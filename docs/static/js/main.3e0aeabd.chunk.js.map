{"version":3,"sources":["components/serverApi/serverApi.ts","components/serverApi/serverClock.ts","components/serverApi/WSClock.ts","index.tsx","components/serverApi/WSClient.ts","components/MIDI.ts","components/instruments.ts","components/VisualNotes.ts","components/Sketch.ts","components/VideoOutput.tsx","app/App.tsx"],"names":["WS_URL","WS_HEADER_END","WS_CLIENT_ID","parseClientId","body","JSON","parse","clientId","WS_USERS_ALL","parseUsersAll","userUpdateReq","user","stringify","WS_USER_EVENT","parseUserEvent","userEventReq","evt","WS_CLOCK_NOW","WS_CLOCK_ORIGIN","WS_CLOCK_UPDATE","clockNowReq","clockUpdateReq","clk","parseClockUpdate","WSClock","global","conn","options","localOrigin","correction","precision","correction2","precision2","lowpass","lastReqAt","lastRespAt","loopId","syncInitial","serverOrigin","precisionNow","syncPeriod","synced","update","readyState","WebSocket","OPEN","nowRaw","send","clearTimeout","this","performance","timeOrigin","setInterval","now","originMs","console","error","nowMs","dur","delta","deltaNow","onSynced","nn","c2gain","perfTime","globalTime","App","require","default","ReactDOM","render","document","getElementById","WSClient","clock","users","reopen","CLOSED","newConn","onclose","code","warn","setTimeout","onopen","log","onerror","onmessage","onMessage","parts","str","sep","out","sepRe","RegExp","prevIndex","lastIndex","re","exec","push","slice","index","split","data","head","onClockOrigin","onClockNow","clkOpts","onClockUpdate","onClientId","filter","uu","uevt","onUserEvent","getUser","newMidiEvent","channel","target","number","kind","type","attack","note","_number","release","value","controller","allChannels","Array","keys","map","x","allEvents","MIDI","opts","webMidi","enabled","enable","a","onEnabled","window","WebMidi","inputs","outputs","input","eventName","addListener","name","channels","eightOhEight","samps","urls","ii","length","Tone","baseUrl","toDestination","VisualNote","age","released","firstUpdate","ageReleased","y","velx","vely","young","health","youngDur","fadeOut","radius","radiusOrig","isDead","pp","others","width","posX","Math","random","height","posY","max","other","dx","dy","ddx","ddy","sx","sy","dd","sqrt","cc","close","outerDist","instrument","draw","colorMode","HSL","midiEvent","sat","size","hue","fill","square","lgt","min","circle","RGB","aa","VisualNotes","notes","noteon","noteoff","isSameNote","forEach","Sketch","visualNotes","started","syncing","instruments","piano","A0","C1","A1","C2","A2","C3","A3","C4","A4","C5","A5","C6","A6","C7","A7","C8","ws","midi","inputDevice","offset","clockOpts","bpm","nameCustomized","destroy","timeGlobalToTone","rawContext","_nativeAudioContext","getOutputTimestamp","contextTime","performanceTime","toLocal","timeToneToGlobal","toneTime","pt","toGlobal","setSize","sketch","setup","mousePressed","createCanvas","setupInputs","inUser","setupInputsUser","inInst","createSelect","instName","position","option","changed","sendUserUpdate","setupInputsMidi","createInput","inOffset","setOffset","off","parseFloat","Number","isNaN","inMidi","_midiInput","setupInputsBPM","inBPM","createSlider","sendClockUpdate","loading","inst","loaded","background","drawLabels","drawUsers","drawMessage","strokeWeight","textAlign","CENTER","xx","yy","textSize","textStyle","BOLD","text","ITALIC","key","stroke","LEFT","BOTTOM","msg","toUpperCase","BOLDITALIC","mouseX","mouseY","onMIDI","inputName","timestamp","offsetMs","tt","triggerAttack","toFrequency","schedule","triggerRelease","pb","me","VideoOutput","ref","useRef","sk","useEffect","current","elem","childNodes","removeChild","clientWidth","clientHeight","skObj","p5","remove","style","display","flex","alignItems","justifyContent","color","className","flexDirection","backgroundColor","top","left","right","bottom"],"mappings":"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","file":"static/js/main.3e0aeabd.chunk.js","sourcesContent":["import { MidiEvent } from '../MIDI'\n\n// export const WS_URL = 'ws://localhost:38883'\n// export const WS_URL = 'ws://207.38.86.97:25468'\nexport const WS_URL = 'wss://mikeylemmon.com/api'\nexport const WS_HEADER_END = '#'\n\nexport const WS_CLIENT_ID = 'client/id'\nexport type ClientIdResp = { clientId: number }\n\nexport function parseClientId(body: string): number {\n\tconst resp: ClientIdResp = JSON.parse(body)\n\treturn resp.clientId\n}\n\nexport type User = {\n\tclientId: number\n\tname: string\n\tinstrument: string\n\tinputDevice: string\n\toffset: number\n\tposX: number\n\tposY: number\n}\n\nexport const WS_USER_UPDATE = 'user/update'\nexport const WS_USERS_ALL = 'user/all'\n\nexport function parseUsersAll(body: string): User[] {\n\tconst resp: User[] = JSON.parse(body)\n\treturn resp\n}\n\nexport function userUpdateReq(user: User): string {\n\treturn WS_USER_UPDATE + WS_HEADER_END + JSON.stringify(user)\n}\n\nexport type UserEvent = {\n\tclientId: number\n\tinstrument: string\n\tmidiEvent: MidiEvent\n\ttimestamp: number\n}\n\nexport const WS_USER_EVENT = 'user/event'\n\nexport function parseUserEvent(body: string): UserEvent {\n\tconst resp: UserEvent = JSON.parse(body)\n\treturn resp\n}\n\nexport function userEventReq(evt: UserEvent): string {\n\treturn WS_USER_EVENT + WS_HEADER_END + JSON.stringify(evt)\n}\n","import { WS_HEADER_END } from './serverApi'\n\nexport const WS_CLOCK_NOW = 'clock/now'\nexport const WS_CLOCK_ORIGIN = 'clock/origin'\nexport const WS_CLOCK_UPDATE = 'clock/update'\n\nexport type ClockNowResp = { nowMs: number }\nexport type ClockOriginResp = { originMs: number }\nexport type ClockOpts = { bpm: number }\n\nexport const clockNowReq = () => WS_CLOCK_NOW + WS_HEADER_END\nexport const clockUpdateReq = (clk: ClockOpts) => WS_CLOCK_UPDATE + WS_HEADER_END + JSON.stringify(clk)\n\nexport function parseClockUpdate(body: string): ClockOpts {\n\tconst resp: ClockOpts = JSON.parse(body)\n\treturn resp\n}\n","import { clockNowReq, ClockNowResp, ClockOriginResp } from './serverClock'\n\nconst SYNC_PERIOD_INITIAL_MS = 500,\n\tSYNC_INITIAL_NUM = 6, // number of times to use initial period\n\tSYNC_PERIOD_MS = 2000\n\nexport type WSClockOptions = {\n\tonSynced: () => void\n}\n\nexport default class WSClock {\n\tglobal: any\n\tconn: WebSocket\n\tlocalOrigin: number\n\tcorrection = 0 // a correction to apply to the local clock based on rolling-average deviation from server clock\n\tprecision = 0 // average of how accurate the workerClock is with correction applied\n\tcorrection2 = 0 // a derivative correction that accounts for linear clock deviation (i.e. local clock is X slower/faster than server)\n\tprecision2 = 0 // measures how accurate the workerClock is with correction and correction2 applied\n\tlowpass = 0.3 // how much latest sample affects correction/precision\n\tlastReqAt = 0\n\tlastRespAt = 0\n\tloopId = -1\n\tsyncInitial = 0\n\tserverOrigin = 0\n\tprecisionNow = 0\n\tsyncPeriod = SYNC_PERIOD_INITIAL_MS\n\tsynced = false\n\toptions: Partial<WSClockOptions>\n\n\tconstructor(global: any, conn: WebSocket, options: Partial<WSClockOptions> = {}) {\n\t\tthis.global = global\n\t\tthis.options = options\n\t\t// this.localOrigin = global.performance.timing.navigationStart\n\t\tthis.localOrigin = global.performance.timeOrigin\n\t\tthis.conn = conn\n\t\tthis.loopId = global.setInterval(this.update, this.syncPeriod)\n\t}\n\n\tnowRaw() {\n\t\treturn global.performance.now()\n\t}\n\n\tupdate = () => {\n\t\tif (this.conn.readyState !== WebSocket.OPEN) {\n\t\t\tthis.global.clearTimeout(this.loopId)\n\t\t\treturn\n\t\t}\n\t\tthis.lastReqAt = this.nowRaw()\n\t\tthis.conn.send(clockNowReq())\n\t}\n\n\tonClockOrigin(body: string) {\n\t\tconst resp: ClockOriginResp = JSON.parse(body)\n\t\tconst { originMs } = resp\n\t\tif (!originMs) {\n\t\t\tconsole.error('[workerClock #onClockOrigin] Received empty response')\n\t\t\treturn\n\t\t}\n\t\tthis.serverOrigin = originMs\n\t}\n\n\tonClockNow(body: string) {\n\t\tconst resp: ClockNowResp = JSON.parse(body)\n\t\tconst { nowMs } = resp || {}\n\t\tif (!nowMs) {\n\t\t\tconsole.error('[workerClock #onClockNow] Received empty response')\n\t\t\treturn\n\t\t}\n\t\tthis.lastRespAt = this.nowRaw()\n\t\tconst dur = this.lastRespAt - this.lastReqAt\n\t\tconst mid = dur / 2 + this.lastReqAt\n\t\tconst delta = nowMs - mid\n\t\tif (this.correction === 0) {\n\t\t\tthis.correction = delta\n\t\t} else {\n\t\t\tthis.correction = delta * this.lowpass + this.correction * (1 - this.lowpass)\n\t\t}\n\t\tconst precision = delta - this.correction\n\t\tif (this.precision === 0) {\n\t\t\tthis.precision = precision\n\t\t} else {\n\t\t\tthis.precision = precision * this.lowpass + this.precision * (1 - this.lowpass)\n\t\t}\n\t\t// Calculate a secondary correction based on the average value of precision to account\n\t\t// for the local clock being consistently slower/faster than the server clock\n\t\tthis.correction2 = this.precision * this.lowpass + this.correction2 * (1 - this.lowpass)\n\t\tconst precision2 = delta - this.correction - this.correction2\n\t\tif (this.precision2 === 0) {\n\t\t\tthis.precision2 = precision2\n\t\t} else {\n\t\t\tthis.precision2 = precision2 * this.lowpass + this.precision2 * (1 - this.lowpass)\n\t\t}\n\n\t\t// Calculate precision metrics for corrected \"now\" time\n\t\tconst now = this.now() - dur / 2\n\t\tconst deltaNow = now - nowMs\n\t\tthis.precisionNow = deltaNow * this.lowpass + this.precisionNow * (1 - this.lowpass)\n\n\t\t// console.log(\n\t\t// \t'[workerClock #onClockNow]',\n\t\t// \t{\n\t\t// \t\tp: this.precision,\n\t\t// \t\tp2: this.precision2,\n\t\t// \t\tc: this.correction,\n\t\t// \t\tc2: this.correction2,\n\t\t// \t},\n\t\t// \t{\n\t\t// \t\tlastP: precision,\n\t\t// \t\tlastP2: precision2,\n\t\t// \t\tdur,\n\t\t// \t},\n\t\t// \t{\n\t\t// \t\tnow: now,\n\t\t// \t\tnowMs: nowMs,\n\t\t// \t\td: deltaNow,\n\t\t// \t\tpnow: this.precisionNow,\n\t\t// \t},\n\t\t// \t{\n\t\t// \t\tnowOverP: this.precisionNow / this.precision2,\n\t\t// \t},\n\t\t// )\n\n\t\tif (!this.synced && this.syncInitial++ > SYNC_INITIAL_NUM) {\n\t\t\t// Replace sync loop with lower-frequency interval\n\t\t\tthis.synced = true\n\t\t\tthis.global.clearTimeout(this.loopId)\n\t\t\t// this.correction2 *= SYNC_PERIOD_MS / SYNC_PERIOD_INITIAL_MS\n\t\t\tthis.correction += this.correction2\n\t\t\tthis.syncPeriod = SYNC_PERIOD_MS\n\t\t\tthis.loopId = this.global.setInterval(this.update, this.syncPeriod)\n\t\t\tif (this.options.onSynced) {\n\t\t\t\tthis.options.onSynced()\n\t\t\t}\n\t\t}\n\t}\n\n\tnow() {\n\t\tconst nn = this.nowRaw()\n\t\tconst c2gain = 1 + (nn - this.lastRespAt) / this.syncPeriod\n\t\treturn nn + this.correction + this.correction2 * c2gain\n\t}\n\n\ttoGlobal(perfTime: number) {\n\t\treturn perfTime + this.correction + this.correction2\n\t}\n\n\ttoLocal(globalTime: number) {\n\t\treturn globalTime - this.correction - this.correction2\n\t}\n}\n","import React from 'react'\nimport ReactDOM from 'react-dom'\nimport 'index.css'\n\nconst render = () => {\n\tconst App = require('app/App').default\n\n\tReactDOM.render(<App />, document.getElementById('root'))\n}\n\nrender()\n\nif (process.env.NODE_ENV === 'development' && module.hot) {\n\tmodule.hot.accept('./app/App', render)\n}\n","import {\n\tparseClientId,\n\tparseUserEvent,\n\tparseUsersAll,\n\tUser,\n\tUserEvent,\n\tWS_CLIENT_ID,\n\tWS_HEADER_END,\n\tWS_URL,\n\tWS_USER_EVENT,\n\tWS_USERS_ALL,\n} from './serverApi'\nimport { parseClockUpdate, ClockOpts, WS_CLOCK_NOW, WS_CLOCK_ORIGIN, WS_CLOCK_UPDATE } from './serverClock'\nimport WSClock, { WSClockOptions } from './WSClock'\n\nexport const DONT_REOPEN = 888\n\nexport type WSClientOptions = {\n\tclock: Partial<WSClockOptions>\n\tonClientId: (clientId: number) => any\n\tonClockUpdate: (clkOpts: ClockOpts) => void\n\tonUserEvent: (evt: UserEvent) => void\n}\n\nexport default class WSClient {\n\tconn: WebSocket\n\tclock: WSClock\n\tglobal: any\n\toptions: WSClientOptions\n\tclientId: number = 0\n\tusers: User[] = []\n\n\tconstructor(global: any, options: WSClientOptions) {\n\t\tthis.global = global\n\t\tthis.options = options as WSClientOptions\n\t\tthis.conn = this.newConn()\n\t\tthis.clock = new WSClock(this.global, this.conn, this.options.clock)\n\t}\n\n\treopen = () => {\n\t\t// Try to re-open the websocket connection if it has closed\n\t\tif (this.conn.readyState !== WebSocket.CLOSED) {\n\t\t\treturn\n\t\t}\n\t\tthis.conn = this.newConn()\n\t}\n\n\tnewConn = (): WebSocket => {\n\t\tconst conn = new WebSocket(WS_URL)\n\t\tconn.onclose = (evt: CloseEvent) => {\n\t\t\tif (evt.code === DONT_REOPEN) {\n\t\t\t\tconsole.warn('Closing for good', evt)\n\t\t\t\treturn\n\t\t\t}\n\t\t\tconsole.warn('WebSocket closed, will attempt to reopen in a few seconds', evt)\n\t\t\tsetTimeout(this.reopen, 5000)\n\t\t}\n\t\tconn.onopen = (evt: Event) => {\n\t\t\tconsole.log('WebSocket opened', evt)\n\t\t\tthis.clock = new WSClock(this.global, this.conn, this.options.clock)\n\t\t}\n\t\tconn.onerror = (evt: Event) => {\n\t\t\tconsole.error('WebSocket error', evt)\n\t\t}\n\t\tconn.onmessage = this.onMessage\n\t\treturn conn\n\t}\n\n\tonMessage = (evt: MessageEvent) => {\n\t\tconst parts = split(evt.data, WS_HEADER_END, 1)\n\t\tconst [head, body] = parts\n\t\tswitch (head) {\n\t\t\tcase WS_CLOCK_NOW:\n\t\t\tcase WS_CLOCK_ORIGIN:\n\t\t\t\tif (!this.clock) {\n\t\t\t\t\tconsole.error('[WSClient #onMessage] No local clock ready to handle server clock message')\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tif (head === WS_CLOCK_ORIGIN) {\n\t\t\t\t\tthis.clock.onClockOrigin(body)\n\t\t\t\t} else {\n\t\t\t\t\tthis.clock.onClockNow(body)\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase WS_CLOCK_UPDATE:\n\t\t\t\tconst clkOpts = parseClockUpdate(body)\n\t\t\t\tthis.options.onClockUpdate(clkOpts)\n\t\t\t\tconsole.log('[WSClient #onMessage] Received clockUpdate', clkOpts)\n\t\t\t\tbreak\n\t\t\tcase WS_CLIENT_ID:\n\t\t\t\tthis.clientId = parseClientId(body)\n\t\t\t\tconsole.log('[WSClient #onMessage] Received clientId', this.clientId)\n\t\t\t\tthis.options.onClientId(this.clientId)\n\t\t\t\tbreak\n\t\t\tcase WS_USERS_ALL:\n\t\t\t\tthis.users = parseUsersAll(body).filter(uu => !!uu)\n\t\t\t\tconsole.log('[WSClient #onMessage] Received users', this.users)\n\t\t\t\tbreak\n\t\t\tcase WS_USER_EVENT:\n\t\t\t\tconst uevt = parseUserEvent(body)\n\t\t\t\t// console.log('[WSClient #onMessage] Received user event', uevt)\n\t\t\t\tthis.options.onUserEvent(uevt)\n\t\t\t\tbreak\n\t\t\tdefault:\n\t\t\t\tconsole.log('[WSClient #onMessage] Unhandled message', { head, body, parts }, evt)\n\t\t\t\tbreak\n\t\t}\n\t}\n\n\tnow = (): number => {\n\t\tif (!this.clock) {\n\t\t\tconsole.error('[WSClient #now] No clock!')\n\t\t\treturn -1\n\t\t}\n\t\treturn this.clock.now()\n\t}\n\n\tgetUser = (clientId: number) => {\n\t\tfor (const uu of this.users) {\n\t\t\tif (uu.clientId === clientId) {\n\t\t\t\treturn uu\n\t\t\t}\n\t\t}\n\t}\n}\n\n// split function with remainder\n// via https://stackoverflow.com/questions/874709/converting-user-input-string-to-regular-expression\nfunction split(str: string, sep: string, nn: number) {\n\tconst out: string[] = []\n\tconst sepRe = new RegExp(sep, 'g')\n\twhile (nn--) {\n\t\tconst prevIndex = sepRe.lastIndex\n\t\tconst re = sepRe.exec(str)\n\t\tif (!re) {\n\t\t\tbreak\n\t\t}\n\t\tout.push(str.slice(prevIndex, re.index))\n\t}\n\tout.push(str.slice(sepRe.lastIndex))\n\treturn out\n}\n","type FieldsShared = {\n\tdata: number[]\n\tchannel: number\n\tkind: string\n}\n\ntype FieldsNote = {\n\tattack?: number\n\tnote: number\n\trelease?: number\n}\n\ntype FieldsCC = {\n\tvalue: number // 0 - 1 (data[2])\n\tcontroller: {\n\t\tnumber: number // (data[1])\n\t\tname: string\n\t}\n}\n\ntype FieldsPitchbend = {\n\tvalue: number // 0 - 1 (data[2])\n}\n\nexport type MidiEventNote = FieldsShared & FieldsNote\nexport type MidiEventCC = FieldsShared & FieldsCC\nexport type MidiEventPitchbend = FieldsShared & FieldsPitchbend\nexport type MidiEvent = FieldsShared & FieldsCC & FieldsNote & FieldsPitchbend\nexport function newMidiEvent(evt: any): MidiEvent {\n\treturn {\n\t\tdata: evt.data,\n\t\tchannel: evt.target.number,\n\t\tkind: evt.type,\n\t\tattack: evt.attack,\n\t\tnote: evt.note && evt.note._number,\n\t\trelease: evt.release,\n\t\tvalue: evt.value,\n\t\tcontroller: evt.controller,\n\t}\n}\n\nconst allChannels = [...Array(16).keys()].map(x => x + 1) // Array of numbers 1 thru 16\nconst allEvents = ['controlchange', 'noteoff', 'noteon', 'pitchbend'] // 'keyaftertouch',\n\ntype MIDIOptions = {\n\tonMessage: (inputName: string, eventName: string, evt: MidiEvent) => void\n\tonEnabled?: (webMidi: any) => void\n}\n\nexport default class MIDI {\n\twebMidi: any | null = null\n\tenabled: boolean = false\n\n\tconstructor(opts: MIDIOptions) {\n\t\tthis.enable(opts)\n\t}\n\n\tenable = async (opts: MIDIOptions) => {\n\t\tconst { onMessage, onEnabled } = opts\n\t\tconst { WebMidi } = window\n\t\ttry {\n\t\t\tawait WebMidi.enable()\n\t\t} catch (err) {\n\t\t\tconsole.error('[MIDI #enable] Failed to enable MIDI', err)\n\t\t\treturn\n\t\t}\n\t\tthis.webMidi = WebMidi\n\t\tthis.enabled = true\n\t\tconst { inputs, outputs } = this.webMidi\n\t\tconsole.log('[MIDI #enable] inputs', inputs)\n\t\tconsole.log('[MIDI #enable] outputs', outputs)\n\t\tif (onEnabled) {\n\t\t\tonEnabled(this.webMidi)\n\t\t}\n\t\tfor (const input of inputs) {\n\t\t\tfor (const eventName of allEvents) {\n\t\t\t\tinput.addListener(\n\t\t\t\t\teventName,\n\t\t\t\t\t(evt: any) => onMessage(input.name, eventName, newMidiEvent(evt)),\n\t\t\t\t\t{\n\t\t\t\t\t\tchannels: allChannels,\n\t\t\t\t\t},\n\t\t\t\t)\n\t\t\t}\n\t\t}\n\t}\n}\n","import * as Tone from 'tone'\n\nexport function piano() {\n\treturn new Tone.Sampler({\n\t\turls: {\n\t\t\tA0: 'A0.mp3',\n\t\t\tC1: 'C1.mp3',\n\t\t\t'D#1': 'Ds1.mp3',\n\t\t\t'F#1': 'Fs1.mp3',\n\t\t\tA1: 'A1.mp3',\n\t\t\tC2: 'C2.mp3',\n\t\t\t'D#2': 'Ds2.mp3',\n\t\t\t'F#2': 'Fs2.mp3',\n\t\t\tA2: 'A2.mp3',\n\t\t\tC3: 'C3.mp3',\n\t\t\t'D#3': 'Ds3.mp3',\n\t\t\t'F#3': 'Fs3.mp3',\n\t\t\tA3: 'A3.mp3',\n\t\t\tC4: 'C4.mp3',\n\t\t\t'D#4': 'Ds4.mp3',\n\t\t\t'F#4': 'Fs4.mp3',\n\t\t\tA4: 'A4.mp3',\n\t\t\tC5: 'C5.mp3',\n\t\t\t'D#5': 'Ds5.mp3',\n\t\t\t'F#5': 'Fs5.mp3',\n\t\t\tA5: 'A5.mp3',\n\t\t\tC6: 'C6.mp3',\n\t\t\t'D#6': 'Ds6.mp3',\n\t\t\t'F#6': 'Fs6.mp3',\n\t\t\tA6: 'A6.mp3',\n\t\t\tC7: 'C7.mp3',\n\t\t\t'D#7': 'Ds7.mp3',\n\t\t\t'F#7': 'Fs7.mp3',\n\t\t\tA7: 'A7.mp3',\n\t\t\tC8: 'C8.mp3',\n\t\t},\n\t\trelease: 1,\n\t\tbaseUrl: 'https://tonejs.github.io/audio/salamander/',\n\t}).toDestination()\n}\n\nexport function eightOhEight() {\n\tconst samps = [\n\t\t'BD0010.WAV',\n\t\t'BD0050.WAV',\n\t\t// 'BD0025.WAV',\n\t\t// 'BD0075.WAV',\n\t\t'SD7510.WAV',\n\t\t'CP.WAV',\n\t\t// 'SD7550.WAV',\n\t\t// 'SD7500.WAV',\n\t\t// 'SD7525.WAV',\n\t\t'CH.WAV',\n\t\t'OH10.WAV',\n\t\t'LT00.WAV',\n\t\t'MT00.WAV',\n\t\t'HT00.WAV',\n\t\t'LC00.WAV',\n\t\t'MC00.WAV',\n\t\t'HC00.WAV',\n\t\t'CB.WAV',\n\t\t'CY0075.WAV',\n\t\t// 'CY1000.WAV',\n\t\t'MA.WAV',\n\t\t'RS.WAV',\n\t\t// 'CL.WAV',\n\t]\n\tconst urls: { [key: number]: string } = {}\n\tconst start = 20\n\tfor (let ii = start; ii < 128; ++ii) {\n\t\turls[ii] = samps[(ii - start) % samps.length]\n\t}\n\treturn new Tone.Sampler({\n\t\turls,\n\t\trelease: 1,\n\t\tbaseUrl: '/samples/808/',\n\t}).toDestination()\n}\n","import * as p5 from 'p5'\nimport { User, UserEvent } from './serverApi/serverApi'\n\nclass VisualNote {\n\tage: number = 0\n\treleased: boolean = false\n\tfirstUpdate: boolean = true\n\tageReleased: number = 0\n\tx: number = -1\n\ty: number = -1\n\tvelx: number = 0\n\tvely: number = 0\n\tyoung: number = 2.0 // decreases to 1 over youngDur frames\n\thealth: number = 1.0 // after release, decreases to 0 over fadeOut frames\n\tyoungDur: number // number of frames this note is 'young' (i.e. in attack)\n\tfadeOut: number // number of frames to fade away after release\n\tradius: number\n\tradiusOrig: number\n\tevt: UserEvent\n\tuser: User\n\n\tconstructor(evt: UserEvent, user: User) {\n\t\tthis.evt = evt\n\t\tthis.user = user\n\t\tconst aa = this.evt.midiEvent.attack || 0.5\n\t\tthis.radius = aa * 25 + 5\n\t\tthis.radiusOrig = this.radius\n\t\tswitch (evt.instrument) {\n\t\t\tcase 'eightOhEight':\n\t\t\t\tthis.youngDur = 2\n\t\t\t\tthis.fadeOut = 3\n\t\t\t\tbreak\n\t\t\tdefault:\n\t\t\t\tthis.youngDur = 5\n\t\t\t\tthis.fadeOut = 10\n\t\t\t\tbreak\n\t\t}\n\t}\n\n\trelease = () => {\n\t\tthis.released = true\n\t\tthis.ageReleased = this.age\n\t}\n\n\tisDead = () => this.released && this.age - this.ageReleased > this.fadeOut\n\n\tupdate = (pp: p5, others: VisualNote[]) => {\n\t\tconst close = 50,\n\t\t\tweightVC = 1.8,\n\t\t\tweightC = 0.2,\n\t\t\tweightF = 1.0 / 500000,\n\t\t\tweightU = 0.003\n\n\t\tif (this.firstUpdate) {\n\t\t\t// transform original normalized position into screen space\n\t\t\tthis.x = pp.width * (this.user.posX + 0.1 * (Math.random() * 2 - 1))\n\t\t\tthis.y = pp.height * (this.user.posY + 0.1 * (Math.random() * 2 - 1))\n\t\t\tthis.firstUpdate = false\n\t\t}\n\n\t\tthis.young = Math.max(1.0, 2.0 - this.age / this.youngDur)\n\t\tthis.age++\n\t\tif (this.released) {\n\t\t\tthis.health = 1.0 - (this.age - this.ageReleased) / this.fadeOut\n\t\t}\n\t\tthis.radius = this.radiusOrig * this.health\n\n\t\tthis.velx *= 0.924\n\t\tthis.vely *= 0.924\n\t\tthis.velx -= weightU * (this.x - this.user.posX * pp.width)\n\t\tthis.vely -= weightU * (this.y - this.user.posY * pp.height)\n\t\tfor (const other of others) {\n\t\t\tif (other === this) {\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tconst dx = this.x - other.x\n\t\t\tconst dy = this.y - other.y\n\t\t\tconst ddx = dx * dx\n\t\t\tconst ddy = dy * dy\n\t\t\tconst sx = dx < 0 ? -1 : 1\n\t\t\tconst sy = dy < 0 ? -1 : 1\n\t\t\tconst dd = Math.sqrt(ddx + ddy)\n\t\t\tconst cc = close * close\n\t\t\tconst outerDist = dd - (this.radius + other.radius)\n\t\t\tif (outerDist < 0) {\n\t\t\t\t// notes bounce off each other if they're touching\n\t\t\t\tthis.velx += (weightVC * sx * (cc * 3 - ddx)) / cc\n\t\t\t\tthis.vely += (weightVC * sy * (cc * 3 - ddy)) / cc\n\t\t\t} else if (outerDist < close) {\n\t\t\t\t// notes repel each other a little if they're not touching but still close\n\t\t\t\tthis.velx += (weightC * sx * ddx) / cc\n\t\t\t\tthis.vely += (weightC * sy * ddy) / cc\n\t\t\t} else if (other.evt.instrument === this.evt.instrument) {\n\t\t\t\t// notes from the same instrument spring towards each other when they're far away\n\t\t\t\tthis.velx -= weightF * sx * ddx\n\t\t\t\tthis.vely -= weightF * sy * ddy\n\t\t\t}\n\t\t}\n\t\t// bounce off the walls\n\t\tif ((this.y < this.radius && this.vely < 0) || (this.y > pp.height - this.radius && this.vely > 0)) {\n\t\t\tthis.vely *= -1\n\t\t}\n\t\tif ((this.x < this.radius && this.velx < 0) || (this.x > pp.width - this.radius && this.velx > 0)) {\n\t\t\tthis.velx *= -1\n\t\t}\n\t\tthis.y += this.vely\n\t\tthis.x += this.velx\n\t}\n\n\tdraw = (pp: p5) => {\n\t\tpp.colorMode(pp.HSL, 1)\n\t\tconst { instrument, midiEvent } = this.evt\n\t\tconst { attack, note } = midiEvent\n\t\tconst aa = attack || 0.5\n\t\tconst sat = aa * 0.3 + 0.55\n\t\tconst size = this.radius * 2 * this.young\n\t\tswitch (instrument) {\n\t\t\tcase 'eightOhEight': {\n\t\t\t\tconst hue = (note % 16) / 16\n\t\t\t\tpp.fill(hue * 0.4 + 0.05, sat, 0.45, this.health)\n\t\t\t\tpp.square(this.x - size / 2, this.y - size / 2, size)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tdefault: {\n\t\t\t\tconst hue = (note % 12) / 12\n\t\t\t\tconst lgt = Math.min(note / 128 + 0.2, 0.65)\n\t\t\t\tpp.fill(hue * 0.25 + 0.55, sat, lgt, this.health)\n\t\t\t\tpp.circle(this.x, this.y, size)\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t\tpp.colorMode(pp.RGB, 255)\n\t}\n}\n\nexport default class VisualNotes {\n\tnotes: VisualNote[] = []\n\n\tnoteon = (evt: UserEvent, user: User) => {\n\t\tthis.notes.push(new VisualNote(evt, user))\n\t}\n\n\tnoteoff = (evt: UserEvent) => {\n\t\tconst notes = this.notes.filter(nn => !nn.released && this.isSameNote(nn, evt))\n\t\tif (!notes.length) {\n\t\t\tconsole.error('[VisualNotes #noteoff] Unable to find note for event', evt)\n\t\t\treturn\n\t\t}\n\t\tnotes.forEach(nn => nn.release())\n\t}\n\n\tisSameNote = (note: VisualNote, evt: UserEvent) => {\n\t\treturn note.evt.instrument === evt.instrument && note.evt.midiEvent.note === evt.midiEvent.note\n\t}\n\n\tdraw = (pp: p5) => {\n\t\tthis.notes = this.notes.filter(nn => !nn.isDead())\n\t\tthis.notes.forEach(nn => nn.update(pp, this.notes))\n\t\tthis.notes.forEach(nn => nn.draw(pp))\n\t}\n}\n","import * as p5 from 'p5'\nimport * as Tone from 'tone'\nimport WSClient, { DONT_REOPEN } from './serverApi/WSClient'\nimport { userEventReq, userUpdateReq, User, UserEvent } from './serverApi/serverApi'\nimport { clockUpdateReq, ClockOpts } from './serverApi/serverClock'\nimport MIDI, { MidiEvent, MidiEventCC, MidiEventNote, MidiEventPitchbend } from './MIDI'\nimport { piano, eightOhEight } from './instruments'\nimport VisualNotes from './VisualNotes'\n\ntype Instruments = {\n\teightOhEight: ReturnType<typeof eightOhEight>\n\tpiano: ReturnType<typeof piano>\n}\n\nconst userInputsY = 40\n\nexport default class Sketch {\n\twidth: number = 0\n\theight: number = 0\n\tnn: number = 0\n\tvisualNotes: VisualNotes = new VisualNotes()\n\tstarted: boolean = false\n\tsyncing: boolean = true\n\tinstruments: Instruments = {\n\t\tpiano: piano(),\n\t\teightOhEight: eightOhEight(),\n\t}\n\tws: WSClient\n\tmidi: MIDI\n\tpp: p5 | null = null\n\tuser: User = {\n\t\tclientId: 0,\n\t\tname: '',\n\t\tinstrument: '',\n\t\tinputDevice: '',\n\t\toffset: 2,\n\t\tposX: Math.random() * 0.8 + 0.1,\n\t\tposY: Math.random() * 0.6 + 0.2,\n\t}\n\tclockOpts: ClockOpts = {\n\t\tbpm: 95,\n\t}\n\n\tnameCustomized: boolean = false\n\n\tinputs: {\n\t\tname?: any\n\t\tinstrument?: any\n\t\tinputDevice?: any\n\t\toffset?: any\n\t\tbpm?: any\n\t} = {}\n\n\tconstructor() {\n\t\tconsole.log('[Sketch #ctor]')\n\t\tthis.ws = new WSClient(window, {\n\t\t\tclock: {\n\t\t\t\tonSynced: () => {\n\t\t\t\t\tthis.syncing = false\n\t\t\t\t\tthis.setupInputsBPM()\n\t\t\t\t},\n\t\t\t},\n\t\t\tonClientId: this.setupInputsUser,\n\t\t\tonClockUpdate: this.onClockUpdate,\n\t\t\tonUserEvent: this.onUserEvent,\n\t\t})\n\t\tthis.midi = new MIDI({\n\t\t\tonMessage: this.onMIDI,\n\t\t\tonEnabled: this.setupInputsMidi,\n\t\t})\n\t\twindow.Tone = Tone\n\t\twindow.me = this\n\t}\n\n\tdestroy = () => {\n\t\tthis.ws.conn.close(DONT_REOPEN, 'sketch destroyed')\n\t}\n\n\ttimeGlobalToTone = (globalTime: number) => {\n\t\tconst rawCtx = Tone.context.rawContext as any\n\t\tconst { contextTime, performanceTime } = rawCtx._nativeAudioContext.getOutputTimestamp()\n\t\tconst lt = this.ws.clock.toLocal(globalTime)\n\t\tconst delta = lt - performanceTime\n\t\tconst toneTime = contextTime + delta / 1000\n\t\treturn toneTime\n\t}\n\n\ttimeToneToGlobal = (toneTime: number) => {\n\t\tconst rawCtx = Tone.context.rawContext as any\n\t\tconst { contextTime, performanceTime } = rawCtx._nativeAudioContext.getOutputTimestamp()\n\t\tconst delta = toneTime - contextTime\n\t\tconst pt = performanceTime + delta * 1000\n\t\tconst globalTime = this.ws.clock.toGlobal(pt)\n\t\t// console.log('[Sketch #timeToneToGlobal]', toneTime * 1000, '>', globalTime)\n\t\treturn globalTime\n\t}\n\n\tsetSize = (width: number, height: number) => {\n\t\tthis.width = width\n\t\tthis.height = height\n\t}\n\n\tsketch = (pp: p5) => {\n\t\tthis.pp = pp\n\t\tpp.setup = () => this.setup(pp)\n\t\tpp.draw = () => this.draw(pp)\n\t\tpp.mousePressed = () => this.mousePressed(pp)\n\t}\n\n\tsetup = (pp: p5) => {\n\t\tconsole.log(`[Sketch #setup] ${this.width} x ${this.height}`)\n\t\tpp.createCanvas(this.width, this.height)\n\t\tthis.setupInputs(pp)\n\t\tthis.user.posX = Math.random() * 0.8 + 0.1\n\t\tthis.user.posY = Math.random() * 0.6 + 0.2\n\t}\n\n\tsetupInputs = (pp: p5) => {\n\t\tconst inUser = this.setupInputsUser(this.ws.clientId)\n\n\t\tconst inInst = pp.createSelect() as any\n\t\tinInst.position(inUser.x + inUser.width + 10, userInputsY)\n\t\tfor (const instName in this.instruments) {\n\t\t\tinInst.option(instName)\n\t\t}\n\t\tinInst.size(100)\n\t\tinInst.changed(() => {\n\t\t\tconsole.log('[Sketch #inputs.instrument] Changed:', inInst.value())\n\t\t\tthis.user.instrument = inInst.value()\n\t\t\tthis.sendUserUpdate()\n\t\t})\n\t\tthis.inputs.instrument = inInst\n\t\tthis.user.instrument = inInst.value()\n\n\t\tif (this.midi.enabled && !this.inputs.inputDevice) {\n\t\t\tthis.setupInputsMidi(this.midi.webMidi)\n\t\t}\n\t}\n\n\tsetupInputsUser = (clientId: number): any => {\n\t\tthis.user.clientId = clientId\n\t\tif (!this.pp) {\n\t\t\tconsole.warn(\n\t\t\t\t'[Sketch #setupInputsUser] Attempted to setup user input before sketch was initialized',\n\t\t\t)\n\t\t\treturn\n\t\t}\n\t\tif (this.inputs.name && this.nameCustomized) {\n\t\t\t// Don't re-create the input if the user has already customized their name\n\t\t\treturn\n\t\t}\n\t\tconst inUser = this.pp.createInput(`User ${this.ws.clientId}`) as any\n\t\tinUser.size(80)\n\t\tinUser.position(20, userInputsY)\n\t\tinUser.input(() => {\n\t\t\tconsole.log('[Sketch #inputs.name] Changed:', inUser.value())\n\t\t\tthis.nameCustomized = true\n\t\t\tthis.user.name = inUser.value()\n\t\t\tthis.sendUserUpdate()\n\t\t})\n\t\tthis.inputs.name = inUser\n\t\tthis.user.name = inUser.value()\n\n\t\tconst inOffset = this.pp.createInput(`${this.user.offset}`) as any\n\t\tinOffset.size(50)\n\t\tinOffset.position(inUser.x + inUser.width + 10, userInputsY)\n\t\tconst setOffset = () => {\n\t\t\tconst off = parseFloat(inOffset.value())\n\t\t\tif (!Number.isNaN(off)) {\n\t\t\t\tthis.user.offset = off\n\t\t\t\tthis.sendUserUpdate()\n\t\t\t}\n\t\t}\n\t\tinOffset.input(() => {\n\t\t\tconsole.log('[Sketch #inputs.offset] Changed:', inOffset.value())\n\t\t\tsetOffset()\n\t\t})\n\t\tthis.inputs.offset = inOffset\n\t\tsetOffset()\n\t\treturn inOffset\n\t}\n\n\tsetupInputsMidi = (webMidi: any) => {\n\t\tif (!this.pp || !this.inputs.instrument) {\n\t\t\treturn\n\t\t}\n\t\tconst { inputs } = webMidi\n\t\tconst inMidi = this.pp.createSelect() as any\n\t\tconst inInst = this.inputs.instrument\n\t\tinMidi.position(inInst.x + inInst.width + 10, userInputsY)\n\t\tfor (const input of inputs) {\n\t\t\tconst { _midiInput } = input\n\t\t\tif (!_midiInput) {\n\t\t\t\tconsole.error('[Sketch #setupInputsMidi] Received a midi input with missing data')\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tinMidi.option(_midiInput.name)\n\t\t}\n\t\tinMidi.option('keyboard')\n\t\tinMidi.changed(() => {\n\t\t\tconsole.log('[Sketch #setupInputsMidi] Changed:', inMidi.value())\n\t\t\tthis.user.inputDevice = inMidi.value()\n\t\t\tthis.sendUserUpdate()\n\t\t})\n\t\tthis.inputs.inputDevice = inMidi\n\t\tthis.user.inputDevice = inMidi.value()\n\t}\n\n\tsetupInputsBPM = () => {\n\t\tif (!this.pp) {\n\t\t\treturn\n\t\t}\n\t\tconst inBPM = this.pp.createSlider(30, 200, this.clockOpts.bpm) as any\n\t\tinBPM.position(20, this.pp.height - 40)\n\t\tinBPM.size(this.pp.width / 2)\n\t\tinBPM.input(() => {\n\t\t\t// console.log('[Sketch #setupInputsBPM] Changed:', inBPM.value())\n\t\t\tthis.clockOpts.bpm = inBPM.value()\n\t\t\tthis.sendClockUpdate(this.clockOpts)\n\t\t})\n\t\tthis.inputs.bpm = inBPM\n\t}\n\n\tdraw = (pp: p5) => {\n\t\tlet loading = false\n\t\tfor (const instName in this.instruments) {\n\t\t\tconst inst = (this.instruments as any)[instName]\n\t\t\tloading = loading || !inst.loaded\n\t\t}\n\t\tpp.background(0x33)\n\t\tthis.visualNotes.draw(pp)\n\t\tthis.drawLabels(pp)\n\t\tthis.drawUsers(pp)\n\t\tif (loading) {\n\t\t\tthis.drawMessage(pp, 'Loading instruments...')\n\t\t} else if (this.syncing) {\n\t\t\tthis.drawMessage(pp, 'Syncing clock with server...')\n\t\t} else if (!this.started) {\n\t\t\tthis.drawMessage(pp, 'Click to enable audio')\n\t\t}\n\t}\n\n\tdrawUsers = (pp: p5) => {\n\t\tpp.strokeWeight(0)\n\t\tpp.textAlign(pp.CENTER, pp.CENTER)\n\t\tfor (const user of this.ws.users) {\n\t\t\tconst xx = user.posX * pp.width\n\t\t\tconst yy = user.posY * pp.height\n\t\t\tpp.fill(255)\n\t\t\tpp.textSize(14)\n\t\t\tpp.textStyle(pp.BOLD)\n\t\t\tpp.text(user.name, xx, yy)\n\t\t\tpp.fill(200)\n\t\t\tpp.textSize(11)\n\t\t\tpp.textStyle(pp.ITALIC)\n\t\t\tpp.text(`${user.instrument} (@${user.offset})`, xx, yy + 18)\n\t\t}\n\t}\n\n\tdrawLabels = (pp: p5) => {\n\t\tpp.textSize(12)\n\t\tpp.fill(255)\n\t\tpp.strokeWeight(1)\n\t\tpp.stroke(0)\n\t\tpp.textAlign(pp.LEFT, pp.BOTTOM)\n\t\tpp.textStyle(pp.BOLD)\n\t\tfor (const key in this.inputs) {\n\t\t\tconst input = (this.inputs as any)[key]\n\t\t\tconst xx = input.x + 3\n\t\t\tconst yy = input.y - 5\n\t\t\tswitch (true) {\n\t\t\t\tcase key === 'offset':\n\t\t\t\t\tconst off = parseFloat(input.value())\n\t\t\t\t\tlet msg = ``\n\t\t\t\t\tif (Number.isNaN(off)) {\n\t\t\t\t\t\t// Show the user that they have an invalid value\n\t\t\t\t\t\tpp.fill(255, 0, 0)\n\t\t\t\t\t\tmsg = ` (NaN!)`\n\t\t\t\t\t}\n\t\t\t\t\tpp.text(`${key.toUpperCase()}${msg}${'\\n'}(in beats)`, xx, yy)\n\t\t\t\t\tif (Number.isNaN(off)) {\n\t\t\t\t\t\t// put fill color back\n\t\t\t\t\t\tpp.fill(255)\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\tcase key in this.user:\n\t\t\t\t\tpp.text(key.toUpperCase(), xx, yy)\n\t\t\t\t\tbreak\n\t\t\t\tdefault:\n\t\t\t\t\tpp.text(`${key.toUpperCase()}: ${input.value()}`, xx, yy)\n\t\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t}\n\n\tdrawMessage = (pp: p5, msg: string) => {\n\t\tpp.fill(200)\n\t\tpp.strokeWeight(0)\n\t\tpp.textSize(20)\n\t\tpp.textAlign(pp.CENTER, pp.CENTER)\n\t\tpp.textStyle(pp.BOLDITALIC)\n\t\tpp.text(msg, pp.width / 2, pp.height / 2)\n\t}\n\n\tmousePressed = (pp: p5) => {\n\t\tif (!this.started) {\n\t\t\tTone.start()\n\t\t\tconsole.log('[Sketch #mousePressed] Started Tone')\n\t\t\tthis.started = true\n\t\t\treturn\n\t\t}\n\t\t// Update user position if click is in the center area\n\t\tif (pp.mouseX < pp.width * 0.1 || pp.mouseX > pp.width * 0.9) {\n\t\t\treturn\n\t\t}\n\t\tif (pp.mouseY < pp.height * 0.2 || pp.mouseY > pp.height * 0.8) {\n\t\t\treturn\n\t\t}\n\t\tthis.user.posX = pp.mouseX / pp.width\n\t\tthis.user.posY = pp.mouseY / pp.height\n\t\tthis.sendUserUpdate()\n\t}\n\n\tsendUserUpdate = () => {\n\t\tconst { conn } = this.ws\n\t\tif (!conn || conn.readyState !== WebSocket.OPEN) {\n\t\t\tconsole.warn(\"[Sketch #sendUserUpdate] Can't send user update, websocket connection is not open\")\n\t\t\treturn\n\t\t}\n\t\tconn.send(userUpdateReq(this.user))\n\t}\n\n\tsendClockUpdate = (clk: ClockOpts) => {\n\t\tconst { conn } = this.ws\n\t\tif (!conn || conn.readyState !== WebSocket.OPEN) {\n\t\t\tconsole.warn(\"[Sketch #sendUserUpdate] Can't send bpm update, websocket connection is not open\")\n\t\t\treturn\n\t\t}\n\t\tconn.send(clockUpdateReq(clk))\n\t}\n\n\tonClockUpdate = (clk: ClockOpts) => {\n\t\tthis.clockOpts = clk\n\t\tif (!this.inputs.bpm) {\n\t\t\treturn\n\t\t}\n\t\tthis.inputs.bpm.value(clk.bpm)\n\t}\n\n\tonMIDI = (inputName: string, eventName: string, evt: MidiEvent) => {\n\t\tif (inputName !== this.user.inputDevice) {\n\t\t\treturn\n\t\t}\n\t\tconst uevt = {\n\t\t\tclientId: this.user.clientId,\n\t\t\tinstrument: this.user.instrument,\n\t\t\tmidiEvent: evt,\n\t\t\ttimestamp: this.ws.now() + this.offsetMs(),\n\t\t}\n\t\tconst { conn } = this.ws\n\t\tif (!conn || conn.readyState !== WebSocket.OPEN) {\n\t\t\tthis.onUserEvent(uevt)\n\t\t\treturn\n\t\t}\n\t\tconn.send(userEventReq(uevt))\n\t}\n\n\toffsetMs = () => {\n\t\tif (!this.inputs.bpm) {\n\t\t\treturn 0\n\t\t}\n\t\tconst bps = this.inputs.bpm.value() / 60\n\t\tconst beatMs = 1000.0 / bps\n\t\treturn beatMs * this.user.offset\n\t}\n\n\tonUserEvent = (evt: UserEvent) => {\n\t\tconst { clientId, instrument, midiEvent, timestamp } = evt\n\t\tconst { data, channel, kind } = midiEvent\n\t\tconst inst = (this.instruments as any)[instrument]\n\t\tif (!inst) {\n\t\t\tconsole.error('[Sketch #onUserEvent] Unable to find instrument', instrument)\n\t\t\treturn\n\t\t}\n\t\tif (inst.loaded === false) {\n\t\t\treturn // don't send events if instrument hasn't finished loading\n\t\t}\n\t\tconst tt = this.timeGlobalToTone(timestamp)\n\t\tif (tt - Tone.immediate() < -1) {\n\t\t\treturn\n\t\t}\n\t\tswitch (kind) {\n\t\t\tcase 'noteon': {\n\t\t\t\tconst nn = midiEvent as MidiEventNote\n\t\t\t\tinst.triggerAttack(Tone.Frequency(nn.note, 'midi').toFrequency(), tt, nn.attack)\n\t\t\t\tlet user = this.user\n\t\t\t\tif (clientId !== user.clientId) {\n\t\t\t\t\tconst uu = this.ws.getUser(clientId)\n\t\t\t\t\tuser = uu || user\n\t\t\t\t}\n\t\t\t\tTone.Draw.schedule(() => this.visualNotes.noteon(evt, user), tt)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase 'noteoff': {\n\t\t\t\tconst nn = midiEvent as MidiEventNote\n\t\t\t\tinst.triggerRelease(Tone.Frequency(nn.note, 'midi').toFrequency(), tt)\n\t\t\t\tTone.Draw.schedule(() => this.visualNotes.noteoff(evt), tt)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase 'controlchange': {\n\t\t\t\tconst cc = midiEvent as MidiEventCC\n\t\t\t\tconsole.log(\n\t\t\t\t\t`[Sketch #onMIDI] CC event on channel ${channel}:`,\n\t\t\t\t\tcc.controller.number,\n\t\t\t\t\tcc.controller.name,\n\t\t\t\t\tcc.value,\n\t\t\t\t)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase 'pitchbend': {\n\t\t\t\tconst pb = midiEvent as MidiEventPitchbend\n\t\t\t\tconsole.log(`[Sketch #onMIDI] Pitchbend event on channel ${channel}:`, pb.value)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tdefault:\n\t\t\t\tconsole.warn(`[Sketch #onMIDI] Unhandled MIDI event on channel ${channel}:`, kind, data, evt)\n\t\t\t\tbreak\n\t\t}\n\t}\n}\n","import React, { useEffect, useRef } from 'react'\nimport Sketch from './Sketch'\n\nconst VideoOutput: React.FC = () => {\n\tconst ref = useRef<HTMLDivElement>(null)\n\tconst sk = useRef<Sketch>(new Sketch())\n\tconst msg = useRef<string>(`Loading`)\n\tuseEffect(() => {\n\t\tif (!ref.current) {\n\t\t\tmsg.current = `Internal component error`\n\t\t\tconsole.warn(`[VideoOutput #useEffect] Can't find component reference`)\n\t\t\treturn\n\t\t}\n\t\tconst elem = ref.current as HTMLDivElement\n\t\tif (elem.childNodes[0]) {\n\t\t\telem.removeChild(elem.childNodes[0]) // remove previous sketch\n\t\t}\n\t\tconst { clientWidth, clientHeight } = elem\n\t\tconst skObj = sk.current\n\t\tskObj.setSize(clientWidth, clientHeight)\n\t\tconst sketch = new window.p5(skObj.sketch, elem)\n\t\treturn () => {\n\t\t\tskObj.destroy()\n\t\t\tsketch.remove()\n\t\t\tconsole.log('[VideoOutput #useEffect.return]')\n\t\t}\n\t})\n\treturn (\n\t\t<div\n\t\t\tref={ref}\n\t\t\tstyle={{\n\t\t\t\tdisplay: 'flex',\n\t\t\t\tflex: 1,\n\t\t\t\talignItems: 'center',\n\t\t\t\tjustifyContent: 'center',\n\t\t\t\tcolor: 'white',\n\t\t\t}}\n\t\t>\n\t\t\t{msg.current}\n\t\t</div>\n\t)\n}\n\nexport default VideoOutput\n","import React from 'react'\nimport VideoOutput from 'components/VideoOutput'\n\nimport './App.css'\n\nconst App: React.FC = () => {\n\treturn (\n\t\t<div\n\t\t\tclassName='App'\n\t\t\tstyle={{\n\t\t\t\tdisplay: 'flex',\n\t\t\t\tflexDirection: 'column',\n\t\t\t\tposition: 'absolute',\n\t\t\t\tbackgroundColor: '#383838',\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0,\n\t\t\t\tright: 0,\n\t\t\t\tbottom: 0,\n\t\t\t}}\n\t\t>\n\t\t\t<VideoOutput />\n\t\t</div>\n\t)\n}\n\nexport default App\n"],"sourceRoot":""}