{"version":3,"sources":["app/serverApi/serverApi.ts","app/serverApi/serverClock.ts","index.tsx","app/serverApi/WSClock.ts","engine3d/core/Vec.ts","engine3d/core/Bounds.ts","engine3d/core/Xform.ts","engine3d/core/Component.ts","engine3d/core/engine3d.ts","engine3d/core/Obj.ts","engine3d/components/Physical.ts","engine3d/components/FollowCam.ts","engine3d/objs/DancerObj.ts","engine3d/objs/Avatar.ts","engine3d/objs/BlackHoleObj.ts","engine3d/objs/Ground.ts","app/constants.ts","app/serverApi/WSClient.ts","app/MIDI.ts","app/util.ts","app/InstControls.ts","app/Instrument.ts","app/instruments/BlackHole.ts","app/instruments/Dancer.ts","app/instruments/Sampler.ts","app/instruments/EightOhEight.ts","app/instruments/Hoover.ts","app/instruments/Metronome.ts","app/instruments/Piano.ts","app/instruments/PolySynth.ts","vendor/p5.easycam.js","app/SketchInputs.ts","app/SketchAudioKeys.ts","app/Loop.ts","app/Loops.ts","app/Sketch.ts","app/VideoOutput.tsx","app/App.tsx"],"names":["WS_URL","WS_HEADER_END","WS_CLIENT_ID","parseClientId","body","JSON","parse","clientId","WS_USERS_ALL","WS_USER_EVENT","WS_USER_FORCE","WS_USER_XFORM","WS_USER_REQUEST_XFORMS","parseUsersAll","parseUserEvent","parseUserForce","parseUserXform","userUpdateReq","req","stringify","userEventReq","userXformReq","userRequestXformsReq","WS_CLOCK_NOW","WS_CLOCK_ORIGIN","WS_CLOCK_UPDATE","NOTE_METRONOME_BPM_CHANGED","NOTE_METRONOME_DOWN","clockNowReq","clockUpdateReq","clk","parseClockUpdate","App","require","default","ReactDOM","render","document","getElementById","WSClock","global","conn","options","localOrigin","correction","precision","correction2","precision2","lowpass","lastReqAt","lastRespAt","loopId","syncInitial","serverOrigin","precisionNow","pingMs","syncPeriod","synced","update","readyState","WebSocket","OPEN","nowRaw","send","clearTimeout","destroy","this","performance","timeOrigin","setInterval","now","originMs","console","error","nowMs","dur","delta","deltaNow","onSynced","nn","c2gain","perfTime","globalTime","Vec","w","clone","x","y","z","cloneMult","val","applyMult","cloneAdd","applyAdd","cloneSub","applySub","isZero","isOne","isEqual","other","normalize","mag","toArray","setFromArray","vals","length","cloneMultMat","mat","dest","Math","abs","Number","EPSILON","window","p5","Vector","Bounds","min","max","cloneXform","xform","applyXform","applyTo","sanitize","tmp","pushInside","off","centerAndSize","center","size","Xform","pos","rot","scale","vec","Component","parent","drawDebug","log","_dt","warn","engine3d","opts","objs","debug","lastUpdate","addObj","obj","unshift","rmObj","filter","oo","getObjs","objType","getObj","Date","valueOf","dt","forEach","draw","pg","drawShadow","draw2D","pp","gg","mvp","_renderer","uMVMatrix","copy","mult","uPMatrix","mat4","Obj","children","comps","drawFunc","drawShadowFunc","drawFunc2D","cc","rm","rmChild","addChild","push","getChildren","getChild","addComp","comp","rmComp","getComps","compType","getComp","applyXformToGraphics","translate","rotateZ","rotateY","rotateX","pop","ndcPos","ndcPos2","ndcPos3","ndcPos4","ndc","width","height","scale2d","gravity","Physical","force","vel","bounds","world","magSq","worldBounds","noFill","stroke","strokeWeight","box","worldScale","worldXZGain","FollowCam","cam","last","state","setCenter","defaultEnvOpts","attack","attackCurve","decay","decayCurve","sustain","release","releaseCurve","DanceMoves","envs","dip","Tone","stepLeft","stepRight","spinLeft","spinRight","headbang","armsLUpperY","armsLUpperZ","armsLLowerX","armsRUpperY","armsRUpperZ","armsRLowerX","value","sizes","leg","stepLeftRight","rotHead","PI","rotArms","l","upper","r","lower","noteEnvMap","0","1","2","3","4","5","6","7","8","9","10","11","noteEvent","time","evt","kind","note","move","triggerAttack","triggerRelease","handleADSR","props","kk","set","armUpper","armLower","neck","head","defaultArmsRot","DancerObj","moves","vol","colors","hue","sat","lgt","hand","handleCC","ctrls","localUser","controlchangeNext","schedule","controlchange","slider","getSliderForCtrl","controller","number","tt","label","handleModwheel","rng","seedrandom","part","quick","setFill","col","fill","scale2D","Avatar","cs","colorMode","HSL","noStroke","sphere","drawHead","drawArm","left","circle","phys","user","followCam","onForce","dancer","facing","keys","up","down","right","jump","jumpInitial","gain","sketch","inputs","hiddenLabels","name","instrument","offset","ss","sss","textAlign","CENTER","BOTTOM","textSize","textStyle","BOLD","text","ITALIC","addFollowCam","getUserXform","setUserXform","data","setUserForce","keyPressed","keyChanged","keyReleased","pressed","key","keysUpdated","mov","ca","centerAxes","cax","caz","ff","atan2","BlackHoleObj","origin2D","shaderBlackHole","backbuffer","blackHole","instruments","shader","setUniform","modwheel","resetShader","Ground","sz","rect","BLACK_KEYS","WSClient","clock","users","isReady","reopen","CLOSED","newConn","ready","onclose","code","setTimeout","onopen","onerror","onmessage","onMessage","parts","str","sep","out","sepRe","RegExp","prevIndex","lastIndex","re","exec","slice","index","split","onClientId","onClockOrigin","onClockNow","clkOpts","onClockUpdate","uu","onUsers","uevt","onUserEvent","onUserForce","onUserXform","onUserRequestXforms","getUser","newMidiEvent","channel","target","type","_number","allChannels","Array","map","allEvents","MIDI","webMidi","enabled","enable","a","onEnabled","WebMidi","outputs","input","eventName","addListener","channels","noteFreq","toFrequency","srand","random","srandVec","mix","aa","bb","xx","_ctrlColorMemo","ctrlColor","ctrl","seed","InstControls","sliders","includes","mousePressed","mouse","mouseX","mouseY","ismousedown","mouseReleased","_evt","valueNext","pitchbendNext","getSliderForPitchbend","pitchbend","getSliderForLabel","lbl","s","InstControl","yy","_wasPressed","_ee","valueLastSent","sendValue","setValueNext","drawVal","TOP","toUpperCase","vw","vx","square","valueY","vv","midiEvt","undefined","sendUserEvent","hh","Instrument","panVol","handleDetune","handleFilter","handlePitchbend","_avatar","_time","avatar","frequency","pow","Q","pan","mute","volume","BlackHole","reverb","synth","freqNode","freq","noiseGain","noise","ps","psSpread","maxObjs","ii","_attacks","noteon","exponentialRampToValueAtTime","setValueAtTime","addBHObj","noteoff","detune","envelope","_rr","_lastPos","objSize","apos","rr","rotate","BHObj","noteEvt","twist","mass","toDestination","wet","connect","delay","delayTime","feedback","addend","playbackRate","start","num","portamento","inst","createdAt","scaleOrig","voice","massOrig","twistDir","mm","im","Dancer","lr","Sampler","sampler","pitchShift","pitch","fq","sin","loaded","samps","EightOhEight","urls","baseUrl","eightOhEight","modNote","bgCol","ground","Hoover","chorus","amGain","amOsc","harmonicity","HooverObj","wave","fft","setNote","floor","oscillator","count","spread","amScale","chain","normalRange","hoover","_ff","lp","calcLaserParams","drawLasers","empty","Float32Array","waveMin","waveMax","volCtrl","visThresh","getValue","valsMax","valsMin","fftVals","params","color","curStrokeColor","_array","line","Metronome","metronome","pianoSamps","A0","C1","A1","C2","A2","C3","A3","C4","A4","C5","A5","C6","A6","C7","A7","C8","Piano","PolySynth","filterVol","addSynthObj","_activeVoices","released","midi","SynthObj","polySynth","mod","RGB","ext","INFO","LIBRARY","VERSION","AUTHOR","SOURCE","toString","EasyCam","renderer","args","RendererGL","distance","rotation","Rotation","identity","viewport","setCanvas","LOOK","UP","AXIS","YAW","PITCH","ROLL","ALL","SHIFT_CONSTRAINT","FIXED_CONSTRAINT","DRAG_CONSTRAINT","scale_rotation","scale_pan","scale_zoom","scale_zoomwheel","distance_min_limit","distance_min","distance_max","MAX_VALUE","dst","state_reset","state_pushed","curr","prev","dist","mwheel","isPressed","istouchdown","BUTTON","LMB","MMB","RMB","button","mouseDragLeft","mouseDragRotate","bind","mouseDragCenter","mouseDragPan","mouseDragRight","mouseDragZoom","mouseWheelAction","mouseWheelZoom","touchmoveSingle","touchmoveMulti","insideViewport","x0","x1","y0","y1","solveConstraint","dx","dy","shiftKey","updateInput","pd","P5","pixelDensity","mousedown","event","mousedrag","mouseup","dblclick","reset","wheel","deltaY","evaluateTouches","i","touches","avg_x","avg_y","avg_d","clientX","clientY","sqrt","touchstart","preventDefault","stopPropagation","dbltap","touchmove","tapcount","touchend","keydown","keyCode","keyup","attachMouseListeners","auto_update","registerMethod","dampedZoom","DampedAction","d","zoom","getZoomMult","dampedPanX","panX","getPanMult","dampedPanY","panY","dampedPanZ","panZ","dampedRotX","getRotationMult","dampedRotY","dampedRotZ","timedRot","Interpolation","setInterpolatedRotation","timedPan","setInterpolatedCenter","timedzoom","setInterpolatedDistance","_pInst","graphics","el","ev","fx","op","detachListener","addEventListener","removeEventListener","passive","elt","attachListener","status","b_update","stop","apply","camEYE","getPosition","camLAT","getCenter","camRUP","getUpVector","_curCamera","camera","addForce","mx","my","mxNdc","myNdc","log10","dz","distance_tmp","applyToVec3","Vec3","add","screenX","mX","screenZ","cross","rx","ry","rz","axis","angle","new_rotation","create","applyToRotation","valA","valB","t","Scalar","smoothstep","slerp","duration","assert","setDistance","setRotation","getState","setState","wheelScale","damping","default_duration","yaw","roll","h","pushed_rendererState","gl","drawingContext","ww","flush","disable","DEPTH_TEST","pushed_uMVMatrix","pushed_uPMatrix","resetMatrix","ortho","cb","action","active","actions","timer","getTime","interpolate","constructor","q0","q1","q2","q3","rotA","rotB","a0","a1","a2","a3","b0","b1","b2","b3","cosTheta","w1","w2","theta","acos","sinTheta","def","norm","halfAngle","coeff","cos","inv","angles_xyz","ax","ay","az","rotX","rotY","rotZ","b","smootherstep","isScalar","arg","dot","v1","v2","normProduct","threshold","v3","asin","Object","freeze","prettyUnit","unit","coarse","thresh","dec","toFixed","SketchInputs","loadedFromStorage","nameCustomized","hidden","clockOpts","bpm","help","helpRetoggle","loops","dial","helpImg","pingBeats","isFocused","focused","toggleHide","setup","setupInputsBPM","toggleHelp","hiddenDial","toggleHideDial","loadImage","remove","setupInputsHide","setupInputsUser","ws","setupInputsInstrument","hide","hideLoops","hideLabels","showHelp","createButton","position","toggleHideText","innerHTML","defaultName","updateUser","latency","createInput","inName","inLatency","onfocus","onblur","setLatency","lat","parseFloat","isNaN","updateRecOffset","inInst","createSelect","uinst","instName","option","selected","changed","setupInputsMidi","inputDevice","inMidi","_midiInput","inBPM","createSlider","sendClockUpdate","drawHelp","drawClockStats","LEFT","msg","ppLabel","RIGHT","ppValue","beatMs","prec","precStr","pingStr","xc","haspect","hx","hy","background","image","keyIsDown","switchTo","SketchAudioKeys","audioKeys","velocity","keyboardInputDisabled","AudioKeys","polyphony","Infinity","Loop","headPlay","headRec","isActive","isDial","isRecording","pgControls","pgNotes","needsRenderControls","needsRenderNotes","id","evts","isMuted","save","localStorage","setItem","load","dataStr","getItem","loadData","removeItem","beats","le","timestamp","setRadius","rad","radius","loopLenMs","loopUserEvent","recOff","offsetMs","loopTime","timeGlobalToLoopNorm","levt","midiEvent","attacks","filterNote","attackEvents","attackEvt","minDiff","relTime","ae","diff","sanitizeEvents","ee","updateClientId","releaseEvents","controlEvents","sortByLoopTime","sort","groupByController","resp","clearAllEvents","_lastDownbeat","_lastBeats","play","rec","headRecPrev","downbeat","lt","_sendUserEvent","timeLoopNormToGlobal","after","recStartedAt","isDown","isFirst","drawLine","drawEvents","arcPlay","ceil","arcRec","recFillAlpha","drawArc","drawControls","drawNotes","createGraphics","radBig","tmpx","tmpy","renderControls","renderNotes","_drawNotes","lx","ly","fromTime","from","arc","clear","cevts","len","nextEvtIdx","nextTime","unreleasedOnly","modNotes","timeGlobalToLoop","timeLoopToGlobal","timeLastLoopStartMs","hitTest","uuid","defaultLoopParams","Loops","activeLoop","recLock","store","lidsStr","aid","lids","lid","loop","saveLoopRefs","ll","copyToClipboard","navigator","clipboard","writeText","pasteFromClipboard","readText","newId","activateLoop","didSetup","loopLen","newLoopBtn","setupInputs","btnHalfwidth","offsetWidth","othersTop","offsetHeight","inactiveLoops","NORMAL","addLoop","dialBeats","recOffset","clearAll","clearActiveLoop","toggleActiveLoopMute","al","muteAll","toggleHideDialText","stopRecording","didHit","activatePrev","activateNext","newAvatarPos","started","syncing","transportStarted","_bpm","_bpmNext","instSliders","avatars","loadFromStorage","ustr","close","timeGlobalToTone","rawContext","_nativeAudioContext","getOutputTimestamp","contextTime","performanceTime","toLocal","timeToneToGlobal","toneTime","pt","toGlobal","setSize","preload","loadShader","createCanvas","textureWrap","REPEAT","n","bbsize","clz32","WEBGL","setDistanceMin","setDistanceMax","setViewport","perspective","loading","drawMessage","BOLDITALIC","sendUpdate","assign","sendUserUpdate","getAvatar","getAvatarSafe","sendUserXform","sendUserRequestXforms","inputName","_eventName","isMetronome","onMetronome","pb","setNewDownbeat","prevs","some","bps","beatSec","offsetSec","didLoad","polysquare","piano","me","VideoOutput","ref","useRef","useEffect","current","elem","childNodes","removeChild","clientWidth","clientHeight","canvas","style","display","flex","alignItems","justifyContent","className","flexDirection","backgroundColor","top","bottom"],"mappings":"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","file":"static/js/main.c175f5d3.chunk.js","sourcesContent":["import { MidiEvent } from '../MIDI'\n\n// export const WS_URL = 'ws://localhost:38883'\n// export const WS_URL = 'wss://mikeylemmon.com/api'\nexport const WS_URL = 'wss://thumpy.space/api'\nexport const WS_HEADER_END = '#'\n\n//\n// Client API\n//\nexport const WS_CLIENT_ID = 'client/id'\nexport type ClientIdResp = { clientId: number }\n\nexport function parseClientId(body: string): number {\n\tconst resp: ClientIdResp = JSON.parse(body)\n\treturn resp.clientId\n}\n\n//\n// Users API\n//\nexport const WS_USERS_ALL = 'user/all'\nexport const WS_USER_UPDATE = 'user/update'\nexport const WS_USER_EVENT = 'user/event'\nexport const WS_USER_FORCE = 'user/force'\nexport const WS_USER_XFORM = 'user/xform'\nexport const WS_USER_REQUEST_XFORMS = 'user/request_xforms'\n\nexport type User = {\n\tclientId: number\n\tname: string\n\tinstrument: string\n\tinputDevice: string\n\toffset: number\n}\n\nexport type UserEvent = {\n\tclientId: number\n\tinstrument: string\n\tmidiEvent: MidiEvent\n\ttimestamp: number\n}\n\nexport type UserForce = {\n\tclientId: number\n\tforce: number[]\n}\n\nexport type UserXform = {\n\tclientId: number\n\tpos: number[]\n\trot: number[]\n\tscale: number[]\n\tforce: number[]\n\tvel: number[]\n}\n\nexport function parseUsersAll(body: string): User[] {\n\tconst resp: User[] = JSON.parse(body)\n\treturn resp\n}\nexport function parseUserEvent(body: string): UserEvent {\n\tconst resp: UserEvent = JSON.parse(body)\n\treturn resp\n}\nexport function parseUserForce(body: string): UserForce {\n\tconst resp: UserForce = JSON.parse(body)\n\treturn resp\n}\nexport function parseUserXform(body: string): UserXform {\n\tconst resp: UserXform = JSON.parse(body)\n\treturn resp\n}\n\nexport function userUpdateReq(req: User): string {\n\treturn WS_USER_UPDATE + WS_HEADER_END + JSON.stringify(req)\n}\nexport function userEventReq(req: UserEvent): string {\n\treturn WS_USER_EVENT + WS_HEADER_END + JSON.stringify(req)\n}\nexport function userForceReq(req: UserForce): string {\n\treturn WS_USER_FORCE + WS_HEADER_END + JSON.stringify(req)\n}\nexport function userXformReq(req: UserXform): string {\n\treturn WS_USER_XFORM + WS_HEADER_END + JSON.stringify(req)\n}\nexport function userRequestXformsReq(): string {\n\treturn WS_USER_REQUEST_XFORMS + WS_HEADER_END\n}\n","import { WS_HEADER_END } from './serverApi'\n\nexport const WS_CLOCK_NOW = 'clock/now'\nexport const WS_CLOCK_ORIGIN = 'clock/origin'\nexport const WS_CLOCK_UPDATE = 'clock/update'\nexport const NOTE_METRONOME_BPM_CHANGED = 32\nexport const NOTE_METRONOME_DOWN = 34\nexport const NOTE_METRONOME_UP = 35\n\nexport type ClockNowResp = { nowMs: number }\nexport type ClockOriginResp = { originMs: number }\nexport type ClockOpts = {\n\tbpm: number\n\tclientId?: number\n}\n\nexport const clockNowReq = () => WS_CLOCK_NOW + WS_HEADER_END\nexport const clockUpdateReq = (clk: ClockOpts) => WS_CLOCK_UPDATE + WS_HEADER_END + JSON.stringify(clk)\n\nexport function parseClockUpdate(body: string): ClockOpts {\n\tconst resp: ClockOpts = JSON.parse(body)\n\treturn resp\n}\n","import React from 'react'\nimport ReactDOM from 'react-dom'\nimport 'index.css'\n\nconst render = () => {\n\tconst App = require('app/App').default\n\n\tReactDOM.render(<App />, document.getElementById('root'))\n}\n\nrender()\n\nif (process.env.NODE_ENV === 'development' && module.hot) {\n\tmodule.hot.accept('./app/App', render)\n}\n","import { clockNowReq, ClockNowResp, ClockOriginResp } from './serverClock'\n\nconst SYNC_PERIOD_INITIAL_MS = 500,\n\tSYNC_INITIAL_NUM = 6, // number of times to use initial period\n\tSYNC_PERIOD_MS = 2000\n\nexport type WSClockOptions = {\n\tonSynced: () => void\n}\n\nexport default class WSClock {\n\tglobal: any\n\tconn: WebSocket\n\tlocalOrigin: number\n\tcorrection = 0 // a correction to apply to the local clock based on rolling-average deviation from server clock\n\tprecision = 0 // average of how accurate the workerClock is with correction applied\n\tcorrection2 = 0 // a derivative correction that accounts for linear clock deviation (i.e. local clock is X slower/faster than server)\n\tprecision2 = 0 // measures how accurate the workerClock is with correction and correction2 applied\n\tlowpass = 0.3 // how much latest sample affects correction/precision\n\tlastReqAt = 0\n\tlastRespAt = 0\n\tloopId = -1\n\tsyncInitial = 0\n\tserverOrigin = 0\n\tprecisionNow = 0\n\tpingMs = 0\n\tsyncPeriod = SYNC_PERIOD_INITIAL_MS\n\tsynced = false\n\toptions: Partial<WSClockOptions>\n\n\tconstructor(global: any, conn: WebSocket, options: Partial<WSClockOptions> = {}) {\n\t\tthis.global = global\n\t\tthis.options = options\n\t\t// this.localOrigin = global.performance.timing.navigationStart\n\t\tthis.localOrigin = global.performance.timeOrigin\n\t\tthis.conn = conn\n\t\tthis.loopId = global.setInterval(this.update, this.syncPeriod)\n\t}\n\n\tnowRaw() {\n\t\treturn global.performance.now()\n\t}\n\n\tupdate = () => {\n\t\tif (this.conn.readyState !== WebSocket.OPEN) {\n\t\t\tthis.global.clearTimeout(this.loopId)\n\t\t\treturn\n\t\t}\n\t\tthis.lastReqAt = this.nowRaw()\n\t\tthis.conn.send(clockNowReq())\n\t}\n\n\tdestroy = () => {\n\t\tthis.global.clearTimeout(this.loopId)\n\t}\n\n\tonClockOrigin(body: string) {\n\t\tconst resp: ClockOriginResp = JSON.parse(body)\n\t\tconst { originMs } = resp\n\t\tif (!originMs) {\n\t\t\tconsole.error('[workerClock #onClockOrigin] Received empty response')\n\t\t\treturn\n\t\t}\n\t\tthis.serverOrigin = originMs\n\t}\n\n\tonClockNow(body: string) {\n\t\tconst resp: ClockNowResp = JSON.parse(body)\n\t\tconst { nowMs } = resp || {}\n\t\tif (!nowMs) {\n\t\t\tconsole.error('[workerClock #onClockNow] Received empty response')\n\t\t\treturn\n\t\t}\n\t\tthis.lastRespAt = this.nowRaw()\n\t\tconst dur = this.lastRespAt - this.lastReqAt\n\t\tthis.pingMs = dur\n\t\tconst mid = dur / 2 + this.lastReqAt\n\t\tconst delta = nowMs - mid\n\t\tif (this.correction === 0) {\n\t\t\tthis.correction = delta\n\t\t} else {\n\t\t\tthis.correction = delta * this.lowpass + this.correction * (1 - this.lowpass)\n\t\t}\n\t\tconst precision = delta - this.correction\n\t\tif (this.precision === 0) {\n\t\t\tthis.precision = precision\n\t\t} else {\n\t\t\tthis.precision = precision * this.lowpass + this.precision * (1 - this.lowpass)\n\t\t}\n\t\t// Calculate a secondary correction based on the average value of precision to account\n\t\t// for the local clock being consistently slower/faster than the server clock\n\t\tthis.correction2 = this.precision * this.lowpass + this.correction2 * (1 - this.lowpass)\n\t\tconst precision2 = delta - this.correction - this.correction2\n\t\tif (this.precision2 === 0) {\n\t\t\tthis.precision2 = precision2\n\t\t} else {\n\t\t\tthis.precision2 = precision2 * this.lowpass + this.precision2 * (1 - this.lowpass)\n\t\t}\n\n\t\t// Calculate precision metrics for corrected \"now\" time\n\t\tconst now = this.now() - dur / 2\n\t\tconst deltaNow = now - nowMs\n\t\tthis.precisionNow = deltaNow * this.lowpass + this.precisionNow * (1 - this.lowpass)\n\n\t\t// console.log(\n\t\t// \t'[workerClock #onClockNow]',\n\t\t// \t{\n\t\t// \t\tp: this.precision,\n\t\t// \t\tp2: this.precision2,\n\t\t// \t\tc: this.correction,\n\t\t// \t\tc2: this.correction2,\n\t\t// \t},\n\t\t// \t{\n\t\t// \t\tlastP: precision,\n\t\t// \t\tlastP2: precision2,\n\t\t// \t\tdur,\n\t\t// \t},\n\t\t// \t{\n\t\t// \t\tnow: now,\n\t\t// \t\tnowMs: nowMs,\n\t\t// \t\td: deltaNow,\n\t\t// \t\tpnow: this.precisionNow,\n\t\t// \t},\n\t\t// \t{\n\t\t// \t\tnowOverP: this.precisionNow / this.precision2,\n\t\t// \t},\n\t\t// )\n\n\t\tif (!this.synced && this.syncInitial++ > SYNC_INITIAL_NUM) {\n\t\t\t// Replace sync loop with lower-frequency interval\n\t\t\tthis.synced = true\n\t\t\tthis.global.clearTimeout(this.loopId)\n\t\t\t// this.correction2 *= SYNC_PERIOD_MS / SYNC_PERIOD_INITIAL_MS\n\t\t\tthis.correction += this.correction2\n\t\t\tthis.syncPeriod = SYNC_PERIOD_MS\n\t\t\tthis.loopId = this.global.setInterval(this.update, this.syncPeriod)\n\t\t\tif (this.options.onSynced) {\n\t\t\t\tthis.options.onSynced()\n\t\t\t}\n\t\t}\n\t}\n\n\tnow() {\n\t\tconst nn = this.nowRaw()\n\t\tconst c2gain = 1 + (nn - this.lastRespAt) / this.syncPeriod\n\t\treturn nn + this.correction + this.correction2 * c2gain\n\t}\n\n\ttoGlobal(perfTime: number) {\n\t\treturn perfTime + this.correction + this.correction2\n\t}\n\n\ttoLocal(globalTime: number) {\n\t\treturn globalTime - this.correction - this.correction2\n\t}\n}\n","export class Vec extends window.p5.Vector {\n\tw = 0\n\n\tconstructor(...vals: number[]) {\n\t\tsuper()\n\t\tthis.setFromArray(vals)\n\t}\n\n\tclone = (): Vec => new Vec(this.x, this.y, this.z)\n\tcloneMult = (val: number | Vec) => this.clone().applyMult(val)\n\tcloneAdd = (val: number | Vec) => this.clone().applyAdd(val)\n\tcloneSub = (val: number | Vec) => this.clone().applySub(val)\n\n\tisZero = () => this.x === 0 && this.y === 0 && this.z === 0\n\tisOne = () => this.x === 1 && this.y === 1 && this.z === 1\n\tisEqual = (other: Vec) => this.x === other.x && this.y === other.y && this.z === other.z\n\tnormalize = () => this.applyMult(1.0/this.mag())\n\n\ttoArray = () => [this.x, this.y, this.z]\n\tsetFromArray = (vals: number[]) => {\n\t\tthis.x = vals.length > 0 ? vals[0] : 0\n\t\tthis.y = vals.length > 1 ? vals[1] : this.x\n\t\tthis.z = vals.length > 2 ? vals[2] : vals.length === 2 ? 0 : this.x\n\t\treturn this\n\t}\n\n\tapplyMult = (val: number | Vec) => {\n\t\tif (val instanceof Vec) {\n\t\t\tthis.x *= val.x\n\t\t\tthis.y *= val.y\n\t\t\tthis.z *= val.z\n\t\t\treturn this\n\t\t}\n\t\tthis.x *= val\n\t\tthis.y *= val\n\t\tthis.z *= val\n\t\treturn this\n\t}\n\n\tapplyAdd = (val: number | Vec) => {\n\t\tif (val instanceof Vec) {\n\t\t\tthis.x += val.x\n\t\t\tthis.y += val.y\n\t\t\tthis.z += val.z\n\t\t\treturn this\n\t\t}\n\t\tthis.x += val\n\t\tthis.y += val\n\t\tthis.z += val\n\t\treturn this\n\t}\n\n\tapplySub = (val: number | Vec) => {\n\t\tif (val instanceof Vec) {\n\t\t\tthis.x -= val.x\n\t\t\tthis.y -= val.y\n\t\t\tthis.z -= val.z\n\t\t\treturn this\n\t\t}\n\t\tthis.x -= val\n\t\tthis.y -= val\n\t\tthis.z -= val\n\t\treturn this\n\t}\n\n\tcloneMultMat = (mat: number[]): Vec => {\n\t\tif (!mat.length || mat.length !== 16) {\n\t\t\tconsole.error('[Vec #applyMult] invalid matrix provided for mult', mat)\n\t\t\treturn this.clone()\n\t\t}\n\t\tconst dest = new Vec()\n\t\tdest.x = mat[0] * this.x + mat[4] * this.y + mat[8] * this.z + mat[12]\n\t\tdest.y = mat[1] * this.x + mat[5] * this.y + mat[9] * this.z + mat[13]\n\t\tdest.z = mat[2] * this.x + mat[6] * this.y + mat[10] * this.z + mat[14]\n\t\tdest.w = mat[3] * this.x + mat[7] * this.y + mat[11] * this.z + mat[15]\n\t\tif (Math.abs(dest.w) > Number.EPSILON) {\n\t\t\tdest.applyMult(1.0 / dest.w)\n\t\t}\n\t\treturn dest\n\t}\n}\n","import { Vec } from './Vec'\nimport { Xform } from './Xform'\n\nexport class Bounds {\n\tmin = new Vec(-1.0)\n\tmax = new Vec(1.0)\n\n\tconstructor(min?: Vec, max?: Vec) {\n\t\tif (min) { this.min = min }\n\t\tif (max) { this.max = max }\n\t}\n\n\tclone = () => new Bounds(this.min.clone(), this.max.clone())\n\tcloneXform = (xform: Xform) => this.clone().applyXform(xform)\n\n\tapplyXform = (xform: Xform) => {\n\t\txform.applyTo(this.min)\n\t\txform.applyTo(this.max)\n\t\tthis.sanitize()\n\t\treturn this\n\t}\n\n\tsanitize = () => {\n\t\tif (this.min.x > this.max.x) {\n\t\t\tconst tmp = this.min.x\n\t\t\tthis.min.x = this.max.x\n\t\t\tthis.max.x = tmp\n\t\t}\n\t\tif (this.min.y > this.max.y) {\n\t\t\tconst tmp = this.min.y\n\t\t\tthis.min.y = this.max.y\n\t\t\tthis.max.y = tmp\n\t\t}\n\t\tif (this.min.z > this.max.z) {\n\t\t\tconst tmp = this.min.z\n\t\t\tthis.min.z = this.max.z\n\t\t\tthis.max.z = tmp\n\t\t}\n\t\treturn this\n\t}\n\n\t// pushInside returns a zero vector if this bounds is inside the other bounds;\n\t// otherwise, returns the vector required to move this bounds into other\n\tpushInside = (other: Bounds): Vec => {\n\t\tconst off = new Vec()\n\t\tif (this.min.x < other.min.x) {\n\t\t\toff.x = other.min.x - this.min.x\n\t\t} else if (this.max.x > other.max.x) {\n\t\t\toff.x = other.max.x - this.max.x\n\t\t}\n\t\tif (this.min.y < other.min.y) {\n\t\t\toff.y = other.min.y - this.min.y\n\t\t} else if (this.max.y > other.max.y) {\n\t\t\toff.y = other.max.y - this.max.y\n\t\t}\n\t\tif (this.min.z < other.min.z) {\n\t\t\toff.z = other.min.z - this.min.z\n\t\t} else if (this.max.z > other.max.z) {\n\t\t\toff.z = other.max.z - this.max.z\n\t\t}\n\t\treturn off\n\t}\n\n\tcenterAndSize = () => {\n\t\treturn {\n\t\t\tcenter: new Vec(\n\t\t\t\t(this.max.x + this.min.x) / 2,\n\t\t\t\t(this.max.y + this.min.y) / 2,\n\t\t\t\t(this.max.z + this.min.z) / 2,\n\t\t\t),\n\t\t\tsize: new Vec(\n\t\t\t\t(this.max.x - this.min.x),\n\t\t\t\t(this.max.y - this.min.y),\n\t\t\t\t(this.max.z - this.min.z),\n\t\t\t),\n\t\t}\n\t}\n}\n","import { Vec } from './Vec'\n\nexport class Xform {\n\tpos: Vec\n\trot: Vec\n\tscale: Vec\n\n\tconstructor(pos?: Vec, rot?: Vec, scale?: Vec) {\n\t\tthis.pos = pos ? pos : new Vec()\n\t\tthis.rot = rot ? rot : new Vec()\n\t\tthis.scale = scale ? scale : new Vec(1.0)\n\t}\n\n\tapplyTo = (vec: Vec) => {\n\t\tvec.applyMult(this.scale)\n\t\t// TODO: rotation\n\t\tvec.applyAdd(this.pos)\n\t}\n}\n","import { drawFunc, Obj } from './Obj'\n\nexport class Component {\n\tparent: Obj\n\tdrawDebug?: drawFunc\n\n\tconstructor(parent: Obj) {\n\t\tthis.parent = parent\n\t}\n\n\tdestroy() {\n\t\tconsole.log('[Component] destroyed')\n\t}\n\n\tupdate(_dt: number) {\n\t\tconsole.warn('[Component] update')\n\t}\n}\n","import * as p5 from 'p5'\nimport { Obj } from './Obj'\n\nexport type Engine3DOpts = {\n\tdebug?: boolean\n}\n\nexport class Engine3D {\n\tobjs: Obj[] = []\n\tdebug = false\n\tlastUpdate?: number\n\n\tconstructor(opts: Engine3DOpts = {}) {\n\t\tif (opts.debug) {\n\t\t\tthis.debug = true\n\t\t}\n\t}\n\n\taddObj = (obj: Obj) => this.objs.unshift(obj)\n\trmObj = (obj: Obj, destroy = true) => {\n\t\tthis.objs = this.objs.filter(oo => {\n\t\t\tif (oo === obj) {\n\t\t\t\tif (destroy) {\n\t\t\t\t\too.destroy()\n\t\t\t\t}\n\t\t\t\treturn false\n\t\t\t}\n\t\t\treturn true\n\t\t})\n\t}\n\tgetObjs = (objType: any) => this.objs.filter(oo => oo instanceof objType)\n\tgetObj = (objType: any): Obj | undefined => {\n\t\tfor (const oo of this.objs) {\n\t\t\tif (oo instanceof objType) {\n\t\t\t\treturn oo\n\t\t\t}\n\t\t}\n\t}\n\n\tupdate = () => {\n\t\tif (!this.lastUpdate) {\n\t\t\tthis.lastUpdate = new Date().valueOf()\n\t\t\treturn\n\t\t}\n\t\tconst now = new Date().valueOf()\n\t\tconst dt = (now - this.lastUpdate) / 1000\n\t\tthis.lastUpdate = now\n\t\tthis.objs.forEach(oo => oo.update(dt))\n\t}\n\n\tdraw = (pg: p5.Graphics) => {\n\t\tfor (const obj of this.objs) {\n\t\t\tobj.draw(pg)\n\t\t\tobj.drawShadow(pg)\n\t\t\tif (this.debug) {\n\t\t\t\tobj.drawDebug(pg)\n\t\t\t}\n\t\t}\n\t}\n\n\tdraw2D = (pp: p5, pg: p5.Graphics) => {\n\t\tconst gg = pg as any\n\t\tconst mvp = gg._renderer.uMVMatrix.copy().mult(gg._renderer.uPMatrix)\n\t\tfor (const obj of this.objs) {\n\t\t\tobj.draw2D(pp, pg, mvp.mat4)\n\t\t}\n\t}\n}\n\nexport const engine3d = new Engine3D({ debug: false })\n","import * as p5 from 'p5'\nimport { Vec } from './Vec'\nimport { Xform } from './Xform'\nimport { Component } from './Component'\nimport { engine3d } from './engine3d'\n\nexport type drawFunc = (pg: p5.Graphics) => void\nexport type drawFunc2D = (pp: p5, pos: Vec, scale: number) => void\n\nexport type ObjOpts = {\n\tparent?: Obj\n\tchildren?: Obj[]\n\tcomps?: Component[]\n\tpos?: Vec\n\trot?: Vec\n\tscale?: Vec\n\tdraw?: drawFunc\n\tdrawShadow?: drawFunc\n\tdraw2D?: drawFunc2D\n}\n\nexport class Obj {\n\tchildren: Obj[] = []\n\tcomps: Component[] = []\n\txform: Xform = new Xform()\n\tparent?: Obj\n\tdrawFunc?: drawFunc\n\tdrawShadowFunc?: drawFunc\n\tdrawFunc2D?: drawFunc2D\n\n\tconstructor(opts: ObjOpts = {}) {\n\t\t// console.log('[Obj] ctor', this)\n\t\tthis.drawFunc = opts.draw\n\t\tthis.drawFunc2D = opts.draw2D\n\t\tthis.parent = opts.parent\n\t\tif (opts.children) {\n\t\t\tthis.children = opts.children\n\t\t}\n\t\tif (opts.comps) {\n\t\t\tthis.comps = opts.comps\n\t\t}\n\t\tif (opts.pos) {\n\t\t\tthis.xform.pos = opts.pos\n\t\t}\n\t\tif (opts.rot) {\n\t\t\tthis.xform.rot = opts.rot\n\t\t}\n\t\tif (opts.scale) {\n\t\t\tthis.xform.scale = opts.scale\n\t\t}\n\t\tengine3d.addObj(this)\n\t}\n\n\tdestroy = () => {\n\t\tthis.comps.forEach(cc => cc.destroy())\n\t\tthis.children.forEach(cc => cc.destroy())\n\t\t// console.log('[Obj] destroyed')\n\t}\n\trm = () => {\n\t\tif (this.parent) {\n\t\t\tthis.parent.rmChild(this)\n\t\t} else {\n\t\t\tengine3d.rmObj(this)\n\t\t}\n\t}\n\n\taddChild = (obj: Obj) => {\n\t\tengine3d.rmObj(obj, false) // remove Obj from root hierarchy\n\t\tobj.parent = this\n\t\tthis.children.push(obj)\n\t}\n\trmChild = (obj: Obj) => {\n\t\tthis.children = this.children.filter(cc => {\n\t\t\tif (cc === obj) {\n\t\t\t\tcc.destroy()\n\t\t\t\treturn false\n\t\t\t}\n\t\t\treturn true\n\t\t})\n\t}\n\tgetChildren = (objType: any) => this.children.filter(oo => oo instanceof objType)\n\tgetChild = (objType: any): Obj | undefined => this.getChildren(objType)[0]\n\n\taddComp = (comp: Component) => {\n\t\tthis.comps.push(comp)\n\t}\n\trmComp = (comp: Component) => {\n\t\tthis.comps = this.comps.filter(cc => {\n\t\t\tif (cc === comp) {\n\t\t\t\tcc.destroy()\n\t\t\t\treturn false\n\t\t\t}\n\t\t\treturn true\n\t\t})\n\t}\n\tgetComps = (compType: any) => this.comps.filter(cc => cc instanceof compType)\n\tgetComp = (compType: any): Component | undefined => this.getComps(compType)[0]\n\n\tupdate(dt: number) {\n\t\tthis.comps.forEach(cc => cc.update(dt))\n\t\tthis.children.forEach(cc => cc.update(dt))\n\t}\n\n\tdraw(pg: p5.Graphics) {\n\t\tpg.push()\n\t\tthis.applyXformToGraphics(pg)\n\t\tif (this.drawFunc) {\n\t\t\tthis.drawFunc(pg)\n\t\t}\n\t\tthis.children.forEach(cc => cc.draw(pg))\n\t\tpg.pop()\n\t}\n\n\tdrawShadow(pg: p5.Graphics) {\n\t\t// Similar to draw, but xformed to ground plane\n\t\tpg.push()\n\t\tconst { pos, rot, scale } = this.xform\n\t\tpg.translate(pos.x, 0, pos.z)\n\t\tif (rot.y !== 0) pg.rotateY(rot.y)\n\t\tpg.scale(scale.x, 1, scale.z)\n\t\tif (this.drawShadowFunc) {\n\t\t\tthis.drawShadowFunc(pg)\n\t\t}\n\t\tthis.children.forEach(cc => cc.drawShadow(pg))\n\t\tpg.pop()\n\t}\n\n\tdraw2D(pp: p5, pg: p5.Graphics, mvp: number[]) {\n\t\tthis.children.forEach(cc => cc.draw2D(pp, pg, mvp))\n\t\tif (!this.drawFunc2D) {\n\t\t\treturn\n\t\t}\n\t\tconst { pos, scale } = this.xform\n\t\tconst ndcPos = pos.cloneMultMat(mvp)\n\t\tconst edge = 1.2\n\t\tif (ndcPos.w < 0 || ndcPos.x < -edge || ndcPos.x > edge || ndcPos.y < -edge || ndcPos.y > edge) {\n\t\t\t// object is off-screen\n\t\t\treturn\n\t\t}\n\t\t// calculate a rough-guess at screen-space scale\n\t\t// (would use inverse MVP matrix but I can't get p5's matrix invert method to work)\n\t\tconst ndcPos2 = pos.cloneAdd(scale).cloneMultMat(mvp)\n\t\tconst ndcPos3 = pos.cloneAdd(scale.cloneMult(new Vec(1, -1, -1))).cloneMultMat(mvp)\n\t\tconst ndcPos4 = pos.cloneAdd(scale.cloneMult(new Vec(-1, -1, 1))).cloneMultMat(mvp)\n\t\tfor (const ndc of [ndcPos, ndcPos2, ndcPos3, ndcPos4]) {\n\t\t\tndc.x = ((ndc.x + 1) * pp.width) / 2\n\t\t\tndc.y = ((1 - ndc.y) * pp.height) / 2\n\t\t\tndc.z = 0\n\t\t}\n\t\tconst scale2d = Math.max(\n\t\t\tndcPos.cloneSub(ndcPos2).mag(),\n\t\t\tndcPos.cloneSub(ndcPos3).mag(),\n\t\t\tndcPos.cloneSub(ndcPos4).mag(),\n\t\t)\n\t\tpp.push()\n\t\tthis.drawFunc2D(pp, ndcPos, scale2d)\n\t\tpp.pop()\n\t}\n\n\tdrawDebug = (pg: p5.Graphics) => {\n\t\tthis.comps.forEach(cc => cc.drawDebug && cc.drawDebug(pg))\n\t}\n\n\tapplyXformToGraphics = (pg: p5.Graphics) => {\n\t\tconst { pos, rot, scale } = this.xform\n\t\tif (!pos.isZero()) {\n\t\t\tpg.translate(pos.x, pos.y, pos.z)\n\t\t}\n\t\tif (rot.z !== 0) pg.rotateZ(rot.z)\n\t\tif (rot.y !== 0) pg.rotateY(rot.y)\n\t\tif (rot.x !== 0) pg.rotateX(rot.x)\n\t\tif (!scale.isOne()) {\n\t\t\tpg.scale(scale.x, scale.y, scale.z)\n\t\t}\n\t}\n}\n","import { Bounds, Component, Obj, Vec } from '../core'\n\nconst gravity = new Vec(0, -9.82, 0)\nexport type PhysicalOpts = {\n\tbounds?: Bounds\n\tworldScale?: number\n}\n\n// Physical is a very simple physics implementation, applying forces\n// to the parent object and constraining it to a hard-coded world bounds\nexport class Physical extends Component {\n\tforce = new Vec()\n\tvel = new Vec()\n\tbounds: Bounds\n\tworld: Bounds\n\n\tconstructor(parent: Obj, opts: PhysicalOpts = {}) {\n\t\tsuper(parent)\n\t\tthis.bounds = opts.bounds ? opts.bounds : new Bounds()\n\t\tif (!opts.worldScale) {\n\t\t\topts.worldScale = 1000\n\t\t}\n\t\tconst worldXZGain = 5\n\t\tthis.world = new Bounds(\n\t\t\tnew Vec(-opts.worldScale * worldXZGain, 0, -opts.worldScale * worldXZGain),\n\t\t\tnew Vec(opts.worldScale * worldXZGain, opts.worldScale, opts.worldScale * worldXZGain),\n\t\t)\n\t}\n\n\tupdate = (dt: number) => {\n\t\t// Update velocity based on forces\n\t\tthis.vel.applyAdd(gravity.cloneAdd(this.force).applyMult(dt))\n\t\tthis.vel.applyMult(new Vec(0.8, 1.0, 0.8)) // friction in X and Z\n\t\tif (this.vel.magSq() < 0.01) {\n\t\t\t// Velocity threshold\n\t\t\tthis.vel.applyMult(0)\n\t\t}\n\t\t// Update position based on velocity\n\t\tconst { pos } = this.parent.xform\n\t\tpos.applyAdd(this.vel)\n\t\t// Constrain to world bounds\n\t\tconst off = this.worldBounds().pushInside(this.world)\n\t\tif (off.isZero()) {\n\t\t\treturn\n\t\t}\n\t\t// Apply constraint offset\n\t\tpos.applyAdd(off)\n\t\t// Bounce the velocity\n\t\tif (off.x !== 0) {\n\t\t\tthis.vel.x *= -0.5\n\t\t}\n\t\tif (off.y !== 0) {\n\t\t\tthis.vel.y *= -0.5\n\t\t}\n\t\tif (off.z !== 0) {\n\t\t\tthis.vel.z *= -0.5\n\t\t}\n\t}\n\n\tdrawDebug = (pg: p5.Graphics) => {\n\t\tconst { center, size } = this.worldBounds().centerAndSize()\n\t\tpg.push()\n\t\tpg.noFill()\n\t\tpg.stroke(255, 0, 0)\n\t\tpg.strokeWeight(1)\n\t\tpg.translate(center.x, center.y, center.z)\n\t\tpg.box(size.x, size.y, size.z)\n\t\tpg.pop()\n\t}\n\n\tworldBounds = () => this.bounds.cloneXform(this.parent.xform)\n}\n","import { EasyCam } from 'vendor/p5.easycam.js'\nimport { Component, Obj } from '../core'\n\n// FollowCam locks an EasyCam's center to the parent Obj\nexport class FollowCam extends Component {\n\tcam: EasyCam\n\n\tconstructor(parent: Obj, cam: EasyCam) {\n\t\tsuper(parent)\n\t\tthis.cam = cam\n\t}\n\n\tlast?: number\n\tupdate = (dt: number) => {\n\t\tif (!this.cam.state || !this.cam.state.center) {\n\t\t\treturn\n\t\t}\n\t\tconst { x, y, z } = this.parent.xform.pos\n\t\tthis.cam.setCenter([x, y, z], 0)\n\t}\n}\n","import * as p5 from 'p5'\nimport * as Tone from 'tone'\nimport seedrandom from 'seedrandom'\nimport { MidiEventNote } from 'app/MIDI'\nimport { ControlChange } from 'app/Instrument'\nimport { InstControls } from 'app/InstControls'\nimport { Component, Obj, ObjOpts, Vec } from '../core'\nimport { Avatar } from './Avatar'\n\nexport type DancerCC = ControlChange & {\n\tctrls: InstControls\n\tlocalUser: boolean\n\ttime: number\n}\n\nconst defaultEnvOpts = {\n\tattack: '0:0.25:0',\n\tattackCurve: 'linear',\n\tdecay: '0:0.5:0',\n\tdecayCurve: 'linear',\n\tsustain: 1,\n\trelease: '0:0.5:0',\n\treleaseCurve: 'linear',\n} as Tone.EnvelopeOptions\n\nclass DanceMoves extends Component {\n\tenvs: { [key: string]: Tone.Envelope } = {\n\t\tdip: new Tone.Envelope(defaultEnvOpts),\n\t\tstepLeft: new Tone.Envelope(defaultEnvOpts),\n\t\tstepRight: new Tone.Envelope(defaultEnvOpts),\n\t\tspinLeft: new Tone.Envelope(defaultEnvOpts),\n\t\tspinRight: new Tone.Envelope(defaultEnvOpts),\n\t\theadbang: new Tone.Envelope(defaultEnvOpts),\n\t\tarmsLUpperY: new Tone.Envelope(defaultEnvOpts),\n\t\tarmsLUpperZ: new Tone.Envelope(defaultEnvOpts),\n\t\tarmsLLowerX: new Tone.Envelope(defaultEnvOpts),\n\t\tarmsRUpperY: new Tone.Envelope(defaultEnvOpts),\n\t\tarmsRUpperZ: new Tone.Envelope(defaultEnvOpts),\n\t\tarmsRLowerX: new Tone.Envelope(defaultEnvOpts),\n\t}\n\n\tupdate = (dt: number) => {\n\t\tconst obj = this.parent as DancerObj\n\t\tconst { envs } = this\n\t\tobj.xform.pos.y = -envs.dip.value * sizes.leg.y * 0.8\n\t\tobj.stepLeftRight = 0.5 * (envs.stepRight.value - envs.stepLeft.value)\n\t\tconst avatar = obj.parent || obj\n\t\tavatar.xform.rot.y += dt * 20 * (envs.spinRight.value - envs.spinLeft.value)\n\t\tobj.rotHead.x = (envs.headbang.value * Math.PI) / 4\n\t\tobj.rotArms.l.upper.y = Math.PI * (0.4 - 0.7 * envs.armsLUpperY.value)\n\t\tobj.rotArms.r.upper.y = Math.PI * (0.4 - 0.7 * envs.armsRUpperY.value)\n\t\tobj.rotArms.l.upper.z = Math.PI * (1.1 + envs.armsLUpperZ.value)\n\t\tobj.rotArms.r.upper.z = Math.PI * (1.1 + envs.armsRUpperZ.value)\n\t\tobj.rotArms.l.lower.x = Math.PI * (0.1 + 0.7 * envs.armsLLowerX.value)\n\t\tobj.rotArms.r.lower.x = Math.PI * (0.1 + 0.7 * envs.armsRLowerX.value)\n\t}\n\n\tnoteEnvMap: { [key: number]: Tone.Envelope } = {\n\t\t0: this.envs.dip,\n\t\t1: this.envs.spinLeft,\n\t\t2: this.envs.headbang,\n\t\t3: this.envs.spinRight,\n\t\t4: this.envs.stepLeft,\n\t\t5: this.envs.stepRight,\n\t\t6: this.envs.armsLUpperZ,\n\t\t7: this.envs.armsRUpperZ,\n\t\t8: this.envs.armsLLowerX,\n\t\t9: this.envs.armsRLowerX,\n\t\t10: this.envs.armsLUpperY,\n\t\t11: this.envs.armsRUpperY,\n\t}\n\n\tnoteEvent = (time: number, evt: MidiEventNote) => {\n\t\tconst { kind, note, attack } = evt\n\t\tconst move = this.noteEnvMap[note % 12]\n\t\tif (kind === 'noteon') {\n\t\t\tmove.triggerAttack(time, attack)\n\t\t} else {\n\t\t\tmove.triggerRelease(time)\n\t\t}\n\t}\n\n\thandleADSR = (props: { [key: string]: string | number }) => {\n\t\tfor (const kk in this.envs) {\n\t\t\tconst env = this.envs[kk]\n\t\t\tenv.set(props)\n\t\t}\n\t}\n}\n\nconst sizes = {\n\tleg: new Vec(0.1, 0.5, 0.1),\n\tarmUpper: new Vec(0.1, 0.3, 0.1),\n\tarmLower: new Vec(0.1, 0.3, 0.1),\n\tbody: new Vec(0.4),\n\tneck: new Vec(0.05),\n\thead: new Vec(0.25),\n}\n\nconst defaultArmsRot = () => ({\n\tupper: new Vec(0, Math.PI * 0.4, Math.PI * 1.1),\n\tlower: new Vec(Math.PI * 0.1, 0, 0),\n})\n\nexport class DancerObj extends Obj {\n\tmoves: DanceMoves\n\trotHead = new Vec()\n\trotArms = {\n\t\tl: defaultArmsRot(),\n\t\tr: defaultArmsRot(),\n\t}\n\tstepLeftRight = 0\n\tvol = 0.5\n\tcolors: { [key: string]: { hue: number; sat: number; lgt: number } } = {\n\t\tstroke: { hue: 0, sat: 0, lgt: 0.9 },\n\t\tbody: { hue: 0, sat: 0, lgt: 0 },\n\t\thead: { hue: 0, sat: 0, lgt: 0 },\n\t\tarmUpper: { hue: 0, sat: 0, lgt: 0 },\n\t\tarmLower: { hue: 0, sat: 0, lgt: 0 },\n\t\thand: { hue: 0, sat: 0, lgt: 0 },\n\t}\n\n\tconstructor(opts: ObjOpts = {}) {\n\t\tsuper(opts)\n\t\tthis.moves = new DanceMoves(this)\n\t\tthis.addComp(this.moves)\n\t}\n\n\tnoteEvent = (time: number, evt: MidiEventNote) => {\n\t\tif (evt.attack) {\n\t\t\tevt.attack *= this.vol * 2\n\t\t}\n\t\tthis.moves.noteEvent(time, evt)\n\t}\n\n\thandleCC = (cc: DancerCC) => {\n\t\tconst { evt, ctrls, localUser, time } = cc\n\t\tif (!evt) {\n\t\t\tconsole.log('[DancerObj #handleCC] Received CC call with missing info', cc)\n\t\t\treturn\n\t\t}\n\t\tif (localUser) {\n\t\t\t// Update sliders if evt is from the local user\n\t\t\tctrls.controlchangeNext(evt)\n\t\t\tTone.Draw.schedule(() => ctrls.controlchange(evt), time)\n\t\t}\n\t\tconst slider = ctrls.getSliderForCtrl(evt.controller.number)\n\t\tif (!slider) {\n\t\t\tconsole.log('[DancerObj #handleCC] Unable to find control for CC event', cc)\n\t\t\treturn\n\t\t}\n\t\tconst tt = '0:' + evt.value + ':0' // Tone timecode for floating beat unit\n\t\tswitch (slider.label) {\n\t\t\tcase 'vol':\n\t\t\t\tthis.vol = evt.value\n\t\t\t\tbreak\n\t\t\tcase 'mod':\n\t\t\t\tTone.Draw.schedule(() => this.handleModwheel(evt.value), time)\n\t\t\t\tbreak\n\t\t\tcase 'a':\n\t\t\t\tthis.moves.handleADSR({ attack: tt })\n\t\t\t\tbreak\n\t\t\tcase 'd':\n\t\t\t\tthis.moves.handleADSR({ decay: tt })\n\t\t\t\tbreak\n\t\t\tcase 's':\n\t\t\t\tthis.moves.handleADSR({ sustain: evt.value })\n\t\t\t\tbreak\n\t\t\tcase 'r':\n\t\t\t\tthis.moves.handleADSR({ release: tt })\n\t\t\t\tbreak\n\t\t}\n\t}\n\n\thandleModwheel = (val: number) => {\n\t\tconst rng = seedrandom(`${val}`)\n\t\tfor (const kk in this.colors) {\n\t\t\tconst part = this.colors[kk]\n\t\t\tpart.hue = rng.quick()\n\t\t\tpart.sat = val ? rng.quick() * 0.7 + 0.3 : 0\n\t\t\tpart.lgt = val * 0.7\n\t\t\tif (kk === 'stroke') {\n\t\t\t\tpart.lgt = 0.9 - part.lgt\n\t\t\t}\n\t\t}\n\t}\n\n\tsetFill = (pg: p5.Graphics, part: string) => {\n\t\tconst col = this.colors[part]\n\t\tpg.fill(col.hue, col.sat, col.lgt)\n\t}\n\n\tdrawFunc = (pg: p5.Graphics) => {\n\t\tconst { leg, body } = sizes\n\t\tconst { parent } = this\n\t\tconst scale2D = (parent instanceof Avatar && parent.scale2D) || 500\n\t\tconst cs = this.colors.stroke\n\t\tpg.colorMode(pg.HSL, 1)\n\t\tpg.stroke(cs.hue, cs.sat, cs.lgt)\n\t\tif (scale2D < 35) {\n\t\t\tpg.noStroke()\n\t\t} else if (scale2D < 200) {\n\t\t\tpg.strokeWeight(1)\n\t\t} else {\n\t\t\tpg.strokeWeight(2)\n\t\t}\n\t\tpg.translate(this.stepLeftRight, -1 + leg.y + body.y, 0)\n\t\tthis.setFill(pg, 'body')\n\t\tpg.sphere(sizes.body.y, 7, 4)\n\t\tthis.setFill(pg, 'head')\n\t\tthis.drawHead(pg)\n\t\tthis.drawArm(pg, true)\n\t\tthis.drawArm(pg, false)\n\t}\n\n\tdrawHead = (pg: p5.Graphics) => {\n\t\tconst { body, neck, head } = sizes\n\t\tpg.push()\n\t\tpg.rotateX(this.rotHead.x)\n\t\tpg.push()\n\t\tpg.translate(0, body.y + neck.y + head.y, 0)\n\t\tpg.box(head.y * 1.8, head.y * 1.8, head.y * 1.8)\n\t\tpg.pop()\n\t\tpg.pop()\n\t}\n\n\tdrawArm = (pg: p5.Graphics, left = true) => {\n\t\tconst { body, armUpper, armLower } = sizes\n\t\tconst rot = left ? this.rotArms.l : this.rotArms.r\n\t\tpg.push()\n\t\tif (left) {\n\t\t\tpg.scale(-1, 1, 1)\n\t\t}\n\t\tpg.translate(body.x, body.y * 0.8, 0)\n\t\tpg.rotateZ(rot.upper.z).rotateY(rot.upper.y)\n\t\tpg.translate(0, armUpper.y / 2, 0)\n\t\tthis.setFill(pg, 'armUpper')\n\t\tpg.box(armUpper.x, armUpper.y, armUpper.z)\n\t\tpg.translate(0, 0.025 + armUpper.y / 2, 0)\n\t\tpg.rotateX(rot.lower.x)\n\t\tpg.translate(0, 0.025 + armLower.y / 2, 0)\n\t\tthis.setFill(pg, 'armLower')\n\t\tpg.box(armLower.x, armLower.y, armLower.z)\n\t\tpg.translate(0, 0.05 + armLower.y / 2 + armLower.x / 2, 0)\n\t\tthis.setFill(pg, 'hand')\n\t\tpg.box(armLower.x, armLower.x, armLower.x)\n\t\tpg.pop()\n\t}\n\n\tdrawShadowFunc = (pg: p5.Graphics) => {\n\t\tpg.push()\n\t\tpg.fill(30).noStroke()\n\t\tpg.rotateX(Math.PI / 2)\n\t\tpg.circle(this.stepLeftRight, 0, sizes.body.x * 2)\n\t\tpg.pop()\n\t}\n}\n","import * as p5 from 'p5'\nimport { EasyCam } from 'vendor/p5.easycam.js'\nimport { User, UserForce, UserXform } from 'app/serverApi/serverApi'\nimport { sketch } from 'app/Sketch'\nimport { Obj, ObjOpts, Vec } from '../core'\nimport { Physical, PhysicalOpts, FollowCam } from '../components'\nimport { DancerObj } from './DancerObj'\n\ntype KeyMovement = {\n\tup: boolean\n\tdown: boolean\n\tleft: boolean\n\tright: boolean\n\tjump: boolean\n\tjumpInitial: boolean\n\tgain: number\n}\n\ntype forceFunc = (data: UserXform) => void\n\nexport type AvatarOpts = ObjOpts & {\n\tuser: User\n\tphys?: PhysicalOpts\n\tonForce?: forceFunc\n}\n\nexport class Avatar extends Obj {\n\tphys: Physical\n\tuser: User\n\tfollowCam?: FollowCam\n\tonForce?: forceFunc\n\tdancer: DancerObj\n\tfacing: Vec\n\tscale2D = 100\n\n\tkeys: KeyMovement = {\n\t\tup: false,\n\t\tdown: false,\n\t\tleft: false,\n\t\tright: false,\n\t\tjump: false,\n\t\tjumpInitial: false,\n\t\tgain: 100,\n\t}\n\n\tconstructor(opts: AvatarOpts) {\n\t\tsuper(opts)\n\t\tthis.user = opts.user\n\t\tthis.phys = new Physical(this, opts.phys)\n\t\tthis.comps = [this.phys]\n\t\tthis.onForce = opts.onForce\n\t\tthis.dancer = new DancerObj()\n\t\tthis.facing = new Vec(0, 0, 1)\n\t\tthis.addChild(this.dancer)\n\t\tconsole.log('[Avatar] ctor', this)\n\t}\n\n\tupdate(dt: number) {\n\t\tsuper.update(dt)\n\t\tif (this.keys.jumpInitial) {\n\t\t\tthis.keys.jumpInitial = false\n\t\t\tthis.keysUpdated()\n\t\t}\n\t}\n\n\tdrawFunc2D = (pp: p5, pos: Vec, scale: number) => {\n\t\tthis.scale2D = scale\n\t\tif (sketch.inputs.hiddenLabels) {\n\t\t\treturn\n\t\t}\n\t\tconst { name, instrument, offset } = this.user\n\t\tif (scale < 15) {\n\t\t\treturn // avatar is very small on screen, so no text\n\t\t}\n\t\tconst ss = Math.min(scale, 50)\n\t\tconst sss = Math.min(scale, 200)\n\t\tpp.translate(pos.x, pos.y)\n\t\tpp.textAlign(pp.CENTER, pp.BOTTOM)\n\t\tpp.fill(255)\n\t\tpp.noStroke()\n\t\tpp.textSize(ss / 2)\n\t\tpp.textStyle(pp.BOLD)\n\t\tif (scale < 35) {\n\t\t\tpp.text(name, 0, -ss * 0.8)\n\t\t\treturn\n\t\t} else {\n\t\t\tpp.text(name, 0, -sss * 0.8)\n\t\t}\n\t\tpp.fill(225)\n\t\tpp.textSize(ss * 0.3)\n\t\tpp.textStyle(pp.ITALIC)\n\t\tpp.text(`${instrument} (@${offset > 0 ? '+' : ''}${offset})`, 0, -sss * 0.8 + ss * 0.35)\n\t}\n\n\taddFollowCam = (cam: EasyCam) => {\n\t\tthis.followCam = new FollowCam(this, cam)\n\t\tthis.followCam.update(0)\n\t\tthis.addComp(this.followCam)\n\t}\n\n\tgetUserXform = (): UserXform => ({\n\t\tclientId: this.user.clientId,\n\t\tpos: this.xform.pos.toArray(),\n\t\trot: this.xform.rot.toArray(),\n\t\tscale: this.xform.scale.toArray(),\n\t\tforce: this.phys.force.toArray(),\n\t\tvel: this.phys.vel.toArray(),\n\t})\n\n\tsetUserXform = (data: UserXform) => {\n\t\tthis.xform.pos.setFromArray(data.pos)\n\t\tthis.xform.rot.setFromArray(data.rot)\n\t\tthis.xform.scale.setFromArray(data.scale)\n\t\tthis.phys.force.setFromArray(data.force)\n\t\tthis.phys.vel.setFromArray(data.vel)\n\t}\n\n\tsetUserForce = (data: UserForce) => {\n\t\tthis.phys.force.setFromArray(data.force)\n\t}\n\n\t//\n\t// Keyboard state updates and movement controls\n\t//\n\tkeyPressed = (evt: p5) => this.keyChanged(evt, true)\n\tkeyReleased = (evt: p5) => this.keyChanged(evt, false)\n\tkeyChanged = (evt: p5, pressed: boolean) => {\n\t\tswitch (evt.key) {\n\t\t\tcase 'ArrowUp':\n\t\t\t\tthis.keys.up = pressed\n\t\t\t\tbreak\n\t\t\tcase 'ArrowDown':\n\t\t\t\tthis.keys.down = pressed\n\t\t\t\tbreak\n\t\t\tcase 'ArrowLeft':\n\t\t\t\tthis.keys.left = pressed\n\t\t\t\tbreak\n\t\t\tcase 'ArrowRight':\n\t\t\t\tthis.keys.right = pressed\n\t\t\t\tbreak\n\t\t\tcase ' ':\n\t\t\t\tthis.keys.jump = pressed\n\t\t\t\tthis.keys.jumpInitial = pressed\n\t\t\t\tbreak\n\t\t\tdefault:\n\t\t\t\treturn\n\t\t}\n\t\tthis.keysUpdated()\n\t}\n\n\t// keysUpdated applies force to the Physical component based on keyboard state and camera orientation\n\tkeysUpdated = () => {\n\t\tconst { up, down, left, right, jump, jumpInitial, gain } = this.keys\n\t\tconst mov = new Vec()\n\t\tmov.x = left && right ? 0 : left ? -gain : right ? gain : 0\n\t\tmov.y = jumpInitial && this.xform.pos.y < this.xform.scale.y * 1.5 ? gain * 3 : jump ? 6 : 0\n\t\tmov.z = down && up ? 0 : up ? gain : down ? -gain : 0\n\t\tif (!this.followCam) {\n\t\t\t// Can't determine camera orientation, apply force in world-space\n\t\t\tthis.phys.force = mov\n\t\t\tif (this.onForce) {\n\t\t\t\tthis.onForce(this.getUserXform())\n\t\t\t}\n\t\t\treturn\n\t\t}\n\t\t// Convert movement vector to force based on camera orientation\n\t\tconst ca = this.followCam.cam.centerAxes() // X=screen-right Z=screen-up, parallel to ground plane\n\t\tconst cax = new Vec(ca.x[0], 0, ca.x[2])\n\t\tconst caz = new Vec(ca.z[0], 0, ca.z[2])\n\t\tconst ff = new Vec(0, mov.y, 0)\n\t\tff.applyAdd(cax.applyMult(mov.x))\n\t\tff.applyAdd(caz.applyMult(mov.z))\n\t\tthis.phys.force = ff\n\t\tif (ff.x !== 0 || ff.z !== 0) {\n\t\t\t// Orient avatar to movement direction\n\t\t\tthis.xform.rot.y = Math.atan2(ff.x, ff.z)\n\t\t\tthis.facing = ff.clone().normalize()\n\t\t}\n\t\tif (this.onForce) {\n\t\t\tthis.onForce(this.getUserXform())\n\t\t}\n\t}\n}\n","import * as p5 from 'p5'\nimport { Obj, Vec } from '../core'\nimport { sketch } from 'app/Sketch'\nimport { BlackHole } from 'app/instruments'\n\nexport class BlackHoleObj extends Obj {\n\torigin2D = new Vec()\n\tscale2D = 1\n\n\tdraw(pg: p5.Graphics) {\n\t\tif (sketch && sketch.shaderBlackHole && sketch.backbuffer) {\n\t\t\tconst blackHole = sketch.instruments.blackHole as BlackHole\n\t\t\tpg.shader(sketch.shaderBlackHole)\n\t\t\tsketch.shaderBlackHole.setUniform('backbuffer', sketch.backbuffer)\n\t\t\tsketch.shaderBlackHole.setUniform('size', [pg.width, pg.height])\n\t\t\tsketch.shaderBlackHole.setUniform('rotate', blackHole.modwheel * Math.PI)\n\t\t}\n\t\tpg.fill(0, 0).noStroke()\n\t\tsuper.draw(pg) // apply xform and draw children\n\t\tpg.resetShader()\n\t}\n}\n","import * as p5 from 'p5'\nimport { Obj } from '../core'\n\nexport class Ground extends Obj {\n\thue = 0\n\tsat = 0\n\tlgt = 0.25\n\n\tdrawFunc = (pg: p5.Graphics) => {\n\t\tpg.colorMode(pg.HSL, 1).noFill().strokeWeight(4).stroke(this.hue, this.sat, 0.25)\n\t\tpg.rotateX(Math.PI / 2)\n\t\t// // Draw the perimeter\n\t\t// pg.rect(-1, -1, 2, 2)\n\t\tpg.circle(0, 0, 2.5)\n\t\t// Draw a square at the origin and in the middle of each quadrant to help\n\t\t// give the user more reference for distance as they move around\n\t\tconst sz = 0.05\n\t\tpg.rect(-sz, -sz, sz * 2, sz * 2)\n\t\tpg.rect(-0.5 - sz, -0.5 - sz, sz * 2, sz * 2)\n\t\tpg.rect(0.5 - sz, -0.5 - sz, sz * 2, sz * 2)\n\t\t// pg.rect(0.5 - sz, 0.5 - sz, sz * 2, sz * 2)\n\t\t// pg.rect(-0.5 - sz, 0.5 - sz, sz * 2, sz * 2)\n\t}\n}\n","export const KEYCODE_RETURN = 3\nexport const KEYCODE_ENTER = 13\nexport const KEYCODE_BACKSPACE = 8\nexport const KEYCODE_DELETE = 46\nexport const KEYCODE_SHIFT = 16\nexport const KEYCODE_CONTROL = 17\nexport const KEYCODE_ESC = 27\n\nexport const BLACK_KEYS = [1, 3, 6, 8, 10]\n","import {\n\tparseClientId,\n\tparseUsersAll,\n\tparseUserEvent,\n\tparseUserForce,\n\tparseUserXform,\n\tUser,\n\tUserEvent,\n\tUserForce,\n\tUserXform,\n\tWS_CLIENT_ID,\n\tWS_HEADER_END,\n\tWS_URL,\n\tWS_USERS_ALL,\n\tWS_USER_EVENT,\n\tWS_USER_FORCE,\n\tWS_USER_XFORM,\n\tWS_USER_REQUEST_XFORMS,\n} from './serverApi'\nimport { parseClockUpdate, ClockOpts, WS_CLOCK_NOW, WS_CLOCK_ORIGIN, WS_CLOCK_UPDATE } from './serverClock'\nimport WSClock, { WSClockOptions } from './WSClock'\n\nexport const DONT_REOPEN = 888\n\nexport type WSClientOptions = {\n\tclock: Partial<WSClockOptions>\n\tonClientId: (clientId: number) => any\n\tonClockUpdate: (clkOpts: ClockOpts) => void\n\tonUsers: (users: User[]) => void\n\tonUserEvent: (evt: UserEvent) => void\n\tonUserForce: (evt: UserForce) => void\n\tonUserXform: (evt: UserXform) => void\n\tonUserRequestXforms: () => void\n}\n\nexport default class WSClient {\n\tconn: WebSocket\n\tclock: WSClock\n\tglobal: any\n\toptions: WSClientOptions\n\tclientId: number = 0\n\tusers: User[] = []\n\tisReady = false\n\n\tconstructor(global: any, options: WSClientOptions) {\n\t\tthis.global = global\n\t\tthis.options = options as WSClientOptions\n\t\tthis.conn = this.newConn()\n\t\tthis.clock = new WSClock(this.global, this.conn, this.options.clock)\n\t}\n\n\treopen = () => {\n\t\t// Try to re-open the websocket connection if it has closed\n\t\tif (this.conn.readyState !== WebSocket.CLOSED) {\n\t\t\treturn\n\t\t}\n\t\tthis.conn = this.newConn()\n\t}\n\n\tready = () => this.conn && this.conn.readyState === WebSocket.OPEN && this.isReady\n\n\tnewConn = (): WebSocket => {\n\t\tthis.isReady = false\n\t\tconst conn = new WebSocket(WS_URL)\n\t\tconn.onclose = (evt: CloseEvent) => {\n\t\t\tif (evt.code === DONT_REOPEN) {\n\t\t\t\tconsole.warn('Closing for good', evt)\n\t\t\t\treturn\n\t\t\t}\n\t\t\tconsole.warn('WebSocket closed, will attempt to reopen in a few seconds', evt)\n\t\t\tsetTimeout(this.reopen, 5000)\n\t\t}\n\t\tconn.onopen = (evt: Event) => {\n\t\t\tconsole.log('WebSocket opened', evt)\n\t\t\tthis.clock.destroy()\n\t\t\tthis.clock = new WSClock(this.global, this.conn, this.options.clock)\n\t\t}\n\t\tconn.onerror = (evt: Event) => {\n\t\t\tconsole.error('WebSocket error', evt)\n\t\t}\n\t\tconn.onmessage = this.onMessage\n\t\treturn conn\n\t}\n\n\tonMessage = (evt: MessageEvent) => {\n\t\tconst parts = split(evt.data, WS_HEADER_END, 1)\n\t\tconst [head, body] = parts\n\t\tswitch (head) {\n\t\t\tcase WS_CLIENT_ID:\n\t\t\t\tthis.isReady = true\n\t\t\t\tthis.clientId = parseClientId(body)\n\t\t\t\tconsole.log('[WSClient #onMessage] Received clientId', this.clientId)\n\t\t\t\tthis.options.onClientId(this.clientId)\n\t\t\t\tbreak\n\t\t\tcase WS_CLOCK_NOW:\n\t\t\tcase WS_CLOCK_ORIGIN:\n\t\t\t\tif (!this.clock) {\n\t\t\t\t\tconsole.error('[WSClient #onMessage] No local clock ready to handle server clock message')\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tif (head === WS_CLOCK_ORIGIN) {\n\t\t\t\t\tthis.clock.onClockOrigin(body)\n\t\t\t\t} else {\n\t\t\t\t\tthis.clock.onClockNow(body)\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase WS_CLOCK_UPDATE:\n\t\t\t\tconst clkOpts = parseClockUpdate(body)\n\t\t\t\tthis.options.onClockUpdate(clkOpts)\n\t\t\t\tconsole.log('[WSClient #onMessage] Received clockUpdate', clkOpts)\n\t\t\t\tbreak\n\t\t\tcase WS_USERS_ALL:\n\t\t\t\tthis.users = parseUsersAll(body).filter(uu => !!uu)\n\t\t\t\t// console.log('[WSClient #onMessage] Received users', this.users)\n\t\t\t\tthis.options.onUsers(this.users)\n\t\t\t\tbreak\n\t\t\tcase WS_USER_EVENT: {\n\t\t\t\tconst uevt = parseUserEvent(body)\n\t\t\t\t// console.log('[WSClient #onMessage] Received user event', uevt)\n\t\t\t\tthis.options.onUserEvent(uevt)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase WS_USER_FORCE: {\n\t\t\t\tconst uevt = parseUserForce(body)\n\t\t\t\t// console.log('[WSClient #onMessage] Received user event', uevt)\n\t\t\t\tthis.options.onUserForce(uevt)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase WS_USER_XFORM: {\n\t\t\t\tconst uevt = parseUserXform(body)\n\t\t\t\t// console.log('[WSClient #onMessage] Received user event', uevt)\n\t\t\t\tthis.options.onUserXform(uevt)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase WS_USER_REQUEST_XFORMS: {\n\t\t\t\tconsole.log('[WSClient #onMessage] Received Xform request')\n\t\t\t\tthis.options.onUserRequestXforms()\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tdefault:\n\t\t\t\tconsole.log('[WSClient #onMessage] Unhandled message', { head, body, parts }, evt)\n\t\t\t\tbreak\n\t\t}\n\t}\n\n\tnow = (): number => {\n\t\tif (!this.clock) {\n\t\t\tconsole.error('[WSClient #now] No clock!')\n\t\t\treturn -1\n\t\t}\n\t\treturn this.clock.now()\n\t}\n\n\tgetUser = (clientId: number) => {\n\t\tfor (const uu of this.users) {\n\t\t\tif (uu.clientId === clientId) {\n\t\t\t\treturn uu\n\t\t\t}\n\t\t}\n\t}\n}\n\n// split function with remainder\n// via https://stackoverflow.com/questions/874709/converting-user-input-string-to-regular-expression\nfunction split(str: string, sep: string, nn: number) {\n\tconst out: string[] = []\n\tconst sepRe = new RegExp(sep, 'g')\n\twhile (nn--) {\n\t\tconst prevIndex = sepRe.lastIndex\n\t\tconst re = sepRe.exec(str)\n\t\tif (!re) {\n\t\t\tbreak\n\t\t}\n\t\tout.push(str.slice(prevIndex, re.index))\n\t}\n\tout.push(str.slice(sepRe.lastIndex))\n\treturn out\n}\n","type FieldsShared = {\n\tdata: number[]\n\tchannel: number\n\tkind: string\n}\n\ntype FieldsNote = {\n\tattack?: number\n\tnote: number\n\trelease?: number\n}\n\ntype FieldsCC = {\n\tvalue: number // 0 - 1 (data[2])\n\tcontroller: {\n\t\tnumber: number // (data[1])\n\t\tname: string\n\t}\n}\n\ntype FieldsPitchbend = {\n\tvalue: number // 0 - 1 (data[2])\n}\n\nexport type MidiEventNote = FieldsShared & FieldsNote\nexport type MidiEventCC = FieldsShared & FieldsCC\nexport type MidiEventPitchbend = FieldsShared & FieldsPitchbend\nexport type MidiEvent = FieldsShared & FieldsCC & FieldsNote & FieldsPitchbend\nexport function newMidiEvent(evt: any): MidiEvent {\n\treturn {\n\t\tdata: evt.data,\n\t\tchannel: evt.target.number,\n\t\tkind: evt.type,\n\t\tattack: evt.attack,\n\t\tnote: evt.note && evt.note._number,\n\t\trelease: evt.release,\n\t\tvalue: evt.value,\n\t\tcontroller: evt.controller,\n\t}\n}\n\nconst allChannels = [...Array(16).keys()].map(x => x + 1) // Array of numbers 1 thru 16\nconst allEvents = ['controlchange', 'noteoff', 'noteon', 'pitchbend'] // 'keyaftertouch',\n\ntype MIDIOptions = {\n\tonMessage: (inputName: string, eventName: string, evt: MidiEvent) => void\n\tonEnabled?: (webMidi: any) => void\n}\n\nexport default class MIDI {\n\twebMidi: any | null = null\n\tenabled: boolean = false\n\n\tconstructor(opts: MIDIOptions) {\n\t\tthis.enable(opts)\n\t}\n\n\tenable = async (opts: MIDIOptions) => {\n\t\tconst { onMessage, onEnabled } = opts\n\t\tconst { WebMidi } = window\n\t\ttry {\n\t\t\tawait WebMidi.enable()\n\t\t} catch (err) {\n\t\t\tconsole.error('[MIDI #enable] Failed to enable MIDI', err)\n\t\t\treturn\n\t\t}\n\t\tthis.webMidi = WebMidi\n\t\tthis.enabled = true\n\t\tconst { inputs, outputs } = this.webMidi\n\t\tconsole.log('[MIDI #enable] inputs', inputs)\n\t\tconsole.log('[MIDI #enable] outputs', outputs)\n\t\tif (onEnabled) {\n\t\t\tonEnabled(this.webMidi)\n\t\t}\n\t\tfor (const input of inputs) {\n\t\t\tfor (const eventName of allEvents) {\n\t\t\t\tinput.addListener(\n\t\t\t\t\teventName,\n\t\t\t\t\t(evt: any) => onMessage(input.name, eventName, newMidiEvent(evt)),\n\t\t\t\t\t{\n\t\t\t\t\t\tchannels: allChannels,\n\t\t\t\t\t},\n\t\t\t\t)\n\t\t\t}\n\t\t}\n\t}\n}\n","import * as Tone from 'tone'\nimport { Vec } from 'engine3d'\nimport seedrandom from 'seedrandom'\n\nexport function noteFreq(note: number) {\n\treturn Tone.Frequency(note, 'midi').toFrequency()\n}\n\nexport const srand = () => Math.random() * 2 - 1\nexport const srandVec = () => new Vec(srand(), srand(), srand())\nexport const mix = (aa: number, bb: number, xx: number) => {\n\treturn bb * xx + aa * (1 - xx)\n}\n\nconst _ctrlColorMemo: { [key: string]: number } = {}\nexport const ctrlColor = (ctrl: string) => {\n\tconst sat = 0.8,\n\t\tlgt = 0.4\n\tif (_ctrlColorMemo[ctrl]) {\n\t\treturn { hue: _ctrlColorMemo[ctrl], sat, lgt }\n\t}\n\t// override seed for some ctrls if their default color is too close to others\n\tlet seed = ctrl\n\tswitch (ctrl) {\n\t\tcase '21':\n\t\t\tseed = '21###'\n\t\t\tbreak\n\t\tcase '22':\n\t\t\tseed = '22&$&'\n\t\t\tbreak\n\t\tcase '73':\n\t\t\tseed = '73##'\n\t\t\tbreak\n\t\tcase '77':\n\t\t\tseed = '77#'\n\t\t\tbreak\n\t}\n\t_ctrlColorMemo[ctrl] = seedrandom(seed).quick()\n\treturn {\n\t\thue: _ctrlColorMemo[ctrl],\n\t\tsat,\n\t\tlgt,\n\t}\n}\n","import * as Tone from 'tone'\nimport * as p5 from 'p5'\nimport { sketch } from './Sketch'\nimport { ctrlColor } from './util'\nimport { MidiEvent, MidiEventCC, MidiEventPitchbend } from './MIDI'\n\n// type Sliders = { [key: string]: InstControl }\ntype InstSlidersOpts = { sliders: InstControl[] }\n\nexport class InstControls {\n\tsliders: InstControl[]\n\n\tconstructor(opts: InstSlidersOpts = { sliders: [] }) {\n\t\tthis.sliders = opts.sliders\n\t}\n\n\tupdate = (pp: p5) => {\n\t\tfor (const ss of this.sliders) {\n\t\t\tss.update(pp)\n\t\t}\n\t}\n\n\tdraw = (pp: p5) => {\n\t\tpp.push()\n\t\tconst { sliders } = this\n\t\tlet xx = 30\n\t\tfor (const ss of sliders) {\n\t\t\tss.xx = xx\n\t\t\tss.draw(pp)\n\t\t\txx += ss.width\n\t\t\tif (['ff', 'a', 'd', 's'].includes(ss.label)) {\n\t\t\t\t// no margin\n\t\t\t} else if (['pb', 'pan'].includes(ss.label)) {\n\t\t\t\txx += ss.width / 2 // half margin\n\t\t\t} else {\n\t\t\t\txx += ss.width // full margin\n\t\t\t}\n\t\t}\n\t\tpp.pop()\n\t}\n\n\tmousePressed = (evt: p5) => {\n\t\tconst { mouse } = sketch.cam || {}\n\t\tfor (const ss of this.sliders) {\n\t\t\tif (ss.mousePressed(evt.mouseX, evt.mouseY)) {\n\t\t\t\tif (mouse) {\n\t\t\t\t\tmouse.ismousedown = false\n\t\t\t\t}\n\t\t\t\treturn true\n\t\t\t}\n\t\t}\n\t\treturn false\n\t}\n\n\tmouseReleased = (_evt: p5) => {\n\t\tthis.sliders.forEach(ss => ss.mouseReleased())\n\t}\n\n\tcontrolchangeNext = (evt: MidiEventCC): InstControl | undefined => {\n\t\tconst ss = this.getSliderForCtrl(evt.controller.number)\n\t\tif (ss && !ss.pressed) {\n\t\t\tss.valueNext = evt.value\n\t\t}\n\t\treturn ss\n\t}\n\tcontrolchange = (evt: MidiEventCC): InstControl | undefined => {\n\t\tconst ss = this.getSliderForCtrl(evt.controller.number)\n\t\tif (ss) {\n\t\t\tss.value.value = evt.value\n\t\t}\n\t\treturn ss\n\t}\n\n\tpitchbendNext = (evt: MidiEventPitchbend): InstControl | undefined => {\n\t\tconst ss = this.getSliderForPitchbend()\n\t\tif (ss && !ss.pressed) {\n\t\t\tss.valueNext = evt.value\n\t\t}\n\t\treturn ss\n\t}\n\tpitchbend = (evt: MidiEventPitchbend): InstControl | undefined => {\n\t\tconst ss = this.getSliderForPitchbend()\n\t\tif (ss) {\n\t\t\tss.value.value = evt.value\n\t\t}\n\t\treturn ss\n\t}\n\n\tgetSliderForLabel = (lbl: string): InstControl | undefined => {\n\t\tconst sliders = this.sliders.filter(s => s.label === lbl)\n\t\treturn sliders[0]\n\t}\n\tgetSliderForCtrl = (ctrl: number): InstControl | undefined => {\n\t\tconst sliders = this.sliders.filter(s => s.ctrl === ctrl)\n\t\treturn sliders[0]\n\t}\n\tgetSliderForPitchbend = (): InstControl | undefined => {\n\t\tconst sliders = this.sliders.filter(s => s.pitchbend)\n\t\treturn sliders[0]\n\t}\n}\n\ntype InstSliderOpts = {\n\tlabel: string\n\tctrl: number\n\tvalue?: number\n\tpitchbend?: boolean\n}\n\nexport class InstControl {\n\theight = 150\n\twidth = 20\n\tvalue = new Tone.Signal(0)\n\tvalueNext = 0\n\tstrokeWeight = 4\n\txx = 40\n\tyy = 100\n\tpressed = false\n\tlabel: string\n\tctrl: number\n\tpitchbend: boolean\n\n\tconstructor(opts: InstSliderOpts) {\n\t\tthis.label = opts.label\n\t\tthis.ctrl = opts.ctrl\n\t\tif (opts.value) {\n\t\t\tthis.set(opts.value)\n\t\t}\n\t\tthis.pitchbend = !!opts.pitchbend\n\t}\n\n\t_wasPressed = false\n\tupdate(pp: p5) {\n\t\tif (!this.pressed) {\n\t\t\tif (this.pitchbend && this._wasPressed) {\n\t\t\t\tthis.valueNext = 0\n\t\t\t\tthis.sendValue()\n\t\t\t}\n\t\t\tthis._wasPressed = false\n\t\t\treturn\n\t\t}\n\t\tthis._wasPressed = true\n\t\tthis.setValueNext(pp.mouseY)\n\t}\n\n\t_ee = 0\n\tdraw(pp: p5) {\n\t\tpp.colorMode(pp.HSL, 1)\n\t\tpp.fill(0, 0, 0.1).stroke(0, 0, 0.7).strokeWeight(this.strokeWeight)\n\t\tpp.rect(this.xx, this.yy, this.width, this.height)\n\t\tconst col = ctrlColor(`${this.ctrl}`)\n\t\tpp.fill(col.hue, col.sat * 0.3, col.lgt).noStroke()\n\t\tthis.drawVal(pp, this.valueNext)\n\t\tpp.fill(col.hue, col.sat, col.lgt).noStroke()\n\t\tthis.drawVal(pp, this.value.value)\n\t\tpp.fill(0, 0, 0.8).stroke(0).strokeWeight(1)\n\t\tpp.textSize(10).textAlign(pp.CENTER, pp.TOP).textStyle(pp.BOLD)\n\t\tpp.text(this.label.toUpperCase(), this.xx + this.width / 2, this.yy + this.height + 5)\n\t}\n\n\tdrawVal(pp: p5, val: number) {\n\t\tconst vw = this.width - this.strokeWeight\n\t\tconst vx = this.xx + this.strokeWeight / 2\n\t\tpp.square(vx, this.valueY(val), vw)\n\t}\n\n\tmousePressed(mouseX: number, mouseY: number) {\n\t\tif (mouseX < this.xx || mouseX > this.xx + this.width) {\n\t\t\treturn false\n\t\t}\n\t\tif (mouseY < this.yy || mouseY > this.yy + this.height) {\n\t\t\treturn false\n\t\t}\n\t\tthis.setValueNext(mouseY)\n\t\tthis.pressed = true\n\t\treturn true\n\t}\n\tmouseReleased() {\n\t\tthis.pressed = false\n\t}\n\n\tsetValueNext(mouseY: number) {\n\t\tconst tt = this.yy + this.width / 2\n\t\tconst hh = this.height - this.width - this.strokeWeight / 2\n\t\tconst vv = 1 - (mouseY - tt) / hh\n\t\tif (this.pitchbend) {\n\t\t\tthis.valueNext = Math.max(-1, Math.min(1, vv * 2 - 1))\n\t\t} else {\n\t\t\tthis.valueNext = Math.max(0, Math.min(1, vv))\n\t\t}\n\t\tthis.sendValue()\n\t}\n\n\tvalueLastSent = 0\n\tsendValue() {\n\t\tif (this.valueNext === this.valueLastSent) {\n\t\t\treturn\n\t\t}\n\t\tthis.valueLastSent = this.valueNext\n\t\t// Send update\n\t\tconst midiEvt = {\n\t\t\tkind: this.pitchbend ? 'pitchbend' : 'controlchange',\n\t\t\tcontroller: this.pitchbend ? undefined : { number: this.ctrl, name: this.label },\n\t\t\tvalue: this.valueNext,\n\t\t} as MidiEvent\n\t\tsketch.sendUserEvent('keyboard', midiEvt.kind, midiEvt)\n\t}\n\n\tvalueY(val: number) {\n\t\tconst tt = this.yy + this.width / 2\n\t\tconst hh = this.height - this.width\n\t\tconst vv = this.pitchbend ? val / 2 + 0.5 : val\n\t\treturn (1 - vv) * hh + tt - this.width / 2 + this.strokeWeight / 2\n\t}\n\n\tset(val: number) {\n\t\tthis.value.value = val\n\t\tif (!this.pressed) {\n\t\t\tthis.valueNext = val\n\t\t}\n\t}\n}\n","import * as Tone from 'tone'\nimport { Avatar } from 'engine3d'\nimport { MidiEventCC, MidiEventNote, MidiEventPitchbend } from './MIDI'\nimport { InstControl, InstControls } from './InstControls'\n\nexport type ControlChange = {\n\tavatar?: Avatar\n\tevt?: MidiEventCC\n\tslider?: InstControl\n}\n\nexport type ADSR = Partial<{\n\tattack: number\n\tdecay: number\n\tsustain: number\n\trelease: number\n}>\n\nexport type FilterProps = Partial<{\n\tfrequency: number\n\tQ: number\n}>\n\nexport class Instrument {\n\tctrls = new InstControls({\n\t\tsliders: [\n\t\t\tnew InstControl({ label: 'pb', ctrl: -1, pitchbend: true }),\n\t\t\tnew InstControl({ label: 'mod', ctrl: 1, value: 0.0 }),\n\t\t\tnew InstControl({ label: 'ff', ctrl: 21, value: 0.67 }), // Filter freq\n\t\t\tnew InstControl({ label: 'fq', ctrl: 22, value: 0.0 }), // Filter Q\n\t\t\tnew InstControl({ label: 'a', ctrl: 71, value: 0.05 }),\n\t\t\tnew InstControl({ label: 'd', ctrl: 72, value: 0.1 }),\n\t\t\tnew InstControl({ label: 's', ctrl: 73, value: 1.0 }),\n\t\t\tnew InstControl({ label: 'r', ctrl: 74, value: 0.4 }),\n\t\t\tnew InstControl({ label: 'pan', ctrl: 27, value: 0.5 }),\n\t\t\tnew InstControl({ label: 'vol', ctrl: 28, value: 0.857 }),\n\t\t],\n\t})\n\tpanVol?: Tone.PanVol // automatically bound to pan/vol sliders\n\thandleDetune?: (val: number) => void // called when pitchbend control changes\n\thandleModwheel?: (val: number) => void // called when modwheel control changes\n\thandleFilter?: (props: FilterProps) => void // called when filter controls change\n\thandleADSR?: (props: ADSR) => void // called when ADSR controls change\n\n\tloaded() {\n\t\treturn false\n\t}\n\n\tnoteon(_avatar: Avatar, _time: number, _evt: MidiEventNote) {}\n\tnoteoff(_avatar: Avatar, _time: number, _evt: MidiEventNote) {}\n\n\tcontrolchange(avatar: Avatar, time: number, evt: MidiEventCC) {\n\t\tthis.ctrls.controlchangeNext(evt)\n\t\tTone.Draw.schedule(() => {\n\t\t\tconst slider = this.ctrls.controlchange(evt)\n\t\t\tconst cc = { avatar, evt, slider }\n\t\t\tthis.handleCC(cc)\n\t\t}, time)\n\t}\n\n\tpitchbend(avatar: Avatar, time: number, evt: MidiEventPitchbend) {\n\t\tthis.ctrls.pitchbendNext(evt)\n\t\tTone.Draw.schedule(() => {\n\t\t\tconst slider = this.ctrls.pitchbend(evt)\n\t\t\tconst cc = { avatar, evt, slider } as ControlChange\n\t\t\tthis.handlePitchbend(cc)\n\t\t}, time)\n\t}\n\n\thandleCC(cc: ControlChange) {\n\t\tconst { slider } = cc\n\t\tif (!slider) {\n\t\t\treturn\n\t\t}\n\t\tconst { label, pitchbend } = slider\n\t\tif (pitchbend) {\n\t\t\tif (this.handlePitchbend) {\n\t\t\t\tthis.handlePitchbend(cc)\n\t\t\t}\n\t\t\treturn\n\t\t}\n\t\tlet vv = slider.value.value\n\n\t\tif (label === 'mod') {\n\t\t\tif (this.handleModwheel) {\n\t\t\t\tthis.handleModwheel(vv)\n\t\t\t}\n\t\t\treturn\n\t\t}\n\n\t\tif (['ff', 'fq'].includes(label)) {\n\t\t\tif (this.handleFilter) {\n\t\t\t\tif (label === 'ff') {\n\t\t\t\t\tthis.handleFilter({ frequency: Math.pow(10, vv * 3 + 1) }) // 10 to 10000\n\t\t\t\t} else {\n\t\t\t\t\tthis.handleFilter({ Q: vv * vv * 8 })\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn\n\t\t}\n\n\t\t// Apply ADSR val to envelope\n\t\tif (['a', 'd', 's', 'r'].includes(label)) {\n\t\t\tif (!this.handleADSR) {\n\t\t\t\treturn\n\t\t\t}\n\t\t\tif (['a', 'd', 'r'].includes(label)) {\n\t\t\t\tvv = 10 * vv * vv * vv * vv + 0.0001\n\t\t\t} else {\n\t\t\t\tvv *= vv\n\t\t\t}\n\t\t\tswitch (label) {\n\t\t\t\tcase 'a':\n\t\t\t\t\tthis.handleADSR({ attack: vv })\n\t\t\t\t\tbreak\n\t\t\t\tcase 'd':\n\t\t\t\t\tthis.handleADSR({ decay: vv })\n\t\t\t\t\tbreak\n\t\t\t\tcase 's':\n\t\t\t\t\tthis.handleADSR({ sustain: vv })\n\t\t\t\t\tbreak\n\t\t\t\tcase 'r':\n\t\t\t\t\tthis.handleADSR({ release: vv })\n\t\t\t\t\tbreak\n\t\t\t}\n\t\t\treturn\n\t\t}\n\n\t\tif (label === 'vol') {\n\t\t\tif (this.panVol) {\n\t\t\t\tthis.panVol.mute = !vv\n\t\t\t\tthis.panVol.set({ volume: vv * 70 - 60 })\n\t\t\t}\n\t\t\treturn\n\t\t}\n\t\tif (label === 'pan') {\n\t\t\tif (this.panVol) {\n\t\t\t\tthis.panVol.set({ pan: vv * 2 - 1 })\n\t\t\t}\n\t\t\treturn\n\t\t}\n\t}\n\n\thandlePitchbend = (cc: ControlChange) => {\n\t\tif (!this.handleDetune) {\n\t\t\treturn\n\t\t}\n\t\tconst { evt, slider } = cc\n\t\tif (slider) {\n\t\t\tthis.handleDetune(slider.value.value)\n\t\t\treturn\n\t\t}\n\t\tif (evt) {\n\t\t\tthis.handleDetune(evt.value)\n\t\t\treturn\n\t\t}\n\t}\n}\n","import * as p5 from 'p5'\nimport * as Tone from 'tone'\nimport { MidiEventNote } from '../MIDI'\nimport { ADSR, ControlChange, FilterProps, Instrument } from '../Instrument'\nimport { mix, noteFreq, srand, srandVec } from '../util'\nimport { Avatar, Obj, ObjOpts, Vec } from 'engine3d'\nimport { sketch } from '../Sketch'\n\nexport class BlackHole extends Instrument {\n\tpanVol: Tone.PanVol\n\treverb: Tone.Reverb\n\tfilter: Tone.Filter\n\tsynth: Tone.Synth\n\tfreqNode = new Tone.Add()\n\tfreq = new Tone.Signal(440)\n\tnoiseGain: Tone.Gain\n\tnoise: Tone.Noise\n\tmodwheel = 0.3\n\tps = 0\n\tpsSpread = 7\n\tobjs: Obj[] = []\n\tmaxObjs = 30\n\tii = 0\n\n\tconstructor() {\n\t\tsuper()\n\t\tthis.panVol = new Tone.PanVol(0, 0).toDestination()\n\t\tthis.reverb = new Tone.Reverb({ decay: 4, wet: 0.6 }).connect(this.panVol)\n\t\tthis.filter = new Tone.Filter({ type: 'lowpass' }).connect(this.reverb)\n\t\tconst delay = new Tone.PingPongDelay({\n\t\t\tdelayTime: '4n',\n\t\t\tfeedback: 0.6,\n\t\t\twet: 0.3,\n\t\t}).connect(this.filter)\n\t\tthis.synth = new Tone.Synth().connect(delay)\n\t\tthis.freqNode.connect(this.synth.frequency)\n\t\tthis.freq.connect(this.freqNode)\n\t\tthis.noiseGain = new Tone.Gain(100).connect(this.freqNode.addend)\n\t\tthis.noise = new Tone.Noise({ volume: 0, playbackRate: 0.5, type: 'brown' })\n\t\t\t.start()\n\t\t\t.connect(this.noiseGain)\n\n\t\t// Initialize control sliders\n\t\tfor (const ss of this.ctrls.sliders) {\n\t\t\tswitch (ss.label) {\n\t\t\t\tcase 'mod':\n\t\t\t\t\tss.set(0.3)\n\t\t\t\t\tbreak\n\t\t\t\tcase 'ff':\n\t\t\t\t\tss.set(0.9)\n\t\t\t\t\tbreak\n\t\t\t\tcase 'fq':\n\t\t\t\t\tss.set(0.25)\n\t\t\t\t\tbreak\n\t\t\t\tcase 'a':\n\t\t\t\t\tss.set(0.1)\n\t\t\t\t\tbreak\n\t\t\t\tcase 'd':\n\t\t\t\t\tss.set(0.3)\n\t\t\t\t\tbreak\n\t\t\t\tcase 's':\n\t\t\t\t\tss.set(0.66)\n\t\t\t\t\tbreak\n\t\t\t\tcase 'r':\n\t\t\t\t\tss.set(0.6)\n\t\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t\tfor (const ss of this.ctrls.sliders) {\n\t\t\tthis.handleCC({ slider: ss })\n\t\t}\n\t}\n\n\tloaded() {\n\t\treturn true\n\t}\n\n\t_attacks = 0\n\tnoteon = (avatar: Avatar, time: number, evt: MidiEventNote) => {\n\t\tconst freq = noteFreq(evt.note)\n\t\ttry {\n\t\t\tif (this._attacks) {\n\t\t\t\tthis.freq.exponentialRampToValueAtTime(freq, time)\n\t\t\t} else {\n\t\t\t\tthis.freq.setValueAtTime(freq, time)\n\t\t\t\tthis.synth.triggerAttack(freq, time, evt.attack)\n\t\t\t}\n\t\t} catch {}\n\t\tthis._attacks++\n\t\tTone.Draw.schedule(() => this.addBHObj(avatar, evt), time)\n\t}\n\tnoteoff = (_avatar: Avatar, time: number, _evt: MidiEventNote) => {\n\t\tthis._attacks = Math.max(0, this._attacks - 1)\n\t\tif (!this._attacks) {\n\t\t\tthis.synth.triggerRelease(time)\n\t\t}\n\t}\n\n\thandleDetune = (val: number) => {\n\t\tthis.ps = val\n\t\tthis.synth.set({ detune: 100 * val * this.psSpread })\n\t}\n\n\thandleModwheel = (val: number) => {\n\t\tthis.modwheel = val\n\t\tconst vv = val * val\n\t\tthis.noiseGain.set({ gain: vv * this.freq.value * 3 })\n\t}\n\n\thandleFilter = (props: FilterProps) => this.filter.set(props)\n\thandleADSR = (props: ADSR) => this.synth.set({ envelope: props })\n\n\thandleCC(cc: ControlChange) {\n\t\tsuper.handleCC(cc)\n\t\tconst { evt } = cc\n\t\tif (!evt) {\n\t\t\treturn\n\t\t}\n\t\t// Handle customized control events that don't have sliders\n\t\tconst num = evt.controller.number\n\t\tlet vv = evt.value * evt.value\n\t\tswitch (true) {\n\t\t\tcase num === 23:\n\t\t\t\tthis.noise.set({ playbackRate: vv * 2 })\n\t\t\t\tbreak\n\t\t\tcase num === 24:\n\t\t\t\tthis.synth.set({ portamento: vv * 2 })\n\t\t\t\tbreak\n\t\t}\n\t}\n\n\t_rr = 0\n\t_lastPos: { [key: number]: Vec } = {}\n\taddBHObj = (avatar: Avatar, evt: MidiEventNote) => {\n\t\tconst { blackHole } = sketch\n\t\tif (!blackHole) {\n\t\t\treturn\n\t\t}\n\t\t// Create obj for note\n\t\tconst objSize = 150\n\t\tconst { objs, maxObjs } = this\n\t\tconst { clientId } = avatar.user\n\t\tlet pos = avatar.xform.pos\n\t\tif (this._lastPos[clientId]) {\n\t\t\tpos = this._lastPos[clientId]\n\t\t}\n\t\tconst off = new Vec(srand() / 2, Math.random() / 2 + 0.5, srand() / 2).applyMult(objSize * 0.6)\n\t\tpos = pos.cloneAdd(off)\n\t\tif (this.ii++ % 8 === 0 || pos.y > 1000) {\n\t\t\t// Start a new column (4 total columns in semicircle behind avatar),\n\t\t\t// place between PolySynth columns\n\t\t\tconst { facing, xform } = avatar\n\t\t\tconst { pos: apos } = xform\n\t\t\tconst ff = new Vec(facing.x, facing.z, 0).applyMult(-700)\n\t\t\tlet rr = 1 + 2 * (this._rr++ % 4)\n\t\t\tif (rr > 3) {\n\t\t\t\trr += 2\n\t\t\t}\n\t\t\tff.rotate(-Math.PI / 2 + (Math.PI * rr) / 10)\n\t\t\tpos.x = apos.x + ff.x\n\t\t\tpos.y = apos.y\n\t\t\tpos.z = apos.z + ff.y\n\t\t}\n\t\tthis._lastPos[clientId] = pos\n\t\tconst rot = new Vec(\n\t\t\tMath.random() * Math.PI * 2,\n\t\t\tMath.random() * Math.PI * 2,\n\t\t\tMath.random() * Math.PI * 2,\n\t\t)\n\t\t// let extraScale = pos.y / 1000\n\t\t// extraScale *= extraScale * extraScale * 10 * objSize\n\t\tconst obj = new BHObj(this, {\n\t\t\tnoteEvt: evt,\n\t\t\tpos: pos,\n\t\t\trot: rot,\n\t\t\t// scale: new Vec(objSize * 0.7 + extraScale),\n\t\t\tscale: new Vec(objSize),\n\t\t\ttwist: this.modwheel * this.modwheel,\n\t\t\tmass: evt.attack || 0.7,\n\t\t})\n\t\tobjs.unshift(obj)\n\t\t// Add obj to root blackhole object\n\t\tblackHole.addChild(obj)\n\t\tif (objs.length > maxObjs) {\n\t\t\t// remove oldest obj\n\t\t\tblackHole.rmChild(objs[objs.length - 1])\n\t\t\tthis.objs = objs.slice(0, maxObjs)\n\t\t}\n\t}\n}\n\ntype BHObjOpts = ObjOpts & {\n\tnoteEvt: MidiEventNote\n\ttwist: number\n\tmass: number\n}\n\nclass BHObj extends Obj {\n\tinst: BlackHole\n\tcreatedAt: number\n\tnoteEvt: MidiEventNote\n\tscaleOrig: Vec\n\tvoice: Tone.Synth | null = null\n\thue = Math.random()\n\tmass: number\n\tmassOrig: number\n\ttwist = 0\n\ttwistDir = 1\n\n\tconstructor(inst: BlackHole, opts: BHObjOpts) {\n\t\tsuper(opts)\n\t\tthis.inst = inst\n\t\tthis.createdAt = new Date().valueOf() / 1000\n\t\tthis.noteEvt = opts.noteEvt\n\t\tthis.scaleOrig = this.xform.scale.clone()\n\t\tthis.mass = 1 - opts.mass // invert to apply square\n\t\tthis.mass = 1 - this.mass * this.mass // un-invert the square\n\t\tthis.massOrig = this.mass\n\t\tthis.twistDir = Math.random() > 0.5 ? 1 : -1\n\t}\n\n\tupdate = (dt: number) => {\n\t\tconst { modwheel } = this.inst\n\t\tconst mm = modwheel * modwheel\n\t\tlet im = 1 - modwheel // invert to apply square\n\t\tim = 1 - im * im // un-invert the square\n\t\tthis.xform.rot.applyAdd(srandVec().applyMult(dt * im))\n\t\tthis.twist = mix(mm, this.twist, 0.99)\n\t\tthis.mass = mix(mix(im, this.massOrig, 0.65), this.mass, 0.99)\n\t}\n\n\torigin2D = new Vec()\n\tscale2D = 1\n\tdrawFunc = (pg: p5.Graphics) => {\n\t\tif (sketch.shaderBlackHole) {\n\t\t\tsketch.shaderBlackHole.setUniform('origin', [\n\t\t\t\tthis.origin2D.x / pg.width,\n\t\t\t\tthis.origin2D.y / pg.height,\n\t\t\t])\n\t\t\tsketch.shaderBlackHole.setUniform('scale', this.scale2D / pg.width)\n\t\t\tsketch.shaderBlackHole.setUniform('rotate', this.twist * Math.PI * this.twistDir)\n\t\t\tsketch.shaderBlackHole.setUniform('mass', this.mass)\n\t\t}\n\t\tpg.sphere(1, 3, 4)\n\t}\n\n\tdrawFunc2D = (pp: p5, pos: Vec, scale: number) => {\n\t\tthis.origin2D = pos\n\t\tthis.scale2D = Math.min(pp.height * 2, scale)\n\t}\n}\n","import { Avatar } from 'engine3d'\nimport { MidiEventCC, MidiEventNote } from '../MIDI'\nimport { Instrument } from '../Instrument'\nimport { InstControl } from '../InstControls'\nimport { sketch } from '../Sketch'\n\nexport class Dancer extends Instrument {\n\tconstructor() {\n\t\tsuper()\n\t\tthis.ctrls.sliders = [\n\t\t\tnew InstControl({ label: 'mod', ctrl: 1, value: 0.0 }), // color of the dancer\n\t\t\tnew InstControl({ label: 'a', ctrl: 71, value: 0.25 }), // unit = beats\n\t\t\tnew InstControl({ label: 'd', ctrl: 72, value: 0.25 }), // unit = beats\n\t\t\tnew InstControl({ label: 's', ctrl: 73, value: 1.0 }),\n\t\t\tnew InstControl({ label: 'r', ctrl: 74, value: 0.5 }), // unit = beats\n\t\t\tnew InstControl({ label: 'vol', ctrl: 28, value: 0.5 }), // amplitude of movements\n\t\t]\n\t}\n\n\tloaded() {\n\t\treturn true\n\t}\n\n\tlr = -1\n\tnoteon = (avatar: Avatar, time: number, evt: MidiEventNote) => {\n\t\tavatar.dancer.noteEvent(time, evt)\n\t}\n\n\tnoteoff = (avatar: Avatar, time: number, evt: MidiEventNote) => {\n\t\tavatar.dancer.noteEvent(time, evt)\n\t}\n\n\tcontrolchange(avatar: Avatar, time: number, evt: MidiEventCC) {\n\t\tavatar.dancer.handleCC({\n\t\t\tevt,\n\t\t\tctrls: this.ctrls,\n\t\t\tlocalUser: avatar === sketch.avatar,\n\t\t\ttime,\n\t\t})\n\t}\n}\n","import * as Tone from 'tone'\nimport { Avatar } from 'engine3d'\nimport { MidiEventNote } from '../MIDI'\nimport { FilterProps, Instrument } from '../Instrument'\nimport { InstControl } from '../InstControls'\nimport { noteFreq } from '../util'\n\nexport class Sampler extends Instrument {\n\tpanVol: Tone.PanVol\n\tfilter: Tone.Filter\n\tpitchShift: Tone.PitchShift\n\tsampler: Tone.Sampler\n\tps = 0\n\tpsSpread = 7\n\n\tconstructor(sampler: Tone.Sampler) {\n\t\tsuper()\n\t\tthis.panVol = new Tone.PanVol(0, 0).toDestination()\n\t\tthis.filter = new Tone.Filter({ type: 'bandpass' }).connect(this.panVol)\n\t\tthis.pitchShift = new Tone.PitchShift().connect(this.filter)\n\t\tthis.sampler = sampler.connect(this.pitchShift)\n\t\tthis.ctrls.sliders = [\n\t\t\tnew InstControl({ label: 'pb', ctrl: -1, pitchbend: true }),\n\t\t\tnew InstControl({ label: 'mod', ctrl: 1, value: 0.0 }),\n\t\t\tnew InstControl({ label: 'ff', ctrl: 21, value: 0.67 }),\n\t\t\tnew InstControl({ label: 'fq', ctrl: 22, value: 0.0 }),\n\t\t\tnew InstControl({ label: 'pan', ctrl: 27, value: 0.5 }),\n\t\t\tnew InstControl({ label: 'vol', ctrl: 28, value: 0.857 }),\n\t\t]\n\t\tfor (const ss of this.ctrls.sliders) {\n\t\t\tthis.handleCC({ slider: ss })\n\t\t}\n\t}\n\n\tloaded() {\n\t\treturn this.sampler.loaded\n\t}\n\n\tnoteon = (_avatar: Avatar, time: number, evt: MidiEventNote) => {\n\t\tthis.sampler.triggerAttack(noteFreq(evt.note), time, evt.attack)\n\t}\n\n\tnoteoff = (_avatar: Avatar, time: number, evt: MidiEventNote) => {\n\t\tthis.sampler.triggerRelease(noteFreq(evt.note), time)\n\t}\n\n\thandleDetune = (val: number) => {\n\t\tthis.ps = val\n\t\tthis.pitchShift.pitch = this.ps * this.psSpread\n\t}\n\n\thandleModwheel = (val: number) => {\n\t\t// bind modwheel to filter freq and Q\n\t\tconst ff = this.ctrls.getSliderForLabel('ff')\n\t\tif (ff) {\n\t\t\tff.set(val)\n\t\t\tthis.handleCC({ slider: ff })\n\t\t}\n\t\tconst fq = this.ctrls.getSliderForLabel('fq')\n\t\tif (fq) {\n\t\t\tconst sin = Math.sin(val * Math.PI)\n\t\t\tlet vv = 1 - val\n\t\t\tvv = 1 - vv * vv * vv\n\t\t\tfq.set(sin * 0.2 + 0 + 0.2 * vv)\n\t\t\tthis.handleCC({ slider: fq })\n\t\t}\n\t}\n\n\thandleFilter = (props: FilterProps) => this.filter.set(props)\n}\n","import * as Tone from 'tone'\nimport { Avatar } from 'engine3d'\nimport { Sampler } from './Sampler'\nimport { MidiEventNote } from '../MIDI'\nimport { noteFreq } from '../util'\nimport Sketch from '../Sketch'\n\nconst samps = [\n\t'BD0010.WAV',\n\t'BD0050.WAV',\n\t// 'BD0025.WAV',\n\t// 'BD0075.WAV',\n\t'SD7510.WAV',\n\t'CP.WAV',\n\t// 'SD7550.WAV',\n\t// 'SD7500.WAV',\n\t// 'SD7525.WAV',\n\t'CH.WAV',\n\t'OH10.WAV',\n\t'LT00.WAV',\n\t'MT00.WAV',\n\t'HT00.WAV',\n\t'LC00.WAV',\n\t'MC00.WAV',\n\t'HC00.WAV',\n\t'CB.WAV',\n\t'CY0075.WAV',\n\t// 'CY1000.WAV',\n\t'MA.WAV',\n\t'RS.WAV',\n\t// 'CL.WAV',\n]\n\nfunction eightOhEight() {\n\tconst urls: { [key: number]: string } = {}\n\tfor (let ii = 0; ii < samps.length; ++ii) {\n\t\turls[ii] = samps[ii % samps.length]\n\t}\n\treturn new Tone.Sampler({\n\t\turls,\n\t\trelease: 1,\n\t\tbaseUrl: '/samples/808/',\n\t})\n}\n\nexport class EightOhEight extends Sampler {\n\tsketch: Sketch\n\n\tconstructor(sketch: Sketch) {\n\t\tsuper(eightOhEight())\n\t\tthis.sketch = sketch\n\t}\n\n\tmodNote(note: number) {\n\t\treturn (note + 12) % samps.length\n\t}\n\n\tnoteon = (_avatar: Avatar, time: number, note: MidiEventNote) => {\n\t\tlet nn = this.modNote(note.note)\n\t\tthis.sampler.triggerAttack(noteFreq(nn), time, note.attack)\n\t\tTone.Draw.schedule(() => {\n\t\t\t// Update color of sky & ground\n\t\t\tconst { bgCol, ground } = this.sketch\n\t\t\tbgCol.hue = Math.random()\n\t\t\tbgCol.sat = Math.random() * 0.4 + 0.5\n\t\t\tground.hue = bgCol.hue\n\t\t\tground.sat = bgCol.sat\n\t\t\tground.lgt = bgCol.lgt * 1.35\n\t\t}, time)\n\t}\n\n\tnoteoff = (_avatar: Avatar, time: number, note: MidiEventNote) => {\n\t\tlet nn = this.modNote(note.note)\n\t\tthis.sampler.triggerRelease(noteFreq(nn), time)\n\t}\n}\n","import * as Tone from 'tone'\nimport { Avatar, Obj, ObjOpts, Vec } from 'engine3d'\nimport { MidiEventNote } from '../MIDI'\nimport { ADSR, ControlChange, FilterProps, Instrument } from '../Instrument'\nimport { noteFreq } from '../util'\nimport { worldScale } from '../Sketch'\n\n// Hoover implements a very rough approximation of a Alpha Juno 2 'rave hoover'\n// by amplitude-modulating a fatsawtooth by a fatsquare (would have used pulse\n// like the Juno does, but Tone doesn't have a fatpulse oscillator built in)\n//\n// References:\n// * https://www.listarc.bham.ac.uk/lists/sc-users-2009/msg53728.html\n// * ...via http://superdupercollider.blogspot.com/2009/06/more-dominator-deconstruction.html\n// * ...via https://tidalcycles.org/index.php/All_effects_and_synths#superhoover\nexport class Hoover extends Instrument {\n\tchorus: Tone.Chorus\n\tfilter: Tone.Filter\n\tamGain: Tone.Gain\n\tsynth: Tone.Synth\n\tamOsc: Tone.OmniOscillator<Tone.FatOscillator>\n\tpanVol: Tone.PanVol\n\tps = 0\n\tpsSpread = 7\n\tharmonicity = new Tone.Multiply(3.03)\n\tfreq = 440\n\tmodwheel = 1\n\tobj = new HooverObj(this, {\n\t\tscale: new Vec(worldScale * 2),\n\t\tpos: new Vec(0, 100, -worldScale),\n\t})\n\twave: Tone.Waveform\n\tfft: Tone.FFT\n\n\tconstructor() {\n\t\tsuper()\n\t\tthis.panVol = new Tone.PanVol(0, 0).toDestination()\n\t\tthis.chorus = new Tone.Chorus(0.15, 30, 1).connect(this.panVol)\n\t\tthis.filter = new Tone.Filter({ type: 'bandpass' }).connect(this.chorus)\n\t\tthis.amGain = new Tone.Gain(1).connect(this.filter)\n\t\tthis.synth = new Tone.Synth({\n\t\t\toscillator: {\n\t\t\t\ttype: 'fatsawtooth',\n\t\t\t\tcount: 4,\n\t\t\t\tspread: 59,\n\t\t\t},\n\t\t\tportamento: 0.25,\n\t\t}).connect(this.amGain)\n\t\tconst amScale = new Tone.AudioToGain().connect(this.amGain.gain)\n\t\tthis.amOsc = new Tone.OmniOscillator({\n\t\t\ttype: 'fatsquare',\n\t\t\tcount: 3,\n\t\t\tspread: 30,\n\t\t})\n\t\t\t.start()\n\t\t\t.connect(amScale)\n\t\tthis.synth.frequency.chain(this.harmonicity, this.amOsc.frequency)\n\n\t\t// Waveform and FFT\n\t\tthis.wave = new Tone.Waveform(32)\n\t\tthis.panVol.connect(this.wave)\n\t\tthis.fft = new Tone.FFT({\n\t\t\tsize: 16,\n\t\t\tnormalRange: true,\n\t\t})\n\t\tthis.panVol.connect(this.fft)\n\n\t\t// Initialize control sliders\n\t\tfor (const ss of this.ctrls.sliders) {\n\t\t\tswitch (ss.label) {\n\t\t\t\tcase 'mod':\n\t\t\t\t\tss.set(1.0)\n\t\t\t\t\tbreak\n\t\t\t\tcase 'a':\n\t\t\t\t\tss.set(0.6)\n\t\t\t\t\tbreak\n\t\t\t\tcase 'd':\n\t\t\t\t\tss.set(0.07)\n\t\t\t\t\tbreak\n\t\t\t\tcase 's':\n\t\t\t\t\tss.set(1.0)\n\t\t\t\t\tbreak\n\t\t\t\tcase 'r':\n\t\t\t\t\tss.set(0.7)\n\t\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t\tfor (const ss of this.ctrls.sliders) {\n\t\t\tthis.handleCC({ slider: ss })\n\t\t}\n\t}\n\n\tloaded() {\n\t\treturn true\n\t}\n\n\t_attacks = 0\n\tnoteon = (_avatar: Avatar, time: number, evt: MidiEventNote) => {\n\t\tthis.freq = noteFreq(evt.note) / 2\n\t\ttry {\n\t\t\tif (this._attacks) {\n\t\t\t\tthis.synth.setNote(this.freq, time)\n\t\t\t} else {\n\t\t\t\tthis.synth.triggerAttack(this.freq, time, evt.attack)\n\t\t\t}\n\t\t} catch {}\n\t\tthis._attacks++\n\t}\n\tnoteoff = (_avatar: Avatar, time: number, _evt: MidiEventNote) => {\n\t\tthis._attacks = Math.max(0, this._attacks - 1)\n\t\tif (!this._attacks) {\n\t\t\tthis.synth.triggerRelease(time)\n\t\t}\n\t}\n\n\thandleDetune = (val: number) => {\n\t\tthis.ps = val\n\t\tthis.synth.set({ detune: 100 * val * this.psSpread })\n\t}\n\n\thandleModwheel = (val: number) => {\n\t\tthis.modwheel = val\n\t\tconst sin = Math.sin(val * Math.PI)\n\t\tlet ss = 1 - sin\n\t\tss = 1 - ss * ss\n\t\tconst vv = Math.pow(2, Math.floor((1 - val) * 32) / 8 - 1)\n\t\tthis.harmonicity.value = vv\n\t\tif (val < 0.5) {\n\t\t\tthis.amOsc.volume.value = ss * 60 - 60\n\t\t} else {\n\t\t\tthis.amOsc.volume.value = 0\n\t\t}\n\t\tconst ff = this.ctrls.getSliderForLabel('ff')\n\t\tif (ff) {\n\t\t\tff.set(val)\n\t\t\tthis.handleCC({ slider: ff })\n\t\t}\n\t\tconst fq = this.ctrls.getSliderForLabel('fq')\n\t\tif (fq) {\n\t\t\tfq.set(sin * sin * sin * 0.35)\n\t\t\tthis.handleCC({ slider: fq })\n\t\t}\n\t}\n\n\thandleFilter = (props: FilterProps) => this.filter.set(props)\n\thandleADSR = (props: ADSR) => this.synth.set({ envelope: props })\n\n\thandleCC(cc: ControlChange) {\n\t\tsuper.handleCC(cc)\n\t\tconst { evt } = cc\n\t\tif (!evt) {\n\t\t\treturn\n\t\t}\n\t\t// Handle customized control events that don't have sliders\n\t\tconst num = evt.controller.number\n\t\tlet vv = evt.value * evt.value\n\t\tswitch (true) {\n\t\t\tcase num === 23:\n\t\t\t\tthis.harmonicity.value = vv * 20\n\t\t\t\tbreak\n\t\t\tcase num === 24:\n\t\t\t\tthis.synth.set({ portamento: vv * 2 })\n\t\t\t\tbreak\n\t\t}\n\t}\n}\n\nclass HooverObj extends Obj {\n\tinst: Hoover\n\thue = 0\n\n\tconstructor(hoover: Hoover, opts: ObjOpts) {\n\t\tsuper(opts)\n\t\tthis.inst = hoover\n\t}\n\n\t_ff = 0.0 // counter for rotation and color modulation\n\tdrawFunc = (pg: p5.Graphics) => {\n\t\tconst lp = this.calcLaserParams()\n\t\tthis._ff += 3 * (32 - lp.wave.length)\n\t\tif (!lp.wave.length) {\n\t\t\treturn\n\t\t}\n\t\t// Apply slow rotation\n\t\tpg.rotateX(this._ff / 59371)\n\t\tpg.rotateY(this._ff / -37523)\n\t\tpg.rotateZ(this._ff / 294783)\n\t\t// Draw waveform lasers, with colors modulated by fft values\n\t\tpg.colorMode(pg.HSL, 1)\n\t\tpg.noFill().strokeWeight(4).stroke(0)\n\t\tthis.drawLasers(pg, lp)\n\t\tpg.rotateX(-Math.PI / 2)\n\t\tthis.drawLasers(pg, lp)\n\t\tpg.rotateY(-Math.PI / 2)\n\t\tthis.drawLasers(pg, lp)\n\t}\n\n\tcalcLaserParams = (): LaserParams => {\n\t\tconst { ctrls, modwheel, wave } = this.inst\n\t\tconst empty = { fft: [], wave: new Float32Array(), waveMin: 0, waveMax: 0 }\n\t\tconst volCtrl = ctrls.getSliderForLabel('vol')\n\t\tif (volCtrl) {\n\t\t\tconst vol = volCtrl.value.value\n\t\t\tif (vol < 0.01) {\n\t\t\t\treturn empty\n\t\t\t}\n\t\t}\n\t\tconst visThresh = 0.001 + 0.02 * (1 - modwheel * modwheel)\n\t\tlet vals = wave.getValue().filter(vv => Math.abs(vv) > visThresh)\n\t\tconst valsMax = Math.max(0, ...vals)\n\t\tconst valsMin = Math.min(0, ...vals)\n\t\tif (!vals.length) {\n\t\t\treturn empty\n\t\t}\n\t\tconst fft = this.inst.fft.getValue()\n\t\tlet fftVals: number[] = []\n\t\tconst fftStart = 2\n\t\tfor (let ii = fftStart; ii < fft.length; ii++) {\n\t\t\tfftVals[ii - fftStart] = fft[ii] * ii * 100\n\t\t}\n\t\tconst max = Math.max(0.001, ...fftVals)\n\t\tfftVals = fftVals.map(ff => ff / max).filter(ff => ff > 0.05)\n\t\tif (!fftVals.length) {\n\t\t\tfftVals.push(fft[0])\n\t\t}\n\t\treturn {\n\t\t\tfft: fftVals,\n\t\t\twave: vals,\n\t\t\twaveMin: valsMin,\n\t\t\twaveMax: valsMax,\n\t\t}\n\t}\n\n\tdrawLasers = (pg: p5.Graphics, params: LaserParams) => {\n\t\tconst { fft, wave, waveMax, waveMin } = params\n\t\tfor (let ii = 0; ii < wave.length; ii++) {\n\t\t\tthis._ff++\n\t\t\tconst ff = this._ff % fft.length || 0\n\t\t\tconst hh = ((ff / fft.length) * 6.7 + this._ff / 100000) % 1.0\n\t\t\tconst ss = (fft[ff] || 0) / 2 + 0.5\n\t\t\tlet vv = 1 - (wave[ii] - waveMin) / (waveMax - waveMin)\n\t\t\tconst aa = 1 - 0.3 * vv * vv\n\t\t\t// work around p5 disabled alpha for stroke by setting 'curStrokeColor' directly\n\t\t\tconst cc = pg.color(hh, ss, 0.5, aa) as any\n\t\t\tconst rr = (pg as any)._renderer\n\t\t\trr.curStrokeColor = cc._array\n\t\t\tpg.rotateZ((Math.PI * 2) / wave.length)\n\t\t\tif (vv > 0.5) {\n\t\t\t\tpg.line(0, 0, 0, 1 - vv)\n\t\t\t} else {\n\t\t\t\tpg.line(0, vv, 0, 0.3)\n\t\t\t}\n\t\t}\n\t}\n}\n\ntype LaserParams = {\n\tfft: number[]\n\twave: Float32Array\n\twaveMin: number\n\twaveMax: number\n}\n","import * as Tone from 'tone'\nimport { Avatar } from 'engine3d'\nimport { Sampler } from './Sampler'\nimport { MidiEventNote } from '../MIDI'\nimport { noteFreq } from '../util'\nimport Sketch from '../Sketch'\n\nconst samps = ['MA.WAV', 'RS.WAV']\n\nfunction metronome() {\n\tconst urls: { [key: number]: string } = {}\n\tfor (let ii = 0; ii < samps.length; ++ii) {\n\t\turls[ii] = samps[ii % samps.length]\n\t}\n\treturn new Tone.Sampler({\n\t\turls,\n\t\trelease: 1,\n\t\tbaseUrl: '/samples/808/',\n\t})\n}\n\nexport class Metronome extends Sampler {\n\tsketch: Sketch\n\n\tconstructor(sketch: Sketch) {\n\t\tsuper(metronome())\n\t\tthis.sketch = sketch\n\t\tthis.panVol.set({ volume: -10 })\n\t\tthis.panVol.mute = true\n\t}\n\n\tmodNote(note: number) {\n\t\treturn note % samps.length\n\t}\n\n\tnoteon = (_avatar: Avatar, time: number, note: MidiEventNote) => {\n\t\tlet nn = this.modNote(note.note)\n\t\tthis.sampler.triggerAttack(noteFreq(nn), time, note.attack)\n\t}\n\n\tnoteoff = (_avatar: Avatar, time: number, note: MidiEventNote) => {\n\t\tlet nn = this.modNote(note.note)\n\t\tthis.sampler.triggerRelease(noteFreq(nn), time)\n\t}\n}\n","import * as Tone from 'tone'\nimport { Sampler } from './Sampler'\n\nconst pianoSamps = {\n\tA0: 'A0.mp3',\n\tC1: 'C1.mp3',\n\t'D#1': 'Ds1.mp3',\n\t'F#1': 'Fs1.mp3',\n\tA1: 'A1.mp3',\n\tC2: 'C2.mp3',\n\t'D#2': 'Ds2.mp3',\n\t'F#2': 'Fs2.mp3',\n\tA2: 'A2.mp3',\n\tC3: 'C3.mp3',\n\t'D#3': 'Ds3.mp3',\n\t'F#3': 'Fs3.mp3',\n\tA3: 'A3.mp3',\n\tC4: 'C4.mp3',\n\t'D#4': 'Ds4.mp3',\n\t'F#4': 'Fs4.mp3',\n\tA4: 'A4.mp3',\n\tC5: 'C5.mp3',\n\t'D#5': 'Ds5.mp3',\n\t'F#5': 'Fs5.mp3',\n\tA5: 'A5.mp3',\n\tC6: 'C6.mp3',\n\t'D#6': 'Ds6.mp3',\n\t'F#6': 'Fs6.mp3',\n\tA6: 'A6.mp3',\n\tC7: 'C7.mp3',\n\t'D#7': 'Ds7.mp3',\n\t'F#7': 'Fs7.mp3',\n\tA7: 'A7.mp3',\n\tC8: 'C8.mp3',\n}\n\nfunction piano() {\n\treturn new Tone.Sampler({\n\t\turls: pianoSamps,\n\t\trelease: 1,\n\t\tbaseUrl: 'https://tonejs.github.io/audio/salamander/',\n\t})\n}\n\nexport class Piano extends Sampler {\n\tconstructor() {\n\t\tsuper(piano())\n\t}\n}\n","import * as p5 from 'p5'\nimport * as Tone from 'tone'\nimport { MidiEventNote } from '../MIDI'\nimport { ADSR, FilterProps, Instrument } from '../Instrument'\nimport { noteFreq, srand, srandVec } from '../util'\nimport { engine3d, Avatar, Obj, ObjOpts, Vec } from 'engine3d'\n\nexport class PolySynth extends Instrument {\n\tsynth: Tone.PolySynth\n\tfilter: Tone.Filter\n\tfilterVol: Tone.Volume\n\treverb: Tone.Reverb\n\tpanVol: Tone.PanVol\n\tps = 0\n\tpsSpread = 7\n\tmodwheel = 0.6\n\tobjs: Obj[] = []\n\tmaxObjs = 30\n\tii = 0\n\n\tconstructor() {\n\t\tsuper()\n\t\tthis.panVol = new Tone.PanVol(0, 0).toDestination()\n\t\tthis.reverb = new Tone.Reverb({ decay: 4, wet: 0.6 }).connect(this.panVol)\n\t\tthis.filterVol = new Tone.Volume(0).connect(this.reverb)\n\t\tthis.filter = new Tone.Filter({ type: 'bandpass' }).connect(this.filterVol)\n\t\tthis.synth = new Tone.PolySynth(Tone.Synth, {\n\t\t\toscillator: {\n\t\t\t\ttype: 'fatsquare',\n\t\t\t\tcount: 3,\n\t\t\t\tspread: 30,\n\t\t\t},\n\t\t}).connect(this.filter)\n\n\t\t// Initialize control sliders\n\t\tfor (const ss of this.ctrls.sliders) {\n\t\t\tswitch (ss.label) {\n\t\t\t\tcase 'mod':\n\t\t\t\t\tss.set(0.6)\n\t\t\t\t\tbreak\n\t\t\t\tcase 'a':\n\t\t\t\t\tss.set(0.01)\n\t\t\t\t\tbreak\n\t\t\t\tcase 'd':\n\t\t\t\t\tss.set(0.4)\n\t\t\t\t\tbreak\n\t\t\t\tcase 's':\n\t\t\t\t\tss.set(0.66)\n\t\t\t\t\tbreak\n\t\t\t\tcase 'r':\n\t\t\t\t\tss.set(0.5)\n\t\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t\tfor (const ss of this.ctrls.sliders) {\n\t\t\tthis.handleCC({ slider: ss })\n\t\t}\n\t}\n\n\tloaded() {\n\t\treturn true\n\t}\n\n\tnoteon = (avatar: Avatar, time: number, evt: MidiEventNote) => {\n\t\tthis.synth.triggerAttack(noteFreq(evt.note), time, evt.attack)\n\t\tTone.Draw.schedule(() => this.addSynthObj(avatar, evt), time)\n\t}\n\n\tnoteoff = (_avatar: Avatar, time: number, evt: MidiEventNote) => {\n\t\tconst freq = noteFreq(evt.note)\n\t\t// Tone.PolySynth can leave voices dangling, so manually release all voices matching this note\n\t\tTone.Draw.schedule(() => {\n\t\t\tfor (const vv of (this.synth as any)._activeVoices) {\n\t\t\t\tif (!vv.released && vv.midi === freq) {\n\t\t\t\t\tvv.voice.triggerRelease(Tone.immediate())\n\t\t\t\t}\n\t\t\t}\n\t\t}, `+${time - Tone.immediate()}`)\n\t}\n\n\thandleDetune = (val: number) => {\n\t\tthis.ps = val\n\t\tthis.synth.set({ detune: 100 * val * this.psSpread })\n\t}\n\n\thandleModwheel = (val: number) => {\n\t\tthis.modwheel = val\n\t\t// bind modwheel to filter freq and Q\n\t\tconst ff = this.ctrls.getSliderForLabel('ff')\n\t\tif (ff) {\n\t\t\tff.set(val)\n\t\t\tthis.handleCC({ slider: ff })\n\t\t}\n\t\tconst fq = this.ctrls.getSliderForLabel('fq')\n\t\tif (fq) {\n\t\t\tconst sin = Math.sin(val * Math.PI)\n\t\t\tlet vv = 1 - val\n\t\t\tvv = 1 - vv * vv * vv\n\t\t\tfq.set(sin * 0.2 + 0.06 + 0.2 * vv)\n\t\t\tthis.handleCC({ slider: fq })\n\t\t}\n\t}\n\n\thandleFilter = (props: FilterProps) => this.filter.set(props)\n\thandleADSR = (props: ADSR) => this.synth.set({ envelope: props })\n\n\t_rr = 0\n\t_lastPos: { [key: number]: Vec } = {}\n\taddSynthObj = (avatar: Avatar, evt: MidiEventNote) => {\n\t\t// Create obj for note\n\t\tconst objSize = 100\n\t\tconst { objs, maxObjs } = this\n\t\tconst { clientId } = avatar.user\n\t\tlet pos = avatar.xform.pos\n\t\tif (this._lastPos[clientId]) {\n\t\t\tpos = this._lastPos[clientId]\n\t\t}\n\t\tconst off = new Vec(srand(), Math.random() / 2 + 1, srand()).applyMult(objSize * 0.6)\n\t\tpos = pos.cloneAdd(off)\n\t\tif (this.ii++ % 8 === 0 || pos.y > 1000) {\n\t\t\t// Start a new column (4 total columns in semicircle behind avatar)\n\t\t\tconst { facing, xform } = avatar\n\t\t\tconst { pos: apos } = xform\n\t\t\tconst ff = new Vec(facing.x, facing.z, 0).applyMult(-700)\n\t\t\tff.rotate(-Math.PI / 2 + (Math.PI * ((this._rr++ % 4) + 1)) / 5)\n\t\t\tpos.x = apos.x + ff.x\n\t\t\tpos.y = apos.y\n\t\t\tpos.z = apos.z + ff.y\n\t\t}\n\t\tthis._lastPos[clientId] = pos\n\t\tconst rot = new Vec(\n\t\t\tMath.random() * Math.PI * 2,\n\t\t\tMath.random() * Math.PI * 2,\n\t\t\tMath.random() * Math.PI * 2,\n\t\t)\n\t\tconst obj = new SynthObj(this, {\n\t\t\tnoteEvt: evt,\n\t\t\tpos: pos,\n\t\t\trot: rot,\n\t\t\tscale: new Vec(objSize),\n\t\t})\n\t\t// Add obj to engine\n\t\tobjs.unshift(obj)\n\t\tengine3d.addObj(obj)\n\t\tif (objs.length > maxObjs) {\n\t\t\t// remove oldest obj\n\t\t\tengine3d.rmObj(objs[objs.length - 1])\n\t\t\tthis.objs = objs.slice(0, maxObjs)\n\t\t}\n\t}\n}\n\ntype SynthObjOpts = ObjOpts & {\n\tnoteEvt: MidiEventNote\n}\n\nclass SynthObj extends Obj {\n\tpolySynth: PolySynth\n\thue = Math.random()\n\tlgt = 0.3\n\t// envValLast = 1\n\t// voice: Tone.Synth | null = null\n\t// noteEvt: MidiEventNote\n\t// scaleOrig: Vec\n\n\tconstructor(polySynth: PolySynth, opts: SynthObjOpts) {\n\t\tsuper(opts)\n\t\tthis.polySynth = polySynth\n\t\t// this.noteEvt = opts.noteEvt\n\t\t// this.scaleOrig = this.xform.scale.clone()\n\t}\n\n\tupdate = (dt: number) => {\n\t\tlet mod = 1 - this.polySynth.modwheel\n\t\tmod = 1 - mod * mod\n\t\tthis.lgt = mod * 0.6 + 0.2\n\t\tthis.hue += (Math.random() * 2 - 1) * dt * mod\n\t\tif (this.hue < 0) {\n\t\t\tthis.hue += 1\n\t\t} else if (this.hue > 1) {\n\t\t\tthis.hue -= 1\n\t\t}\n\t\tthis.xform.rot.applyAdd(srandVec().applyMult(dt * mod))\n\t\t// // Disabled: scale by envelope value\n\t\t// const voices = (this.polySynth.synth as any)._activeVoices\n\t\t// if (!this.voice) {\n\t\t// \tfor (const vv of voices) {\n\t\t// \t\tif (vv.midi === noteFreq(this.noteEvt.note) && !vv.released) {\n\t\t// \t\t\tthis.voice = vv.voice\n\t\t// \t\t\tbreak\n\t\t// \t\t}\n\t\t// \t}\n\t\t// }\n\t\t// if (this.voice) {\n\t\t// \tthis.envValLast = this.voice.envelope.value\n\t\t// }\n\t\t// this.xform.scale = this.scaleOrig.cloneMult(this.envValLast)\n\t}\n\n\tdrawFunc = (pg: p5.Graphics) => {\n\t\tpg.colorMode(pg.HSL, 1)\n\t\tpg.fill(this.hue, 0.8, this.lgt)\n\t\tpg.stroke(this.hue, 0.8, this.lgt - 0.2)\n\t\tpg.strokeWeight(1)\n\t\tpg.sphere(1, 3, 4)\n\t\tpg.colorMode(pg.RGB, 255)\n\t}\n}\n","// import * as p5 from 'p5'\n/*\n *\n * The p5.EasyCam library - Easy 3D CameraControl for p5.js and WEBGL.\n *\n *   Copyright © 2017-2020 by p5.EasyCam authors\n *\n *   Source: https://github.com/freshfork/p5.EasyCam\n *\n *   MIT License: https://opensource.org/licenses/MIT\n *\n *\n * explanatory notes:\n *\n * p5.EasyCam is a derivative of the original PeasyCam Library by Jonathan Feinberg\n * and combines new useful features with the great look and feel of its parent.\n *\n */\n\n/** @namespace  */\n// var Dw = (function(ext) {\nconst ext = {}\n\n/**\n * EasyCam Library Info\n */\nconst INFO = {\n\t/** name    */ LIBRARY: 'p5.EasyCam',\n\t/** version */ VERSION: '1.0.10',\n\t/** author  */ AUTHOR: 'p5.EasyCam authors',\n\t/** source  */ SOURCE: 'https://github.com/freshfork/p5.EasyCam',\n\n\ttoString: function () {\n\t\treturn this.LIBRARY + ' v' + this.VERSION + ' by ' + this.AUTHOR + ' (' + this.SOURCE + ')'\n\t},\n}\n\n/**\n * EasyCam\n *\n * <pre>\n *\n *   new Dw.EasyCam(p5.RendererGL, {\n *     distance : z,                 // scalar\n *     center   : [x, y, z],         // vector\n *     rotation : [q0, q1, q2, q3],  // quaternion\n *     viewport : [x, y, w, h],      // array\n *   }\n *\n * </pre>\n *\n * @param {p5.RendererGL} renderer - p5 WEBGL renderer\n * @param {Object}        args     - {distance, center, rotation, viewport}\n *\n */\nexport class EasyCam {\n\t/**\n\t * @constructor\n\t */\n\tconstructor(renderer, args) {\n\t\t// WEBGL renderer required\n\t\tif (!(renderer instanceof window.p5.RendererGL)) {\n\t\t\tconsole.log('renderer needs to be an instance of p5.RendererGL')\n\t\t\treturn\n\t\t}\n\n\t\t// define default args\n\t\targs = args || {}\n\t\tif (args.distance === undefined) args.distance = 500\n\t\tif (args.center === undefined) args.center = [0, 0, 0]\n\t\tif (args.rotation === undefined) args.rotation = Rotation.identity()\n\t\tif (args.viewport === undefined) args.viewport = [0, 0, renderer.width, renderer.height]\n\n\t\t// library info\n\t\tthis.INFO = INFO\n\n\t\t// set renderer, graphics, p5\n\t\t// this.renderer;\n\t\t// this.graphics;\n\t\t// this.P5\n\t\tthis.setCanvas(renderer)\n\n\t\t// self reference\n\t\tvar cam = this\n\t\tthis.cam = cam\n\n\t\t// some constants\n\t\tthis.LOOK = [0, 0, 1]\n\t\tthis.UP = [0, 1, 0]\n\n\t\t// principal axes flags\n\t\tthis.AXIS = new (function () {\n\t\t\tthis.YAW = 0x01\n\t\t\tthis.PITCH = 0x02\n\t\t\tthis.ROLL = 0x04\n\t\t\tthis.ALL = this.YAW | this.PITCH | this.ROLL\n\t\t})()\n\n\t\t// mouse action constraints\n\t\tthis.SHIFT_CONSTRAINT = 0 // applied when pressing the shift key\n\t\tthis.FIXED_CONSTRAINT = 0 // applied, when set by user and SHIFT_CONSTRAINT is 0\n\t\tthis.DRAG_CONSTRAINT = 0 // depending on SHIFT_CONSTRAINT and FIXED_CONSTRAINT, default is ALL\n\n\t\t// mouse action speed\n\t\tthis.scale_rotation = 0.001\n\t\tthis.scale_pan = 0.0002\n\t\tthis.scale_zoom = 0.001\n\t\tthis.scale_zoomwheel = 20.0\n\n\t\t// zoom limits\n\t\tthis.distance_min_limit = 0.01\n\t\tthis.distance_min = 1.0\n\t\tthis.distance_max = Number.MAX_VALUE\n\n\t\t// main state\n\t\tthis.state = {\n\t\t\tdistance: args.distance, // scalar\n\t\t\tcenter: args.center.slice(), // vec3\n\t\t\trotation: args.rotation.slice(), // quaternion\n\n\t\t\tcopy: function (dst) {\n\t\t\t\tdst = dst || {}\n\t\t\t\tdst.distance = this.distance\n\t\t\t\tdst.center = this.center.slice()\n\t\t\t\tdst.rotation = this.rotation.slice()\n\t\t\t\treturn dst\n\t\t\t},\n\t\t}\n\n\t\t// backup-state at start\n\t\tthis.state_reset = this.state.copy()\n\t\t// backup-state, probably not required\n\t\tthis.state_pushed = this.state.copy()\n\n\t\t// viewport for the mouse-pointer [x,y,w,h]\n\t\tthis.viewport = args.viewport.slice()\n\n\t\t// mouse/touch/key action handler\n\t\tthis.mouse = {\n\t\t\tcam: cam,\n\n\t\t\tcurr: [0, 0, 0],\n\t\t\tprev: [0, 0, 0],\n\t\t\tdist: [0, 0, 0],\n\t\t\tmwheel: 0,\n\n\t\t\tisPressed: false, // true if (istouchdown || ismousedown)\n\t\t\tistouchdown: false, // true, if input came from a touch\n\t\t\tismousedown: false, // true, if input came from a mouse\n\n\t\t\tBUTTON: { LMB: 0x01, MMB: 0x02, RMB: 0x04 },\n\n\t\t\tbutton: 0,\n\n\t\t\tmouseDragLeft: cam.mouseDragRotate.bind(cam),\n\t\t\tmouseDragCenter: cam.mouseDragPan.bind(cam),\n\t\t\tmouseDragRight: cam.mouseDragZoom.bind(cam),\n\t\t\tmouseWheelAction: cam.mouseWheelZoom.bind(cam),\n\n\t\t\ttouchmoveSingle: cam.mouseDragRotate.bind(cam),\n\t\t\ttouchmoveMulti: function () {\n\t\t\t\tcam.mouseDragPan()\n\t\t\t\tcam.mouseDragZoom()\n\t\t\t},\n\n\t\t\tinsideViewport: function (x, y) {\n\t\t\t\tvar x0 = cam.viewport[0],\n\t\t\t\t\tx1 = x0 + cam.viewport[2]\n\t\t\t\tvar y0 = cam.viewport[1],\n\t\t\t\t\ty1 = y0 + cam.viewport[3]\n\t\t\t\treturn x > x0 && x < x1 && y > y0 && y < y1\n\t\t\t},\n\n\t\t\tsolveConstraint: function () {\n\t\t\t\tvar dx = this.dist[0]\n\t\t\t\tvar dy = this.dist[1]\n\n\t\t\t\t// YAW, PITCH\n\t\t\t\tif (this.shiftKey && !cam.SHIFT_CONSTRAINT && Math.abs(dx - dy) > 1) {\n\t\t\t\t\tcam.SHIFT_CONSTRAINT = Math.abs(dx) > Math.abs(dy) ? cam.AXIS.YAW : cam.AXIS.PITCH\n\t\t\t\t}\n\n\t\t\t\t// define constraint by increasing priority\n\t\t\t\tcam.DRAG_CONSTRAINT = cam.AXIS.ALL\n\t\t\t\tif (cam.FIXED_CONSTRAINT) cam.DRAG_CONSTRAINT = cam.FIXED_CONSTRAINT\n\t\t\t\tif (cam.SHIFT_CONSTRAINT) cam.DRAG_CONSTRAINT = cam.SHIFT_CONSTRAINT\n\t\t\t},\n\n\t\t\tupdateInput: function (x, y, z) {\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tvar pd = cam.P5.pixelDensity()\n\n\t\t\t\tmouse.prev[0] = mouse.curr[0]\n\t\t\t\tmouse.prev[1] = mouse.curr[1]\n\t\t\t\tmouse.prev[2] = mouse.curr[2]\n\n\t\t\t\tmouse.curr[0] = x\n\t\t\t\tmouse.curr[1] = y\n\t\t\t\tmouse.curr[2] = z\n\n\t\t\t\tmouse.dist[0] = -(mouse.curr[0] - mouse.prev[0]) / pd\n\t\t\t\tmouse.dist[1] = -(mouse.curr[1] - mouse.prev[1]) / pd\n\t\t\t\tmouse.dist[2] = -(mouse.curr[2] - mouse.prev[2]) / pd\n\t\t\t},\n\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\t\t\t// mouseinput\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\n\t\t\tmousedown: function (event) {\n\t\t\t\tvar mouse = cam.mouse\n\n\t\t\t\tif (event.button === 0) mouse.button |= mouse.BUTTON.LMB\n\t\t\t\tif (event.button === 1) mouse.button |= mouse.BUTTON.MMB\n\t\t\t\tif (event.button === 2) mouse.button |= mouse.BUTTON.RMB\n\n\t\t\t\tif (mouse.insideViewport(event.x, event.y)) {\n\t\t\t\t\tmouse.updateInput(event.x, event.y, event.y)\n\t\t\t\t\tmouse.ismousedown = mouse.button > 0\n\t\t\t\t\tmouse.isPressed = mouse.ismousedown\n\t\t\t\t\tcam.SHIFT_CONSTRAINT = 0\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tmousedrag: function () {\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tif (mouse.ismousedown) {\n\t\t\t\t\tvar x = cam.P5.mouseX\n\t\t\t\t\tvar y = cam.P5.mouseY\n\t\t\t\t\tvar z = y\n\n\t\t\t\t\tmouse.updateInput(x, y, z)\n\t\t\t\t\tmouse.solveConstraint()\n\n\t\t\t\t\tvar LMB = mouse.button & mouse.BUTTON.LMB\n\t\t\t\t\tvar MMB = mouse.button & mouse.BUTTON.MMB\n\t\t\t\t\tvar RMB = mouse.button & mouse.BUTTON.RMB\n\n\t\t\t\t\tif (LMB && mouse.mouseDragLeft) mouse.mouseDragLeft()\n\t\t\t\t\tif (MMB && mouse.mouseDragCenter) mouse.mouseDragCenter()\n\t\t\t\t\tif (RMB && mouse.mouseDragRight) mouse.mouseDragRight()\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tmouseup: function (event) {\n\t\t\t\tvar mouse = cam.mouse\n\n\t\t\t\tif (event.button === 0) mouse.button &= ~mouse.BUTTON.LMB\n\t\t\t\tif (event.button === 1) mouse.button &= ~mouse.BUTTON.MMB\n\t\t\t\tif (event.button === 2) mouse.button &= ~mouse.BUTTON.RMB\n\n\t\t\t\tmouse.ismousedown = mouse.button > 0\n\t\t\t\tmouse.isPressed = mouse.istouchdown || mouse.ismousedown\n\t\t\t\tcam.SHIFT_CONSTRAINT = 0\n\t\t\t},\n\n\t\t\tdblclick: function (event) {\n\t\t\t\tvar x = event.x\n\t\t\t\tvar y = event.y\n\t\t\t\tif (cam.mouse.insideViewport(x, y)) {\n\t\t\t\t\tcam.reset()\n\t\t\t\t}\n\t\t\t},\n\n\t\t\twheel: function (event) {\n\t\t\t\tvar x = event.x\n\t\t\t\tvar y = event.y\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tif (mouse.insideViewport(x, y)) {\n\t\t\t\t\tmouse.mwheel = event.deltaY * 0.01\n\t\t\t\t\tif (mouse.mouseWheelAction) mouse.mouseWheelAction()\n\t\t\t\t}\n\t\t\t},\n\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\t\t\t// touchinput\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\n\t\t\tevaluateTouches: function (event) {\n\t\t\t\tvar touches = event.touches\n\t\t\t\tvar avg_x = 0.0\n\t\t\t\tvar avg_y = 0.0\n\t\t\t\tvar avg_d = 0.0\n\t\t\t\tvar i,\n\t\t\t\t\tdx,\n\t\t\t\t\tdy,\n\t\t\t\t\tcount = touches.length\n\n\t\t\t\t// center, averaged touch position\n\t\t\t\tfor (i = 0; i < count; i++) {\n\t\t\t\t\tavg_x += touches[i].clientX\n\t\t\t\t\tavg_y += touches[i].clientY\n\t\t\t\t}\n\t\t\t\tavg_x /= count\n\t\t\t\tavg_y /= count\n\n\t\t\t\t// offset, mean distance to center\n\t\t\t\tfor (i = 0; i < count; i++) {\n\t\t\t\t\tdx = avg_x - touches[i].clientX\n\t\t\t\t\tdy = avg_y - touches[i].clientY\n\t\t\t\t\tavg_d += Math.sqrt(dx * dx + dy * dy)\n\t\t\t\t}\n\t\t\t\tavg_d /= count\n\n\t\t\t\tcam.mouse.updateInput(avg_x, avg_y, -avg_d)\n\t\t\t},\n\n\t\t\ttouchstart: function (event) {\n\t\t\t\tevent.preventDefault()\n\t\t\t\tevent.stopPropagation()\n\n\t\t\t\tvar mouse = cam.mouse\n\n\t\t\t\tmouse.evaluateTouches(event)\n\t\t\t\tmouse.istouchdown = mouse.insideViewport(mouse.curr[0], mouse.curr[1])\n\t\t\t\tmouse.isPressed = cam.mouse.istouchdown || cam.mouse.ismousedown\n\n\t\t\t\tmouse.dbltap(event)\n\t\t\t},\n\n\t\t\ttouchmove: function (event) {\n\t\t\t\tevent.preventDefault()\n\t\t\t\tevent.stopPropagation()\n\n\t\t\t\tvar mouse = cam.mouse\n\n\t\t\t\tif (mouse.istouchdown) {\n\t\t\t\t\tmouse.evaluateTouches(event)\n\t\t\t\t\tmouse.solveConstraint()\n\n\t\t\t\t\tif (event.touches.length === 1) {\n\t\t\t\t\t\tmouse.touchmoveSingle()\n\t\t\t\t\t} else {\n\t\t\t\t\t\tmouse.touchmoveMulti()\n\t\t\t\t\t\tmouse.tapcount = 0\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\n\t\t\ttouchend: function (event) {\n\t\t\t\tevent.preventDefault()\n\t\t\t\tevent.stopPropagation()\n\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tmouse.istouchdown = false\n\t\t\t\tmouse.isPressed = mouse.istouchdown || mouse.ismousedown\n\t\t\t\tcam.SHIFT_CONSTRAINT = 0\n\n\t\t\t\tif (mouse.tapcount >= 2) {\n\t\t\t\t\tif (mouse.insideViewport(mouse.curr[0], mouse.curr[1])) {\n\t\t\t\t\t\tcam.reset()\n\t\t\t\t\t}\n\t\t\t\t\tmouse.tapcount = 0\n\t\t\t\t}\n\t\t\t},\n\n\t\t\ttapcount: 0,\n\n\t\t\tdbltap: function (event) {\n\t\t\t\tif (cam.mouse.tapcount++ === 0) {\n\t\t\t\t\tsetTimeout(function () {\n\t\t\t\t\t\tcam.mouse.tapcount = 0\n\t\t\t\t\t}, 350)\n\t\t\t\t}\n\t\t\t},\n\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\t\t\t// keyingput\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\n\t\t\t// key-event for shift constraints\n\t\t\tshiftKey: false,\n\n\t\t\tkeydown: function (event) {\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tif (!mouse.shiftKey) {\n\t\t\t\t\tmouse.shiftKey = event.keyCode === 16\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tkeyup: function (event) {\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tif (mouse.shiftKey) {\n\t\t\t\t\tmouse.shiftKey = event.keyCode !== 16\n\t\t\t\t\tif (!mouse.shiftKey) {\n\t\t\t\t\t\tcam.SHIFT_CONSTRAINT = 0\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t}\n\n\t\t// camera mouse listeners\n\t\tthis.attachMouseListeners()\n\n\t\t// P5 registered callbacks, TODO unregister on dispose\n\t\tthis.auto_update = true\n\t\tthis.P5.registerMethod('pre', function () {\n\t\t\tif (cam.auto_update) {\n\t\t\t\tcam.update()\n\t\t\t}\n\t\t})\n\n\t\t// damped camera transition\n\t\tthis.dampedZoom = new DampedAction(function (d) {\n\t\t\tcam.zoom(d * cam.getZoomMult())\n\t\t})\n\t\tthis.dampedPanX = new DampedAction(function (d) {\n\t\t\tcam.panX(d * cam.getPanMult())\n\t\t})\n\t\tthis.dampedPanY = new DampedAction(function (d) {\n\t\t\tcam.panY(d * cam.getPanMult())\n\t\t})\n\t\tthis.dampedPanZ = new DampedAction(function (d) {\n\t\t\tcam.panZ(d * cam.getPanMult())\n\t\t})\n\t\tthis.dampedRotX = new DampedAction(function (d) {\n\t\t\tcam.rotateX(d * cam.getRotationMult())\n\t\t})\n\t\tthis.dampedRotY = new DampedAction(function (d) {\n\t\t\tcam.rotateY(d * cam.getRotationMult())\n\t\t})\n\t\tthis.dampedRotZ = new DampedAction(function (d) {\n\t\t\tcam.rotateZ(d * cam.getRotationMult())\n\t\t})\n\n\t\t// interpolated camera transition\n\t\tthis.timedRot = new Interpolation(cam.setInterpolatedRotation.bind(cam))\n\t\tthis.timedPan = new Interpolation(cam.setInterpolatedCenter.bind(cam))\n\t\tthis.timedzoom = new Interpolation(cam.setInterpolatedDistance.bind(cam))\n\t}\n\n\t/**\n\t * sets the WEBGL renderer the camera is working on\n\t *\n\t * @param {p5.RendererGL} renderer ... p5 WEBGL renderer\n\t */\n\tsetCanvas(renderer) {\n\t\tif (renderer instanceof window.p5.RendererGL) {\n\t\t\t// p5js seems to be not very clear about this\n\t\t\t// ... a bit confusing, so i guess this could change in future releases\n\t\t\tthis.renderer = renderer\n\t\t\tif (renderer._pInst instanceof window.p5) {\n\t\t\t\tthis.graphics = renderer\n\t\t\t} else {\n\t\t\t\tthis.graphics = renderer._pInst\n\t\t\t}\n\t\t\tthis.P5 = this.graphics._pInst\n\t\t} else {\n\t\t\tthis.graphics = undefined\n\t\t\tthis.renderer = undefined\n\t\t}\n\t}\n\n\t/** @return {p5.RendererGL} the currently used renderer */\n\tgetCanvas() {\n\t\treturn this.renderer\n\t}\n\n\tattachListener(el, ev, fx, op) {\n\t\tif (!el || el === fx.el) {\n\t\t\treturn\n\t\t}\n\n\t\tthis.detachListener(fx)\n\n\t\tfx.el = el\n\t\tfx.ev = ev\n\t\tfx.op = op\n\t\tfx.el.addEventListener(fx.ev, fx, fx.op)\n\t}\n\n\tdetachListener(fx) {\n\t\tif (fx.el) {\n\t\t\tfx.el.removeEventListener(fx.ev, fx, fx.op)\n\t\t\tfx.el = undefined\n\t\t}\n\t}\n\n\t/** attaches input-listeners (mouse, touch, key) to the used renderer */\n\tattachMouseListeners(renderer) {\n\t\tvar cam = this.cam\n\t\tvar mouse = cam.mouse\n\n\t\trenderer = renderer || cam.renderer\n\t\tif (renderer) {\n\t\t\tvar op = { passive: false }\n\t\t\tvar el = renderer.elt\n\n\t\t\tcam.attachListener(el, 'mousedown', mouse.mousedown, op)\n\t\t\tcam.attachListener(el, 'mouseup', mouse.mouseup, op)\n\t\t\t// cam.attachListener(el, 'dblclick', mouse.dblclick, op)\n\t\t\tcam.attachListener(el, 'wheel', mouse.wheel, op)\n\t\t\tcam.attachListener(el, 'touchstart', mouse.touchstart, op)\n\t\t\tcam.attachListener(el, 'touchend', mouse.touchend, op)\n\t\t\tcam.attachListener(el, 'touchmove', mouse.touchmove, op)\n\t\t\tcam.attachListener(window, 'keydown', mouse.keydown, op)\n\t\t\tcam.attachListener(window, 'keyup', mouse.keyup, op)\n\t\t}\n\t}\n\n\t/** detaches all attached input-listeners */\n\tremoveMouseListeners() {\n\t\tvar cam = this.cam\n\t\tvar mouse = cam.mouse\n\n\t\tcam.detachListener(mouse.mousedown)\n\t\tcam.detachListener(mouse.mouseup)\n\t\t// cam.detachListener(mouse.dblclick)\n\t\tcam.detachListener(mouse.wheel)\n\t\tcam.detachListener(mouse.keydown)\n\t\tcam.detachListener(mouse.keyup)\n\t\tcam.detachListener(mouse.touchstart)\n\t\tcam.detachListener(mouse.touchend)\n\t\tcam.detachListener(mouse.touchmove)\n\t}\n\n\t/** Disposes/releases the camera. */\n\tdispose() {\n\t\t// // TODO: p5 unregister 'pre', ... not available in 0.5.16\n\t\t// removeMouseListeners();\n\t}\n\n\t/** @return {boolean} the current autoUpdate state */\n\tgetAutoUpdate() {\n\t\treturn this.auto_update\n\t}\n\t/**\n\t * If true, the EasyCam will update automatically in a pre-draw step.\n\t * This updates the camera state and updates the renderers\n\t * modelview/camera matrix.\n\t *\n\t * If false, the update() needs to be called manually.\n\t *\n\t * @param {boolean} the new autoUpdate state\n\t */\n\tsetAutoUpdate(status) {\n\t\tthis.auto_update = status\n\t}\n\n\t/**\n\t * Updates the camera state (interpolated / damped animations) and updates\n\t * the renderers' modelview/camera matrix.\n\t *\n\t * if \"auto_update\" is true, this is called automatically in a pre-draw call.\n\t */\n\tupdate() {\n\t\tvar cam = this.cam\n\t\tvar mouse = cam.mouse\n\n\t\tmouse.mousedrag()\n\n\t\tvar b_update = false\n\t\tb_update |= cam.dampedZoom.update()\n\t\tb_update |= cam.dampedPanX.update()\n\t\tb_update |= cam.dampedPanY.update()\n\t\tb_update |= cam.dampedPanZ.update()\n\t\tb_update |= cam.dampedRotX.update()\n\t\tb_update |= cam.dampedRotY.update()\n\t\tb_update |= cam.dampedRotZ.update()\n\n\t\t// interpolated actions have lower priority then damped actions\n\t\tif (b_update) {\n\t\t\tcam.timedRot.stop()\n\t\t\tcam.timedPan.stop()\n\t\t\tcam.timedzoom.stop()\n\t\t} else {\n\t\t\tcam.timedRot.update()\n\t\t\tcam.timedPan.update()\n\t\t\tcam.timedzoom.update()\n\t\t}\n\n\t\tcam.apply()\n\t}\n\n\t/**\n\t * Applies the current camera state to the renderers' modelview/camera matrix.\n\t * If no argument is given, then the cameras currently set renderer is used.\n\t */\n\tapply(renderer) {\n\t\tvar cam = this.cam\n\t\trenderer = renderer || cam.renderer\n\n\t\tif (renderer) {\n\t\t\tthis.camEYE = this.getPosition(this.camEYE)\n\t\t\tthis.camLAT = this.getCenter(this.camLAT)\n\t\t\tthis.camLAT[1] += this.cam.state.distance / 6 // put center towards bottom of screen\n\t\t\tthis.camRUP = this.getUpVector(this.camRUP)\n\n\t\t\tif (undefined === renderer._curCamera)\n\t\t\t\trenderer.camera(\n\t\t\t\t\tthis.camEYE[0],\n\t\t\t\t\tthis.camEYE[1],\n\t\t\t\t\tthis.camEYE[2],\n\t\t\t\t\tthis.camLAT[0],\n\t\t\t\t\tthis.camLAT[1],\n\t\t\t\t\tthis.camLAT[2],\n\t\t\t\t\tthis.camRUP[0],\n\t\t\t\t\tthis.camRUP[1],\n\t\t\t\t\tthis.camRUP[2],\n\t\t\t\t)\n\t\t\telse\n\t\t\t\trenderer._curCamera.camera(\n\t\t\t\t\tthis.camEYE[0],\n\t\t\t\t\tthis.camEYE[1],\n\t\t\t\t\tthis.camEYE[2],\n\t\t\t\t\tthis.camLAT[0],\n\t\t\t\t\tthis.camLAT[1],\n\t\t\t\t\tthis.camLAT[2],\n\t\t\t\t\tthis.camRUP[0],\n\t\t\t\t\tthis.camRUP[1],\n\t\t\t\t\tthis.camRUP[2],\n\t\t\t\t)\n\t\t}\n\t}\n\n\t/** @param {int[]} the new viewport-def, as [x,y,w,h] */\n\tsetViewport(viewport) {\n\t\tthis.viewport = viewport.slice()\n\t}\n\n\t/** @returns {int[]} the current viewport-def, as [x,y,w,h] */\n\tgetViewport() {\n\t\treturn this.viewport\n\t}\n\n\t//\n\t// mouse state changes\n\t//\n\n\t/** implemented zoom-cb for mouswheel handler.*/\n\tmouseWheelZoom() {\n\t\tvar cam = this\n\t\tvar mouse = cam.mouse\n\t\tcam.dampedZoom.addForce(mouse.mwheel * cam.scale_zoomwheel)\n\t}\n\n\t/** implemented zoom-cb for mousedrag/touch handler.*/\n\tmouseDragZoom() {\n\t\tvar cam = this\n\t\tvar mouse = cam.mouse\n\t\tcam.dampedZoom.addForce(-mouse.dist[2])\n\t}\n\n\t/** implemented pan-cb for mousedrag/touch handler.*/\n\tmouseDragPan() {\n\t\tvar cam = this\n\t\tvar mouse = cam.mouse\n\n\t\tcam.dampedPanX.addForce(cam.DRAG_CONSTRAINT & cam.AXIS.YAW ? mouse.dist[0] : 0)\n\t\tcam.dampedPanY.addForce(cam.DRAG_CONSTRAINT & cam.AXIS.PITCH ? mouse.dist[1] : 0)\n\t}\n\n\t/** implemented rotate-cb for mousedrag/touch handler.*/\n\tmouseDragRotate() {\n\t\tvar cam = this\n\t\tvar mouse = cam.mouse\n\n\t\tvar mx = mouse.curr[0],\n\t\t\tmy = mouse.curr[1]\n\t\tvar dx = mouse.dist[0],\n\t\t\tdy = mouse.dist[1]\n\n\t\t// mouse [-1, +1]\n\t\tvar mxNdc = Math.min(Math.max((mx - cam.viewport[0]) / cam.viewport[2], 0), 1) * 2 - 1\n\t\tvar myNdc = Math.min(Math.max((my - cam.viewport[1]) / cam.viewport[3], 0), 1) * 2 - 1\n\n\t\tif (cam.DRAG_CONSTRAINT & cam.AXIS.YAW) {\n\t\t\tcam.dampedRotY.addForce(+dx * (1.0 - myNdc * myNdc))\n\t\t}\n\t\tif (cam.DRAG_CONSTRAINT & cam.AXIS.PITCH) {\n\t\t\tcam.dampedRotX.addForce(-dy * (1.0 - mxNdc * mxNdc))\n\t\t}\n\t\tif (cam.DRAG_CONSTRAINT & cam.AXIS.ROLL) {\n\t\t\tcam.dampedRotZ.addForce(-dx * myNdc)\n\t\t\tcam.dampedRotZ.addForce(+dy * mxNdc)\n\t\t}\n\t}\n\n\t//\n\t// damped multipliers\n\t//\n\t/** (private) returns the used zoom -multiplier for damped actions. */\n\tgetZoomMult() {\n\t\treturn this.state.distance * this.scale_zoom\n\t}\n\t/** (private) returns the used pan-multiplier for damped actions. */\n\tgetPanMult() {\n\t\treturn this.state.distance * this.scale_pan\n\t}\n\t/** (private) returns the used rotate-multiplier for damped actions. */\n\tgetRotationMult() {\n\t\treturn Math.pow(Math.log10(1 + this.state.distance), 0.5) * this.scale_rotation\n\t}\n\n\t//\n\t// damped state changes\n\t//\n\t/** Applies a change to the current zoom.  */\n\tzoom(dz) {\n\t\tvar cam = this.cam\n\t\tvar distance_tmp = cam.state.distance + dz\n\n\t\t// check lower bound\n\t\tif (distance_tmp < cam.distance_min) {\n\t\t\tdistance_tmp = cam.distance_min\n\t\t\tcam.dampedZoom.stop()\n\t\t}\n\n\t\t// check upper bound\n\t\tif (distance_tmp > cam.distance_max) {\n\t\t\tdistance_tmp = cam.distance_max\n\t\t\tcam.dampedZoom.stop()\n\t\t}\n\n\t\tcam.state.distance = distance_tmp\n\t}\n\n\t/** Applies a change to the current pan-xValue.  */\n\tpanX(dx) {\n\t\tvar state = this.cam.state\n\t\tif (dx) {\n\t\t\tvar val = Rotation.applyToVec3(state.rotation, [dx, 0, 0])\n\t\t\tVec3.add(state.center, val, state.center)\n\t\t}\n\t}\n\n\t/** Applies a change to the current pan-yValue.  */\n\tpanY(dy) {\n\t\tvar state = this.cam.state\n\t\tif (dy) {\n\t\t\tvar val = Rotation.applyToVec3(state.rotation, [0, dy, 0])\n\t\t\tVec3.add(state.center, val, state.center)\n\t\t}\n\t}\n\n\tpanZ(dz) {\n\t\tvar state = this.cam.state\n\t\tif (dz) {\n\t\t\tvar val = Rotation.applyToVec3(state.rotation, [0, 0, dz])\n\t\t\tVec3.add(state.center, val, state.center)\n\t\t}\n\t}\n\n\tpanGround(dx, dy, dz) {\n\t\tconst ca = this.centerAxes()\n\t\tVec3.mult(ca.x, dx, ca.x)\n\t\tVec3.mult(ca.z, dz, ca.z)\n\t\tconst val = [0, 0, 0]\n\t\tVec3.add(ca.x, ca.z, val)\n\t\tval[1] = dy\n\t\tVec3.add(this.cam.state.center, val, this.cam.state.center)\n\t}\n\n\tcenterAxes() {\n\t\tconst state = this.cam.state\n\t\t// Get world unit vector for screen-space X axis\n\t\tconst screenX = Rotation.applyToVec3(state.rotation, [1, 0, 0])\n\t\tscreenX[1] = 0 // project X vector onto ground plane\n\t\t// normalize post-projection vector\n\t\tlet mX = Vec3.mag(screenX)\n\t\tif (mX === 0) {\n\t\t\tconsole.warn('[EasyCam] No magnitude for screenX vector', screenX)\n\t\t\tmX = 1\n\t\t}\n\t\tVec3.mult(screenX, 1.0 / mX, screenX)\n\t\t// Get Z vector: cross-product of X with UP (Y)\n\t\tconst screenZ = [0, 0, 0]\n\t\tVec3.cross(screenX, [0, 1, 0], screenZ)\n\t\t// Multiply ground-plane vectors by arguments, apply to camera state\n\t\treturn {\n\t\t\tx: screenX,\n\t\t\ty: [0, 1, 0],\n\t\t\tz: screenZ,\n\t\t}\n\t}\n\n\t/** Applies a change to the current pan-value.  */\n\tpan(dx, dy, dz) {\n\t\tthis.cam.panX(dx)\n\t\tthis.cam.panY(dy)\n\t\tthis.cam.panZ(dz)\n\t}\n\n\t/** Applies a change to the current xRotation.  */\n\trotateX(rx) {\n\t\tthis.cam.rotate([1, 0, 0], rx)\n\t}\n\n\t/** Applies a change to the current yRotation.  */\n\trotateY(ry) {\n\t\tthis.cam.rotate([0, 1, 0], ry)\n\t}\n\n\t/** Applies a change to the current zRotation.  */\n\trotateZ(rz) {\n\t\tthis.cam.rotate([0, 0, 1], rz)\n\t}\n\n\t/** Applies a change to the current rotation, using the given axis/angle.  */\n\trotate(axis, angle) {\n\t\tvar state = this.cam.state\n\t\tif (angle) {\n\t\t\tvar new_rotation = Rotation.create({ axis: axis, angle: angle })\n\t\t\tRotation.applyToRotation(state.rotation, new_rotation, state.rotation)\n\t\t}\n\t}\n\n\t//\n\t// interpolated states\n\t//\n\t/** Sets the new camera-distance, interpolated (t) between given A and B. */\n\tsetInterpolatedDistance(valA, valB, t) {\n\t\tthis.cam.state.distance = Scalar.mix(valA, valB, Scalar.smoothstep(t))\n\t}\n\t/** Sets the new camera-center, interpolated (t) between given A and B. */\n\tsetInterpolatedCenter(valA, valB, t) {\n\t\tthis.cam.state.center = Vec3.mix(valA, valB, Scalar.smoothstep(t))\n\t}\n\t/** Sets the new camera-rotation, interpolated (t) between given A and B. */\n\tsetInterpolatedRotation(valA, valB, t) {\n\t\tthis.cam.state.rotation = Rotation.slerp(valA, valB, t)\n\t}\n\n\t//\n\t// DISTANCE\n\t//\n\t/** Sets the minimum camera distance. */\n\tsetDistanceMin(distance_min) {\n\t\tthis.distance_min = Math.max(distance_min, this.distance_min_limit)\n\t\tthis.zoom(0) // update, to ensure new minimum\n\t}\n\n\t/** Sets the maximum camera distance. */\n\tsetDistanceMax(distance_max) {\n\t\tthis.distance_max = distance_max\n\t\tthis.zoom(0) // update, to ensure new maximum\n\t}\n\n\t/**\n\t * Sets the new camera distance.\n\t *\n\t * @param {double} new distance.\n\t * @param {long} animation time in millis.\n\t */\n\tsetDistance(distance, duration) {\n\t\tthis.timedzoom.start(this.state.distance, distance, duration, [this.dampedZoom])\n\t}\n\n\t/** @returns {double} the current camera distance. */\n\tgetDistance() {\n\t\treturn this.state.distance\n\t}\n\n\t//\n\t// CENTER / LOOK AT\n\t//\n\t/**\n\t * Sets the new camera center.\n\t *\n\t * @param {double[]} new center.\n\t * @param {long} animation time in millis.\n\t */\n\tsetCenter(center, duration) {\n\t\tthis.timedPan.start(this.state.center, center, duration, [this.dampedPanX, this.dampedPanY])\n\t}\n\n\t/** @returns {double[]} the current camera center. */\n\tgetCenter() {\n\t\treturn this.state.center\n\t}\n\n\t//\n\t// ROTATION\n\t//\n\t/**\n\t * Sets the new camera rotation (quaternion).\n\t *\n\t * @param {double[]} new rotation as quat[q0,q1,q2,q3].\n\t * @param {long} animation time in millis.\n\t */\n\tsetRotation(rotation, duration) {\n\t\tthis.timedRot.start(this.state.rotation, rotation, duration, [\n\t\t\tthis.dampedRotX,\n\t\t\tthis.dampedRotY,\n\t\t\tthis.dampedRotZ,\n\t\t])\n\t}\n\n\t/** @returns {double[]} the current camera rotation as quat[q0,q1,q2,q3]. */\n\tgetRotation() {\n\t\treturn this.state.rotation\n\t}\n\n\t//\n\t// CAMERA POSITION/EYE\n\t//\n\t/** @returns {double[]} the current camera position, aka. the eye position. */\n\tgetPosition(dst) {\n\t\tvar cam = this.cam\n\t\tvar state = cam.state\n\n\t\tdst = Vec3.assert(dst)\n\t\tRotation.applyToVec3(state.rotation, cam.LOOK, dst)\n\t\tVec3.mult(dst, state.distance, dst)\n\t\tVec3.add(dst, state.center, dst)\n\n\t\treturn dst\n\t}\n\n\t//\n\t// CAMERA UP\n\t//\n\t/** @returns {double[]} the current camera up vector. */\n\tgetUpVector(dst) {\n\t\tvar cam = this.cam\n\t\tvar state = cam.state\n\t\tdst = Vec3.assert(dst)\n\t\tRotation.applyToVec3(state.rotation, cam.UP, dst)\n\t\treturn dst\n\t}\n\n\t//\n\t// STATE (rotation, center, distance)\n\t//\n\t/** @returns {Object} a copy of the camera state {distance,center,rotation} */\n\tgetState() {\n\t\treturn this.state.copy()\n\t}\n\t/**\n\t * @param {Object} a new camera state {distance,center,rotation}.\n\t * @param {long} animation time in millis.\n\t */\n\tsetState(other, duration) {\n\t\tif (other) {\n\t\t\tthis.setDistance(other.distance, duration)\n\t\t\tthis.setCenter(other.center, duration)\n\t\t\tthis.setRotation(other.rotation, duration)\n\t\t}\n\t}\n\n\tpushState() {\n\t\treturn (this.state_pushed = this.getState())\n\t}\n\tpopState(duration) {\n\t\tthis.setState(this.state_pushed, duration)\n\t}\n\n\t/** sets the current state as reset-state. */\n\tpushResetState() {\n\t\treturn (this.state_reset = this.getState())\n\t}\n\t/** resets the camera, by applying the reset-state. */\n\treset(duration) {\n\t\tthis.setState(this.state_reset, duration)\n\t}\n\n\t/** sets the rotation scale/speed. */\n\tsetRotationScale(scale_rotation) {\n\t\tthis.scale_rotation = scale_rotation\n\t}\n\t/** sets the pan scale/speed. */\n\tsetPanScale(scale_pan) {\n\t\tthis.scale_pan = scale_pan\n\t}\n\t/** sets the zoom scale/speed. */\n\tsetZoomScale(scale_zoom) {\n\t\tthis.scale_zoom = scale_zoom\n\t}\n\t/** sets the wheel scale/speed. */\n\tsetWheelScale(wheelScale) {\n\t\tthis.scale_zoomwheel = wheelScale\n\t}\n\t/** @returns the rotation scale/speed. */\n\tgetRotationScale() {\n\t\treturn this.scale_rotation\n\t}\n\t/** @returns the pan scale/speed. */\n\tgetPanScale() {\n\t\treturn this.scale_pan\n\t}\n\t/** @returns the zoom scale/speed. */\n\tgetZoomScale() {\n\t\treturn this.scale_zoom\n\t}\n\t/** @returns the wheel scale/speed. */\n\tgetWheelScale() {\n\t\treturn this.scale_zoomwheel\n\t}\n\n\t/** sets the default damping scale/speed. */\n\tsetDamping(damping) {\n\t\tthis.dampedZoom.damping = damping\n\t\tthis.dampedPanX.damping = damping\n\t\tthis.dampedPanY.damping = damping\n\t\tthis.dampedPanZ.damping = damping\n\t\tthis.dampedRotX.damping = damping\n\t\tthis.dampedRotY.damping = damping\n\t\tthis.dampedRotZ.damping = damping\n\t}\n\t/** sets the default interpolation time in millis. */\n\tsetDefaultInterpolationTime(duration) {\n\t\tthis.timedRot.default_duration = duration\n\t\tthis.timedPan.default_duration = duration\n\t\tthis.timedzoom.default_duration = duration\n\t}\n\n\t/**\n\t * sets the rotation constraint for each axis separately.\n\t *\n\t * @param {boolean} yaw constraint\n\t * @param {boolean} pitch constraint\n\t * @param {boolean} roll constraint\n\t */\n\tsetRotationConstraint(yaw, pitch, roll) {\n\t\tvar cam = this.cam\n\t\tcam.FIXED_CONSTRAINT = 0\n\t\tcam.FIXED_CONSTRAINT |= yaw ? cam.AXIS.YAW : 0\n\t\tcam.FIXED_CONSTRAINT |= pitch ? cam.AXIS.PITCH : 0\n\t\tcam.FIXED_CONSTRAINT |= roll ? cam.AXIS.ROLL : 0\n\t}\n\n\t/**\n\t *\n\t * begin screen-aligned 2D-drawing.\n\t *\n\t * <pre>\n\t * beginHUD()\n\t *   disabled depth test\n\t *   ortho\n\t *   ... your code is executed here ...\n\t * endHUD()\n\t * </pre>\n\t *\n\t */\n\tbeginHUD(renderer, w, h) {\n\t\tvar cam = this.cam\n\t\trenderer = renderer || cam.renderer\n\n\t\tif (!renderer) return\n\t\tthis.pushed_rendererState = renderer.push()\n\n\t\tvar gl = renderer.drawingContext\n\t\tconst ww = w !== undefined ? w : renderer.width\n\t\tconst hh = h !== undefined ? h : renderer.height\n\t\tvar d = Number.MAX_VALUE\n\n\t\tgl.flush()\n\t\t// gl.finish();\n\n\t\t// 1) disable DEPTH_TEST\n\t\tgl.disable(gl.DEPTH_TEST)\n\t\t// 2) push modelview/projection\n\t\t//    p5 is not creating a push/pop stack\n\t\tthis.pushed_uMVMatrix = renderer.uMVMatrix.copy()\n\t\tthis.pushed_uPMatrix = renderer.uPMatrix.copy()\n\n\t\t// 3) set new modelview (identity)\n\t\trenderer.resetMatrix()\n\t\t// 4) set new projection (ortho)\n\t\trenderer._curCamera.ortho(0, ww, -hh, 0, -d, +d)\n\t\t// renderer.ortho();\n\t\t// renderer.translate(-w/2, -h/2);\n\t}\n\n\t/**\n\t *\n\t * end screen-aligned 2D-drawing.\n\t *\n\t */\n\tendHUD(renderer) {\n\t\tvar cam = this.cam\n\t\trenderer = renderer || cam.renderer\n\n\t\tif (!renderer) return\n\n\t\tvar gl = renderer.drawingContext\n\n\t\tgl.flush()\n\t\t// gl.finish();\n\n\t\t// 2) restore modelview/projection\n\t\trenderer.uMVMatrix.set(this.pushed_uMVMatrix)\n\t\trenderer.uPMatrix.set(this.pushed_uPMatrix)\n\t\t// 1) enable DEPTH_TEST\n\t\tgl.enable(gl.DEPTH_TEST)\n\t\trenderer.pop(this.pushed_rendererState)\n\t}\n}\n\n/**\n * Damped callback, that accepts the resulting damped/smooth value.\n *\n * @callback dampedCallback\n * @param {double} value - the damped/smoothed value\n *\n */\n\n/**\n *\n * DampedAction, for smoothly changing a value to zero.\n *\n * @param {dampedCallback} cb - callback that accepts the damped value as argument.\n */\nclass DampedAction {\n\t/**  @constructor */\n\tconstructor(cb) {\n\t\tthis.value = 0.0\n\t\tthis.damping = 0.85\n\t\tthis.action = cb\n\t}\n\n\t/** adds a value to the current value beeing damped.\n\t * @param {double} force - the value beeing added.\n\t */\n\taddForce(force) {\n\t\tthis.value += force\n\t}\n\n\t/** updates the damping and calls {@link damped-callback}. */\n\tupdate() {\n\t\tvar active = this.value * this.value > 0.000001\n\t\tif (active) {\n\t\t\tthis.action(this.value)\n\t\t\tthis.value *= this.damping\n\t\t} else {\n\t\t\tthis.stop()\n\t\t}\n\t\treturn active\n\t}\n\n\t/** stops the damping. */\n\tstop() {\n\t\tthis.value = 0.0\n\t}\n}\n\n/**\n * Interpolation callback, that implements any form of interpolation between\n * two values A and B and the interpolationparameter t.\n * <pre>\n *   linear: A * (1-t) + B * t\n *   smooth, etc...\n * </pre>\n * @callback interpolationCallback\n * @param {Object} A - First Value\n * @param {Object} B - Second Value\n * @param {double} t - interpolation parameter [0, 1]\n *\n */\n\n/**\n *\n * Interpolation, for smoothly changing a value by interpolating it over time.\n *\n * @param {interpolationCallback} cb - callback for interpolating between two values.\n */\nclass Interpolation {\n\t/**  @constructor */\n\tconstructor(cb) {\n\t\tthis.default_duration = 300\n\t\tthis.action = cb\n\t}\n\n\t/** starts the interpolation.\n\t *  If the given interpolation-duration is 0, then\n\t * {@link interpolation-callback} is called immediately.\n\t */\n\tstart(valA, valB, duration, actions) {\n\t\tfor (var x in actions) {\n\t\t\tactions[x].stop()\n\t\t}\n\t\tthis.valA = valA\n\t\tthis.valB = valB\n\t\tthis.duration = duration === undefined ? this.default_duration : duration\n\t\tthis.timer = new Date().getTime()\n\t\tthis.active = this.duration > 0\n\t\tif (!this.active) {\n\t\t\tthis.interpolate(1)\n\t\t}\n\t}\n\n\t/** updates the interpolation and calls {@link interpolation-callback}.*/\n\tupdate() {\n\t\tif (this.active) {\n\t\t\tvar t = (new Date().getTime() - this.timer) / this.duration\n\t\t\tif (t > 0.995) {\n\t\t\t\tthis.interpolate(1)\n\t\t\t\tthis.stop()\n\t\t\t} else {\n\t\t\t\tthis.interpolate(t)\n\t\t\t}\n\t\t}\n\t}\n\n\tinterpolate(t) {\n\t\tthis.action(this.valA, this.valB, t)\n\t}\n\n\t/** stops the interpolation. */\n\tstop() {\n\t\tthis.active = false\n\t}\n}\n\n////////////////////////////////////////////////////////////////////////////////\n//\n// ROTATION (Quaternion)\n//\n////////////////////////////////////////////////////////////////////////////////\n/**\n * Rotation as Quaternion [q0, q1, q2, q3]\n *\n * Note: Only functions that were required for the EasyCam to work are implemented.\n *\n * @namespace\n */\nvar Rotation = {\n\tassert: function (dst) {\n\t\treturn dst === undefined || dst.constructor !== Array ? [1, 0, 0, 0] : dst\n\t},\n\n\t/** @returns {Number[]} an identity rotation [1,0,0,0] */\n\tidentity: function () {\n\t\treturn [1, 0, 0, 0]\n\t},\n\n\t/**\n\t * Applies the rotation to a vector and returns dst or a new vector.\n\t *\n\t * @param {Number[]} rot - Rotation (Quaternion)\n\t * @param {Number[]} vec - vector to be rotated by rot\n\t * @param {Number[]} dst - resulting vector\n\t * @returns {Number[]} dst- resulting vector\n\t */\n\tapplyToVec3: function (rot, vec, dst) {\n\t\tvar [x, y, z] = vec\n\t\tvar [q0, q1, q2, q3] = rot\n\n\t\tvar s = q1 * x + q2 * y + q3 * z\n\n\t\tdst = Vec3.assert(dst)\n\t\tdst[0] = 2 * (q0 * (x * q0 - (q2 * z - q3 * y)) + s * q1) - x\n\t\tdst[1] = 2 * (q0 * (y * q0 - (q3 * x - q1 * z)) + s * q2) - y\n\t\tdst[2] = 2 * (q0 * (z * q0 - (q1 * y - q2 * x)) + s * q3) - z\n\t\treturn dst\n\t},\n\n\t/**\n\t * Applies the rotation to another rotation and returns dst or a new rotation.\n\t *\n\t * @param {Number[]} rotA - RotationA (Quaternion)\n\t * @param {Number[]} rotB - RotationB (Quaternion)\n\t * @param {Number[]} dst - resulting rotation\n\t * @returns {Number[]} dst - resulting rotation\n\t */\n\tapplyToRotation(rotA, rotB, dst) {\n\t\tvar [a0, a1, a2, a3] = rotA\n\t\tvar [b0, b1, b2, b3] = rotB\n\n\t\tdst = Rotation.assert(dst)\n\t\tdst[0] = b0 * a0 - (b1 * a1 + b2 * a2 + b3 * a3)\n\t\tdst[1] = b1 * a0 + b0 * a1 + (b2 * a3 - b3 * a2)\n\t\tdst[2] = b2 * a0 + b0 * a2 + (b3 * a1 - b1 * a3)\n\t\tdst[3] = b3 * a0 + b0 * a3 + (b1 * a2 - b2 * a1)\n\t\treturn dst\n\t},\n\n\t/**\n\t * Interpolates a rotation.\n\t *\n\t * @param {Number[]} rotA - RotationA (Quaternion)\n\t * @param {Number[]} rotB - RotationB (Quaternion)\n\t * @param {Number  } t - interpolation parameter\n\t * @param {Number[]} dst - resulting rotation\n\t * @returns {Number[]} dst - resulting rotation\n\t */\n\tslerp: function (rotA, rotB, t, dst) {\n\t\tvar [a0, a1, a2, a3] = rotA\n\t\tvar [b0, b1, b2, b3] = rotB\n\n\t\tvar cosTheta = a0 * b0 + a1 * b1 + a2 * b2 + a3 * b3\n\t\tif (cosTheta < 0) {\n\t\t\tb0 = -b0\n\t\t\tb1 = -b1\n\t\t\tb2 = -b2\n\t\t\tb3 = -b3\n\t\t\tcosTheta = -cosTheta\n\t\t}\n\n\t\tvar theta = Math.acos(cosTheta)\n\t\tvar sinTheta = Math.sqrt(1.0 - cosTheta * cosTheta)\n\n\t\tvar w1, w2\n\t\tif (sinTheta > 0.001) {\n\t\t\tw1 = Math.sin((1.0 - t) * theta) / sinTheta\n\t\t\tw2 = Math.sin(t * theta) / sinTheta\n\t\t} else {\n\t\t\tw1 = 1.0 - t\n\t\t\tw2 = t\n\t\t}\n\n\t\tdst = Rotation.assert(dst)\n\t\tdst[0] = w1 * a0 + w2 * b0\n\t\tdst[1] = w1 * a1 + w2 * b1\n\t\tdst[2] = w1 * a2 + w2 * b2\n\t\tdst[3] = w1 * a3 + w2 * b3\n\n\t\treturn Rotation.create({ rotation: dst, normalize: true }, dst)\n\t},\n\n\t/**\n\t * Creates/Initiates a new Rotation\n\t *\n\t * <pre>\n\t *\n\t *    1) Axis,Angle:\n\t *       {\n\t *         axis : [x, y, z],\n\t *         angle: double\n\t *       }\n\t *\n\t *    2) Another Rotation:\n\t *       {\n\t *         rotation : [q0, q1, q2, q3],\n\t *         normalize: boolean\n\t *       }\n\t *\n\t *    3) 3 euler angles, XYZ-order:\n\t *       {\n\t *         angles_xyz : [rX, rY, rZ]\n\t *       }\n\t *\n\t * </pre>\n\t *\n\t *\n\t * @param {Object} def - Definition, for creating the new Rotation\n\t * @param {Number[]} dst - resulting rotation\n\t * @returns {Number[]} dst - resulting rotation\n\t */\n\tcreate: function (def, dst) {\n\t\tdst = Rotation.assert(dst)\n\n\t\t// 1) from axis and angle\n\t\tif (def.axis) {\n\t\t\tvar axis = def.axis\n\t\t\tvar angle = def.angle\n\n\t\t\tvar norm = Vec3.mag(axis)\n\t\t\tif (norm === 0.0) return // vector is of zero length\n\n\t\t\tvar halfAngle = -0.5 * angle\n\t\t\tvar coeff = Math.sin(halfAngle) / norm\n\n\t\t\tdst[0] = Math.cos(halfAngle)\n\t\t\tdst[1] = coeff * axis[0]\n\t\t\tdst[2] = coeff * axis[1]\n\t\t\tdst[3] = coeff * axis[2]\n\t\t\treturn dst\n\t\t}\n\n\t\t// 2) from another rotation\n\t\tif (def.rotation) {\n\t\t\tdst[0] = def.rotation[0]\n\t\t\tdst[1] = def.rotation[1]\n\t\t\tdst[2] = def.rotation[2]\n\t\t\tdst[3] = def.rotation[3]\n\n\t\t\tif (def.normalize) {\n\t\t\t\tvar inv =\n\t\t\t\t\t1.0 / Math.sqrt(dst[0] * dst[0] + dst[1] * dst[1] + dst[2] * dst[2] + dst[3] * dst[3])\n\t\t\t\tdst[0] *= inv\n\t\t\t\tdst[1] *= inv\n\t\t\t\tdst[2] *= inv\n\t\t\t\tdst[3] *= inv\n\t\t\t}\n\n\t\t\treturn dst\n\t\t}\n\n\t\t// 3) from 3 euler angles, order XYZ\n\t\tif (def.angles_xyz) {\n\t\t\tvar ax = -0.5 * def.angles_xyz[0]\n\t\t\tvar ay = -0.5 * def.angles_xyz[1]\n\t\t\tvar az = -0.5 * def.angles_xyz[2]\n\n\t\t\tvar rotX = [Math.cos(ax), Math.sin(ax), 0, 0]\n\t\t\tvar rotY = [Math.cos(ay), 0, Math.sin(ay), 0]\n\t\t\tvar rotZ = [Math.cos(az), 0, 0, Math.sin(az)]\n\n\t\t\tRotation.applyToRotation(rotY, rotZ, dst)\n\t\t\tRotation.applyToRotation(rotX, dst, dst)\n\n\t\t\treturn dst\n\t\t}\n\t},\n\n\t//\n\t// ... to be continued ...\n\t//\n}\n\n////////////////////////////////////////////////////////////////////////////////\n//\n// SCALAR\n//\n////////////////////////////////////////////////////////////////////////////////\n/**\n * Scalar as a simple number.\n *\n * Note: Only functions that were required for the EasyCam to work are implemented.\n *\n * @namespace\n */\nvar Scalar = {\n\t/**\n\t * Linear interpolation between A and B using t[0,1]\n\t */\n\tmix: function (a, b, t) {\n\t\treturn a * (1 - t) + b * t\n\t},\n\n\t/**\n\t * modifying t as a function of smoothstep(0,1,t);\n\t */\n\tsmoothstep: function (x) {\n\t\treturn x * x * (3 - 2 * x)\n\t},\n\n\t/**\n\t * modifying t as a function of smootherstep(0,1,t);\n\t */\n\tsmootherstep: function (x) {\n\t\treturn x * x * x * (x * (x * 6 - 15) + 10)\n\t},\n}\n\n////////////////////////////////////////////////////////////////////////////////\n//\n// VEC3\n//\n////////////////////////////////////////////////////////////////////////////////\n/**\n * Vec3 as a 3D vector (Array)\n *\n * @namespace\n */\nvar Vec3 = {\n\tassert: function (dst) {\n\t\treturn dst === undefined || dst.constructor !== Array ? [0, 0, 0] : dst\n\t},\n\n\tisScalar: function (arg) {\n\t\t// TODO: do some profiling to figure out what fails\n\t\treturn arg !== undefined && arg.constructor !== Array\n\t\t// return typeof(arg) === 'number';\n\t},\n\n\t/** addition: <pre> dst = a + b </pre>  */\n\tadd: function (a, b, dst) {\n\t\tdst = this.assert(dst)\n\t\tif (this.isScalar(b)) {\n\t\t\tdst[0] = a[0] + b\n\t\t\tdst[1] = a[1] + b\n\t\t\tdst[2] = a[2] + b\n\t\t} else {\n\t\t\tdst[0] = a[0] + b[0]\n\t\t\tdst[1] = a[1] + b[1]\n\t\t\tdst[2] = a[2] + b[2]\n\t\t}\n\t\treturn dst\n\t},\n\n\t/** componentwise multiplication: <pre> dst = a * b </pre>  */\n\tmult: function (a, b, dst) {\n\t\tdst = this.assert(dst)\n\t\tif (this.isScalar(b)) {\n\t\t\tdst[0] = a[0] * b\n\t\t\tdst[1] = a[1] * b\n\t\t\tdst[2] = a[2] * b\n\t\t} else {\n\t\t\tdst[0] = a[0] * b[0]\n\t\t\tdst[1] = a[1] * b[1]\n\t\t\tdst[2] = a[2] * b[2]\n\t\t}\n\t\treturn dst\n\t},\n\n\t/** squared length  */\n\tmagSq: function (a) {\n\t\treturn a[0] * a[0] + a[1] * a[1] + a[2] * a[2]\n\t},\n\n\t/** length  */\n\tmag: function (a) {\n\t\treturn Math.sqrt(a[0] * a[0] + a[1] * a[1] + a[2] * a[2])\n\t},\n\n\t/** dot-product  */\n\tdot: function (a, b) {\n\t\treturn a[0] * b[0] + a[1] * b[1] + a[2] * b[2]\n\t},\n\n\t/** cross-product  */\n\tcross: function (a, b, dst) {\n\t\tdst = this.assert(dst)\n\t\tdst[0] = a[1] * b[2] - a[2] * b[1]\n\t\tdst[1] = a[2] * b[0] - a[0] * b[2]\n\t\tdst[2] = a[0] * b[1] - a[1] * b[0]\n\t\treturn dst\n\t},\n\n\t/** angle  */\n\tangle: function (v1, v2) {\n\t\tvar normProduct = this.mag(v1) * this.mag(v2)\n\t\tif (normProduct === 0.0) {\n\t\t\treturn 0.0 // at least one vector is of zero length\n\t\t}\n\n\t\tvar dot = this.dot(v1, v2)\n\t\tvar threshold = normProduct * 0.9999\n\t\tif (dot < -threshold || dot > threshold) {\n\t\t\t// the vectors are almost aligned, compute using the sine\n\t\t\tvar v3 = this.cross(v1, v2)\n\t\t\tif (dot >= 0) {\n\t\t\t\treturn Math.asin(this.mag(v3) / normProduct)\n\t\t\t} else {\n\t\t\t\treturn Math.PI - Math.asin(this.mag(v3) / normProduct)\n\t\t\t}\n\t\t}\n\n\t\t// the vectors are sufficiently separated to use the cosine\n\t\treturn Math.acos(dot / normProduct)\n\t},\n\n\t/** linear interpolation: <pre> dst = a * (1 - t) + b * t </pre> */\n\tmix(a, b, t, dst) {\n\t\tdst = this.assert(dst)\n\t\tdst[0] = Scalar.mix(a[0], b[0], t)\n\t\tdst[1] = Scalar.mix(a[1], b[1], t)\n\t\tdst[2] = Scalar.mix(a[2], b[2], t)\n\t\treturn dst\n\t},\n\n\t//\n\t// ... to be continued ...\n\t//\n}\n\n////////////////////////////////////////////////////////////////////////////////\n//\n// public objects\n//\n////////////////////////////////////////////////////////////////////////////////\n\n/**\n * @static\n */\nEasyCam.INFO = INFO // make static\nObject.freeze(INFO) // and constant\n\n// ext = (ext !== undefined) ? ext : {};\n\n/**\n * @memberof Dw\n */\next.EasyCam = EasyCam\n/**\n * @memberof Dw\n */\next.DampedAction = DampedAction\n/**\n * @memberof Dw\n */\next.Interpolation = Interpolation\n/**\n * @memberof Dw\n */\next.Rotation = Rotation\n/**\n * @memberof Dw\n */\next.Vec3 = Vec3\n/**\n * @memberof Dw\n */\next.Scalar = Scalar\n\n// return ext;\n//\n//\n// })(Dw);\n\n// export const { DampedAction, Interpolation, Rotation, Vec3, Scalar } = ext\nexport default ext\n\n// /**\n//  * @submodule Camera\n//  * @for p5\n//  */\n//\n// if(p5){\n//\n//\n//   /**\n//    * p5.EasyCam creator function.\n//    * Arguments are optional, and equal to the default EasyCam constructor.\n//    * @return {EasyCam} a new EasyCam\n//    */\n//   p5.prototype.createEasyCam = function(/* p5.RendererGL, {state} */){\n//\n//     var renderer = this._renderer;\n//     var args     = arguments[0];\n//\n//     if(arguments[0] instanceof p5.RendererGL){\n//       renderer = arguments[0];\n//       args     = arguments[1]; // could still be undefined, which is fine\n//     }\n//\n//     return new Dw.EasyCam(renderer, args);\n//   }\n// }\n","import * as p5 from 'p5'\nimport { KEYCODE_CONTROL } from './constants'\nimport { sketch } from './Sketch'\nimport { clockUpdateReq, ClockOpts } from './serverApi/serverClock'\n\nconst userInputsY = 40\n\nfunction prettyUnit(unit: string, val: number, coarse = false) {\n\tlet uu = unit\n\tlet vv = val\n\tconst thresh = coarse ? 0.1 : 1\n\tif (vv < thresh) {\n\t\tvv *= 1000\n\t\tuu = `m${unit}`\n\t}\n\tif (vv < thresh) {\n\t\tvv *= 1000\n\t\tuu = `µ${unit}`\n\t}\n\tconst dec = vv >= 10 ? 0 : vv >= 1 ? 1 : 2\n\treturn `${vv.toFixed(dec)}${uu}`\n}\n\nexport class SketchInputs {\n\tpp?: p5\n\tnameCustomized = false\n\tinputs: {\n\t\t// DOM input elements\n\t\tname?: any\n\t\tinstrument?: any\n\t\tinputDevice?: any\n\t\tlatency?: any\n\t\tbpm?: any\n\t\thide?: any\n\t\thideLoops?: any\n\t\t// hideDial?: any\n\t\thideLabels?: any\n\t\tshowHelp?: any\n\t} = {}\n\thidden = false\n\thiddenLabels = false\n\tclockOpts: ClockOpts = {\n\t\tbpm: 95,\n\t}\n\thelp = false\n\thelpRetoggle = {\n\t\tloops: true,\n\t\tdial: true,\n\t}\n\thelpImg?: p5.Image\n\tpingBeats = 0 // number of beats it takes for a round-trip message to/from the server\n\n\tconstructor(loadedFromStorage = false) {\n\t\tthis.nameCustomized = loadedFromStorage\n\t}\n\n\tbpm = () => (this.inputs.bpm ? this.inputs.bpm.value() : this.clockOpts.bpm)\n\n\tisFocused = () => {\n\t\tfor (const key in this.inputs) {\n\t\t\tconst input = (this.inputs as any)[key]\n\t\t\tif (input && input.focused) {\n\t\t\t\treturn true\n\t\t\t}\n\t\t}\n\t\treturn false\n\t}\n\n\ttoggleHide = () => {\n\t\tif (!this.pp) {\n\t\t\treturn\n\t\t}\n\t\tthis.hidden = !this.hidden\n\t\tthis.setup(this.pp)\n\t\tif (!this.hidden) {\n\t\t\tthis.setupInputsBPM()\n\t\t}\n\t}\n\n\ttoggleHelp = () => {\n\t\tif (!this.pp) {\n\t\t\treturn\n\t\t}\n\t\tconst { loops } = sketch\n\t\tthis.help = !this.help\n\t\tif (this.help) {\n\t\t\tthis.helpRetoggle.loops = !loops.hidden\n\t\t\tthis.helpRetoggle.dial = !loops.hiddenDial\n\t\t}\n\t\tif (this.helpRetoggle.loops) {\n\t\t\tloops.toggleHide()\n\t\t}\n\t\tif (this.helpRetoggle.dial) {\n\t\t\tloops.toggleHideDial()\n\t\t}\n\t\tthis.setup(this.pp)\n\t\tif (!this.help && !this.hidden) {\n\t\t\tthis.setupInputsBPM()\n\t\t}\n\t}\n\n\tsetup = (pp: p5) => {\n\t\tthis.pp = pp\n\t\tif (!this.helpImg) {\n\t\t\tthis.helpImg = pp.loadImage('/help-overlay.png')\n\t\t}\n\t\tif (this.hidden || this.help) {\n\t\t\tfor (const key in this.inputs) {\n\t\t\t\tconst input = (this.inputs as any)[key]\n\t\t\t\tif (!input) {\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\t\t\t\tinput.remove()\n\t\t\t\tdelete (this.inputs as any)[key]\n\t\t\t}\n\t\t\tthis.setupInputsHide(this.pp)\n\t\t\treturn\n\t\t}\n\t\tthis.setupInputsUser(sketch.ws.clientId)\n\t\tthis.setupInputsInstrument()\n\t\t// // setupInputsMidi is commented out because the inputDevice does nothing right now\n\t\t// // (it's disabled in Sketch.sendUserEvent because it's easier to dev if all inputs are handled)\n\t\t// if (!this.inputs.inputDevice) {\n\t\t// \tthis.setupInputsMidi(sketch.midi.webMidi)\n\t\t// }\n\t\tthis.setupInputsHide(pp)\n\t}\n\n\tsetupInputsHide = (pp: p5) => {\n\t\tif (this.inputs.hide) {\n\t\t\tthis.inputs.hide.remove()\n\t\t}\n\t\tif (this.inputs.hideLoops) {\n\t\t\tthis.inputs.hideLoops.remove()\n\t\t}\n\t\t// if (this.inputs.hideDial) {\n\t\t// \tthis.inputs.hideDial.remove()\n\t\t// }\n\t\tif (this.inputs.hideLabels) {\n\t\t\tthis.inputs.hideLabels.remove()\n\t\t}\n\t\tif (this.inputs.showHelp) {\n\t\t\tthis.inputs.showHelp.remove()\n\t\t}\n\t\tconst { loops } = sketch\n\t\tthis.inputs.showHelp = pp.createButton(this.help ? 'Hide Help' : 'Show Help') as any\n\t\tconst { showHelp } = this.inputs\n\t\tlet xx = pp.width - showHelp.width - 50\n\t\tconst yy = pp.height - showHelp.height - 10\n\t\tshowHelp.position(xx, yy)\n\t\tshowHelp.mousePressed(this.toggleHelp)\n\t\tif (this.help) {\n\t\t\treturn\n\t\t}\n\t\txx -= 100\n\t\tthis.inputs.hide = pp.createButton(this.hidden ? 'Show Settings' : 'Hide Settings') as any\n\t\tthis.inputs.hideLoops = pp.createButton(loops.toggleHideText()) as any\n\t\t// this.inputs.hideDial = pp.createButton(loops.toggleHideDialText()) as any\n\t\tthis.inputs.hideLabels = pp.createButton(this.hiddenLabels ? 'Show Names' : 'Hide Names') as any\n\t\tconst { hide, hideLoops, /* hideDial, */ hideLabels } = this.inputs\n\t\thideLoops.position(xx, yy)\n\t\thideLoops.mousePressed(() => {\n\t\t\tloops.toggleHideDial()\n\t\t\tloops.toggleHide()\n\t\t\thideLoops.elt.innerHTML = loops.toggleHideText()\n\t\t})\n\t\txx -= 105\n\t\t// hideDial.position(xx, yy)\n\t\t// hideDial.mousePressed(() => {\n\t\t// \tloops.toggleHideDial()\n\t\t// \thideDial.elt.innerHTML = loops.toggleHideDialText()\n\t\t// })\n\t\thideLabels.position(xx, yy)\n\t\thideLabels.mousePressed(() => {\n\t\t\tthis.hiddenLabels = !this.hiddenLabels\n\t\t\thideLabels.elt.innerHTML = this.hiddenLabels ? 'Show Names' : 'Hide Names'\n\t\t})\n\t\txx -= 110\n\t\thide.position(xx, yy)\n\t\thide.mousePressed(this.toggleHide)\n\t}\n\n\tsetupInputsUser = (clientId: number): any => {\n\t\tconst uu = sketch.user\n\t\tconst defaultName = this.nameCustomized ? uu.name : `User ${sketch.ws.clientId}`\n\t\tif (this.hidden) {\n\t\t\tif (uu.name === '') {\n\t\t\t\tsketch.updateUser({ name: defaultName })\n\t\t\t}\n\t\t\treturn\n\t\t}\n\t\tif (!this.pp) {\n\t\t\tconsole.log(\n\t\t\t\t'[SketchInputs #setupInputsUser] Attempted to setup user input before sketch was initialized',\n\t\t\t)\n\t\t\treturn\n\t\t}\n\t\tif (this.inputs.name) {\n\t\t\tthis.inputs.name.remove()\n\t\t}\n\t\tif (this.inputs.latency) {\n\t\t\tthis.inputs.latency.remove()\n\t\t}\n\t\tthis.inputs.name = this.pp.createInput(defaultName) as any\n\t\tthis.inputs.latency = this.pp.createInput(`${sketch.user.offset}`) as any\n\t\tconst { name: inName, latency: inLatency } = this.inputs\n\t\tinName.size(80)\n\t\tinName.position(20, userInputsY)\n\t\tinName.input(() => {\n\t\t\t// console.log('[SketchInputs #inputs.name] Changed:', inName.value())\n\t\t\tthis.nameCustomized = true\n\t\t\tsketch.updateUser({ name: inName.value() })\n\t\t})\n\t\tinName.elt.onfocus = () => (inName.focused = true)\n\t\tinName.elt.onblur = () => (inName.focused = false)\n\t\t// // Uncomment to select name field on load:\n\t\t// inName.elt.focus()\n\t\t// inName.elt.select()\n\t\tsketch.updateUser({ name: inName.value() }, false)\n\n\t\tinLatency.size(50)\n\t\tinLatency.position(inName.x + inName.width + 10, userInputsY)\n\t\tconst setLatency = () => {\n\t\t\tconst lat = parseFloat(inLatency.value())\n\t\t\tif (!Number.isNaN(lat)) {\n\t\t\t\tsketch.updateUser({ offset: lat })\n\t\t\t\tsketch.loops.updateRecOffset(lat)\n\t\t\t}\n\t\t}\n\t\tinLatency.input(() => {\n\t\t\tconsole.log('[SketchInputs #inputs.latency] Changed:', inLatency.value())\n\t\t\tsetLatency()\n\t\t})\n\t\tinLatency.elt.onfocus = () => (inLatency.focused = true)\n\t\tinLatency.elt.onblur = () => (inLatency.focused = false)\n\t\tsetLatency()\n\t}\n\n\tsetupInputsInstrument = () => {\n\t\tif (!this.pp || !this.inputs.latency || this.hidden) {\n\t\t\treturn\n\t\t}\n\t\tif (this.inputs.instrument) {\n\t\t\tthis.inputs.instrument.remove()\n\t\t}\n\t\tconst inInst = this.pp.createSelect() as any\n\t\tinInst.position(this.inputs.latency.x + this.inputs.latency.width + 10, userInputsY)\n\t\tconst uinst = sketch.user.instrument\n\t\tinInst.size(130)\n\t\tfor (const instName in sketch.instruments) {\n\t\t\tinInst.option(instName)\n\t\t\tif (instName === uinst) {\n\t\t\t\tinInst.selected(instName)\n\t\t\t}\n\t\t}\n\t\tinInst.changed(() => {\n\t\t\tsketch.updateUser({ instrument: inInst.value() })\n\t\t})\n\t\tinInst.elt.onfocus = () => (inInst.focused = true)\n\t\tinInst.elt.onblur = () => (inInst.focused = false)\n\t\tthis.inputs.instrument = inInst\n\t\tsketch.updateUser({ instrument: inInst.value() }, false)\n\t}\n\n\tsetupInputsMidi = (webMidi: any) => {\n\t\tif (!this.pp || !this.inputs.instrument || this.hidden) {\n\t\t\treturn\n\t\t}\n\t\tif (this.inputs.inputDevice) {\n\t\t\tthis.inputs.inputDevice.remove()\n\t\t}\n\t\tconst { inputs } = webMidi || { inputs: [] }\n\t\tconst inMidi = this.pp.createSelect() as any\n\t\tconst inInst = this.inputs.instrument\n\t\tinMidi.position(inInst.x + inInst.width + 10, userInputsY)\n\t\tinMidi.option('keyboard')\n\t\tfor (const input of inputs) {\n\t\t\tconst { _midiInput } = input\n\t\t\tif (!_midiInput) {\n\t\t\t\tconsole.error('[SketchInputs #setupInputsMidi] Received a midi input with missing data')\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tinMidi.option(_midiInput.name)\n\t\t}\n\t\tinMidi.selected(sketch.user.inputDevice)\n\t\tinMidi.changed(() => {\n\t\t\tsketch.updateUser({ inputDevice: inMidi.value() })\n\t\t})\n\t\tinMidi.elt.onfocus = () => (inMidi.focused = true)\n\t\tinMidi.elt.onblur = () => (inMidi.focused = false)\n\t\tthis.inputs.inputDevice = inMidi\n\t\tsketch.updateUser({ inputDevice: inMidi.value() }, false)\n\t}\n\n\tsetupInputsBPM = () => {\n\t\tif (!this.pp || this.hidden) {\n\t\t\treturn\n\t\t}\n\t\tif (this.inputs.bpm) {\n\t\t\tthis.inputs.bpm.remove()\n\t\t}\n\t\tconst inBPM = this.pp.createSlider(30, 200, this.clockOpts.bpm) as any\n\t\tinBPM.position(20, this.pp.height - 40)\n\t\tinBPM.size(300)\n\t\tinBPM.input(() => {\n\t\t\tthis.clockOpts.bpm = inBPM.value()\n\t\t\tthis.clockOpts.clientId = sketch.user.clientId\n\t\t\tthis.sendClockUpdate(this.clockOpts)\n\t\t})\n\t\tinBPM.elt.onfocus = () => (inBPM.focused = true)\n\t\tinBPM.elt.onblur = () => (inBPM.focused = false)\n\t\tthis.inputs.bpm = inBPM\n\t}\n\n\tdraw = (pp: p5) => {\n\t\tif (this.help) {\n\t\t\tthis.drawHelp(pp)\n\t\t\treturn\n\t\t}\n\t\tif (this.hidden) {\n\t\t\treturn\n\t\t}\n\t\t// Draw labels for inputs\n\t\tthis.drawClockStats(pp)\n\t\tpp.textSize(12).textAlign(pp.LEFT, pp.BOTTOM).textStyle(pp.BOLD)\n\t\tpp.fill(255).strokeWeight(1).stroke(0)\n\t\tfor (const key in this.inputs) {\n\t\t\tconst input = (this.inputs as any)[key]\n\t\t\tif (!input) {\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tconst xx = input.x + 3\n\t\t\tconst yy = input.y - 5\n\t\t\tswitch (true) {\n\t\t\t\tcase key === 'hide':\n\t\t\t\tcase key === 'hideLoops':\n\t\t\t\tcase key === 'hideDial':\n\t\t\t\tcase key === 'hideLabels':\n\t\t\t\tcase key === 'showHelp':\n\t\t\t\t\tcontinue\n\t\t\t\tcase key === 'latency':\n\t\t\t\t\tpp.push()\n\t\t\t\t\tconst lat = parseFloat(input.value())\n\t\t\t\t\tlet msg = ``\n\t\t\t\t\tif (Number.isNaN(lat)) {\n\t\t\t\t\t\t// Show the user that they have an invalid value\n\t\t\t\t\t\tpp.fill(255, 40, 40)\n\t\t\t\t\t\tmsg = ` (NaN!)`\n\t\t\t\t\t} else if (this.pingBeats > lat / 2) {\n\t\t\t\t\t\t// Warn user that latency is less than half of ping\n\t\t\t\t\t\tpp.fill(255, 128, 0)\n\t\t\t\t\t\tmsg = ` (check ping)`\n\t\t\t\t\t}\n\t\t\t\t\tpp.text(`${key.toUpperCase()}${msg}${'\\n'}in beats`, xx, yy)\n\t\t\t\t\tpp.pop()\n\t\t\t\t\tbreak\n\t\t\t\tcase key in sketch.user:\n\t\t\t\t\tpp.text(key.toUpperCase(), xx, yy)\n\t\t\t\t\tbreak\n\t\t\t\tdefault:\n\t\t\t\t\tpp.text(`${key.toUpperCase()}: ${input.value()}`, xx, yy)\n\t\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t}\n\n\tdrawClockStats = (pp: p5) => {\n\t\tpp.push()\n\t\tpp.colorMode(pp.HSL, 1)\n\t\tconst ppLabel = () => pp.fill(0, 0, 0.7).textAlign(pp.RIGHT, pp.BOTTOM)\n\t\tconst ppValue = (warn: boolean) =>\n\t\t\tpp.textAlign(pp.LEFT, pp.BOTTOM).fill(0, warn ? 1 : 0, warn ? 0.65 : 0.85)\n\t\tconst beatMs = sketch.beatMs()\n\t\tconst xx = 20,\n\t\t\txc = xx + 60 // x pos for colon in aligned '<label>: <value>' rows\n\t\tlet yy = pp.height - 140\n\t\t// draw heading\n\t\tpp.fill(0.58, 0.8, 0.65).strokeWeight(1).stroke(0)\n\t\tpp.textAlign(pp.LEFT, pp.BOTTOM).textSize(13).textStyle(pp.BOLD)\n\t\tpp.text(`Clock stats (B = beat = ${prettyUnit('s', beatMs / 1000)})`, xx, yy)\n\t\tpp.textSize(12).strokeWeight(1)\n\t\tyy += 20\n\t\tif (!sketch.ws.ready()) {\n\t\t\tppValue(true).text(`NO CONNECTION TO SERVER`, xx, yy)\n\t\t\tpp.pop()\n\t\t\treturn\n\t\t}\n\t\t// draw precision and ping stats\n\t\tconst { offset: latency } = sketch.user\n\t\tconst { precisionNow, pingMs } = sketch.ws.clock\n\t\tthis.pingBeats = pingMs / beatMs\n\t\tconst prec = Math.abs(precisionNow)\n\t\tconst precStr = `${prettyUnit('s', prec / 1000)} (${prettyUnit('B', prec / beatMs, true)})`\n\t\tconst pingStr = `${prettyUnit('s', pingMs / 1000)} (${prettyUnit('B', this.pingBeats, true)})`\n\t\tppLabel().text(`precision:`, xc, yy)\n\t\tppValue(prec / beatMs >= 1.0 / 32) // warn if clock precision is worse than 128th note\n\t\t\t.text(precStr, xc + 5, yy)\n\t\tyy += 20\n\t\tppLabel().text(`ping:`, xc, yy)\n\t\tppValue(this.pingBeats > latency / 2) // warn if ping is close to latency value\n\t\t\t.text(pingStr, xc + 5, yy)\n\t\tpp.pop()\n\t}\n\n\tdrawHelp = (pp: p5) => {\n\t\tif (!this.helpImg) {\n\t\t\treturn\n\t\t}\n\t\tconst haspect = this.helpImg.height / this.helpImg.width\n\t\tconst hx = 40\n\t\tconst ww = pp.width - hx * 2\n\t\tconst hh = haspect * ww\n\t\tconst hy = (pp.height - hh) / 2\n\t\tpp.background(60, 220)\n\t\tpp.image(this.helpImg, hx, hy, ww, hh)\n\t}\n\n\tsendClockUpdate = (clk: ClockOpts) => {\n\t\tconst { conn, ready } = sketch.ws\n\t\tif (!ready()) {\n\t\t\tconsole.warn(\n\t\t\t\t\"[SketchInputs #sendClockUpdate] Can't send bpm update, websocket connection is not open\",\n\t\t\t)\n\t\t\treturn\n\t\t}\n\t\tconn.send(clockUpdateReq(clk))\n\t}\n\n\tonClockUpdate = (clk: ClockOpts) => {\n\t\tthis.clockOpts = clk\n\t\tif (!this.inputs.bpm) {\n\t\t\treturn\n\t\t}\n\t\tthis.inputs.bpm.value(clk.bpm)\n\t}\n\n\tkeyPressed = (evt: p5) => {\n\t\tif (evt.keyIsDown(KEYCODE_CONTROL)) {\n\t\t\treturn\n\t\t}\n\t\tlet prev: boolean\n\t\tswitch (evt.key) {\n\t\t\tcase 'c':\n\t\t\t\tprev = true\n\t\t\t\tbreak\n\t\t\tcase 'v':\n\t\t\t\tprev = false\n\t\t\t\tbreak\n\t\t\tdefault:\n\t\t\t\treturn\n\t\t}\n\t\tconst uinst = sketch.user.instrument\n\t\tconst keys = Object.keys(sketch.instruments)\n\t\tfor (let ii = 0; ii < keys.length; ii++) {\n\t\t\tconst iname = keys[ii]\n\t\t\tif (iname !== uinst) {\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tlet switchTo: string\n\t\t\tif (prev) {\n\t\t\t\tif (ii === 0) {\n\t\t\t\t\tswitchTo = keys[keys.length - 1]\n\t\t\t\t} else {\n\t\t\t\t\tswitchTo = keys[ii - 1]\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (ii === keys.length - 1) {\n\t\t\t\t\tswitchTo = keys[0]\n\t\t\t\t} else {\n\t\t\t\t\tswitchTo = keys[ii + 1]\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (this.inputs.instrument) {\n\t\t\t\tthis.inputs.instrument.selected(switchTo)\n\t\t\t}\n\t\t\tsketch.updateUser({ instrument: switchTo })\n\t\t\treturn\n\t\t}\n\t}\n}\n","import AudioKeys from 'audiokeys'\nimport Sketch from './Sketch'\nimport { MidiEvent } from './MIDI'\nimport { KEYCODE_CONTROL } from './constants'\n\ntype AudioKeysEvent = {\n\t// the midi number of the note\n\tnote: number\n\t// the keyCode of the key being pressed down\n\tkeyCode: number\n\t// the frequency of the note\n\tfrequency: number\n\t// on note down: the current velocity (this can only be set when rows = 1)\n\t// on note up: 0\n\tvelocity: number\n}\n\nexport class SketchAudioKeys {\n\tsketch: Sketch\n\taudioKeys: AudioKeys\n\n\tconstructor(sketch: Sketch) {\n\t\tthis.sketch = sketch\n\t\tthis.audioKeys = new AudioKeys({ polyphony: Infinity, velocity: 95 })\n\t\tthis.audioKeys.down(this.keyPressed)\n\t\tthis.audioKeys.up(this.keyReleased)\n\t}\n\n\tkeyPressed = (evt: AudioKeysEvent) => {\n\t\tconst { note, velocity } = evt\n\t\tif (this.sketch.keyboardInputDisabled()) {\n\t\t\treturn\n\t\t}\n\t\tconst { pp } = this.sketch\n\t\tif (pp && pp.keyIsDown(KEYCODE_CONTROL)) {\n\t\t\treturn\n\t\t}\n\t\tif (this.sketch.user.inputDevice !== 'keyboard') {\n\t\t\treturn\n\t\t}\n\t\tconst midiEvt = { kind: 'noteon', note: note, attack: velocity / 128.0 } as MidiEvent\n\t\tthis.sketch.sendUserEvent('keyboard', 'noteon', midiEvt)\n\t}\n\n\tkeyReleased = (evt: AudioKeysEvent) => {\n\t\tconst { note } = evt\n\t\tif (this.sketch.keyboardInputDisabled()) {\n\t\t\treturn\n\t\t}\n\t\tif (this.sketch.user.inputDevice !== 'keyboard') {\n\t\t\treturn\n\t\t}\n\t\tconst midiEvt = { kind: 'noteoff', note: note } as MidiEvent\n\t\tthis.sketch.sendUserEvent('keyboard', 'noteoff', midiEvt)\n\t}\n}\n","import * as p5 from 'p5'\nimport { v4 as uuid } from 'uuid'\nimport { UserEvent } from './serverApi/serverApi'\nimport { sketch } from './Sketch'\nimport { BLACK_KEYS } from './constants'\nimport { ctrlColor } from './util'\n\nexport const radBig = 50\nexport const radSmall = 35\n\ntype LoopEvent = {\n\tevt: UserEvent\n\tloopTime: number // normalized 0-1 to loop duration\n\trelease?: LoopEvent // reference to release for attack events\n}\n\nexport type LoopData = {\n\tid: string\n\tbeats: number\n\tevts: LoopEvent[]\n\tisMuted: boolean\n}\n\nexport type LoopOpts = {\n\tid?: string\n\tbeats: number\n\tradius: number\n\tisDial?: boolean\n}\n\nexport class Loop {\n\txx = 0\n\tyy = 0\n\theadPlay = 0\n\theadRec = 0\n\tisActive = false\n\tisDial = false\n\tisRecording = false\n\tloaded = false\n\tpgControls?: p5.Graphics\n\tpgNotes?: p5.Graphics\n\tneedsRenderControls = false\n\tneedsRenderNotes = false\n\t// data: LoopData // TODO: replace props below with this data prop\n\topts: LoopOpts\n\tid: string\n\tevts: LoopEvent[] = []\n\tisMuted = false\n\n\tconstructor(opts: LoopOpts) {\n\t\tthis.opts = opts\n\t\tif (opts.id) {\n\t\t\tthis.id = opts.id\n\t\t\tif (this.load()) {\n\t\t\t\tconsole.log(`[Loop #ctor] Loaded loop ${opts.id} from local storage`)\n\t\t\t\tthis.needsRenderControls = true\n\t\t\t\tthis.needsRenderNotes = true\n\t\t\t\treturn // loaded loop from local storage\n\t\t\t} else {\n\t\t\t\tconsole.error(`[Loop #ctor] Failed to load loop ${opts.id} from local storage`)\n\t\t\t}\n\t\t} else {\n\t\t\tthis.id = uuid()\n\t\t}\n\t\tif (opts.isDial) {\n\t\t\tthis.isDial = true\n\t\t} else {\n\t\t\tthis.isActive = true\n\t\t}\n\t}\n\n\tsave = () => {\n\t\tsketch.localStorage.setItem(this.id, JSON.stringify(this.data()))\n\t}\n\n\tload = () => {\n\t\tconst { id } = this\n\t\tconst dataStr = sketch.localStorage.getItem(id)\n\t\tif (!dataStr || dataStr === '') {\n\t\t\tthis.loaded = false\n\t\t\treturn false\n\t\t}\n\t\tthis.loadData(JSON.parse(dataStr) as LoopData)\n\t\treturn true\n\t}\n\n\tremove = () => {\n\t\tlocalStorage.removeItem(this.id)\n\t}\n\n\tdata = (): LoopData => {\n\t\tconst { id, isMuted, evts, opts } = this\n\t\tconst { beats } = opts\n\t\treturn { id, beats, evts, isMuted }\n\t}\n\n\tloadData = (data: LoopData) => {\n\t\tthis.id = data.id\n\t\tthis.isMuted = data.isMuted\n\t\tthis.evts = data.evts\n\t\tthis.evts.forEach(le => (le.evt.timestamp = 0))\n\t\tthis.opts.beats = data.beats\n\t\tthis.needsRenderControls = true\n\t\tthis.needsRenderNotes = true\n\t\tthis.loaded = true\n\t}\n\n\tsetRadius = (rad: number) => {\n\t\tif (rad === this.opts.radius) {\n\t\t\treturn\n\t\t}\n\t\tthis.opts.radius = rad\n\t\t// redraw notes and controls\n\t\tif (this.pgControls) {\n\t\t\tthis.needsRenderControls = true\n\t\t}\n\t\tif (this.pgNotes) {\n\t\t\tthis.needsRenderNotes = true\n\t\t}\n\t}\n\n\tloopLenMs = () => this.opts.beats * sketch.beatMs()\n\n\tloopUserEvent = (evt: UserEvent) => {\n\t\tconst recOff = sketch.offsetMs()\n\t\tconst now = sketch.nowMs()\n\t\tconst loopTime = this.timeGlobalToLoopNorm(now + recOff)\n\t\tconst levt = {\n\t\t\tevt,\n\t\t\tloopTime,\n\t\t}\n\t\tconst { kind, note } = evt.midiEvent\n\t\tif (kind === 'noteoff') {\n\t\t\t// Attach event to the associated noteon event\n\t\t\tconst attacks = this.filterNote(this.attackEvents(), note)\n\t\t\tlet attackEvt: LoopEvent | null = null\n\t\t\tlet minDiff = 1\n\t\t\tconst relTime = loopTime + 1\n\t\t\tfor (const ae of attacks) {\n\t\t\t\tlet attTime = ae.loopTime > loopTime ? ae.loopTime : ae.loopTime + 1\n\t\t\t\tconst diff = relTime - attTime\n\t\t\t\tif (diff < minDiff) {\n\t\t\t\t\tminDiff = diff\n\t\t\t\t\tattackEvt = ae\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (attackEvt) {\n\t\t\t\tattackEvt.release = levt\n\t\t\t} else {\n\t\t\t\tconsole.warn('[Loop #loopUserEvent] No attack event found for release', levt)\n\t\t\t}\n\t\t\tthis.needsRenderNotes = true\n\t\t\treturn\n\t\t}\n\t\tif (kind === 'controlchange' || kind === 'pitchbend') {\n\t\t\tthis.needsRenderControls = true\n\t\t}\n\t\tif (kind === 'noteon' || kind === 'noteoff') {\n\t\t\tthis.needsRenderNotes = true\n\t\t}\n\t\tthis.evts.push(levt)\n\t}\n\n\tsanitizeEvents = () => {\n\t\t// Remove any attacks that don't have releases\n\t\tthis.evts = this.evts.filter(ee => ee.evt.midiEvent.kind !== 'noteon' || ee.release)\n\t}\n\n\tupdateClientId = (clientId: number) => {\n\t\tfor (const le of this.evts) {\n\t\t\tle.evt.clientId = clientId\n\t\t\tif (le.release) {\n\t\t\t\tle.release.evt.clientId = clientId\n\t\t\t}\n\t\t}\n\t}\n\n\tattackEvents = () => this.evts.filter(ee => ee.evt.midiEvent.kind === 'noteon')\n\treleaseEvents = () => this.evts.filter(ee => ee.evt.midiEvent.kind === 'noteoff')\n\tcontrolEvents = () =>\n\t\tthis.evts.filter(\n\t\t\tee => ee.evt.midiEvent.kind === 'controlchange' || ee.evt.midiEvent.kind === 'pitchbend',\n\t\t)\n\tsortByLoopTime = (evts: LoopEvent[]) =>\n\t\tevts.sort((aa: LoopEvent, bb: LoopEvent) => (aa.loopTime > bb.loopTime ? 1 : -1))\n\tgroupByController = (evts: LoopEvent[]) => {\n\t\tconst resp: { [key: number]: LoopEvent[] } = {}\n\t\tfor (const le of evts) {\n\t\t\tconst { controller } = le.evt.midiEvent\n\t\t\tconst ctrl = controller ? controller.number : 0\n\t\t\tif (!resp[ctrl]) {\n\t\t\t\tresp[ctrl] = []\n\t\t\t}\n\t\t\tresp[ctrl].push(le)\n\t\t}\n\t\treturn resp\n\t}\n\tfilterNote = (evts: LoopEvent[], note: number) => evts.filter(ee => ee.evt.midiEvent.note === note)\n\n\tclearAllEvents = () => {\n\t\t// Remove all loop events\n\t\tthis.evts = []\n\t\tthis.save()\n\t\t// Update note and control graphics\n\t\tif (this.pgControls) {\n\t\t\tthis.needsRenderControls = true\n\t\t}\n\t\tif (this.pgNotes) {\n\t\t\tthis.needsRenderNotes = true\n\t\t}\n\t}\n\n\t_lastDownbeat = 0\n\t_lastBeats = 0\n\tupdate = () => {\n\t\t// Calculate play and rec heads normalized (0-1) to the loop length\n\t\tconst now = sketch.nowMs()\n\t\tconst recOff = sketch.offsetMs()\n\t\tconst play = this.timeGlobalToLoopNorm(now)\n\t\tlet rec = this.timeGlobalToLoopNorm(now + recOff)\n\t\tconst headRecPrev = this.headRec\n\n\t\tthis.headPlay = play\n\t\tthis.headRec = rec\n\n\t\tif (this.isMuted) {\n\t\t\treturn\n\t\t}\n\t\tif (this._lastDownbeat !== sketch.downbeat || this._lastBeats !== this.opts.beats) {\n\t\t\tthis._lastDownbeat = sketch.downbeat\n\t\t\tthis._lastBeats = this.opts.beats\n\t\t\treturn // downbeat changed, skip an update so we don't get faulty triggers\n\t\t}\n\n\t\t// Trigger looped events if an offset boundary was crossed\n\t\tfor (const levt of this.evts) {\n\t\t\tconst { evt, loopTime, release } = levt\n\t\t\tlet lt = loopTime\n\t\t\tif (evt.timestamp > now - sketch.beatMs() / 2) {\n\t\t\t\tcontinue // don't trigger the first event since it is sent directly\n\t\t\t}\n\t\t\tif (rec < headRecPrev) {\n\t\t\t\t// crossed the 1/0 boundary\n\t\t\t\tif (lt <= rec) {\n\t\t\t\t\tlt += 1\n\t\t\t\t}\n\t\t\t\trec += 1\n\t\t\t}\n\t\t\tif (headRecPrev < lt && lt <= rec) {\n\t\t\t\tsketch._sendUserEvent({\n\t\t\t\t\t...levt.evt,\n\t\t\t\t\ttimestamp: this.timeLoopNormToGlobal(now + recOff, lt),\n\t\t\t\t})\n\t\t\t\tif (release) {\n\t\t\t\t\tlet after = release.loopTime - loopTime\n\t\t\t\t\tif (after <= 0) {\n\t\t\t\t\t\tafter += 1\n\t\t\t\t\t}\n\t\t\t\t\tsketch._sendUserEvent({\n\t\t\t\t\t\t...release.evt,\n\t\t\t\t\t\ttimestamp: this.timeLoopNormToGlobal(now + recOff, lt + after),\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\trecStartedAt: number | null = null\n\tdraw = (pp: p5, xx: number, yy: number) => {\n\t\tconst { beats, radius } = this.opts\n\t\tconst { isActive, isDial, isMuted, isRecording } = this\n\t\tthis.xx = xx\n\t\tthis.yy = yy\n\t\tif (isRecording) {\n\t\t\tif (this.recStartedAt === null) {\n\t\t\t\tthis.recStartedAt = this.headRec\n\t\t\t}\n\t\t\tpp.fill(30).stroke(255, 0, 0).strokeWeight(4)\n\t\t} else {\n\t\t\tthis.recStartedAt = null\n\t\t\tpp.fill(30).stroke(0).strokeWeight(2)\n\t\t}\n\t\tpp.circle(this.xx, this.yy, radius * 2 + (isRecording ? 2 : 0))\n\n\t\t// Draw a line for every beat\n\t\tfor (let ii = 0; ii < beats; ii++) {\n\t\t\tconst isDown = ii % 4 === 0\n\t\t\tconst isFirst = ii === 0\n\t\t\tpp.stroke(isFirst ? 180 : isDown ? 130 : 80)\n\t\t\tpp.strokeWeight(isFirst ? 3 : isDown ? 2 : 1)\n\t\t\tconst bb = ii / beats\n\t\t\tthis.drawLine(pp, radius, bb)\n\t\t}\n\n\t\tthis.drawEvents(pp)\n\n\t\tif (isMuted) {\n\t\t\tpp.fill(30, 150).noStroke()\n\t\t\tpp.circle(this.xx, this.yy, radius * 2)\n\t\t}\n\n\t\t// Draw indicators for playhead and record-head\n\t\tconst { headPlay, headRec } = this\n\t\tif (isDial || isRecording) {\n\t\t\tconst arcPlay = (Math.ceil(headPlay * beats) % beats) / beats\n\t\t\tconst arcRec = (Math.ceil(headRec * beats) % beats) / beats\n\t\t\tlet recFillAlpha = 100\n\t\t\tif (isDial) {\n\t\t\t\tpp.fill(0, 200, 0, 60).noStroke()\n\t\t\t\tthis.drawArc(pp, radius, arcPlay)\n\t\t\t\trecFillAlpha = 140\n\t\t\t}\n\t\t\tpp.fill(180, 0, 0, recFillAlpha).noStroke()\n\t\t\tif (headRec !== headPlay) {\n\t\t\t\tconst rad = isRecording ? radius : radius * 0.7\n\t\t\t\tif (isRecording && this.recStartedAt !== null) {\n\t\t\t\t\tthis.drawArc(pp, rad, headRec, this.recStartedAt)\n\t\t\t\t} else {\n\t\t\t\t\tthis.drawArc(pp, rad, arcRec, headPlay)\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (isActive || !isMuted) {\n\t\t\tif (isMuted) {\n\t\t\t\tpp.stroke(100).strokeWeight(3)\n\t\t\t} else {\n\t\t\t\tpp.stroke(0, 200, 0).strokeWeight(3)\n\t\t\t}\n\t\t\tthis.drawLine(pp, radius, headPlay)\n\t\t}\n\t\tif (isDial || isActive) {\n\t\t\tpp.stroke(200, 0, 0).strokeWeight(4)\n\t\t\tconst rad = isRecording ? radius : radius * 0.7\n\t\t\tthis.drawLine(pp, rad, headRec)\n\t\t}\n\t}\n\n\t// drawEvents draws an arc stroke for every note\n\tdrawEvents = (pp: p5) => {\n\t\tif (this.isDial) {\n\t\t\treturn\n\t\t}\n\t\tthis.drawControls(pp)\n\t\tthis.drawNotes(pp)\n\t}\n\n\tdrawControls = (pp: p5) => {\n\t\tconst { radius } = this.opts\n\t\tif (this.needsRenderControls) {\n\t\t\tthis.needsRenderControls = false\n\t\t\tif (!this.pgControls) {\n\t\t\t\tthis.pgControls = pp.createGraphics(radBig * 2, radBig * 2)\n\t\t\t}\n\t\t\t// Stash the x and y coords and override with center of graphics\n\t\t\tconst [tmpx, tmpy] = [this.xx, this.yy]\n\t\t\tthis.xx = radius\n\t\t\tthis.yy = radius\n\t\t\tthis.renderControls()\n\t\t\tthis.xx = tmpx\n\t\t\tthis.yy = tmpy\n\t\t}\n\t\tif (this.pgControls) {\n\t\t\tpp.image(this.pgControls, this.xx - radius, this.yy - radius)\n\t\t}\n\t}\n\n\tdrawNotes = (pp: p5) => {\n\t\tconst { radius } = this.opts\n\t\tif (this.needsRenderNotes) {\n\t\t\tthis.needsRenderNotes = false\n\t\t\tif (!this.pgNotes) {\n\t\t\t\tthis.pgNotes = pp.createGraphics(radBig * 2, radBig * 2)\n\t\t\t}\n\t\t\tconst [tmpx, tmpy] = [this.xx, this.yy]\n\t\t\tthis.xx = radius\n\t\t\tthis.yy = radius\n\t\t\tthis.renderNotes()\n\t\t\tthis.xx = tmpx\n\t\t\tthis.yy = tmpy\n\t\t}\n\t\tif (this.pgNotes) {\n\t\t\tpp.image(this.pgNotes, this.xx - radius, this.yy - radius)\n\t\t}\n\t\tif (this.isRecording) {\n\t\t\tthis._drawNotes(pp, true) // draw any unreleased notes\n\t\t}\n\t}\n\n\tdrawLine = (pp: p5, rad: number, loopTime: number) => {\n\t\tconst theta = Math.PI * 2 * loopTime\n\t\tconst lx = this.xx + (rad - 2) * Math.sin(theta)\n\t\tconst ly = this.yy - (rad - 2) * Math.cos(theta)\n\t\tpp.line(this.xx, this.yy, lx, ly)\n\t}\n\n\tdrawArc = (pp: p5, rad: number, loopTime: number, fromTime: number = 0) => {\n\t\tconst theta = Math.PI * (2 * loopTime - 0.5)\n\t\tconst from = Math.PI * (2 * fromTime - 0.5)\n\t\tpp.arc(this.xx, this.yy, rad * 2, rad * 2, from, theta)\n\t}\n\n\trenderControls = () => {\n\t\tif (!this.pgControls) {\n\t\t\treturn\n\t\t}\n\t\tconst pg = this.pgControls\n\t\tpg.clear()\n\t\tconst cevts = this.groupByController(this.sortByLoopTime(this.controlEvents()))\n\t\tif (!Object.keys(cevts).length) {\n\t\t\treturn\n\t\t}\n\t\tconst { radius } = this.opts\n\t\tpg.strokeWeight(2).noFill()\n\t\tpg.colorMode(pg.HSL, 1)\n\t\tfor (const ctrl in cevts) {\n\t\t\tconst col = ctrlColor(ctrl)\n\t\t\tconst len = cevts[ctrl].length\n\t\t\tfor (let ii = 0; ii < len; ii++) {\n\t\t\t\tconst { loopTime, evt } = cevts[ctrl][ii]\n\t\t\t\tconst nextEvtIdx = ii === len - 1 ? 0 : ii + 1\n\t\t\t\tconst { loopTime: nextTime } = cevts[ctrl][nextEvtIdx]\n\t\t\t\tconst { kind, value } = evt.midiEvent\n\t\t\t\tconst isPitchbend = kind === 'pitchbend'\n\t\t\t\tconst vv = isPitchbend ? value / 2 + 0.5 : value\n\t\t\t\tconst rad = radius * (0.3 + 0.65 * vv)\n\t\t\t\tpg.stroke(col.hue, col.sat, col.lgt)\n\t\t\t\tthis.drawArc(pg, rad, nextTime, loopTime)\n\t\t\t}\n\t\t}\n\t}\n\n\trenderNotes = () => {\n\t\tif (!this.pgNotes) {\n\t\t\treturn\n\t\t}\n\t\tthis.pgNotes.clear()\n\t\tthis._drawNotes(this.pgNotes)\n\t}\n\n\t_drawNotes = (pp: p5, unreleasedOnly = false) => {\n\t\tconst modNotes = 12\n\t\tconst { radius } = this.opts\n\t\tpp.strokeWeight(radius / modNotes).noFill()\n\t\tpp.colorMode(pp.HSL, 1)\n\t\tfor (const { loopTime, evt, release } of this.attackEvents()) {\n\t\t\tconst { note, attack } = evt.midiEvent\n\t\t\tlet relTime = this.headRec\n\t\t\tif (release) {\n\t\t\t\tif (unreleasedOnly) {\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\t\t\t\trelTime = release.loopTime\n\t\t\t}\n\t\t\tconst rad = radius * (0.3 + (0.7 * (note % modNotes)) / modNotes)\n\t\t\tconst nn = note % 12\n\t\t\tlet hue = BLACK_KEYS.includes(nn) ? 0.5 + nn / 36 : nn / 36\n\t\t\tlet sat = attack ? 1 - attack : 0.5\n\t\t\tsat = 1 - sat * sat\n\t\t\tpp.stroke(hue, sat, 0.4)\n\t\t\tthis.drawArc(pp, rad, relTime, loopTime)\n\t\t}\n\t\tpp.colorMode(pp.RGB, 255)\n\t}\n\n\ttimeGlobalToLoop = (tt: number) => {\n\t\treturn (tt - sketch.downbeat) / this.loopLenMs()\n\t}\n\n\ttimeGlobalToLoopNorm = (tt: number) => {\n\t\tconst lt = this.timeGlobalToLoop(tt)\n\t\treturn lt - Math.floor(lt) // 0-1 from start to end of loop\n\t}\n\n\ttimeLoopToGlobal = (loopTime: number) => {\n\t\tconst loopLenMs = this.loopLenMs()\n\t\treturn sketch.downbeat + loopTime * loopLenMs\n\t}\n\n\ttimeLoopNormToGlobal = (tt: number, loopTime: number) => {\n\t\tconst loopLenMs = this.loopLenMs()\n\t\treturn this.timeLastLoopStartMs(tt) + loopTime * loopLenMs\n\t}\n\n\ttimeLastLoopStartMs = (tt: number) => {\n\t\tconst loopLenMs = this.loopLenMs()\n\t\tconst lt = this.timeGlobalToLoop(tt)\n\t\treturn sketch.downbeat + Math.floor(lt) * loopLenMs\n\t}\n\n\thitTest = (xx: number, yy: number) => {\n\t\tconst { radius } = this.opts\n\t\tif (xx < this.xx - radius || xx > this.xx + radius) {\n\t\t\treturn false\n\t\t}\n\t\tif (yy < this.yy - radius || yy > this.yy + radius) {\n\t\t\treturn false\n\t\t}\n\t\treturn true\n\t}\n}\n","import * as p5 from 'p5'\nimport { UserEvent } from './serverApi/serverApi'\nimport Sketch from './Sketch'\nimport {\n\tKEYCODE_BACKSPACE,\n\tKEYCODE_CONTROL,\n\tKEYCODE_DELETE,\n\tKEYCODE_SHIFT,\n\tKEYCODE_ENTER,\n\tKEYCODE_RETURN,\n} from './constants'\nimport { radBig, radSmall, Loop, LoopData } from './Loop'\n\ntype LoopsOpts = {\n\tsketch: Sketch\n\trecOffset: number\n}\n\nconst defaultLoopParams = { beats: 8, radius: radSmall }\n\nexport class Loops {\n\tsketch: Sketch\n\tdial: Loop\n\tloops: Loop[] = []\n\tactiveLoop: Loop\n\tinputs: {\n\t\tloopLen?: any\n\t\tnewLoopBtn?: any\n\t} = {}\n\trecLock = false\n\thidden = false\n\thiddenDial = false\n\tloaded = false\n\n\tconstructor(opts: LoopsOpts) {\n\t\tthis.sketch = opts.sketch\n\t\tthis.dial = new Loop({\n\t\t\tbeats: this.dialBeats(opts.recOffset),\n\t\t\tradius: radBig,\n\t\t\tisDial: true,\n\t\t})\n\t\tthis.activeLoop = new Loop({ beats: 8, radius: radBig })\n\t}\n\n\tload = () => {\n\t\tconst { sketch } = this\n\t\tconst store = sketch.localStorage\n\t\tconst lidsStr = store.getItem('loops')\n\t\tconst aid = store.getItem('activeLoop')\n\t\tlet activeLoop: Loop | null = null\n\t\tif (lidsStr && lidsStr !== '') {\n\t\t\tconst lids = JSON.parse(lidsStr)\n\t\t\tfor (const lid of lids) {\n\t\t\t\tconst loop = new Loop({ id: lid, ...defaultLoopParams })\n\t\t\t\tif (loop.loaded) {\n\t\t\t\t\t// loop loaded successfully from local storage, add to loops\n\t\t\t\t\tloop.updateClientId(sketch.user.clientId)\n\t\t\t\t\tthis.loops.push(loop)\n\t\t\t\t\tif (lid === aid) {\n\t\t\t\t\t\tactiveLoop = loop\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (activeLoop) {\n\t\t\tthis.activeLoop = activeLoop\n\t\t\treturn activeLoop\n\t\t}\n\t\tthis.activeLoop = new Loop(defaultLoopParams)\n\t\tthis.loops.push(this.activeLoop)\n\t\treturn this.activeLoop\n\t}\n\n\tsaveLoopRefs = () => {\n\t\tconst store = this.sketch.localStorage\n\t\tstore.setItem('activeLoop', this.activeLoop.id)\n\t\tstore.setItem('loops', JSON.stringify(this.loops.map(ll => ll.id)))\n\t}\n\n\tcopyToClipboard = async () => {\n\t\tawait navigator.clipboard.writeText(JSON.stringify(this.activeLoop.data()))\n\t\tconsole.log('[Loops #copyToClipboard] Data saved to clipboard')\n\t}\n\tpasteFromClipboard = async () => {\n\t\tconst dataStr = await navigator.clipboard.readText()\n\t\tif (!dataStr || dataStr === '') {\n\t\t\tconsole.log('[Loops #copyToClipboard] No data to paste')\n\t\t\treturn\n\t\t}\n\t\ttry {\n\t\t\tconst data = JSON.parse(dataStr) as LoopData\n\t\t\tif (!data || !data.id || data.id === '' || !data.beats || !data.evts || !data.evts.length) {\n\t\t\t\tconsole.log('[Loops #copyToClipboard] Unable to parse pasted data', data, { dataStr })\n\t\t\t\treturn\n\t\t\t}\n\t\t\tconst loop = new Loop(defaultLoopParams)\n\t\t\tconst newId = loop.id\n\t\t\tloop.loadData(data)\n\t\t\tif (loop.loaded) {\n\t\t\t\t// loop loaded successfully from local storage, add to loops\n\t\t\t\tloop.id = newId\n\t\t\t\tloop.updateClientId(this.sketch.user.clientId)\n\t\t\t\tloop.isMuted = true\n\t\t\t\tthis.loops.push(loop)\n\t\t\t\tthis.activateLoop(loop)\n\t\t\t\tloop.save()\n\t\t\t\tthis.saveLoopRefs()\n\t\t\t\tconsole.log('[Loops #pasteFromClipboard] New loop loaded from clipboard')\n\t\t\t}\n\t\t} catch (err) {\n\t\t\tconsole.log('[Loops #copyToClipboard] Unable to parse pasted data', err, dataStr)\n\t\t}\n\t}\n\n\tupdate = () => {\n\t\tif (!this.loaded) {\n\t\t\tthis.activeLoop = this.load()\n\t\t\tthis.loaded = true\n\t\t}\n\t\tthis.dial.update()\n\t\tthis.loops.forEach(ll => ll.update())\n\t}\n\n\tdraw = (pp: p5) => {\n\t\tconst { activeLoop, didSetup, hidden, hiddenDial } = this\n\t\tif (hidden) {\n\t\t\tif (didSetup) {\n\t\t\t\tthis.inputs.loopLen.remove()\n\t\t\t\tthis.inputs.newLoopBtn.remove()\n\t\t\t\tthis.didSetup = false\n\t\t\t}\n\t\t} else if (!didSetup) {\n\t\t\tthis.setupInputs(pp)\n\t\t}\n\t\tconst { loopLen, newLoopBtn } = this.inputs\n\n\t\t// Draw active loop\n\t\tlet rad = radBig\n\t\tlet yy = rad + 20\n\t\tlet xx = pp.width - 20\n\t\tif (!hidden) {\n\t\t\tactiveLoop.isActive = true\n\t\t\tactiveLoop.setRadius(rad)\n\t\t\tactiveLoop.isRecording = this.isRecording(pp)\n\t\t\txx -= rad + 20\n\t\t\tactiveLoop.draw(pp, xx, yy)\n\t\t\tpp.fill(210).stroke(0).strokeWeight(1)\n\t\t\tpp.textSize(14).textAlign(pp.CENTER, pp.TOP)\n\t\t\tpp.text(`Active loop: ${loopLen.value()} beats`, xx, yy + rad + 10)\n\t\t\tloopLen.position(xx - 60, yy + rad + 30)\n\t\t\tconst btnHalfwidth = Math.max(48, Math.floor(newLoopBtn.elt.offsetWidth / 2))\n\t\t\tnewLoopBtn.position(xx - btnHalfwidth, yy + rad + 60)\n\t\t\txx -= rad + 20\n\t\t}\n\n\t\tif (!hiddenDial) {\n\t\t\t// Draw metronome dial\n\t\t\trad = this.dial.opts.radius\n\t\t\txx -= rad + 20\n\t\t\tthis.dial.draw(pp, xx, yy)\n\t\t\tpp.fill(210).stroke(0).strokeWeight(1)\n\t\t\tpp.textSize(14).textAlign(pp.CENTER, pp.TOP)\n\t\t\tpp.text('Metronome', xx, yy + rad + 10)\n\t\t}\n\n\t\tif (hidden) {\n\t\t\treturn\n\t\t}\n\n\t\tyy = newLoopBtn.y + newLoopBtn.elt.offsetHeight + 20\n\n\t\tconst othersTop = yy\n\t\trad = radSmall\n\t\txx = pp.width - rad - 20\n\t\tfor (const ll of this.inactiveLoops()) {\n\t\t\tll.isActive = false\n\t\t\tll.setRadius(radSmall)\n\t\t\tyy += rad\n\t\t\tll.draw(pp, xx, yy)\n\t\t\tif (pp.keyIsDown(KEYCODE_SHIFT)) {\n\t\t\t\t// inform user they can click here to delete this loop\n\t\t\t\tpp.fill(50, 150).noStroke()\n\t\t\t\tpp.circle(xx, yy, rad * 2)\n\t\t\t\tpp.fill(200).textSize(12).textStyle(pp.NORMAL).textAlign(pp.CENTER, pp.CENTER)\n\t\t\t\tpp.text('Click to\\ndelete', xx, yy)\n\t\t\t}\n\t\t\tyy += rad + 20\n\t\t\tif (yy > pp.height - rad * 3) {\n\t\t\t\tyy = othersTop\n\t\t\t\txx -= rad * 2 + 20\n\t\t\t}\n\t\t}\n\t}\n\n\tdidSetup = false\n\tsetupInputs = (pp: p5) => {\n\t\tthis.didSetup = true\n\t\tthis.inputs.loopLen = pp.createSlider(1, 64, this.activeLoop.opts.beats) as any\n\t\tthis.inputs.newLoopBtn = pp.createButton('Add new loop') as any\n\t\tconst { loopLen, newLoopBtn } = this.inputs\n\t\tloopLen.size(120)\n\t\tloopLen.input(() => {\n\t\t\tthis.activeLoop.opts.beats = loopLen.value()\n\t\t\tthis.activeLoop.save()\n\t\t})\n\t\tnewLoopBtn.mousePressed(this.addLoop)\n\t}\n\n\tdialBeats = (recOffset: number) => 4 * Math.ceil((recOffset + 1) / 4)\n\n\tupdateRecOffset = (off: number) => {\n\t\tthis.dial.opts.beats = this.dialBeats(off)\n\t}\n\n\tloopUserEvent = (evt: UserEvent) => {\n\t\tthis.activeLoop.loopUserEvent(evt)\n\t}\n\n\tclearAll = () => {\n\t\tthis.loops.forEach(ll => ll.clearAllEvents())\n\t}\n\n\tclearActiveLoop = () => {\n\t\tthis.activeLoop.clearAllEvents()\n\t}\n\n\tupdateClientId = (clientId: number) => {\n\t\tthis.loops.forEach(ll => ll.updateClientId(clientId))\n\t}\n\n\ttoggleActiveLoopMute = () => {\n\t\tconst al = this.activeLoop\n\t\tal.isMuted = !al.isMuted\n\t\tal.save()\n\t}\n\n\tmuteAll = () => {\n\t\tfor (const ll of this.loops) {\n\t\t\tif (!ll.isMuted) {\n\t\t\t\tll.isMuted = true\n\t\t\t\tll.save()\n\t\t\t}\n\t\t}\n\t}\n\n\ttoggleHide = () => (this.hidden = !this.hidden)\n\ttoggleHideText = () => (this.hidden ? 'Show Loops' : 'Hide Loops')\n\ttoggleHideDial = () => (this.hiddenDial = !this.hiddenDial)\n\ttoggleHideDialText = () => (this.hiddenDial ? 'Show Metronome' : 'Hide Metronome')\n\n\tstopRecording = () => {\n\t\tthis.activeLoop.sanitizeEvents()\n\t\tthis.activeLoop.save()\n\t}\n\n\taddLoop = () => {\n\t\tthis.activeLoop = new Loop({\n\t\t\tbeats: this.inputs.loopLen.value(),\n\t\t\tradius: radBig,\n\t\t})\n\t\tthis.loops.push(this.activeLoop)\n\t\tthis.saveLoopRefs()\n\t}\n\n\tinactiveLoops = () => this.loops.filter(ll => ll !== this.activeLoop)\n\n\tmousePressed = (pp: p5) => {\n\t\tlet didHit = false\n\t\tfor (const loop of this.inactiveLoops()) {\n\t\t\tif (loop.hitTest(pp.mouseX, pp.mouseY)) {\n\t\t\t\tdidHit = true\n\t\t\t\tif (pp.keyIsDown(KEYCODE_SHIFT)) {\n\t\t\t\t\t// Remove loop\n\t\t\t\t\tloop.remove()\n\t\t\t\t\tthis.loops = this.loops.filter(ll => ll !== loop)\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t\tthis.activateLoop(loop)\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t\tif (didHit) {\n\t\t\tthis.saveLoopRefs()\n\t\t}\n\t}\n\n\tactivateLoop = (loop: Loop) => {\n\t\tthis.activeLoop.isActive = false\n\t\tthis.inputs.loopLen.value(loop.opts.beats)\n\t\tthis.activeLoop = loop\n\t\tloop.isActive = true\n\t}\n\n\tkeyPressed = (evt: p5) => {\n\t\tif (evt.keyCode === KEYCODE_BACKSPACE || evt.keyCode === KEYCODE_DELETE) {\n\t\t\tthis.clearActiveLoop()\n\t\t\treturn\n\t\t}\n\t\tif (evt.keyCode === KEYCODE_ENTER || evt.keyCode === KEYCODE_RETURN) {\n\t\t\tthis.recLock = !this.recLock\n\t\t\tif (!this.recLock) {\n\t\t\t\tthis.stopRecording()\n\t\t\t}\n\t\t\treturn\n\t\t}\n\t\tswitch (evt.key) {\n\t\t\tcase 'c':\n\t\t\t\tif (evt.keyIsDown(KEYCODE_CONTROL)) {\n\t\t\t\t\tthis.copyToClipboard()\n\t\t\t\t}\n\t\t\t\treturn\n\t\t\tcase 'v':\n\t\t\t\tif (evt.keyIsDown(KEYCODE_CONTROL)) {\n\t\t\t\t\tthis.pasteFromClipboard()\n\t\t\t\t}\n\t\t\t\treturn\n\t\t\tcase '\\\\':\n\t\t\tcase '|':\n\t\t\tcase 'm':\n\t\t\t\tif (evt.keyIsDown(KEYCODE_CONTROL)) {\n\t\t\t\t\tthis.muteAll()\n\t\t\t\t} else {\n\t\t\t\t\tthis.toggleActiveLoopMute()\n\t\t\t\t}\n\t\t\t\treturn\n\t\t\tcase '[':\n\t\t\tcase ',':\n\t\t\t\treturn this.activatePrev()\n\t\t\tcase ']':\n\t\t\tcase '.':\n\t\t\t\treturn this.activateNext()\n\t\t}\n\t}\n\n\tactivatePrev = () => {\n\t\tconst { loops } = this\n\t\tfor (let ii = 0; ii < loops.length; ii++) {\n\t\t\tif (loops[ii] === this.activeLoop) {\n\t\t\t\tif (ii === 0) {\n\t\t\t\t\tthis.activateLoop(loops[loops.length - 1])\n\t\t\t\t} else {\n\t\t\t\t\tthis.activateLoop(loops[ii - 1])\n\t\t\t\t}\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t}\n\n\tactivateNext = () => {\n\t\tconst { loops } = this\n\t\tfor (let ii = 0; ii < loops.length; ii++) {\n\t\t\tif (loops[ii] === this.activeLoop) {\n\t\t\t\tif (ii === loops.length - 1) {\n\t\t\t\t\tthis.activateLoop(loops[0])\n\t\t\t\t} else {\n\t\t\t\t\tthis.activateLoop(loops[ii + 1])\n\t\t\t\t}\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t}\n\n\tkeyReleased = (evt: p5) => {\n\t\tif (evt.keyCode === KEYCODE_SHIFT) {\n\t\t\t// Stopped recording to loop, cleanup any dangling notes\n\t\t\tthis.stopRecording()\n\t\t}\n\t}\n\n\tisRecording = (pp?: p5): boolean => {\n\t\treturn this.recLock || (!!pp && pp.keyIsDown(KEYCODE_SHIFT))\n\t}\n}\n","import * as p5 from 'p5'\nimport * as Tone from 'tone'\nimport { engine3d, Avatar, BlackHoleObj, Ground, Vec } from 'engine3d'\nimport { KEYCODE_ESC } from './constants'\nimport WSClient, { DONT_REOPEN } from './serverApi/WSClient'\nimport { ClockOpts, NOTE_METRONOME_BPM_CHANGED, NOTE_METRONOME_DOWN } from './serverApi/serverClock'\nimport {\n\tuserEventReq,\n\tuserUpdateReq,\n\tuserXformReq,\n\tuserRequestXformsReq,\n\tUser,\n\tUserEvent,\n\tUserForce,\n\tUserXform,\n} from './serverApi/serverApi'\nimport MIDI, { MidiEvent, MidiEventCC, MidiEventNote, MidiEventPitchbend } from './MIDI'\nimport { Instrument } from './Instrument'\nimport { InstControls } from './InstControls'\nimport { BlackHole, Dancer, EightOhEight, Hoover, Metronome, Piano, PolySynth } from './instruments'\nimport { EasyCam } from 'vendor/p5.easycam.js'\nimport { SketchInputs } from './SketchInputs'\nimport { SketchAudioKeys } from './SketchAudioKeys'\nimport { Loops } from './Loops'\n\ntype Instruments = { [key: string]: Instrument }\n\nexport const worldScale = 1000\nconst newAvatarPos = () => {\n\tconst rr = () => Math.random() - 0.5\n\treturn new Vec((rr() * worldScale) / 2, 31, (rr() * worldScale) / 2)\n}\nfunction nearestPowerOf2(n: number) {\n\t// via https://stackoverflow.com/questions/26965171/fast-nearest-power-of-2-in-javascript\n\treturn 1 << (31 - Math.clz32(n))\n}\n\nexport default class Sketch {\n\twidth = 0\n\theight = 0\n\tstarted = false\n\tsyncing = true\n\tdownbeat = Tone.now() // Tone time of the first downbeat\n\ttransportStarted = false\n\t_bpm = 95\n\t_bpmNext = 95\n\tbgCol = {\n\t\thue: 0.5,\n\t\tsat: 0,\n\t\tlgt: 0.2,\n\t}\n\n\tlocalStorage: Storage\n\tws: WSClient\n\tmidi: MIDI\n\taudioKeys: SketchAudioKeys\n\tinstruments: Instruments\n\tinstSliders = new InstControls()\n\tinputs: SketchInputs\n\tloops: Loops\n\n\tuser: User = {\n\t\tclientId: -1,\n\t\tname: '',\n\t\tinstrument: 'dancer',\n\t\tinputDevice: 'keyboard',\n\t\toffset: 1,\n\t}\n\tusers: User[] = []\n\tavatar: Avatar\n\tavatars: Avatar[] = []\n\n\tpp?: p5 // Main canvas, gets WebGL graphics + 2D elements (loops, labels, etc)\n\tpg?: p5.Graphics // WebGL graphics context for 3D virtual space\n\tbackbuffer?: p5.Graphics // A graphics buffer for the previously rendered frame\n\tcam?: EasyCam\n\tground = new Ground({ pos: new Vec(0, -1, 0), scale: new Vec(worldScale) })\n\tblackHole = new BlackHoleObj()\n\n\tconstructor(global: any) {\n\t\tconsole.log('[Sketch #ctor]')\n\t\tthis.localStorage = global.localStorage\n\t\tconst didLoad = this.loadFromStorage()\n\t\tthis.inputs = new SketchInputs(didLoad)\n\t\tthis.loops = new Loops({\n\t\t\tsketch: this,\n\t\t\trecOffset: this.user.offset,\n\t\t})\n\t\tthis.avatar = new Avatar({\n\t\t\tuser: this.user,\n\t\t\tpos: newAvatarPos(),\n\t\t\tscale: new Vec(30),\n\t\t\tphys: { worldScale },\n\t\t\tonForce: this.sendUserXform,\n\t\t})\n\t\tthis.ws = new WSClient(window, {\n\t\t\tclock: {\n\t\t\t\tonSynced: () => {\n\t\t\t\t\tthis.syncing = false\n\t\t\t\t},\n\t\t\t},\n\t\t\tonClientId: (clientId: number) => {\n\t\t\t\tthis.transportStarted = false\n\t\t\t\tthis.user.clientId = clientId\n\t\t\t\tthis.inputs.setupInputsUser(clientId)\n\t\t\t\tthis.loops.updateClientId(clientId)\n\t\t\t\tthis.sendUserUpdate()\n\t\t\t\tthis.sendUserXform(this.avatar.getUserXform())\n\t\t\t\tthis.sendUserRequestXforms()\n\t\t\t},\n\t\t\tonClockUpdate: (clkOpts: ClockOpts) => {\n\t\t\t\tif (clkOpts.clientId === 0) {\n\t\t\t\t\t// Clock update came from server, use to set BPM on next downbeat\n\t\t\t\t\tthis._bpmNext = clkOpts.bpm\n\t\t\t\t} else {\n\t\t\t\t\tthis.inputs.onClockUpdate(clkOpts)\n\t\t\t\t}\n\t\t\t},\n\t\t\tonUsers: this.onUsers,\n\t\t\tonUserEvent: this.onUserEvent,\n\t\t\tonUserForce: this.onUserForce,\n\t\t\tonUserXform: this.onUserXform,\n\t\t\tonUserRequestXforms: () => this.sendUserXform(this.avatar.getUserXform()),\n\t\t})\n\t\tthis.instruments = {\n\t\t\tdancer: new Dancer(),\n\t\t\tpolysquare: new PolySynth(),\n\t\t\tblackHole: new BlackHole(),\n\t\t\thoover: new Hoover(),\n\t\t\teightOhEight: new EightOhEight(this),\n\t\t\tpiano: new Piano(),\n\t\t\tmetronome: new Metronome(this),\n\t\t}\n\t\tthis.midi = new MIDI({\n\t\t\tonEnabled: this.inputs.setupInputsMidi,\n\t\t\tonMessage: this.sendUserEvent,\n\t\t})\n\t\tthis.audioKeys = new SketchAudioKeys(this)\n\t\twindow.Tone = Tone\n\t\twindow.me = this\n\t}\n\n\tloadFromStorage = () => {\n\t\tconst ustr = this.localStorage.getItem('user')\n\t\tif (!ustr || ustr === ``) {\n\t\t\tconsole.error('No stored user')\n\t\t\treturn false\n\t\t}\n\t\tthis.user = JSON.parse(ustr)\n\t\treturn true\n\t}\n\n\tdestroy = () => {\n\t\tthis.ws.conn.close(DONT_REOPEN, 'sketch destroyed')\n\t}\n\n\ttimeGlobalToTone = (globalTime: number) => {\n\t\tconst rawCtx = Tone.context.rawContext as any\n\t\tconst { contextTime, performanceTime } = rawCtx._nativeAudioContext.getOutputTimestamp()\n\t\tconst lt = this.ws.clock.toLocal(globalTime)\n\t\tconst delta = lt - performanceTime\n\t\tconst toneTime = contextTime + delta / 1000\n\t\treturn toneTime\n\t}\n\n\ttimeToneToGlobal = (toneTime: number) => {\n\t\tconst rawCtx = Tone.context.rawContext as any\n\t\tconst { contextTime, performanceTime } = rawCtx._nativeAudioContext.getOutputTimestamp()\n\t\tconst delta = toneTime - contextTime\n\t\tconst pt = performanceTime + delta * 1000\n\t\tconst globalTime = this.ws.clock.toGlobal(pt)\n\t\treturn globalTime\n\t}\n\n\tsetSize = (width: number, height: number) => {\n\t\tthis.width = width\n\t\tthis.height = height\n\t}\n\n\tshaderBlackHole?: p5.Shader\n\tsketch = (pp: p5) => {\n\t\tthis.pp = pp\n\t\tpp.pixelDensity(1)\n\t\tpp.preload = () => {\n\t\t\tthis.shaderBlackHole = pp.loadShader('/shaders/simple.vert', '/shaders/blackHole.frag')\n\t\t}\n\t\tpp.setup = () => this.setup(pp)\n\t\tpp.draw = () => this.draw(pp)\n\t\tpp.mousePressed = () => this.mousePressed(pp)\n\t\tpp.mouseReleased = () => this.mouseReleased(pp)\n\t\tpp.keyPressed = () => this.keyPressed(pp)\n\t\tpp.keyReleased = () => this.keyReleased(pp)\n\t}\n\n\tsetup = (pp: p5) => {\n\t\tconsole.log(`[Sketch #setup] ${this.width} x ${this.height}`)\n\t\tpp.createCanvas(this.width, this.height)\n\t\tthis.pg = pp.createGraphics(this.width, this.height, 'webgl')\n\t\tthis.pg.textureWrap(pp.REPEAT) // applies to textures rendered to pg (i.e. backbuffer)\n\t\tconst bbsize = nearestPowerOf2(this.width) // backbuffer size is ^2 so p5 doesn't force mode to CLAMP\n\t\tthis.backbuffer = pp.createGraphics(bbsize, bbsize, pp.WEBGL)\n\t\tthis.cam = new EasyCam((this.pg as any)._renderer, { distance: 100 })\n\t\tthis.cam.setDistanceMin(40)\n\t\tthis.cam.setDistanceMax(3000)\n\t\tthis.cam.rotateX(-Math.PI / 8)\n\t\tthis.cam.attachMouseListeners((pp as any)._renderer)\n\t\tthis.cam.setViewport([0, 0, this.width, this.height])\n\t\tthis.cam.rotateZ(Math.PI)\n\t\tthis.avatar.addFollowCam(this.cam)\n\t\tthis.inputs.setup(pp)\n\t}\n\n\tdraw = (pp: p5) => {\n\t\tthis.instSliders.update(pp)\n\t\tthis.loops.update()\n\t\tengine3d.update()\n\t\tpp.colorMode(pp.HSL, 1)\n\t\t\t.background(this.bgCol.hue, this.bgCol.sat, this.bgCol.lgt, 0.5)\n\t\t\t.colorMode(pp.RGB, 255)\n\t\tconst { pg } = this\n\t\tif (pg) {\n\t\t\tpg.perspective(Math.PI / 3, pg.width / pg.height, 1, 10000)\n\t\t\tpg.clear()\n\t\t\tengine3d.draw(pg)\n\t\t\tpp.image(pg, 0, 0)\n\t\t\tconst { backbuffer } = this\n\t\t\tif (backbuffer) {\n\t\t\t\tconst { width, height } = backbuffer\n\t\t\t\tbackbuffer.image(pg, -width / 2, -height / 2, width, height)\n\t\t\t}\n\t\t}\n\t\tthis.inputs.draw(pp)\n\t\tthis.loops.draw(pp)\n\t\tif (this.inputs.help) {\n\t\t\treturn\n\t\t}\n\t\tif (!this.inputs.hidden) {\n\t\t\tthis.instSliders.draw(pp)\n\t\t}\n\t\tif (pg) {\n\t\t\tengine3d.draw2D(pp, pg)\n\t\t}\n\t\t// set loading to true if any instruments haven't finished loading\n\t\tlet loading = false\n\t\tfor (const instName in this.instruments) {\n\t\t\tif (!this.instruments[instName].loaded()) {\n\t\t\t\tloading = true\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t\tif (loading) {\n\t\t\tthis.drawMessage(pp, 'Loading instruments...')\n\t\t} else if (this.ws.ready()) {\n\t\t\tif (this.syncing) {\n\t\t\t\tthis.drawMessage(pp, 'Syncing clock with server')\n\t\t\t} else if (!this.transportStarted) {\n\t\t\t\tthis.drawMessage(pp, 'Starting on next downbeat')\n\t\t\t}\n\t\t}\n\t}\n\n\tdrawMessage = (pp: p5, msg: string) => {\n\t\tconst xx = pp.width / 2\n\t\tconst yy = pp.height - 100\n\t\tpp.fill(30, 180).stroke(200, 180).strokeWeight(4)\n\t\tpp.rect(xx - 150, yy - 20, 300, 40)\n\t\tpp.fill(200).stroke(0).strokeWeight(2)\n\t\tpp.textSize(20).textAlign(pp.CENTER, pp.CENTER).textStyle(pp.BOLDITALIC)\n\t\tpp.text(msg, xx, yy)\n\t}\n\n\tmousePressed = (pp: p5) => {\n\t\tif (!this.started) {\n\t\t\tthis.started = true\n\t\t\tTone.start()\n\t\t\tconsole.log('[Sketch #mousePressed] Started Tone')\n\t\t}\n\t\tif (this.instSliders.mousePressed(pp)) {\n\t\t\treturn\n\t\t}\n\t\tthis.loops.mousePressed(pp)\n\t}\n\tmouseReleased = (pp: p5) => {\n\t\tthis.instSliders.mouseReleased(pp)\n\t}\n\n\tkeyboardInputDisabled = () => {\n\t\treturn this.inputs.isFocused() // Ignore keyboard if inputs are focused\n\t}\n\tkeyPressed = (evt: p5) => {\n\t\tif (this.keyboardInputDisabled()) {\n\t\t\treturn\n\t\t}\n\t\tif (evt.keyIsDown(KEYCODE_ESC)) {\n\t\t\tthis.inputs.toggleHelp()\n\t\t\treturn\n\t\t}\n\t\tthis.avatar.keyPressed(evt)\n\t\tthis.loops.keyPressed(evt)\n\t\tthis.inputs.keyPressed(evt)\n\t}\n\tkeyReleased = (evt: p5) => {\n\t\tif (this.keyboardInputDisabled()) {\n\t\t\treturn\n\t\t}\n\t\tthis.avatar.keyReleased(evt)\n\t\tthis.loops.keyReleased(evt)\n\t}\n\n\tupdateUser = (uu: Partial<User>, sendUpdate: boolean = true) => {\n\t\tthis.user = Object.assign(this.user, uu)\n\t\tthis.localStorage.setItem('user', JSON.stringify(this.user))\n\t\tif (sendUpdate) {\n\t\t\tthis.sendUserUpdate()\n\t\t}\n\t\tif (uu.instrument) {\n\t\t\tconst inst = this.instruments[uu.instrument]\n\t\t\tthis.instSliders = inst.ctrls\n\t\t}\n\t}\n\n\t// getUser returns the user matching clientId,\n\t// or this.user if no matching user is found\n\tgetUser = (clientId: number): User => {\n\t\tif (clientId === this.user.clientId) {\n\t\t\treturn this.user\n\t\t}\n\t\tfor (const uu of this.users) {\n\t\t\tif (clientId === uu.clientId) {\n\t\t\t\treturn uu\n\t\t\t}\n\t\t}\n\t\treturn this.user\n\t}\n\n\tgetAvatar = (clientId: number): Avatar | null => {\n\t\tif (clientId === this.user.clientId) {\n\t\t\treturn this.avatar\n\t\t}\n\t\tfor (const aa of this.avatars) {\n\t\t\tif (clientId === aa.user.clientId) {\n\t\t\t\treturn aa\n\t\t\t}\n\t\t}\n\t\treturn null\n\t}\n\tgetAvatarSafe = (clientId: number): Avatar => {\n\t\tconst aa = this.getAvatar(clientId)\n\t\tif (!aa) {\n\t\t\tconsole.warn(\"[Sketch #getAvatarSafe] Can't find avatar for client\", clientId)\n\t\t\treturn this.avatar\n\t\t}\n\t\treturn aa\n\t}\n\n\tsendUserUpdate = () => {\n\t\tconst { conn, ready } = this.ws\n\t\tif (!ready()) {\n\t\t\tconsole.warn(\"[Sketch #sendUserUpdate] Can't send user update, websocket connection is not open\")\n\t\t\treturn\n\t\t}\n\t\tconn.send(userUpdateReq(this.user))\n\t}\n\n\tsendUserXform = (data: UserXform) => {\n\t\tconst { conn, ready } = this.ws\n\t\tif (!ready()) {\n\t\t\tconsole.warn(\"[Sketch #sendUserXform] Can't send user xform, websocket connection is not open\")\n\t\t\treturn\n\t\t}\n\t\tconn.send(userXformReq(data))\n\t}\n\n\tsendUserRequestXforms = () => {\n\t\tconst { conn, ready } = this.ws\n\t\tif (!ready()) {\n\t\t\tconsole.warn(\n\t\t\t\t\"[Sketch #sendUserRequestXforms] Can't request other users' xforms, websocket connection is not open\",\n\t\t\t)\n\t\t\treturn\n\t\t}\n\t\tconn.send(userRequestXformsReq())\n\t}\n\n\tsendUserEvent = (inputName: string, _eventName: string, evt: MidiEvent) => {\n\t\tlet instName = this.user.instrument\n\t\tif (evt.controller) {\n\t\t\t// Hardcode some CC events to control instrument volumes\n\t\t\tswitch (evt.controller.number) {\n\t\t\t\tcase 79: // master volume (local only)\n\t\t\t\t\tTone.Destination.volume.value = (evt.value - 1) * 50\n\t\t\t\t// fallthrough\n\t\t\t\tcase 19: // master mute (local only)\n\t\t\t\t\tTone.Destination.mute = !evt.value\n\t\t\t\t\treturn\n\t\t\t\tcase 117: // record lock (local only)\n\t\t\t\t\tif (evt.value) {\n\t\t\t\t\t\tthis.loops.recLock = !this.loops.recLock\n\t\t\t\t\t}\n\t\t\t\t\treturn\n\t\t\t\tcase 18:\n\t\t\t\tcase 78:\n\t\t\t\t\tinstName = 'metronome'\n\t\t\t\t\tbreak\n\t\t\t\tcase 17:\n\t\t\t\tcase 77:\n\t\t\t\t\tinstName = 'synth'\n\t\t\t\t\tbreak\n\t\t\t\tcase 16:\n\t\t\t\tcase 76:\n\t\t\t\t\tinstName = 'eightOhEight'\n\t\t\t\t\tbreak\n\t\t\t\tcase 15:\n\t\t\t\tcase 75:\n\t\t\t\t\tinstName = 'piano'\n\t\t\t\t\tbreak\n\t\t\t\tdefault:\n\t\t\t\t\t// Commented out for easier deving -- MIDI input always enabled\n\t\t\t\t\t// if (inputName !== this.user.inputDevice) {\n\t\t\t\t\t// \treturn // not a whitelisted CC and not the active device, so don't send\n\t\t\t\t\t// }\n\t\t\t\t\tbreak\n\t\t\t}\n\t\t\t// Commented out for easier deving -- MIDI input always enabled\n\t\t\t// } else {\n\t\t\t// \tif (inputName !== this.user.inputDevice) {\n\t\t\t// \t\treturn\n\t\t\t// \t}\n\t\t}\n\t\tconst off = this.offsetMs()\n\t\tconst uevt = {\n\t\t\tclientId: this.user.clientId,\n\t\t\tinstrument: instName,\n\t\t\tmidiEvent: evt,\n\t\t\ttimestamp: this.nowMs() + off,\n\t\t}\n\t\tif (this.loops.isRecording(this.pp)) {\n\t\t\tthis.loops.loopUserEvent(uevt)\n\t\t}\n\t\tthis._sendUserEvent(uevt)\n\t}\n\n\t_sendUserEvent = (uevt: UserEvent) => {\n\t\tconst { conn, ready } = this.ws\n\t\tif (!ready() || !this.transportStarted) {\n\t\t\t// websocket connection isn't ready, handle event locally\n\t\t\tthis.onUserEvent(uevt)\n\t\t\treturn\n\t\t}\n\t\tconn.send(userEventReq(uevt))\n\t}\n\n\tonUserEvent = (evt: UserEvent) => {\n\t\tconst { clientId, instrument, midiEvent, timestamp } = evt\n\t\tconst { data, channel, kind } = midiEvent\n\t\tconst inst = this.instruments[instrument]\n\t\tif (!inst) {\n\t\t\tconsole.error('[Sketch #onUserEvent] Unable to find instrument', instrument)\n\t\t\treturn\n\t\t}\n\t\tif (!inst.loaded()) {\n\t\t\treturn // don't send events if instrument hasn't finished loading\n\t\t}\n\t\tconst isMetronome = instrument === 'metronome'\n\t\tif (isMetronome && this.syncing) {\n\t\t\treturn // don't handle metronome events until clock has synced\n\t\t}\n\t\tif (!isMetronome && !this.transportStarted) {\n\t\t\treturn // don't handle non-metronome events until the downbeat has been set\n\t\t}\n\t\tconst tt = this.timeGlobalToTone(timestamp)\n\t\tif (tt < 0) {\n\t\t\treturn // Negative tone time, probably just\n\t\t}\n\t\tif (tt - Tone.immediate() < -1) {\n\t\t\tconsole.log(`[Sketch #onUserEvent] Received event ${Tone.immediate() - tt} seconds late`)\n\t\t\treturn\n\t\t}\n\t\tconst avatar = this.getAvatarSafe(clientId)\n\t\tswitch (kind) {\n\t\t\tcase 'noteon': {\n\t\t\t\tconst nn = midiEvent as MidiEventNote\n\t\t\t\tinst.noteon(avatar, tt, nn)\n\t\t\t\tif (isMetronome) {\n\t\t\t\t\tthis.onMetronome(tt, nn.note)\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase 'noteoff': {\n\t\t\t\tconst nn = midiEvent as MidiEventNote\n\t\t\t\tinst.noteoff(avatar, tt, nn)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase 'controlchange': {\n\t\t\t\tconst cc = midiEvent as MidiEventCC\n\t\t\t\tinst.controlchange(avatar, tt, cc)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase 'pitchbend': {\n\t\t\t\tconst pb = midiEvent as MidiEventPitchbend\n\t\t\t\tinst.pitchbend(avatar, tt, pb)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tdefault:\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`[Sketch #onUserEvent] Unhandled MIDI event on channel ${channel}:`,\n\t\t\t\t\tkind,\n\t\t\t\t\tdata,\n\t\t\t\t\tevt,\n\t\t\t\t)\n\t\t\t\tbreak\n\t\t}\n\t}\n\n\tonMetronome = (time: number, note: number) => {\n\t\tif (!this.transportStarted && note === NOTE_METRONOME_DOWN) {\n\t\t\tconsole.log(`[Sketch #onUserEvent] Downbeat synced with server. BPM:`, this._bpmNext)\n\t\t\tthis.transportStarted = true\n\t\t\tthis.inputs.setupInputsBPM()\n\t\t\tthis.setNewDownbeat(time)\n\t\t\treturn\n\t\t}\n\t\tif (note !== NOTE_METRONOME_BPM_CHANGED) {\n\t\t\treturn\n\t\t}\n\t\tconsole.log(\n\t\t\t`[Sketch #onUserEvent] Received new downbeat from server, will update clock in ${(\n\t\t\t\ttime - Tone.immediate()\n\t\t\t).toFixed(1)} seconds`,\n\t\t)\n\t\tTone.Draw.schedule(() => {\n\t\t\tconsole.log(`[Sketch #onUserEvent] BPM updated:`, this._bpmNext)\n\t\t\tthis.setNewDownbeat(time)\n\t\t}, time)\n\t}\n\n\tsetNewDownbeat = (toneTime: number) => {\n\t\tthis.downbeat = this.timeToneToGlobal(toneTime)\n\t\tthis._bpm = this._bpmNext\n\t\tthis.inputs.onClockUpdate({ bpm: this._bpm, clientId: 0 })\n\t\tTone.Transport.bpm.value = this._bpm\n\t}\n\n\tonUsers = (users: User[]) => {\n\t\tfor (const user of users) {\n\t\t\tif (user.clientId === this.user.clientId) {\n\t\t\t\tcontinue // skip local user\n\t\t\t}\n\t\t\tconst prevs = this.users.filter(uu => uu.clientId === user.clientId)\n\t\t\tif (!prevs.length) {\n\t\t\t\tthis.users.push(user)\n\t\t\t\tconst aa = new Avatar({\n\t\t\t\t\tuser: user,\n\t\t\t\t\tpos: newAvatarPos(),\n\t\t\t\t\tscale: new Vec(20),\n\t\t\t\t\tphys: { worldScale },\n\t\t\t\t})\n\t\t\t\tif (user.name === 'the-server') {\n\t\t\t\t\t// Put server far away, really small\n\t\t\t\t\taa.xform.pos = new Vec(worldScale * 4, 31, 0)\n\t\t\t\t\taa.xform.scale = new Vec(3)\n\t\t\t\t\taa.xform.rot.y = Math.PI / 2\n\t\t\t\t}\n\t\t\t\tthis.avatars.push(aa)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tif (prevs.length > 1) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`[Sketch #onUsers] Found more than one user for clientId #${user.clientId}`,\n\t\t\t\t\tuser.clientId,\n\t\t\t\t\tuser.name,\n\t\t\t\t)\n\t\t\t}\n\t\t\t// Update pre-existing user\n\t\t\tconst prev = prevs[0]\n\t\t\tObject.assign(prev, user)\n\t\t}\n\t\tfor (const user of this.users) {\n\t\t\tif (users.some(uu => uu.clientId === user.clientId)) {\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\t// user dropped, remove user and its avatar\n\t\t\tconst aa = this.getAvatar(user.clientId)\n\t\t\tif (aa) {\n\t\t\t\tengine3d.rmObj(aa)\n\t\t\t} else {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`[Sketch #onUsers] Unable to find avatar for dropped user #${user.clientId}`,\n\t\t\t\t\tuser.name,\n\t\t\t\t)\n\t\t\t}\n\t\t\tthis.users = this.users.filter(uu => uu.clientId !== user.clientId)\n\t\t\tthis.avatars = this.avatars.filter(aa => aa.user.clientId !== user.clientId)\n\t\t}\n\t}\n\n\tonUserForce = (evt: UserForce) => {\n\t\tconst { clientId } = evt\n\t\tconst avatar = this.getAvatar(clientId)\n\t\tif (!avatar) {\n\t\t\tconsole.warn('[Sketch #onUserForce] No avatar for user', clientId)\n\t\t\treturn\n\t\t}\n\t\tavatar.setUserForce(evt)\n\t}\n\n\tonUserXform = (evt: UserXform) => {\n\t\tconst { clientId } = evt\n\t\tconst avatar = this.getAvatar(clientId)\n\t\tif (!avatar) {\n\t\t\tconsole.warn('[Sketch #onUserXform] No avatar for user', clientId)\n\t\t\treturn\n\t\t}\n\t\tavatar.setUserXform(evt)\n\t}\n\n\tbpm = () => {\n\t\tif (!this.transportStarted) {\n\t\t\treturn this.inputs.bpm()\n\t\t}\n\t\treturn this._bpm\n\t}\n\tbps = () => this.bpm() / 60\n\tbeatMs = () => 1000.0 / this.bps()\n\tbeatSec = () => 1.0 / this.bps()\n\toffsetMs = () => this.beatMs() * this.user.offset\n\toffsetSec = () => this.beatSec() * this.user.offset\n\tnowMs = () => this.ws.now()\n}\n\nexport const sketch = new Sketch(window)\n","import React, { useEffect, useRef } from 'react'\nimport { sketch } from './Sketch'\n\nconst VideoOutput: React.FC = () => {\n\tconst ref = useRef<HTMLDivElement>(null)\n\tconst msg = useRef<string>(`Loading`)\n\tuseEffect(() => {\n\t\tif (!ref.current) {\n\t\t\tmsg.current = `Internal component error`\n\t\t\tconsole.warn(`[VideoOutput #useEffect] Can't find component reference`)\n\t\t\treturn\n\t\t}\n\t\tconst elem = ref.current as HTMLDivElement\n\t\tif (elem.childNodes[0]) {\n\t\t\telem.removeChild(elem.childNodes[0]) // remove previous sketch\n\t\t}\n\t\tconst { clientWidth, clientHeight } = elem\n\t\tsketch.setSize(clientWidth, clientHeight)\n\t\tconst canvas = new window.p5(sketch.sketch, elem)\n\t\treturn () => {\n\t\t\tsketch.destroy()\n\t\t\tcanvas.remove()\n\t\t\tconsole.log('[VideoOutput #useEffect.return]')\n\t\t}\n\t})\n\treturn (\n\t\t<div\n\t\t\tref={ref}\n\t\t\tstyle={{\n\t\t\t\tdisplay: 'flex',\n\t\t\t\tflex: 1,\n\t\t\t\talignItems: 'center',\n\t\t\t\tjustifyContent: 'center',\n\t\t\t\tcolor: 'white',\n\t\t\t}}\n\t\t>\n\t\t\t{msg.current}\n\t\t</div>\n\t)\n}\n\nexport default VideoOutput\n","import React from 'react'\nimport VideoOutput from './VideoOutput'\n\nimport './App.css'\n\nconst App: React.FC = () => {\n\treturn (\n\t\t<div\n\t\t\tclassName='App'\n\t\t\tstyle={{\n\t\t\t\tdisplay: 'flex',\n\t\t\t\tflexDirection: 'column',\n\t\t\t\tposition: 'absolute',\n\t\t\t\tbackgroundColor: '#383838',\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0,\n\t\t\t\tright: 0,\n\t\t\t\tbottom: 0,\n\t\t\t}}\n\t\t>\n\t\t\t<VideoOutput />\n\t\t</div>\n\t)\n}\n\nexport default App\n"],"sourceRoot":""}