{"version":3,"sources":["app/serverApi/serverApi.ts","app/serverApi/serverClock.ts","app/serverApi/WSClock.ts","index.tsx","app/serverApi/WSClient.ts","app/MIDI.ts","app/Instrument.ts","app/instruments/util.ts","app/instruments/Sampler.ts","app/instruments/EightOhEight.ts","app/instruments/Metronome.ts","app/instruments/Piano.ts","app/instruments/PolySynth.ts","app/VisualNotes.ts","vendor/p5.easycam.js","engine3d/core/Vec.ts","engine3d/core/Bounds.ts","engine3d/core/Xform.ts","engine3d/core/Component.ts","engine3d/core/engine3d.ts","engine3d/core/Obj.ts","engine3d/components/Physical.ts","engine3d/components/FollowCam.ts","engine3d/objs/Avatar.ts","engine3d/objs/Ground.ts","app/SketchInputs.ts","app/SketchAudioKeys.ts","app/Sketch.ts","app/VideoOutput.tsx","app/App.tsx"],"names":["WS_URL","WS_HEADER_END","WS_CLIENT_ID","parseClientId","body","JSON","parse","clientId","WS_USERS_ALL","WS_USER_EVENT","WS_USER_FORCE","WS_USER_XFORM","parseUsersAll","parseUserEvent","parseUserForce","parseUserXform","userUpdateReq","req","stringify","userEventReq","userXformReq","WS_CLOCK_NOW","WS_CLOCK_ORIGIN","WS_CLOCK_UPDATE","clockNowReq","clockUpdateReq","clk","parseClockUpdate","WSClock","global","conn","options","localOrigin","correction","precision","correction2","precision2","lowpass","lastReqAt","lastRespAt","loopId","syncInitial","serverOrigin","precisionNow","syncPeriod","synced","update","readyState","WebSocket","OPEN","nowRaw","send","clearTimeout","this","performance","timeOrigin","setInterval","now","originMs","console","error","nowMs","dur","delta","deltaNow","onSynced","nn","c2gain","perfTime","globalTime","App","require","default","ReactDOM","render","document","getElementById","WSClient","clock","users","reopen","CLOSED","newConn","ready","onclose","evt","code","warn","setTimeout","onopen","log","onerror","onmessage","onMessage","parts","str","sep","out","sepRe","RegExp","prevIndex","lastIndex","re","exec","push","slice","index","split","data","head","onClockOrigin","onClockNow","clkOpts","onClockUpdate","onClientId","filter","uu","onUsers","uevt","onUserEvent","onUserForce","onUserXform","getUser","newMidiEvent","channel","target","number","kind","type","attack","note","_number","release","value","controller","allChannels","Array","keys","map","x","allEvents","MIDI","opts","webMidi","enabled","enable","a","onEnabled","window","WebMidi","inputs","outputs","input","eventName","addListener","name","channels","Instrument","_time","_evt","noteFreq","Tone","toFrequency","Sampler","sampler","pitchShift","panVol","ps","psSpread","noteon","time","triggerAttack","noteoff","triggerRelease","controlchange","num","delayed","pitch","mute","volume","pan","schedule","pitchbend","toDestination","connect","loaded","samps","EightOhEight","sketch","urls","ii","length","baseUrl","eightOhEight","modNote","Metronome","metronome","ground","hue","Math","random","sat","bgCol","pianoSamps","A0","C1","A1","C2","A2","C3","A3","C4","A4","C5","A5","C6","A6","C7","A7","C8","Piano","PolySynth","synth","filterVol","reverb","setFilterGain","db","set","gain","min","vv","frequency","Q","updatePitchbend","key","envelope","detune","decay","wet","oscillator","count","spread","sustain","VisualNote","avatar","age","released","firstUpdate","ageReleased","y","velx","vely","young","health","youngDur","fadeOut","radius","radiusOrig","isDead","pg","others","pos","xform","ux","uy","z","max","other","dx","dy","ddx","ddy","sx","sy","dd","sqrt","cc","close","outerDist","instrument","draw","pp","colorMode","HSL","midiEvent","size","fill","square","lgt","circle","RGB","aa","VisualNotes","notes","isSameNote","forEach","perspective","PI","width","height","clear","noStroke","translate","rotateX","pop","ext","INFO","LIBRARY","VERSION","AUTHOR","SOURCE","toString","EasyCam","renderer","args","p5","RendererGL","undefined","distance","center","rotation","Rotation","identity","viewport","setCanvas","cam","LOOK","UP","AXIS","YAW","PITCH","ROLL","ALL","SHIFT_CONSTRAINT","FIXED_CONSTRAINT","DRAG_CONSTRAINT","scale_rotation","scale_pan","scale_zoom","scale_zoomwheel","distance_min_limit","distance_min","distance_max","Number","MAX_VALUE","state","copy","dst","state_reset","state_pushed","mouse","curr","prev","dist","mwheel","isPressed","istouchdown","ismousedown","BUTTON","LMB","MMB","RMB","button","mouseDragLeft","mouseDragRotate","bind","mouseDragCenter","mouseDragPan","mouseDragRight","mouseDragZoom","mouseWheelAction","mouseWheelZoom","touchmoveSingle","touchmoveMulti","insideViewport","x0","x1","y0","y1","solveConstraint","shiftKey","abs","updateInput","pd","P5","pixelDensity","mousedown","event","mousedrag","mouseX","mouseY","mouseup","dblclick","reset","wheel","deltaY","evaluateTouches","i","touches","avg_x","avg_y","avg_d","clientX","clientY","touchstart","preventDefault","stopPropagation","dbltap","touchmove","tapcount","touchend","keydown","keyCode","keyup","attachMouseListeners","auto_update","registerMethod","dampedZoom","DampedAction","d","zoom","getZoomMult","dampedPanX","panX","getPanMult","dampedPanY","panY","dampedPanZ","panZ","dampedRotX","getRotationMult","dampedRotY","rotateY","dampedRotZ","rotateZ","timedRot","Interpolation","setInterpolatedRotation","timedPan","setInterpolatedCenter","timedzoom","setInterpolatedDistance","_pInst","graphics","el","ev","fx","op","detachListener","addEventListener","removeEventListener","passive","elt","attachListener","status","b_update","stop","apply","camEYE","getPosition","camLAT","getCenter","camRUP","getUpVector","_curCamera","camera","addForce","mx","my","mxNdc","myNdc","pow","log10","dz","distance_tmp","val","applyToVec3","Vec3","add","ca","centerAxes","mult","screenX","mX","mag","screenZ","cross","rx","rotate","ry","rz","axis","angle","new_rotation","create","applyToRotation","valA","valB","t","Scalar","mix","smoothstep","slerp","duration","start","assert","setDistance","setCenter","setRotation","getState","setState","wheelScale","damping","default_duration","yaw","roll","w","h","pushed_rendererState","gl","drawingContext","ww","hh","flush","disable","DEPTH_TEST","pushed_uMVMatrix","uMVMatrix","pushed_uPMatrix","uPMatrix","resetMatrix","ortho","cb","action","force","active","actions","timer","Date","getTime","interpolate","constructor","rot","vec","q0","q1","q2","q3","s","rotA","rotB","a0","a1","a2","a3","b0","b1","b2","b3","cosTheta","w1","w2","theta","acos","sinTheta","sin","normalize","def","norm","halfAngle","coeff","cos","inv","angles_xyz","ax","ay","az","rotX","rotY","rotZ","b","smootherstep","isScalar","arg","magSq","dot","v1","v2","normProduct","threshold","v3","asin","Object","freeze","Vec","clone","cloneMult","applyMult","cloneAdd","applyAdd","cloneSub","applySub","isZero","isOne","isEqual","toArray","setFromArray","vals","cloneMultMat","mat","dest","EPSILON","Vector","Bounds","cloneXform","applyXform","applyTo","sanitize","tmp","pushInside","off","centerAndSize","Xform","scale","Component","parent","drawDebug","_dt","engine3d","objs","debug","lastUpdate","addObj","obj","rmObj","oo","destroy","valueOf","dt","draw2D","gg","mvp","_renderer","mat4","Obj","comps","drawFunc","drawFunc2D","rm","addComp","comp","rmComponent","getComps","compType","getComp","cs","applyXformToGraphics","ndcPos","ndcPos2","ndcPos3","ndcPos4","ndc","scale2d","gravity","Physical","vel","bounds","world","worldBounds","noFill","stroke","strokeWeight","box","worldScale","FollowCam","last","Avatar","phys","user","followCam","onForce","up","down","left","right","jump","jumpInitial","sphere","render2D","offset","ss","textAlign","CENTER","BOTTOM","textSize","textStyle","BOLD","text","ITALIC","addFollowCam","getUserXform","setUserXform","setUserForce","keyPressed","keyChanged","keyReleased","pressed","keysUpdated","mov","cax","caz","ff","Ground","subDF","angleMode","RADIANS","rect","SketchInputs","nameCustomized","hidden","clockOpts","bpm","isFocused","focused","toggleHide","setup","setupInputsBPM","remove","setupInputsHide","setupInputsUser","ws","setupInputsInstrument","inputDevice","setupInputsMidi","midi","hide","inHide","createButton","position","mousePressed","defaultName","updateUser","inName","createInput","onfocus","onblur","focus","select","inOffset","setOffset","parseFloat","isNaN","inInst","createSelect","uinst","instName","instruments","option","selected","changed","inMidi","_midiInput","inBPM","createSlider","sendClockUpdate","LEFT","xx","yy","msg","toUpperCase","SketchAudioKeys","audioKeys","velocity","keyboardInputDisabled","midiEvt","sendUserEvent","AudioKeys","polyphony","Infinity","newAvatarPos","rr","Sketch","_global","visualNotes","started","syncing","avatars","timeGlobalToTone","rawContext","_nativeAudioContext","getOutputTimestamp","contextTime","performanceTime","toLocal","timeToneToGlobal","toneTime","pt","toGlobal","setSize","createCanvas","createGraphics","setDistanceMin","setDistanceMax","setViewport","loading","background","image","drawMessage","BOLDITALIC","sendUpdate","assign","sendUserUpdate","getAvatar","sendUserXform","inputName","_eventName","timestamp","offsetMs","prevs","some","inst","tt","pb","bps","piano","me","VideoOutput","ref","useRef","sk","useEffect","current","elem","childNodes","removeChild","clientWidth","clientHeight","skObj","style","display","flex","alignItems","justifyContent","color","className","flexDirection","backgroundColor","top","bottom"],"mappings":"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","file":"static/js/main.cc618c8b.chunk.js","sourcesContent":["import { MidiEvent } from '../MIDI'\n\nexport const WS_URL = 'ws://localhost:38883'\n// export const WS_URL = 'wss://mikeylemmon.com/api'\nexport const WS_HEADER_END = '#'\n\n//\n// Client API\n//\nexport const WS_CLIENT_ID = 'client/id'\nexport type ClientIdResp = { clientId: number }\n\nexport function parseClientId(body: string): number {\n\tconst resp: ClientIdResp = JSON.parse(body)\n\treturn resp.clientId\n}\n\n//\n// Users API\n//\nexport const WS_USERS_ALL = 'user/all'\nexport const WS_USER_UPDATE = 'user/update'\nexport const WS_USER_EVENT = 'user/event'\nexport const WS_USER_FORCE = 'user/force'\nexport const WS_USER_XFORM = 'user/xform'\n\nexport type User = {\n\tclientId: number\n\tname: string\n\tinstrument: string\n\tinputDevice: string\n\toffset: number\n}\n\nexport type UserEvent = {\n\tclientId: number\n\tinstrument: string\n\tmidiEvent: MidiEvent\n\ttimestamp: number\n}\n\nexport type UserForce = {\n\tclientId: number\n\tforce: number[]\n}\n\nexport type UserXform = {\n\tclientId: number\n\tpos: number[]\n\trot: number[]\n\tscale: number[]\n\tforce: number[]\n\tvel: number[]\n}\n\nexport function parseUsersAll(body: string): User[] {\n\tconst resp: User[] = JSON.parse(body)\n\treturn resp\n}\nexport function parseUserEvent(body: string): UserEvent {\n\tconst resp: UserEvent = JSON.parse(body)\n\treturn resp\n}\nexport function parseUserForce(body: string): UserForce {\n\tconst resp: UserForce = JSON.parse(body)\n\treturn resp\n}\nexport function parseUserXform(body: string): UserXform {\n\tconst resp: UserXform = JSON.parse(body)\n\treturn resp\n}\n\nexport function userUpdateReq(req: User): string {\n\treturn WS_USER_UPDATE + WS_HEADER_END + JSON.stringify(req)\n}\nexport function userEventReq(req: UserEvent): string {\n\treturn WS_USER_EVENT + WS_HEADER_END + JSON.stringify(req)\n}\nexport function userForceReq(req: UserForce): string {\n\treturn WS_USER_FORCE + WS_HEADER_END + JSON.stringify(req)\n}\nexport function userXformReq(req: UserXform): string {\n\treturn WS_USER_XFORM + WS_HEADER_END + JSON.stringify(req)\n}\n","import { WS_HEADER_END } from './serverApi'\n\nexport const WS_CLOCK_NOW = 'clock/now'\nexport const WS_CLOCK_ORIGIN = 'clock/origin'\nexport const WS_CLOCK_UPDATE = 'clock/update'\n\nexport type ClockNowResp = { nowMs: number }\nexport type ClockOriginResp = { originMs: number }\nexport type ClockOpts = { bpm: number }\n\nexport const clockNowReq = () => WS_CLOCK_NOW + WS_HEADER_END\nexport const clockUpdateReq = (clk: ClockOpts) => WS_CLOCK_UPDATE + WS_HEADER_END + JSON.stringify(clk)\n\nexport function parseClockUpdate(body: string): ClockOpts {\n\tconst resp: ClockOpts = JSON.parse(body)\n\treturn resp\n}\n","import { clockNowReq, ClockNowResp, ClockOriginResp } from './serverClock'\n\nconst SYNC_PERIOD_INITIAL_MS = 500,\n\tSYNC_INITIAL_NUM = 6, // number of times to use initial period\n\tSYNC_PERIOD_MS = 2000\n\nexport type WSClockOptions = {\n\tonSynced: () => void\n}\n\nexport default class WSClock {\n\tglobal: any\n\tconn: WebSocket\n\tlocalOrigin: number\n\tcorrection = 0 // a correction to apply to the local clock based on rolling-average deviation from server clock\n\tprecision = 0 // average of how accurate the workerClock is with correction applied\n\tcorrection2 = 0 // a derivative correction that accounts for linear clock deviation (i.e. local clock is X slower/faster than server)\n\tprecision2 = 0 // measures how accurate the workerClock is with correction and correction2 applied\n\tlowpass = 0.3 // how much latest sample affects correction/precision\n\tlastReqAt = 0\n\tlastRespAt = 0\n\tloopId = -1\n\tsyncInitial = 0\n\tserverOrigin = 0\n\tprecisionNow = 0\n\tsyncPeriod = SYNC_PERIOD_INITIAL_MS\n\tsynced = false\n\toptions: Partial<WSClockOptions>\n\n\tconstructor(global: any, conn: WebSocket, options: Partial<WSClockOptions> = {}) {\n\t\tthis.global = global\n\t\tthis.options = options\n\t\t// this.localOrigin = global.performance.timing.navigationStart\n\t\tthis.localOrigin = global.performance.timeOrigin\n\t\tthis.conn = conn\n\t\tthis.loopId = global.setInterval(this.update, this.syncPeriod)\n\t}\n\n\tnowRaw() {\n\t\treturn global.performance.now()\n\t}\n\n\tupdate = () => {\n\t\tif (this.conn.readyState !== WebSocket.OPEN) {\n\t\t\tthis.global.clearTimeout(this.loopId)\n\t\t\treturn\n\t\t}\n\t\tthis.lastReqAt = this.nowRaw()\n\t\tthis.conn.send(clockNowReq())\n\t}\n\n\tonClockOrigin(body: string) {\n\t\tconst resp: ClockOriginResp = JSON.parse(body)\n\t\tconst { originMs } = resp\n\t\tif (!originMs) {\n\t\t\tconsole.error('[workerClock #onClockOrigin] Received empty response')\n\t\t\treturn\n\t\t}\n\t\tthis.serverOrigin = originMs\n\t}\n\n\tonClockNow(body: string) {\n\t\tconst resp: ClockNowResp = JSON.parse(body)\n\t\tconst { nowMs } = resp || {}\n\t\tif (!nowMs) {\n\t\t\tconsole.error('[workerClock #onClockNow] Received empty response')\n\t\t\treturn\n\t\t}\n\t\tthis.lastRespAt = this.nowRaw()\n\t\tconst dur = this.lastRespAt - this.lastReqAt\n\t\tconst mid = dur / 2 + this.lastReqAt\n\t\tconst delta = nowMs - mid\n\t\tif (this.correction === 0) {\n\t\t\tthis.correction = delta\n\t\t} else {\n\t\t\tthis.correction = delta * this.lowpass + this.correction * (1 - this.lowpass)\n\t\t}\n\t\tconst precision = delta - this.correction\n\t\tif (this.precision === 0) {\n\t\t\tthis.precision = precision\n\t\t} else {\n\t\t\tthis.precision = precision * this.lowpass + this.precision * (1 - this.lowpass)\n\t\t}\n\t\t// Calculate a secondary correction based on the average value of precision to account\n\t\t// for the local clock being consistently slower/faster than the server clock\n\t\tthis.correction2 = this.precision * this.lowpass + this.correction2 * (1 - this.lowpass)\n\t\tconst precision2 = delta - this.correction - this.correction2\n\t\tif (this.precision2 === 0) {\n\t\t\tthis.precision2 = precision2\n\t\t} else {\n\t\t\tthis.precision2 = precision2 * this.lowpass + this.precision2 * (1 - this.lowpass)\n\t\t}\n\n\t\t// Calculate precision metrics for corrected \"now\" time\n\t\tconst now = this.now() - dur / 2\n\t\tconst deltaNow = now - nowMs\n\t\tthis.precisionNow = deltaNow * this.lowpass + this.precisionNow * (1 - this.lowpass)\n\n\t\t// console.log(\n\t\t// \t'[workerClock #onClockNow]',\n\t\t// \t{\n\t\t// \t\tp: this.precision,\n\t\t// \t\tp2: this.precision2,\n\t\t// \t\tc: this.correction,\n\t\t// \t\tc2: this.correction2,\n\t\t// \t},\n\t\t// \t{\n\t\t// \t\tlastP: precision,\n\t\t// \t\tlastP2: precision2,\n\t\t// \t\tdur,\n\t\t// \t},\n\t\t// \t{\n\t\t// \t\tnow: now,\n\t\t// \t\tnowMs: nowMs,\n\t\t// \t\td: deltaNow,\n\t\t// \t\tpnow: this.precisionNow,\n\t\t// \t},\n\t\t// \t{\n\t\t// \t\tnowOverP: this.precisionNow / this.precision2,\n\t\t// \t},\n\t\t// )\n\n\t\tif (!this.synced && this.syncInitial++ > SYNC_INITIAL_NUM) {\n\t\t\t// Replace sync loop with lower-frequency interval\n\t\t\tthis.synced = true\n\t\t\tthis.global.clearTimeout(this.loopId)\n\t\t\t// this.correction2 *= SYNC_PERIOD_MS / SYNC_PERIOD_INITIAL_MS\n\t\t\tthis.correction += this.correction2\n\t\t\tthis.syncPeriod = SYNC_PERIOD_MS\n\t\t\tthis.loopId = this.global.setInterval(this.update, this.syncPeriod)\n\t\t\tif (this.options.onSynced) {\n\t\t\t\tthis.options.onSynced()\n\t\t\t}\n\t\t}\n\t}\n\n\tnow() {\n\t\tconst nn = this.nowRaw()\n\t\tconst c2gain = 1 + (nn - this.lastRespAt) / this.syncPeriod\n\t\treturn nn + this.correction + this.correction2 * c2gain\n\t}\n\n\ttoGlobal(perfTime: number) {\n\t\treturn perfTime + this.correction + this.correction2\n\t}\n\n\ttoLocal(globalTime: number) {\n\t\treturn globalTime - this.correction - this.correction2\n\t}\n}\n","import React from 'react'\nimport ReactDOM from 'react-dom'\nimport 'index.css'\n\nconst render = () => {\n\tconst App = require('app/App').default\n\n\tReactDOM.render(<App />, document.getElementById('root'))\n}\n\nrender()\n\nif (process.env.NODE_ENV === 'development' && module.hot) {\n\tmodule.hot.accept('./app/App', render)\n}\n","import {\n\tparseClientId,\n\tparseUsersAll,\n\tparseUserEvent,\n\tparseUserForce,\n\tparseUserXform,\n\tUser,\n\tUserEvent,\n\tUserForce,\n\tUserXform,\n\tWS_CLIENT_ID,\n\tWS_HEADER_END,\n\tWS_URL,\n\tWS_USERS_ALL,\n\tWS_USER_EVENT,\n\tWS_USER_FORCE,\n\tWS_USER_XFORM,\n} from './serverApi'\nimport { parseClockUpdate, ClockOpts, WS_CLOCK_NOW, WS_CLOCK_ORIGIN, WS_CLOCK_UPDATE } from './serverClock'\nimport WSClock, { WSClockOptions } from './WSClock'\n\nexport const DONT_REOPEN = 888\n\nexport type WSClientOptions = {\n\tclock: Partial<WSClockOptions>\n\tonClientId: (clientId: number) => any\n\tonClockUpdate: (clkOpts: ClockOpts) => void\n\tonUsers: (users: User[]) => void\n\tonUserEvent: (evt: UserEvent) => void\n\tonUserForce: (evt: UserForce) => void\n\tonUserXform: (evt: UserXform) => void\n}\n\nexport default class WSClient {\n\tconn: WebSocket\n\tclock: WSClock\n\tglobal: any\n\toptions: WSClientOptions\n\tclientId: number = 0\n\tusers: User[] = []\n\n\tconstructor(global: any, options: WSClientOptions) {\n\t\tthis.global = global\n\t\tthis.options = options as WSClientOptions\n\t\tthis.conn = this.newConn()\n\t\tthis.clock = new WSClock(this.global, this.conn, this.options.clock)\n\t}\n\n\treopen = () => {\n\t\t// Try to re-open the websocket connection if it has closed\n\t\tif (this.conn.readyState !== WebSocket.CLOSED) {\n\t\t\treturn\n\t\t}\n\t\tthis.conn = this.newConn()\n\t}\n\n\tready = () => this.conn && this.conn.readyState === WebSocket.OPEN\n\n\tnewConn = (): WebSocket => {\n\t\tconst conn = new WebSocket(WS_URL)\n\t\tconn.onclose = (evt: CloseEvent) => {\n\t\t\tif (evt.code === DONT_REOPEN) {\n\t\t\t\tconsole.warn('Closing for good', evt)\n\t\t\t\treturn\n\t\t\t}\n\t\t\tconsole.warn('WebSocket closed, will attempt to reopen in a few seconds', evt)\n\t\t\tsetTimeout(this.reopen, 5000)\n\t\t}\n\t\tconn.onopen = (evt: Event) => {\n\t\t\tconsole.log('WebSocket opened', evt)\n\t\t\tthis.clock = new WSClock(this.global, this.conn, this.options.clock)\n\t\t}\n\t\tconn.onerror = (evt: Event) => {\n\t\t\tconsole.error('WebSocket error', evt)\n\t\t}\n\t\tconn.onmessage = this.onMessage\n\t\treturn conn\n\t}\n\n\tonMessage = (evt: MessageEvent) => {\n\t\tconst parts = split(evt.data, WS_HEADER_END, 1)\n\t\tconst [head, body] = parts\n\t\tswitch (head) {\n\t\t\tcase WS_CLOCK_NOW:\n\t\t\tcase WS_CLOCK_ORIGIN:\n\t\t\t\tif (!this.clock) {\n\t\t\t\t\tconsole.error('[WSClient #onMessage] No local clock ready to handle server clock message')\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tif (head === WS_CLOCK_ORIGIN) {\n\t\t\t\t\tthis.clock.onClockOrigin(body)\n\t\t\t\t} else {\n\t\t\t\t\tthis.clock.onClockNow(body)\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase WS_CLOCK_UPDATE:\n\t\t\t\tconst clkOpts = parseClockUpdate(body)\n\t\t\t\tthis.options.onClockUpdate(clkOpts)\n\t\t\t\tconsole.log('[WSClient #onMessage] Received clockUpdate', clkOpts)\n\t\t\t\tbreak\n\t\t\tcase WS_CLIENT_ID:\n\t\t\t\tthis.clientId = parseClientId(body)\n\t\t\t\tconsole.log('[WSClient #onMessage] Received clientId', this.clientId)\n\t\t\t\tthis.options.onClientId(this.clientId)\n\t\t\t\tbreak\n\t\t\tcase WS_USERS_ALL:\n\t\t\t\tthis.users = parseUsersAll(body).filter(uu => !!uu)\n\t\t\t\tconsole.log('[WSClient #onMessage] Received users', this.users)\n\t\t\t\tthis.options.onUsers(this.users)\n\t\t\t\tbreak\n\t\t\tcase WS_USER_EVENT: {\n\t\t\t\tconst uevt = parseUserEvent(body)\n\t\t\t\t// console.log('[WSClient #onMessage] Received user event', uevt)\n\t\t\t\tthis.options.onUserEvent(uevt)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase WS_USER_FORCE: {\n\t\t\t\tconst uevt = parseUserForce(body)\n\t\t\t\t// console.log('[WSClient #onMessage] Received user event', uevt)\n\t\t\t\tthis.options.onUserForce(uevt)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase WS_USER_XFORM: {\n\t\t\t\tconst uevt = parseUserXform(body)\n\t\t\t\t// console.log('[WSClient #onMessage] Received user event', uevt)\n\t\t\t\tthis.options.onUserXform(uevt)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tdefault:\n\t\t\t\tconsole.log('[WSClient #onMessage] Unhandled message', { head, body, parts }, evt)\n\t\t\t\tbreak\n\t\t}\n\t}\n\n\tnow = (): number => {\n\t\tif (!this.clock) {\n\t\t\tconsole.error('[WSClient #now] No clock!')\n\t\t\treturn -1\n\t\t}\n\t\treturn this.clock.now()\n\t}\n\n\tgetUser = (clientId: number) => {\n\t\tfor (const uu of this.users) {\n\t\t\tif (uu.clientId === clientId) {\n\t\t\t\treturn uu\n\t\t\t}\n\t\t}\n\t}\n}\n\n// split function with remainder\n// via https://stackoverflow.com/questions/874709/converting-user-input-string-to-regular-expression\nfunction split(str: string, sep: string, nn: number) {\n\tconst out: string[] = []\n\tconst sepRe = new RegExp(sep, 'g')\n\twhile (nn--) {\n\t\tconst prevIndex = sepRe.lastIndex\n\t\tconst re = sepRe.exec(str)\n\t\tif (!re) {\n\t\t\tbreak\n\t\t}\n\t\tout.push(str.slice(prevIndex, re.index))\n\t}\n\tout.push(str.slice(sepRe.lastIndex))\n\treturn out\n}\n","type FieldsShared = {\n\tdata: number[]\n\tchannel: number\n\tkind: string\n}\n\ntype FieldsNote = {\n\tattack?: number\n\tnote: number\n\trelease?: number\n}\n\ntype FieldsCC = {\n\tvalue: number // 0 - 1 (data[2])\n\tcontroller: {\n\t\tnumber: number // (data[1])\n\t\tname: string\n\t}\n}\n\ntype FieldsPitchbend = {\n\tvalue: number // 0 - 1 (data[2])\n}\n\nexport type MidiEventNote = FieldsShared & FieldsNote\nexport type MidiEventCC = FieldsShared & FieldsCC\nexport type MidiEventPitchbend = FieldsShared & FieldsPitchbend\nexport type MidiEvent = FieldsShared & FieldsCC & FieldsNote & FieldsPitchbend\nexport function newMidiEvent(evt: any): MidiEvent {\n\treturn {\n\t\tdata: evt.data,\n\t\tchannel: evt.target.number,\n\t\tkind: evt.type,\n\t\tattack: evt.attack,\n\t\tnote: evt.note && evt.note._number,\n\t\trelease: evt.release,\n\t\tvalue: evt.value,\n\t\tcontroller: evt.controller,\n\t}\n}\n\nconst allChannels = [...Array(16).keys()].map(x => x + 1) // Array of numbers 1 thru 16\nconst allEvents = ['controlchange', 'noteoff', 'noteon', 'pitchbend'] // 'keyaftertouch',\n\ntype MIDIOptions = {\n\tonMessage: (inputName: string, eventName: string, evt: MidiEvent) => void\n\tonEnabled?: (webMidi: any) => void\n}\n\nexport default class MIDI {\n\twebMidi: any | null = null\n\tenabled: boolean = false\n\n\tconstructor(opts: MIDIOptions) {\n\t\tthis.enable(opts)\n\t}\n\n\tenable = async (opts: MIDIOptions) => {\n\t\tconst { onMessage, onEnabled } = opts\n\t\tconst { WebMidi } = window\n\t\ttry {\n\t\t\tawait WebMidi.enable()\n\t\t} catch (err) {\n\t\t\tconsole.error('[MIDI #enable] Failed to enable MIDI', err)\n\t\t\treturn\n\t\t}\n\t\tthis.webMidi = WebMidi\n\t\tthis.enabled = true\n\t\tconst { inputs, outputs } = this.webMidi\n\t\tconsole.log('[MIDI #enable] inputs', inputs)\n\t\tconsole.log('[MIDI #enable] outputs', outputs)\n\t\tif (onEnabled) {\n\t\t\tonEnabled(this.webMidi)\n\t\t}\n\t\tfor (const input of inputs) {\n\t\t\tfor (const eventName of allEvents) {\n\t\t\t\tinput.addListener(\n\t\t\t\t\teventName,\n\t\t\t\t\t(evt: any) => onMessage(input.name, eventName, newMidiEvent(evt)),\n\t\t\t\t\t{\n\t\t\t\t\t\tchannels: allChannels,\n\t\t\t\t\t},\n\t\t\t\t)\n\t\t\t}\n\t\t}\n\t}\n}\n","import { MidiEventCC, MidiEventNote, MidiEventPitchbend } from './MIDI'\n\nexport class Instrument {\n\tloaded() {\n\t\treturn false\n\t}\n\tnoteon(_time: number, _evt: MidiEventNote) {}\n\tnoteoff(_time: number, _evt: MidiEventNote) {}\n\tcontrolchange(_time: number, _evt: MidiEventCC) {}\n\tpitchbend(_time: number, _evt: MidiEventPitchbend) {}\n}\n","import * as Tone from 'tone'\n\nexport function noteFreq(note: number) {\n\treturn Tone.Frequency(note, 'midi').toFrequency()\n}\n","import * as Tone from 'tone'\nimport { MidiEventCC, MidiEventNote, MidiEventPitchbend } from '../MIDI'\nimport { Instrument } from '../Instrument'\nimport { noteFreq } from './util'\n\nexport class Sampler extends Instrument {\n\tsampler: Tone.Sampler\n\tpitchShift: Tone.PitchShift\n\tpanVol: Tone.PanVol\n\tps = 0\n\tpsSpread = 7\n\n\tconstructor(sampler: Tone.Sampler) {\n\t\tsuper()\n\t\tthis.panVol = new Tone.PanVol(0, 0).toDestination()\n\t\tthis.pitchShift = new Tone.PitchShift().connect(this.panVol)\n\t\tthis.sampler = sampler.connect(this.pitchShift)\n\t}\n\n\tloaded() {\n\t\treturn this.sampler.loaded\n\t}\n\n\tnoteon = (time: number, evt: MidiEventNote) => {\n\t\tthis.sampler.triggerAttack(noteFreq(evt.note), time, evt.attack)\n\t}\n\tnoteoff = (time: number, evt: MidiEventNote) => {\n\t\tthis.sampler.triggerRelease(noteFreq(evt.note), time)\n\t}\n\tcontrolchange = (time: number, evt: MidiEventCC) => {\n\t\tconst num = evt.controller.number\n\t\tlet delayed: (() => void) | null = null\n\t\tswitch (true) {\n\t\t\tcase num === 1:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.psSpread = evt.value * 12\n\t\t\t\t\tthis.pitchShift.pitch = this.ps * this.psSpread\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase 75 <= num && num <= 79:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.panVol.mute = !evt.value\n\t\t\t\t\tthis.panVol.volume.value = (evt.value - 1) * 50\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase 15 <= num && num <= 19:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.panVol.mute = !evt.value\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase num === 28:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.panVol.pan.value = evt.value * 2 - 1\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tdefault:\n\t\t\t\tconsole.log(\n\t\t\t\t\t`[Sampler #controlchange] Unsupported CC event on channel ${evt.channel}:`,\n\t\t\t\t\tevt.controller,\n\t\t\t\t\tevt.value,\n\t\t\t\t)\n\t\t}\n\t\tif (delayed) {\n\t\t\tTone.Draw.schedule(delayed, time)\n\t\t}\n\t}\n\tpitchbend = (time: number, evt: MidiEventPitchbend) => {\n\t\tTone.Draw.schedule(() => {\n\t\t\tthis.ps = evt.value\n\t\t\tthis.pitchShift.pitch = this.ps * this.psSpread\n\t\t}, time)\n\t}\n}\n","import * as Tone from 'tone'\nimport { Sampler } from './Sampler'\nimport { MidiEventNote } from '../MIDI'\nimport { noteFreq } from './util'\nimport Sketch from '../Sketch'\n\nconst samps = [\n\t'BD0010.WAV',\n\t'BD0050.WAV',\n\t// 'BD0025.WAV',\n\t// 'BD0075.WAV',\n\t'SD7510.WAV',\n\t'CP.WAV',\n\t// 'SD7550.WAV',\n\t// 'SD7500.WAV',\n\t// 'SD7525.WAV',\n\t'CH.WAV',\n\t'OH10.WAV',\n\t'LT00.WAV',\n\t'MT00.WAV',\n\t'HT00.WAV',\n\t'LC00.WAV',\n\t'MC00.WAV',\n\t'HC00.WAV',\n\t'CB.WAV',\n\t'CY0075.WAV',\n\t// 'CY1000.WAV',\n\t'MA.WAV',\n\t'RS.WAV',\n\t// 'CL.WAV',\n]\n\nfunction eightOhEight() {\n\tconst urls: { [key: number]: string } = {}\n\tfor (let ii = 0; ii < samps.length; ++ii) {\n\t\turls[ii] = samps[ii % samps.length]\n\t}\n\treturn new Tone.Sampler({\n\t\turls,\n\t\trelease: 1,\n\t\tbaseUrl: '/samples/808/',\n\t})\n}\n\nexport class EightOhEight extends Sampler {\n\tsketch: Sketch\n\n\tconstructor(sketch: Sketch) {\n\t\tsuper(eightOhEight())\n\t\tthis.sketch = sketch\n\t}\n\n\tmodNote(note: number) {\n\t\treturn (note + 12) % samps.length\n\t}\n\n\tnoteon = (time: number, note: MidiEventNote) => {\n\t\tlet nn = this.modNote(note.note)\n\t\tthis.sampler.triggerAttack(noteFreq(nn), time, note.attack)\n\t}\n\n\tnoteoff = (time: number, note: MidiEventNote) => {\n\t\tlet nn = this.modNote(note.note)\n\t\tthis.sampler.triggerRelease(noteFreq(nn), time)\n\t}\n}\n","import * as Tone from 'tone'\nimport { Sampler } from './Sampler'\nimport { MidiEventNote } from '../MIDI'\nimport { noteFreq } from './util'\nimport Sketch from '../Sketch'\n\nconst samps = ['MA.WAV', 'RS.WAV']\n\nfunction metronome() {\n\tconst urls: { [key: number]: string } = {}\n\tfor (let ii = 0; ii < samps.length; ++ii) {\n\t\turls[ii] = samps[ii % samps.length]\n\t}\n\treturn new Tone.Sampler({\n\t\turls,\n\t\trelease: 1,\n\t\tbaseUrl: '/samples/808/',\n\t})\n}\n\nexport class Metronome extends Sampler {\n\tsketch: Sketch\n\n\tconstructor(sketch: Sketch) {\n\t\tsuper(metronome())\n\t\tthis.sketch = sketch\n\t}\n\n\tmodNote(note: number) {\n\t\treturn note % samps.length\n\t}\n\n\tnoteon = (time: number, note: MidiEventNote) => {\n\t\tlet nn = this.modNote(note.note)\n\t\tthis.sampler.triggerAttack(noteFreq(nn), time, note.attack)\n\t\tif (nn % samps.length === 0) {\n\t\t\t// Update ground color on down beat\n\t\t\tTone.Draw.schedule(() => {\n\t\t\t\tthis.sketch.ground.hue = Math.random()\n\t\t\t\tthis.sketch.ground.sat = Math.random() * 0.4 + 0.5\n\t\t\t}, time)\n\t\t} else {\n\t\t\t// Update sky color on other beats\n\t\t\tTone.Draw.schedule(() => {\n\t\t\t\tthis.sketch.bgCol.hue = Math.random()\n\t\t\t\tthis.sketch.bgCol.sat = Math.random() * 0.4 + 0.5\n\t\t\t}, time)\n\t\t}\n\t}\n\n\tnoteoff = (time: number, note: MidiEventNote) => {\n\t\tlet nn = this.modNote(note.note)\n\t\tthis.sampler.triggerRelease(noteFreq(nn), time)\n\t}\n}\n","import * as Tone from 'tone'\nimport { Sampler } from './Sampler'\n\nconst pianoSamps = {\n\tA0: 'A0.mp3',\n\tC1: 'C1.mp3',\n\t'D#1': 'Ds1.mp3',\n\t'F#1': 'Fs1.mp3',\n\tA1: 'A1.mp3',\n\tC2: 'C2.mp3',\n\t'D#2': 'Ds2.mp3',\n\t'F#2': 'Fs2.mp3',\n\tA2: 'A2.mp3',\n\tC3: 'C3.mp3',\n\t'D#3': 'Ds3.mp3',\n\t'F#3': 'Fs3.mp3',\n\tA3: 'A3.mp3',\n\tC4: 'C4.mp3',\n\t'D#4': 'Ds4.mp3',\n\t'F#4': 'Fs4.mp3',\n\tA4: 'A4.mp3',\n\tC5: 'C5.mp3',\n\t'D#5': 'Ds5.mp3',\n\t'F#5': 'Fs5.mp3',\n\tA5: 'A5.mp3',\n\tC6: 'C6.mp3',\n\t'D#6': 'Ds6.mp3',\n\t'F#6': 'Fs6.mp3',\n\tA6: 'A6.mp3',\n\tC7: 'C7.mp3',\n\t'D#7': 'Ds7.mp3',\n\t'F#7': 'Fs7.mp3',\n\tA7: 'A7.mp3',\n\tC8: 'C8.mp3',\n}\n\nfunction piano() {\n\treturn new Tone.Sampler({\n\t\turls: pianoSamps,\n\t\trelease: 1,\n\t\tbaseUrl: 'https://tonejs.github.io/audio/salamander/',\n\t})\n}\n\nexport class Piano extends Sampler {\n\tconstructor() {\n\t\tsuper(piano())\n\t}\n}\n","import * as Tone from 'tone'\nimport { MidiEventCC, MidiEventNote, MidiEventPitchbend } from '../MIDI'\nimport { Instrument } from '../Instrument'\nimport { noteFreq } from './util'\n\nexport class PolySynth extends Instrument {\n\tsynth: Tone.PolySynth\n\tfilter: Tone.Filter\n\tfilterVol: Tone.Volume\n\treverb: Tone.Reverb\n\tpanVol: Tone.PanVol\n\tps = 0\n\tpsSpread = 7\n\n\tconstructor() {\n\t\tsuper()\n\t\tthis.panVol = new Tone.PanVol(0, 0).toDestination()\n\t\tthis.reverb = new Tone.Reverb({ decay: 4, wet: 0.6 }).connect(this.panVol)\n\t\tthis.filterVol = new Tone.Volume(0).connect(this.reverb)\n\t\tthis.filter = new Tone.Filter({\n\t\t\ttype: 'bandpass',\n\t\t\tfrequency: 1000,\n\t\t\tQ: 2,\n\t\t}).connect(this.filterVol)\n\t\tthis.synth = new Tone.PolySynth(Tone.Synth, {\n\t\t\toscillator: {\n\t\t\t\ttype: 'fatsawtooth',\n\t\t\t\tcount: 3,\n\t\t\t\tspread: 30,\n\t\t\t},\n\t\t\tenvelope: {\n\t\t\t\tattack: 0.02,\n\t\t\t\tdecay: 0.1,\n\t\t\t\tsustain: 0.7,\n\t\t\t\trelease: 1.0,\n\t\t\t},\n\t\t}).connect(this.filter)\n\t}\n\n\tsetFilterGain = (db: number) => {\n\t\tthis.filter.set({ gain: db })\n\t\tthis.filterVol.volume.set({ value: Math.min(0, -db) })\n\t}\n\n\tloaded() {\n\t\treturn true\n\t}\n\n\tnoteon = (time: number, evt: MidiEventNote) => {\n\t\tthis.synth.triggerAttack(noteFreq(evt.note), time, evt.attack)\n\t}\n\tnoteoff = (time: number, evt: MidiEventNote) => {\n\t\tthis.synth.triggerRelease(noteFreq(evt.note), time)\n\t}\n\n\tcontrolchange = (time: number, evt: MidiEventCC) => {\n\t\tconst num = evt.controller.number\n\t\tlet delayed: (() => void) | null = null\n\t\tswitch (true) {\n\t\t\tcase num === 1:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tconst vv = evt.value * evt.value\n\t\t\t\t\tthis.filter.set({ frequency: 20 + 10000 * vv })\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase num === 21:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tconst vv = evt.value * evt.value\n\t\t\t\t\tthis.filter.set({ Q: vv * 8 })\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase num === 27:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.psSpread = evt.value * 12\n\t\t\t\t\tthis.updatePitchbend()\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase num === 28:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.panVol.set({ pan: evt.value * 2 - 1 })\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase 71 <= num && num <= 74: {\n\t\t\t\tlet vv = evt.value * evt.value * evt.value * evt.value\n\t\t\t\tconst key = ['attack', 'decay', 'sustain', 'release'][num - 71]\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tvv = key === 'sustain' ? evt.value : 10 * vv\n\t\t\t\t\tthis.synth.set({ envelope: { [key]: vv } })\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase 75 <= num && num <= 79:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.panVol.mute = !evt.value\n\t\t\t\t\tthis.panVol.set({ volume: (evt.value - 1) * 50 })\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase 15 <= num && num <= 19:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.panVol.mute = !evt.value\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tdefault:\n\t\t\t\tconsole.log(\n\t\t\t\t\t`[PolySynth #controlchange] Unsupported CC event on channel ${evt.channel}:`,\n\t\t\t\t\tevt.controller,\n\t\t\t\t\tevt.value,\n\t\t\t\t)\n\t\t}\n\t\tif (delayed) {\n\t\t\tTone.Draw.schedule(delayed, time)\n\t\t}\n\t}\n\n\tpitchbend = (time: number, evt: MidiEventPitchbend) => {\n\t\tTone.Draw.schedule(() => {\n\t\t\tthis.ps = evt.value\n\t\t\tthis.updatePitchbend()\n\t\t}, time)\n\t}\n\n\tupdatePitchbend = () => {\n\t\tthis.synth.set({ detune: 100 * this.ps * this.psSpread })\n\t}\n}\n","import * as p5 from 'p5'\nimport { Avatar } from 'engine3d'\nimport { UserEvent } from './serverApi/serverApi'\n\nclass VisualNote {\n\tage: number = 0\n\treleased: boolean = false\n\tfirstUpdate: boolean = true\n\tageReleased: number = 0\n\tx: number = -1\n\ty: number = -1\n\tvelx: number = 0\n\tvely: number = 0\n\tyoung: number = 2.0 // decreases to 1 over youngDur frames\n\thealth: number = 1.0 // after release, decreases to 0 over fadeOut frames\n\tyoungDur: number // number of frames this note is 'young' (i.e. in attack)\n\tfadeOut: number // number of frames to fade away after release\n\tradius: number\n\tradiusOrig: number\n\tevt: UserEvent\n\tavatar: Avatar\n\n\tconstructor(evt: UserEvent, avatar: Avatar) {\n\t\tthis.evt = evt\n\t\tthis.avatar = avatar\n\t\tconst aa = this.evt.midiEvent.attack || 0.5\n\t\tthis.radius = aa * 25 + 5\n\t\tthis.radiusOrig = this.radius\n\t\tswitch (evt.instrument) {\n\t\t\tcase 'eightOhEight':\n\t\t\t\tthis.youngDur = 2\n\t\t\t\tthis.fadeOut = 3\n\t\t\t\tbreak\n\t\t\tdefault:\n\t\t\t\tthis.youngDur = 5\n\t\t\t\tthis.fadeOut = 10\n\t\t\t\tbreak\n\t\t}\n\t}\n\n\trelease = () => {\n\t\tthis.released = true\n\t\tthis.ageReleased = this.age\n\t}\n\n\tisDead = () => this.released && this.age - this.ageReleased > this.fadeOut\n\n\tupdate = (pg: p5.Graphics, others: VisualNote[]) => {\n\t\tconst close = 50,\n\t\t\tweightVC = 1.8,\n\t\t\tweightC = 0.2,\n\t\t\tweightF = 1.0 / 500000,\n\t\t\tweightU = 0.003,\n\t\t\t{ pos } = this.avatar.xform,\n\t\t\tux = pos.x/1000,\n\t\t\tuy = pos.z/1000,\n\t\t\twidth = 1000,\n\t\t\theight = 1000\n\n\t\tif (this.firstUpdate) {\n\t\t\t// transform original normalized position into screen space\n\t\t\tthis.x = width * (ux + 0.1 * (Math.random() * 2 - 1))\n\t\t\tthis.y = height * (uy + 0.1 * (Math.random() * 2 - 1))\n\t\t\tthis.firstUpdate = false\n\t\t}\n\n\t\tthis.young = Math.max(1.0, 2.0 - this.age / this.youngDur)\n\t\tthis.age++\n\t\tif (this.released) {\n\t\t\tthis.health = 1.0 - (this.age - this.ageReleased) / this.fadeOut\n\t\t}\n\t\tthis.radius = this.radiusOrig * this.health\n\n\t\tthis.velx *= 0.924\n\t\tthis.vely *= 0.924\n\t\tthis.velx -= weightU * (this.x - ux * width)\n\t\tthis.vely -= weightU * (this.y - uy * height)\n\t\tfor (const other of others) {\n\t\t\tif (other === this) {\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tconst dx = this.x - other.x\n\t\t\tconst dy = this.y - other.y\n\t\t\tconst ddx = dx * dx\n\t\t\tconst ddy = dy * dy\n\t\t\tconst sx = dx < 0 ? -1 : 1\n\t\t\tconst sy = dy < 0 ? -1 : 1\n\t\t\tconst dd = Math.sqrt(ddx + ddy)\n\t\t\tconst cc = close * close\n\t\t\tconst outerDist = dd - (this.radius + other.radius)\n\t\t\tif (outerDist < 0) {\n\t\t\t\t// notes bounce off each other if they're touching\n\t\t\t\tthis.velx += (weightVC * sx * (cc * 3 - ddx)) / cc\n\t\t\t\tthis.vely += (weightVC * sy * (cc * 3 - ddy)) / cc\n\t\t\t} else if (outerDist < close) {\n\t\t\t\t// notes repel each other a little if they're not touching but still close\n\t\t\t\tthis.velx += (weightC * sx * ddx) / cc\n\t\t\t\tthis.vely += (weightC * sy * ddy) / cc\n\t\t\t} else if (other.evt.instrument === this.evt.instrument) {\n\t\t\t\t// notes from the same instrument spring towards each other when they're far away\n\t\t\t\tthis.velx -= weightF * sx * ddx\n\t\t\t\tthis.vely -= weightF * sy * ddy\n\t\t\t}\n\t\t}\n\t\t// bounce off the walls\n\t\tif ((this.x < -width + this.radius && this.velx < 0) || (this.x > width - this.radius && this.velx > 0)) {\n\t\t\tthis.velx *= -1\n\t\t}\n\t\tif ((this.y < -height + this.radius && this.vely < 0) || (this.y > height - this.radius && this.vely > 0)) {\n\t\t\tthis.vely *= -1\n\t\t}\n\t\tthis.x += this.velx\n\t\tthis.y += this.vely\n\t}\n\n\tdraw = (pp: p5, pg: p5.Graphics) => {\n\t\tpg.colorMode(pp.HSL, 1)\n\t\tconst { instrument, midiEvent } = this.evt\n\t\tconst { attack, note } = midiEvent\n\t\tconst aa = attack || 0.5\n\t\tconst sat = aa * 0.3 + 0.55\n\t\tconst size = this.radius * 2 * this.young\n\t\tswitch (instrument) {\n\t\t\tcase 'eightOhEight':\n\t\t\tcase 'metronome': {\n\t\t\t\tconst hue = (note % 16) / 16\n\t\t\t\tpg.fill(hue * 0.4 + 0.05, sat, 0.45, this.health)\n\t\t\t\tpg.square(this.x - size / 2, this.y - size / 2, size)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tdefault: {\n\t\t\t\tconst hue = (note % 12) / 12\n\t\t\t\tconst lgt = Math.min(note / 128 + 0.2, 0.65)\n\t\t\t\tpg.fill(hue * 0.25 + 0.55, sat, lgt, this.health)\n\t\t\t\tpg.circle(this.x, this.y, size)\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t\tpg.colorMode(pp.RGB, 255)\n\t}\n}\n\nexport default class VisualNotes {\n\tnotes: VisualNote[] = []\n\n\tnoteon = (evt: UserEvent, avatar: Avatar) => {\n\t\tthis.notes.push(new VisualNote(evt, avatar))\n\t}\n\n\tnoteoff = (evt: UserEvent) => {\n\t\tconst notes = this.notes.filter(nn => !nn.released && this.isSameNote(nn, evt))\n\t\tif (!notes.length) {\n\t\t\tconsole.warn('[VisualNotes #noteoff] Unable to find note for event', evt)\n\t\t\treturn\n\t\t}\n\t\tnotes.forEach(nn => nn.release())\n\t}\n\n\tisSameNote = (note: VisualNote, evt: UserEvent) => {\n\t\treturn note.evt.instrument === evt.instrument && note.evt.midiEvent.note === evt.midiEvent.note\n\t}\n\n\t/*eslint no-lone-blocks: \"off\"*/\n\tdraw = (pp: p5, pg: p5.Graphics) => {\n\t\tthis.notes = this.notes.filter(nn => !nn.isDead())\n\t\tthis.notes.forEach(nn => nn.update(pg, this.notes))\n\t\tpg.perspective(Math.PI / 3, pg.width / pg.height, 0.5, 10000)\n\t\tpg.clear()\n\t\tpg.push()\n\t\tpg.noStroke()\n\t\tpg.translate(0, 5, 0)\n\t\tpg.rotateX(Math.PI/2)\n\t\tthis.notes.forEach(nn => nn.draw(pp, pg))\n\t\tpg.pop()\n\t}\n}\n","// import * as p5 from 'p5'\n/*\n *\n * The p5.EasyCam library - Easy 3D CameraControl for p5.js and WEBGL.\n *\n *   Copyright  2017-2020 by p5.EasyCam authors\n *\n *   Source: https://github.com/freshfork/p5.EasyCam\n *\n *   MIT License: https://opensource.org/licenses/MIT\n *\n *\n * explanatory notes:\n *\n * p5.EasyCam is a derivative of the original PeasyCam Library by Jonathan Feinberg\n * and combines new useful features with the great look and feel of its parent.\n *\n */\n\n/** @namespace  */\n// var Dw = (function(ext) {\nconst ext = {}\n\n/**\n * EasyCam Library Info\n */\nconst INFO = {\n\t/** name    */ LIBRARY: 'p5.EasyCam',\n\t/** version */ VERSION: '1.0.10',\n\t/** author  */ AUTHOR: 'p5.EasyCam authors',\n\t/** source  */ SOURCE: 'https://github.com/freshfork/p5.EasyCam',\n\n\ttoString: function () {\n\t\treturn this.LIBRARY + ' v' + this.VERSION + ' by ' + this.AUTHOR + ' (' + this.SOURCE + ')'\n\t},\n}\n\n/**\n * EasyCam\n *\n * <pre>\n *\n *   new Dw.EasyCam(p5.RendererGL, {\n *     distance : z,                 // scalar\n *     center   : [x, y, z],         // vector\n *     rotation : [q0, q1, q2, q3],  // quaternion\n *     viewport : [x, y, w, h],      // array\n *   }\n *\n * </pre>\n *\n * @param {p5.RendererGL} renderer - p5 WEBGL renderer\n * @param {Object}        args     - {distance, center, rotation, viewport}\n *\n */\nexport class EasyCam {\n\t/**\n\t * @constructor\n\t */\n\tconstructor(renderer, args) {\n\t\t// WEBGL renderer required\n\t\tif (!(renderer instanceof window.p5.RendererGL)) {\n\t\t\tconsole.log('renderer needs to be an instance of p5.RendererGL')\n\t\t\treturn\n\t\t}\n\n\t\t// define default args\n\t\targs = args || {}\n\t\tif (args.distance === undefined) args.distance = 500\n\t\tif (args.center === undefined) args.center = [0, 0, 0]\n\t\tif (args.rotation === undefined) args.rotation = Rotation.identity()\n\t\tif (args.viewport === undefined) args.viewport = [0, 0, renderer.width, renderer.height]\n\n\t\t// library info\n\t\tthis.INFO = INFO\n\n\t\t// set renderer, graphics, p5\n\t\t// this.renderer;\n\t\t// this.graphics;\n\t\t// this.P5\n\t\tthis.setCanvas(renderer)\n\n\t\t// self reference\n\t\tvar cam = this\n\t\tthis.cam = cam\n\n\t\t// some constants\n\t\tthis.LOOK = [0, 0, 1]\n\t\tthis.UP = [0, 1, 0]\n\n\t\t// principal axes flags\n\t\tthis.AXIS = new (function () {\n\t\t\tthis.YAW = 0x01\n\t\t\tthis.PITCH = 0x02\n\t\t\tthis.ROLL = 0x04\n\t\t\tthis.ALL = this.YAW | this.PITCH | this.ROLL\n\t\t})()\n\n\t\t// mouse action constraints\n\t\tthis.SHIFT_CONSTRAINT = 0 // applied when pressing the shift key\n\t\tthis.FIXED_CONSTRAINT = 0 // applied, when set by user and SHIFT_CONSTRAINT is 0\n\t\tthis.DRAG_CONSTRAINT = 0 // depending on SHIFT_CONSTRAINT and FIXED_CONSTRAINT, default is ALL\n\n\t\t// mouse action speed\n\t\tthis.scale_rotation = 0.001\n\t\tthis.scale_pan = 0.0002\n\t\tthis.scale_zoom = 0.001\n\t\tthis.scale_zoomwheel = 20.0\n\n\t\t// zoom limits\n\t\tthis.distance_min_limit = 0.01\n\t\tthis.distance_min = 1.0\n\t\tthis.distance_max = Number.MAX_VALUE\n\n\t\t// main state\n\t\tthis.state = {\n\t\t\tdistance: args.distance, // scalar\n\t\t\tcenter: args.center.slice(), // vec3\n\t\t\trotation: args.rotation.slice(), // quaternion\n\n\t\t\tcopy: function (dst) {\n\t\t\t\tdst = dst || {}\n\t\t\t\tdst.distance = this.distance\n\t\t\t\tdst.center = this.center.slice()\n\t\t\t\tdst.rotation = this.rotation.slice()\n\t\t\t\treturn dst\n\t\t\t},\n\t\t}\n\n\t\t// backup-state at start\n\t\tthis.state_reset = this.state.copy()\n\t\t// backup-state, probably not required\n\t\tthis.state_pushed = this.state.copy()\n\n\t\t// viewport for the mouse-pointer [x,y,w,h]\n\t\tthis.viewport = args.viewport.slice()\n\n\t\t// mouse/touch/key action handler\n\t\tthis.mouse = {\n\t\t\tcam: cam,\n\n\t\t\tcurr: [0, 0, 0],\n\t\t\tprev: [0, 0, 0],\n\t\t\tdist: [0, 0, 0],\n\t\t\tmwheel: 0,\n\n\t\t\tisPressed: false, // true if (istouchdown || ismousedown)\n\t\t\tistouchdown: false, // true, if input came from a touch\n\t\t\tismousedown: false, // true, if input came from a mouse\n\n\t\t\tBUTTON: { LMB: 0x01, MMB: 0x02, RMB: 0x04 },\n\n\t\t\tbutton: 0,\n\n\t\t\tmouseDragLeft: cam.mouseDragRotate.bind(cam),\n\t\t\tmouseDragCenter: cam.mouseDragPan.bind(cam),\n\t\t\tmouseDragRight: cam.mouseDragZoom.bind(cam),\n\t\t\tmouseWheelAction: cam.mouseWheelZoom.bind(cam),\n\n\t\t\ttouchmoveSingle: cam.mouseDragRotate.bind(cam),\n\t\t\ttouchmoveMulti: function () {\n\t\t\t\tcam.mouseDragPan()\n\t\t\t\tcam.mouseDragZoom()\n\t\t\t},\n\n\t\t\tinsideViewport: function (x, y) {\n\t\t\t\tvar x0 = cam.viewport[0],\n\t\t\t\t\tx1 = x0 + cam.viewport[2]\n\t\t\t\tvar y0 = cam.viewport[1],\n\t\t\t\t\ty1 = y0 + cam.viewport[3]\n\t\t\t\treturn x > x0 && x < x1 && y > y0 && y < y1\n\t\t\t},\n\n\t\t\tsolveConstraint: function () {\n\t\t\t\tvar dx = this.dist[0]\n\t\t\t\tvar dy = this.dist[1]\n\n\t\t\t\t// YAW, PITCH\n\t\t\t\tif (this.shiftKey && !cam.SHIFT_CONSTRAINT && Math.abs(dx - dy) > 1) {\n\t\t\t\t\tcam.SHIFT_CONSTRAINT = Math.abs(dx) > Math.abs(dy) ? cam.AXIS.YAW : cam.AXIS.PITCH\n\t\t\t\t}\n\n\t\t\t\t// define constraint by increasing priority\n\t\t\t\tcam.DRAG_CONSTRAINT = cam.AXIS.ALL\n\t\t\t\tif (cam.FIXED_CONSTRAINT) cam.DRAG_CONSTRAINT = cam.FIXED_CONSTRAINT\n\t\t\t\tif (cam.SHIFT_CONSTRAINT) cam.DRAG_CONSTRAINT = cam.SHIFT_CONSTRAINT\n\t\t\t},\n\n\t\t\tupdateInput: function (x, y, z) {\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tvar pd = cam.P5.pixelDensity()\n\n\t\t\t\tmouse.prev[0] = mouse.curr[0]\n\t\t\t\tmouse.prev[1] = mouse.curr[1]\n\t\t\t\tmouse.prev[2] = mouse.curr[2]\n\n\t\t\t\tmouse.curr[0] = x\n\t\t\t\tmouse.curr[1] = y\n\t\t\t\tmouse.curr[2] = z\n\n\t\t\t\tmouse.dist[0] = -(mouse.curr[0] - mouse.prev[0]) / pd\n\t\t\t\tmouse.dist[1] = -(mouse.curr[1] - mouse.prev[1]) / pd\n\t\t\t\tmouse.dist[2] = -(mouse.curr[2] - mouse.prev[2]) / pd\n\t\t\t},\n\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\t\t\t// mouseinput\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\n\t\t\tmousedown: function (event) {\n\t\t\t\tvar mouse = cam.mouse\n\n\t\t\t\tif (event.button === 0) mouse.button |= mouse.BUTTON.LMB\n\t\t\t\tif (event.button === 1) mouse.button |= mouse.BUTTON.MMB\n\t\t\t\tif (event.button === 2) mouse.button |= mouse.BUTTON.RMB\n\n\t\t\t\tif (mouse.insideViewport(event.x, event.y)) {\n\t\t\t\t\tmouse.updateInput(event.x, event.y, event.y)\n\t\t\t\t\tmouse.ismousedown = mouse.button > 0\n\t\t\t\t\tmouse.isPressed = mouse.ismousedown\n\t\t\t\t\tcam.SHIFT_CONSTRAINT = 0\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tmousedrag: function () {\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tif (mouse.ismousedown) {\n\t\t\t\t\tvar x = cam.P5.mouseX\n\t\t\t\t\tvar y = cam.P5.mouseY\n\t\t\t\t\tvar z = y\n\n\t\t\t\t\tmouse.updateInput(x, y, z)\n\t\t\t\t\tmouse.solveConstraint()\n\n\t\t\t\t\tvar LMB = mouse.button & mouse.BUTTON.LMB\n\t\t\t\t\tvar MMB = mouse.button & mouse.BUTTON.MMB\n\t\t\t\t\tvar RMB = mouse.button & mouse.BUTTON.RMB\n\n\t\t\t\t\tif (LMB && mouse.mouseDragLeft) mouse.mouseDragLeft()\n\t\t\t\t\tif (MMB && mouse.mouseDragCenter) mouse.mouseDragCenter()\n\t\t\t\t\tif (RMB && mouse.mouseDragRight) mouse.mouseDragRight()\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tmouseup: function (event) {\n\t\t\t\tvar mouse = cam.mouse\n\n\t\t\t\tif (event.button === 0) mouse.button &= ~mouse.BUTTON.LMB\n\t\t\t\tif (event.button === 1) mouse.button &= ~mouse.BUTTON.MMB\n\t\t\t\tif (event.button === 2) mouse.button &= ~mouse.BUTTON.RMB\n\n\t\t\t\tmouse.ismousedown = mouse.button > 0\n\t\t\t\tmouse.isPressed = mouse.istouchdown || mouse.ismousedown\n\t\t\t\tcam.SHIFT_CONSTRAINT = 0\n\t\t\t},\n\n\t\t\tdblclick: function (event) {\n\t\t\t\tvar x = event.x\n\t\t\t\tvar y = event.y\n\t\t\t\tif (cam.mouse.insideViewport(x, y)) {\n\t\t\t\t\tcam.reset()\n\t\t\t\t}\n\t\t\t},\n\n\t\t\twheel: function (event) {\n\t\t\t\tvar x = event.x\n\t\t\t\tvar y = event.y\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tif (mouse.insideViewport(x, y)) {\n\t\t\t\t\tmouse.mwheel = event.deltaY * 0.01\n\t\t\t\t\tif (mouse.mouseWheelAction) mouse.mouseWheelAction()\n\t\t\t\t}\n\t\t\t},\n\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\t\t\t// touchinput\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\n\t\t\tevaluateTouches: function (event) {\n\t\t\t\tvar touches = event.touches\n\t\t\t\tvar avg_x = 0.0\n\t\t\t\tvar avg_y = 0.0\n\t\t\t\tvar avg_d = 0.0\n\t\t\t\tvar i,\n\t\t\t\t\tdx,\n\t\t\t\t\tdy,\n\t\t\t\t\tcount = touches.length\n\n\t\t\t\t// center, averaged touch position\n\t\t\t\tfor (i = 0; i < count; i++) {\n\t\t\t\t\tavg_x += touches[i].clientX\n\t\t\t\t\tavg_y += touches[i].clientY\n\t\t\t\t}\n\t\t\t\tavg_x /= count\n\t\t\t\tavg_y /= count\n\n\t\t\t\t// offset, mean distance to center\n\t\t\t\tfor (i = 0; i < count; i++) {\n\t\t\t\t\tdx = avg_x - touches[i].clientX\n\t\t\t\t\tdy = avg_y - touches[i].clientY\n\t\t\t\t\tavg_d += Math.sqrt(dx * dx + dy * dy)\n\t\t\t\t}\n\t\t\t\tavg_d /= count\n\n\t\t\t\tcam.mouse.updateInput(avg_x, avg_y, -avg_d)\n\t\t\t},\n\n\t\t\ttouchstart: function (event) {\n\t\t\t\tevent.preventDefault()\n\t\t\t\tevent.stopPropagation()\n\n\t\t\t\tvar mouse = cam.mouse\n\n\t\t\t\tmouse.evaluateTouches(event)\n\t\t\t\tmouse.istouchdown = mouse.insideViewport(mouse.curr[0], mouse.curr[1])\n\t\t\t\tmouse.isPressed = cam.mouse.istouchdown || cam.mouse.ismousedown\n\n\t\t\t\tmouse.dbltap(event)\n\t\t\t},\n\n\t\t\ttouchmove: function (event) {\n\t\t\t\tevent.preventDefault()\n\t\t\t\tevent.stopPropagation()\n\n\t\t\t\tvar mouse = cam.mouse\n\n\t\t\t\tif (mouse.istouchdown) {\n\t\t\t\t\tmouse.evaluateTouches(event)\n\t\t\t\t\tmouse.solveConstraint()\n\n\t\t\t\t\tif (event.touches.length === 1) {\n\t\t\t\t\t\tmouse.touchmoveSingle()\n\t\t\t\t\t} else {\n\t\t\t\t\t\tmouse.touchmoveMulti()\n\t\t\t\t\t\tmouse.tapcount = 0\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\n\t\t\ttouchend: function (event) {\n\t\t\t\tevent.preventDefault()\n\t\t\t\tevent.stopPropagation()\n\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tmouse.istouchdown = false\n\t\t\t\tmouse.isPressed = mouse.istouchdown || mouse.ismousedown\n\t\t\t\tcam.SHIFT_CONSTRAINT = 0\n\n\t\t\t\tif (mouse.tapcount >= 2) {\n\t\t\t\t\tif (mouse.insideViewport(mouse.curr[0], mouse.curr[1])) {\n\t\t\t\t\t\tcam.reset()\n\t\t\t\t\t}\n\t\t\t\t\tmouse.tapcount = 0\n\t\t\t\t}\n\t\t\t},\n\n\t\t\ttapcount: 0,\n\n\t\t\tdbltap: function (event) {\n\t\t\t\tif (cam.mouse.tapcount++ === 0) {\n\t\t\t\t\tsetTimeout(function () {\n\t\t\t\t\t\tcam.mouse.tapcount = 0\n\t\t\t\t\t}, 350)\n\t\t\t\t}\n\t\t\t},\n\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\t\t\t// keyingput\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\n\t\t\t// key-event for shift constraints\n\t\t\tshiftKey: false,\n\n\t\t\tkeydown: function (event) {\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tif (!mouse.shiftKey) {\n\t\t\t\t\tmouse.shiftKey = event.keyCode === 16\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tkeyup: function (event) {\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tif (mouse.shiftKey) {\n\t\t\t\t\tmouse.shiftKey = event.keyCode !== 16\n\t\t\t\t\tif (!mouse.shiftKey) {\n\t\t\t\t\t\tcam.SHIFT_CONSTRAINT = 0\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t}\n\n\t\t// camera mouse listeners\n\t\tthis.attachMouseListeners()\n\n\t\t// P5 registered callbacks, TODO unregister on dispose\n\t\tthis.auto_update = true\n\t\tthis.P5.registerMethod('pre', function () {\n\t\t\tif (cam.auto_update) {\n\t\t\t\tcam.update()\n\t\t\t}\n\t\t})\n\n\t\t// damped camera transition\n\t\tthis.dampedZoom = new DampedAction(function (d) {\n\t\t\tcam.zoom(d * cam.getZoomMult())\n\t\t})\n\t\tthis.dampedPanX = new DampedAction(function (d) {\n\t\t\tcam.panX(d * cam.getPanMult())\n\t\t})\n\t\tthis.dampedPanY = new DampedAction(function (d) {\n\t\t\tcam.panY(d * cam.getPanMult())\n\t\t})\n\t\tthis.dampedPanZ = new DampedAction(function (d) {\n\t\t\tcam.panZ(d * cam.getPanMult())\n\t\t})\n\t\tthis.dampedRotX = new DampedAction(function (d) {\n\t\t\tcam.rotateX(d * cam.getRotationMult())\n\t\t})\n\t\tthis.dampedRotY = new DampedAction(function (d) {\n\t\t\tcam.rotateY(d * cam.getRotationMult())\n\t\t})\n\t\tthis.dampedRotZ = new DampedAction(function (d) {\n\t\t\tcam.rotateZ(d * cam.getRotationMult())\n\t\t})\n\n\t\t// interpolated camera transition\n\t\tthis.timedRot = new Interpolation(cam.setInterpolatedRotation.bind(cam))\n\t\tthis.timedPan = new Interpolation(cam.setInterpolatedCenter.bind(cam))\n\t\tthis.timedzoom = new Interpolation(cam.setInterpolatedDistance.bind(cam))\n\t}\n\n\t/**\n\t * sets the WEBGL renderer the camera is working on\n\t *\n\t * @param {p5.RendererGL} renderer ... p5 WEBGL renderer\n\t */\n\tsetCanvas(renderer) {\n\t\tif (renderer instanceof window.p5.RendererGL) {\n\t\t\t// p5js seems to be not very clear about this\n\t\t\t// ... a bit confusing, so i guess this could change in future releases\n\t\t\tthis.renderer = renderer\n\t\t\tif (renderer._pInst instanceof window.p5) {\n\t\t\t\tthis.graphics = renderer\n\t\t\t} else {\n\t\t\t\tthis.graphics = renderer._pInst\n\t\t\t}\n\t\t\tthis.P5 = this.graphics._pInst\n\t\t} else {\n\t\t\tthis.graphics = undefined\n\t\t\tthis.renderer = undefined\n\t\t}\n\t}\n\n\t/** @return {p5.RendererGL} the currently used renderer */\n\tgetCanvas() {\n\t\treturn this.renderer\n\t}\n\n\tattachListener(el, ev, fx, op) {\n\t\tif (!el || el === fx.el) {\n\t\t\treturn\n\t\t}\n\n\t\tthis.detachListener(fx)\n\n\t\tfx.el = el\n\t\tfx.ev = ev\n\t\tfx.op = op\n\t\tfx.el.addEventListener(fx.ev, fx, fx.op)\n\t}\n\n\tdetachListener(fx) {\n\t\tif (fx.el) {\n\t\t\tfx.el.removeEventListener(fx.ev, fx, fx.op)\n\t\t\tfx.el = undefined\n\t\t}\n\t}\n\n\t/** attaches input-listeners (mouse, touch, key) to the used renderer */\n\tattachMouseListeners(renderer) {\n\t\tvar cam = this.cam\n\t\tvar mouse = cam.mouse\n\n\t\trenderer = renderer || cam.renderer\n\t\tif (renderer) {\n\t\t\tvar op = { passive: false }\n\t\t\tvar el = renderer.elt\n\n\t\t\tcam.attachListener(el, 'mousedown', mouse.mousedown, op)\n\t\t\tcam.attachListener(el, 'mouseup', mouse.mouseup, op)\n\t\t\t// cam.attachListener(el, 'dblclick', mouse.dblclick, op)\n\t\t\tcam.attachListener(el, 'wheel', mouse.wheel, op)\n\t\t\tcam.attachListener(el, 'touchstart', mouse.touchstart, op)\n\t\t\tcam.attachListener(el, 'touchend', mouse.touchend, op)\n\t\t\tcam.attachListener(el, 'touchmove', mouse.touchmove, op)\n\t\t\tcam.attachListener(window, 'keydown', mouse.keydown, op)\n\t\t\tcam.attachListener(window, 'keyup', mouse.keyup, op)\n\t\t}\n\t}\n\n\t/** detaches all attached input-listeners */\n\tremoveMouseListeners() {\n\t\tvar cam = this.cam\n\t\tvar mouse = cam.mouse\n\n\t\tcam.detachListener(mouse.mousedown)\n\t\tcam.detachListener(mouse.mouseup)\n\t\t// cam.detachListener(mouse.dblclick)\n\t\tcam.detachListener(mouse.wheel)\n\t\tcam.detachListener(mouse.keydown)\n\t\tcam.detachListener(mouse.keyup)\n\t\tcam.detachListener(mouse.touchstart)\n\t\tcam.detachListener(mouse.touchend)\n\t\tcam.detachListener(mouse.touchmove)\n\t}\n\n\t/** Disposes/releases the camera. */\n\tdispose() {\n\t\t// // TODO: p5 unregister 'pre', ... not available in 0.5.16\n\t\t// removeMouseListeners();\n\t}\n\n\t/** @return {boolean} the current autoUpdate state */\n\tgetAutoUpdate() {\n\t\treturn this.auto_update\n\t}\n\t/**\n\t * If true, the EasyCam will update automatically in a pre-draw step.\n\t * This updates the camera state and updates the renderers\n\t * modelview/camera matrix.\n\t *\n\t * If false, the update() needs to be called manually.\n\t *\n\t * @param {boolean} the new autoUpdate state\n\t */\n\tsetAutoUpdate(status) {\n\t\tthis.auto_update = status\n\t}\n\n\t/**\n\t * Updates the camera state (interpolated / damped animations) and updates\n\t * the renderers' modelview/camera matrix.\n\t *\n\t * if \"auto_update\" is true, this is called automatically in a pre-draw call.\n\t */\n\tupdate() {\n\t\tvar cam = this.cam\n\t\tvar mouse = cam.mouse\n\n\t\tmouse.mousedrag()\n\n\t\tvar b_update = false\n\t\tb_update |= cam.dampedZoom.update()\n\t\tb_update |= cam.dampedPanX.update()\n\t\tb_update |= cam.dampedPanY.update()\n\t\tb_update |= cam.dampedPanZ.update()\n\t\tb_update |= cam.dampedRotX.update()\n\t\tb_update |= cam.dampedRotY.update()\n\t\tb_update |= cam.dampedRotZ.update()\n\n\t\t// interpolated actions have lower priority then damped actions\n\t\tif (b_update) {\n\t\t\tcam.timedRot.stop()\n\t\t\tcam.timedPan.stop()\n\t\t\tcam.timedzoom.stop()\n\t\t} else {\n\t\t\tcam.timedRot.update()\n\t\t\tcam.timedPan.update()\n\t\t\tcam.timedzoom.update()\n\t\t}\n\n\t\tcam.apply()\n\t}\n\n\t/**\n\t * Applies the current camera state to the renderers' modelview/camera matrix.\n\t * If no argument is given, then the cameras currently set renderer is used.\n\t */\n\tapply(renderer) {\n\t\tvar cam = this.cam\n\t\trenderer = renderer || cam.renderer\n\n\t\tif (renderer) {\n\t\t\tthis.camEYE = this.getPosition(this.camEYE)\n\t\t\tthis.camLAT = this.getCenter(this.camLAT)\n\t\t\tthis.camRUP = this.getUpVector(this.camRUP)\n\n\t\t\tif (undefined === renderer._curCamera)\n\t\t\t\trenderer.camera(\n\t\t\t\t\tthis.camEYE[0],\n\t\t\t\t\tthis.camEYE[1],\n\t\t\t\t\tthis.camEYE[2],\n\t\t\t\t\tthis.camLAT[0],\n\t\t\t\t\tthis.camLAT[1],\n\t\t\t\t\tthis.camLAT[2],\n\t\t\t\t\tthis.camRUP[0],\n\t\t\t\t\tthis.camRUP[1],\n\t\t\t\t\tthis.camRUP[2],\n\t\t\t\t)\n\t\t\telse\n\t\t\t\trenderer._curCamera.camera(\n\t\t\t\t\tthis.camEYE[0],\n\t\t\t\t\tthis.camEYE[1],\n\t\t\t\t\tthis.camEYE[2],\n\t\t\t\t\tthis.camLAT[0],\n\t\t\t\t\tthis.camLAT[1],\n\t\t\t\t\tthis.camLAT[2],\n\t\t\t\t\tthis.camRUP[0],\n\t\t\t\t\tthis.camRUP[1],\n\t\t\t\t\tthis.camRUP[2],\n\t\t\t\t)\n\t\t}\n\t}\n\n\t/** @param {int[]} the new viewport-def, as [x,y,w,h] */\n\tsetViewport(viewport) {\n\t\tthis.viewport = viewport.slice()\n\t}\n\n\t/** @returns {int[]} the current viewport-def, as [x,y,w,h] */\n\tgetViewport() {\n\t\treturn this.viewport\n\t}\n\n\t//\n\t// mouse state changes\n\t//\n\n\t/** implemented zoom-cb for mouswheel handler.*/\n\tmouseWheelZoom() {\n\t\tvar cam = this\n\t\tvar mouse = cam.mouse\n\t\tcam.dampedZoom.addForce(mouse.mwheel * cam.scale_zoomwheel)\n\t}\n\n\t/** implemented zoom-cb for mousedrag/touch handler.*/\n\tmouseDragZoom() {\n\t\tvar cam = this\n\t\tvar mouse = cam.mouse\n\t\tcam.dampedZoom.addForce(-mouse.dist[2])\n\t}\n\n\t/** implemented pan-cb for mousedrag/touch handler.*/\n\tmouseDragPan() {\n\t\tvar cam = this\n\t\tvar mouse = cam.mouse\n\n\t\tcam.dampedPanX.addForce(cam.DRAG_CONSTRAINT & cam.AXIS.YAW ? mouse.dist[0] : 0)\n\t\tcam.dampedPanY.addForce(cam.DRAG_CONSTRAINT & cam.AXIS.PITCH ? mouse.dist[1] : 0)\n\t}\n\n\t/** implemented rotate-cb for mousedrag/touch handler.*/\n\tmouseDragRotate() {\n\t\tvar cam = this\n\t\tvar mouse = cam.mouse\n\n\t\tvar mx = mouse.curr[0],\n\t\t\tmy = mouse.curr[1]\n\t\tvar dx = mouse.dist[0],\n\t\t\tdy = mouse.dist[1]\n\n\t\t// mouse [-1, +1]\n\t\tvar mxNdc = Math.min(Math.max((mx - cam.viewport[0]) / cam.viewport[2], 0), 1) * 2 - 1\n\t\tvar myNdc = Math.min(Math.max((my - cam.viewport[1]) / cam.viewport[3], 0), 1) * 2 - 1\n\n\t\tif (cam.DRAG_CONSTRAINT & cam.AXIS.YAW) {\n\t\t\tcam.dampedRotY.addForce(+dx * (1.0 - myNdc * myNdc))\n\t\t}\n\t\tif (cam.DRAG_CONSTRAINT & cam.AXIS.PITCH) {\n\t\t\tcam.dampedRotX.addForce(-dy * (1.0 - mxNdc * mxNdc))\n\t\t}\n\t\tif (cam.DRAG_CONSTRAINT & cam.AXIS.ROLL) {\n\t\t\tcam.dampedRotZ.addForce(-dx * myNdc)\n\t\t\tcam.dampedRotZ.addForce(+dy * mxNdc)\n\t\t}\n\t}\n\n\t//\n\t// damped multipliers\n\t//\n\t/** (private) returns the used zoom -multiplier for damped actions. */\n\tgetZoomMult() {\n\t\treturn this.state.distance * this.scale_zoom\n\t}\n\t/** (private) returns the used pan-multiplier for damped actions. */\n\tgetPanMult() {\n\t\treturn this.state.distance * this.scale_pan\n\t}\n\t/** (private) returns the used rotate-multiplier for damped actions. */\n\tgetRotationMult() {\n\t\treturn Math.pow(Math.log10(1 + this.state.distance), 0.5) * this.scale_rotation\n\t}\n\n\t//\n\t// damped state changes\n\t//\n\t/** Applies a change to the current zoom.  */\n\tzoom(dz) {\n\t\tvar cam = this.cam\n\t\tvar distance_tmp = cam.state.distance + dz\n\n\t\t// check lower bound\n\t\tif (distance_tmp < cam.distance_min) {\n\t\t\tdistance_tmp = cam.distance_min\n\t\t\tcam.dampedZoom.stop()\n\t\t}\n\n\t\t// check upper bound\n\t\tif (distance_tmp > cam.distance_max) {\n\t\t\tdistance_tmp = cam.distance_max\n\t\t\tcam.dampedZoom.stop()\n\t\t}\n\n\t\tcam.state.distance = distance_tmp\n\t}\n\n\t/** Applies a change to the current pan-xValue.  */\n\tpanX(dx) {\n\t\tvar state = this.cam.state\n\t\tif (dx) {\n\t\t\tvar val = Rotation.applyToVec3(state.rotation, [dx, 0, 0])\n\t\t\tVec3.add(state.center, val, state.center)\n\t\t}\n\t}\n\n\t/** Applies a change to the current pan-yValue.  */\n\tpanY(dy) {\n\t\tvar state = this.cam.state\n\t\tif (dy) {\n\t\t\tvar val = Rotation.applyToVec3(state.rotation, [0, dy, 0])\n\t\t\tVec3.add(state.center, val, state.center)\n\t\t}\n\t}\n\n\tpanZ(dz) {\n\t\tvar state = this.cam.state\n\t\tif (dz) {\n\t\t\tvar val = Rotation.applyToVec3(state.rotation, [0, 0, dz])\n\t\t\tVec3.add(state.center, val, state.center)\n\t\t}\n\t}\n\n\tpanGround(dx, dy, dz) {\n\t\tconst ca = this.centerAxes()\n\t\tVec3.mult(ca.x, dx, ca.x)\n\t\tVec3.mult(ca.z, dz, ca.z)\n\t\tconst val = [0, 0, 0]\n\t\tVec3.add(ca.x, ca.z, val)\n\t\tval[1] = dy\n\t\tVec3.add(this.cam.state.center, val, this.cam.state.center)\n\t}\n\n\tcenterAxes() {\n\t\tconst state = this.cam.state\n\t\t// Get world unit vector for screen-space X axis\n\t\tconst screenX = Rotation.applyToVec3(state.rotation, [1, 0, 0])\n\t\tscreenX[1] = 0 // project X vector onto ground plane\n\t\t// normalize post-projection vector\n\t\tlet mX = Vec3.mag(screenX)\n\t\tif (mX === 0) {\n\t\t\tconsole.warn('[EasyCam] No magnitude for screenX vector', screenX)\n\t\t\tmX = 1\n\t\t}\n\t\tVec3.mult(screenX, 1.0 / mX, screenX)\n\t\t// Get Z vector: cross-product of X with UP (Y)\n\t\tconst screenZ = [0, 0, 0]\n\t\tVec3.cross(screenX, [0, 1, 0], screenZ)\n\t\t// Multiply ground-plane vectors by arguments, apply to camera state\n\t\treturn {\n\t\t\tx: screenX,\n\t\t\ty: [0, 1, 0],\n\t\t\tz: screenZ,\n\t\t}\n\t}\n\n\t/** Applies a change to the current pan-value.  */\n\tpan(dx, dy, dz) {\n\t\tthis.cam.panX(dx)\n\t\tthis.cam.panY(dy)\n\t\tthis.cam.panZ(dz)\n\t}\n\n\t/** Applies a change to the current xRotation.  */\n\trotateX(rx) {\n\t\tthis.cam.rotate([1, 0, 0], rx)\n\t}\n\n\t/** Applies a change to the current yRotation.  */\n\trotateY(ry) {\n\t\tthis.cam.rotate([0, 1, 0], ry)\n\t}\n\n\t/** Applies a change to the current zRotation.  */\n\trotateZ(rz) {\n\t\tthis.cam.rotate([0, 0, 1], rz)\n\t}\n\n\t/** Applies a change to the current rotation, using the given axis/angle.  */\n\trotate(axis, angle) {\n\t\tvar state = this.cam.state\n\t\tif (angle) {\n\t\t\tvar new_rotation = Rotation.create({ axis: axis, angle: angle })\n\t\t\tRotation.applyToRotation(state.rotation, new_rotation, state.rotation)\n\t\t}\n\t}\n\n\t//\n\t// interpolated states\n\t//\n\t/** Sets the new camera-distance, interpolated (t) between given A and B. */\n\tsetInterpolatedDistance(valA, valB, t) {\n\t\tthis.cam.state.distance = Scalar.mix(valA, valB, Scalar.smoothstep(t))\n\t}\n\t/** Sets the new camera-center, interpolated (t) between given A and B. */\n\tsetInterpolatedCenter(valA, valB, t) {\n\t\tthis.cam.state.center = Vec3.mix(valA, valB, Scalar.smoothstep(t))\n\t}\n\t/** Sets the new camera-rotation, interpolated (t) between given A and B. */\n\tsetInterpolatedRotation(valA, valB, t) {\n\t\tthis.cam.state.rotation = Rotation.slerp(valA, valB, t)\n\t}\n\n\t//\n\t// DISTANCE\n\t//\n\t/** Sets the minimum camera distance. */\n\tsetDistanceMin(distance_min) {\n\t\tthis.distance_min = Math.max(distance_min, this.distance_min_limit)\n\t\tthis.zoom(0) // update, to ensure new minimum\n\t}\n\n\t/** Sets the maximum camera distance. */\n\tsetDistanceMax(distance_max) {\n\t\tthis.distance_max = distance_max\n\t\tthis.zoom(0) // update, to ensure new maximum\n\t}\n\n\t/**\n\t * Sets the new camera distance.\n\t *\n\t * @param {double} new distance.\n\t * @param {long} animation time in millis.\n\t */\n\tsetDistance(distance, duration) {\n\t\tthis.timedzoom.start(this.state.distance, distance, duration, [this.dampedZoom])\n\t}\n\n\t/** @returns {double} the current camera distance. */\n\tgetDistance() {\n\t\treturn this.state.distance\n\t}\n\n\t//\n\t// CENTER / LOOK AT\n\t//\n\t/**\n\t * Sets the new camera center.\n\t *\n\t * @param {double[]} new center.\n\t * @param {long} animation time in millis.\n\t */\n\tsetCenter(center, duration) {\n\t\tthis.timedPan.start(this.state.center, center, duration, [this.dampedPanX, this.dampedPanY])\n\t}\n\n\t/** @returns {double[]} the current camera center. */\n\tgetCenter() {\n\t\treturn this.state.center\n\t}\n\n\t//\n\t// ROTATION\n\t//\n\t/**\n\t * Sets the new camera rotation (quaternion).\n\t *\n\t * @param {double[]} new rotation as quat[q0,q1,q2,q3].\n\t * @param {long} animation time in millis.\n\t */\n\tsetRotation(rotation, duration) {\n\t\tthis.timedRot.start(this.state.rotation, rotation, duration, [\n\t\t\tthis.dampedRotX,\n\t\t\tthis.dampedRotY,\n\t\t\tthis.dampedRotZ,\n\t\t])\n\t}\n\n\t/** @returns {double[]} the current camera rotation as quat[q0,q1,q2,q3]. */\n\tgetRotation() {\n\t\treturn this.state.rotation\n\t}\n\n\t//\n\t// CAMERA POSITION/EYE\n\t//\n\t/** @returns {double[]} the current camera position, aka. the eye position. */\n\tgetPosition(dst) {\n\t\tvar cam = this.cam\n\t\tvar state = cam.state\n\n\t\tdst = Vec3.assert(dst)\n\t\tRotation.applyToVec3(state.rotation, cam.LOOK, dst)\n\t\tVec3.mult(dst, state.distance, dst)\n\t\tVec3.add(dst, state.center, dst)\n\n\t\treturn dst\n\t}\n\n\t//\n\t// CAMERA UP\n\t//\n\t/** @returns {double[]} the current camera up vector. */\n\tgetUpVector(dst) {\n\t\tvar cam = this.cam\n\t\tvar state = cam.state\n\t\tdst = Vec3.assert(dst)\n\t\tRotation.applyToVec3(state.rotation, cam.UP, dst)\n\t\treturn dst\n\t}\n\n\t//\n\t// STATE (rotation, center, distance)\n\t//\n\t/** @returns {Object} a copy of the camera state {distance,center,rotation} */\n\tgetState() {\n\t\treturn this.state.copy()\n\t}\n\t/**\n\t * @param {Object} a new camera state {distance,center,rotation}.\n\t * @param {long} animation time in millis.\n\t */\n\tsetState(other, duration) {\n\t\tif (other) {\n\t\t\tthis.setDistance(other.distance, duration)\n\t\t\tthis.setCenter(other.center, duration)\n\t\t\tthis.setRotation(other.rotation, duration)\n\t\t}\n\t}\n\n\tpushState() {\n\t\treturn (this.state_pushed = this.getState())\n\t}\n\tpopState(duration) {\n\t\tthis.setState(this.state_pushed, duration)\n\t}\n\n\t/** sets the current state as reset-state. */\n\tpushResetState() {\n\t\treturn (this.state_reset = this.getState())\n\t}\n\t/** resets the camera, by applying the reset-state. */\n\treset(duration) {\n\t\tthis.setState(this.state_reset, duration)\n\t}\n\n\t/** sets the rotation scale/speed. */\n\tsetRotationScale(scale_rotation) {\n\t\tthis.scale_rotation = scale_rotation\n\t}\n\t/** sets the pan scale/speed. */\n\tsetPanScale(scale_pan) {\n\t\tthis.scale_pan = scale_pan\n\t}\n\t/** sets the zoom scale/speed. */\n\tsetZoomScale(scale_zoom) {\n\t\tthis.scale_zoom = scale_zoom\n\t}\n\t/** sets the wheel scale/speed. */\n\tsetWheelScale(wheelScale) {\n\t\tthis.scale_zoomwheel = wheelScale\n\t}\n\t/** @returns the rotation scale/speed. */\n\tgetRotationScale() {\n\t\treturn this.scale_rotation\n\t}\n\t/** @returns the pan scale/speed. */\n\tgetPanScale() {\n\t\treturn this.scale_pan\n\t}\n\t/** @returns the zoom scale/speed. */\n\tgetZoomScale() {\n\t\treturn this.scale_zoom\n\t}\n\t/** @returns the wheel scale/speed. */\n\tgetWheelScale() {\n\t\treturn this.scale_zoomwheel\n\t}\n\n\t/** sets the default damping scale/speed. */\n\tsetDamping(damping) {\n\t\tthis.dampedZoom.damping = damping\n\t\tthis.dampedPanX.damping = damping\n\t\tthis.dampedPanY.damping = damping\n\t\tthis.dampedPanZ.damping = damping\n\t\tthis.dampedRotX.damping = damping\n\t\tthis.dampedRotY.damping = damping\n\t\tthis.dampedRotZ.damping = damping\n\t}\n\t/** sets the default interpolation time in millis. */\n\tsetDefaultInterpolationTime(duration) {\n\t\tthis.timedRot.default_duration = duration\n\t\tthis.timedPan.default_duration = duration\n\t\tthis.timedzoom.default_duration = duration\n\t}\n\n\t/**\n\t * sets the rotation constraint for each axis separately.\n\t *\n\t * @param {boolean} yaw constraint\n\t * @param {boolean} pitch constraint\n\t * @param {boolean} roll constraint\n\t */\n\tsetRotationConstraint(yaw, pitch, roll) {\n\t\tvar cam = this.cam\n\t\tcam.FIXED_CONSTRAINT = 0\n\t\tcam.FIXED_CONSTRAINT |= yaw ? cam.AXIS.YAW : 0\n\t\tcam.FIXED_CONSTRAINT |= pitch ? cam.AXIS.PITCH : 0\n\t\tcam.FIXED_CONSTRAINT |= roll ? cam.AXIS.ROLL : 0\n\t}\n\n\t/**\n\t *\n\t * begin screen-aligned 2D-drawing.\n\t *\n\t * <pre>\n\t * beginHUD()\n\t *   disabled depth test\n\t *   ortho\n\t *   ... your code is executed here ...\n\t * endHUD()\n\t * </pre>\n\t *\n\t */\n\tbeginHUD(renderer, w, h) {\n\t\tvar cam = this.cam\n\t\trenderer = renderer || cam.renderer\n\n\t\tif (!renderer) return\n\t\tthis.pushed_rendererState = renderer.push()\n\n\t\tvar gl = renderer.drawingContext\n\t\tconst ww = w !== undefined ? w : renderer.width\n\t\tconst hh = h !== undefined ? h : renderer.height\n\t\tvar d = Number.MAX_VALUE\n\n\t\tgl.flush()\n\t\t// gl.finish();\n\n\t\t// 1) disable DEPTH_TEST\n\t\tgl.disable(gl.DEPTH_TEST)\n\t\t// 2) push modelview/projection\n\t\t//    p5 is not creating a push/pop stack\n\t\tthis.pushed_uMVMatrix = renderer.uMVMatrix.copy()\n\t\tthis.pushed_uPMatrix = renderer.uPMatrix.copy()\n\n\t\t// 3) set new modelview (identity)\n\t\trenderer.resetMatrix()\n\t\t// 4) set new projection (ortho)\n\t\trenderer._curCamera.ortho(0, ww, -hh, 0, -d, +d)\n\t\t// renderer.ortho();\n\t\t// renderer.translate(-w/2, -h/2);\n\t}\n\n\t/**\n\t *\n\t * end screen-aligned 2D-drawing.\n\t *\n\t */\n\tendHUD(renderer) {\n\t\tvar cam = this.cam\n\t\trenderer = renderer || cam.renderer\n\n\t\tif (!renderer) return\n\n\t\tvar gl = renderer.drawingContext\n\n\t\tgl.flush()\n\t\t// gl.finish();\n\n\t\t// 2) restore modelview/projection\n\t\trenderer.uMVMatrix.set(this.pushed_uMVMatrix)\n\t\trenderer.uPMatrix.set(this.pushed_uPMatrix)\n\t\t// 1) enable DEPTH_TEST\n\t\tgl.enable(gl.DEPTH_TEST)\n\t\trenderer.pop(this.pushed_rendererState)\n\t}\n}\n\n/**\n * Damped callback, that accepts the resulting damped/smooth value.\n *\n * @callback dampedCallback\n * @param {double} value - the damped/smoothed value\n *\n */\n\n/**\n *\n * DampedAction, for smoothly changing a value to zero.\n *\n * @param {dampedCallback} cb - callback that accepts the damped value as argument.\n */\nclass DampedAction {\n\t/**  @constructor */\n\tconstructor(cb) {\n\t\tthis.value = 0.0\n\t\tthis.damping = 0.85\n\t\tthis.action = cb\n\t}\n\n\t/** adds a value to the current value beeing damped.\n\t * @param {double} force - the value beeing added.\n\t */\n\taddForce(force) {\n\t\tthis.value += force\n\t}\n\n\t/** updates the damping and calls {@link damped-callback}. */\n\tupdate() {\n\t\tvar active = this.value * this.value > 0.000001\n\t\tif (active) {\n\t\t\tthis.action(this.value)\n\t\t\tthis.value *= this.damping\n\t\t} else {\n\t\t\tthis.stop()\n\t\t}\n\t\treturn active\n\t}\n\n\t/** stops the damping. */\n\tstop() {\n\t\tthis.value = 0.0\n\t}\n}\n\n/**\n * Interpolation callback, that implements any form of interpolation between\n * two values A and B and the interpolationparameter t.\n * <pre>\n *   linear: A * (1-t) + B * t\n *   smooth, etc...\n * </pre>\n * @callback interpolationCallback\n * @param {Object} A - First Value\n * @param {Object} B - Second Value\n * @param {double} t - interpolation parameter [0, 1]\n *\n */\n\n/**\n *\n * Interpolation, for smoothly changing a value by interpolating it over time.\n *\n * @param {interpolationCallback} cb - callback for interpolating between two values.\n */\nclass Interpolation {\n\t/**  @constructor */\n\tconstructor(cb) {\n\t\tthis.default_duration = 300\n\t\tthis.action = cb\n\t}\n\n\t/** starts the interpolation.\n\t *  If the given interpolation-duration is 0, then\n\t * {@link interpolation-callback} is called immediately.\n\t */\n\tstart(valA, valB, duration, actions) {\n\t\tfor (var x in actions) {\n\t\t\tactions[x].stop()\n\t\t}\n\t\tthis.valA = valA\n\t\tthis.valB = valB\n\t\tthis.duration = duration === undefined ? this.default_duration : duration\n\t\tthis.timer = new Date().getTime()\n\t\tthis.active = this.duration > 0\n\t\tif (!this.active) {\n\t\t\tthis.interpolate(1)\n\t\t}\n\t}\n\n\t/** updates the interpolation and calls {@link interpolation-callback}.*/\n\tupdate() {\n\t\tif (this.active) {\n\t\t\tvar t = (new Date().getTime() - this.timer) / this.duration\n\t\t\tif (t > 0.995) {\n\t\t\t\tthis.interpolate(1)\n\t\t\t\tthis.stop()\n\t\t\t} else {\n\t\t\t\tthis.interpolate(t)\n\t\t\t}\n\t\t}\n\t}\n\n\tinterpolate(t) {\n\t\tthis.action(this.valA, this.valB, t)\n\t}\n\n\t/** stops the interpolation. */\n\tstop() {\n\t\tthis.active = false\n\t}\n}\n\n////////////////////////////////////////////////////////////////////////////////\n//\n// ROTATION (Quaternion)\n//\n////////////////////////////////////////////////////////////////////////////////\n/**\n * Rotation as Quaternion [q0, q1, q2, q3]\n *\n * Note: Only functions that were required for the EasyCam to work are implemented.\n *\n * @namespace\n */\nvar Rotation = {\n\tassert: function (dst) {\n\t\treturn dst === undefined || dst.constructor !== Array ? [1, 0, 0, 0] : dst\n\t},\n\n\t/** @returns {Number[]} an identity rotation [1,0,0,0] */\n\tidentity: function () {\n\t\treturn [1, 0, 0, 0]\n\t},\n\n\t/**\n\t * Applies the rotation to a vector and returns dst or a new vector.\n\t *\n\t * @param {Number[]} rot - Rotation (Quaternion)\n\t * @param {Number[]} vec - vector to be rotated by rot\n\t * @param {Number[]} dst - resulting vector\n\t * @returns {Number[]} dst- resulting vector\n\t */\n\tapplyToVec3: function (rot, vec, dst) {\n\t\tvar [x, y, z] = vec\n\t\tvar [q0, q1, q2, q3] = rot\n\n\t\tvar s = q1 * x + q2 * y + q3 * z\n\n\t\tdst = Vec3.assert(dst)\n\t\tdst[0] = 2 * (q0 * (x * q0 - (q2 * z - q3 * y)) + s * q1) - x\n\t\tdst[1] = 2 * (q0 * (y * q0 - (q3 * x - q1 * z)) + s * q2) - y\n\t\tdst[2] = 2 * (q0 * (z * q0 - (q1 * y - q2 * x)) + s * q3) - z\n\t\treturn dst\n\t},\n\n\t/**\n\t * Applies the rotation to another rotation and returns dst or a new rotation.\n\t *\n\t * @param {Number[]} rotA - RotationA (Quaternion)\n\t * @param {Number[]} rotB - RotationB (Quaternion)\n\t * @param {Number[]} dst - resulting rotation\n\t * @returns {Number[]} dst - resulting rotation\n\t */\n\tapplyToRotation(rotA, rotB, dst) {\n\t\tvar [a0, a1, a2, a3] = rotA\n\t\tvar [b0, b1, b2, b3] = rotB\n\n\t\tdst = Rotation.assert(dst)\n\t\tdst[0] = b0 * a0 - (b1 * a1 + b2 * a2 + b3 * a3)\n\t\tdst[1] = b1 * a0 + b0 * a1 + (b2 * a3 - b3 * a2)\n\t\tdst[2] = b2 * a0 + b0 * a2 + (b3 * a1 - b1 * a3)\n\t\tdst[3] = b3 * a0 + b0 * a3 + (b1 * a2 - b2 * a1)\n\t\treturn dst\n\t},\n\n\t/**\n\t * Interpolates a rotation.\n\t *\n\t * @param {Number[]} rotA - RotationA (Quaternion)\n\t * @param {Number[]} rotB - RotationB (Quaternion)\n\t * @param {Number  } t - interpolation parameter\n\t * @param {Number[]} dst - resulting rotation\n\t * @returns {Number[]} dst - resulting rotation\n\t */\n\tslerp: function (rotA, rotB, t, dst) {\n\t\tvar [a0, a1, a2, a3] = rotA\n\t\tvar [b0, b1, b2, b3] = rotB\n\n\t\tvar cosTheta = a0 * b0 + a1 * b1 + a2 * b2 + a3 * b3\n\t\tif (cosTheta < 0) {\n\t\t\tb0 = -b0\n\t\t\tb1 = -b1\n\t\t\tb2 = -b2\n\t\t\tb3 = -b3\n\t\t\tcosTheta = -cosTheta\n\t\t}\n\n\t\tvar theta = Math.acos(cosTheta)\n\t\tvar sinTheta = Math.sqrt(1.0 - cosTheta * cosTheta)\n\n\t\tvar w1, w2\n\t\tif (sinTheta > 0.001) {\n\t\t\tw1 = Math.sin((1.0 - t) * theta) / sinTheta\n\t\t\tw2 = Math.sin(t * theta) / sinTheta\n\t\t} else {\n\t\t\tw1 = 1.0 - t\n\t\t\tw2 = t\n\t\t}\n\n\t\tdst = Rotation.assert(dst)\n\t\tdst[0] = w1 * a0 + w2 * b0\n\t\tdst[1] = w1 * a1 + w2 * b1\n\t\tdst[2] = w1 * a2 + w2 * b2\n\t\tdst[3] = w1 * a3 + w2 * b3\n\n\t\treturn Rotation.create({ rotation: dst, normalize: true }, dst)\n\t},\n\n\t/**\n\t * Creates/Initiates a new Rotation\n\t *\n\t * <pre>\n\t *\n\t *    1) Axis,Angle:\n\t *       {\n\t *         axis : [x, y, z],\n\t *         angle: double\n\t *       }\n\t *\n\t *    2) Another Rotation:\n\t *       {\n\t *         rotation : [q0, q1, q2, q3],\n\t *         normalize: boolean\n\t *       }\n\t *\n\t *    3) 3 euler angles, XYZ-order:\n\t *       {\n\t *         angles_xyz : [rX, rY, rZ]\n\t *       }\n\t *\n\t * </pre>\n\t *\n\t *\n\t * @param {Object} def - Definition, for creating the new Rotation\n\t * @param {Number[]} dst - resulting rotation\n\t * @returns {Number[]} dst - resulting rotation\n\t */\n\tcreate: function (def, dst) {\n\t\tdst = Rotation.assert(dst)\n\n\t\t// 1) from axis and angle\n\t\tif (def.axis) {\n\t\t\tvar axis = def.axis\n\t\t\tvar angle = def.angle\n\n\t\t\tvar norm = Vec3.mag(axis)\n\t\t\tif (norm === 0.0) return // vector is of zero length\n\n\t\t\tvar halfAngle = -0.5 * angle\n\t\t\tvar coeff = Math.sin(halfAngle) / norm\n\n\t\t\tdst[0] = Math.cos(halfAngle)\n\t\t\tdst[1] = coeff * axis[0]\n\t\t\tdst[2] = coeff * axis[1]\n\t\t\tdst[3] = coeff * axis[2]\n\t\t\treturn dst\n\t\t}\n\n\t\t// 2) from another rotation\n\t\tif (def.rotation) {\n\t\t\tdst[0] = def.rotation[0]\n\t\t\tdst[1] = def.rotation[1]\n\t\t\tdst[2] = def.rotation[2]\n\t\t\tdst[3] = def.rotation[3]\n\n\t\t\tif (def.normalize) {\n\t\t\t\tvar inv =\n\t\t\t\t\t1.0 / Math.sqrt(dst[0] * dst[0] + dst[1] * dst[1] + dst[2] * dst[2] + dst[3] * dst[3])\n\t\t\t\tdst[0] *= inv\n\t\t\t\tdst[1] *= inv\n\t\t\t\tdst[2] *= inv\n\t\t\t\tdst[3] *= inv\n\t\t\t}\n\n\t\t\treturn dst\n\t\t}\n\n\t\t// 3) from 3 euler angles, order XYZ\n\t\tif (def.angles_xyz) {\n\t\t\tvar ax = -0.5 * def.angles_xyz[0]\n\t\t\tvar ay = -0.5 * def.angles_xyz[1]\n\t\t\tvar az = -0.5 * def.angles_xyz[2]\n\n\t\t\tvar rotX = [Math.cos(ax), Math.sin(ax), 0, 0]\n\t\t\tvar rotY = [Math.cos(ay), 0, Math.sin(ay), 0]\n\t\t\tvar rotZ = [Math.cos(az), 0, 0, Math.sin(az)]\n\n\t\t\tRotation.applyToRotation(rotY, rotZ, dst)\n\t\t\tRotation.applyToRotation(rotX, dst, dst)\n\n\t\t\treturn dst\n\t\t}\n\t},\n\n\t//\n\t// ... to be continued ...\n\t//\n}\n\n////////////////////////////////////////////////////////////////////////////////\n//\n// SCALAR\n//\n////////////////////////////////////////////////////////////////////////////////\n/**\n * Scalar as a simple number.\n *\n * Note: Only functions that were required for the EasyCam to work are implemented.\n *\n * @namespace\n */\nvar Scalar = {\n\t/**\n\t * Linear interpolation between A and B using t[0,1]\n\t */\n\tmix: function (a, b, t) {\n\t\treturn a * (1 - t) + b * t\n\t},\n\n\t/**\n\t * modifying t as a function of smoothstep(0,1,t);\n\t */\n\tsmoothstep: function (x) {\n\t\treturn x * x * (3 - 2 * x)\n\t},\n\n\t/**\n\t * modifying t as a function of smootherstep(0,1,t);\n\t */\n\tsmootherstep: function (x) {\n\t\treturn x * x * x * (x * (x * 6 - 15) + 10)\n\t},\n}\n\n////////////////////////////////////////////////////////////////////////////////\n//\n// VEC3\n//\n////////////////////////////////////////////////////////////////////////////////\n/**\n * Vec3 as a 3D vector (Array)\n *\n * @namespace\n */\nvar Vec3 = {\n\tassert: function (dst) {\n\t\treturn dst === undefined || dst.constructor !== Array ? [0, 0, 0] : dst\n\t},\n\n\tisScalar: function (arg) {\n\t\t// TODO: do some profiling to figure out what fails\n\t\treturn arg !== undefined && arg.constructor !== Array\n\t\t// return typeof(arg) === 'number';\n\t},\n\n\t/** addition: <pre> dst = a + b </pre>  */\n\tadd: function (a, b, dst) {\n\t\tdst = this.assert(dst)\n\t\tif (this.isScalar(b)) {\n\t\t\tdst[0] = a[0] + b\n\t\t\tdst[1] = a[1] + b\n\t\t\tdst[2] = a[2] + b\n\t\t} else {\n\t\t\tdst[0] = a[0] + b[0]\n\t\t\tdst[1] = a[1] + b[1]\n\t\t\tdst[2] = a[2] + b[2]\n\t\t}\n\t\treturn dst\n\t},\n\n\t/** componentwise multiplication: <pre> dst = a * b </pre>  */\n\tmult: function (a, b, dst) {\n\t\tdst = this.assert(dst)\n\t\tif (this.isScalar(b)) {\n\t\t\tdst[0] = a[0] * b\n\t\t\tdst[1] = a[1] * b\n\t\t\tdst[2] = a[2] * b\n\t\t} else {\n\t\t\tdst[0] = a[0] * b[0]\n\t\t\tdst[1] = a[1] * b[1]\n\t\t\tdst[2] = a[2] * b[2]\n\t\t}\n\t\treturn dst\n\t},\n\n\t/** squared length  */\n\tmagSq: function (a) {\n\t\treturn a[0] * a[0] + a[1] * a[1] + a[2] * a[2]\n\t},\n\n\t/** length  */\n\tmag: function (a) {\n\t\treturn Math.sqrt(a[0] * a[0] + a[1] * a[1] + a[2] * a[2])\n\t},\n\n\t/** dot-product  */\n\tdot: function (a, b) {\n\t\treturn a[0] * b[0] + a[1] * b[1] + a[2] * b[2]\n\t},\n\n\t/** cross-product  */\n\tcross: function (a, b, dst) {\n\t\tdst = this.assert(dst)\n\t\tdst[0] = a[1] * b[2] - a[2] * b[1]\n\t\tdst[1] = a[2] * b[0] - a[0] * b[2]\n\t\tdst[2] = a[0] * b[1] - a[1] * b[0]\n\t\treturn dst\n\t},\n\n\t/** angle  */\n\tangle: function (v1, v2) {\n\t\tvar normProduct = this.mag(v1) * this.mag(v2)\n\t\tif (normProduct === 0.0) {\n\t\t\treturn 0.0 // at least one vector is of zero length\n\t\t}\n\n\t\tvar dot = this.dot(v1, v2)\n\t\tvar threshold = normProduct * 0.9999\n\t\tif (dot < -threshold || dot > threshold) {\n\t\t\t// the vectors are almost aligned, compute using the sine\n\t\t\tvar v3 = this.cross(v1, v2)\n\t\t\tif (dot >= 0) {\n\t\t\t\treturn Math.asin(this.mag(v3) / normProduct)\n\t\t\t} else {\n\t\t\t\treturn Math.PI - Math.asin(this.mag(v3) / normProduct)\n\t\t\t}\n\t\t}\n\n\t\t// the vectors are sufficiently separated to use the cosine\n\t\treturn Math.acos(dot / normProduct)\n\t},\n\n\t/** linear interpolation: <pre> dst = a * (1 - t) + b * t </pre> */\n\tmix(a, b, t, dst) {\n\t\tdst = this.assert(dst)\n\t\tdst[0] = Scalar.mix(a[0], b[0], t)\n\t\tdst[1] = Scalar.mix(a[1], b[1], t)\n\t\tdst[2] = Scalar.mix(a[2], b[2], t)\n\t\treturn dst\n\t},\n\n\t//\n\t// ... to be continued ...\n\t//\n}\n\n////////////////////////////////////////////////////////////////////////////////\n//\n// public objects\n//\n////////////////////////////////////////////////////////////////////////////////\n\n/**\n * @static\n */\nEasyCam.INFO = INFO // make static\nObject.freeze(INFO) // and constant\n\n// ext = (ext !== undefined) ? ext : {};\n\n/**\n * @memberof Dw\n */\next.EasyCam = EasyCam\n/**\n * @memberof Dw\n */\next.DampedAction = DampedAction\n/**\n * @memberof Dw\n */\next.Interpolation = Interpolation\n/**\n * @memberof Dw\n */\next.Rotation = Rotation\n/**\n * @memberof Dw\n */\next.Vec3 = Vec3\n/**\n * @memberof Dw\n */\next.Scalar = Scalar\n\n// return ext;\n//\n//\n// })(Dw);\n\n// export const { DampedAction, Interpolation, Rotation, Vec3, Scalar } = ext\nexport default ext\n\n// /**\n//  * @submodule Camera\n//  * @for p5\n//  */\n//\n// if(p5){\n//\n//\n//   /**\n//    * p5.EasyCam creator function.\n//    * Arguments are optional, and equal to the default EasyCam constructor.\n//    * @return {EasyCam} a new EasyCam\n//    */\n//   p5.prototype.createEasyCam = function(/* p5.RendererGL, {state} */){\n//\n//     var renderer = this._renderer;\n//     var args     = arguments[0];\n//\n//     if(arguments[0] instanceof p5.RendererGL){\n//       renderer = arguments[0];\n//       args     = arguments[1]; // could still be undefined, which is fine\n//     }\n//\n//     return new Dw.EasyCam(renderer, args);\n//   }\n// }\n","export class Vec extends window.p5.Vector {\n\tw = 0\n\n\tconstructor(...vals: number[]) {\n\t\tsuper()\n\t\tthis.setFromArray(vals)\n\t}\n\n\tclone = (): Vec => new Vec(this.x, this.y, this.z)\n\tcloneMult = (val: number | Vec) => this.clone().applyMult(val)\n\tcloneAdd = (val: number | Vec) => this.clone().applyAdd(val)\n\tcloneSub = (val: number | Vec) => this.clone().applySub(val)\n\n\tisZero = () => this.x === 0 && this.y === 0 && this.z === 0\n\tisOne = () => this.x === 1 && this.y === 1 && this.z === 1\n\tisEqual = (other: Vec) => this.x === other.x && this.y === other.y && this.z === other.z\n\tnormalize = () => this.applyMult(1.0/this.mag())\n\n\ttoArray = () => [this.x, this.y, this.z]\n\tsetFromArray = (vals: number[]) => {\n\t\tthis.x = vals.length > 0 ? vals[0] : 0\n\t\tthis.y = vals.length > 1 ? vals[1] : this.x\n\t\tthis.z = vals.length > 2 ? vals[2] : vals.length === 2 ? 0 : this.x\n\t\treturn this\n\t}\n\n\tapplyMult = (val: number | Vec) => {\n\t\tif (val instanceof Vec) {\n\t\t\tthis.x *= val.x\n\t\t\tthis.y *= val.y\n\t\t\tthis.z *= val.z\n\t\t\treturn this\n\t\t}\n\t\tthis.x *= val\n\t\tthis.y *= val\n\t\tthis.z *= val\n\t\treturn this\n\t}\n\n\tapplyAdd = (val: number | Vec) => {\n\t\tif (val instanceof Vec) {\n\t\t\tthis.x += val.x\n\t\t\tthis.y += val.y\n\t\t\tthis.z += val.z\n\t\t\treturn this\n\t\t}\n\t\tthis.x += val\n\t\tthis.y += val\n\t\tthis.z += val\n\t\treturn this\n\t}\n\n\tapplySub = (val: number | Vec) => {\n\t\tif (val instanceof Vec) {\n\t\t\tthis.x -= val.x\n\t\t\tthis.y -= val.y\n\t\t\tthis.z -= val.z\n\t\t\treturn this\n\t\t}\n\t\tthis.x -= val\n\t\tthis.y -= val\n\t\tthis.z -= val\n\t\treturn this\n\t}\n\n\tcloneMultMat = (mat: number[]): Vec => {\n\t\tif (!mat.length || mat.length !== 16) {\n\t\t\tconsole.error('[Vec #applyMult] invalid matrix provided for mult', mat)\n\t\t\treturn this.clone()\n\t\t}\n\t\tconst dest = new Vec()\n\t\tdest.x = mat[0] * this.x + mat[4] * this.y + mat[8] * this.z + mat[12]\n\t\tdest.y = mat[1] * this.x + mat[5] * this.y + mat[9] * this.z + mat[13]\n\t\tdest.z = mat[2] * this.x + mat[6] * this.y + mat[10] * this.z + mat[14]\n\t\tdest.w = mat[3] * this.x + mat[7] * this.y + mat[11] * this.z + mat[15]\n\t\tif (Math.abs(dest.w) > Number.EPSILON) {\n\t\t\tdest.applyMult(1.0 / dest.w)\n\t\t}\n\t\treturn dest\n\t}\n}\n","import { Vec } from './Vec'\nimport { Xform } from './Xform'\n\nexport class Bounds {\n\tmin = new Vec(-1.0)\n\tmax = new Vec(1.0)\n\n\tconstructor(min?: Vec, max?: Vec) {\n\t\tif (min) { this.min = min }\n\t\tif (max) { this.max = max }\n\t}\n\n\tclone = () => new Bounds(this.min.clone(), this.max.clone())\n\tcloneXform = (xform: Xform) => this.clone().applyXform(xform)\n\n\tapplyXform = (xform: Xform) => {\n\t\txform.applyTo(this.min)\n\t\txform.applyTo(this.max)\n\t\tthis.sanitize()\n\t\treturn this\n\t}\n\n\tsanitize = () => {\n\t\tif (this.min.x > this.max.x) {\n\t\t\tconst tmp = this.min.x\n\t\t\tthis.min.x = this.max.x\n\t\t\tthis.max.x = tmp\n\t\t}\n\t\tif (this.min.y > this.max.y) {\n\t\t\tconst tmp = this.min.y\n\t\t\tthis.min.y = this.max.y\n\t\t\tthis.max.y = tmp\n\t\t}\n\t\tif (this.min.z > this.max.z) {\n\t\t\tconst tmp = this.min.z\n\t\t\tthis.min.z = this.max.z\n\t\t\tthis.max.z = tmp\n\t\t}\n\t\treturn this\n\t}\n\n\t// pushInside returns a zero vector if this bounds is inside the other bounds;\n\t// otherwise, returns the vector required to move this bounds into other\n\tpushInside = (other: Bounds): Vec => {\n\t\tconst off = new Vec()\n\t\tif (this.min.x < other.min.x) {\n\t\t\toff.x = other.min.x - this.min.x\n\t\t} else if (this.max.x > other.max.x) {\n\t\t\toff.x = other.max.x - this.max.x\n\t\t}\n\t\tif (this.min.y < other.min.y) {\n\t\t\toff.y = other.min.y - this.min.y\n\t\t} else if (this.max.y > other.max.y) {\n\t\t\toff.y = other.max.y - this.max.y\n\t\t}\n\t\tif (this.min.z < other.min.z) {\n\t\t\toff.z = other.min.z - this.min.z\n\t\t} else if (this.max.z > other.max.z) {\n\t\t\toff.z = other.max.z - this.max.z\n\t\t}\n\t\treturn off\n\t}\n\n\tcenterAndSize = () => {\n\t\treturn {\n\t\t\tcenter: new Vec(\n\t\t\t\t(this.max.x + this.min.x) / 2,\n\t\t\t\t(this.max.y + this.min.y) / 2,\n\t\t\t\t(this.max.z + this.min.z) / 2,\n\t\t\t),\n\t\t\tsize: new Vec(\n\t\t\t\t(this.max.x - this.min.x),\n\t\t\t\t(this.max.y - this.min.y),\n\t\t\t\t(this.max.z - this.min.z),\n\t\t\t),\n\t\t}\n\t}\n}\n","import { Vec } from './Vec'\n\nexport class Xform {\n\tpos: Vec\n\trot: Vec\n\tscale: Vec\n\n\tconstructor(pos?: Vec, rot?: Vec, scale?: Vec) {\n\t\tthis.pos = pos ? pos : new Vec()\n\t\tthis.rot = rot ? rot : new Vec()\n\t\tthis.scale = scale ? scale : new Vec(1.0)\n\t}\n\n\tapplyTo = (vec: Vec) => {\n\t\tvec.applyMult(this.scale)\n\t\t// TODO: rotation\n\t\tvec.applyAdd(this.pos)\n\t}\n}\n","import { drawFunc, Obj } from './Obj'\n\nexport class Component {\n\tparent: Obj\n\tdrawDebug?: drawFunc\n\n\tconstructor(parent: Obj) {\n\t\tthis.parent = parent\n\t}\n\n\tdestroy() {\n\t\tconsole.log('[Component] destroyed')\n\t}\n\n\tupdate(_dt: number) {\n\t\tconsole.warn('[Component] update')\n\t}\n}\n","import * as p5 from 'p5'\nimport { Obj } from './Obj'\n\nexport type Engine3DOpts = {\n\tdebug?: boolean\n}\n\nexport class Engine3D {\n\tobjs: Obj[] = []\n\tdebug = false\n\tlastUpdate?: number\n\n\tconstructor(opts: Engine3DOpts = {}) {\n\t\tif (opts.debug) {\n\t\t\tthis.debug = true\n\t\t}\n\t}\n\n\taddObj = (obj: Obj) => this.objs.push(obj)\n\trmObj = (obj: Obj) => {\n\t\tthis.objs = this.objs.filter(oo => {\n\t\t\tif (oo === obj) {\n\t\t\t\too.destroy()\n\t\t\t\treturn false\n\t\t\t}\n\t\t\treturn true\n\t\t})\n\t}\n\n\tupdate = () => {\n\t\tif (!this.lastUpdate) {\n\t\t\tthis.lastUpdate = new Date().valueOf()\n\t\t\treturn\n\t\t}\n\t\tconst now = new Date().valueOf()\n\t\tconst dt = (now - this.lastUpdate) / 1000\n\t\tthis.lastUpdate = now\n\t\tthis.objs.forEach(oo => oo.update(dt))\n\t}\n\n\tdraw = (pg: p5.Graphics) => {\n\t\tfor (const obj of this.objs) {\n\t\t\tobj.draw(pg)\n\t\t\tif (this.debug) {\n\t\t\t\tobj.drawDebug(pg)\n\t\t\t}\n\t\t}\n\t}\n\n\tdraw2D = (pp: p5, pg: p5.Graphics) => {\n\t\tconst gg = pg as any\n\t\tconst mvp = gg._renderer.uMVMatrix.copy().mult(gg._renderer.uPMatrix)\n\t\tfor (const obj of this.objs) {\n\t\t\tobj.draw2D(pp, pg, mvp.mat4)\n\t\t}\n\t}\n}\n\nexport const engine3d = new Engine3D({ debug: false })\n","import * as p5 from 'p5'\nimport { Vec } from './Vec'\nimport { Xform } from './Xform'\nimport { Component } from './Component'\nimport { engine3d } from './engine3d'\n\nexport type drawFunc = (pg: p5.Graphics) => void\nexport type drawFunc2D = (pp: p5, pos: Vec, scale: number) => void\n\nexport type ObjOpts = {\n\tcomps?: Component[]\n\tpos?: Vec\n\trot?: Vec\n\tscale?: Vec\n\tdraw?: drawFunc\n\tdraw2D?: drawFunc2D\n}\n\nexport class Obj {\n\tcomps: Component[] = []\n\txform: Xform = new Xform()\n\tdrawFunc?: drawFunc\n\tdrawFunc2D?: drawFunc2D\n\n\tconstructor(opts: ObjOpts) {\n\t\tconsole.log('[Obj] ctor', this)\n\t\tthis.drawFunc = opts.draw\n\t\tthis.drawFunc2D = opts.draw2D\n\t\tif (opts.comps) {\n\t\t\tthis.comps = opts.comps\n\t\t}\n\t\tif (opts.pos) {\n\t\t\tthis.xform.pos = opts.pos\n\t\t}\n\t\tif (opts.rot) {\n\t\t\tthis.xform.rot = opts.rot\n\t\t}\n\t\tif (opts.scale) {\n\t\t\tthis.xform.scale = opts.scale\n\t\t}\n\t\tengine3d.addObj(this)\n\t}\n\n\tdestroy = () => {\n\t\tthis.comps.forEach(cc => cc.destroy())\n\t\tconsole.log('[Obj] destroyed')\n\t}\n\trm = () => {\n\t\tengine3d.rmObj(this)\n\t}\n\n\taddComp = (comp: Component) => {\n\t\tthis.comps.push(comp)\n\t}\n\trmComponent = (comp: Component) => {\n\t\tthis.comps = this.comps.filter(cc => {\n\t\t\tif (cc === comp) {\n\t\t\t\tcc.destroy()\n\t\t\t\treturn false\n\t\t\t}\n\t\t\treturn true\n\t\t})\n\t}\n\tgetComps = (compType: any) => this.comps.filter(cc => cc instanceof compType)\n\tgetComp = (compType: any): Component | null => {\n\t\tconst cs = this.getComps(compType)\n\t\tif (cs.length) {\n\t\t\treturn cs[0]\n\t\t}\n\t\treturn null\n\t}\n\n\tupdate(dt: number) {\n\t\tthis.comps.forEach(cc => cc.update(dt))\n\t}\n\n\tdraw(pg: p5.Graphics) {\n\t\tpg.push()\n\t\tthis.applyXformToGraphics(pg)\n\t\tif (this.drawFunc) {\n\t\t\tthis.drawFunc(pg)\n\t\t}\n\t\tpg.pop()\n\t}\n\n\tdraw2D(pp: p5, pg: p5.Graphics, mvp: number[]) {\n\t\tif (!this.drawFunc2D) {\n\t\t\treturn\n\t\t}\n\t\tconst { pos, scale } = this.xform\n\t\tconst ndcPos = pos.cloneMultMat(mvp)\n\t\tconst edge = 1.2\n\t\tif (ndcPos.w < 0 || ndcPos.x < -edge || ndcPos.x > edge || ndcPos.y < -edge || ndcPos.y > edge) {\n\t\t\t// object is off-screen\n\t\t\treturn\n\t\t}\n\t\t// calculate a rough-guess at screen-space scale\n\t\t// (would use inverse MVP matrix but I can't get p5's matrix invert method to work)\n\t\tconst ndcPos2 = pos.cloneAdd(scale).cloneMultMat(mvp)\n\t\tconst ndcPos3 = pos.cloneAdd(scale.cloneMult(new Vec(1, -1, -1))).cloneMultMat(mvp)\n\t\tconst ndcPos4 = pos.cloneAdd(scale.cloneMult(new Vec(-1, -1, 1))).cloneMultMat(mvp)\n\t\tfor (const ndc of [ndcPos, ndcPos2, ndcPos3, ndcPos4]) {\n\t\t\tndc.x = (ndc.x + 1) * pp.width / 2\n\t\t\tndc.y = (1 - ndc.y) * pp.height / 2\n\t\t\tndc.z = 0\n\t\t}\n\t\tconst scale2d = Math.max(\n\t\t\tndcPos.cloneSub(ndcPos2).mag(),\n\t\t\tndcPos.cloneSub(ndcPos3).mag(),\n\t\t\tndcPos.cloneSub(ndcPos4).mag(),\n\t\t)\n\t\tpp.push()\n\t\tthis.drawFunc2D(pp, ndcPos, scale2d)\n\t\tpp.pop()\n\t}\n\n\tdrawDebug = (pg: p5.Graphics) => {\n\t\tthis.comps.forEach(cc => cc.drawDebug && cc.drawDebug(pg))\n\t}\n\n\tapplyXformToGraphics = (pg: p5.Graphics) => {\n\t\tconst { pos, rot, scale } = this.xform\n\t\tif (!pos.isZero()) {\n\t\t\tpg.translate(pos.x, pos.y, pos.z)\n\t\t}\n\t\tif (rot.z !== 0) pg.rotateZ(rot.z)\n\t\tif (rot.y !== 0) pg.rotateY(rot.y)\n\t\tif (rot.x !== 0) pg.rotateX(rot.x)\n\t\tif (!scale.isOne()) {\n\t\t\tpg.scale(scale.x, scale.y, scale.z)\n\t\t}\n\t}\n}\n","import { Bounds, Component, Obj, Vec } from '../core'\n\nconst gravity = new Vec(0, -9.82, 0)\nexport type PhysicalOpts = {\n\tbounds?: Bounds\n\tworldScale?: number\n}\n\n// Physical is a very simple physics implementation, applying forces\n// to the parent object and constraining it to a hard-coded world bounds\nexport class Physical extends Component {\n\tforce = new Vec()\n\tvel = new Vec()\n\tbounds: Bounds\n\tworld: Bounds\n\n\tconstructor(parent: Obj, opts: PhysicalOpts = {}) {\n\t\tsuper(parent)\n\t\tthis.bounds = opts.bounds ? opts.bounds : new Bounds()\n\t\tif (!opts.worldScale) {\n\t\t\topts.worldScale = 1000\n\t\t}\n\t\tthis.world = new Bounds(\n\t\t\tnew Vec(-opts.worldScale, 0, -opts.worldScale),\n\t\t\tnew Vec(opts.worldScale, opts.worldScale, opts.worldScale),\n\t\t)\n\t}\n\n\tupdate = (dt: number) => {\n\t\t// Update velocity based on forces\n\t\tthis.vel.applyAdd(gravity.cloneAdd(this.force).applyMult(dt))\n\t\tthis.vel.applyMult(new Vec(0.8, 1.0, 0.8)) // friction in X and Z\n\t\tif (this.vel.magSq() < 0.01) {\n\t\t\t// Velocity threshold\n\t\t\tthis.vel.applyMult(0)\n\t\t}\n\t\t// Update position based on velocity\n\t\tconst { pos } = this.parent.xform\n\t\tpos.applyAdd(this.vel)\n\t\t// Constrain to world bounds\n\t\tconst off = this.worldBounds().pushInside(this.world)\n\t\tif (off.isZero()) {\n\t\t\treturn\n\t\t}\n\t\t// Apply constraint offset\n\t\tpos.applyAdd(off)\n\t\t// Bounce the velocity\n\t\tif (off.x !== 0) {\n\t\t\tthis.vel.x *= -0.5\n\t\t}\n\t\tif (off.y !== 0) {\n\t\t\tthis.vel.y *= -0.5\n\t\t}\n\t\tif (off.z !== 0) {\n\t\t\tthis.vel.z *= -0.5\n\t\t}\n\t}\n\n\tdrawDebug = (pg: p5.Graphics) => {\n\t\tconst { center, size } = this.worldBounds().centerAndSize()\n\t\tpg.push()\n\t\tpg.noFill()\n\t\tpg.stroke(255, 0, 0)\n\t\tpg.strokeWeight(1)\n\t\tpg.translate(center.x, center.y, center.z)\n\t\tpg.box(size.x, size.y, size.z)\n\t\tpg.pop()\n\t}\n\n\tworldBounds = () => this.bounds.cloneXform(this.parent.xform)\n}\n","import { EasyCam } from 'vendor/p5.easycam.js'\nimport { Component, Obj } from '../core'\n\n// FollowCam locks an EasyCam's center to the parent Obj\nexport class FollowCam extends Component {\n\tcam: EasyCam\n\n\tconstructor(parent: Obj, cam: EasyCam) {\n\t\tsuper(parent)\n\t\tthis.cam = cam\n\t}\n\n\tlast?: number\n\tupdate = (dt: number) => {\n\t\tif (!this.cam.state || !this.cam.state.center) {\n\t\t\treturn\n\t\t}\n\t\tconst { x, y, z } = this.parent.xform.pos\n\t\tthis.cam.setCenter([x, y, z], 0)\n\t}\n}\n","import * as p5 from 'p5'\nimport { EasyCam } from 'vendor/p5.easycam.js'\nimport { User, UserForce, UserXform } from 'app/serverApi/serverApi'\nimport { Obj, ObjOpts, Vec } from '../core'\nimport { Physical, PhysicalOpts, FollowCam } from '../components'\n\ntype KeyMovement = {\n\tup: boolean\n\tdown: boolean\n\tleft: boolean\n\tright: boolean\n\tjump: boolean\n\tjumpInitial: boolean\n\tgain: number\n}\n\ntype forceFunc = (data: UserXform) => void\n\nexport type AvatarOpts = ObjOpts & {\n\tuser: User\n\tphys?: PhysicalOpts\n\tonForce?: forceFunc\n}\n\nexport class Avatar extends Obj {\n\tphys: Physical\n\tuser: User\n\tfollowCam?: FollowCam\n\tonForce?: forceFunc\n\n\tkeys: KeyMovement = {\n\t\tup: false,\n\t\tdown: false,\n\t\tleft: false,\n\t\tright: false,\n\t\tjump: false,\n\t\tjumpInitial: false,\n\t\tgain: 150,\n\t}\n\n\tconstructor(opts: AvatarOpts) {\n\t\tsuper(opts)\n\t\tthis.user = opts.user\n\t\tthis.phys = new Physical(this, opts.phys)\n\t\tthis.comps = [this.phys]\n\t\tthis.onForce = opts.onForce\n\t\tif (!this.drawFunc) {\n\t\t\tthis.drawFunc = this.render\n\t\t}\n\t\tif (!this.drawFunc2D) {\n\t\t\tthis.drawFunc2D = this.render2D\n\t\t}\n\t\tconsole.log('[Avatar] ctor', this)\n\t}\n\n\tupdate(dt: number) {\n\t\tsuper.update(dt)\n\t\tif (this.keys.jumpInitial) {\n\t\t\tthis.keys.jumpInitial = false\n\t\t\tthis.keysUpdated()\n\t\t}\n\t}\n\n\tdraw(pg: p5.Graphics) {\n\t\tsuper.draw(pg) // applys xform and calls this.render\n\t\t// draw shadow\n\t\tconst { pos, scale } = this.xform\n\t\tpg.push()\n\t\tpg.fill(30)\n\t\tpg.noStroke()\n\t\tpg.translate(pos.x, 0, pos.z)\n\t\tpg.scale(scale.x, 0, scale.z)\n\t\tpg.rotateX(Math.PI/2)\n\t\tpg.circle(0, 0, 2)\n\t\tpg.pop()\n\t}\n\n\trender = (pg: p5.Graphics) => {\n\t\tpg.fill(0)\n\t\tpg.stroke(255)\n\t\tpg.strokeWeight(2)\n\t\tpg.sphere(1, 7, 7)\n\t}\n\n\trender2D = (pp: p5, pos: Vec, scale: number) => {\n\t\tconst { name, instrument, offset } = this.user\n\t\tif (scale < 15) {\n\t\t\treturn\n\t\t}\n\t\tconst ss = Math.min(scale, 50)\n\t\tpp.translate(pos.x, pos.y)\n\t\tpp.textAlign(pp.CENTER, pp.BOTTOM)\n\t\tpp.fill(255)\n\t\tpp.noStroke()\n\t\tpp.textSize(ss/2)\n\t\tpp.textStyle(pp.BOLD)\n\t\tif (scale < 35) {\n\t\t\tpp.text(name, 0, -ss * 0.8)\n\t\t\treturn\n\t\t} else {\n\t\t\tpp.text(name, 0, -ss * 1.1)\n\t\t}\n\t\tpp.fill(225)\n\t\tpp.textSize(ss * 0.3)\n\t\tpp.textStyle(pp.ITALIC)\n\t\tpp.text(`${instrument} (@${offset > 0 ? '+' : ''}${offset})`, 0, -ss * 0.75)\n\t}\n\n\taddFollowCam = (cam: EasyCam) => {\n\t\tthis.followCam = new FollowCam(this, cam)\n\t\tthis.followCam.update(0)\n\t\tthis.addComp(this.followCam)\n\t}\n\n\tgetUserXform = (): UserXform => ({\n\t\tclientId: this.user.clientId,\n\t\tpos: this.xform.pos.toArray(),\n\t\trot: this.xform.rot.toArray(),\n\t\tscale: this.xform.scale.toArray(),\n\t\tforce: this.phys.force.toArray(),\n\t\tvel: this.phys.vel.toArray(),\n\t})\n\n\tsetUserXform = (data: UserXform) => {\n\t\tthis.xform.pos.setFromArray(data.pos)\n\t\tthis.xform.rot.setFromArray(data.rot)\n\t\tthis.xform.scale.setFromArray(data.scale)\n\t\tthis.phys.force.setFromArray(data.force)\n\t\tthis.phys.vel.setFromArray(data.vel)\n\t}\n\n\tsetUserForce = (data: UserForce) => {\n\t\tthis.phys.force.setFromArray(data.force)\n\t}\n\n\t//\n\t// Keyboard state updates and movement controls\n\t//\n\tkeyPressed = (evt: p5) => this.keyChanged(evt, true)\n\tkeyReleased = (evt: p5) => this.keyChanged(evt, false)\n\tkeyChanged = (evt: p5, pressed: boolean) => {\n\t\tswitch (evt.key) {\n\t\t\tcase 'ArrowUp':\n\t\t\t\tthis.keys.up = pressed\n\t\t\t\tbreak\n\t\t\tcase 'ArrowDown':\n\t\t\t\tthis.keys.down = pressed\n\t\t\t\tbreak\n\t\t\tcase 'ArrowLeft':\n\t\t\t\tthis.keys.left = pressed\n\t\t\t\tbreak\n\t\t\tcase 'ArrowRight':\n\t\t\t\tthis.keys.right = pressed\n\t\t\t\tbreak\n\t\t\tcase ' ':\n\t\t\t\tthis.keys.jump = pressed\n\t\t\t\tthis.keys.jumpInitial = pressed\n\t\t\t\tbreak\n\t\t\tdefault:\n\t\t\t\treturn\n\t\t}\n\t\tthis.keysUpdated()\n\t}\n\n\t// keysUpdated applies force to the Physical component based on keyboard state and camera orientation\n\tkeysUpdated = () => {\n\t\tconst { up, down, left, right, jump, jumpInitial, gain } = this.keys\n\t\tconst mov = new Vec()\n\t\tmov.x = left && right ? 0 : left ? -gain : right ? gain : 0\n\t\tmov.y = jumpInitial && this.xform.pos.y < this.xform.scale.y * 1.5 ? gain * 2 : jump ? 5 : 0\n\t\tmov.z = down && up ? 0 : up ? gain : down ? -gain : 0\n\t\tif (!this.followCam) {\n\t\t\t// Can't determine camera orientation, apply force in world-space\n\t\t\tthis.phys.force = mov\n\t\t\tif (this.onForce) {\n\t\t\t\tthis.onForce(this.getUserXform())\n\t\t\t}\n\t\t\treturn\n\t\t}\n\t\t// Convert movement vector to force based on camera orientation\n\t\tconst ca = this.followCam.cam.centerAxes() // X=screen-right Z=screen-up, parallel to ground plane\n\t\tconst cax = new Vec(ca.x[0], ca.x[1], ca.x[2])\n\t\tconst caz = new Vec(ca.z[0], ca.z[1], ca.z[2])\n\t\tconst ff = new Vec(0, mov.y, 0)\n\t\tff.applyAdd(cax.applyMult(mov.x))\n\t\tff.applyAdd(caz.applyMult(mov.z))\n\t\tthis.phys.force = ff\n\t\tif (this.onForce) {\n\t\t\tthis.onForce(this.getUserXform())\n\t\t}\n\t}\n\n\t// userUpdated = () => {\n\t// \tconsole.log('[Avatar #userUpdated]', this.user.name)\n\t// }\n\n}\n","import * as p5 from 'p5'\nimport { Obj, ObjOpts } from '../core'\n\nexport class Ground extends Obj {\n\thue: number\n\tsat: number\n\n\tconstructor(opts: ObjOpts = {}) {\n\t\tconst subDF = opts.draw\n\t\topts.draw = (pg: p5.Graphics) => {\n\t\t\tpg.colorMode(pg.HSL, 1)\n\t\t\t// Draw ground plane\n\t\t\tpg.angleMode(pg.RADIANS)\n\t\t\tpg.fill(this.hue, this.sat, 0.3)\n\t\t\tpg.noStroke()\n\t\t\tpg.rotateX(Math.PI / 2)\n\t\t\tpg.rect(-1, -1, 2, 2)\n\t\t\tif (subDF) {\n\t\t\t\tsubDF(pg)\n\t\t\t}\n\t\t\tpg.colorMode(pg.RGB, 255)\n\t\t}\n\t\tsuper(opts)\n\t\tthis.hue = 0.5\n\t\tthis.sat = 0\n\t}\n}\n","import * as p5 from 'p5'\nimport Sketch from './Sketch'\nimport { clockUpdateReq, ClockOpts } from './serverApi/serverClock'\n\nconst userInputsY = 40\n\nexport class SketchInputs {\n\tparent: Sketch\n\tpp?: p5\n\tnameCustomized = false\n\tinputs: {\n\t\t// DOM input elements\n\t\tname?: any\n\t\tinstrument?: any\n\t\tinputDevice?: any\n\t\toffset?: any\n\t\tbpm?: any\n\t\thide?: any\n\t} = {}\n\thidden = false\n\tclockOpts: ClockOpts = {\n\t\tbpm: 95,\n\t}\n\n\tconstructor(parent: Sketch) {\n\t\tthis.parent = parent\n\t}\n\n\tbpm = () => (this.inputs.bpm ? this.inputs.bpm.value() : this.clockOpts.bpm)\n\n\tisFocused = () => {\n\t\tfor (const key in this.inputs) {\n\t\t\tconst input = (this.inputs as any)[key]\n\t\t\tif (input && input.focused) {\n\t\t\t\treturn true\n\t\t\t}\n\t\t}\n\t\treturn false\n\t}\n\n\ttoggleHide = () => {\n\t\tif (!this.pp) {\n\t\t\treturn\n\t\t}\n\t\tthis.hidden = !this.hidden\n\t\tthis.setup(this.pp)\n\t\tif (!this.hidden) {\n\t\t\tthis.setupInputsBPM()\n\t\t}\n\t}\n\n\tsetup = (pp: p5) => {\n\t\tthis.pp = pp\n\t\tif (this.hidden) {\n\t\t\tfor (const key in this.inputs) {\n\t\t\t\tconst input = (this.inputs as any)[key]\n\t\t\t\tif (!input) {\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\t\t\t\tinput.remove()\n\t\t\t\tdelete (this.inputs as any)[key]\n\t\t\t}\n\t\t\tthis.setupInputsHide(this.pp)\n\t\t\treturn\n\t\t}\n\t\tthis.setupInputsUser(this.parent.ws.clientId)\n\t\tthis.setupInputsInstrument()\n\t\tif (!this.inputs.inputDevice) {\n\t\t\tthis.setupInputsMidi(this.parent.midi.webMidi)\n\t\t}\n\t\tthis.setupInputsHide(pp)\n\t}\n\n\tsetupInputsHide = (pp: p5) => {\n\t\tif (this.inputs.hide) {\n\t\t\tthis.inputs.hide.remove()\n\t\t}\n\t\tconst inHide = pp.createButton(this.hidden ? 'Show Settings' : 'Hide Settings') as any\n\t\tinHide.position(pp.width - inHide.width - 50, pp.height - inHide.height - 10)\n\t\tinHide.mousePressed(this.toggleHide)\n\t\tthis.inputs.hide = inHide\n\t}\n\n\tsetupInputsUser = (clientId: number): any => {\n\t\tconsole.log('[SketchInputs #setupInputsUser] clientId', clientId)\n\t\tconst uu = this.parent.user\n\t\tconst defaultName = this.nameCustomized ? uu.name : `User ${this.parent.ws.clientId}`\n\t\tif (this.hidden) {\n\t\t\tif (uu.name === '') {\n\t\t\t\tthis.parent.updateUser({ name: defaultName })\n\t\t\t}\n\t\t\treturn\n\t\t}\n\t\tif (!this.pp) {\n\t\t\tconsole.warn(\n\t\t\t\t'[SketchInputs #setupInputsUser] Attempted to setup user input before sketch was initialized',\n\t\t\t)\n\t\t\treturn\n\t\t}\n\t\tif (this.inputs.name && this.nameCustomized) {\n\t\t\t// Don't re-create the input if the user has already customized their name\n\t\t\treturn\n\t\t}\n\t\tif (this.inputs.name) {\n\t\t\tthis.inputs.name.remove()\n\t\t}\n\t\tif (this.inputs.offset) {\n\t\t\tthis.inputs.offset.remove()\n\t\t}\n\t\tconst inName = this.pp.createInput(defaultName) as any\n\t\tinName.size(80)\n\t\tinName.position(20, userInputsY)\n\t\tinName.input(() => {\n\t\t\tconsole.log('[SketchInputs #inputs.name] Changed:', inName.value())\n\t\t\tthis.nameCustomized = true\n\t\t\tthis.parent.updateUser({ name: inName.value() })\n\t\t})\n\t\tinName.elt.onfocus = () => (inName.focused = true)\n\t\tinName.elt.onblur = () => (inName.focused = false)\n\t\tinName.elt.focus()\n\t\tinName.elt.select()\n\t\tthis.inputs.name = inName\n\t\tthis.parent.updateUser({ name: inName.value() }, false)\n\n\t\tconst inOffset = this.pp.createInput(`${this.parent.user.offset}`) as any\n\t\tinOffset.size(50)\n\t\tinOffset.position(inName.x + inName.width + 10, userInputsY)\n\t\tconst setOffset = () => {\n\t\t\tconst off = parseFloat(inOffset.value())\n\t\t\tif (!Number.isNaN(off)) {\n\t\t\t\tthis.parent.updateUser({ offset: off })\n\t\t\t}\n\t\t}\n\t\tinOffset.input(() => {\n\t\t\tconsole.log('[SketchInputs #inputs.offset] Changed:', inOffset.value())\n\t\t\tsetOffset()\n\t\t})\n\t\tinOffset.elt.onfocus = () => (inOffset.focused = true)\n\t\tinOffset.elt.onblur = () => (inOffset.focused = false)\n\t\tthis.inputs.offset = inOffset\n\t\tsetOffset()\n\t}\n\n\tsetupInputsInstrument = () => {\n\t\tif (!this.pp || !this.inputs.offset || this.hidden) {\n\t\t\treturn\n\t\t}\n\t\tif (this.inputs.instrument) {\n\t\t\tthis.inputs.instrument.remove()\n\t\t}\n\t\tconst inInst = this.pp.createSelect() as any\n\t\tinInst.position(this.inputs.offset.x + this.inputs.offset.width + 10, userInputsY)\n\t\tconst uinst = this.parent.user.instrument\n\t\tinInst.size(130)\n\t\tfor (const instName in this.parent.instruments) {\n\t\t\tinInst.option(instName)\n\t\t\tif (instName === uinst) {\n\t\t\t\tinInst.selected(instName)\n\t\t\t}\n\t\t}\n\t\tinInst.changed(() => {\n\t\t\tconsole.log('[SketchInputs #inputs.instrument] Changed:', inInst.value())\n\t\t\tthis.parent.updateUser({ instrument: inInst.value() })\n\t\t})\n\t\tinInst.elt.onfocus = () => (inInst.focused = true)\n\t\tinInst.elt.onblur = () => (inInst.focused = false)\n\t\tthis.inputs.instrument = inInst\n\t\tthis.parent.updateUser({ instrument: inInst.value() }, false)\n\t}\n\n\tsetupInputsMidi = (webMidi: any) => {\n\t\tif (!this.pp || !this.inputs.instrument || this.hidden) {\n\t\t\treturn\n\t\t}\n\t\tif (this.inputs.inputDevice) {\n\t\t\tthis.inputs.inputDevice.remove()\n\t\t}\n\t\tconst { inputs } = webMidi || { inputs: [] }\n\t\tconst inMidi = this.pp.createSelect() as any\n\t\tconst inInst = this.inputs.instrument\n\t\tinMidi.position(inInst.x + inInst.width + 10, userInputsY)\n\t\tinMidi.option('keyboard')\n\t\tfor (const input of inputs) {\n\t\t\tconst { _midiInput } = input\n\t\t\tif (!_midiInput) {\n\t\t\t\tconsole.error('[SketchInputs #setupInputsMidi] Received a midi input with missing data')\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tinMidi.option(_midiInput.name)\n\t\t}\n\t\tinMidi.selected(this.parent.user.inputDevice)\n\t\tinMidi.changed(() => {\n\t\t\tconsole.log('[SketchInputs #setupInputsMidi] Changed:', inMidi.value())\n\t\t\tthis.parent.updateUser({ inputDevice: inMidi.value() })\n\t\t})\n\t\tinMidi.elt.onfocus = () => (inMidi.focused = true)\n\t\tinMidi.elt.onblur = () => (inMidi.focused = false)\n\t\tthis.inputs.inputDevice = inMidi\n\t\tthis.parent.updateUser({ inputDevice: inMidi.value() }, false)\n\t}\n\n\tsetupInputsBPM = () => {\n\t\tif (!this.pp || this.hidden) {\n\t\t\treturn\n\t\t}\n\t\tif (this.inputs.bpm) {\n\t\t\tthis.inputs.bpm.remove()\n\t\t}\n\t\tconst inBPM = this.pp.createSlider(30, 200, this.clockOpts.bpm) as any\n\t\tinBPM.position(20, this.pp.height - 40)\n\t\tinBPM.size(this.pp.width / 2)\n\t\tinBPM.input(() => {\n\t\t\t// console.log('[SketchInputs #setupInputsBPM] Changed:', inBPM.value())\n\t\t\tthis.clockOpts.bpm = inBPM.value()\n\t\t\tthis.sendClockUpdate(this.clockOpts)\n\t\t})\n\t\tinBPM.elt.onfocus = () => (inBPM.focused = true)\n\t\tinBPM.elt.onblur = () => (inBPM.focused = false)\n\t\tthis.inputs.bpm = inBPM\n\t}\n\n\tdraw = (pp: p5) => {\n\t\tpp.textSize(12)\n\t\tpp.fill(255)\n\t\tpp.strokeWeight(1)\n\t\tpp.stroke(0)\n\t\tpp.textAlign(pp.LEFT, pp.BOTTOM)\n\t\tpp.textStyle(pp.BOLD)\n\t\tfor (const key in this.inputs) {\n\t\t\tif (key === 'hide') {\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tconst input = (this.inputs as any)[key]\n\t\t\tif (!input) {\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tconst xx = input.x + 3\n\t\t\tconst yy = input.y - 5\n\t\t\tswitch (true) {\n\t\t\t\tcase key === 'offset':\n\t\t\t\t\tconst off = parseFloat(input.value())\n\t\t\t\t\tlet msg = ``\n\t\t\t\t\tif (Number.isNaN(off)) {\n\t\t\t\t\t\t// Show the user that they have an invalid value\n\t\t\t\t\t\tpp.fill(255, 0, 0)\n\t\t\t\t\t\tmsg = ` (NaN!)`\n\t\t\t\t\t}\n\t\t\t\t\tpp.text(`${key.toUpperCase()}${msg}${'\\n'}(in beats)`, xx, yy)\n\t\t\t\t\tif (Number.isNaN(off)) {\n\t\t\t\t\t\t// put fill color back\n\t\t\t\t\t\tpp.fill(255)\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\tcase key in this.parent.user:\n\t\t\t\t\tpp.text(key.toUpperCase(), xx, yy)\n\t\t\t\t\tbreak\n\t\t\t\tdefault:\n\t\t\t\t\tpp.text(`${key.toUpperCase()}: ${input.value()}`, xx, yy)\n\t\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t}\n\n\tsendClockUpdate = (clk: ClockOpts) => {\n\t\tconst { conn, ready } = this.parent.ws\n\t\tif (!ready()) {\n\t\t\tconsole.warn(\n\t\t\t\t\"[SketchInputs #sendClockUpdate] Can't send bpm update, websocket connection is not open\",\n\t\t\t)\n\t\t\treturn\n\t\t}\n\t\tconn.send(clockUpdateReq(clk))\n\t}\n\n\tonClockUpdate = (clk: ClockOpts) => {\n\t\tthis.clockOpts = clk\n\t\tif (!this.inputs.bpm) {\n\t\t\treturn\n\t\t}\n\t\tthis.inputs.bpm.value(clk.bpm)\n\t}\n}\n","import AudioKeys from 'audiokeys'\nimport Sketch from './Sketch'\nimport { MidiEvent } from './MIDI'\n\ntype AudioKeysEvent = {\n\t// the midi number of the note\n\tnote: number\n\t// the keyCode of the key being pressed down\n\tkeyCode: number\n\t// the frequency of the note\n\tfrequency: number\n\t// on note down: the current velocity (this can only be set when rows = 1)\n\t// on note up: 0\n\tvelocity: number\n}\n\nexport class SketchAudioKeys {\n\tparent: Sketch\n\taudioKeys: AudioKeys\n\n\tconstructor(parent: Sketch) {\n\t\tthis.parent = parent\n\t\tthis.audioKeys = new AudioKeys({ polyphony: Infinity })\n\t\tthis.audioKeys.down(this.keyPressed)\n\t\tthis.audioKeys.up(this.keyReleased)\n\t}\n\n\tkeyPressed = (evt: AudioKeysEvent) => {\n\t\tconst { note, velocity } = evt\n\t\tif (this.parent.keyboardInputDisabled()) {\n\t\t\treturn\n\t\t}\n\t\tif (this.parent.user.inputDevice !== 'keyboard') {\n\t\t\treturn\n\t\t}\n\t\tconst midiEvt = { kind: 'noteon', note: note, attack: velocity / 128.0 } as MidiEvent\n\t\tthis.parent.sendUserEvent('keyboard', 'noteon', midiEvt)\n\t}\n\n\tkeyReleased = (evt: AudioKeysEvent) => {\n\t\tconst { note } = evt\n\t\tif (this.parent.keyboardInputDisabled()) {\n\t\t\treturn\n\t\t}\n\t\tif (this.parent.user.inputDevice !== 'keyboard') {\n\t\t\treturn\n\t\t}\n\t\tconst midiEvt = { kind: 'noteoff', note: note } as MidiEvent\n\t\tthis.parent.sendUserEvent('keyboard', 'noteoff', midiEvt)\n\t}\n}\n","import * as p5 from 'p5'\nimport * as Tone from 'tone'\nimport WSClient, { DONT_REOPEN } from './serverApi/WSClient'\nimport {\n\tuserEventReq,\n\tuserUpdateReq,\n\tuserXformReq,\n\tUser,\n\tUserEvent,\n\tUserForce,\n\tUserXform,\n} from './serverApi/serverApi'\nimport MIDI, { MidiEvent, MidiEventCC, MidiEventNote, MidiEventPitchbend } from './MIDI'\nimport { Instrument } from './Instrument'\nimport { EightOhEight, Metronome, Piano, PolySynth } from './instruments'\nimport VisualNotes from './VisualNotes'\nimport { EasyCam } from 'vendor/p5.easycam.js'\nimport { engine3d, Avatar, Ground, Vec } from 'engine3d'\nimport { SketchInputs } from './SketchInputs'\nimport { SketchAudioKeys } from './SketchAudioKeys'\n\ntype Instruments = { [key: string]: Instrument }\n\nconst worldScale = 1000\nconst newAvatarPos = () => {\n\tconst rr = () => Math.random() * 1.8 - 0.9\n\treturn new Vec(rr() * worldScale, 100, rr() * worldScale)\n}\n\nexport default class Sketch {\n\twidth: number = 0\n\theight: number = 0\n\tvisualNotes: VisualNotes = new VisualNotes()\n\tstarted: boolean = false\n\tsyncing: boolean = true\n\tinstruments: Instruments\n\tws: WSClient\n\tmidi: MIDI\n\taudioKeys: SketchAudioKeys\n\tpp?: p5\n\tpg?: p5.Graphics\n\tcam?: EasyCam\n\tuser: User = {\n\t\tclientId: 0,\n\t\tname: '',\n\t\tinstrument: 'synth',\n\t\tinputDevice: 'keyboard',\n\t\toffset: 2,\n\t}\n\tavatar: Avatar\n\tusers: User[] = []\n\tavatars: Avatar[] = []\n\tinputs: SketchInputs\n\tground = new Ground({ pos: new Vec(0, -1, 0), scale: new Vec(worldScale) })\n\tengine3d = engine3d\n\tbgCol = {\n\t\thue: 0.5,\n\t\tsat: 0,\n\t\tlgt: 0.2,\n\t}\n\n\tconstructor(_global: any) {\n\t\tconsole.log('[Sketch #ctor]')\n\t\tthis.inputs = new SketchInputs(this)\n\t\tthis.ws = new WSClient(window, {\n\t\t\tclock: {\n\t\t\t\tonSynced: () => {\n\t\t\t\t\tthis.syncing = false\n\t\t\t\t\tthis.inputs.setupInputsBPM()\n\t\t\t\t},\n\t\t\t},\n\t\t\tonClientId: (clientId: number) => {\n\t\t\t\tthis.user.clientId = clientId\n\t\t\t\tthis.inputs.setupInputsUser(clientId)\n\t\t\t\tthis.sendUserXform(this.avatar.getUserXform())\n\t\t\t},\n\t\t\tonClockUpdate: this.inputs.onClockUpdate,\n\t\t\tonUsers: this.onUsers,\n\t\t\tonUserEvent: this.onUserEvent,\n\t\t\tonUserForce: this.onUserForce,\n\t\t\tonUserXform: this.onUserXform,\n\t\t})\n\t\tthis.instruments = {\n\t\t\tsynth: new PolySynth(),\n\t\t\teightOhEight: new EightOhEight(this),\n\t\t\tpiano: new Piano(),\n\t\t\tmetronome: new Metronome(this),\n\t\t}\n\t\tthis.midi = new MIDI({\n\t\t\tonEnabled: this.inputs.setupInputsMidi,\n\t\t\tonMessage: this.sendUserEvent,\n\t\t})\n\t\tthis.audioKeys = new SketchAudioKeys(this)\n\t\tthis.avatar = new Avatar({\n\t\t\tuser: this.user,\n\t\t\tpos: newAvatarPos(),\n\t\t\tscale: new Vec(40),\n\t\t\tphys: { worldScale },\n\t\t\tonForce: this.sendUserXform,\n\t\t})\n\t\t// Tone.Destination.chain(\n\t\t// \tnew Tone.Reverb({ decay: 4, wet: 0.6 }),\n\t\t// )\n\t\twindow.Tone = Tone\n\t\twindow.me = this\n\t}\n\n\tdestroy = () => {\n\t\tthis.ws.conn.close(DONT_REOPEN, 'sketch destroyed')\n\t}\n\n\ttimeGlobalToTone = (globalTime: number) => {\n\t\tconst rawCtx = Tone.context.rawContext as any\n\t\tconst { contextTime, performanceTime } = rawCtx._nativeAudioContext.getOutputTimestamp()\n\t\tconst lt = this.ws.clock.toLocal(globalTime)\n\t\tconst delta = lt - performanceTime\n\t\tconst toneTime = contextTime + delta / 1000\n\t\treturn toneTime\n\t}\n\n\ttimeToneToGlobal = (toneTime: number) => {\n\t\tconst rawCtx = Tone.context.rawContext as any\n\t\tconst { contextTime, performanceTime } = rawCtx._nativeAudioContext.getOutputTimestamp()\n\t\tconst delta = toneTime - contextTime\n\t\tconst pt = performanceTime + delta * 1000\n\t\tconst globalTime = this.ws.clock.toGlobal(pt)\n\t\treturn globalTime\n\t}\n\n\tsetSize = (width: number, height: number) => {\n\t\tthis.width = width\n\t\tthis.height = height\n\t}\n\n\tsketch = (pp: p5) => {\n\t\tthis.pp = pp\n\t\tpp.setup = () => this.setup(pp)\n\t\tpp.draw = () => this.draw(pp)\n\t\tpp.mousePressed = () => this.mousePressed(pp)\n\t\tpp.keyPressed = () => this.keyPressed(pp)\n\t\tpp.keyReleased = () => this.keyReleased(pp)\n\t}\n\n\tsetup = (pp: p5) => {\n\t\tconsole.log(`[Sketch #setup] ${this.width} x ${this.height}`)\n\t\tpp.createCanvas(this.width, this.height)\n\t\tthis.pg = pp.createGraphics(this.width, this.height, 'webgl')\n\t\tthis.cam = new EasyCam((this.pg as any)._renderer, { distance: 600 })\n\t\tthis.cam.setDistanceMin(1)\n\t\tthis.cam.setDistanceMax(1000)\n\t\tthis.cam.attachMouseListeners((pp as any)._renderer)\n\t\tthis.cam.setViewport([0, 0, this.width, this.height])\n\t\tthis.cam.rotateY(Math.PI)\n\t\tthis.cam.rotateZ(Math.PI)\n\t\t;(this.cam.state as any).center[2] = 40\n\t\tthis.avatar.addFollowCam(this.cam)\n\t\tthis.inputs.setup(pp)\n\t}\n\n\tdraw = (pp: p5) => {\n\t\tengine3d.update()\n\t\tlet loading = false\n\t\tfor (const instName in this.instruments) {\n\t\t\tif (!this.instruments[instName].loaded()) {\n\t\t\t\tloading = true\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t\tpp.colorMode(pp.HSL, 1)\n\t\tpp.background(this.bgCol.hue, this.bgCol.sat, this.bgCol.lgt)\n\t\tpp.colorMode(pp.RGB, 255)\n\t\tif (this.pg) {\n\t\t\t// Draw notes to separate graphics canvas\n\t\t\tthis.visualNotes.draw(pp, this.pg)\n\t\t\tengine3d.draw(this.pg)\n\t\t\tpp.image(this.pg, 0, 0)\n\t\t\tengine3d.draw2D(pp, this.pg)\n\t\t}\n\t\tthis.inputs.draw(pp)\n\t\tif (loading) {\n\t\t\tthis.drawMessage(pp, 'Loading instruments...')\n\t\t} else if (this.syncing) {\n\t\t\tthis.drawMessage(pp, 'Syncing clock with server...')\n\t\t} else if (!this.started) {\n\t\t\tthis.drawMessage(pp, 'Click to enable audio')\n\t\t}\n\t}\n\n\tdrawMessage = (pp: p5, msg: string) => {\n\t\tpp.fill(200)\n\t\tpp.strokeWeight(0)\n\t\tpp.textSize(20)\n\t\tpp.textAlign(pp.CENTER, pp.CENTER)\n\t\tpp.textStyle(pp.BOLDITALIC)\n\t\tpp.text(msg, pp.width / 2, pp.height / 2)\n\t}\n\n\tmousePressed = (pp: p5) => {\n\t\tif (this.started) {\n\t\t\treturn\n\t\t}\n\t\tthis.started = true\n\t\tTone.start()\n\t\tconsole.log('[Sketch #mousePressed] Started Tone')\n\t}\n\n\tkeyboardInputDisabled = () => {\n\t\treturn this.inputs.isFocused() // Ignore keyboard if inputs are focused\n\t}\n\tkeyPressed = (evt: p5) => {\n\t\tif (!this.keyboardInputDisabled()) {\n\t\t\tthis.avatar.keyPressed(evt)\n\t\t}\n\t}\n\tkeyReleased = (evt: p5) => {\n\t\tif (!this.keyboardInputDisabled()) {\n\t\t\tthis.avatar.keyReleased(evt)\n\t\t}\n\t}\n\n\tupdateUser = (uu: Partial<User>, sendUpdate: boolean = true) => {\n\t\tthis.user = Object.assign(this.user, uu)\n\t\tif (sendUpdate) {\n\t\t\tthis.sendUserUpdate()\n\t\t}\n\t}\n\n\t// getUser returns the user matching clientId,\n\t// or this.user if no matching user is found\n\tgetUser = (clientId: number): User => {\n\t\tif (clientId === this.user.clientId) {\n\t\t\treturn this.user\n\t\t}\n\t\tfor (const uu of this.users) {\n\t\t\tif (clientId === uu.clientId) {\n\t\t\t\treturn uu\n\t\t\t}\n\t\t}\n\t\treturn this.user\n\t}\n\n\tgetAvatar = (clientId: number): Avatar | null => {\n\t\tif (clientId === this.user.clientId) {\n\t\t\treturn this.avatar\n\t\t}\n\t\tfor (const aa of this.avatars) {\n\t\t\tif (clientId === aa.user.clientId) {\n\t\t\t\treturn aa\n\t\t\t}\n\t\t}\n\t\treturn null\n\t}\n\n\tsendUserUpdate = () => {\n\t\tconst { conn, ready } = this.ws\n\t\tif (!ready()) {\n\t\t\tconsole.warn(\"[Sketch #sendUserUpdate] Can't send user update, websocket connection is not open\")\n\t\t\treturn\n\t\t}\n\t\tconn.send(userUpdateReq(this.user))\n\t}\n\n\tsendUserXform = (data: UserXform) => {\n\t\tconst { conn, ready } = this.ws\n\t\tif (!ready()) {\n\t\t\tconsole.warn(\"[Sketch #sendUserXform] Can't send user xform, websocket connection is not open\")\n\t\t\treturn\n\t\t}\n\t\tconn.send(userXformReq(data))\n\t}\n\n\tsendUserEvent = (inputName: string, _eventName: string, evt: MidiEvent) => {\n\t\tlet instName = this.user.instrument\n\t\tif (evt.controller) {\n\t\t\t// Hardcode some CC events to control instrument volumes\n\t\t\tswitch (evt.controller.number) {\n\t\t\t\tcase 79: // master volume (local only)\n\t\t\t\t\tTone.Destination.volume.value = (evt.value - 1) * 50\n\t\t\t\t// fallthrough\n\t\t\t\tcase 19: // master mute (local only)\n\t\t\t\t\tTone.Destination.mute = !evt.value\n\t\t\t\t\treturn\n\t\t\t\tcase 18:\n\t\t\t\tcase 78:\n\t\t\t\t\tinstName = 'metronome'\n\t\t\t\t\tbreak\n\t\t\t\tcase 17:\n\t\t\t\tcase 77:\n\t\t\t\t\tinstName = 'synth'\n\t\t\t\t\tbreak\n\t\t\t\tcase 16:\n\t\t\t\tcase 76:\n\t\t\t\t\tinstName = 'eightOhEight'\n\t\t\t\t\tbreak\n\t\t\t\tcase 15:\n\t\t\t\tcase 75:\n\t\t\t\t\tinstName = 'piano'\n\t\t\t\t\tbreak\n\t\t\t\tdefault:\n\t\t\t\t\t// Commented out for easier deving -- MIDI input always enabled\n\t\t\t\t\t// if (inputName !== this.user.inputDevice) {\n\t\t\t\t\t// \treturn // not a whitelisted CC and not the active device, so don't send\n\t\t\t\t\t// }\n\t\t\t\t\tbreak\n\t\t\t}\n\t\t\t// Commented out for easier deving -- MIDI input always enabled\n\t\t\t// } else {\n\t\t\t// \tif (inputName !== this.user.inputDevice) {\n\t\t\t// \t\treturn\n\t\t\t// \t}\n\t\t}\n\t\tconst uevt = {\n\t\t\tclientId: this.user.clientId,\n\t\t\tinstrument: instName,\n\t\t\tmidiEvent: evt,\n\t\t\ttimestamp: this.ws.now() + this.offsetMs(),\n\t\t}\n\t\tconst { conn, ready } = this.ws\n\t\tif (!ready()) {\n\t\t\t// websocket connection isn't ready, handle event locally\n\t\t\tthis.onUserEvent(uevt)\n\t\t\treturn\n\t\t}\n\t\tconn.send(userEventReq(uevt))\n\t}\n\n\tonUsers = (users: User[]) => {\n\t\tfor (const user of users) {\n\t\t\tif (user.clientId === this.user.clientId) {\n\t\t\t\tcontinue // skip local user\n\t\t\t}\n\t\t\tconst prevs = this.users.filter(uu => uu.clientId === user.clientId)\n\t\t\tif (!prevs.length) {\n\t\t\t\tthis.users.push(user)\n\t\t\t\tthis.avatars.push(\n\t\t\t\t\tnew Avatar({\n\t\t\t\t\t\tuser: user,\n\t\t\t\t\t\tpos: newAvatarPos(),\n\t\t\t\t\t\tscale: new Vec(20),\n\t\t\t\t\t\tphys: { worldScale },\n\t\t\t\t\t}),\n\t\t\t\t)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tif (prevs.length > 1) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`[Sketch #onUsers] Found more than one user for clientId #${user.clientId}`,\n\t\t\t\t\tuser.clientId,\n\t\t\t\t\tuser.name,\n\t\t\t\t)\n\t\t\t}\n\t\t\t// Update pre-existing user\n\t\t\tconst prev = prevs[0]\n\t\t\tObject.assign(prev, user)\n\t\t}\n\t\tfor (const user of this.users) {\n\t\t\tif (users.some(uu => uu.clientId === user.clientId)) {\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\t// user dropped, remove user and its avatar\n\t\t\tconst aa = this.getAvatar(user.clientId)\n\t\t\tif (aa) {\n\t\t\t\tengine3d.rmObj(aa)\n\t\t\t} else {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`[Sketch #onUsers] Unable to find avatar for dropped user #${user.clientId}`,\n\t\t\t\t\tuser.name,\n\t\t\t\t)\n\t\t\t}\n\t\t\tthis.users = this.users.filter(uu => uu.clientId !== user.clientId)\n\t\t\tthis.avatars = this.avatars.filter(aa => aa.user.clientId !== user.clientId)\n\t\t}\n\t}\n\n\tonUserForce = (evt: UserForce) => {\n\t\tconst { clientId } = evt\n\t\tconst avatar = this.getAvatar(clientId)\n\t\tif (!avatar) {\n\t\t\tconsole.warn('[Sketch #onUserForce] No avatar for user', clientId)\n\t\t\treturn\n\t\t}\n\t\tavatar.setUserForce(evt)\n\t}\n\n\tonUserXform = (evt: UserXform) => {\n\t\tconst { clientId } = evt\n\t\tconst avatar = this.getAvatar(clientId)\n\t\tif (!avatar) {\n\t\t\tconsole.warn('[Sketch #onUserXform] No avatar for user', clientId)\n\t\t\treturn\n\t\t}\n\t\tavatar.setUserXform(evt)\n\t}\n\n\tonUserEvent = (evt: UserEvent) => {\n\t\tconst { clientId, instrument, midiEvent, timestamp } = evt\n\t\tconst { data, channel, kind } = midiEvent\n\t\tconst inst = this.instruments[instrument]\n\t\tif (!inst) {\n\t\t\tconsole.error('[Sketch #onUserEvent] Unable to find instrument', instrument)\n\t\t\treturn\n\t\t}\n\t\tif (!inst.loaded()) {\n\t\t\treturn // don't send events if instrument hasn't finished loading\n\t\t}\n\t\tconst tt = this.timeGlobalToTone(timestamp)\n\t\tif (tt - Tone.immediate() < -1) {\n\t\t\tconsole.warn(`[Sketch #onUserEvent] Received event ${tt - Tone.immediate()} seconds late`)\n\t\t\treturn\n\t\t}\n\t\tswitch (kind) {\n\t\t\tcase 'noteon': {\n\t\t\t\tconst nn = midiEvent as MidiEventNote\n\t\t\t\tinst.noteon(tt, nn)\n\t\t\t\tconst avatar = this.getAvatar(clientId)\n\t\t\t\tif (avatar) {\n\t\t\t\t\tTone.Draw.schedule(() => this.visualNotes.noteon(evt, avatar), tt)\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase 'noteoff': {\n\t\t\t\tconst nn = midiEvent as MidiEventNote\n\t\t\t\tinst.noteoff(tt, nn)\n\t\t\t\tTone.Draw.schedule(() => this.visualNotes.noteoff(evt), tt)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase 'controlchange': {\n\t\t\t\tconst cc = midiEvent as MidiEventCC\n\t\t\t\tinst.controlchange(tt, cc)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase 'pitchbend': {\n\t\t\t\tconst pb = midiEvent as MidiEventPitchbend\n\t\t\t\tinst.pitchbend(tt, pb)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tdefault:\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`[Sketch #onUserEvent] Unhandled MIDI event on channel ${channel}:`,\n\t\t\t\t\tkind,\n\t\t\t\t\tdata,\n\t\t\t\t\tevt,\n\t\t\t\t)\n\t\t\t\tbreak\n\t\t}\n\t}\n\n\toffsetMs = () => {\n\t\tconst bps = this.inputs.bpm() / 60\n\t\tif (!bps) {\n\t\t\treturn 0\n\t\t}\n\t\tconst beatMs = 1000.0 / bps\n\t\treturn beatMs * this.user.offset\n\t}\n}\n","import React, { useEffect, useRef } from 'react'\nimport Sketch from './Sketch'\n\nconst VideoOutput: React.FC = () => {\n\tconst ref = useRef<HTMLDivElement>(null)\n\tconst sk = useRef<Sketch>(new Sketch(window))\n\tconst msg = useRef<string>(`Loading`)\n\tuseEffect(() => {\n\t\tif (!ref.current) {\n\t\t\tmsg.current = `Internal component error`\n\t\t\tconsole.warn(`[VideoOutput #useEffect] Can't find component reference`)\n\t\t\treturn\n\t\t}\n\t\tconst elem = ref.current as HTMLDivElement\n\t\tif (elem.childNodes[0]) {\n\t\t\telem.removeChild(elem.childNodes[0]) // remove previous sketch\n\t\t}\n\t\tconst { clientWidth, clientHeight } = elem\n\t\tconst skObj = sk.current\n\t\tskObj.setSize(clientWidth, clientHeight)\n\t\tconst sketch = new window.p5(skObj.sketch, elem)\n\t\treturn () => {\n\t\t\tskObj.destroy()\n\t\t\tsketch.remove()\n\t\t\tconsole.log('[VideoOutput #useEffect.return]')\n\t\t}\n\t})\n\treturn (\n\t\t<div\n\t\t\tref={ref}\n\t\t\tstyle={{\n\t\t\t\tdisplay: 'flex',\n\t\t\t\tflex: 1,\n\t\t\t\talignItems: 'center',\n\t\t\t\tjustifyContent: 'center',\n\t\t\t\tcolor: 'white',\n\t\t\t}}\n\t\t>\n\t\t\t{msg.current}\n\t\t</div>\n\t)\n}\n\nexport default VideoOutput\n","import React from 'react'\nimport VideoOutput from './VideoOutput'\n\nimport './App.css'\n\nconst App: React.FC = () => {\n\treturn (\n\t\t<div\n\t\t\tclassName='App'\n\t\t\tstyle={{\n\t\t\t\tdisplay: 'flex',\n\t\t\t\tflexDirection: 'column',\n\t\t\t\tposition: 'absolute',\n\t\t\t\tbackgroundColor: '#383838',\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0,\n\t\t\t\tright: 0,\n\t\t\t\tbottom: 0,\n\t\t\t}}\n\t\t>\n\t\t\t<VideoOutput />\n\t\t</div>\n\t)\n}\n\nexport default App\n"],"sourceRoot":""}