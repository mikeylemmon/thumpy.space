{"version":3,"sources":["app/serverApi/serverApi.ts","app/serverApi/serverClock.ts","app/serverApi/WSClock.ts","index.tsx","app/serverApi/WSClient.ts","app/MIDI.ts","app/Instrument.ts","app/instruments/util.ts","app/instruments/Sampler.ts","app/instruments/EightOhEight.ts","app/instruments/Metronome.ts","app/instruments/Piano.ts","engine3d/core/Vec.ts","engine3d/core/Bounds.ts","engine3d/core/Xform.ts","engine3d/core/Component.ts","engine3d/core/engine3d.ts","engine3d/core/Obj.ts","engine3d/components/Physical.ts","engine3d/components/FollowCam.ts","engine3d/objs/Avatar.ts","engine3d/objs/Ground.ts","app/instruments/PolySynth.ts","app/VisualNotes.ts","vendor/p5.easycam.js","app/SketchInputs.ts","app/SketchAudioKeys.ts","app/Sketch.ts","app/VideoOutput.tsx","app/App.tsx"],"names":["WS_URL","WS_HEADER_END","WS_CLIENT_ID","parseClientId","body","JSON","parse","clientId","WS_USERS_ALL","WS_USER_EVENT","WS_USER_FORCE","WS_USER_XFORM","parseUsersAll","parseUserEvent","parseUserForce","parseUserXform","userUpdateReq","req","stringify","userEventReq","userXformReq","WS_CLOCK_NOW","WS_CLOCK_ORIGIN","WS_CLOCK_UPDATE","clockNowReq","clockUpdateReq","clk","parseClockUpdate","WSClock","global","conn","options","localOrigin","correction","precision","correction2","precision2","lowpass","lastReqAt","lastRespAt","loopId","syncInitial","serverOrigin","precisionNow","syncPeriod","synced","update","readyState","WebSocket","OPEN","nowRaw","send","clearTimeout","this","performance","timeOrigin","setInterval","now","originMs","console","error","nowMs","dur","delta","deltaNow","onSynced","nn","c2gain","perfTime","globalTime","App","require","default","ReactDOM","render","document","getElementById","WSClient","clock","users","reopen","CLOSED","newConn","ready","onclose","evt","code","warn","setTimeout","onopen","log","onerror","onmessage","onMessage","parts","str","sep","out","sepRe","RegExp","prevIndex","lastIndex","re","exec","push","slice","index","split","data","head","onClockOrigin","onClockNow","clkOpts","onClockUpdate","onClientId","filter","uu","onUsers","uevt","onUserEvent","onUserForce","onUserXform","getUser","newMidiEvent","channel","target","number","kind","type","attack","note","_number","release","value","controller","allChannels","Array","keys","map","x","allEvents","MIDI","opts","webMidi","enabled","enable","a","onEnabled","window","WebMidi","inputs","outputs","input","eventName","addListener","name","channels","Instrument","_avatar","_time","_evt","noteFreq","Tone","toFrequency","Sampler","sampler","pitchShift","panVol","ps","psSpread","noteon","time","triggerAttack","noteoff","triggerRelease","controlchange","num","delayed","pitch","mute","volume","pan","schedule","pitchbend","toDestination","connect","loaded","samps","EightOhEight","sketch","urls","ii","length","baseUrl","eightOhEight","modNote","Metronome","metronome","ground","hue","Math","random","sat","bgCol","set","pianoSamps","A0","C1","A1","C2","A2","C3","A3","C4","A4","C5","A5","C6","A6","C7","A7","C8","Piano","Vec","w","clone","y","z","cloneMult","val","applyMult","cloneAdd","applyAdd","cloneSub","applySub","isZero","isOne","isEqual","other","normalize","mag","toArray","setFromArray","vals","cloneMultMat","mat","dest","abs","Number","EPSILON","p5","Vector","Bounds","min","max","cloneXform","xform","applyXform","applyTo","sanitize","tmp","pushInside","off","centerAndSize","center","size","Xform","pos","rot","scale","vec","Component","parent","drawDebug","_dt","engine3d","objs","debug","lastUpdate","addObj","obj","rmObj","oo","destroy","Date","valueOf","dt","forEach","draw","pg","draw2D","pp","gg","mvp","_renderer","uMVMatrix","copy","mult","uPMatrix","mat4","Obj","comps","drawFunc","drawFunc2D","cc","rm","addComp","comp","rmComponent","getComps","compType","getComp","cs","applyXformToGraphics","translate","rotateZ","rotateY","rotateX","pop","ndcPos","ndcPos2","ndcPos3","ndcPos4","ndc","width","height","scale2d","gravity","Physical","force","vel","bounds","world","magSq","worldBounds","noFill","stroke","strokeWeight","box","worldScale","FollowCam","cam","last","state","setCenter","Avatar","phys","user","followCam","onForce","up","down","left","right","jump","jumpInitial","gain","fill","sphere","render2D","instrument","offset","ss","textAlign","CENTER","BOTTOM","noStroke","textSize","textStyle","BOLD","text","ITALIC","addFollowCam","getUserXform","setUserXform","setUserForce","keyPressed","keyChanged","keyReleased","pressed","key","keysUpdated","mov","ca","centerAxes","cax","caz","ff","PI","circle","Ground","subDF","colorMode","HSL","angleMode","RADIANS","rect","RGB","srand","SynthObj","polySynth","createdAt","noteEvt","scaleOrig","voice","releasedAt","lgt","envValLast","mod","modwheel","PolySynth","synth","filterVol","reverb","decay","sustain","maxObjs","setFilterGain","db","avatar","addSynthObj","vv","frequency","Q","updatePitchbend","envelope","detune","objSize","unshift","wet","oscillator","count","spread","VisualNote","age","released","firstUpdate","ageReleased","velx","vely","young","health","youngDur","fadeOut","radius","radiusOrig","isDead","others","ux","uy","dx","dy","ddx","ddy","sx","sy","dd","sqrt","close","outerDist","midiEvent","square","aa","VisualNotes","notes","isSameNote","perspective","clear","ext","INFO","LIBRARY","VERSION","AUTHOR","SOURCE","toString","EasyCam","renderer","args","RendererGL","undefined","distance","rotation","Rotation","identity","viewport","setCanvas","LOOK","UP","AXIS","YAW","PITCH","ROLL","ALL","SHIFT_CONSTRAINT","FIXED_CONSTRAINT","DRAG_CONSTRAINT","scale_rotation","scale_pan","scale_zoom","scale_zoomwheel","distance_min_limit","distance_min","distance_max","MAX_VALUE","dst","state_reset","state_pushed","mouse","curr","prev","dist","mwheel","isPressed","istouchdown","ismousedown","BUTTON","LMB","MMB","RMB","button","mouseDragLeft","mouseDragRotate","bind","mouseDragCenter","mouseDragPan","mouseDragRight","mouseDragZoom","mouseWheelAction","mouseWheelZoom","touchmoveSingle","touchmoveMulti","insideViewport","x0","x1","y0","y1","solveConstraint","shiftKey","updateInput","pd","P5","pixelDensity","mousedown","event","mousedrag","mouseX","mouseY","mouseup","dblclick","reset","wheel","deltaY","evaluateTouches","i","touches","avg_x","avg_y","avg_d","clientX","clientY","touchstart","preventDefault","stopPropagation","dbltap","touchmove","tapcount","touchend","keydown","keyCode","keyup","attachMouseListeners","auto_update","registerMethod","dampedZoom","DampedAction","d","zoom","getZoomMult","dampedPanX","panX","getPanMult","dampedPanY","panY","dampedPanZ","panZ","dampedRotX","getRotationMult","dampedRotY","dampedRotZ","timedRot","Interpolation","setInterpolatedRotation","timedPan","setInterpolatedCenter","timedzoom","setInterpolatedDistance","_pInst","graphics","el","ev","fx","op","detachListener","addEventListener","removeEventListener","passive","elt","attachListener","status","b_update","stop","apply","camEYE","getPosition","camLAT","getCenter","camRUP","getUpVector","_curCamera","camera","addForce","mx","my","mxNdc","myNdc","pow","log10","dz","distance_tmp","applyToVec3","Vec3","add","screenX","mX","screenZ","cross","rx","rotate","ry","rz","axis","angle","new_rotation","create","applyToRotation","valA","valB","t","Scalar","mix","smoothstep","slerp","duration","start","assert","setDistance","setRotation","getState","setState","wheelScale","damping","default_duration","yaw","roll","h","pushed_rendererState","gl","drawingContext","ww","hh","flush","disable","DEPTH_TEST","pushed_uMVMatrix","pushed_uPMatrix","resetMatrix","ortho","cb","action","active","actions","timer","getTime","interpolate","constructor","q0","q1","q2","q3","s","rotA","rotB","a0","a1","a2","a3","b0","b1","b2","b3","cosTheta","w1","w2","theta","acos","sinTheta","sin","def","norm","halfAngle","coeff","cos","inv","angles_xyz","ax","ay","az","rotX","rotY","rotZ","b","smootherstep","isScalar","arg","dot","v1","v2","normProduct","threshold","v3","asin","Object","freeze","SketchInputs","nameCustomized","hidden","clockOpts","bpm","isFocused","focused","toggleHide","setup","setupInputsBPM","remove","setupInputsHide","setupInputsUser","ws","setupInputsInstrument","inputDevice","setupInputsMidi","midi","hide","inHide","createButton","position","mousePressed","defaultName","updateUser","inName","createInput","onfocus","onblur","focus","select","inOffset","setOffset","parseFloat","isNaN","inInst","createSelect","uinst","instName","instruments","option","selected","changed","inMidi","_midiInput","inBPM","createSlider","sendClockUpdate","LEFT","xx","yy","msg","toUpperCase","SketchAudioKeys","audioKeys","velocity","keyboardInputDisabled","midiEvt","sendUserEvent","AudioKeys","polyphony","Infinity","newAvatarPos","rr","Sketch","_global","visualNotes","started","syncing","avatars","timeGlobalToTone","rawContext","_nativeAudioContext","getOutputTimestamp","contextTime","performanceTime","toLocal","timeToneToGlobal","toneTime","pt","toGlobal","setSize","createCanvas","createGraphics","setDistanceMin","setDistanceMax","setViewport","loading","background","image","drawMessage","BOLDITALIC","sendUpdate","assign","sendUserUpdate","getAvatar","getAvatarSafe","sendUserXform","inputName","_eventName","timestamp","offsetMs","prevs","some","inst","tt","pb","bps","piano","me","VideoOutput","ref","useRef","sk","useEffect","current","elem","childNodes","removeChild","clientWidth","clientHeight","skObj","style","display","flex","alignItems","justifyContent","color","className","flexDirection","backgroundColor","top","bottom"],"mappings":"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","file":"static/js/main.cad60843.chunk.js","sourcesContent":["import { MidiEvent } from '../MIDI'\n\nexport const WS_URL = 'ws://localhost:38883'\n// export const WS_URL = 'wss://mikeylemmon.com/api'\nexport const WS_HEADER_END = '#'\n\n//\n// Client API\n//\nexport const WS_CLIENT_ID = 'client/id'\nexport type ClientIdResp = { clientId: number }\n\nexport function parseClientId(body: string): number {\n\tconst resp: ClientIdResp = JSON.parse(body)\n\treturn resp.clientId\n}\n\n//\n// Users API\n//\nexport const WS_USERS_ALL = 'user/all'\nexport const WS_USER_UPDATE = 'user/update'\nexport const WS_USER_EVENT = 'user/event'\nexport const WS_USER_FORCE = 'user/force'\nexport const WS_USER_XFORM = 'user/xform'\n\nexport type User = {\n\tclientId: number\n\tname: string\n\tinstrument: string\n\tinputDevice: string\n\toffset: number\n}\n\nexport type UserEvent = {\n\tclientId: number\n\tinstrument: string\n\tmidiEvent: MidiEvent\n\ttimestamp: number\n}\n\nexport type UserForce = {\n\tclientId: number\n\tforce: number[]\n}\n\nexport type UserXform = {\n\tclientId: number\n\tpos: number[]\n\trot: number[]\n\tscale: number[]\n\tforce: number[]\n\tvel: number[]\n}\n\nexport function parseUsersAll(body: string): User[] {\n\tconst resp: User[] = JSON.parse(body)\n\treturn resp\n}\nexport function parseUserEvent(body: string): UserEvent {\n\tconst resp: UserEvent = JSON.parse(body)\n\treturn resp\n}\nexport function parseUserForce(body: string): UserForce {\n\tconst resp: UserForce = JSON.parse(body)\n\treturn resp\n}\nexport function parseUserXform(body: string): UserXform {\n\tconst resp: UserXform = JSON.parse(body)\n\treturn resp\n}\n\nexport function userUpdateReq(req: User): string {\n\treturn WS_USER_UPDATE + WS_HEADER_END + JSON.stringify(req)\n}\nexport function userEventReq(req: UserEvent): string {\n\treturn WS_USER_EVENT + WS_HEADER_END + JSON.stringify(req)\n}\nexport function userForceReq(req: UserForce): string {\n\treturn WS_USER_FORCE + WS_HEADER_END + JSON.stringify(req)\n}\nexport function userXformReq(req: UserXform): string {\n\treturn WS_USER_XFORM + WS_HEADER_END + JSON.stringify(req)\n}\n","import { WS_HEADER_END } from './serverApi'\n\nexport const WS_CLOCK_NOW = 'clock/now'\nexport const WS_CLOCK_ORIGIN = 'clock/origin'\nexport const WS_CLOCK_UPDATE = 'clock/update'\n\nexport type ClockNowResp = { nowMs: number }\nexport type ClockOriginResp = { originMs: number }\nexport type ClockOpts = { bpm: number }\n\nexport const clockNowReq = () => WS_CLOCK_NOW + WS_HEADER_END\nexport const clockUpdateReq = (clk: ClockOpts) => WS_CLOCK_UPDATE + WS_HEADER_END + JSON.stringify(clk)\n\nexport function parseClockUpdate(body: string): ClockOpts {\n\tconst resp: ClockOpts = JSON.parse(body)\n\treturn resp\n}\n","import { clockNowReq, ClockNowResp, ClockOriginResp } from './serverClock'\n\nconst SYNC_PERIOD_INITIAL_MS = 500,\n\tSYNC_INITIAL_NUM = 6, // number of times to use initial period\n\tSYNC_PERIOD_MS = 2000\n\nexport type WSClockOptions = {\n\tonSynced: () => void\n}\n\nexport default class WSClock {\n\tglobal: any\n\tconn: WebSocket\n\tlocalOrigin: number\n\tcorrection = 0 // a correction to apply to the local clock based on rolling-average deviation from server clock\n\tprecision = 0 // average of how accurate the workerClock is with correction applied\n\tcorrection2 = 0 // a derivative correction that accounts for linear clock deviation (i.e. local clock is X slower/faster than server)\n\tprecision2 = 0 // measures how accurate the workerClock is with correction and correction2 applied\n\tlowpass = 0.3 // how much latest sample affects correction/precision\n\tlastReqAt = 0\n\tlastRespAt = 0\n\tloopId = -1\n\tsyncInitial = 0\n\tserverOrigin = 0\n\tprecisionNow = 0\n\tsyncPeriod = SYNC_PERIOD_INITIAL_MS\n\tsynced = false\n\toptions: Partial<WSClockOptions>\n\n\tconstructor(global: any, conn: WebSocket, options: Partial<WSClockOptions> = {}) {\n\t\tthis.global = global\n\t\tthis.options = options\n\t\t// this.localOrigin = global.performance.timing.navigationStart\n\t\tthis.localOrigin = global.performance.timeOrigin\n\t\tthis.conn = conn\n\t\tthis.loopId = global.setInterval(this.update, this.syncPeriod)\n\t}\n\n\tnowRaw() {\n\t\treturn global.performance.now()\n\t}\n\n\tupdate = () => {\n\t\tif (this.conn.readyState !== WebSocket.OPEN) {\n\t\t\tthis.global.clearTimeout(this.loopId)\n\t\t\treturn\n\t\t}\n\t\tthis.lastReqAt = this.nowRaw()\n\t\tthis.conn.send(clockNowReq())\n\t}\n\n\tonClockOrigin(body: string) {\n\t\tconst resp: ClockOriginResp = JSON.parse(body)\n\t\tconst { originMs } = resp\n\t\tif (!originMs) {\n\t\t\tconsole.error('[workerClock #onClockOrigin] Received empty response')\n\t\t\treturn\n\t\t}\n\t\tthis.serverOrigin = originMs\n\t}\n\n\tonClockNow(body: string) {\n\t\tconst resp: ClockNowResp = JSON.parse(body)\n\t\tconst { nowMs } = resp || {}\n\t\tif (!nowMs) {\n\t\t\tconsole.error('[workerClock #onClockNow] Received empty response')\n\t\t\treturn\n\t\t}\n\t\tthis.lastRespAt = this.nowRaw()\n\t\tconst dur = this.lastRespAt - this.lastReqAt\n\t\tconst mid = dur / 2 + this.lastReqAt\n\t\tconst delta = nowMs - mid\n\t\tif (this.correction === 0) {\n\t\t\tthis.correction = delta\n\t\t} else {\n\t\t\tthis.correction = delta * this.lowpass + this.correction * (1 - this.lowpass)\n\t\t}\n\t\tconst precision = delta - this.correction\n\t\tif (this.precision === 0) {\n\t\t\tthis.precision = precision\n\t\t} else {\n\t\t\tthis.precision = precision * this.lowpass + this.precision * (1 - this.lowpass)\n\t\t}\n\t\t// Calculate a secondary correction based on the average value of precision to account\n\t\t// for the local clock being consistently slower/faster than the server clock\n\t\tthis.correction2 = this.precision * this.lowpass + this.correction2 * (1 - this.lowpass)\n\t\tconst precision2 = delta - this.correction - this.correction2\n\t\tif (this.precision2 === 0) {\n\t\t\tthis.precision2 = precision2\n\t\t} else {\n\t\t\tthis.precision2 = precision2 * this.lowpass + this.precision2 * (1 - this.lowpass)\n\t\t}\n\n\t\t// Calculate precision metrics for corrected \"now\" time\n\t\tconst now = this.now() - dur / 2\n\t\tconst deltaNow = now - nowMs\n\t\tthis.precisionNow = deltaNow * this.lowpass + this.precisionNow * (1 - this.lowpass)\n\n\t\t// console.log(\n\t\t// \t'[workerClock #onClockNow]',\n\t\t// \t{\n\t\t// \t\tp: this.precision,\n\t\t// \t\tp2: this.precision2,\n\t\t// \t\tc: this.correction,\n\t\t// \t\tc2: this.correction2,\n\t\t// \t},\n\t\t// \t{\n\t\t// \t\tlastP: precision,\n\t\t// \t\tlastP2: precision2,\n\t\t// \t\tdur,\n\t\t// \t},\n\t\t// \t{\n\t\t// \t\tnow: now,\n\t\t// \t\tnowMs: nowMs,\n\t\t// \t\td: deltaNow,\n\t\t// \t\tpnow: this.precisionNow,\n\t\t// \t},\n\t\t// \t{\n\t\t// \t\tnowOverP: this.precisionNow / this.precision2,\n\t\t// \t},\n\t\t// )\n\n\t\tif (!this.synced && this.syncInitial++ > SYNC_INITIAL_NUM) {\n\t\t\t// Replace sync loop with lower-frequency interval\n\t\t\tthis.synced = true\n\t\t\tthis.global.clearTimeout(this.loopId)\n\t\t\t// this.correction2 *= SYNC_PERIOD_MS / SYNC_PERIOD_INITIAL_MS\n\t\t\tthis.correction += this.correction2\n\t\t\tthis.syncPeriod = SYNC_PERIOD_MS\n\t\t\tthis.loopId = this.global.setInterval(this.update, this.syncPeriod)\n\t\t\tif (this.options.onSynced) {\n\t\t\t\tthis.options.onSynced()\n\t\t\t}\n\t\t}\n\t}\n\n\tnow() {\n\t\tconst nn = this.nowRaw()\n\t\tconst c2gain = 1 + (nn - this.lastRespAt) / this.syncPeriod\n\t\treturn nn + this.correction + this.correction2 * c2gain\n\t}\n\n\ttoGlobal(perfTime: number) {\n\t\treturn perfTime + this.correction + this.correction2\n\t}\n\n\ttoLocal(globalTime: number) {\n\t\treturn globalTime - this.correction - this.correction2\n\t}\n}\n","import React from 'react'\nimport ReactDOM from 'react-dom'\nimport 'index.css'\n\nconst render = () => {\n\tconst App = require('app/App').default\n\n\tReactDOM.render(<App />, document.getElementById('root'))\n}\n\nrender()\n\nif (process.env.NODE_ENV === 'development' && module.hot) {\n\tmodule.hot.accept('./app/App', render)\n}\n","import {\n\tparseClientId,\n\tparseUsersAll,\n\tparseUserEvent,\n\tparseUserForce,\n\tparseUserXform,\n\tUser,\n\tUserEvent,\n\tUserForce,\n\tUserXform,\n\tWS_CLIENT_ID,\n\tWS_HEADER_END,\n\tWS_URL,\n\tWS_USERS_ALL,\n\tWS_USER_EVENT,\n\tWS_USER_FORCE,\n\tWS_USER_XFORM,\n} from './serverApi'\nimport { parseClockUpdate, ClockOpts, WS_CLOCK_NOW, WS_CLOCK_ORIGIN, WS_CLOCK_UPDATE } from './serverClock'\nimport WSClock, { WSClockOptions } from './WSClock'\n\nexport const DONT_REOPEN = 888\n\nexport type WSClientOptions = {\n\tclock: Partial<WSClockOptions>\n\tonClientId: (clientId: number) => any\n\tonClockUpdate: (clkOpts: ClockOpts) => void\n\tonUsers: (users: User[]) => void\n\tonUserEvent: (evt: UserEvent) => void\n\tonUserForce: (evt: UserForce) => void\n\tonUserXform: (evt: UserXform) => void\n}\n\nexport default class WSClient {\n\tconn: WebSocket\n\tclock: WSClock\n\tglobal: any\n\toptions: WSClientOptions\n\tclientId: number = 0\n\tusers: User[] = []\n\n\tconstructor(global: any, options: WSClientOptions) {\n\t\tthis.global = global\n\t\tthis.options = options as WSClientOptions\n\t\tthis.conn = this.newConn()\n\t\tthis.clock = new WSClock(this.global, this.conn, this.options.clock)\n\t}\n\n\treopen = () => {\n\t\t// Try to re-open the websocket connection if it has closed\n\t\tif (this.conn.readyState !== WebSocket.CLOSED) {\n\t\t\treturn\n\t\t}\n\t\tthis.conn = this.newConn()\n\t}\n\n\tready = () => this.conn && this.conn.readyState === WebSocket.OPEN\n\n\tnewConn = (): WebSocket => {\n\t\tconst conn = new WebSocket(WS_URL)\n\t\tconn.onclose = (evt: CloseEvent) => {\n\t\t\tif (evt.code === DONT_REOPEN) {\n\t\t\t\tconsole.warn('Closing for good', evt)\n\t\t\t\treturn\n\t\t\t}\n\t\t\tconsole.warn('WebSocket closed, will attempt to reopen in a few seconds', evt)\n\t\t\tsetTimeout(this.reopen, 5000)\n\t\t}\n\t\tconn.onopen = (evt: Event) => {\n\t\t\tconsole.log('WebSocket opened', evt)\n\t\t\tthis.clock = new WSClock(this.global, this.conn, this.options.clock)\n\t\t}\n\t\tconn.onerror = (evt: Event) => {\n\t\t\tconsole.error('WebSocket error', evt)\n\t\t}\n\t\tconn.onmessage = this.onMessage\n\t\treturn conn\n\t}\n\n\tonMessage = (evt: MessageEvent) => {\n\t\tconst parts = split(evt.data, WS_HEADER_END, 1)\n\t\tconst [head, body] = parts\n\t\tswitch (head) {\n\t\t\tcase WS_CLOCK_NOW:\n\t\t\tcase WS_CLOCK_ORIGIN:\n\t\t\t\tif (!this.clock) {\n\t\t\t\t\tconsole.error('[WSClient #onMessage] No local clock ready to handle server clock message')\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tif (head === WS_CLOCK_ORIGIN) {\n\t\t\t\t\tthis.clock.onClockOrigin(body)\n\t\t\t\t} else {\n\t\t\t\t\tthis.clock.onClockNow(body)\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase WS_CLOCK_UPDATE:\n\t\t\t\tconst clkOpts = parseClockUpdate(body)\n\t\t\t\tthis.options.onClockUpdate(clkOpts)\n\t\t\t\tconsole.log('[WSClient #onMessage] Received clockUpdate', clkOpts)\n\t\t\t\tbreak\n\t\t\tcase WS_CLIENT_ID:\n\t\t\t\tthis.clientId = parseClientId(body)\n\t\t\t\tconsole.log('[WSClient #onMessage] Received clientId', this.clientId)\n\t\t\t\tthis.options.onClientId(this.clientId)\n\t\t\t\tbreak\n\t\t\tcase WS_USERS_ALL:\n\t\t\t\tthis.users = parseUsersAll(body).filter(uu => !!uu)\n\t\t\t\tconsole.log('[WSClient #onMessage] Received users', this.users)\n\t\t\t\tthis.options.onUsers(this.users)\n\t\t\t\tbreak\n\t\t\tcase WS_USER_EVENT: {\n\t\t\t\tconst uevt = parseUserEvent(body)\n\t\t\t\t// console.log('[WSClient #onMessage] Received user event', uevt)\n\t\t\t\tthis.options.onUserEvent(uevt)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase WS_USER_FORCE: {\n\t\t\t\tconst uevt = parseUserForce(body)\n\t\t\t\t// console.log('[WSClient #onMessage] Received user event', uevt)\n\t\t\t\tthis.options.onUserForce(uevt)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase WS_USER_XFORM: {\n\t\t\t\tconst uevt = parseUserXform(body)\n\t\t\t\t// console.log('[WSClient #onMessage] Received user event', uevt)\n\t\t\t\tthis.options.onUserXform(uevt)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tdefault:\n\t\t\t\tconsole.log('[WSClient #onMessage] Unhandled message', { head, body, parts }, evt)\n\t\t\t\tbreak\n\t\t}\n\t}\n\n\tnow = (): number => {\n\t\tif (!this.clock) {\n\t\t\tconsole.error('[WSClient #now] No clock!')\n\t\t\treturn -1\n\t\t}\n\t\treturn this.clock.now()\n\t}\n\n\tgetUser = (clientId: number) => {\n\t\tfor (const uu of this.users) {\n\t\t\tif (uu.clientId === clientId) {\n\t\t\t\treturn uu\n\t\t\t}\n\t\t}\n\t}\n}\n\n// split function with remainder\n// via https://stackoverflow.com/questions/874709/converting-user-input-string-to-regular-expression\nfunction split(str: string, sep: string, nn: number) {\n\tconst out: string[] = []\n\tconst sepRe = new RegExp(sep, 'g')\n\twhile (nn--) {\n\t\tconst prevIndex = sepRe.lastIndex\n\t\tconst re = sepRe.exec(str)\n\t\tif (!re) {\n\t\t\tbreak\n\t\t}\n\t\tout.push(str.slice(prevIndex, re.index))\n\t}\n\tout.push(str.slice(sepRe.lastIndex))\n\treturn out\n}\n","type FieldsShared = {\n\tdata: number[]\n\tchannel: number\n\tkind: string\n}\n\ntype FieldsNote = {\n\tattack?: number\n\tnote: number\n\trelease?: number\n}\n\ntype FieldsCC = {\n\tvalue: number // 0 - 1 (data[2])\n\tcontroller: {\n\t\tnumber: number // (data[1])\n\t\tname: string\n\t}\n}\n\ntype FieldsPitchbend = {\n\tvalue: number // 0 - 1 (data[2])\n}\n\nexport type MidiEventNote = FieldsShared & FieldsNote\nexport type MidiEventCC = FieldsShared & FieldsCC\nexport type MidiEventPitchbend = FieldsShared & FieldsPitchbend\nexport type MidiEvent = FieldsShared & FieldsCC & FieldsNote & FieldsPitchbend\nexport function newMidiEvent(evt: any): MidiEvent {\n\treturn {\n\t\tdata: evt.data,\n\t\tchannel: evt.target.number,\n\t\tkind: evt.type,\n\t\tattack: evt.attack,\n\t\tnote: evt.note && evt.note._number,\n\t\trelease: evt.release,\n\t\tvalue: evt.value,\n\t\tcontroller: evt.controller,\n\t}\n}\n\nconst allChannels = [...Array(16).keys()].map(x => x + 1) // Array of numbers 1 thru 16\nconst allEvents = ['controlchange', 'noteoff', 'noteon', 'pitchbend'] // 'keyaftertouch',\n\ntype MIDIOptions = {\n\tonMessage: (inputName: string, eventName: string, evt: MidiEvent) => void\n\tonEnabled?: (webMidi: any) => void\n}\n\nexport default class MIDI {\n\twebMidi: any | null = null\n\tenabled: boolean = false\n\n\tconstructor(opts: MIDIOptions) {\n\t\tthis.enable(opts)\n\t}\n\n\tenable = async (opts: MIDIOptions) => {\n\t\tconst { onMessage, onEnabled } = opts\n\t\tconst { WebMidi } = window\n\t\ttry {\n\t\t\tawait WebMidi.enable()\n\t\t} catch (err) {\n\t\t\tconsole.error('[MIDI #enable] Failed to enable MIDI', err)\n\t\t\treturn\n\t\t}\n\t\tthis.webMidi = WebMidi\n\t\tthis.enabled = true\n\t\tconst { inputs, outputs } = this.webMidi\n\t\tconsole.log('[MIDI #enable] inputs', inputs)\n\t\tconsole.log('[MIDI #enable] outputs', outputs)\n\t\tif (onEnabled) {\n\t\t\tonEnabled(this.webMidi)\n\t\t}\n\t\tfor (const input of inputs) {\n\t\t\tfor (const eventName of allEvents) {\n\t\t\t\tinput.addListener(\n\t\t\t\t\teventName,\n\t\t\t\t\t(evt: any) => onMessage(input.name, eventName, newMidiEvent(evt)),\n\t\t\t\t\t{\n\t\t\t\t\t\tchannels: allChannels,\n\t\t\t\t\t},\n\t\t\t\t)\n\t\t\t}\n\t\t}\n\t}\n}\n","import { Avatar } from 'engine3d'\nimport { MidiEventCC, MidiEventNote, MidiEventPitchbend } from './MIDI'\n\nexport class Instrument {\n\tloaded() {\n\t\treturn false\n\t}\n\tnoteon(_avatar: Avatar, _time: number, _evt: MidiEventNote) {}\n\tnoteoff(_avatar: Avatar, _time: number, _evt: MidiEventNote) {}\n\tcontrolchange(_avatar: Avatar, _time: number, _evt: MidiEventCC) {}\n\tpitchbend(_avatar: Avatar, _time: number, _evt: MidiEventPitchbend) {}\n}\n","import * as Tone from 'tone'\n\nexport function noteFreq(note: number) {\n\treturn Tone.Frequency(note, 'midi').toFrequency()\n}\n","import * as Tone from 'tone'\nimport { Avatar } from 'engine3d'\nimport { MidiEventCC, MidiEventNote, MidiEventPitchbend } from '../MIDI'\nimport { Instrument } from '../Instrument'\nimport { noteFreq } from './util'\n\nexport class Sampler extends Instrument {\n\tsampler: Tone.Sampler\n\tpitchShift: Tone.PitchShift\n\tpanVol: Tone.PanVol\n\tps = 0\n\tpsSpread = 7\n\n\tconstructor(sampler: Tone.Sampler) {\n\t\tsuper()\n\t\tthis.panVol = new Tone.PanVol(0, 0).toDestination()\n\t\tthis.pitchShift = new Tone.PitchShift().connect(this.panVol)\n\t\tthis.sampler = sampler.connect(this.pitchShift)\n\t}\n\n\tloaded() {\n\t\treturn this.sampler.loaded\n\t}\n\n\tnoteon = (_avatar: Avatar, time: number, evt: MidiEventNote) => {\n\t\tthis.sampler.triggerAttack(noteFreq(evt.note), time, evt.attack)\n\t}\n\n\tnoteoff = (_avatar: Avatar, time: number, evt: MidiEventNote) => {\n\t\tthis.sampler.triggerRelease(noteFreq(evt.note), time)\n\t}\n\n\tcontrolchange = (_avatar: Avatar, time: number, evt: MidiEventCC) => {\n\t\tconst num = evt.controller.number\n\t\tlet delayed: (() => void) | null = null\n\t\tswitch (true) {\n\t\t\tcase num === 1:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.psSpread = evt.value * 12\n\t\t\t\t\tthis.pitchShift.pitch = this.ps * this.psSpread\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase 75 <= num && num <= 79:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.panVol.mute = !evt.value\n\t\t\t\t\tthis.panVol.volume.value = (evt.value - 1) * 50\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase 15 <= num && num <= 19:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.panVol.mute = !evt.value\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase num === 28:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.panVol.pan.value = evt.value * 2 - 1\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tdefault:\n\t\t\t\tconsole.log(\n\t\t\t\t\t`[Sampler #controlchange] Unsupported CC event on channel ${evt.channel}:`,\n\t\t\t\t\tevt.controller,\n\t\t\t\t\tevt.value,\n\t\t\t\t)\n\t\t}\n\t\tif (delayed) {\n\t\t\tTone.Draw.schedule(delayed, time)\n\t\t}\n\t}\n\n\tpitchbend = (_avatar: Avatar, time: number, evt: MidiEventPitchbend) => {\n\t\tTone.Draw.schedule(() => {\n\t\t\tthis.ps = evt.value\n\t\t\tthis.pitchShift.pitch = this.ps * this.psSpread\n\t\t}, time)\n\t}\n}\n","import * as Tone from 'tone'\nimport { Avatar } from 'engine3d'\nimport { Sampler } from './Sampler'\nimport { MidiEventNote } from '../MIDI'\nimport { noteFreq } from './util'\nimport Sketch from '../Sketch'\n\nconst samps = [\n\t'BD0010.WAV',\n\t'BD0050.WAV',\n\t// 'BD0025.WAV',\n\t// 'BD0075.WAV',\n\t'SD7510.WAV',\n\t'CP.WAV',\n\t// 'SD7550.WAV',\n\t// 'SD7500.WAV',\n\t// 'SD7525.WAV',\n\t'CH.WAV',\n\t'OH10.WAV',\n\t'LT00.WAV',\n\t'MT00.WAV',\n\t'HT00.WAV',\n\t'LC00.WAV',\n\t'MC00.WAV',\n\t'HC00.WAV',\n\t'CB.WAV',\n\t'CY0075.WAV',\n\t// 'CY1000.WAV',\n\t'MA.WAV',\n\t'RS.WAV',\n\t// 'CL.WAV',\n]\n\nfunction eightOhEight() {\n\tconst urls: { [key: number]: string } = {}\n\tfor (let ii = 0; ii < samps.length; ++ii) {\n\t\turls[ii] = samps[ii % samps.length]\n\t}\n\treturn new Tone.Sampler({\n\t\turls,\n\t\trelease: 1,\n\t\tbaseUrl: '/samples/808/',\n\t})\n}\n\nexport class EightOhEight extends Sampler {\n\tsketch: Sketch\n\n\tconstructor(sketch: Sketch) {\n\t\tsuper(eightOhEight())\n\t\tthis.sketch = sketch\n\t}\n\n\tmodNote(note: number) {\n\t\treturn (note + 12) % samps.length\n\t}\n\n\tnoteon = (_avatar: Avatar, time: number, note: MidiEventNote) => {\n\t\tlet nn = this.modNote(note.note)\n\t\tthis.sampler.triggerAttack(noteFreq(nn), time, note.attack)\n\t}\n\n\tnoteoff = (_avatar: Avatar, time: number, note: MidiEventNote) => {\n\t\tlet nn = this.modNote(note.note)\n\t\tthis.sampler.triggerRelease(noteFreq(nn), time)\n\t}\n}\n","import * as Tone from 'tone'\nimport { Avatar } from 'engine3d'\nimport { Sampler } from './Sampler'\nimport { MidiEventNote } from '../MIDI'\nimport { noteFreq } from './util'\nimport Sketch from '../Sketch'\n\nconst samps = ['MA.WAV', 'RS.WAV']\n\nfunction metronome() {\n\tconst urls: { [key: number]: string } = {}\n\tfor (let ii = 0; ii < samps.length; ++ii) {\n\t\turls[ii] = samps[ii % samps.length]\n\t}\n\treturn new Tone.Sampler({\n\t\turls,\n\t\trelease: 1,\n\t\tbaseUrl: '/samples/808/',\n\t})\n}\n\nexport class Metronome extends Sampler {\n\tsketch: Sketch\n\n\tconstructor(sketch: Sketch) {\n\t\tsuper(metronome())\n\t\tthis.sketch = sketch\n\t\tthis.panVol.set({ volume: -10 })\n\t\tthis.panVol.mute = true\n\t}\n\n\tmodNote(note: number) {\n\t\treturn note % samps.length\n\t}\n\n\tnoteon = (_avatar: Avatar, time: number, note: MidiEventNote) => {\n\t\tlet nn = this.modNote(note.note)\n\t\tthis.sampler.triggerAttack(noteFreq(nn), time, note.attack)\n\t\tif (nn % samps.length === 0) {\n\t\t\t// Update ground color on down beat\n\t\t\tTone.Draw.schedule(() => {\n\t\t\t\tthis.sketch.ground.hue = Math.random()\n\t\t\t\tthis.sketch.ground.sat = Math.random() * 0.4 + 0.5\n\t\t\t}, time)\n\t\t} else {\n\t\t\t// Update sky color on other beats\n\t\t\tTone.Draw.schedule(() => {\n\t\t\t\tthis.sketch.bgCol.hue = Math.random()\n\t\t\t\tthis.sketch.bgCol.sat = Math.random() * 0.4 + 0.5\n\t\t\t}, time)\n\t\t}\n\t}\n\n\tnoteoff = (_avatar: Avatar, time: number, note: MidiEventNote) => {\n\t\tlet nn = this.modNote(note.note)\n\t\tthis.sampler.triggerRelease(noteFreq(nn), time)\n\t}\n}\n","import * as Tone from 'tone'\nimport { Sampler } from './Sampler'\n\nconst pianoSamps = {\n\tA0: 'A0.mp3',\n\tC1: 'C1.mp3',\n\t'D#1': 'Ds1.mp3',\n\t'F#1': 'Fs1.mp3',\n\tA1: 'A1.mp3',\n\tC2: 'C2.mp3',\n\t'D#2': 'Ds2.mp3',\n\t'F#2': 'Fs2.mp3',\n\tA2: 'A2.mp3',\n\tC3: 'C3.mp3',\n\t'D#3': 'Ds3.mp3',\n\t'F#3': 'Fs3.mp3',\n\tA3: 'A3.mp3',\n\tC4: 'C4.mp3',\n\t'D#4': 'Ds4.mp3',\n\t'F#4': 'Fs4.mp3',\n\tA4: 'A4.mp3',\n\tC5: 'C5.mp3',\n\t'D#5': 'Ds5.mp3',\n\t'F#5': 'Fs5.mp3',\n\tA5: 'A5.mp3',\n\tC6: 'C6.mp3',\n\t'D#6': 'Ds6.mp3',\n\t'F#6': 'Fs6.mp3',\n\tA6: 'A6.mp3',\n\tC7: 'C7.mp3',\n\t'D#7': 'Ds7.mp3',\n\t'F#7': 'Fs7.mp3',\n\tA7: 'A7.mp3',\n\tC8: 'C8.mp3',\n}\n\nfunction piano() {\n\treturn new Tone.Sampler({\n\t\turls: pianoSamps,\n\t\trelease: 1,\n\t\tbaseUrl: 'https://tonejs.github.io/audio/salamander/',\n\t})\n}\n\nexport class Piano extends Sampler {\n\tconstructor() {\n\t\tsuper(piano())\n\t}\n}\n","export class Vec extends window.p5.Vector {\n\tw = 0\n\n\tconstructor(...vals: number[]) {\n\t\tsuper()\n\t\tthis.setFromArray(vals)\n\t}\n\n\tclone = (): Vec => new Vec(this.x, this.y, this.z)\n\tcloneMult = (val: number | Vec) => this.clone().applyMult(val)\n\tcloneAdd = (val: number | Vec) => this.clone().applyAdd(val)\n\tcloneSub = (val: number | Vec) => this.clone().applySub(val)\n\n\tisZero = () => this.x === 0 && this.y === 0 && this.z === 0\n\tisOne = () => this.x === 1 && this.y === 1 && this.z === 1\n\tisEqual = (other: Vec) => this.x === other.x && this.y === other.y && this.z === other.z\n\tnormalize = () => this.applyMult(1.0/this.mag())\n\n\ttoArray = () => [this.x, this.y, this.z]\n\tsetFromArray = (vals: number[]) => {\n\t\tthis.x = vals.length > 0 ? vals[0] : 0\n\t\tthis.y = vals.length > 1 ? vals[1] : this.x\n\t\tthis.z = vals.length > 2 ? vals[2] : vals.length === 2 ? 0 : this.x\n\t\treturn this\n\t}\n\n\tapplyMult = (val: number | Vec) => {\n\t\tif (val instanceof Vec) {\n\t\t\tthis.x *= val.x\n\t\t\tthis.y *= val.y\n\t\t\tthis.z *= val.z\n\t\t\treturn this\n\t\t}\n\t\tthis.x *= val\n\t\tthis.y *= val\n\t\tthis.z *= val\n\t\treturn this\n\t}\n\n\tapplyAdd = (val: number | Vec) => {\n\t\tif (val instanceof Vec) {\n\t\t\tthis.x += val.x\n\t\t\tthis.y += val.y\n\t\t\tthis.z += val.z\n\t\t\treturn this\n\t\t}\n\t\tthis.x += val\n\t\tthis.y += val\n\t\tthis.z += val\n\t\treturn this\n\t}\n\n\tapplySub = (val: number | Vec) => {\n\t\tif (val instanceof Vec) {\n\t\t\tthis.x -= val.x\n\t\t\tthis.y -= val.y\n\t\t\tthis.z -= val.z\n\t\t\treturn this\n\t\t}\n\t\tthis.x -= val\n\t\tthis.y -= val\n\t\tthis.z -= val\n\t\treturn this\n\t}\n\n\tcloneMultMat = (mat: number[]): Vec => {\n\t\tif (!mat.length || mat.length !== 16) {\n\t\t\tconsole.error('[Vec #applyMult] invalid matrix provided for mult', mat)\n\t\t\treturn this.clone()\n\t\t}\n\t\tconst dest = new Vec()\n\t\tdest.x = mat[0] * this.x + mat[4] * this.y + mat[8] * this.z + mat[12]\n\t\tdest.y = mat[1] * this.x + mat[5] * this.y + mat[9] * this.z + mat[13]\n\t\tdest.z = mat[2] * this.x + mat[6] * this.y + mat[10] * this.z + mat[14]\n\t\tdest.w = mat[3] * this.x + mat[7] * this.y + mat[11] * this.z + mat[15]\n\t\tif (Math.abs(dest.w) > Number.EPSILON) {\n\t\t\tdest.applyMult(1.0 / dest.w)\n\t\t}\n\t\treturn dest\n\t}\n}\n","import { Vec } from './Vec'\nimport { Xform } from './Xform'\n\nexport class Bounds {\n\tmin = new Vec(-1.0)\n\tmax = new Vec(1.0)\n\n\tconstructor(min?: Vec, max?: Vec) {\n\t\tif (min) { this.min = min }\n\t\tif (max) { this.max = max }\n\t}\n\n\tclone = () => new Bounds(this.min.clone(), this.max.clone())\n\tcloneXform = (xform: Xform) => this.clone().applyXform(xform)\n\n\tapplyXform = (xform: Xform) => {\n\t\txform.applyTo(this.min)\n\t\txform.applyTo(this.max)\n\t\tthis.sanitize()\n\t\treturn this\n\t}\n\n\tsanitize = () => {\n\t\tif (this.min.x > this.max.x) {\n\t\t\tconst tmp = this.min.x\n\t\t\tthis.min.x = this.max.x\n\t\t\tthis.max.x = tmp\n\t\t}\n\t\tif (this.min.y > this.max.y) {\n\t\t\tconst tmp = this.min.y\n\t\t\tthis.min.y = this.max.y\n\t\t\tthis.max.y = tmp\n\t\t}\n\t\tif (this.min.z > this.max.z) {\n\t\t\tconst tmp = this.min.z\n\t\t\tthis.min.z = this.max.z\n\t\t\tthis.max.z = tmp\n\t\t}\n\t\treturn this\n\t}\n\n\t// pushInside returns a zero vector if this bounds is inside the other bounds;\n\t// otherwise, returns the vector required to move this bounds into other\n\tpushInside = (other: Bounds): Vec => {\n\t\tconst off = new Vec()\n\t\tif (this.min.x < other.min.x) {\n\t\t\toff.x = other.min.x - this.min.x\n\t\t} else if (this.max.x > other.max.x) {\n\t\t\toff.x = other.max.x - this.max.x\n\t\t}\n\t\tif (this.min.y < other.min.y) {\n\t\t\toff.y = other.min.y - this.min.y\n\t\t} else if (this.max.y > other.max.y) {\n\t\t\toff.y = other.max.y - this.max.y\n\t\t}\n\t\tif (this.min.z < other.min.z) {\n\t\t\toff.z = other.min.z - this.min.z\n\t\t} else if (this.max.z > other.max.z) {\n\t\t\toff.z = other.max.z - this.max.z\n\t\t}\n\t\treturn off\n\t}\n\n\tcenterAndSize = () => {\n\t\treturn {\n\t\t\tcenter: new Vec(\n\t\t\t\t(this.max.x + this.min.x) / 2,\n\t\t\t\t(this.max.y + this.min.y) / 2,\n\t\t\t\t(this.max.z + this.min.z) / 2,\n\t\t\t),\n\t\t\tsize: new Vec(\n\t\t\t\t(this.max.x - this.min.x),\n\t\t\t\t(this.max.y - this.min.y),\n\t\t\t\t(this.max.z - this.min.z),\n\t\t\t),\n\t\t}\n\t}\n}\n","import { Vec } from './Vec'\n\nexport class Xform {\n\tpos: Vec\n\trot: Vec\n\tscale: Vec\n\n\tconstructor(pos?: Vec, rot?: Vec, scale?: Vec) {\n\t\tthis.pos = pos ? pos : new Vec()\n\t\tthis.rot = rot ? rot : new Vec()\n\t\tthis.scale = scale ? scale : new Vec(1.0)\n\t}\n\n\tapplyTo = (vec: Vec) => {\n\t\tvec.applyMult(this.scale)\n\t\t// TODO: rotation\n\t\tvec.applyAdd(this.pos)\n\t}\n}\n","import { drawFunc, Obj } from './Obj'\n\nexport class Component {\n\tparent: Obj\n\tdrawDebug?: drawFunc\n\n\tconstructor(parent: Obj) {\n\t\tthis.parent = parent\n\t}\n\n\tdestroy() {\n\t\tconsole.log('[Component] destroyed')\n\t}\n\n\tupdate(_dt: number) {\n\t\tconsole.warn('[Component] update')\n\t}\n}\n","import * as p5 from 'p5'\nimport { Obj } from './Obj'\n\nexport type Engine3DOpts = {\n\tdebug?: boolean\n}\n\nexport class Engine3D {\n\tobjs: Obj[] = []\n\tdebug = false\n\tlastUpdate?: number\n\n\tconstructor(opts: Engine3DOpts = {}) {\n\t\tif (opts.debug) {\n\t\t\tthis.debug = true\n\t\t}\n\t}\n\n\taddObj = (obj: Obj) => this.objs.push(obj)\n\trmObj = (obj: Obj) => {\n\t\tthis.objs = this.objs.filter(oo => {\n\t\t\tif (oo === obj) {\n\t\t\t\too.destroy()\n\t\t\t\treturn false\n\t\t\t}\n\t\t\treturn true\n\t\t})\n\t}\n\n\tupdate = () => {\n\t\tif (!this.lastUpdate) {\n\t\t\tthis.lastUpdate = new Date().valueOf()\n\t\t\treturn\n\t\t}\n\t\tconst now = new Date().valueOf()\n\t\tconst dt = (now - this.lastUpdate) / 1000\n\t\tthis.lastUpdate = now\n\t\tthis.objs.forEach(oo => oo.update(dt))\n\t}\n\n\tdraw = (pg: p5.Graphics) => {\n\t\tfor (const obj of this.objs) {\n\t\t\tobj.draw(pg)\n\t\t\tif (this.debug) {\n\t\t\t\tobj.drawDebug(pg)\n\t\t\t}\n\t\t}\n\t}\n\n\tdraw2D = (pp: p5, pg: p5.Graphics) => {\n\t\tconst gg = pg as any\n\t\tconst mvp = gg._renderer.uMVMatrix.copy().mult(gg._renderer.uPMatrix)\n\t\tfor (const obj of this.objs) {\n\t\t\tobj.draw2D(pp, pg, mvp.mat4)\n\t\t}\n\t}\n}\n\nexport const engine3d = new Engine3D({ debug: false })\n","import * as p5 from 'p5'\nimport { Vec } from './Vec'\nimport { Xform } from './Xform'\nimport { Component } from './Component'\nimport { engine3d } from './engine3d'\n\nexport type drawFunc = (pg: p5.Graphics) => void\nexport type drawFunc2D = (pp: p5, pos: Vec, scale: number) => void\n\nexport type ObjOpts = {\n\tcomps?: Component[]\n\tpos?: Vec\n\trot?: Vec\n\tscale?: Vec\n\tdraw?: drawFunc\n\tdraw2D?: drawFunc2D\n}\n\nexport class Obj {\n\tcomps: Component[] = []\n\txform: Xform = new Xform()\n\tdrawFunc?: drawFunc\n\tdrawFunc2D?: drawFunc2D\n\n\tconstructor(opts: ObjOpts) {\n\t\t// console.log('[Obj] ctor', this)\n\t\tthis.drawFunc = opts.draw\n\t\tthis.drawFunc2D = opts.draw2D\n\t\tif (opts.comps) {\n\t\t\tthis.comps = opts.comps\n\t\t}\n\t\tif (opts.pos) {\n\t\t\tthis.xform.pos = opts.pos\n\t\t}\n\t\tif (opts.rot) {\n\t\t\tthis.xform.rot = opts.rot\n\t\t}\n\t\tif (opts.scale) {\n\t\t\tthis.xform.scale = opts.scale\n\t\t}\n\t\tengine3d.addObj(this)\n\t}\n\n\tdestroy = () => {\n\t\tthis.comps.forEach(cc => cc.destroy())\n\t\t// console.log('[Obj] destroyed')\n\t}\n\trm = () => {\n\t\tengine3d.rmObj(this)\n\t}\n\n\taddComp = (comp: Component) => {\n\t\tthis.comps.push(comp)\n\t}\n\trmComponent = (comp: Component) => {\n\t\tthis.comps = this.comps.filter(cc => {\n\t\t\tif (cc === comp) {\n\t\t\t\tcc.destroy()\n\t\t\t\treturn false\n\t\t\t}\n\t\t\treturn true\n\t\t})\n\t}\n\tgetComps = (compType: any) => this.comps.filter(cc => cc instanceof compType)\n\tgetComp = (compType: any): Component | null => {\n\t\tconst cs = this.getComps(compType)\n\t\tif (cs.length) {\n\t\t\treturn cs[0]\n\t\t}\n\t\treturn null\n\t}\n\n\tupdate(dt: number) {\n\t\tthis.comps.forEach(cc => cc.update(dt))\n\t}\n\n\tdraw(pg: p5.Graphics) {\n\t\tpg.push()\n\t\tthis.applyXformToGraphics(pg)\n\t\tif (this.drawFunc) {\n\t\t\tthis.drawFunc(pg)\n\t\t}\n\t\tpg.pop()\n\t}\n\n\tdraw2D(pp: p5, pg: p5.Graphics, mvp: number[]) {\n\t\tif (!this.drawFunc2D) {\n\t\t\treturn\n\t\t}\n\t\tconst { pos, scale } = this.xform\n\t\tconst ndcPos = pos.cloneMultMat(mvp)\n\t\tconst edge = 1.2\n\t\tif (ndcPos.w < 0 || ndcPos.x < -edge || ndcPos.x > edge || ndcPos.y < -edge || ndcPos.y > edge) {\n\t\t\t// object is off-screen\n\t\t\treturn\n\t\t}\n\t\t// calculate a rough-guess at screen-space scale\n\t\t// (would use inverse MVP matrix but I can't get p5's matrix invert method to work)\n\t\tconst ndcPos2 = pos.cloneAdd(scale).cloneMultMat(mvp)\n\t\tconst ndcPos3 = pos.cloneAdd(scale.cloneMult(new Vec(1, -1, -1))).cloneMultMat(mvp)\n\t\tconst ndcPos4 = pos.cloneAdd(scale.cloneMult(new Vec(-1, -1, 1))).cloneMultMat(mvp)\n\t\tfor (const ndc of [ndcPos, ndcPos2, ndcPos3, ndcPos4]) {\n\t\t\tndc.x = (ndc.x + 1) * pp.width / 2\n\t\t\tndc.y = (1 - ndc.y) * pp.height / 2\n\t\t\tndc.z = 0\n\t\t}\n\t\tconst scale2d = Math.max(\n\t\t\tndcPos.cloneSub(ndcPos2).mag(),\n\t\t\tndcPos.cloneSub(ndcPos3).mag(),\n\t\t\tndcPos.cloneSub(ndcPos4).mag(),\n\t\t)\n\t\tpp.push()\n\t\tthis.drawFunc2D(pp, ndcPos, scale2d)\n\t\tpp.pop()\n\t}\n\n\tdrawDebug = (pg: p5.Graphics) => {\n\t\tthis.comps.forEach(cc => cc.drawDebug && cc.drawDebug(pg))\n\t}\n\n\tapplyXformToGraphics = (pg: p5.Graphics) => {\n\t\tconst { pos, rot, scale } = this.xform\n\t\tif (!pos.isZero()) {\n\t\t\tpg.translate(pos.x, pos.y, pos.z)\n\t\t}\n\t\tif (rot.z !== 0) pg.rotateZ(rot.z)\n\t\tif (rot.y !== 0) pg.rotateY(rot.y)\n\t\tif (rot.x !== 0) pg.rotateX(rot.x)\n\t\tif (!scale.isOne()) {\n\t\t\tpg.scale(scale.x, scale.y, scale.z)\n\t\t}\n\t}\n}\n","import { Bounds, Component, Obj, Vec } from '../core'\n\nconst gravity = new Vec(0, -9.82, 0)\nexport type PhysicalOpts = {\n\tbounds?: Bounds\n\tworldScale?: number\n}\n\n// Physical is a very simple physics implementation, applying forces\n// to the parent object and constraining it to a hard-coded world bounds\nexport class Physical extends Component {\n\tforce = new Vec()\n\tvel = new Vec()\n\tbounds: Bounds\n\tworld: Bounds\n\n\tconstructor(parent: Obj, opts: PhysicalOpts = {}) {\n\t\tsuper(parent)\n\t\tthis.bounds = opts.bounds ? opts.bounds : new Bounds()\n\t\tif (!opts.worldScale) {\n\t\t\topts.worldScale = 1000\n\t\t}\n\t\tthis.world = new Bounds(\n\t\t\tnew Vec(-opts.worldScale, 0, -opts.worldScale),\n\t\t\tnew Vec(opts.worldScale, opts.worldScale, opts.worldScale),\n\t\t)\n\t}\n\n\tupdate = (dt: number) => {\n\t\t// Update velocity based on forces\n\t\tthis.vel.applyAdd(gravity.cloneAdd(this.force).applyMult(dt))\n\t\tthis.vel.applyMult(new Vec(0.8, 1.0, 0.8)) // friction in X and Z\n\t\tif (this.vel.magSq() < 0.01) {\n\t\t\t// Velocity threshold\n\t\t\tthis.vel.applyMult(0)\n\t\t}\n\t\t// Update position based on velocity\n\t\tconst { pos } = this.parent.xform\n\t\tpos.applyAdd(this.vel)\n\t\t// Constrain to world bounds\n\t\tconst off = this.worldBounds().pushInside(this.world)\n\t\tif (off.isZero()) {\n\t\t\treturn\n\t\t}\n\t\t// Apply constraint offset\n\t\tpos.applyAdd(off)\n\t\t// Bounce the velocity\n\t\tif (off.x !== 0) {\n\t\t\tthis.vel.x *= -0.5\n\t\t}\n\t\tif (off.y !== 0) {\n\t\t\tthis.vel.y *= -0.5\n\t\t}\n\t\tif (off.z !== 0) {\n\t\t\tthis.vel.z *= -0.5\n\t\t}\n\t}\n\n\tdrawDebug = (pg: p5.Graphics) => {\n\t\tconst { center, size } = this.worldBounds().centerAndSize()\n\t\tpg.push()\n\t\tpg.noFill()\n\t\tpg.stroke(255, 0, 0)\n\t\tpg.strokeWeight(1)\n\t\tpg.translate(center.x, center.y, center.z)\n\t\tpg.box(size.x, size.y, size.z)\n\t\tpg.pop()\n\t}\n\n\tworldBounds = () => this.bounds.cloneXform(this.parent.xform)\n}\n","import { EasyCam } from 'vendor/p5.easycam.js'\nimport { Component, Obj } from '../core'\n\n// FollowCam locks an EasyCam's center to the parent Obj\nexport class FollowCam extends Component {\n\tcam: EasyCam\n\n\tconstructor(parent: Obj, cam: EasyCam) {\n\t\tsuper(parent)\n\t\tthis.cam = cam\n\t}\n\n\tlast?: number\n\tupdate = (dt: number) => {\n\t\tif (!this.cam.state || !this.cam.state.center) {\n\t\t\treturn\n\t\t}\n\t\tconst { x, y, z } = this.parent.xform.pos\n\t\tthis.cam.setCenter([x, y, z], 0)\n\t}\n}\n","import * as p5 from 'p5'\nimport { EasyCam } from 'vendor/p5.easycam.js'\nimport { User, UserForce, UserXform } from 'app/serverApi/serverApi'\nimport { Obj, ObjOpts, Vec } from '../core'\nimport { Physical, PhysicalOpts, FollowCam } from '../components'\n\ntype KeyMovement = {\n\tup: boolean\n\tdown: boolean\n\tleft: boolean\n\tright: boolean\n\tjump: boolean\n\tjumpInitial: boolean\n\tgain: number\n}\n\ntype forceFunc = (data: UserXform) => void\n\nexport type AvatarOpts = ObjOpts & {\n\tuser: User\n\tphys?: PhysicalOpts\n\tonForce?: forceFunc\n}\n\nexport class Avatar extends Obj {\n\tphys: Physical\n\tuser: User\n\tfollowCam?: FollowCam\n\tonForce?: forceFunc\n\n\tkeys: KeyMovement = {\n\t\tup: false,\n\t\tdown: false,\n\t\tleft: false,\n\t\tright: false,\n\t\tjump: false,\n\t\tjumpInitial: false,\n\t\tgain: 150,\n\t}\n\n\tconstructor(opts: AvatarOpts) {\n\t\tsuper(opts)\n\t\tthis.user = opts.user\n\t\tthis.phys = new Physical(this, opts.phys)\n\t\tthis.comps = [this.phys]\n\t\tthis.onForce = opts.onForce\n\t\tif (!this.drawFunc) {\n\t\t\tthis.drawFunc = this.render\n\t\t}\n\t\tif (!this.drawFunc2D) {\n\t\t\tthis.drawFunc2D = this.render2D\n\t\t}\n\t\tconsole.log('[Avatar] ctor', this)\n\t}\n\n\tupdate(dt: number) {\n\t\tsuper.update(dt)\n\t\tif (this.keys.jumpInitial) {\n\t\t\tthis.keys.jumpInitial = false\n\t\t\tthis.keysUpdated()\n\t\t}\n\t}\n\n\tdraw(pg: p5.Graphics) {\n\t\tsuper.draw(pg) // applys xform and calls this.render\n\t\t// draw shadow\n\t\tconst { pos, scale } = this.xform\n\t\tpg.push()\n\t\tpg.fill(30)\n\t\tpg.noStroke()\n\t\tpg.translate(pos.x, 0, pos.z)\n\t\tpg.scale(scale.x, 0, scale.z)\n\t\tpg.rotateX(Math.PI/2)\n\t\tpg.circle(0, 0, 2)\n\t\tpg.pop()\n\t}\n\n\trender = (pg: p5.Graphics) => {\n\t\tpg.fill(0)\n\t\tpg.stroke(255)\n\t\tpg.strokeWeight(2)\n\t\tpg.sphere(1, 7, 7)\n\t}\n\n\trender2D = (pp: p5, pos: Vec, scale: number) => {\n\t\tconst { name, instrument, offset } = this.user\n\t\tif (scale < 15) {\n\t\t\treturn\n\t\t}\n\t\tconst ss = Math.min(scale, 50)\n\t\tpp.translate(pos.x, pos.y)\n\t\tpp.textAlign(pp.CENTER, pp.BOTTOM)\n\t\tpp.fill(255)\n\t\tpp.noStroke()\n\t\tpp.textSize(ss/2)\n\t\tpp.textStyle(pp.BOLD)\n\t\tif (scale < 35) {\n\t\t\tpp.text(name, 0, -ss * 0.8)\n\t\t\treturn\n\t\t} else {\n\t\t\tpp.text(name, 0, -ss * 1.1)\n\t\t}\n\t\tpp.fill(225)\n\t\tpp.textSize(ss * 0.3)\n\t\tpp.textStyle(pp.ITALIC)\n\t\tpp.text(`${instrument} (@${offset > 0 ? '+' : ''}${offset})`, 0, -ss * 0.75)\n\t}\n\n\taddFollowCam = (cam: EasyCam) => {\n\t\tthis.followCam = new FollowCam(this, cam)\n\t\tthis.followCam.update(0)\n\t\tthis.addComp(this.followCam)\n\t}\n\n\tgetUserXform = (): UserXform => ({\n\t\tclientId: this.user.clientId,\n\t\tpos: this.xform.pos.toArray(),\n\t\trot: this.xform.rot.toArray(),\n\t\tscale: this.xform.scale.toArray(),\n\t\tforce: this.phys.force.toArray(),\n\t\tvel: this.phys.vel.toArray(),\n\t})\n\n\tsetUserXform = (data: UserXform) => {\n\t\tthis.xform.pos.setFromArray(data.pos)\n\t\tthis.xform.rot.setFromArray(data.rot)\n\t\tthis.xform.scale.setFromArray(data.scale)\n\t\tthis.phys.force.setFromArray(data.force)\n\t\tthis.phys.vel.setFromArray(data.vel)\n\t}\n\n\tsetUserForce = (data: UserForce) => {\n\t\tthis.phys.force.setFromArray(data.force)\n\t}\n\n\t//\n\t// Keyboard state updates and movement controls\n\t//\n\tkeyPressed = (evt: p5) => this.keyChanged(evt, true)\n\tkeyReleased = (evt: p5) => this.keyChanged(evt, false)\n\tkeyChanged = (evt: p5, pressed: boolean) => {\n\t\tswitch (evt.key) {\n\t\t\tcase 'ArrowUp':\n\t\t\t\tthis.keys.up = pressed\n\t\t\t\tbreak\n\t\t\tcase 'ArrowDown':\n\t\t\t\tthis.keys.down = pressed\n\t\t\t\tbreak\n\t\t\tcase 'ArrowLeft':\n\t\t\t\tthis.keys.left = pressed\n\t\t\t\tbreak\n\t\t\tcase 'ArrowRight':\n\t\t\t\tthis.keys.right = pressed\n\t\t\t\tbreak\n\t\t\tcase ' ':\n\t\t\t\tthis.keys.jump = pressed\n\t\t\t\tthis.keys.jumpInitial = pressed\n\t\t\t\tbreak\n\t\t\tdefault:\n\t\t\t\treturn\n\t\t}\n\t\tthis.keysUpdated()\n\t}\n\n\t// keysUpdated applies force to the Physical component based on keyboard state and camera orientation\n\tkeysUpdated = () => {\n\t\tconst { up, down, left, right, jump, jumpInitial, gain } = this.keys\n\t\tconst mov = new Vec()\n\t\tmov.x = left && right ? 0 : left ? -gain : right ? gain : 0\n\t\tmov.y = jumpInitial && this.xform.pos.y < this.xform.scale.y * 1.5 ? gain * 2 : jump ? 5 : 0\n\t\tmov.z = down && up ? 0 : up ? gain : down ? -gain : 0\n\t\tif (!this.followCam) {\n\t\t\t// Can't determine camera orientation, apply force in world-space\n\t\t\tthis.phys.force = mov\n\t\t\tif (this.onForce) {\n\t\t\t\tthis.onForce(this.getUserXform())\n\t\t\t}\n\t\t\treturn\n\t\t}\n\t\t// Convert movement vector to force based on camera orientation\n\t\tconst ca = this.followCam.cam.centerAxes() // X=screen-right Z=screen-up, parallel to ground plane\n\t\tconst cax = new Vec(ca.x[0], ca.x[1], ca.x[2])\n\t\tconst caz = new Vec(ca.z[0], ca.z[1], ca.z[2])\n\t\tconst ff = new Vec(0, mov.y, 0)\n\t\tff.applyAdd(cax.applyMult(mov.x))\n\t\tff.applyAdd(caz.applyMult(mov.z))\n\t\tthis.phys.force = ff\n\t\tif (this.onForce) {\n\t\t\tthis.onForce(this.getUserXform())\n\t\t}\n\t}\n\n\t// userUpdated = () => {\n\t// \tconsole.log('[Avatar #userUpdated]', this.user.name)\n\t// }\n\n}\n","import * as p5 from 'p5'\nimport { Obj, ObjOpts } from '../core'\n\nexport class Ground extends Obj {\n\thue: number\n\tsat: number\n\n\tconstructor(opts: ObjOpts = {}) {\n\t\tconst subDF = opts.draw\n\t\topts.draw = (pg: p5.Graphics) => {\n\t\t\tpg.colorMode(pg.HSL, 1)\n\t\t\t// Draw ground plane\n\t\t\tpg.angleMode(pg.RADIANS)\n\t\t\tpg.fill(this.hue, this.sat, 0.3)\n\t\t\tpg.noStroke()\n\t\t\tpg.rotateX(Math.PI / 2)\n\t\t\tpg.rect(-1, -1, 2, 2)\n\t\t\tif (subDF) {\n\t\t\t\tsubDF(pg)\n\t\t\t}\n\t\t\tpg.colorMode(pg.RGB, 255)\n\t\t}\n\t\tsuper(opts)\n\t\tthis.hue = 0.5\n\t\tthis.sat = 0\n\t}\n}\n","import * as p5 from 'p5'\nimport * as Tone from 'tone'\nimport { MidiEventCC, MidiEventNote, MidiEventPitchbend } from '../MIDI'\nimport { Instrument } from '../Instrument'\nimport { noteFreq } from './util'\nimport { engine3d, Avatar, Obj, ObjOpts, Vec } from 'engine3d'\n\nexport type SynthObjOpts = ObjOpts & {\n\tnoteEvt: MidiEventNote\n}\n\nconst srand = () => Math.random() * 2 - 1\nconst srandVec = () => new Vec(srand(), srand(), srand())\n\nclass SynthObj extends Obj {\n\tpolySynth: PolySynth\n\tcreatedAt: number\n\tnoteEvt: MidiEventNote\n\tscaleOrig: Vec\n\tvoice: Tone.Synth | null = null\n\treleasedAt = 0\n\thue = Math.random()\n\tlgt = 0.3\n\tenvValLast = 1\n\n\tconstructor(polySynth: PolySynth, opts: SynthObjOpts) {\n\t\tsuper(opts)\n\t\tthis.polySynth = polySynth\n\t\tthis.createdAt = new Date().valueOf() / 1000\n\t\tthis.noteEvt = opts.noteEvt\n\t\tthis.drawFunc = this.render\n\t\tthis.scaleOrig = this.xform.scale.clone()\n\t}\n\n\trelease = () => this.releasedAt = new Date().valueOf() / 1000\n\n\tupdate = (dt: number) => {\n\t\tlet mod = 1 - this.polySynth.modwheel\n\t\tmod = 1 - (mod * mod)\n\t\t// set lightness\n\t\tthis.lgt = mod * 0.8 + 0.2\n\t\t// set hue\n\t\tthis.hue += (Math.random() * 2 - 1) * dt * mod\n\t\tif (this.hue < 0) { this.hue += 1 }\n\t\telse if (this.hue > 1) { this.hue -= 1 }\n\t\tthis.xform.rot.applyAdd(srandVec().applyMult(dt * mod))\n\t\t// // Disabled for now: scale by envelope value\n\t\t// const voices = (this.polySynth.synth as any)._activeVoices\n\t\t// if (!this.voice) {\n\t\t// \tfor (const vv of voices) {\n\t\t// \t\tif (vv.midi === noteFreq(this.noteEvt.note) && !vv.released) {\n\t\t// \t\t\tthis.voice = vv.voice\n\t\t// \t\t\tbreak\n\t\t// \t\t}\n\t\t// \t}\n\t\t// }\n\t\t// if (this.voice) {\n\t\t// \tthis.envValLast = this.voice.envelope.value\n\t\t// }\n\t\t// this.xform.scale = this.scaleOrig.cloneMult(this.envValLast)\n\t}\n\n\trender = (pg: p5.Graphics) => {\n\t\tpg.colorMode(pg.HSL, 1)\n\t\tpg.fill(this.hue, 0.8, this.lgt)\n\t\tpg.stroke(this.hue, 0.8, this.lgt - 0.2)\n\t\tpg.strokeWeight(1)\n\t\tpg.sphere(1, 3, 4)\n\t\tpg.colorMode(pg.RGB, 255)\n\t}\n}\n\nexport class PolySynth extends Instrument {\n\tsynth: Tone.PolySynth\n\tfilter: Tone.Filter\n\tfilterVol: Tone.Volume\n\treverb: Tone.Reverb\n\tpanVol: Tone.PanVol\n\tps = 0\n\tpsSpread = 7\n\tattack = 0.01\n\tdecay = 0.07\n\tsustain = 0.3\n\trelease = 0.6\n\tmodwheel = 0.3\n\tobjs: Obj[] = []\n\tmaxObjs = 24\n\tii = 0\n\n\tconstructor() {\n\t\tsuper()\n\t\tthis.panVol = new Tone.PanVol(0, 0).toDestination()\n\t\tthis.reverb = new Tone.Reverb({ decay: 4, wet: 0.6 }).connect(this.panVol)\n\t\tthis.filterVol = new Tone.Volume(0).connect(this.reverb)\n\t\tthis.filter = new Tone.Filter({\n\t\t\ttype: 'bandpass',\n\t\t\tfrequency: 1000,\n\t\t\tQ: 2,\n\t\t}).connect(this.filterVol)\n\t\tthis.synth = new Tone.PolySynth(Tone.Synth, {\n\t\t\toscillator: {\n\t\t\t\ttype: 'fatsawtooth',\n\t\t\t\tcount: 3,\n\t\t\t\tspread: 30,\n\t\t\t},\n\t\t\tenvelope: {\n\t\t\t\tattack: this.attack,\n\t\t\t\tdecay: this.decay,\n\t\t\t\tsustain: this.sustain,\n\t\t\t\trelease: this.release,\n\t\t\t},\n\t\t}).connect(this.filter)\n\t}\n\n\tsetFilterGain = (db: number) => {\n\t\tthis.filter.set({ gain: db })\n\t\tthis.filterVol.volume.set({ value: Math.min(0, -db) })\n\t}\n\n\tloaded() {\n\t\treturn true\n\t}\n\n\tnoteon = (avatar: Avatar, time: number, evt: MidiEventNote) => {\n\t\tthis.synth.triggerAttack(noteFreq(evt.note), time, evt.attack)\n\t\tTone.Draw.schedule(() => this.addSynthObj(avatar, evt), time)\n\t}\n\n\tnoteoff = (_avatar: Avatar, time: number, evt: MidiEventNote) => {\n\t\tthis.synth.triggerRelease(noteFreq(evt.note), time)\n\t}\n\n\tcontrolchange = (_avatar: Avatar, time: number, evt: MidiEventCC) => {\n\t\tconst num = evt.controller.number\n\t\tlet delayed: (() => void) | null = null\n\t\tswitch (true) {\n\t\t\tcase num === 1:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tconst vv = evt.value * evt.value\n\t\t\t\t\tthis.filter.set({ frequency: 20 + 10000 * vv })\n\t\t\t\t\tthis.modwheel = evt.value\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase num === 21:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tconst vv = evt.value * evt.value\n\t\t\t\t\tthis.filter.set({ Q: vv * 8 })\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase num === 27:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.psSpread = evt.value * 12\n\t\t\t\t\tthis.updatePitchbend()\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase num === 28:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.panVol.set({ pan: evt.value * 2 - 1 })\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase 71 <= num && num <= 74: {\n\t\t\t\tlet vv = evt.value * evt.value * evt.value * evt.value\n\t\t\t\tconst key = ['attack', 'decay', 'sustain', 'release'][num - 71]\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tvv = key === 'sustain' ? evt.value : 10 * vv\n\t\t\t\t\t;(this as any)[key] = vv\n\t\t\t\t\tthis.synth.set({ envelope: { [key]: vv } })\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase 75 <= num && num <= 79:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.panVol.mute = !evt.value\n\t\t\t\t\tthis.panVol.set({ volume: (evt.value - 1) * 50 })\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase 15 <= num && num <= 19:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.panVol.mute = !evt.value\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tdefault:\n\t\t\t\tconsole.log(\n\t\t\t\t\t`[PolySynth #controlchange] Unsupported CC event on channel ${evt.channel}:`,\n\t\t\t\t\tevt.controller,\n\t\t\t\t\tevt.value,\n\t\t\t\t)\n\t\t}\n\t\tif (delayed) {\n\t\t\tTone.Draw.schedule(delayed, time)\n\t\t}\n\t}\n\n\tpitchbend = (_avatar: Avatar, time: number, evt: MidiEventPitchbend) => {\n\t\tTone.Draw.schedule(() => {\n\t\t\tthis.ps = evt.value\n\t\t\tthis.updatePitchbend()\n\t\t}, time)\n\t}\n\n\tupdatePitchbend = () => {\n\t\tthis.synth.set({ detune: 100 * this.ps * this.psSpread })\n\t}\n\n\taddSynthObj = (avatar: Avatar, evt: MidiEventNote) => {\n\t\t// Create obj for note\n\t\tconst objSize = 100\n\t\tconst { objs, maxObjs } = this\n\t\tlet pos = avatar.xform.pos\n\t\tif (objs.length) {\n\t\t\tpos = objs[0].xform.pos\n\t\t}\n\t\tconst off = new Vec(srand(), Math.random(), srand()).applyMult(objSize * 0.6)\n\t\tpos = pos.cloneAdd(off)\n\t\tif (this.ii++ % 8 === 0) {\n\t\t\tpos.x = avatar.xform.pos.x\n\t\t\tpos.y = avatar.xform.pos.y\n\t\t\tpos.z = avatar.xform.pos.z\n\t\t}\n\t\tconst rot = new Vec(\n\t\t\tMath.random() * Math.PI * 2,\n\t\t\tMath.random() * Math.PI * 2,\n\t\t\tMath.random() * Math.PI * 2\n\t\t)\n\t\tconst obj = new SynthObj(this, {\n\t\t\tnoteEvt: evt,\n\t\t\tpos: pos,\n\t\t\trot: rot,\n\t\t\tscale: new Vec(objSize),\n\t\t})\n\t\t// Add obj to engine\n\t\tobjs.unshift(obj)\n\t\tengine3d.addObj(obj)\n\t\tif (objs.length > maxObjs) {\n\t\t\t// remove oldest obj\n\t\t\tengine3d.rmObj(objs[objs.length - 1])\n\t\t\tthis.objs = objs.slice(0, maxObjs)\n\t\t}\n\t}\n\n}\n","import * as p5 from 'p5'\nimport { Avatar } from 'engine3d'\nimport { UserEvent } from './serverApi/serverApi'\n\nclass VisualNote {\n\tage: number = 0\n\treleased: boolean = false\n\tfirstUpdate: boolean = true\n\tageReleased: number = 0\n\tx: number = -1\n\ty: number = -1\n\tvelx: number = 0\n\tvely: number = 0\n\tyoung: number = 2.0 // decreases to 1 over youngDur frames\n\thealth: number = 1.0 // after release, decreases to 0 over fadeOut frames\n\tyoungDur: number // number of frames this note is 'young' (i.e. in attack)\n\tfadeOut: number // number of frames to fade away after release\n\tradius: number\n\tradiusOrig: number\n\tevt: UserEvent\n\tavatar: Avatar\n\n\tconstructor(evt: UserEvent, avatar: Avatar) {\n\t\tthis.evt = evt\n\t\tthis.avatar = avatar\n\t\tconst aa = this.evt.midiEvent.attack || 0.5\n\t\tthis.radius = aa * 25 + 5\n\t\tthis.radiusOrig = this.radius\n\t\tswitch (evt.instrument) {\n\t\t\tcase 'eightOhEight':\n\t\t\t\tthis.youngDur = 2\n\t\t\t\tthis.fadeOut = 3\n\t\t\t\tbreak\n\t\t\tdefault:\n\t\t\t\tthis.youngDur = 5\n\t\t\t\tthis.fadeOut = 10\n\t\t\t\tbreak\n\t\t}\n\t}\n\n\trelease = () => {\n\t\tthis.released = true\n\t\tthis.ageReleased = this.age\n\t}\n\n\tisDead = () => this.released && this.age - this.ageReleased > this.fadeOut\n\n\tupdate = (pg: p5.Graphics, others: VisualNote[]) => {\n\t\tconst close = 50,\n\t\t\tweightVC = 1.8,\n\t\t\tweightC = 0.2,\n\t\t\tweightF = 1.0 / 500000,\n\t\t\tweightU = 0.003,\n\t\t\t{ pos } = this.avatar.xform,\n\t\t\tux = pos.x/1000,\n\t\t\tuy = pos.z/1000,\n\t\t\twidth = 1000,\n\t\t\theight = 1000\n\n\t\tif (this.firstUpdate) {\n\t\t\t// transform original normalized position into screen space\n\t\t\tthis.x = width * (ux + 0.1 * (Math.random() * 2 - 1))\n\t\t\tthis.y = height * (uy + 0.1 * (Math.random() * 2 - 1))\n\t\t\tthis.firstUpdate = false\n\t\t}\n\n\t\tthis.young = Math.max(1.0, 2.0 - this.age / this.youngDur)\n\t\tthis.age++\n\t\tif (this.released) {\n\t\t\tthis.health = 1.0 - (this.age - this.ageReleased) / this.fadeOut\n\t\t}\n\t\tthis.radius = this.radiusOrig * this.health\n\n\t\tthis.velx *= 0.924\n\t\tthis.vely *= 0.924\n\t\tthis.velx -= weightU * (this.x - ux * width)\n\t\tthis.vely -= weightU * (this.y - uy * height)\n\t\tfor (const other of others) {\n\t\t\tif (other === this) {\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tconst dx = this.x - other.x\n\t\t\tconst dy = this.y - other.y\n\t\t\tconst ddx = dx * dx\n\t\t\tconst ddy = dy * dy\n\t\t\tconst sx = dx < 0 ? -1 : 1\n\t\t\tconst sy = dy < 0 ? -1 : 1\n\t\t\tconst dd = Math.sqrt(ddx + ddy)\n\t\t\tconst cc = close * close\n\t\t\tconst outerDist = dd - (this.radius + other.radius)\n\t\t\tif (outerDist < 0) {\n\t\t\t\t// notes bounce off each other if they're touching\n\t\t\t\tthis.velx += (weightVC * sx * (cc * 3 - ddx)) / cc\n\t\t\t\tthis.vely += (weightVC * sy * (cc * 3 - ddy)) / cc\n\t\t\t} else if (outerDist < close) {\n\t\t\t\t// notes repel each other a little if they're not touching but still close\n\t\t\t\tthis.velx += (weightC * sx * ddx) / cc\n\t\t\t\tthis.vely += (weightC * sy * ddy) / cc\n\t\t\t} else if (other.evt.instrument === this.evt.instrument) {\n\t\t\t\t// notes from the same instrument spring towards each other when they're far away\n\t\t\t\tthis.velx -= weightF * sx * ddx\n\t\t\t\tthis.vely -= weightF * sy * ddy\n\t\t\t}\n\t\t}\n\t\t// bounce off the walls\n\t\tif ((this.x < -width + this.radius && this.velx < 0) || (this.x > width - this.radius && this.velx > 0)) {\n\t\t\tthis.velx *= -1\n\t\t}\n\t\tif ((this.y < -height + this.radius && this.vely < 0) || (this.y > height - this.radius && this.vely > 0)) {\n\t\t\tthis.vely *= -1\n\t\t}\n\t\tthis.x += this.velx\n\t\tthis.y += this.vely\n\t}\n\n\tdraw = (pp: p5, pg: p5.Graphics) => {\n\t\tpg.colorMode(pp.HSL, 1)\n\t\tconst { instrument, midiEvent } = this.evt\n\t\tconst { attack, note } = midiEvent\n\t\tconst aa = attack || 0.5\n\t\tconst sat = aa * 0.3 + 0.55\n\t\tconst size = this.radius * 2 * this.young\n\t\tswitch (instrument) {\n\t\t\tcase 'eightOhEight':\n\t\t\tcase 'metronome': {\n\t\t\t\tconst hue = (note % 16) / 16\n\t\t\t\tpg.fill(hue * 0.4 + 0.05, sat, 0.45, this.health)\n\t\t\t\tpg.square(this.x - size / 2, this.y - size / 2, size)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tdefault: {\n\t\t\t\tconst hue = (note % 12) / 12\n\t\t\t\tconst lgt = Math.min(note / 128 + 0.2, 0.65)\n\t\t\t\tpg.fill(hue * 0.25 + 0.55, sat, lgt, this.health)\n\t\t\t\tpg.circle(this.x, this.y, size)\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t\tpg.colorMode(pp.RGB, 255)\n\t}\n}\n\nexport default class VisualNotes {\n\tnotes: VisualNote[] = []\n\n\tnoteon = (evt: UserEvent, avatar: Avatar) => {\n\t\tthis.notes.push(new VisualNote(evt, avatar))\n\t}\n\n\tnoteoff = (evt: UserEvent) => {\n\t\tconst notes = this.notes.filter(nn => !nn.released && this.isSameNote(nn, evt))\n\t\tif (!notes.length) {\n\t\t\tconsole.warn('[VisualNotes #noteoff] Unable to find note for event', evt)\n\t\t\treturn\n\t\t}\n\t\tnotes.forEach(nn => nn.release())\n\t}\n\n\tisSameNote = (note: VisualNote, evt: UserEvent) => {\n\t\treturn note.evt.instrument === evt.instrument && note.evt.midiEvent.note === evt.midiEvent.note\n\t}\n\n\t/*eslint no-lone-blocks: \"off\"*/\n\tdraw = (pp: p5, pg: p5.Graphics) => {\n\t\tthis.notes = this.notes.filter(nn => !nn.isDead())\n\t\tthis.notes.forEach(nn => nn.update(pg, this.notes))\n\t\tpg.perspective(Math.PI / 3, pg.width / pg.height, 0.5, 10000)\n\t\tpg.clear()\n\t\tpg.push()\n\t\tpg.noStroke()\n\t\tpg.translate(0, 5, 0)\n\t\tpg.rotateX(Math.PI/2)\n\t\tthis.notes.forEach(nn => nn.draw(pp, pg))\n\t\tpg.pop()\n\t}\n}\n","// import * as p5 from 'p5'\n/*\n *\n * The p5.EasyCam library - Easy 3D CameraControl for p5.js and WEBGL.\n *\n *   Copyright  2017-2020 by p5.EasyCam authors\n *\n *   Source: https://github.com/freshfork/p5.EasyCam\n *\n *   MIT License: https://opensource.org/licenses/MIT\n *\n *\n * explanatory notes:\n *\n * p5.EasyCam is a derivative of the original PeasyCam Library by Jonathan Feinberg\n * and combines new useful features with the great look and feel of its parent.\n *\n */\n\n/** @namespace  */\n// var Dw = (function(ext) {\nconst ext = {}\n\n/**\n * EasyCam Library Info\n */\nconst INFO = {\n\t/** name    */ LIBRARY: 'p5.EasyCam',\n\t/** version */ VERSION: '1.0.10',\n\t/** author  */ AUTHOR: 'p5.EasyCam authors',\n\t/** source  */ SOURCE: 'https://github.com/freshfork/p5.EasyCam',\n\n\ttoString: function () {\n\t\treturn this.LIBRARY + ' v' + this.VERSION + ' by ' + this.AUTHOR + ' (' + this.SOURCE + ')'\n\t},\n}\n\n/**\n * EasyCam\n *\n * <pre>\n *\n *   new Dw.EasyCam(p5.RendererGL, {\n *     distance : z,                 // scalar\n *     center   : [x, y, z],         // vector\n *     rotation : [q0, q1, q2, q3],  // quaternion\n *     viewport : [x, y, w, h],      // array\n *   }\n *\n * </pre>\n *\n * @param {p5.RendererGL} renderer - p5 WEBGL renderer\n * @param {Object}        args     - {distance, center, rotation, viewport}\n *\n */\nexport class EasyCam {\n\t/**\n\t * @constructor\n\t */\n\tconstructor(renderer, args) {\n\t\t// WEBGL renderer required\n\t\tif (!(renderer instanceof window.p5.RendererGL)) {\n\t\t\tconsole.log('renderer needs to be an instance of p5.RendererGL')\n\t\t\treturn\n\t\t}\n\n\t\t// define default args\n\t\targs = args || {}\n\t\tif (args.distance === undefined) args.distance = 500\n\t\tif (args.center === undefined) args.center = [0, 0, 0]\n\t\tif (args.rotation === undefined) args.rotation = Rotation.identity()\n\t\tif (args.viewport === undefined) args.viewport = [0, 0, renderer.width, renderer.height]\n\n\t\t// library info\n\t\tthis.INFO = INFO\n\n\t\t// set renderer, graphics, p5\n\t\t// this.renderer;\n\t\t// this.graphics;\n\t\t// this.P5\n\t\tthis.setCanvas(renderer)\n\n\t\t// self reference\n\t\tvar cam = this\n\t\tthis.cam = cam\n\n\t\t// some constants\n\t\tthis.LOOK = [0, 0, 1]\n\t\tthis.UP = [0, 1, 0]\n\n\t\t// principal axes flags\n\t\tthis.AXIS = new (function () {\n\t\t\tthis.YAW = 0x01\n\t\t\tthis.PITCH = 0x02\n\t\t\tthis.ROLL = 0x04\n\t\t\tthis.ALL = this.YAW | this.PITCH | this.ROLL\n\t\t})()\n\n\t\t// mouse action constraints\n\t\tthis.SHIFT_CONSTRAINT = 0 // applied when pressing the shift key\n\t\tthis.FIXED_CONSTRAINT = 0 // applied, when set by user and SHIFT_CONSTRAINT is 0\n\t\tthis.DRAG_CONSTRAINT = 0 // depending on SHIFT_CONSTRAINT and FIXED_CONSTRAINT, default is ALL\n\n\t\t// mouse action speed\n\t\tthis.scale_rotation = 0.001\n\t\tthis.scale_pan = 0.0002\n\t\tthis.scale_zoom = 0.001\n\t\tthis.scale_zoomwheel = 20.0\n\n\t\t// zoom limits\n\t\tthis.distance_min_limit = 0.01\n\t\tthis.distance_min = 1.0\n\t\tthis.distance_max = Number.MAX_VALUE\n\n\t\t// main state\n\t\tthis.state = {\n\t\t\tdistance: args.distance, // scalar\n\t\t\tcenter: args.center.slice(), // vec3\n\t\t\trotation: args.rotation.slice(), // quaternion\n\n\t\t\tcopy: function (dst) {\n\t\t\t\tdst = dst || {}\n\t\t\t\tdst.distance = this.distance\n\t\t\t\tdst.center = this.center.slice()\n\t\t\t\tdst.rotation = this.rotation.slice()\n\t\t\t\treturn dst\n\t\t\t},\n\t\t}\n\n\t\t// backup-state at start\n\t\tthis.state_reset = this.state.copy()\n\t\t// backup-state, probably not required\n\t\tthis.state_pushed = this.state.copy()\n\n\t\t// viewport for the mouse-pointer [x,y,w,h]\n\t\tthis.viewport = args.viewport.slice()\n\n\t\t// mouse/touch/key action handler\n\t\tthis.mouse = {\n\t\t\tcam: cam,\n\n\t\t\tcurr: [0, 0, 0],\n\t\t\tprev: [0, 0, 0],\n\t\t\tdist: [0, 0, 0],\n\t\t\tmwheel: 0,\n\n\t\t\tisPressed: false, // true if (istouchdown || ismousedown)\n\t\t\tistouchdown: false, // true, if input came from a touch\n\t\t\tismousedown: false, // true, if input came from a mouse\n\n\t\t\tBUTTON: { LMB: 0x01, MMB: 0x02, RMB: 0x04 },\n\n\t\t\tbutton: 0,\n\n\t\t\tmouseDragLeft: cam.mouseDragRotate.bind(cam),\n\t\t\tmouseDragCenter: cam.mouseDragPan.bind(cam),\n\t\t\tmouseDragRight: cam.mouseDragZoom.bind(cam),\n\t\t\tmouseWheelAction: cam.mouseWheelZoom.bind(cam),\n\n\t\t\ttouchmoveSingle: cam.mouseDragRotate.bind(cam),\n\t\t\ttouchmoveMulti: function () {\n\t\t\t\tcam.mouseDragPan()\n\t\t\t\tcam.mouseDragZoom()\n\t\t\t},\n\n\t\t\tinsideViewport: function (x, y) {\n\t\t\t\tvar x0 = cam.viewport[0],\n\t\t\t\t\tx1 = x0 + cam.viewport[2]\n\t\t\t\tvar y0 = cam.viewport[1],\n\t\t\t\t\ty1 = y0 + cam.viewport[3]\n\t\t\t\treturn x > x0 && x < x1 && y > y0 && y < y1\n\t\t\t},\n\n\t\t\tsolveConstraint: function () {\n\t\t\t\tvar dx = this.dist[0]\n\t\t\t\tvar dy = this.dist[1]\n\n\t\t\t\t// YAW, PITCH\n\t\t\t\tif (this.shiftKey && !cam.SHIFT_CONSTRAINT && Math.abs(dx - dy) > 1) {\n\t\t\t\t\tcam.SHIFT_CONSTRAINT = Math.abs(dx) > Math.abs(dy) ? cam.AXIS.YAW : cam.AXIS.PITCH\n\t\t\t\t}\n\n\t\t\t\t// define constraint by increasing priority\n\t\t\t\tcam.DRAG_CONSTRAINT = cam.AXIS.ALL\n\t\t\t\tif (cam.FIXED_CONSTRAINT) cam.DRAG_CONSTRAINT = cam.FIXED_CONSTRAINT\n\t\t\t\tif (cam.SHIFT_CONSTRAINT) cam.DRAG_CONSTRAINT = cam.SHIFT_CONSTRAINT\n\t\t\t},\n\n\t\t\tupdateInput: function (x, y, z) {\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tvar pd = cam.P5.pixelDensity()\n\n\t\t\t\tmouse.prev[0] = mouse.curr[0]\n\t\t\t\tmouse.prev[1] = mouse.curr[1]\n\t\t\t\tmouse.prev[2] = mouse.curr[2]\n\n\t\t\t\tmouse.curr[0] = x\n\t\t\t\tmouse.curr[1] = y\n\t\t\t\tmouse.curr[2] = z\n\n\t\t\t\tmouse.dist[0] = -(mouse.curr[0] - mouse.prev[0]) / pd\n\t\t\t\tmouse.dist[1] = -(mouse.curr[1] - mouse.prev[1]) / pd\n\t\t\t\tmouse.dist[2] = -(mouse.curr[2] - mouse.prev[2]) / pd\n\t\t\t},\n\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\t\t\t// mouseinput\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\n\t\t\tmousedown: function (event) {\n\t\t\t\tvar mouse = cam.mouse\n\n\t\t\t\tif (event.button === 0) mouse.button |= mouse.BUTTON.LMB\n\t\t\t\tif (event.button === 1) mouse.button |= mouse.BUTTON.MMB\n\t\t\t\tif (event.button === 2) mouse.button |= mouse.BUTTON.RMB\n\n\t\t\t\tif (mouse.insideViewport(event.x, event.y)) {\n\t\t\t\t\tmouse.updateInput(event.x, event.y, event.y)\n\t\t\t\t\tmouse.ismousedown = mouse.button > 0\n\t\t\t\t\tmouse.isPressed = mouse.ismousedown\n\t\t\t\t\tcam.SHIFT_CONSTRAINT = 0\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tmousedrag: function () {\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tif (mouse.ismousedown) {\n\t\t\t\t\tvar x = cam.P5.mouseX\n\t\t\t\t\tvar y = cam.P5.mouseY\n\t\t\t\t\tvar z = y\n\n\t\t\t\t\tmouse.updateInput(x, y, z)\n\t\t\t\t\tmouse.solveConstraint()\n\n\t\t\t\t\tvar LMB = mouse.button & mouse.BUTTON.LMB\n\t\t\t\t\tvar MMB = mouse.button & mouse.BUTTON.MMB\n\t\t\t\t\tvar RMB = mouse.button & mouse.BUTTON.RMB\n\n\t\t\t\t\tif (LMB && mouse.mouseDragLeft) mouse.mouseDragLeft()\n\t\t\t\t\tif (MMB && mouse.mouseDragCenter) mouse.mouseDragCenter()\n\t\t\t\t\tif (RMB && mouse.mouseDragRight) mouse.mouseDragRight()\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tmouseup: function (event) {\n\t\t\t\tvar mouse = cam.mouse\n\n\t\t\t\tif (event.button === 0) mouse.button &= ~mouse.BUTTON.LMB\n\t\t\t\tif (event.button === 1) mouse.button &= ~mouse.BUTTON.MMB\n\t\t\t\tif (event.button === 2) mouse.button &= ~mouse.BUTTON.RMB\n\n\t\t\t\tmouse.ismousedown = mouse.button > 0\n\t\t\t\tmouse.isPressed = mouse.istouchdown || mouse.ismousedown\n\t\t\t\tcam.SHIFT_CONSTRAINT = 0\n\t\t\t},\n\n\t\t\tdblclick: function (event) {\n\t\t\t\tvar x = event.x\n\t\t\t\tvar y = event.y\n\t\t\t\tif (cam.mouse.insideViewport(x, y)) {\n\t\t\t\t\tcam.reset()\n\t\t\t\t}\n\t\t\t},\n\n\t\t\twheel: function (event) {\n\t\t\t\tvar x = event.x\n\t\t\t\tvar y = event.y\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tif (mouse.insideViewport(x, y)) {\n\t\t\t\t\tmouse.mwheel = event.deltaY * 0.01\n\t\t\t\t\tif (mouse.mouseWheelAction) mouse.mouseWheelAction()\n\t\t\t\t}\n\t\t\t},\n\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\t\t\t// touchinput\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\n\t\t\tevaluateTouches: function (event) {\n\t\t\t\tvar touches = event.touches\n\t\t\t\tvar avg_x = 0.0\n\t\t\t\tvar avg_y = 0.0\n\t\t\t\tvar avg_d = 0.0\n\t\t\t\tvar i,\n\t\t\t\t\tdx,\n\t\t\t\t\tdy,\n\t\t\t\t\tcount = touches.length\n\n\t\t\t\t// center, averaged touch position\n\t\t\t\tfor (i = 0; i < count; i++) {\n\t\t\t\t\tavg_x += touches[i].clientX\n\t\t\t\t\tavg_y += touches[i].clientY\n\t\t\t\t}\n\t\t\t\tavg_x /= count\n\t\t\t\tavg_y /= count\n\n\t\t\t\t// offset, mean distance to center\n\t\t\t\tfor (i = 0; i < count; i++) {\n\t\t\t\t\tdx = avg_x - touches[i].clientX\n\t\t\t\t\tdy = avg_y - touches[i].clientY\n\t\t\t\t\tavg_d += Math.sqrt(dx * dx + dy * dy)\n\t\t\t\t}\n\t\t\t\tavg_d /= count\n\n\t\t\t\tcam.mouse.updateInput(avg_x, avg_y, -avg_d)\n\t\t\t},\n\n\t\t\ttouchstart: function (event) {\n\t\t\t\tevent.preventDefault()\n\t\t\t\tevent.stopPropagation()\n\n\t\t\t\tvar mouse = cam.mouse\n\n\t\t\t\tmouse.evaluateTouches(event)\n\t\t\t\tmouse.istouchdown = mouse.insideViewport(mouse.curr[0], mouse.curr[1])\n\t\t\t\tmouse.isPressed = cam.mouse.istouchdown || cam.mouse.ismousedown\n\n\t\t\t\tmouse.dbltap(event)\n\t\t\t},\n\n\t\t\ttouchmove: function (event) {\n\t\t\t\tevent.preventDefault()\n\t\t\t\tevent.stopPropagation()\n\n\t\t\t\tvar mouse = cam.mouse\n\n\t\t\t\tif (mouse.istouchdown) {\n\t\t\t\t\tmouse.evaluateTouches(event)\n\t\t\t\t\tmouse.solveConstraint()\n\n\t\t\t\t\tif (event.touches.length === 1) {\n\t\t\t\t\t\tmouse.touchmoveSingle()\n\t\t\t\t\t} else {\n\t\t\t\t\t\tmouse.touchmoveMulti()\n\t\t\t\t\t\tmouse.tapcount = 0\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\n\t\t\ttouchend: function (event) {\n\t\t\t\tevent.preventDefault()\n\t\t\t\tevent.stopPropagation()\n\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tmouse.istouchdown = false\n\t\t\t\tmouse.isPressed = mouse.istouchdown || mouse.ismousedown\n\t\t\t\tcam.SHIFT_CONSTRAINT = 0\n\n\t\t\t\tif (mouse.tapcount >= 2) {\n\t\t\t\t\tif (mouse.insideViewport(mouse.curr[0], mouse.curr[1])) {\n\t\t\t\t\t\tcam.reset()\n\t\t\t\t\t}\n\t\t\t\t\tmouse.tapcount = 0\n\t\t\t\t}\n\t\t\t},\n\n\t\t\ttapcount: 0,\n\n\t\t\tdbltap: function (event) {\n\t\t\t\tif (cam.mouse.tapcount++ === 0) {\n\t\t\t\t\tsetTimeout(function () {\n\t\t\t\t\t\tcam.mouse.tapcount = 0\n\t\t\t\t\t}, 350)\n\t\t\t\t}\n\t\t\t},\n\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\t\t\t// keyingput\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\n\t\t\t// key-event for shift constraints\n\t\t\tshiftKey: false,\n\n\t\t\tkeydown: function (event) {\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tif (!mouse.shiftKey) {\n\t\t\t\t\tmouse.shiftKey = event.keyCode === 16\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tkeyup: function (event) {\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tif (mouse.shiftKey) {\n\t\t\t\t\tmouse.shiftKey = event.keyCode !== 16\n\t\t\t\t\tif (!mouse.shiftKey) {\n\t\t\t\t\t\tcam.SHIFT_CONSTRAINT = 0\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t}\n\n\t\t// camera mouse listeners\n\t\tthis.attachMouseListeners()\n\n\t\t// P5 registered callbacks, TODO unregister on dispose\n\t\tthis.auto_update = true\n\t\tthis.P5.registerMethod('pre', function () {\n\t\t\tif (cam.auto_update) {\n\t\t\t\tcam.update()\n\t\t\t}\n\t\t})\n\n\t\t// damped camera transition\n\t\tthis.dampedZoom = new DampedAction(function (d) {\n\t\t\tcam.zoom(d * cam.getZoomMult())\n\t\t})\n\t\tthis.dampedPanX = new DampedAction(function (d) {\n\t\t\tcam.panX(d * cam.getPanMult())\n\t\t})\n\t\tthis.dampedPanY = new DampedAction(function (d) {\n\t\t\tcam.panY(d * cam.getPanMult())\n\t\t})\n\t\tthis.dampedPanZ = new DampedAction(function (d) {\n\t\t\tcam.panZ(d * cam.getPanMult())\n\t\t})\n\t\tthis.dampedRotX = new DampedAction(function (d) {\n\t\t\tcam.rotateX(d * cam.getRotationMult())\n\t\t})\n\t\tthis.dampedRotY = new DampedAction(function (d) {\n\t\t\tcam.rotateY(d * cam.getRotationMult())\n\t\t})\n\t\tthis.dampedRotZ = new DampedAction(function (d) {\n\t\t\tcam.rotateZ(d * cam.getRotationMult())\n\t\t})\n\n\t\t// interpolated camera transition\n\t\tthis.timedRot = new Interpolation(cam.setInterpolatedRotation.bind(cam))\n\t\tthis.timedPan = new Interpolation(cam.setInterpolatedCenter.bind(cam))\n\t\tthis.timedzoom = new Interpolation(cam.setInterpolatedDistance.bind(cam))\n\t}\n\n\t/**\n\t * sets the WEBGL renderer the camera is working on\n\t *\n\t * @param {p5.RendererGL} renderer ... p5 WEBGL renderer\n\t */\n\tsetCanvas(renderer) {\n\t\tif (renderer instanceof window.p5.RendererGL) {\n\t\t\t// p5js seems to be not very clear about this\n\t\t\t// ... a bit confusing, so i guess this could change in future releases\n\t\t\tthis.renderer = renderer\n\t\t\tif (renderer._pInst instanceof window.p5) {\n\t\t\t\tthis.graphics = renderer\n\t\t\t} else {\n\t\t\t\tthis.graphics = renderer._pInst\n\t\t\t}\n\t\t\tthis.P5 = this.graphics._pInst\n\t\t} else {\n\t\t\tthis.graphics = undefined\n\t\t\tthis.renderer = undefined\n\t\t}\n\t}\n\n\t/** @return {p5.RendererGL} the currently used renderer */\n\tgetCanvas() {\n\t\treturn this.renderer\n\t}\n\n\tattachListener(el, ev, fx, op) {\n\t\tif (!el || el === fx.el) {\n\t\t\treturn\n\t\t}\n\n\t\tthis.detachListener(fx)\n\n\t\tfx.el = el\n\t\tfx.ev = ev\n\t\tfx.op = op\n\t\tfx.el.addEventListener(fx.ev, fx, fx.op)\n\t}\n\n\tdetachListener(fx) {\n\t\tif (fx.el) {\n\t\t\tfx.el.removeEventListener(fx.ev, fx, fx.op)\n\t\t\tfx.el = undefined\n\t\t}\n\t}\n\n\t/** attaches input-listeners (mouse, touch, key) to the used renderer */\n\tattachMouseListeners(renderer) {\n\t\tvar cam = this.cam\n\t\tvar mouse = cam.mouse\n\n\t\trenderer = renderer || cam.renderer\n\t\tif (renderer) {\n\t\t\tvar op = { passive: false }\n\t\t\tvar el = renderer.elt\n\n\t\t\tcam.attachListener(el, 'mousedown', mouse.mousedown, op)\n\t\t\tcam.attachListener(el, 'mouseup', mouse.mouseup, op)\n\t\t\t// cam.attachListener(el, 'dblclick', mouse.dblclick, op)\n\t\t\tcam.attachListener(el, 'wheel', mouse.wheel, op)\n\t\t\tcam.attachListener(el, 'touchstart', mouse.touchstart, op)\n\t\t\tcam.attachListener(el, 'touchend', mouse.touchend, op)\n\t\t\tcam.attachListener(el, 'touchmove', mouse.touchmove, op)\n\t\t\tcam.attachListener(window, 'keydown', mouse.keydown, op)\n\t\t\tcam.attachListener(window, 'keyup', mouse.keyup, op)\n\t\t}\n\t}\n\n\t/** detaches all attached input-listeners */\n\tremoveMouseListeners() {\n\t\tvar cam = this.cam\n\t\tvar mouse = cam.mouse\n\n\t\tcam.detachListener(mouse.mousedown)\n\t\tcam.detachListener(mouse.mouseup)\n\t\t// cam.detachListener(mouse.dblclick)\n\t\tcam.detachListener(mouse.wheel)\n\t\tcam.detachListener(mouse.keydown)\n\t\tcam.detachListener(mouse.keyup)\n\t\tcam.detachListener(mouse.touchstart)\n\t\tcam.detachListener(mouse.touchend)\n\t\tcam.detachListener(mouse.touchmove)\n\t}\n\n\t/** Disposes/releases the camera. */\n\tdispose() {\n\t\t// // TODO: p5 unregister 'pre', ... not available in 0.5.16\n\t\t// removeMouseListeners();\n\t}\n\n\t/** @return {boolean} the current autoUpdate state */\n\tgetAutoUpdate() {\n\t\treturn this.auto_update\n\t}\n\t/**\n\t * If true, the EasyCam will update automatically in a pre-draw step.\n\t * This updates the camera state and updates the renderers\n\t * modelview/camera matrix.\n\t *\n\t * If false, the update() needs to be called manually.\n\t *\n\t * @param {boolean} the new autoUpdate state\n\t */\n\tsetAutoUpdate(status) {\n\t\tthis.auto_update = status\n\t}\n\n\t/**\n\t * Updates the camera state (interpolated / damped animations) and updates\n\t * the renderers' modelview/camera matrix.\n\t *\n\t * if \"auto_update\" is true, this is called automatically in a pre-draw call.\n\t */\n\tupdate() {\n\t\tvar cam = this.cam\n\t\tvar mouse = cam.mouse\n\n\t\tmouse.mousedrag()\n\n\t\tvar b_update = false\n\t\tb_update |= cam.dampedZoom.update()\n\t\tb_update |= cam.dampedPanX.update()\n\t\tb_update |= cam.dampedPanY.update()\n\t\tb_update |= cam.dampedPanZ.update()\n\t\tb_update |= cam.dampedRotX.update()\n\t\tb_update |= cam.dampedRotY.update()\n\t\tb_update |= cam.dampedRotZ.update()\n\n\t\t// interpolated actions have lower priority then damped actions\n\t\tif (b_update) {\n\t\t\tcam.timedRot.stop()\n\t\t\tcam.timedPan.stop()\n\t\t\tcam.timedzoom.stop()\n\t\t} else {\n\t\t\tcam.timedRot.update()\n\t\t\tcam.timedPan.update()\n\t\t\tcam.timedzoom.update()\n\t\t}\n\n\t\tcam.apply()\n\t}\n\n\t/**\n\t * Applies the current camera state to the renderers' modelview/camera matrix.\n\t * If no argument is given, then the cameras currently set renderer is used.\n\t */\n\tapply(renderer) {\n\t\tvar cam = this.cam\n\t\trenderer = renderer || cam.renderer\n\n\t\tif (renderer) {\n\t\t\tthis.camEYE = this.getPosition(this.camEYE)\n\t\t\tthis.camLAT = this.getCenter(this.camLAT)\n\t\t\tthis.camRUP = this.getUpVector(this.camRUP)\n\n\t\t\tif (undefined === renderer._curCamera)\n\t\t\t\trenderer.camera(\n\t\t\t\t\tthis.camEYE[0],\n\t\t\t\t\tthis.camEYE[1],\n\t\t\t\t\tthis.camEYE[2],\n\t\t\t\t\tthis.camLAT[0],\n\t\t\t\t\tthis.camLAT[1],\n\t\t\t\t\tthis.camLAT[2],\n\t\t\t\t\tthis.camRUP[0],\n\t\t\t\t\tthis.camRUP[1],\n\t\t\t\t\tthis.camRUP[2],\n\t\t\t\t)\n\t\t\telse\n\t\t\t\trenderer._curCamera.camera(\n\t\t\t\t\tthis.camEYE[0],\n\t\t\t\t\tthis.camEYE[1],\n\t\t\t\t\tthis.camEYE[2],\n\t\t\t\t\tthis.camLAT[0],\n\t\t\t\t\tthis.camLAT[1],\n\t\t\t\t\tthis.camLAT[2],\n\t\t\t\t\tthis.camRUP[0],\n\t\t\t\t\tthis.camRUP[1],\n\t\t\t\t\tthis.camRUP[2],\n\t\t\t\t)\n\t\t}\n\t}\n\n\t/** @param {int[]} the new viewport-def, as [x,y,w,h] */\n\tsetViewport(viewport) {\n\t\tthis.viewport = viewport.slice()\n\t}\n\n\t/** @returns {int[]} the current viewport-def, as [x,y,w,h] */\n\tgetViewport() {\n\t\treturn this.viewport\n\t}\n\n\t//\n\t// mouse state changes\n\t//\n\n\t/** implemented zoom-cb for mouswheel handler.*/\n\tmouseWheelZoom() {\n\t\tvar cam = this\n\t\tvar mouse = cam.mouse\n\t\tcam.dampedZoom.addForce(mouse.mwheel * cam.scale_zoomwheel)\n\t}\n\n\t/** implemented zoom-cb for mousedrag/touch handler.*/\n\tmouseDragZoom() {\n\t\tvar cam = this\n\t\tvar mouse = cam.mouse\n\t\tcam.dampedZoom.addForce(-mouse.dist[2])\n\t}\n\n\t/** implemented pan-cb for mousedrag/touch handler.*/\n\tmouseDragPan() {\n\t\tvar cam = this\n\t\tvar mouse = cam.mouse\n\n\t\tcam.dampedPanX.addForce(cam.DRAG_CONSTRAINT & cam.AXIS.YAW ? mouse.dist[0] : 0)\n\t\tcam.dampedPanY.addForce(cam.DRAG_CONSTRAINT & cam.AXIS.PITCH ? mouse.dist[1] : 0)\n\t}\n\n\t/** implemented rotate-cb for mousedrag/touch handler.*/\n\tmouseDragRotate() {\n\t\tvar cam = this\n\t\tvar mouse = cam.mouse\n\n\t\tvar mx = mouse.curr[0],\n\t\t\tmy = mouse.curr[1]\n\t\tvar dx = mouse.dist[0],\n\t\t\tdy = mouse.dist[1]\n\n\t\t// mouse [-1, +1]\n\t\tvar mxNdc = Math.min(Math.max((mx - cam.viewport[0]) / cam.viewport[2], 0), 1) * 2 - 1\n\t\tvar myNdc = Math.min(Math.max((my - cam.viewport[1]) / cam.viewport[3], 0), 1) * 2 - 1\n\n\t\tif (cam.DRAG_CONSTRAINT & cam.AXIS.YAW) {\n\t\t\tcam.dampedRotY.addForce(+dx * (1.0 - myNdc * myNdc))\n\t\t}\n\t\tif (cam.DRAG_CONSTRAINT & cam.AXIS.PITCH) {\n\t\t\tcam.dampedRotX.addForce(-dy * (1.0 - mxNdc * mxNdc))\n\t\t}\n\t\tif (cam.DRAG_CONSTRAINT & cam.AXIS.ROLL) {\n\t\t\tcam.dampedRotZ.addForce(-dx * myNdc)\n\t\t\tcam.dampedRotZ.addForce(+dy * mxNdc)\n\t\t}\n\t}\n\n\t//\n\t// damped multipliers\n\t//\n\t/** (private) returns the used zoom -multiplier for damped actions. */\n\tgetZoomMult() {\n\t\treturn this.state.distance * this.scale_zoom\n\t}\n\t/** (private) returns the used pan-multiplier for damped actions. */\n\tgetPanMult() {\n\t\treturn this.state.distance * this.scale_pan\n\t}\n\t/** (private) returns the used rotate-multiplier for damped actions. */\n\tgetRotationMult() {\n\t\treturn Math.pow(Math.log10(1 + this.state.distance), 0.5) * this.scale_rotation\n\t}\n\n\t//\n\t// damped state changes\n\t//\n\t/** Applies a change to the current zoom.  */\n\tzoom(dz) {\n\t\tvar cam = this.cam\n\t\tvar distance_tmp = cam.state.distance + dz\n\n\t\t// check lower bound\n\t\tif (distance_tmp < cam.distance_min) {\n\t\t\tdistance_tmp = cam.distance_min\n\t\t\tcam.dampedZoom.stop()\n\t\t}\n\n\t\t// check upper bound\n\t\tif (distance_tmp > cam.distance_max) {\n\t\t\tdistance_tmp = cam.distance_max\n\t\t\tcam.dampedZoom.stop()\n\t\t}\n\n\t\tcam.state.distance = distance_tmp\n\t}\n\n\t/** Applies a change to the current pan-xValue.  */\n\tpanX(dx) {\n\t\tvar state = this.cam.state\n\t\tif (dx) {\n\t\t\tvar val = Rotation.applyToVec3(state.rotation, [dx, 0, 0])\n\t\t\tVec3.add(state.center, val, state.center)\n\t\t}\n\t}\n\n\t/** Applies a change to the current pan-yValue.  */\n\tpanY(dy) {\n\t\tvar state = this.cam.state\n\t\tif (dy) {\n\t\t\tvar val = Rotation.applyToVec3(state.rotation, [0, dy, 0])\n\t\t\tVec3.add(state.center, val, state.center)\n\t\t}\n\t}\n\n\tpanZ(dz) {\n\t\tvar state = this.cam.state\n\t\tif (dz) {\n\t\t\tvar val = Rotation.applyToVec3(state.rotation, [0, 0, dz])\n\t\t\tVec3.add(state.center, val, state.center)\n\t\t}\n\t}\n\n\tpanGround(dx, dy, dz) {\n\t\tconst ca = this.centerAxes()\n\t\tVec3.mult(ca.x, dx, ca.x)\n\t\tVec3.mult(ca.z, dz, ca.z)\n\t\tconst val = [0, 0, 0]\n\t\tVec3.add(ca.x, ca.z, val)\n\t\tval[1] = dy\n\t\tVec3.add(this.cam.state.center, val, this.cam.state.center)\n\t}\n\n\tcenterAxes() {\n\t\tconst state = this.cam.state\n\t\t// Get world unit vector for screen-space X axis\n\t\tconst screenX = Rotation.applyToVec3(state.rotation, [1, 0, 0])\n\t\tscreenX[1] = 0 // project X vector onto ground plane\n\t\t// normalize post-projection vector\n\t\tlet mX = Vec3.mag(screenX)\n\t\tif (mX === 0) {\n\t\t\tconsole.warn('[EasyCam] No magnitude for screenX vector', screenX)\n\t\t\tmX = 1\n\t\t}\n\t\tVec3.mult(screenX, 1.0 / mX, screenX)\n\t\t// Get Z vector: cross-product of X with UP (Y)\n\t\tconst screenZ = [0, 0, 0]\n\t\tVec3.cross(screenX, [0, 1, 0], screenZ)\n\t\t// Multiply ground-plane vectors by arguments, apply to camera state\n\t\treturn {\n\t\t\tx: screenX,\n\t\t\ty: [0, 1, 0],\n\t\t\tz: screenZ,\n\t\t}\n\t}\n\n\t/** Applies a change to the current pan-value.  */\n\tpan(dx, dy, dz) {\n\t\tthis.cam.panX(dx)\n\t\tthis.cam.panY(dy)\n\t\tthis.cam.panZ(dz)\n\t}\n\n\t/** Applies a change to the current xRotation.  */\n\trotateX(rx) {\n\t\tthis.cam.rotate([1, 0, 0], rx)\n\t}\n\n\t/** Applies a change to the current yRotation.  */\n\trotateY(ry) {\n\t\tthis.cam.rotate([0, 1, 0], ry)\n\t}\n\n\t/** Applies a change to the current zRotation.  */\n\trotateZ(rz) {\n\t\tthis.cam.rotate([0, 0, 1], rz)\n\t}\n\n\t/** Applies a change to the current rotation, using the given axis/angle.  */\n\trotate(axis, angle) {\n\t\tvar state = this.cam.state\n\t\tif (angle) {\n\t\t\tvar new_rotation = Rotation.create({ axis: axis, angle: angle })\n\t\t\tRotation.applyToRotation(state.rotation, new_rotation, state.rotation)\n\t\t}\n\t}\n\n\t//\n\t// interpolated states\n\t//\n\t/** Sets the new camera-distance, interpolated (t) between given A and B. */\n\tsetInterpolatedDistance(valA, valB, t) {\n\t\tthis.cam.state.distance = Scalar.mix(valA, valB, Scalar.smoothstep(t))\n\t}\n\t/** Sets the new camera-center, interpolated (t) between given A and B. */\n\tsetInterpolatedCenter(valA, valB, t) {\n\t\tthis.cam.state.center = Vec3.mix(valA, valB, Scalar.smoothstep(t))\n\t}\n\t/** Sets the new camera-rotation, interpolated (t) between given A and B. */\n\tsetInterpolatedRotation(valA, valB, t) {\n\t\tthis.cam.state.rotation = Rotation.slerp(valA, valB, t)\n\t}\n\n\t//\n\t// DISTANCE\n\t//\n\t/** Sets the minimum camera distance. */\n\tsetDistanceMin(distance_min) {\n\t\tthis.distance_min = Math.max(distance_min, this.distance_min_limit)\n\t\tthis.zoom(0) // update, to ensure new minimum\n\t}\n\n\t/** Sets the maximum camera distance. */\n\tsetDistanceMax(distance_max) {\n\t\tthis.distance_max = distance_max\n\t\tthis.zoom(0) // update, to ensure new maximum\n\t}\n\n\t/**\n\t * Sets the new camera distance.\n\t *\n\t * @param {double} new distance.\n\t * @param {long} animation time in millis.\n\t */\n\tsetDistance(distance, duration) {\n\t\tthis.timedzoom.start(this.state.distance, distance, duration, [this.dampedZoom])\n\t}\n\n\t/** @returns {double} the current camera distance. */\n\tgetDistance() {\n\t\treturn this.state.distance\n\t}\n\n\t//\n\t// CENTER / LOOK AT\n\t//\n\t/**\n\t * Sets the new camera center.\n\t *\n\t * @param {double[]} new center.\n\t * @param {long} animation time in millis.\n\t */\n\tsetCenter(center, duration) {\n\t\tthis.timedPan.start(this.state.center, center, duration, [this.dampedPanX, this.dampedPanY])\n\t}\n\n\t/** @returns {double[]} the current camera center. */\n\tgetCenter() {\n\t\treturn this.state.center\n\t}\n\n\t//\n\t// ROTATION\n\t//\n\t/**\n\t * Sets the new camera rotation (quaternion).\n\t *\n\t * @param {double[]} new rotation as quat[q0,q1,q2,q3].\n\t * @param {long} animation time in millis.\n\t */\n\tsetRotation(rotation, duration) {\n\t\tthis.timedRot.start(this.state.rotation, rotation, duration, [\n\t\t\tthis.dampedRotX,\n\t\t\tthis.dampedRotY,\n\t\t\tthis.dampedRotZ,\n\t\t])\n\t}\n\n\t/** @returns {double[]} the current camera rotation as quat[q0,q1,q2,q3]. */\n\tgetRotation() {\n\t\treturn this.state.rotation\n\t}\n\n\t//\n\t// CAMERA POSITION/EYE\n\t//\n\t/** @returns {double[]} the current camera position, aka. the eye position. */\n\tgetPosition(dst) {\n\t\tvar cam = this.cam\n\t\tvar state = cam.state\n\n\t\tdst = Vec3.assert(dst)\n\t\tRotation.applyToVec3(state.rotation, cam.LOOK, dst)\n\t\tVec3.mult(dst, state.distance, dst)\n\t\tVec3.add(dst, state.center, dst)\n\n\t\treturn dst\n\t}\n\n\t//\n\t// CAMERA UP\n\t//\n\t/** @returns {double[]} the current camera up vector. */\n\tgetUpVector(dst) {\n\t\tvar cam = this.cam\n\t\tvar state = cam.state\n\t\tdst = Vec3.assert(dst)\n\t\tRotation.applyToVec3(state.rotation, cam.UP, dst)\n\t\treturn dst\n\t}\n\n\t//\n\t// STATE (rotation, center, distance)\n\t//\n\t/** @returns {Object} a copy of the camera state {distance,center,rotation} */\n\tgetState() {\n\t\treturn this.state.copy()\n\t}\n\t/**\n\t * @param {Object} a new camera state {distance,center,rotation}.\n\t * @param {long} animation time in millis.\n\t */\n\tsetState(other, duration) {\n\t\tif (other) {\n\t\t\tthis.setDistance(other.distance, duration)\n\t\t\tthis.setCenter(other.center, duration)\n\t\t\tthis.setRotation(other.rotation, duration)\n\t\t}\n\t}\n\n\tpushState() {\n\t\treturn (this.state_pushed = this.getState())\n\t}\n\tpopState(duration) {\n\t\tthis.setState(this.state_pushed, duration)\n\t}\n\n\t/** sets the current state as reset-state. */\n\tpushResetState() {\n\t\treturn (this.state_reset = this.getState())\n\t}\n\t/** resets the camera, by applying the reset-state. */\n\treset(duration) {\n\t\tthis.setState(this.state_reset, duration)\n\t}\n\n\t/** sets the rotation scale/speed. */\n\tsetRotationScale(scale_rotation) {\n\t\tthis.scale_rotation = scale_rotation\n\t}\n\t/** sets the pan scale/speed. */\n\tsetPanScale(scale_pan) {\n\t\tthis.scale_pan = scale_pan\n\t}\n\t/** sets the zoom scale/speed. */\n\tsetZoomScale(scale_zoom) {\n\t\tthis.scale_zoom = scale_zoom\n\t}\n\t/** sets the wheel scale/speed. */\n\tsetWheelScale(wheelScale) {\n\t\tthis.scale_zoomwheel = wheelScale\n\t}\n\t/** @returns the rotation scale/speed. */\n\tgetRotationScale() {\n\t\treturn this.scale_rotation\n\t}\n\t/** @returns the pan scale/speed. */\n\tgetPanScale() {\n\t\treturn this.scale_pan\n\t}\n\t/** @returns the zoom scale/speed. */\n\tgetZoomScale() {\n\t\treturn this.scale_zoom\n\t}\n\t/** @returns the wheel scale/speed. */\n\tgetWheelScale() {\n\t\treturn this.scale_zoomwheel\n\t}\n\n\t/** sets the default damping scale/speed. */\n\tsetDamping(damping) {\n\t\tthis.dampedZoom.damping = damping\n\t\tthis.dampedPanX.damping = damping\n\t\tthis.dampedPanY.damping = damping\n\t\tthis.dampedPanZ.damping = damping\n\t\tthis.dampedRotX.damping = damping\n\t\tthis.dampedRotY.damping = damping\n\t\tthis.dampedRotZ.damping = damping\n\t}\n\t/** sets the default interpolation time in millis. */\n\tsetDefaultInterpolationTime(duration) {\n\t\tthis.timedRot.default_duration = duration\n\t\tthis.timedPan.default_duration = duration\n\t\tthis.timedzoom.default_duration = duration\n\t}\n\n\t/**\n\t * sets the rotation constraint for each axis separately.\n\t *\n\t * @param {boolean} yaw constraint\n\t * @param {boolean} pitch constraint\n\t * @param {boolean} roll constraint\n\t */\n\tsetRotationConstraint(yaw, pitch, roll) {\n\t\tvar cam = this.cam\n\t\tcam.FIXED_CONSTRAINT = 0\n\t\tcam.FIXED_CONSTRAINT |= yaw ? cam.AXIS.YAW : 0\n\t\tcam.FIXED_CONSTRAINT |= pitch ? cam.AXIS.PITCH : 0\n\t\tcam.FIXED_CONSTRAINT |= roll ? cam.AXIS.ROLL : 0\n\t}\n\n\t/**\n\t *\n\t * begin screen-aligned 2D-drawing.\n\t *\n\t * <pre>\n\t * beginHUD()\n\t *   disabled depth test\n\t *   ortho\n\t *   ... your code is executed here ...\n\t * endHUD()\n\t * </pre>\n\t *\n\t */\n\tbeginHUD(renderer, w, h) {\n\t\tvar cam = this.cam\n\t\trenderer = renderer || cam.renderer\n\n\t\tif (!renderer) return\n\t\tthis.pushed_rendererState = renderer.push()\n\n\t\tvar gl = renderer.drawingContext\n\t\tconst ww = w !== undefined ? w : renderer.width\n\t\tconst hh = h !== undefined ? h : renderer.height\n\t\tvar d = Number.MAX_VALUE\n\n\t\tgl.flush()\n\t\t// gl.finish();\n\n\t\t// 1) disable DEPTH_TEST\n\t\tgl.disable(gl.DEPTH_TEST)\n\t\t// 2) push modelview/projection\n\t\t//    p5 is not creating a push/pop stack\n\t\tthis.pushed_uMVMatrix = renderer.uMVMatrix.copy()\n\t\tthis.pushed_uPMatrix = renderer.uPMatrix.copy()\n\n\t\t// 3) set new modelview (identity)\n\t\trenderer.resetMatrix()\n\t\t// 4) set new projection (ortho)\n\t\trenderer._curCamera.ortho(0, ww, -hh, 0, -d, +d)\n\t\t// renderer.ortho();\n\t\t// renderer.translate(-w/2, -h/2);\n\t}\n\n\t/**\n\t *\n\t * end screen-aligned 2D-drawing.\n\t *\n\t */\n\tendHUD(renderer) {\n\t\tvar cam = this.cam\n\t\trenderer = renderer || cam.renderer\n\n\t\tif (!renderer) return\n\n\t\tvar gl = renderer.drawingContext\n\n\t\tgl.flush()\n\t\t// gl.finish();\n\n\t\t// 2) restore modelview/projection\n\t\trenderer.uMVMatrix.set(this.pushed_uMVMatrix)\n\t\trenderer.uPMatrix.set(this.pushed_uPMatrix)\n\t\t// 1) enable DEPTH_TEST\n\t\tgl.enable(gl.DEPTH_TEST)\n\t\trenderer.pop(this.pushed_rendererState)\n\t}\n}\n\n/**\n * Damped callback, that accepts the resulting damped/smooth value.\n *\n * @callback dampedCallback\n * @param {double} value - the damped/smoothed value\n *\n */\n\n/**\n *\n * DampedAction, for smoothly changing a value to zero.\n *\n * @param {dampedCallback} cb - callback that accepts the damped value as argument.\n */\nclass DampedAction {\n\t/**  @constructor */\n\tconstructor(cb) {\n\t\tthis.value = 0.0\n\t\tthis.damping = 0.85\n\t\tthis.action = cb\n\t}\n\n\t/** adds a value to the current value beeing damped.\n\t * @param {double} force - the value beeing added.\n\t */\n\taddForce(force) {\n\t\tthis.value += force\n\t}\n\n\t/** updates the damping and calls {@link damped-callback}. */\n\tupdate() {\n\t\tvar active = this.value * this.value > 0.000001\n\t\tif (active) {\n\t\t\tthis.action(this.value)\n\t\t\tthis.value *= this.damping\n\t\t} else {\n\t\t\tthis.stop()\n\t\t}\n\t\treturn active\n\t}\n\n\t/** stops the damping. */\n\tstop() {\n\t\tthis.value = 0.0\n\t}\n}\n\n/**\n * Interpolation callback, that implements any form of interpolation between\n * two values A and B and the interpolationparameter t.\n * <pre>\n *   linear: A * (1-t) + B * t\n *   smooth, etc...\n * </pre>\n * @callback interpolationCallback\n * @param {Object} A - First Value\n * @param {Object} B - Second Value\n * @param {double} t - interpolation parameter [0, 1]\n *\n */\n\n/**\n *\n * Interpolation, for smoothly changing a value by interpolating it over time.\n *\n * @param {interpolationCallback} cb - callback for interpolating between two values.\n */\nclass Interpolation {\n\t/**  @constructor */\n\tconstructor(cb) {\n\t\tthis.default_duration = 300\n\t\tthis.action = cb\n\t}\n\n\t/** starts the interpolation.\n\t *  If the given interpolation-duration is 0, then\n\t * {@link interpolation-callback} is called immediately.\n\t */\n\tstart(valA, valB, duration, actions) {\n\t\tfor (var x in actions) {\n\t\t\tactions[x].stop()\n\t\t}\n\t\tthis.valA = valA\n\t\tthis.valB = valB\n\t\tthis.duration = duration === undefined ? this.default_duration : duration\n\t\tthis.timer = new Date().getTime()\n\t\tthis.active = this.duration > 0\n\t\tif (!this.active) {\n\t\t\tthis.interpolate(1)\n\t\t}\n\t}\n\n\t/** updates the interpolation and calls {@link interpolation-callback}.*/\n\tupdate() {\n\t\tif (this.active) {\n\t\t\tvar t = (new Date().getTime() - this.timer) / this.duration\n\t\t\tif (t > 0.995) {\n\t\t\t\tthis.interpolate(1)\n\t\t\t\tthis.stop()\n\t\t\t} else {\n\t\t\t\tthis.interpolate(t)\n\t\t\t}\n\t\t}\n\t}\n\n\tinterpolate(t) {\n\t\tthis.action(this.valA, this.valB, t)\n\t}\n\n\t/** stops the interpolation. */\n\tstop() {\n\t\tthis.active = false\n\t}\n}\n\n////////////////////////////////////////////////////////////////////////////////\n//\n// ROTATION (Quaternion)\n//\n////////////////////////////////////////////////////////////////////////////////\n/**\n * Rotation as Quaternion [q0, q1, q2, q3]\n *\n * Note: Only functions that were required for the EasyCam to work are implemented.\n *\n * @namespace\n */\nvar Rotation = {\n\tassert: function (dst) {\n\t\treturn dst === undefined || dst.constructor !== Array ? [1, 0, 0, 0] : dst\n\t},\n\n\t/** @returns {Number[]} an identity rotation [1,0,0,0] */\n\tidentity: function () {\n\t\treturn [1, 0, 0, 0]\n\t},\n\n\t/**\n\t * Applies the rotation to a vector and returns dst or a new vector.\n\t *\n\t * @param {Number[]} rot - Rotation (Quaternion)\n\t * @param {Number[]} vec - vector to be rotated by rot\n\t * @param {Number[]} dst - resulting vector\n\t * @returns {Number[]} dst- resulting vector\n\t */\n\tapplyToVec3: function (rot, vec, dst) {\n\t\tvar [x, y, z] = vec\n\t\tvar [q0, q1, q2, q3] = rot\n\n\t\tvar s = q1 * x + q2 * y + q3 * z\n\n\t\tdst = Vec3.assert(dst)\n\t\tdst[0] = 2 * (q0 * (x * q0 - (q2 * z - q3 * y)) + s * q1) - x\n\t\tdst[1] = 2 * (q0 * (y * q0 - (q3 * x - q1 * z)) + s * q2) - y\n\t\tdst[2] = 2 * (q0 * (z * q0 - (q1 * y - q2 * x)) + s * q3) - z\n\t\treturn dst\n\t},\n\n\t/**\n\t * Applies the rotation to another rotation and returns dst or a new rotation.\n\t *\n\t * @param {Number[]} rotA - RotationA (Quaternion)\n\t * @param {Number[]} rotB - RotationB (Quaternion)\n\t * @param {Number[]} dst - resulting rotation\n\t * @returns {Number[]} dst - resulting rotation\n\t */\n\tapplyToRotation(rotA, rotB, dst) {\n\t\tvar [a0, a1, a2, a3] = rotA\n\t\tvar [b0, b1, b2, b3] = rotB\n\n\t\tdst = Rotation.assert(dst)\n\t\tdst[0] = b0 * a0 - (b1 * a1 + b2 * a2 + b3 * a3)\n\t\tdst[1] = b1 * a0 + b0 * a1 + (b2 * a3 - b3 * a2)\n\t\tdst[2] = b2 * a0 + b0 * a2 + (b3 * a1 - b1 * a3)\n\t\tdst[3] = b3 * a0 + b0 * a3 + (b1 * a2 - b2 * a1)\n\t\treturn dst\n\t},\n\n\t/**\n\t * Interpolates a rotation.\n\t *\n\t * @param {Number[]} rotA - RotationA (Quaternion)\n\t * @param {Number[]} rotB - RotationB (Quaternion)\n\t * @param {Number  } t - interpolation parameter\n\t * @param {Number[]} dst - resulting rotation\n\t * @returns {Number[]} dst - resulting rotation\n\t */\n\tslerp: function (rotA, rotB, t, dst) {\n\t\tvar [a0, a1, a2, a3] = rotA\n\t\tvar [b0, b1, b2, b3] = rotB\n\n\t\tvar cosTheta = a0 * b0 + a1 * b1 + a2 * b2 + a3 * b3\n\t\tif (cosTheta < 0) {\n\t\t\tb0 = -b0\n\t\t\tb1 = -b1\n\t\t\tb2 = -b2\n\t\t\tb3 = -b3\n\t\t\tcosTheta = -cosTheta\n\t\t}\n\n\t\tvar theta = Math.acos(cosTheta)\n\t\tvar sinTheta = Math.sqrt(1.0 - cosTheta * cosTheta)\n\n\t\tvar w1, w2\n\t\tif (sinTheta > 0.001) {\n\t\t\tw1 = Math.sin((1.0 - t) * theta) / sinTheta\n\t\t\tw2 = Math.sin(t * theta) / sinTheta\n\t\t} else {\n\t\t\tw1 = 1.0 - t\n\t\t\tw2 = t\n\t\t}\n\n\t\tdst = Rotation.assert(dst)\n\t\tdst[0] = w1 * a0 + w2 * b0\n\t\tdst[1] = w1 * a1 + w2 * b1\n\t\tdst[2] = w1 * a2 + w2 * b2\n\t\tdst[3] = w1 * a3 + w2 * b3\n\n\t\treturn Rotation.create({ rotation: dst, normalize: true }, dst)\n\t},\n\n\t/**\n\t * Creates/Initiates a new Rotation\n\t *\n\t * <pre>\n\t *\n\t *    1) Axis,Angle:\n\t *       {\n\t *         axis : [x, y, z],\n\t *         angle: double\n\t *       }\n\t *\n\t *    2) Another Rotation:\n\t *       {\n\t *         rotation : [q0, q1, q2, q3],\n\t *         normalize: boolean\n\t *       }\n\t *\n\t *    3) 3 euler angles, XYZ-order:\n\t *       {\n\t *         angles_xyz : [rX, rY, rZ]\n\t *       }\n\t *\n\t * </pre>\n\t *\n\t *\n\t * @param {Object} def - Definition, for creating the new Rotation\n\t * @param {Number[]} dst - resulting rotation\n\t * @returns {Number[]} dst - resulting rotation\n\t */\n\tcreate: function (def, dst) {\n\t\tdst = Rotation.assert(dst)\n\n\t\t// 1) from axis and angle\n\t\tif (def.axis) {\n\t\t\tvar axis = def.axis\n\t\t\tvar angle = def.angle\n\n\t\t\tvar norm = Vec3.mag(axis)\n\t\t\tif (norm === 0.0) return // vector is of zero length\n\n\t\t\tvar halfAngle = -0.5 * angle\n\t\t\tvar coeff = Math.sin(halfAngle) / norm\n\n\t\t\tdst[0] = Math.cos(halfAngle)\n\t\t\tdst[1] = coeff * axis[0]\n\t\t\tdst[2] = coeff * axis[1]\n\t\t\tdst[3] = coeff * axis[2]\n\t\t\treturn dst\n\t\t}\n\n\t\t// 2) from another rotation\n\t\tif (def.rotation) {\n\t\t\tdst[0] = def.rotation[0]\n\t\t\tdst[1] = def.rotation[1]\n\t\t\tdst[2] = def.rotation[2]\n\t\t\tdst[3] = def.rotation[3]\n\n\t\t\tif (def.normalize) {\n\t\t\t\tvar inv =\n\t\t\t\t\t1.0 / Math.sqrt(dst[0] * dst[0] + dst[1] * dst[1] + dst[2] * dst[2] + dst[3] * dst[3])\n\t\t\t\tdst[0] *= inv\n\t\t\t\tdst[1] *= inv\n\t\t\t\tdst[2] *= inv\n\t\t\t\tdst[3] *= inv\n\t\t\t}\n\n\t\t\treturn dst\n\t\t}\n\n\t\t// 3) from 3 euler angles, order XYZ\n\t\tif (def.angles_xyz) {\n\t\t\tvar ax = -0.5 * def.angles_xyz[0]\n\t\t\tvar ay = -0.5 * def.angles_xyz[1]\n\t\t\tvar az = -0.5 * def.angles_xyz[2]\n\n\t\t\tvar rotX = [Math.cos(ax), Math.sin(ax), 0, 0]\n\t\t\tvar rotY = [Math.cos(ay), 0, Math.sin(ay), 0]\n\t\t\tvar rotZ = [Math.cos(az), 0, 0, Math.sin(az)]\n\n\t\t\tRotation.applyToRotation(rotY, rotZ, dst)\n\t\t\tRotation.applyToRotation(rotX, dst, dst)\n\n\t\t\treturn dst\n\t\t}\n\t},\n\n\t//\n\t// ... to be continued ...\n\t//\n}\n\n////////////////////////////////////////////////////////////////////////////////\n//\n// SCALAR\n//\n////////////////////////////////////////////////////////////////////////////////\n/**\n * Scalar as a simple number.\n *\n * Note: Only functions that were required for the EasyCam to work are implemented.\n *\n * @namespace\n */\nvar Scalar = {\n\t/**\n\t * Linear interpolation between A and B using t[0,1]\n\t */\n\tmix: function (a, b, t) {\n\t\treturn a * (1 - t) + b * t\n\t},\n\n\t/**\n\t * modifying t as a function of smoothstep(0,1,t);\n\t */\n\tsmoothstep: function (x) {\n\t\treturn x * x * (3 - 2 * x)\n\t},\n\n\t/**\n\t * modifying t as a function of smootherstep(0,1,t);\n\t */\n\tsmootherstep: function (x) {\n\t\treturn x * x * x * (x * (x * 6 - 15) + 10)\n\t},\n}\n\n////////////////////////////////////////////////////////////////////////////////\n//\n// VEC3\n//\n////////////////////////////////////////////////////////////////////////////////\n/**\n * Vec3 as a 3D vector (Array)\n *\n * @namespace\n */\nvar Vec3 = {\n\tassert: function (dst) {\n\t\treturn dst === undefined || dst.constructor !== Array ? [0, 0, 0] : dst\n\t},\n\n\tisScalar: function (arg) {\n\t\t// TODO: do some profiling to figure out what fails\n\t\treturn arg !== undefined && arg.constructor !== Array\n\t\t// return typeof(arg) === 'number';\n\t},\n\n\t/** addition: <pre> dst = a + b </pre>  */\n\tadd: function (a, b, dst) {\n\t\tdst = this.assert(dst)\n\t\tif (this.isScalar(b)) {\n\t\t\tdst[0] = a[0] + b\n\t\t\tdst[1] = a[1] + b\n\t\t\tdst[2] = a[2] + b\n\t\t} else {\n\t\t\tdst[0] = a[0] + b[0]\n\t\t\tdst[1] = a[1] + b[1]\n\t\t\tdst[2] = a[2] + b[2]\n\t\t}\n\t\treturn dst\n\t},\n\n\t/** componentwise multiplication: <pre> dst = a * b </pre>  */\n\tmult: function (a, b, dst) {\n\t\tdst = this.assert(dst)\n\t\tif (this.isScalar(b)) {\n\t\t\tdst[0] = a[0] * b\n\t\t\tdst[1] = a[1] * b\n\t\t\tdst[2] = a[2] * b\n\t\t} else {\n\t\t\tdst[0] = a[0] * b[0]\n\t\t\tdst[1] = a[1] * b[1]\n\t\t\tdst[2] = a[2] * b[2]\n\t\t}\n\t\treturn dst\n\t},\n\n\t/** squared length  */\n\tmagSq: function (a) {\n\t\treturn a[0] * a[0] + a[1] * a[1] + a[2] * a[2]\n\t},\n\n\t/** length  */\n\tmag: function (a) {\n\t\treturn Math.sqrt(a[0] * a[0] + a[1] * a[1] + a[2] * a[2])\n\t},\n\n\t/** dot-product  */\n\tdot: function (a, b) {\n\t\treturn a[0] * b[0] + a[1] * b[1] + a[2] * b[2]\n\t},\n\n\t/** cross-product  */\n\tcross: function (a, b, dst) {\n\t\tdst = this.assert(dst)\n\t\tdst[0] = a[1] * b[2] - a[2] * b[1]\n\t\tdst[1] = a[2] * b[0] - a[0] * b[2]\n\t\tdst[2] = a[0] * b[1] - a[1] * b[0]\n\t\treturn dst\n\t},\n\n\t/** angle  */\n\tangle: function (v1, v2) {\n\t\tvar normProduct = this.mag(v1) * this.mag(v2)\n\t\tif (normProduct === 0.0) {\n\t\t\treturn 0.0 // at least one vector is of zero length\n\t\t}\n\n\t\tvar dot = this.dot(v1, v2)\n\t\tvar threshold = normProduct * 0.9999\n\t\tif (dot < -threshold || dot > threshold) {\n\t\t\t// the vectors are almost aligned, compute using the sine\n\t\t\tvar v3 = this.cross(v1, v2)\n\t\t\tif (dot >= 0) {\n\t\t\t\treturn Math.asin(this.mag(v3) / normProduct)\n\t\t\t} else {\n\t\t\t\treturn Math.PI - Math.asin(this.mag(v3) / normProduct)\n\t\t\t}\n\t\t}\n\n\t\t// the vectors are sufficiently separated to use the cosine\n\t\treturn Math.acos(dot / normProduct)\n\t},\n\n\t/** linear interpolation: <pre> dst = a * (1 - t) + b * t </pre> */\n\tmix(a, b, t, dst) {\n\t\tdst = this.assert(dst)\n\t\tdst[0] = Scalar.mix(a[0], b[0], t)\n\t\tdst[1] = Scalar.mix(a[1], b[1], t)\n\t\tdst[2] = Scalar.mix(a[2], b[2], t)\n\t\treturn dst\n\t},\n\n\t//\n\t// ... to be continued ...\n\t//\n}\n\n////////////////////////////////////////////////////////////////////////////////\n//\n// public objects\n//\n////////////////////////////////////////////////////////////////////////////////\n\n/**\n * @static\n */\nEasyCam.INFO = INFO // make static\nObject.freeze(INFO) // and constant\n\n// ext = (ext !== undefined) ? ext : {};\n\n/**\n * @memberof Dw\n */\next.EasyCam = EasyCam\n/**\n * @memberof Dw\n */\next.DampedAction = DampedAction\n/**\n * @memberof Dw\n */\next.Interpolation = Interpolation\n/**\n * @memberof Dw\n */\next.Rotation = Rotation\n/**\n * @memberof Dw\n */\next.Vec3 = Vec3\n/**\n * @memberof Dw\n */\next.Scalar = Scalar\n\n// return ext;\n//\n//\n// })(Dw);\n\n// export const { DampedAction, Interpolation, Rotation, Vec3, Scalar } = ext\nexport default ext\n\n// /**\n//  * @submodule Camera\n//  * @for p5\n//  */\n//\n// if(p5){\n//\n//\n//   /**\n//    * p5.EasyCam creator function.\n//    * Arguments are optional, and equal to the default EasyCam constructor.\n//    * @return {EasyCam} a new EasyCam\n//    */\n//   p5.prototype.createEasyCam = function(/* p5.RendererGL, {state} */){\n//\n//     var renderer = this._renderer;\n//     var args     = arguments[0];\n//\n//     if(arguments[0] instanceof p5.RendererGL){\n//       renderer = arguments[0];\n//       args     = arguments[1]; // could still be undefined, which is fine\n//     }\n//\n//     return new Dw.EasyCam(renderer, args);\n//   }\n// }\n","import * as p5 from 'p5'\nimport Sketch from './Sketch'\nimport { clockUpdateReq, ClockOpts } from './serverApi/serverClock'\n\nconst userInputsY = 40\n\nexport class SketchInputs {\n\tparent: Sketch\n\tpp?: p5\n\tnameCustomized = false\n\tinputs: {\n\t\t// DOM input elements\n\t\tname?: any\n\t\tinstrument?: any\n\t\tinputDevice?: any\n\t\toffset?: any\n\t\tbpm?: any\n\t\thide?: any\n\t} = {}\n\thidden = false\n\tclockOpts: ClockOpts = {\n\t\tbpm: 95,\n\t}\n\n\tconstructor(parent: Sketch) {\n\t\tthis.parent = parent\n\t}\n\n\tbpm = () => (this.inputs.bpm ? this.inputs.bpm.value() : this.clockOpts.bpm)\n\n\tisFocused = () => {\n\t\tfor (const key in this.inputs) {\n\t\t\tconst input = (this.inputs as any)[key]\n\t\t\tif (input && input.focused) {\n\t\t\t\treturn true\n\t\t\t}\n\t\t}\n\t\treturn false\n\t}\n\n\ttoggleHide = () => {\n\t\tif (!this.pp) {\n\t\t\treturn\n\t\t}\n\t\tthis.hidden = !this.hidden\n\t\tthis.setup(this.pp)\n\t\tif (!this.hidden) {\n\t\t\tthis.setupInputsBPM()\n\t\t}\n\t}\n\n\tsetup = (pp: p5) => {\n\t\tthis.pp = pp\n\t\tif (this.hidden) {\n\t\t\tfor (const key in this.inputs) {\n\t\t\t\tconst input = (this.inputs as any)[key]\n\t\t\t\tif (!input) {\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\t\t\t\tinput.remove()\n\t\t\t\tdelete (this.inputs as any)[key]\n\t\t\t}\n\t\t\tthis.setupInputsHide(this.pp)\n\t\t\treturn\n\t\t}\n\t\tthis.setupInputsUser(this.parent.ws.clientId)\n\t\tthis.setupInputsInstrument()\n\t\tif (!this.inputs.inputDevice) {\n\t\t\tthis.setupInputsMidi(this.parent.midi.webMidi)\n\t\t}\n\t\tthis.setupInputsHide(pp)\n\t}\n\n\tsetupInputsHide = (pp: p5) => {\n\t\tif (this.inputs.hide) {\n\t\t\tthis.inputs.hide.remove()\n\t\t}\n\t\tconst inHide = pp.createButton(this.hidden ? 'Show Settings' : 'Hide Settings') as any\n\t\tinHide.position(pp.width - inHide.width - 50, pp.height - inHide.height - 10)\n\t\tinHide.mousePressed(this.toggleHide)\n\t\tthis.inputs.hide = inHide\n\t}\n\n\tsetupInputsUser = (clientId: number): any => {\n\t\tconsole.log('[SketchInputs #setupInputsUser] clientId', clientId)\n\t\tconst uu = this.parent.user\n\t\tconst defaultName = this.nameCustomized ? uu.name : `User ${this.parent.ws.clientId}`\n\t\tif (this.hidden) {\n\t\t\tif (uu.name === '') {\n\t\t\t\tthis.parent.updateUser({ name: defaultName })\n\t\t\t}\n\t\t\treturn\n\t\t}\n\t\tif (!this.pp) {\n\t\t\tconsole.warn(\n\t\t\t\t'[SketchInputs #setupInputsUser] Attempted to setup user input before sketch was initialized',\n\t\t\t)\n\t\t\treturn\n\t\t}\n\t\tif (this.inputs.name && this.nameCustomized) {\n\t\t\t// Don't re-create the input if the user has already customized their name\n\t\t\treturn\n\t\t}\n\t\tif (this.inputs.name) {\n\t\t\tthis.inputs.name.remove()\n\t\t}\n\t\tif (this.inputs.offset) {\n\t\t\tthis.inputs.offset.remove()\n\t\t}\n\t\tconst inName = this.pp.createInput(defaultName) as any\n\t\tinName.size(80)\n\t\tinName.position(20, userInputsY)\n\t\tinName.input(() => {\n\t\t\tconsole.log('[SketchInputs #inputs.name] Changed:', inName.value())\n\t\t\tthis.nameCustomized = true\n\t\t\tthis.parent.updateUser({ name: inName.value() })\n\t\t})\n\t\tinName.elt.onfocus = () => (inName.focused = true)\n\t\tinName.elt.onblur = () => (inName.focused = false)\n\t\tinName.elt.focus()\n\t\tinName.elt.select()\n\t\tthis.inputs.name = inName\n\t\tthis.parent.updateUser({ name: inName.value() }, false)\n\n\t\tconst inOffset = this.pp.createInput(`${this.parent.user.offset}`) as any\n\t\tinOffset.size(50)\n\t\tinOffset.position(inName.x + inName.width + 10, userInputsY)\n\t\tconst setOffset = () => {\n\t\t\tconst off = parseFloat(inOffset.value())\n\t\t\tif (!Number.isNaN(off)) {\n\t\t\t\tthis.parent.updateUser({ offset: off })\n\t\t\t}\n\t\t}\n\t\tinOffset.input(() => {\n\t\t\tconsole.log('[SketchInputs #inputs.offset] Changed:', inOffset.value())\n\t\t\tsetOffset()\n\t\t})\n\t\tinOffset.elt.onfocus = () => (inOffset.focused = true)\n\t\tinOffset.elt.onblur = () => (inOffset.focused = false)\n\t\tthis.inputs.offset = inOffset\n\t\tsetOffset()\n\t}\n\n\tsetupInputsInstrument = () => {\n\t\tif (!this.pp || !this.inputs.offset || this.hidden) {\n\t\t\treturn\n\t\t}\n\t\tif (this.inputs.instrument) {\n\t\t\tthis.inputs.instrument.remove()\n\t\t}\n\t\tconst inInst = this.pp.createSelect() as any\n\t\tinInst.position(this.inputs.offset.x + this.inputs.offset.width + 10, userInputsY)\n\t\tconst uinst = this.parent.user.instrument\n\t\tinInst.size(130)\n\t\tfor (const instName in this.parent.instruments) {\n\t\t\tinInst.option(instName)\n\t\t\tif (instName === uinst) {\n\t\t\t\tinInst.selected(instName)\n\t\t\t}\n\t\t}\n\t\tinInst.changed(() => {\n\t\t\tconsole.log('[SketchInputs #inputs.instrument] Changed:', inInst.value())\n\t\t\tthis.parent.updateUser({ instrument: inInst.value() })\n\t\t})\n\t\tinInst.elt.onfocus = () => (inInst.focused = true)\n\t\tinInst.elt.onblur = () => (inInst.focused = false)\n\t\tthis.inputs.instrument = inInst\n\t\tthis.parent.updateUser({ instrument: inInst.value() }, false)\n\t}\n\n\tsetupInputsMidi = (webMidi: any) => {\n\t\tif (!this.pp || !this.inputs.instrument || this.hidden) {\n\t\t\treturn\n\t\t}\n\t\tif (this.inputs.inputDevice) {\n\t\t\tthis.inputs.inputDevice.remove()\n\t\t}\n\t\tconst { inputs } = webMidi || { inputs: [] }\n\t\tconst inMidi = this.pp.createSelect() as any\n\t\tconst inInst = this.inputs.instrument\n\t\tinMidi.position(inInst.x + inInst.width + 10, userInputsY)\n\t\tinMidi.option('keyboard')\n\t\tfor (const input of inputs) {\n\t\t\tconst { _midiInput } = input\n\t\t\tif (!_midiInput) {\n\t\t\t\tconsole.error('[SketchInputs #setupInputsMidi] Received a midi input with missing data')\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tinMidi.option(_midiInput.name)\n\t\t}\n\t\tinMidi.selected(this.parent.user.inputDevice)\n\t\tinMidi.changed(() => {\n\t\t\tconsole.log('[SketchInputs #setupInputsMidi] Changed:', inMidi.value())\n\t\t\tthis.parent.updateUser({ inputDevice: inMidi.value() })\n\t\t})\n\t\tinMidi.elt.onfocus = () => (inMidi.focused = true)\n\t\tinMidi.elt.onblur = () => (inMidi.focused = false)\n\t\tthis.inputs.inputDevice = inMidi\n\t\tthis.parent.updateUser({ inputDevice: inMidi.value() }, false)\n\t}\n\n\tsetupInputsBPM = () => {\n\t\tif (!this.pp || this.hidden) {\n\t\t\treturn\n\t\t}\n\t\tif (this.inputs.bpm) {\n\t\t\tthis.inputs.bpm.remove()\n\t\t}\n\t\tconst inBPM = this.pp.createSlider(30, 200, this.clockOpts.bpm) as any\n\t\tinBPM.position(20, this.pp.height - 40)\n\t\tinBPM.size(this.pp.width / 2)\n\t\tinBPM.input(() => {\n\t\t\t// console.log('[SketchInputs #setupInputsBPM] Changed:', inBPM.value())\n\t\t\tthis.clockOpts.bpm = inBPM.value()\n\t\t\tthis.sendClockUpdate(this.clockOpts)\n\t\t})\n\t\tinBPM.elt.onfocus = () => (inBPM.focused = true)\n\t\tinBPM.elt.onblur = () => (inBPM.focused = false)\n\t\tthis.inputs.bpm = inBPM\n\t}\n\n\tdraw = (pp: p5) => {\n\t\tpp.textSize(12)\n\t\tpp.fill(255)\n\t\tpp.strokeWeight(1)\n\t\tpp.stroke(0)\n\t\tpp.textAlign(pp.LEFT, pp.BOTTOM)\n\t\tpp.textStyle(pp.BOLD)\n\t\tfor (const key in this.inputs) {\n\t\t\tif (key === 'hide') {\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tconst input = (this.inputs as any)[key]\n\t\t\tif (!input) {\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tconst xx = input.x + 3\n\t\t\tconst yy = input.y - 5\n\t\t\tswitch (true) {\n\t\t\t\tcase key === 'offset':\n\t\t\t\t\tconst off = parseFloat(input.value())\n\t\t\t\t\tlet msg = ``\n\t\t\t\t\tif (Number.isNaN(off)) {\n\t\t\t\t\t\t// Show the user that they have an invalid value\n\t\t\t\t\t\tpp.fill(255, 0, 0)\n\t\t\t\t\t\tmsg = ` (NaN!)`\n\t\t\t\t\t}\n\t\t\t\t\tpp.text(`${key.toUpperCase()}${msg}${'\\n'}(in beats)`, xx, yy)\n\t\t\t\t\tif (Number.isNaN(off)) {\n\t\t\t\t\t\t// put fill color back\n\t\t\t\t\t\tpp.fill(255)\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\tcase key in this.parent.user:\n\t\t\t\t\tpp.text(key.toUpperCase(), xx, yy)\n\t\t\t\t\tbreak\n\t\t\t\tdefault:\n\t\t\t\t\tpp.text(`${key.toUpperCase()}: ${input.value()}`, xx, yy)\n\t\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t}\n\n\tsendClockUpdate = (clk: ClockOpts) => {\n\t\tconst { conn, ready } = this.parent.ws\n\t\tif (!ready()) {\n\t\t\tconsole.warn(\n\t\t\t\t\"[SketchInputs #sendClockUpdate] Can't send bpm update, websocket connection is not open\",\n\t\t\t)\n\t\t\treturn\n\t\t}\n\t\tconn.send(clockUpdateReq(clk))\n\t}\n\n\tonClockUpdate = (clk: ClockOpts) => {\n\t\tthis.clockOpts = clk\n\t\tif (!this.inputs.bpm) {\n\t\t\treturn\n\t\t}\n\t\tthis.inputs.bpm.value(clk.bpm)\n\t}\n}\n","import AudioKeys from 'audiokeys'\nimport Sketch from './Sketch'\nimport { MidiEvent } from './MIDI'\n\ntype AudioKeysEvent = {\n\t// the midi number of the note\n\tnote: number\n\t// the keyCode of the key being pressed down\n\tkeyCode: number\n\t// the frequency of the note\n\tfrequency: number\n\t// on note down: the current velocity (this can only be set when rows = 1)\n\t// on note up: 0\n\tvelocity: number\n}\n\nexport class SketchAudioKeys {\n\tparent: Sketch\n\taudioKeys: AudioKeys\n\n\tconstructor(parent: Sketch) {\n\t\tthis.parent = parent\n\t\tthis.audioKeys = new AudioKeys({ polyphony: Infinity })\n\t\tthis.audioKeys.down(this.keyPressed)\n\t\tthis.audioKeys.up(this.keyReleased)\n\t}\n\n\tkeyPressed = (evt: AudioKeysEvent) => {\n\t\tconst { note, velocity } = evt\n\t\tif (this.parent.keyboardInputDisabled()) {\n\t\t\treturn\n\t\t}\n\t\tif (this.parent.user.inputDevice !== 'keyboard') {\n\t\t\treturn\n\t\t}\n\t\tconst midiEvt = { kind: 'noteon', note: note, attack: velocity / 128.0 } as MidiEvent\n\t\tthis.parent.sendUserEvent('keyboard', 'noteon', midiEvt)\n\t}\n\n\tkeyReleased = (evt: AudioKeysEvent) => {\n\t\tconst { note } = evt\n\t\tif (this.parent.keyboardInputDisabled()) {\n\t\t\treturn\n\t\t}\n\t\tif (this.parent.user.inputDevice !== 'keyboard') {\n\t\t\treturn\n\t\t}\n\t\tconst midiEvt = { kind: 'noteoff', note: note } as MidiEvent\n\t\tthis.parent.sendUserEvent('keyboard', 'noteoff', midiEvt)\n\t}\n}\n","import * as p5 from 'p5'\nimport * as Tone from 'tone'\nimport WSClient, { DONT_REOPEN } from './serverApi/WSClient'\nimport {\n\tuserEventReq,\n\tuserUpdateReq,\n\tuserXformReq,\n\tUser,\n\tUserEvent,\n\tUserForce,\n\tUserXform,\n} from './serverApi/serverApi'\nimport MIDI, { MidiEvent, MidiEventCC, MidiEventNote, MidiEventPitchbend } from './MIDI'\nimport { Instrument } from './Instrument'\nimport { EightOhEight, Metronome, Piano, PolySynth } from './instruments'\nimport VisualNotes from './VisualNotes'\nimport { EasyCam } from 'vendor/p5.easycam.js'\nimport { engine3d, Avatar, Ground, Vec } from 'engine3d'\nimport { SketchInputs } from './SketchInputs'\nimport { SketchAudioKeys } from './SketchAudioKeys'\n\ntype Instruments = { [key: string]: Instrument }\n\nconst worldScale = 1000\nconst newAvatarPos = () => {\n\tconst rr = () => Math.random() * 1.8 - 0.9\n\treturn new Vec(rr() * worldScale, 100, rr() * worldScale)\n}\n\nexport default class Sketch {\n\twidth: number = 0\n\theight: number = 0\n\tvisualNotes: VisualNotes = new VisualNotes()\n\tstarted: boolean = false\n\tsyncing: boolean = true\n\tinstruments: Instruments\n\tws: WSClient\n\tmidi: MIDI\n\taudioKeys: SketchAudioKeys\n\tpp?: p5\n\tpg?: p5.Graphics\n\tcam?: EasyCam\n\tuser: User = {\n\t\tclientId: 0,\n\t\tname: '',\n\t\tinstrument: 'synth',\n\t\tinputDevice: 'keyboard',\n\t\toffset: 2,\n\t}\n\tavatar: Avatar\n\tusers: User[] = []\n\tavatars: Avatar[] = []\n\tinputs: SketchInputs\n\tground = new Ground({ pos: new Vec(0, -1, 0), scale: new Vec(worldScale) })\n\tengine3d = engine3d\n\tbgCol = {\n\t\thue: 0.5,\n\t\tsat: 0,\n\t\tlgt: 0.2,\n\t}\n\n\tconstructor(_global: any) {\n\t\tconsole.log('[Sketch #ctor]')\n\t\tthis.inputs = new SketchInputs(this)\n\t\tthis.ws = new WSClient(window, {\n\t\t\tclock: {\n\t\t\t\tonSynced: () => {\n\t\t\t\t\tthis.syncing = false\n\t\t\t\t\tthis.inputs.setupInputsBPM()\n\t\t\t\t},\n\t\t\t},\n\t\t\tonClientId: (clientId: number) => {\n\t\t\t\tthis.user.clientId = clientId\n\t\t\t\tthis.inputs.setupInputsUser(clientId)\n\t\t\t\tthis.sendUserXform(this.avatar.getUserXform())\n\t\t\t},\n\t\t\tonClockUpdate: this.inputs.onClockUpdate,\n\t\t\tonUsers: this.onUsers,\n\t\t\tonUserEvent: this.onUserEvent,\n\t\t\tonUserForce: this.onUserForce,\n\t\t\tonUserXform: this.onUserXform,\n\t\t})\n\t\tthis.instruments = {\n\t\t\tsynth: new PolySynth(),\n\t\t\teightOhEight: new EightOhEight(this),\n\t\t\tpiano: new Piano(),\n\t\t\tmetronome: new Metronome(this),\n\t\t}\n\t\tthis.midi = new MIDI({\n\t\t\tonEnabled: this.inputs.setupInputsMidi,\n\t\t\tonMessage: this.sendUserEvent,\n\t\t})\n\t\tthis.audioKeys = new SketchAudioKeys(this)\n\t\tthis.avatar = new Avatar({\n\t\t\tuser: this.user,\n\t\t\tpos: newAvatarPos(),\n\t\t\tscale: new Vec(40),\n\t\t\tphys: { worldScale },\n\t\t\tonForce: this.sendUserXform,\n\t\t})\n\t\t// Tone.Destination.chain(\n\t\t// \tnew Tone.Reverb({ decay: 4, wet: 0.6 }),\n\t\t// )\n\t\twindow.Tone = Tone\n\t\twindow.me = this\n\t}\n\n\tdestroy = () => {\n\t\tthis.ws.conn.close(DONT_REOPEN, 'sketch destroyed')\n\t}\n\n\ttimeGlobalToTone = (globalTime: number) => {\n\t\tconst rawCtx = Tone.context.rawContext as any\n\t\tconst { contextTime, performanceTime } = rawCtx._nativeAudioContext.getOutputTimestamp()\n\t\tconst lt = this.ws.clock.toLocal(globalTime)\n\t\tconst delta = lt - performanceTime\n\t\tconst toneTime = contextTime + delta / 1000\n\t\treturn toneTime\n\t}\n\n\ttimeToneToGlobal = (toneTime: number) => {\n\t\tconst rawCtx = Tone.context.rawContext as any\n\t\tconst { contextTime, performanceTime } = rawCtx._nativeAudioContext.getOutputTimestamp()\n\t\tconst delta = toneTime - contextTime\n\t\tconst pt = performanceTime + delta * 1000\n\t\tconst globalTime = this.ws.clock.toGlobal(pt)\n\t\treturn globalTime\n\t}\n\n\tsetSize = (width: number, height: number) => {\n\t\tthis.width = width\n\t\tthis.height = height\n\t}\n\n\tsketch = (pp: p5) => {\n\t\tthis.pp = pp\n\t\tpp.setup = () => this.setup(pp)\n\t\tpp.draw = () => this.draw(pp)\n\t\tpp.mousePressed = () => this.mousePressed(pp)\n\t\tpp.keyPressed = () => this.keyPressed(pp)\n\t\tpp.keyReleased = () => this.keyReleased(pp)\n\t}\n\n\tsetup = (pp: p5) => {\n\t\tconsole.log(`[Sketch #setup] ${this.width} x ${this.height}`)\n\t\tpp.createCanvas(this.width, this.height)\n\t\tthis.pg = pp.createGraphics(this.width, this.height, 'webgl')\n\t\tthis.cam = new EasyCam((this.pg as any)._renderer, { distance: 600 })\n\t\tthis.cam.setDistanceMin(1)\n\t\tthis.cam.setDistanceMax(1000)\n\t\tthis.cam.attachMouseListeners((pp as any)._renderer)\n\t\tthis.cam.setViewport([0, 0, this.width, this.height])\n\t\tthis.cam.rotateY(Math.PI)\n\t\tthis.cam.rotateZ(Math.PI)\n\t\t;(this.cam.state as any).center[2] = 40\n\t\tthis.avatar.addFollowCam(this.cam)\n\t\tthis.inputs.setup(pp)\n\t}\n\n\tdraw = (pp: p5) => {\n\t\tengine3d.update()\n\t\tlet loading = false\n\t\tfor (const instName in this.instruments) {\n\t\t\tif (!this.instruments[instName].loaded()) {\n\t\t\t\tloading = true\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t\tpp.colorMode(pp.HSL, 1)\n\t\tpp.background(this.bgCol.hue, this.bgCol.sat, this.bgCol.lgt)\n\t\tpp.colorMode(pp.RGB, 255)\n\t\tif (this.pg) {\n\t\t\t// Draw notes to separate graphics canvas\n\t\t\tthis.visualNotes.draw(pp, this.pg)\n\t\t\tengine3d.draw(this.pg)\n\t\t\tpp.image(this.pg, 0, 0)\n\t\t\tengine3d.draw2D(pp, this.pg)\n\t\t}\n\t\tthis.inputs.draw(pp)\n\t\tif (loading) {\n\t\t\tthis.drawMessage(pp, 'Loading instruments...')\n\t\t} else if (this.syncing) {\n\t\t\tthis.drawMessage(pp, 'Syncing clock with server...')\n\t\t} else if (!this.started) {\n\t\t\tthis.drawMessage(pp, 'Click to enable audio')\n\t\t}\n\t}\n\n\tdrawMessage = (pp: p5, msg: string) => {\n\t\tpp.fill(200)\n\t\tpp.strokeWeight(0)\n\t\tpp.textSize(20)\n\t\tpp.textAlign(pp.CENTER, pp.CENTER)\n\t\tpp.textStyle(pp.BOLDITALIC)\n\t\tpp.text(msg, pp.width / 2, pp.height / 2)\n\t}\n\n\tmousePressed = (pp: p5) => {\n\t\tif (this.started) {\n\t\t\treturn\n\t\t}\n\t\tthis.started = true\n\t\tTone.start()\n\t\tconsole.log('[Sketch #mousePressed] Started Tone')\n\t}\n\n\tkeyboardInputDisabled = () => {\n\t\treturn this.inputs.isFocused() // Ignore keyboard if inputs are focused\n\t}\n\tkeyPressed = (evt: p5) => {\n\t\tif (!this.keyboardInputDisabled()) {\n\t\t\tthis.avatar.keyPressed(evt)\n\t\t}\n\t}\n\tkeyReleased = (evt: p5) => {\n\t\tif (!this.keyboardInputDisabled()) {\n\t\t\tthis.avatar.keyReleased(evt)\n\t\t}\n\t}\n\n\tupdateUser = (uu: Partial<User>, sendUpdate: boolean = true) => {\n\t\tthis.user = Object.assign(this.user, uu)\n\t\tif (sendUpdate) {\n\t\t\tthis.sendUserUpdate()\n\t\t}\n\t}\n\n\t// getUser returns the user matching clientId,\n\t// or this.user if no matching user is found\n\tgetUser = (clientId: number): User => {\n\t\tif (clientId === this.user.clientId) {\n\t\t\treturn this.user\n\t\t}\n\t\tfor (const uu of this.users) {\n\t\t\tif (clientId === uu.clientId) {\n\t\t\t\treturn uu\n\t\t\t}\n\t\t}\n\t\treturn this.user\n\t}\n\n\tgetAvatar = (clientId: number): Avatar | null => {\n\t\tif (clientId === this.user.clientId) {\n\t\t\treturn this.avatar\n\t\t}\n\t\tfor (const aa of this.avatars) {\n\t\t\tif (clientId === aa.user.clientId) {\n\t\t\t\treturn aa\n\t\t\t}\n\t\t}\n\t\treturn null\n\t}\n\tgetAvatarSafe = (clientId: number): Avatar => {\n\t\tconst aa = this.getAvatar(clientId)\n\t\tif (!aa) {\n\t\t\treturn this.avatar\n\t\t}\n\t\treturn aa\n\t}\n\n\tsendUserUpdate = () => {\n\t\tconst { conn, ready } = this.ws\n\t\tif (!ready()) {\n\t\t\tconsole.warn(\"[Sketch #sendUserUpdate] Can't send user update, websocket connection is not open\")\n\t\t\treturn\n\t\t}\n\t\tconn.send(userUpdateReq(this.user))\n\t}\n\n\tsendUserXform = (data: UserXform) => {\n\t\tconst { conn, ready } = this.ws\n\t\tif (!ready()) {\n\t\t\tconsole.warn(\"[Sketch #sendUserXform] Can't send user xform, websocket connection is not open\")\n\t\t\treturn\n\t\t}\n\t\tconn.send(userXformReq(data))\n\t}\n\n\tsendUserEvent = (inputName: string, _eventName: string, evt: MidiEvent) => {\n\t\tlet instName = this.user.instrument\n\t\tif (evt.controller) {\n\t\t\t// Hardcode some CC events to control instrument volumes\n\t\t\tswitch (evt.controller.number) {\n\t\t\t\tcase 79: // master volume (local only)\n\t\t\t\t\tTone.Destination.volume.value = (evt.value - 1) * 50\n\t\t\t\t// fallthrough\n\t\t\t\tcase 19: // master mute (local only)\n\t\t\t\t\tTone.Destination.mute = !evt.value\n\t\t\t\t\treturn\n\t\t\t\tcase 18:\n\t\t\t\tcase 78:\n\t\t\t\t\tinstName = 'metronome'\n\t\t\t\t\tbreak\n\t\t\t\tcase 17:\n\t\t\t\tcase 77:\n\t\t\t\t\tinstName = 'synth'\n\t\t\t\t\tbreak\n\t\t\t\tcase 16:\n\t\t\t\tcase 76:\n\t\t\t\t\tinstName = 'eightOhEight'\n\t\t\t\t\tbreak\n\t\t\t\tcase 15:\n\t\t\t\tcase 75:\n\t\t\t\t\tinstName = 'piano'\n\t\t\t\t\tbreak\n\t\t\t\tdefault:\n\t\t\t\t\t// Commented out for easier deving -- MIDI input always enabled\n\t\t\t\t\t// if (inputName !== this.user.inputDevice) {\n\t\t\t\t\t// \treturn // not a whitelisted CC and not the active device, so don't send\n\t\t\t\t\t// }\n\t\t\t\t\tbreak\n\t\t\t}\n\t\t\t// Commented out for easier deving -- MIDI input always enabled\n\t\t\t// } else {\n\t\t\t// \tif (inputName !== this.user.inputDevice) {\n\t\t\t// \t\treturn\n\t\t\t// \t}\n\t\t}\n\t\tconst uevt = {\n\t\t\tclientId: this.user.clientId,\n\t\t\tinstrument: instName,\n\t\t\tmidiEvent: evt,\n\t\t\ttimestamp: this.ws.now() + this.offsetMs(),\n\t\t}\n\t\tconst { conn, ready } = this.ws\n\t\tif (!ready()) {\n\t\t\t// websocket connection isn't ready, handle event locally\n\t\t\tthis.onUserEvent(uevt)\n\t\t\treturn\n\t\t}\n\t\tconn.send(userEventReq(uevt))\n\t}\n\n\tonUsers = (users: User[]) => {\n\t\tfor (const user of users) {\n\t\t\tif (user.clientId === this.user.clientId) {\n\t\t\t\tcontinue // skip local user\n\t\t\t}\n\t\t\tconst prevs = this.users.filter(uu => uu.clientId === user.clientId)\n\t\t\tif (!prevs.length) {\n\t\t\t\tthis.users.push(user)\n\t\t\t\tthis.avatars.push(\n\t\t\t\t\tnew Avatar({\n\t\t\t\t\t\tuser: user,\n\t\t\t\t\t\tpos: newAvatarPos(),\n\t\t\t\t\t\tscale: new Vec(20),\n\t\t\t\t\t\tphys: { worldScale },\n\t\t\t\t\t}),\n\t\t\t\t)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tif (prevs.length > 1) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`[Sketch #onUsers] Found more than one user for clientId #${user.clientId}`,\n\t\t\t\t\tuser.clientId,\n\t\t\t\t\tuser.name,\n\t\t\t\t)\n\t\t\t}\n\t\t\t// Update pre-existing user\n\t\t\tconst prev = prevs[0]\n\t\t\tObject.assign(prev, user)\n\t\t}\n\t\tfor (const user of this.users) {\n\t\t\tif (users.some(uu => uu.clientId === user.clientId)) {\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\t// user dropped, remove user and its avatar\n\t\t\tconst aa = this.getAvatar(user.clientId)\n\t\t\tif (aa) {\n\t\t\t\tengine3d.rmObj(aa)\n\t\t\t} else {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`[Sketch #onUsers] Unable to find avatar for dropped user #${user.clientId}`,\n\t\t\t\t\tuser.name,\n\t\t\t\t)\n\t\t\t}\n\t\t\tthis.users = this.users.filter(uu => uu.clientId !== user.clientId)\n\t\t\tthis.avatars = this.avatars.filter(aa => aa.user.clientId !== user.clientId)\n\t\t}\n\t}\n\n\tonUserForce = (evt: UserForce) => {\n\t\tconst { clientId } = evt\n\t\tconst avatar = this.getAvatar(clientId)\n\t\tif (!avatar) {\n\t\t\tconsole.warn('[Sketch #onUserForce] No avatar for user', clientId)\n\t\t\treturn\n\t\t}\n\t\tavatar.setUserForce(evt)\n\t}\n\n\tonUserXform = (evt: UserXform) => {\n\t\tconst { clientId } = evt\n\t\tconst avatar = this.getAvatar(clientId)\n\t\tif (!avatar) {\n\t\t\tconsole.warn('[Sketch #onUserXform] No avatar for user', clientId)\n\t\t\treturn\n\t\t}\n\t\tavatar.setUserXform(evt)\n\t}\n\n\tonUserEvent = (evt: UserEvent) => {\n\t\tconst { clientId, instrument, midiEvent, timestamp } = evt\n\t\tconst { data, channel, kind } = midiEvent\n\t\tconst inst = this.instruments[instrument]\n\t\tif (!inst) {\n\t\t\tconsole.error('[Sketch #onUserEvent] Unable to find instrument', instrument)\n\t\t\treturn\n\t\t}\n\t\tif (!inst.loaded()) {\n\t\t\treturn // don't send events if instrument hasn't finished loading\n\t\t}\n\t\tconst tt = this.timeGlobalToTone(timestamp)\n\t\tif (tt - Tone.immediate() < -1) {\n\t\t\tconsole.warn(`[Sketch #onUserEvent] Received event ${tt - Tone.immediate()} seconds late`)\n\t\t\treturn\n\t\t}\n\t\tconst avatar = this.getAvatarSafe(clientId)\n\t\tswitch (kind) {\n\t\t\tcase 'noteon': {\n\t\t\t\tconst nn = midiEvent as MidiEventNote\n\t\t\t\tinst.noteon(avatar, tt, nn)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase 'noteoff': {\n\t\t\t\tconst nn = midiEvent as MidiEventNote\n\t\t\t\tinst.noteoff(avatar, tt, nn)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase 'controlchange': {\n\t\t\t\tconst cc = midiEvent as MidiEventCC\n\t\t\t\tinst.controlchange(avatar, tt, cc)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase 'pitchbend': {\n\t\t\t\tconst pb = midiEvent as MidiEventPitchbend\n\t\t\t\tinst.pitchbend(avatar, tt, pb)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tdefault:\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`[Sketch #onUserEvent] Unhandled MIDI event on channel ${channel}:`,\n\t\t\t\t\tkind,\n\t\t\t\t\tdata,\n\t\t\t\t\tevt,\n\t\t\t\t)\n\t\t\t\tbreak\n\t\t}\n\t}\n\n\toffsetMs = () => {\n\t\tconst bps = this.inputs.bpm() / 60\n\t\tif (!bps) {\n\t\t\treturn 0\n\t\t}\n\t\tconst beatMs = 1000.0 / bps\n\t\treturn beatMs * this.user.offset\n\t}\n}\n","import React, { useEffect, useRef } from 'react'\nimport Sketch from './Sketch'\n\nconst VideoOutput: React.FC = () => {\n\tconst ref = useRef<HTMLDivElement>(null)\n\tconst sk = useRef<Sketch>(new Sketch(window))\n\tconst msg = useRef<string>(`Loading`)\n\tuseEffect(() => {\n\t\tif (!ref.current) {\n\t\t\tmsg.current = `Internal component error`\n\t\t\tconsole.warn(`[VideoOutput #useEffect] Can't find component reference`)\n\t\t\treturn\n\t\t}\n\t\tconst elem = ref.current as HTMLDivElement\n\t\tif (elem.childNodes[0]) {\n\t\t\telem.removeChild(elem.childNodes[0]) // remove previous sketch\n\t\t}\n\t\tconst { clientWidth, clientHeight } = elem\n\t\tconst skObj = sk.current\n\t\tskObj.setSize(clientWidth, clientHeight)\n\t\tconst sketch = new window.p5(skObj.sketch, elem)\n\t\treturn () => {\n\t\t\tskObj.destroy()\n\t\t\tsketch.remove()\n\t\t\tconsole.log('[VideoOutput #useEffect.return]')\n\t\t}\n\t})\n\treturn (\n\t\t<div\n\t\t\tref={ref}\n\t\t\tstyle={{\n\t\t\t\tdisplay: 'flex',\n\t\t\t\tflex: 1,\n\t\t\t\talignItems: 'center',\n\t\t\t\tjustifyContent: 'center',\n\t\t\t\tcolor: 'white',\n\t\t\t}}\n\t\t>\n\t\t\t{msg.current}\n\t\t</div>\n\t)\n}\n\nexport default VideoOutput\n","import React from 'react'\nimport VideoOutput from './VideoOutput'\n\nimport './App.css'\n\nconst App: React.FC = () => {\n\treturn (\n\t\t<div\n\t\t\tclassName='App'\n\t\t\tstyle={{\n\t\t\t\tdisplay: 'flex',\n\t\t\t\tflexDirection: 'column',\n\t\t\t\tposition: 'absolute',\n\t\t\t\tbackgroundColor: '#383838',\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0,\n\t\t\t\tright: 0,\n\t\t\t\tbottom: 0,\n\t\t\t}}\n\t\t>\n\t\t\t<VideoOutput />\n\t\t</div>\n\t)\n}\n\nexport default App\n"],"sourceRoot":""}