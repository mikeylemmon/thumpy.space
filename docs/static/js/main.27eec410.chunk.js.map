{"version":3,"sources":["app/serverApi/serverApi.ts","app/serverApi/serverClock.ts","app/serverApi/WSClock.ts","index.tsx","app/serverApi/WSClient.ts","app/MIDI.ts","app/Instrument.ts","app/instruments/util.ts","engine3d/core/Vec.ts","engine3d/core/Bounds.ts","engine3d/core/Xform.ts","engine3d/core/Component.ts","engine3d/core/engine3d.ts","engine3d/core/Obj.ts","engine3d/components/Physical.ts","engine3d/components/FollowCam.ts","engine3d/objs/DancerObj.ts","engine3d/objs/Avatar.ts","app/instruments/BlackHole.ts","app/instruments/Dancer.ts","app/instruments/Sampler.ts","app/instruments/EightOhEight.ts","app/instruments/Metronome.ts","app/instruments/Piano.ts","app/instruments/PolySynth.ts","vendor/p5.easycam.js","app/SketchInputs.ts","app/SketchAudioKeys.ts","app/constants.ts","app/Loop.ts","app/Loops.ts","engine3d/objs/BlackHoleObj.ts","app/Sketch.ts","app/VideoOutput.tsx","app/App.tsx"],"names":["WS_URL","WS_HEADER_END","WS_CLIENT_ID","parseClientId","body","JSON","parse","clientId","WS_USERS_ALL","WS_USER_EVENT","WS_USER_FORCE","WS_USER_XFORM","WS_USER_REQUEST_XFORMS","parseUsersAll","parseUserEvent","parseUserForce","parseUserXform","userUpdateReq","req","stringify","userEventReq","userXformReq","userRequestXformsReq","WS_CLOCK_NOW","WS_CLOCK_ORIGIN","WS_CLOCK_UPDATE","NOTE_METRONOME_BPM_CHANGED","NOTE_METRONOME_DOWN","clockNowReq","clockUpdateReq","clk","parseClockUpdate","WSClock","global","conn","options","localOrigin","correction","precision","correction2","precision2","lowpass","lastReqAt","lastRespAt","loopId","syncInitial","serverOrigin","precisionNow","pingMs","syncPeriod","synced","update","readyState","WebSocket","OPEN","nowRaw","send","clearTimeout","destroy","this","performance","timeOrigin","setInterval","now","originMs","console","error","nowMs","dur","delta","deltaNow","onSynced","nn","c2gain","perfTime","globalTime","App","require","default","ReactDOM","render","document","getElementById","WSClient","clock","users","reopen","CLOSED","newConn","ready","onclose","evt","code","warn","setTimeout","onopen","log","onerror","onmessage","onMessage","parts","str","sep","out","sepRe","RegExp","prevIndex","lastIndex","re","exec","push","slice","index","split","data","head","onClockOrigin","onClockNow","clkOpts","onClockUpdate","onClientId","filter","uu","onUsers","uevt","onUserEvent","onUserForce","onUserXform","onUserRequestXforms","getUser","newMidiEvent","channel","target","number","kind","type","attack","note","_number","release","value","controller","allChannels","Array","keys","map","x","allEvents","MIDI","opts","webMidi","enabled","enable","a","onEnabled","window","WebMidi","inputs","outputs","input","eventName","addListener","name","channels","Instrument","_avatar","_time","_evt","noteFreq","Tone","toFrequency","Vec","w","clone","y","z","cloneMult","val","applyMult","cloneAdd","applyAdd","cloneSub","applySub","isZero","isOne","isEqual","other","normalize","mag","toArray","setFromArray","vals","length","cloneMultMat","mat","dest","Math","abs","Number","EPSILON","p5","Vector","Bounds","min","max","cloneXform","xform","applyXform","applyTo","sanitize","tmp","pushInside","off","centerAndSize","center","size","Xform","pos","rot","scale","vec","Component","parent","drawDebug","_dt","engine3d","objs","debug","lastUpdate","addObj","obj","unshift","rmObj","oo","Date","valueOf","dt","forEach","draw","pg","drawShadow","draw2D","pp","gg","mvp","_renderer","uMVMatrix","copy","mult","uPMatrix","mat4","Obj","children","comps","drawFunc","drawShadowFunc","drawFunc2D","cc","rm","rmChild","addChild","getChildren","objType","getChild","addComp","comp","rmComp","getComps","compType","getComp","applyXformToGraphics","translate","rotateZ","rotateY","rotateX","pop","ndcPos","ndcPos2","ndcPos3","ndcPos4","ndc","width","height","scale2d","gravity","Physical","force","vel","bounds","world","magSq","worldBounds","noFill","stroke","strokeWeight","box","worldScale","FollowCam","cam","last","state","setCenter","defaultEnvOpts","attackCurve","sustain","releaseCurve","DanceMoves","dip","stepLeft","stepRight","spinLeft","spinRight","headbang","arms","l","upper","lower","r","sizes","leg","stepLeftRight","rotHead","PI","rotArms","noteEnvMap","0","1","2","3","4","5","6","7","8","9","10","11","noteEvent","time","move","triggerAttack","triggerRelease","armUpper","armLower","neck","defaultArmsRot","DancerObj","moves","fill","sphere","drawHead","drawArm","left","noStroke","circle","Avatar","phys","user","followCam","onForce","dancer","up","down","right","jump","jumpInitial","gain","instrument","offset","ss","sss","textAlign","CENTER","BOTTOM","textSize","textStyle","BOLD","text","ITALIC","addFollowCam","getUserXform","setUserXform","setUserForce","keyPressed","keyChanged","keyReleased","pressed","key","keysUpdated","mov","ca","centerAxes","cax","caz","ff","atan2","srand","random","BHObj","inst","createdAt","noteEvt","scaleOrig","voice","hue","mass","twist","mod","modwheel","origin2D","scale2D","sketch","shaderBlackHole","setUniform","BlackHole","synth","freqNode","freq","noiseGain","noise","reverb","panVol","ps","psSpread","decay","maxObjs","ii","noteon","avatar","exponentialRampToValueAtTime","schedule","addBHObj","noteoff","controlchange","num","delayed","vv","set","playbackRate","updatePitchbend","pan","envelope","mute","volume","pitchbend","detune","lastPos","blackHole","objSize","apos","ascale","theta","sin","cos","toDestination","wet","connect","frequency","Q","delay","delayTime","feedback","addend","start","Dancer","lr","Sampler","sampler","pitchShift","pitch","loaded","samps","EightOhEight","urls","baseUrl","eightOhEight","modNote","bgCol","sat","Metronome","metronome","pianoSamps","A0","C1","A1","C2","A2","C3","A3","C4","A4","C5","A5","C6","A6","C7","A7","C8","Piano","SynthObj","polySynth","lgt","envValLast","colorMode","HSL","RGB","PolySynth","filterVol","setFilterGain","db","addSynthObj","_activeVoices","released","midi","rampTo","oscillator","count","spread","ext","INFO","LIBRARY","VERSION","AUTHOR","SOURCE","toString","EasyCam","renderer","args","RendererGL","undefined","distance","rotation","Rotation","identity","viewport","setCanvas","LOOK","UP","AXIS","YAW","PITCH","ROLL","ALL","SHIFT_CONSTRAINT","FIXED_CONSTRAINT","DRAG_CONSTRAINT","scale_rotation","scale_pan","scale_zoom","scale_zoomwheel","distance_min_limit","distance_min","distance_max","MAX_VALUE","dst","state_reset","state_pushed","mouse","curr","prev","dist","mwheel","isPressed","istouchdown","ismousedown","BUTTON","LMB","MMB","RMB","button","mouseDragLeft","mouseDragRotate","bind","mouseDragCenter","mouseDragPan","mouseDragRight","mouseDragZoom","mouseWheelAction","mouseWheelZoom","touchmoveSingle","touchmoveMulti","insideViewport","x0","x1","y0","y1","solveConstraint","dx","dy","shiftKey","updateInput","pd","P5","pixelDensity","mousedown","event","mousedrag","mouseX","mouseY","mouseup","dblclick","reset","wheel","deltaY","evaluateTouches","i","touches","avg_x","avg_y","avg_d","clientX","clientY","sqrt","touchstart","preventDefault","stopPropagation","dbltap","touchmove","tapcount","touchend","keydown","keyCode","keyup","attachMouseListeners","auto_update","registerMethod","dampedZoom","DampedAction","d","zoom","getZoomMult","dampedPanX","panX","getPanMult","dampedPanY","panY","dampedPanZ","panZ","dampedRotX","getRotationMult","dampedRotY","dampedRotZ","timedRot","Interpolation","setInterpolatedRotation","timedPan","setInterpolatedCenter","timedzoom","setInterpolatedDistance","_pInst","graphics","el","ev","fx","op","detachListener","addEventListener","removeEventListener","passive","elt","attachListener","status","b_update","stop","apply","camEYE","getPosition","camLAT","getCenter","camRUP","getUpVector","_curCamera","camera","addForce","mx","my","mxNdc","myNdc","pow","log10","dz","distance_tmp","applyToVec3","Vec3","add","screenX","mX","screenZ","cross","rx","rotate","ry","rz","axis","angle","new_rotation","create","applyToRotation","valA","valB","t","Scalar","mix","smoothstep","slerp","duration","assert","setDistance","setRotation","getState","setState","wheelScale","damping","default_duration","yaw","roll","h","pushed_rendererState","gl","drawingContext","ww","hh","flush","disable","DEPTH_TEST","pushed_uMVMatrix","pushed_uPMatrix","resetMatrix","ortho","cb","action","active","actions","timer","getTime","interpolate","constructor","q0","q1","q2","q3","s","rotA","rotB","a0","a1","a2","a3","b0","b1","b2","b3","cosTheta","w1","w2","acos","sinTheta","def","norm","halfAngle","coeff","inv","angles_xyz","ax","ay","az","rotX","rotY","rotZ","b","smootherstep","isScalar","arg","dot","v1","v2","normProduct","threshold","v3","asin","Object","freeze","msToString","ms","toFixed","SketchInputs","loadedFromStorage","nameCustomized","hidden","clockOpts","bpm","help","helpRetoggle","loops","dial","helpImg","isFocused","focused","toggleHide","setup","setupInputsBPM","loadImage","remove","setupInputsHide","setupInputsUser","ws","setupInputsInstrument","inputDevice","setupInputsMidi","hide","hideLoops","hideDial","showHelp","createButton","xx","yy","position","mousePressed","hiddenDial","toggleHideDial","toggleHideText","toggleHideDialText","innerHTML","defaultName","updateUser","inName","createInput","onfocus","onblur","inOffset","setOffset","parseFloat","isNaN","updateRecOffset","inInst","createSelect","uinst","instName","instruments","option","selected","changed","inMidi","_midiInput","inBPM","createSlider","sendClockUpdate","drawHelp","LEFT","msg","toUpperCase","prec","ping","xp","RIGHT","haspect","hx","hy","background","image","SketchAudioKeys","audioKeys","customs","customToCtrl","velocity","keyboardInputDisabled","midiEvt","sendUserEvent","keyPressedP5","handleCustom","prop","increase","_state","keyReleasedP5","AudioKeys","polyphony","Infinity","BLACK_KEYS","Loop","id","evts","headPlay","headRec","isActive","isDial","isRecording","isMuted","pgControls","pgNotes","needsRenderControls","needsRenderNotes","save","beats","localStorage","setItem","load","dataStr","getItem","removeItem","setRadius","rad","radius","loopLenMs","beatMs","loopUserEvent","recOff","offsetMs","loopTime","timeGlobalToLoopNorm","levt","midiEvent","attacks","filterNote","attackEvents","attackEvt","minDiff","relTime","ae","diff","sanitizeEvents","ee","updateClientId","le","releaseEvents","controlEvents","sortByLoopTime","sort","aa","bb","groupByController","resp","ctrl","clearAllEvents","play","rec","headRecPrev","lt","timestamp","_sendUserEvent","timeLoopNormToGlobal","after","recStartedAt","isDown","isFirst","drawLine","drawEvents","arcPlay","ceil","arcRec","recFillAlpha","drawArc","drawControls","drawNotes","createGraphics","radBig","tmpx","tmpy","renderControls","renderNotes","_drawNotes","lx","ly","line","fromTime","from","arc","clear","cevts","seedrandom","quick","len","nextEvtIdx","nextTime","unreleasedOnly","modNotes","includes","timeGlobalToLoop","tt","downbeat","floor","timeLoopToGlobal","timeLastLoopStartMs","hitTest","uuid","Loops","activeLoop","recLock","saveLoopRefs","store","ll","lidsStr","defaultParams","aid","lids","lid","loop","didSetup","loopLen","newLoopBtn","setupInputs","TOP","btnHalfwidth","offsetWidth","othersTop","offsetHeight","inactiveLoops","keyIsDown","NORMAL","addLoop","dialBeats","recOffset","clearAll","clearActiveLoop","toggleActiveLoopMute","al","stopRecording","didHit","BlackHoleObj","backbuffer","shader","resetShader","newAvatarPos","rr","started","syncing","avatars","transportStarted","_bpm","_bpmNext","loadFromStorage","ustr","close","timeGlobalToTone","rawContext","_nativeAudioContext","getOutputTimestamp","contextTime","performanceTime","toLocal","timeToneToGlobal","toneTime","pt","toGlobal","setSize","preload","loadShader","createCanvas","textureWrap","REPEAT","n","bbsize","clz32","WEBGL","setDistanceMin","setDistanceMax","setViewport","loading","perspective","drawMessage","BOLDITALIC","sendUpdate","assign","sendUserUpdate","getAvatar","getAvatarSafe","sendUserXform","sendUserRequestXforms","inputName","_eventName","isMetronome","onMetronome","pb","setNewDownbeat","prevs","some","bps","beatSec","offsetSec","didLoad","piano","me","VideoOutput","ref","useRef","useEffect","current","elem","childNodes","removeChild","clientWidth","clientHeight","canvas","style","display","flex","alignItems","justifyContent","color","className","flexDirection","backgroundColor","top","bottom"],"mappings":"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","file":"static/js/main.27eec410.chunk.js","sourcesContent":["import { MidiEvent } from '../MIDI'\n\n// export const WS_URL = 'ws://localhost:38883'\nexport const WS_URL = 'wss://mikeylemmon.com/api'\nexport const WS_HEADER_END = '#'\n\n//\n// Client API\n//\nexport const WS_CLIENT_ID = 'client/id'\nexport type ClientIdResp = { clientId: number }\n\nexport function parseClientId(body: string): number {\n\tconst resp: ClientIdResp = JSON.parse(body)\n\treturn resp.clientId\n}\n\n//\n// Users API\n//\nexport const WS_USERS_ALL = 'user/all'\nexport const WS_USER_UPDATE = 'user/update'\nexport const WS_USER_EVENT = 'user/event'\nexport const WS_USER_FORCE = 'user/force'\nexport const WS_USER_XFORM = 'user/xform'\nexport const WS_USER_REQUEST_XFORMS = 'user/request_xforms'\n\nexport type User = {\n\tclientId: number\n\tname: string\n\tinstrument: string\n\tinputDevice: string\n\toffset: number\n}\n\nexport type UserEvent = {\n\tclientId: number\n\tinstrument: string\n\tmidiEvent: MidiEvent\n\ttimestamp: number\n}\n\nexport type UserForce = {\n\tclientId: number\n\tforce: number[]\n}\n\nexport type UserXform = {\n\tclientId: number\n\tpos: number[]\n\trot: number[]\n\tscale: number[]\n\tforce: number[]\n\tvel: number[]\n}\n\nexport function parseUsersAll(body: string): User[] {\n\tconst resp: User[] = JSON.parse(body)\n\treturn resp\n}\nexport function parseUserEvent(body: string): UserEvent {\n\tconst resp: UserEvent = JSON.parse(body)\n\treturn resp\n}\nexport function parseUserForce(body: string): UserForce {\n\tconst resp: UserForce = JSON.parse(body)\n\treturn resp\n}\nexport function parseUserXform(body: string): UserXform {\n\tconst resp: UserXform = JSON.parse(body)\n\treturn resp\n}\n\nexport function userUpdateReq(req: User): string {\n\treturn WS_USER_UPDATE + WS_HEADER_END + JSON.stringify(req)\n}\nexport function userEventReq(req: UserEvent): string {\n\treturn WS_USER_EVENT + WS_HEADER_END + JSON.stringify(req)\n}\nexport function userForceReq(req: UserForce): string {\n\treturn WS_USER_FORCE + WS_HEADER_END + JSON.stringify(req)\n}\nexport function userXformReq(req: UserXform): string {\n\treturn WS_USER_XFORM + WS_HEADER_END + JSON.stringify(req)\n}\nexport function userRequestXformsReq(): string {\n\treturn WS_USER_REQUEST_XFORMS + WS_HEADER_END\n}\n","import { WS_HEADER_END } from './serverApi'\n\nexport const WS_CLOCK_NOW = 'clock/now'\nexport const WS_CLOCK_ORIGIN = 'clock/origin'\nexport const WS_CLOCK_UPDATE = 'clock/update'\nexport const NOTE_METRONOME_BPM_CHANGED = 32\nexport const NOTE_METRONOME_DOWN = 34\nexport const NOTE_METRONOME_UP = 35\n\nexport type ClockNowResp = { nowMs: number }\nexport type ClockOriginResp = { originMs: number }\nexport type ClockOpts = {\n\tbpm: number\n\tclientId?: number\n}\n\nexport const clockNowReq = () => WS_CLOCK_NOW + WS_HEADER_END\nexport const clockUpdateReq = (clk: ClockOpts) => WS_CLOCK_UPDATE + WS_HEADER_END + JSON.stringify(clk)\n\nexport function parseClockUpdate(body: string): ClockOpts {\n\tconst resp: ClockOpts = JSON.parse(body)\n\treturn resp\n}\n","import { clockNowReq, ClockNowResp, ClockOriginResp } from './serverClock'\n\nconst SYNC_PERIOD_INITIAL_MS = 500,\n\tSYNC_INITIAL_NUM = 6, // number of times to use initial period\n\tSYNC_PERIOD_MS = 2000\n\nexport type WSClockOptions = {\n\tonSynced: () => void\n}\n\nexport default class WSClock {\n\tglobal: any\n\tconn: WebSocket\n\tlocalOrigin: number\n\tcorrection = 0 // a correction to apply to the local clock based on rolling-average deviation from server clock\n\tprecision = 0 // average of how accurate the workerClock is with correction applied\n\tcorrection2 = 0 // a derivative correction that accounts for linear clock deviation (i.e. local clock is X slower/faster than server)\n\tprecision2 = 0 // measures how accurate the workerClock is with correction and correction2 applied\n\tlowpass = 0.3 // how much latest sample affects correction/precision\n\tlastReqAt = 0\n\tlastRespAt = 0\n\tloopId = -1\n\tsyncInitial = 0\n\tserverOrigin = 0\n\tprecisionNow = 0\n\tpingMs = 0\n\tsyncPeriod = SYNC_PERIOD_INITIAL_MS\n\tsynced = false\n\toptions: Partial<WSClockOptions>\n\n\tconstructor(global: any, conn: WebSocket, options: Partial<WSClockOptions> = {}) {\n\t\tthis.global = global\n\t\tthis.options = options\n\t\t// this.localOrigin = global.performance.timing.navigationStart\n\t\tthis.localOrigin = global.performance.timeOrigin\n\t\tthis.conn = conn\n\t\tthis.loopId = global.setInterval(this.update, this.syncPeriod)\n\t}\n\n\tnowRaw() {\n\t\treturn global.performance.now()\n\t}\n\n\tupdate = () => {\n\t\tif (this.conn.readyState !== WebSocket.OPEN) {\n\t\t\tthis.global.clearTimeout(this.loopId)\n\t\t\treturn\n\t\t}\n\t\tthis.lastReqAt = this.nowRaw()\n\t\tthis.conn.send(clockNowReq())\n\t}\n\n\tdestroy = () => {\n\t\tthis.global.clearTimeout(this.loopId)\n\t}\n\n\tonClockOrigin(body: string) {\n\t\tconst resp: ClockOriginResp = JSON.parse(body)\n\t\tconst { originMs } = resp\n\t\tif (!originMs) {\n\t\t\tconsole.error('[workerClock #onClockOrigin] Received empty response')\n\t\t\treturn\n\t\t}\n\t\tthis.serverOrigin = originMs\n\t}\n\n\tonClockNow(body: string) {\n\t\tconst resp: ClockNowResp = JSON.parse(body)\n\t\tconst { nowMs } = resp || {}\n\t\tif (!nowMs) {\n\t\t\tconsole.error('[workerClock #onClockNow] Received empty response')\n\t\t\treturn\n\t\t}\n\t\tthis.lastRespAt = this.nowRaw()\n\t\tconst dur = this.lastRespAt - this.lastReqAt\n\t\tthis.pingMs = dur\n\t\tconst mid = dur / 2 + this.lastReqAt\n\t\tconst delta = nowMs - mid\n\t\tif (this.correction === 0) {\n\t\t\tthis.correction = delta\n\t\t} else {\n\t\t\tthis.correction = delta * this.lowpass + this.correction * (1 - this.lowpass)\n\t\t}\n\t\tconst precision = delta - this.correction\n\t\tif (this.precision === 0) {\n\t\t\tthis.precision = precision\n\t\t} else {\n\t\t\tthis.precision = precision * this.lowpass + this.precision * (1 - this.lowpass)\n\t\t}\n\t\t// Calculate a secondary correction based on the average value of precision to account\n\t\t// for the local clock being consistently slower/faster than the server clock\n\t\tthis.correction2 = this.precision * this.lowpass + this.correction2 * (1 - this.lowpass)\n\t\tconst precision2 = delta - this.correction - this.correction2\n\t\tif (this.precision2 === 0) {\n\t\t\tthis.precision2 = precision2\n\t\t} else {\n\t\t\tthis.precision2 = precision2 * this.lowpass + this.precision2 * (1 - this.lowpass)\n\t\t}\n\n\t\t// Calculate precision metrics for corrected \"now\" time\n\t\tconst now = this.now() - dur / 2\n\t\tconst deltaNow = now - nowMs\n\t\tthis.precisionNow = deltaNow * this.lowpass + this.precisionNow * (1 - this.lowpass)\n\n\t\t// console.log(\n\t\t// \t'[workerClock #onClockNow]',\n\t\t// \t{\n\t\t// \t\tp: this.precision,\n\t\t// \t\tp2: this.precision2,\n\t\t// \t\tc: this.correction,\n\t\t// \t\tc2: this.correction2,\n\t\t// \t},\n\t\t// \t{\n\t\t// \t\tlastP: precision,\n\t\t// \t\tlastP2: precision2,\n\t\t// \t\tdur,\n\t\t// \t},\n\t\t// \t{\n\t\t// \t\tnow: now,\n\t\t// \t\tnowMs: nowMs,\n\t\t// \t\td: deltaNow,\n\t\t// \t\tpnow: this.precisionNow,\n\t\t// \t},\n\t\t// \t{\n\t\t// \t\tnowOverP: this.precisionNow / this.precision2,\n\t\t// \t},\n\t\t// )\n\n\t\tif (!this.synced && this.syncInitial++ > SYNC_INITIAL_NUM) {\n\t\t\t// Replace sync loop with lower-frequency interval\n\t\t\tthis.synced = true\n\t\t\tthis.global.clearTimeout(this.loopId)\n\t\t\t// this.correction2 *= SYNC_PERIOD_MS / SYNC_PERIOD_INITIAL_MS\n\t\t\tthis.correction += this.correction2\n\t\t\tthis.syncPeriod = SYNC_PERIOD_MS\n\t\t\tthis.loopId = this.global.setInterval(this.update, this.syncPeriod)\n\t\t\tif (this.options.onSynced) {\n\t\t\t\tthis.options.onSynced()\n\t\t\t}\n\t\t}\n\t}\n\n\tnow() {\n\t\tconst nn = this.nowRaw()\n\t\tconst c2gain = 1 + (nn - this.lastRespAt) / this.syncPeriod\n\t\treturn nn + this.correction + this.correction2 * c2gain\n\t}\n\n\ttoGlobal(perfTime: number) {\n\t\treturn perfTime + this.correction + this.correction2\n\t}\n\n\ttoLocal(globalTime: number) {\n\t\treturn globalTime - this.correction - this.correction2\n\t}\n}\n","import React from 'react'\nimport ReactDOM from 'react-dom'\nimport 'index.css'\n\nconst render = () => {\n\tconst App = require('app/App').default\n\n\tReactDOM.render(<App />, document.getElementById('root'))\n}\n\nrender()\n\nif (process.env.NODE_ENV === 'development' && module.hot) {\n\tmodule.hot.accept('./app/App', render)\n}\n","import {\n\tparseClientId,\n\tparseUsersAll,\n\tparseUserEvent,\n\tparseUserForce,\n\tparseUserXform,\n\tUser,\n\tUserEvent,\n\tUserForce,\n\tUserXform,\n\tWS_CLIENT_ID,\n\tWS_HEADER_END,\n\tWS_URL,\n\tWS_USERS_ALL,\n\tWS_USER_EVENT,\n\tWS_USER_FORCE,\n\tWS_USER_XFORM,\n\tWS_USER_REQUEST_XFORMS,\n} from './serverApi'\nimport { parseClockUpdate, ClockOpts, WS_CLOCK_NOW, WS_CLOCK_ORIGIN, WS_CLOCK_UPDATE } from './serverClock'\nimport WSClock, { WSClockOptions } from './WSClock'\n\nexport const DONT_REOPEN = 888\n\nexport type WSClientOptions = {\n\tclock: Partial<WSClockOptions>\n\tonClientId: (clientId: number) => any\n\tonClockUpdate: (clkOpts: ClockOpts) => void\n\tonUsers: (users: User[]) => void\n\tonUserEvent: (evt: UserEvent) => void\n\tonUserForce: (evt: UserForce) => void\n\tonUserXform: (evt: UserXform) => void\n\tonUserRequestXforms: () => void\n}\n\nexport default class WSClient {\n\tconn: WebSocket\n\tclock: WSClock\n\tglobal: any\n\toptions: WSClientOptions\n\tclientId: number = 0\n\tusers: User[] = []\n\n\tconstructor(global: any, options: WSClientOptions) {\n\t\tthis.global = global\n\t\tthis.options = options as WSClientOptions\n\t\tthis.conn = this.newConn()\n\t\tthis.clock = new WSClock(this.global, this.conn, this.options.clock)\n\t}\n\n\treopen = () => {\n\t\t// Try to re-open the websocket connection if it has closed\n\t\tif (this.conn.readyState !== WebSocket.CLOSED) {\n\t\t\treturn\n\t\t}\n\t\tthis.conn = this.newConn()\n\t}\n\n\tready = () => this.conn && this.conn.readyState === WebSocket.OPEN\n\n\tnewConn = (): WebSocket => {\n\t\tconst conn = new WebSocket(WS_URL)\n\t\tconn.onclose = (evt: CloseEvent) => {\n\t\t\tif (evt.code === DONT_REOPEN) {\n\t\t\t\tconsole.warn('Closing for good', evt)\n\t\t\t\treturn\n\t\t\t}\n\t\t\tconsole.warn('WebSocket closed, will attempt to reopen in a few seconds', evt)\n\t\t\tsetTimeout(this.reopen, 5000)\n\t\t}\n\t\tconn.onopen = (evt: Event) => {\n\t\t\tconsole.log('WebSocket opened', evt)\n\t\t\tthis.clock.destroy()\n\t\t\tthis.clock = new WSClock(this.global, this.conn, this.options.clock)\n\t\t}\n\t\tconn.onerror = (evt: Event) => {\n\t\t\tconsole.error('WebSocket error', evt)\n\t\t}\n\t\tconn.onmessage = this.onMessage\n\t\treturn conn\n\t}\n\n\tonMessage = (evt: MessageEvent) => {\n\t\tconst parts = split(evt.data, WS_HEADER_END, 1)\n\t\tconst [head, body] = parts\n\t\tswitch (head) {\n\t\t\tcase WS_CLOCK_NOW:\n\t\t\tcase WS_CLOCK_ORIGIN:\n\t\t\t\tif (!this.clock) {\n\t\t\t\t\tconsole.error('[WSClient #onMessage] No local clock ready to handle server clock message')\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tif (head === WS_CLOCK_ORIGIN) {\n\t\t\t\t\tthis.clock.onClockOrigin(body)\n\t\t\t\t} else {\n\t\t\t\t\tthis.clock.onClockNow(body)\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase WS_CLOCK_UPDATE:\n\t\t\t\tconst clkOpts = parseClockUpdate(body)\n\t\t\t\tthis.options.onClockUpdate(clkOpts)\n\t\t\t\tconsole.log('[WSClient #onMessage] Received clockUpdate', clkOpts)\n\t\t\t\tbreak\n\t\t\tcase WS_CLIENT_ID:\n\t\t\t\tthis.clientId = parseClientId(body)\n\t\t\t\tconsole.log('[WSClient #onMessage] Received clientId', this.clientId)\n\t\t\t\tthis.options.onClientId(this.clientId)\n\t\t\t\tbreak\n\t\t\tcase WS_USERS_ALL:\n\t\t\t\tthis.users = parseUsersAll(body).filter(uu => !!uu)\n\t\t\t\t// console.log('[WSClient #onMessage] Received users', this.users)\n\t\t\t\tthis.options.onUsers(this.users)\n\t\t\t\tbreak\n\t\t\tcase WS_USER_EVENT: {\n\t\t\t\tconst uevt = parseUserEvent(body)\n\t\t\t\t// console.log('[WSClient #onMessage] Received user event', uevt)\n\t\t\t\tthis.options.onUserEvent(uevt)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase WS_USER_FORCE: {\n\t\t\t\tconst uevt = parseUserForce(body)\n\t\t\t\t// console.log('[WSClient #onMessage] Received user event', uevt)\n\t\t\t\tthis.options.onUserForce(uevt)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase WS_USER_XFORM: {\n\t\t\t\tconst uevt = parseUserXform(body)\n\t\t\t\t// console.log('[WSClient #onMessage] Received user event', uevt)\n\t\t\t\tthis.options.onUserXform(uevt)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase WS_USER_REQUEST_XFORMS: {\n\t\t\t\tconsole.log('[WSClient #onMessage] Received Xform request')\n\t\t\t\tthis.options.onUserRequestXforms()\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tdefault:\n\t\t\t\tconsole.log('[WSClient #onMessage] Unhandled message', { head, body, parts }, evt)\n\t\t\t\tbreak\n\t\t}\n\t}\n\n\tnow = (): number => {\n\t\tif (!this.clock) {\n\t\t\tconsole.error('[WSClient #now] No clock!')\n\t\t\treturn -1\n\t\t}\n\t\treturn this.clock.now()\n\t}\n\n\tgetUser = (clientId: number) => {\n\t\tfor (const uu of this.users) {\n\t\t\tif (uu.clientId === clientId) {\n\t\t\t\treturn uu\n\t\t\t}\n\t\t}\n\t}\n}\n\n// split function with remainder\n// via https://stackoverflow.com/questions/874709/converting-user-input-string-to-regular-expression\nfunction split(str: string, sep: string, nn: number) {\n\tconst out: string[] = []\n\tconst sepRe = new RegExp(sep, 'g')\n\twhile (nn--) {\n\t\tconst prevIndex = sepRe.lastIndex\n\t\tconst re = sepRe.exec(str)\n\t\tif (!re) {\n\t\t\tbreak\n\t\t}\n\t\tout.push(str.slice(prevIndex, re.index))\n\t}\n\tout.push(str.slice(sepRe.lastIndex))\n\treturn out\n}\n","type FieldsShared = {\n\tdata: number[]\n\tchannel: number\n\tkind: string\n}\n\ntype FieldsNote = {\n\tattack?: number\n\tnote: number\n\trelease?: number\n}\n\ntype FieldsCC = {\n\tvalue: number // 0 - 1 (data[2])\n\tcontroller: {\n\t\tnumber: number // (data[1])\n\t\tname: string\n\t}\n}\n\ntype FieldsPitchbend = {\n\tvalue: number // 0 - 1 (data[2])\n}\n\nexport type MidiEventNote = FieldsShared & FieldsNote\nexport type MidiEventCC = FieldsShared & FieldsCC\nexport type MidiEventPitchbend = FieldsShared & FieldsPitchbend\nexport type MidiEvent = FieldsShared & FieldsCC & FieldsNote & FieldsPitchbend\nexport function newMidiEvent(evt: any): MidiEvent {\n\treturn {\n\t\tdata: evt.data,\n\t\tchannel: evt.target.number,\n\t\tkind: evt.type,\n\t\tattack: evt.attack,\n\t\tnote: evt.note && evt.note._number,\n\t\trelease: evt.release,\n\t\tvalue: evt.value,\n\t\tcontroller: evt.controller,\n\t}\n}\n\nconst allChannels = [...Array(16).keys()].map(x => x + 1) // Array of numbers 1 thru 16\nconst allEvents = ['controlchange', 'noteoff', 'noteon', 'pitchbend'] // 'keyaftertouch',\n\ntype MIDIOptions = {\n\tonMessage: (inputName: string, eventName: string, evt: MidiEvent) => void\n\tonEnabled?: (webMidi: any) => void\n}\n\nexport default class MIDI {\n\twebMidi: any | null = null\n\tenabled: boolean = false\n\n\tconstructor(opts: MIDIOptions) {\n\t\tthis.enable(opts)\n\t}\n\n\tenable = async (opts: MIDIOptions) => {\n\t\tconst { onMessage, onEnabled } = opts\n\t\tconst { WebMidi } = window\n\t\ttry {\n\t\t\tawait WebMidi.enable()\n\t\t} catch (err) {\n\t\t\tconsole.error('[MIDI #enable] Failed to enable MIDI', err)\n\t\t\treturn\n\t\t}\n\t\tthis.webMidi = WebMidi\n\t\tthis.enabled = true\n\t\tconst { inputs, outputs } = this.webMidi\n\t\tconsole.log('[MIDI #enable] inputs', inputs)\n\t\tconsole.log('[MIDI #enable] outputs', outputs)\n\t\tif (onEnabled) {\n\t\t\tonEnabled(this.webMidi)\n\t\t}\n\t\tfor (const input of inputs) {\n\t\t\tfor (const eventName of allEvents) {\n\t\t\t\tinput.addListener(\n\t\t\t\t\teventName,\n\t\t\t\t\t(evt: any) => onMessage(input.name, eventName, newMidiEvent(evt)),\n\t\t\t\t\t{\n\t\t\t\t\t\tchannels: allChannels,\n\t\t\t\t\t},\n\t\t\t\t)\n\t\t\t}\n\t\t}\n\t}\n}\n","import { Avatar } from 'engine3d'\nimport { MidiEventCC, MidiEventNote, MidiEventPitchbend } from './MIDI'\n\nexport class Instrument {\n\tloaded() {\n\t\treturn false\n\t}\n\tnoteon(_avatar: Avatar, _time: number, _evt: MidiEventNote) {}\n\tnoteoff(_avatar: Avatar, _time: number, _evt: MidiEventNote) {}\n\tcontrolchange(_avatar: Avatar, _time: number, _evt: MidiEventCC) {}\n\tpitchbend(_avatar: Avatar, _time: number, _evt: MidiEventPitchbend) {}\n}\n","import * as Tone from 'tone'\n\nexport function noteFreq(note: number) {\n\treturn Tone.Frequency(note, 'midi').toFrequency()\n}\n","export class Vec extends window.p5.Vector {\n\tw = 0\n\n\tconstructor(...vals: number[]) {\n\t\tsuper()\n\t\tthis.setFromArray(vals)\n\t}\n\n\tclone = (): Vec => new Vec(this.x, this.y, this.z)\n\tcloneMult = (val: number | Vec) => this.clone().applyMult(val)\n\tcloneAdd = (val: number | Vec) => this.clone().applyAdd(val)\n\tcloneSub = (val: number | Vec) => this.clone().applySub(val)\n\n\tisZero = () => this.x === 0 && this.y === 0 && this.z === 0\n\tisOne = () => this.x === 1 && this.y === 1 && this.z === 1\n\tisEqual = (other: Vec) => this.x === other.x && this.y === other.y && this.z === other.z\n\tnormalize = () => this.applyMult(1.0/this.mag())\n\n\ttoArray = () => [this.x, this.y, this.z]\n\tsetFromArray = (vals: number[]) => {\n\t\tthis.x = vals.length > 0 ? vals[0] : 0\n\t\tthis.y = vals.length > 1 ? vals[1] : this.x\n\t\tthis.z = vals.length > 2 ? vals[2] : vals.length === 2 ? 0 : this.x\n\t\treturn this\n\t}\n\n\tapplyMult = (val: number | Vec) => {\n\t\tif (val instanceof Vec) {\n\t\t\tthis.x *= val.x\n\t\t\tthis.y *= val.y\n\t\t\tthis.z *= val.z\n\t\t\treturn this\n\t\t}\n\t\tthis.x *= val\n\t\tthis.y *= val\n\t\tthis.z *= val\n\t\treturn this\n\t}\n\n\tapplyAdd = (val: number | Vec) => {\n\t\tif (val instanceof Vec) {\n\t\t\tthis.x += val.x\n\t\t\tthis.y += val.y\n\t\t\tthis.z += val.z\n\t\t\treturn this\n\t\t}\n\t\tthis.x += val\n\t\tthis.y += val\n\t\tthis.z += val\n\t\treturn this\n\t}\n\n\tapplySub = (val: number | Vec) => {\n\t\tif (val instanceof Vec) {\n\t\t\tthis.x -= val.x\n\t\t\tthis.y -= val.y\n\t\t\tthis.z -= val.z\n\t\t\treturn this\n\t\t}\n\t\tthis.x -= val\n\t\tthis.y -= val\n\t\tthis.z -= val\n\t\treturn this\n\t}\n\n\tcloneMultMat = (mat: number[]): Vec => {\n\t\tif (!mat.length || mat.length !== 16) {\n\t\t\tconsole.error('[Vec #applyMult] invalid matrix provided for mult', mat)\n\t\t\treturn this.clone()\n\t\t}\n\t\tconst dest = new Vec()\n\t\tdest.x = mat[0] * this.x + mat[4] * this.y + mat[8] * this.z + mat[12]\n\t\tdest.y = mat[1] * this.x + mat[5] * this.y + mat[9] * this.z + mat[13]\n\t\tdest.z = mat[2] * this.x + mat[6] * this.y + mat[10] * this.z + mat[14]\n\t\tdest.w = mat[3] * this.x + mat[7] * this.y + mat[11] * this.z + mat[15]\n\t\tif (Math.abs(dest.w) > Number.EPSILON) {\n\t\t\tdest.applyMult(1.0 / dest.w)\n\t\t}\n\t\treturn dest\n\t}\n}\n","import { Vec } from './Vec'\nimport { Xform } from './Xform'\n\nexport class Bounds {\n\tmin = new Vec(-1.0)\n\tmax = new Vec(1.0)\n\n\tconstructor(min?: Vec, max?: Vec) {\n\t\tif (min) { this.min = min }\n\t\tif (max) { this.max = max }\n\t}\n\n\tclone = () => new Bounds(this.min.clone(), this.max.clone())\n\tcloneXform = (xform: Xform) => this.clone().applyXform(xform)\n\n\tapplyXform = (xform: Xform) => {\n\t\txform.applyTo(this.min)\n\t\txform.applyTo(this.max)\n\t\tthis.sanitize()\n\t\treturn this\n\t}\n\n\tsanitize = () => {\n\t\tif (this.min.x > this.max.x) {\n\t\t\tconst tmp = this.min.x\n\t\t\tthis.min.x = this.max.x\n\t\t\tthis.max.x = tmp\n\t\t}\n\t\tif (this.min.y > this.max.y) {\n\t\t\tconst tmp = this.min.y\n\t\t\tthis.min.y = this.max.y\n\t\t\tthis.max.y = tmp\n\t\t}\n\t\tif (this.min.z > this.max.z) {\n\t\t\tconst tmp = this.min.z\n\t\t\tthis.min.z = this.max.z\n\t\t\tthis.max.z = tmp\n\t\t}\n\t\treturn this\n\t}\n\n\t// pushInside returns a zero vector if this bounds is inside the other bounds;\n\t// otherwise, returns the vector required to move this bounds into other\n\tpushInside = (other: Bounds): Vec => {\n\t\tconst off = new Vec()\n\t\tif (this.min.x < other.min.x) {\n\t\t\toff.x = other.min.x - this.min.x\n\t\t} else if (this.max.x > other.max.x) {\n\t\t\toff.x = other.max.x - this.max.x\n\t\t}\n\t\tif (this.min.y < other.min.y) {\n\t\t\toff.y = other.min.y - this.min.y\n\t\t} else if (this.max.y > other.max.y) {\n\t\t\toff.y = other.max.y - this.max.y\n\t\t}\n\t\tif (this.min.z < other.min.z) {\n\t\t\toff.z = other.min.z - this.min.z\n\t\t} else if (this.max.z > other.max.z) {\n\t\t\toff.z = other.max.z - this.max.z\n\t\t}\n\t\treturn off\n\t}\n\n\tcenterAndSize = () => {\n\t\treturn {\n\t\t\tcenter: new Vec(\n\t\t\t\t(this.max.x + this.min.x) / 2,\n\t\t\t\t(this.max.y + this.min.y) / 2,\n\t\t\t\t(this.max.z + this.min.z) / 2,\n\t\t\t),\n\t\t\tsize: new Vec(\n\t\t\t\t(this.max.x - this.min.x),\n\t\t\t\t(this.max.y - this.min.y),\n\t\t\t\t(this.max.z - this.min.z),\n\t\t\t),\n\t\t}\n\t}\n}\n","import { Vec } from './Vec'\n\nexport class Xform {\n\tpos: Vec\n\trot: Vec\n\tscale: Vec\n\n\tconstructor(pos?: Vec, rot?: Vec, scale?: Vec) {\n\t\tthis.pos = pos ? pos : new Vec()\n\t\tthis.rot = rot ? rot : new Vec()\n\t\tthis.scale = scale ? scale : new Vec(1.0)\n\t}\n\n\tapplyTo = (vec: Vec) => {\n\t\tvec.applyMult(this.scale)\n\t\t// TODO: rotation\n\t\tvec.applyAdd(this.pos)\n\t}\n}\n","import { drawFunc, Obj } from './Obj'\n\nexport class Component {\n\tparent: Obj\n\tdrawDebug?: drawFunc\n\n\tconstructor(parent: Obj) {\n\t\tthis.parent = parent\n\t}\n\n\tdestroy() {\n\t\tconsole.log('[Component] destroyed')\n\t}\n\n\tupdate(_dt: number) {\n\t\tconsole.warn('[Component] update')\n\t}\n}\n","import * as p5 from 'p5'\nimport { Obj } from './Obj'\n\nexport type Engine3DOpts = {\n\tdebug?: boolean\n}\n\nexport class Engine3D {\n\tobjs: Obj[] = []\n\tdebug = false\n\tlastUpdate?: number\n\n\tconstructor(opts: Engine3DOpts = {}) {\n\t\tif (opts.debug) {\n\t\t\tthis.debug = true\n\t\t}\n\t}\n\n\taddObj = (obj: Obj) => this.objs.unshift(obj)\n\trmObj = (obj: Obj, destroy = true) => {\n\t\tthis.objs = this.objs.filter(oo => {\n\t\t\tif (oo === obj) {\n\t\t\t\tif (destroy) {\n\t\t\t\t\too.destroy()\n\t\t\t\t}\n\t\t\t\treturn false\n\t\t\t}\n\t\t\treturn true\n\t\t})\n\t}\n\n\tupdate = () => {\n\t\tif (!this.lastUpdate) {\n\t\t\tthis.lastUpdate = new Date().valueOf()\n\t\t\treturn\n\t\t}\n\t\tconst now = new Date().valueOf()\n\t\tconst dt = (now - this.lastUpdate) / 1000\n\t\tthis.lastUpdate = now\n\t\tthis.objs.forEach(oo => oo.update(dt))\n\t}\n\n\tdraw = (pg: p5.Graphics) => {\n\t\tfor (const obj of this.objs) {\n\t\t\tobj.draw(pg)\n\t\t\tobj.drawShadow(pg)\n\t\t\tif (this.debug) {\n\t\t\t\tobj.drawDebug(pg)\n\t\t\t}\n\t\t}\n\t}\n\n\tdraw2D = (pp: p5, pg: p5.Graphics) => {\n\t\tconst gg = pg as any\n\t\tconst mvp = gg._renderer.uMVMatrix.copy().mult(gg._renderer.uPMatrix)\n\t\tfor (const obj of this.objs) {\n\t\t\tobj.draw2D(pp, pg, mvp.mat4)\n\t\t}\n\t}\n}\n\nexport const engine3d = new Engine3D({ debug: false })\n","import * as p5 from 'p5'\nimport { Vec } from './Vec'\nimport { Xform } from './Xform'\nimport { Component } from './Component'\nimport { engine3d } from './engine3d'\n\nexport type drawFunc = (pg: p5.Graphics) => void\nexport type drawFunc2D = (pp: p5, pos: Vec, scale: number) => void\n\nexport type ObjOpts = {\n\tparent?: Obj\n\tchildren?: Obj[]\n\tcomps?: Component[]\n\tpos?: Vec\n\trot?: Vec\n\tscale?: Vec\n\tdraw?: drawFunc\n\tdrawShadow?: drawFunc\n\tdraw2D?: drawFunc2D\n}\n\nexport class Obj {\n\tchildren: Obj[] = []\n\tcomps: Component[] = []\n\txform: Xform = new Xform()\n\tparent?: Obj\n\tdrawFunc?: drawFunc\n\tdrawShadowFunc?: drawFunc\n\tdrawFunc2D?: drawFunc2D\n\n\tconstructor(opts: ObjOpts = {}) {\n\t\t// console.log('[Obj] ctor', this)\n\t\tthis.drawFunc = opts.draw\n\t\tthis.drawFunc2D = opts.draw2D\n\t\tthis.parent = opts.parent\n\t\tif (opts.children) {\n\t\t\tthis.children = opts.children\n\t\t}\n\t\tif (opts.comps) {\n\t\t\tthis.comps = opts.comps\n\t\t}\n\t\tif (opts.pos) {\n\t\t\tthis.xform.pos = opts.pos\n\t\t}\n\t\tif (opts.rot) {\n\t\t\tthis.xform.rot = opts.rot\n\t\t}\n\t\tif (opts.scale) {\n\t\t\tthis.xform.scale = opts.scale\n\t\t}\n\t\tengine3d.addObj(this)\n\t}\n\n\tdestroy = () => {\n\t\tthis.comps.forEach(cc => cc.destroy())\n\t\tthis.children.forEach(cc => cc.destroy())\n\t\t// console.log('[Obj] destroyed')\n\t}\n\trm = () => {\n\t\tif (this.parent) {\n\t\t\tthis.parent.rmChild(this)\n\t\t} else {\n\t\t\tengine3d.rmObj(this)\n\t\t}\n\t}\n\n\taddChild = (obj: Obj) => {\n\t\tengine3d.rmObj(obj, false) // remove Obj from root hierarchy\n\t\tobj.parent = this\n\t\tthis.children.push(obj)\n\t}\n\trmChild = (obj: Obj) => {\n\t\tthis.children = this.children.filter(cc => {\n\t\t\tif (cc === obj) {\n\t\t\t\tcc.destroy()\n\t\t\t\treturn false\n\t\t\t}\n\t\t\treturn true\n\t\t})\n\t}\n\tgetChildren = (objType: any) => this.children.filter(oo => oo instanceof objType)\n\tgetChild = (objType: any): Obj | undefined => this.getChildren(objType)[0]\n\n\taddComp = (comp: Component) => {\n\t\tthis.comps.push(comp)\n\t}\n\trmComp = (comp: Component) => {\n\t\tthis.comps = this.comps.filter(cc => {\n\t\t\tif (cc === comp) {\n\t\t\t\tcc.destroy()\n\t\t\t\treturn false\n\t\t\t}\n\t\t\treturn true\n\t\t})\n\t}\n\tgetComps = (compType: any) => this.comps.filter(cc => cc instanceof compType)\n\tgetComp = (compType: any): Component | undefined => this.getComps(compType)[0]\n\n\tupdate(dt: number) {\n\t\tthis.comps.forEach(cc => cc.update(dt))\n\t\tthis.children.forEach(cc => cc.update(dt))\n\t}\n\n\tdraw(pg: p5.Graphics) {\n\t\tpg.push()\n\t\tthis.applyXformToGraphics(pg)\n\t\tif (this.drawFunc) {\n\t\t\tthis.drawFunc(pg)\n\t\t}\n\t\tthis.children.forEach(cc => cc.draw(pg))\n\t\tpg.pop()\n\t}\n\n\tdrawShadow(pg: p5.Graphics) {\n\t\t// Similar to draw, but xformed to ground plane\n\t\tpg.push()\n\t\tconst { pos, rot, scale } = this.xform\n\t\tpg.translate(pos.x, 0, pos.z)\n\t\tif (rot.y !== 0) pg.rotateY(rot.y)\n\t\tpg.scale(scale.x, 1, scale.z)\n\t\tif (this.drawShadowFunc) {\n\t\t\tthis.drawShadowFunc(pg)\n\t\t}\n\t\tthis.children.forEach(cc => cc.drawShadow(pg))\n\t\tpg.pop()\n\t}\n\n\tdraw2D(pp: p5, pg: p5.Graphics, mvp: number[]) {\n\t\tthis.children.forEach(cc => cc.draw2D(pp, pg, mvp))\n\t\tif (!this.drawFunc2D) {\n\t\t\treturn\n\t\t}\n\t\tconst { pos, scale } = this.xform\n\t\tconst ndcPos = pos.cloneMultMat(mvp)\n\t\tconst edge = 1.2\n\t\tif (ndcPos.w < 0 || ndcPos.x < -edge || ndcPos.x > edge || ndcPos.y < -edge || ndcPos.y > edge) {\n\t\t\t// object is off-screen\n\t\t\treturn\n\t\t}\n\t\t// calculate a rough-guess at screen-space scale\n\t\t// (would use inverse MVP matrix but I can't get p5's matrix invert method to work)\n\t\tconst ndcPos2 = pos.cloneAdd(scale).cloneMultMat(mvp)\n\t\tconst ndcPos3 = pos.cloneAdd(scale.cloneMult(new Vec(1, -1, -1))).cloneMultMat(mvp)\n\t\tconst ndcPos4 = pos.cloneAdd(scale.cloneMult(new Vec(-1, -1, 1))).cloneMultMat(mvp)\n\t\tfor (const ndc of [ndcPos, ndcPos2, ndcPos3, ndcPos4]) {\n\t\t\tndc.x = ((ndc.x + 1) * pp.width) / 2\n\t\t\tndc.y = ((1 - ndc.y) * pp.height) / 2\n\t\t\tndc.z = 0\n\t\t}\n\t\tconst scale2d = Math.max(\n\t\t\tndcPos.cloneSub(ndcPos2).mag(),\n\t\t\tndcPos.cloneSub(ndcPos3).mag(),\n\t\t\tndcPos.cloneSub(ndcPos4).mag(),\n\t\t)\n\t\tpp.push()\n\t\tthis.drawFunc2D(pp, ndcPos, scale2d)\n\t\tpp.pop()\n\t}\n\n\tdrawDebug = (pg: p5.Graphics) => {\n\t\tthis.comps.forEach(cc => cc.drawDebug && cc.drawDebug(pg))\n\t}\n\n\tapplyXformToGraphics = (pg: p5.Graphics) => {\n\t\tconst { pos, rot, scale } = this.xform\n\t\tif (!pos.isZero()) {\n\t\t\tpg.translate(pos.x, pos.y, pos.z)\n\t\t}\n\t\tif (rot.z !== 0) pg.rotateZ(rot.z)\n\t\tif (rot.y !== 0) pg.rotateY(rot.y)\n\t\tif (rot.x !== 0) pg.rotateX(rot.x)\n\t\tif (!scale.isOne()) {\n\t\t\tpg.scale(scale.x, scale.y, scale.z)\n\t\t}\n\t}\n}\n","import { Bounds, Component, Obj, Vec } from '../core'\n\nconst gravity = new Vec(0, -9.82, 0)\nexport type PhysicalOpts = {\n\tbounds?: Bounds\n\tworldScale?: number\n}\n\n// Physical is a very simple physics implementation, applying forces\n// to the parent object and constraining it to a hard-coded world bounds\nexport class Physical extends Component {\n\tforce = new Vec()\n\tvel = new Vec()\n\tbounds: Bounds\n\tworld: Bounds\n\n\tconstructor(parent: Obj, opts: PhysicalOpts = {}) {\n\t\tsuper(parent)\n\t\tthis.bounds = opts.bounds ? opts.bounds : new Bounds()\n\t\tif (!opts.worldScale) {\n\t\t\topts.worldScale = 1000\n\t\t}\n\t\tthis.world = new Bounds(\n\t\t\tnew Vec(-opts.worldScale, 0, -opts.worldScale),\n\t\t\tnew Vec(opts.worldScale, opts.worldScale, opts.worldScale),\n\t\t)\n\t}\n\n\tupdate = (dt: number) => {\n\t\t// Update velocity based on forces\n\t\tthis.vel.applyAdd(gravity.cloneAdd(this.force).applyMult(dt))\n\t\tthis.vel.applyMult(new Vec(0.8, 1.0, 0.8)) // friction in X and Z\n\t\tif (this.vel.magSq() < 0.01) {\n\t\t\t// Velocity threshold\n\t\t\tthis.vel.applyMult(0)\n\t\t}\n\t\t// Update position based on velocity\n\t\tconst { pos } = this.parent.xform\n\t\tpos.applyAdd(this.vel)\n\t\t// Constrain to world bounds\n\t\tconst off = this.worldBounds().pushInside(this.world)\n\t\tif (off.isZero()) {\n\t\t\treturn\n\t\t}\n\t\t// Apply constraint offset\n\t\tpos.applyAdd(off)\n\t\t// Bounce the velocity\n\t\tif (off.x !== 0) {\n\t\t\tthis.vel.x *= -0.5\n\t\t}\n\t\tif (off.y !== 0) {\n\t\t\tthis.vel.y *= -0.5\n\t\t}\n\t\tif (off.z !== 0) {\n\t\t\tthis.vel.z *= -0.5\n\t\t}\n\t}\n\n\tdrawDebug = (pg: p5.Graphics) => {\n\t\tconst { center, size } = this.worldBounds().centerAndSize()\n\t\tpg.push()\n\t\tpg.noFill()\n\t\tpg.stroke(255, 0, 0)\n\t\tpg.strokeWeight(1)\n\t\tpg.translate(center.x, center.y, center.z)\n\t\tpg.box(size.x, size.y, size.z)\n\t\tpg.pop()\n\t}\n\n\tworldBounds = () => this.bounds.cloneXform(this.parent.xform)\n}\n","import { EasyCam } from 'vendor/p5.easycam.js'\nimport { Component, Obj } from '../core'\n\n// FollowCam locks an EasyCam's center to the parent Obj\nexport class FollowCam extends Component {\n\tcam: EasyCam\n\n\tconstructor(parent: Obj, cam: EasyCam) {\n\t\tsuper(parent)\n\t\tthis.cam = cam\n\t}\n\n\tlast?: number\n\tupdate = (dt: number) => {\n\t\tif (!this.cam.state || !this.cam.state.center) {\n\t\t\treturn\n\t\t}\n\t\tconst { x, y, z } = this.parent.xform.pos\n\t\tthis.cam.setCenter([x, y, z], 0)\n\t}\n}\n","import * as p5 from 'p5'\nimport * as Tone from 'tone'\nimport { Component, Obj, ObjOpts, Vec } from '../core'\nimport { MidiEventCC, MidiEventNote, MidiEventPitchbend } from 'app/MIDI'\n\nconst defaultEnvOpts = {\n\tattack: '16n',\n\tattackCurve: 'linear',\n\tsustain: 1,\n\trelease: '8n',\n\treleaseCurve: 'linear',\n} as Tone.EnvelopeOptions\n\nclass DanceMoves extends Component {\n\tdip = new Tone.Envelope(defaultEnvOpts)\n\tstepLeft = new Tone.Envelope(defaultEnvOpts)\n\tstepRight = new Tone.Envelope(defaultEnvOpts)\n\tspinLeft = new Tone.Envelope(defaultEnvOpts)\n\tspinRight = new Tone.Envelope(defaultEnvOpts)\n\theadbang = new Tone.Envelope(defaultEnvOpts)\n\tarms = {\n\t\tl: {\n\t\t\tupper: {\n\t\t\t\ty: new Tone.Envelope(defaultEnvOpts),\n\t\t\t\tz: new Tone.Envelope(defaultEnvOpts),\n\t\t\t},\n\t\t\tlower: {\n\t\t\t\tx: new Tone.Envelope(defaultEnvOpts),\n\t\t\t},\n\t\t},\n\t\tr: {\n\t\t\tupper: {\n\t\t\t\ty: new Tone.Envelope(defaultEnvOpts),\n\t\t\t\tz: new Tone.Envelope(defaultEnvOpts),\n\t\t\t},\n\t\t\tlower: {\n\t\t\t\tx: new Tone.Envelope(defaultEnvOpts),\n\t\t\t},\n\t\t},\n\t}\n\n\tupdate = (dt: number) => {\n\t\tconst obj = this.parent as DancerObj\n\t\tobj.xform.pos.y = -this.dip.value * sizes.leg.y * 0.8\n\t\tobj.stepLeftRight = 0.7 * (this.stepRight.value - this.stepLeft.value)\n\t\tconst avatar = obj.parent || obj\n\t\tavatar.xform.rot.y += dt * 20 * (this.spinRight.value - this.spinLeft.value)\n\t\tobj.rotHead.x = (this.headbang.value * Math.PI) / 4\n\t\tobj.rotArms.l.upper.y = Math.PI * (0.4 - 0.7 * this.arms.l.upper.y.value)\n\t\tobj.rotArms.r.upper.y = Math.PI * (0.4 - 0.7 * this.arms.r.upper.y.value)\n\t\tobj.rotArms.l.upper.z = Math.PI * (1.1 + this.arms.l.upper.z.value)\n\t\tobj.rotArms.r.upper.z = Math.PI * (1.1 + this.arms.r.upper.z.value)\n\t\tobj.rotArms.l.lower.x = Math.PI * (0.1 + 0.7 * this.arms.l.lower.x.value)\n\t\tobj.rotArms.r.lower.x = Math.PI * (0.1 + 0.7 * this.arms.r.lower.x.value)\n\t}\n\n\tnoteEnvMap: { [key: number]: Tone.Envelope } = {\n\t\t0: this.dip,\n\t\t1: this.spinLeft,\n\t\t2: this.headbang,\n\t\t3: this.spinRight,\n\t\t4: this.stepLeft,\n\t\t5: this.stepRight,\n\t\t6: this.arms.l.upper.z,\n\t\t7: this.arms.r.upper.z,\n\t\t8: this.arms.l.lower.x,\n\t\t9: this.arms.r.lower.x,\n\t\t10: this.arms.l.upper.y,\n\t\t11: this.arms.r.upper.y,\n\t}\n\n\tnoteEvent = (time: number, evt: MidiEventNote) => {\n\t\tconst { kind, note, attack } = evt\n\t\tconst move = this.noteEnvMap[note % 12]\n\t\tif (kind === 'noteon') {\n\t\t\tmove.triggerAttack(time, attack)\n\t\t} else {\n\t\t\tmove.triggerRelease(time)\n\t\t}\n\t}\n}\n\nconst sizes = {\n\tleg: new Vec(0.1, 0.5, 0.1),\n\tarmUpper: new Vec(0.1, 0.3, 0.1),\n\tarmLower: new Vec(0.1, 0.3, 0.1),\n\tbody: new Vec(0.4),\n\tneck: new Vec(0.05),\n\thead: new Vec(0.25),\n}\n\nconst defaultArmsRot = () => ({\n\tupper: new Vec(0, Math.PI * 0.4, Math.PI * 1.1),\n\tlower: new Vec(Math.PI * 0.1, 0, 0),\n})\n\nexport class DancerObj extends Obj {\n\tmoves: DanceMoves\n\trotHead = new Vec()\n\trotArms = {\n\t\tl: defaultArmsRot(),\n\t\tr: defaultArmsRot(),\n\t}\n\tstepLeftRight = 0\n\n\tconstructor(opts: ObjOpts = {}) {\n\t\tsuper(opts)\n\t\tthis.moves = new DanceMoves(this)\n\t\tthis.addComp(this.moves)\n\t}\n\n\tdrawFunc = (pg: p5.Graphics) => {\n\t\tpg.fill(0).stroke(255).strokeWeight(2)\n\t\tconst { leg, body } = sizes\n\t\tpg.translate(this.stepLeftRight, -1 + leg.y + body.y, 0)\n\t\tpg.sphere(sizes.body.y, 7, 4)\n\t\tthis.drawHead(pg)\n\t\tthis.drawArm(pg, true)\n\t\tthis.drawArm(pg, false)\n\t}\n\n\tdrawHead = (pg: p5.Graphics) => {\n\t\tconst { body, neck, head } = sizes\n\t\tpg.push()\n\t\tpg.rotateX(this.rotHead.x)\n\t\tpg.push()\n\t\tpg.translate(0, body.y + neck.y + head.y, 0)\n\t\tpg.box(head.y * 1.8, head.y * 1.8, head.y * 1.8)\n\t\tpg.pop()\n\t\tpg.pop()\n\t}\n\n\tdrawArm = (pg: p5.Graphics, left = true) => {\n\t\tconst { body, armUpper, armLower } = sizes\n\t\tconst rot = left ? this.rotArms.l : this.rotArms.r\n\t\tpg.push()\n\t\tif (left) {\n\t\t\tpg.scale(-1, 1, 1)\n\t\t}\n\t\tpg.translate(body.x, body.y * 0.8, 0)\n\t\tpg.rotateZ(rot.upper.z).rotateY(rot.upper.y)\n\t\tpg.translate(0, armUpper.y / 2, 0)\n\t\tpg.box(armUpper.x, armUpper.y, armUpper.z)\n\t\tpg.translate(0, 0.025 + armUpper.y / 2, 0)\n\t\tpg.rotateX(rot.lower.x)\n\t\tpg.translate(0, 0.025 + armLower.y / 2, 0)\n\t\tpg.box(armLower.x, armLower.y, armLower.z)\n\t\tpg.translate(0, 0.05 + armLower.y / 2 + armLower.x / 2, 0)\n\t\tpg.box(armLower.x, armLower.x, armLower.x)\n\t\tpg.pop()\n\t}\n\n\tdrawShadowFunc = (pg: p5.Graphics) => {\n\t\tpg.push()\n\t\tpg.fill(30).noStroke()\n\t\tpg.rotateX(Math.PI / 2)\n\t\tpg.circle(this.stepLeftRight, 0, sizes.body.x * 2)\n\t\tpg.pop()\n\t}\n}\n","import * as p5 from 'p5'\nimport { EasyCam } from 'vendor/p5.easycam.js'\nimport { User, UserForce, UserXform } from 'app/serverApi/serverApi'\nimport { Obj, ObjOpts, Vec } from '../core'\nimport { Physical, PhysicalOpts, FollowCam } from '../components'\nimport { DancerObj } from './DancerObj'\n\ntype KeyMovement = {\n\tup: boolean\n\tdown: boolean\n\tleft: boolean\n\tright: boolean\n\tjump: boolean\n\tjumpInitial: boolean\n\tgain: number\n}\n\ntype forceFunc = (data: UserXform) => void\n\nexport type AvatarOpts = ObjOpts & {\n\tuser: User\n\tphys?: PhysicalOpts\n\tonForce?: forceFunc\n}\n\nexport class Avatar extends Obj {\n\tphys: Physical\n\tuser: User\n\tfollowCam?: FollowCam\n\tonForce?: forceFunc\n\tdancer: DancerObj\n\n\tkeys: KeyMovement = {\n\t\tup: false,\n\t\tdown: false,\n\t\tleft: false,\n\t\tright: false,\n\t\tjump: false,\n\t\tjumpInitial: false,\n\t\tgain: 100,\n\t}\n\n\tconstructor(opts: AvatarOpts) {\n\t\tsuper(opts)\n\t\tthis.user = opts.user\n\t\tthis.phys = new Physical(this, opts.phys)\n\t\tthis.comps = [this.phys]\n\t\tthis.onForce = opts.onForce\n\t\tthis.dancer = new DancerObj()\n\t\tthis.addChild(this.dancer)\n\t\tconsole.log('[Avatar] ctor', this)\n\t}\n\n\tupdate(dt: number) {\n\t\tsuper.update(dt)\n\t\tif (this.keys.jumpInitial) {\n\t\t\tthis.keys.jumpInitial = false\n\t\t\tthis.keysUpdated()\n\t\t}\n\t}\n\n\tdrawFunc2D = (pp: p5, pos: Vec, scale: number) => {\n\t\tconst { name, instrument, offset } = this.user\n\t\tif (scale < 15) {\n\t\t\treturn // avatar is very small on screen, so no text\n\t\t}\n\t\tconst ss = Math.min(scale, 50)\n\t\tconst sss = Math.min(scale, 200)\n\t\tpp.translate(pos.x, pos.y)\n\t\tpp.textAlign(pp.CENTER, pp.BOTTOM)\n\t\tpp.fill(255)\n\t\tpp.noStroke()\n\t\tpp.textSize(ss / 2)\n\t\tpp.textStyle(pp.BOLD)\n\t\tif (scale < 35) {\n\t\t\tpp.text(name, 0, -ss * 0.8)\n\t\t\treturn\n\t\t} else {\n\t\t\tpp.text(name, 0, -sss * 0.8)\n\t\t}\n\t\tpp.fill(225)\n\t\tpp.textSize(ss * 0.3)\n\t\tpp.textStyle(pp.ITALIC)\n\t\tpp.text(`${instrument} (@${offset > 0 ? '+' : ''}${offset})`, 0, -sss * 0.8 + ss * 0.35)\n\t}\n\n\taddFollowCam = (cam: EasyCam) => {\n\t\tthis.followCam = new FollowCam(this, cam)\n\t\tthis.followCam.update(0)\n\t\tthis.addComp(this.followCam)\n\t}\n\n\tgetUserXform = (): UserXform => ({\n\t\tclientId: this.user.clientId,\n\t\tpos: this.xform.pos.toArray(),\n\t\trot: this.xform.rot.toArray(),\n\t\tscale: this.xform.scale.toArray(),\n\t\tforce: this.phys.force.toArray(),\n\t\tvel: this.phys.vel.toArray(),\n\t})\n\n\tsetUserXform = (data: UserXform) => {\n\t\tthis.xform.pos.setFromArray(data.pos)\n\t\tthis.xform.rot.setFromArray(data.rot)\n\t\tthis.xform.scale.setFromArray(data.scale)\n\t\tthis.phys.force.setFromArray(data.force)\n\t\tthis.phys.vel.setFromArray(data.vel)\n\t}\n\n\tsetUserForce = (data: UserForce) => {\n\t\tthis.phys.force.setFromArray(data.force)\n\t}\n\n\t//\n\t// Keyboard state updates and movement controls\n\t//\n\tkeyPressed = (evt: p5) => this.keyChanged(evt, true)\n\tkeyReleased = (evt: p5) => this.keyChanged(evt, false)\n\tkeyChanged = (evt: p5, pressed: boolean) => {\n\t\tswitch (evt.key) {\n\t\t\tcase 'ArrowUp':\n\t\t\t\tthis.keys.up = pressed\n\t\t\t\tbreak\n\t\t\tcase 'ArrowDown':\n\t\t\t\tthis.keys.down = pressed\n\t\t\t\tbreak\n\t\t\tcase 'ArrowLeft':\n\t\t\t\tthis.keys.left = pressed\n\t\t\t\tbreak\n\t\t\tcase 'ArrowRight':\n\t\t\t\tthis.keys.right = pressed\n\t\t\t\tbreak\n\t\t\tcase ' ':\n\t\t\t\tthis.keys.jump = pressed\n\t\t\t\tthis.keys.jumpInitial = pressed\n\t\t\t\tbreak\n\t\t\tdefault:\n\t\t\t\treturn\n\t\t}\n\t\tthis.keysUpdated()\n\t}\n\n\t// keysUpdated applies force to the Physical component based on keyboard state and camera orientation\n\tkeysUpdated = () => {\n\t\tconst { up, down, left, right, jump, jumpInitial, gain } = this.keys\n\t\tconst mov = new Vec()\n\t\tmov.x = left && right ? 0 : left ? -gain : right ? gain : 0\n\t\tmov.y = jumpInitial && this.xform.pos.y < this.xform.scale.y * 1.5 ? gain * 3 : jump ? 6 : 0\n\t\tmov.z = down && up ? 0 : up ? gain : down ? -gain : 0\n\t\tif (!this.followCam) {\n\t\t\t// Can't determine camera orientation, apply force in world-space\n\t\t\tthis.phys.force = mov\n\t\t\tif (this.onForce) {\n\t\t\t\tthis.onForce(this.getUserXform())\n\t\t\t}\n\t\t\treturn\n\t\t}\n\t\t// Convert movement vector to force based on camera orientation\n\t\tconst ca = this.followCam.cam.centerAxes() // X=screen-right Z=screen-up, parallel to ground plane\n\t\tconst cax = new Vec(ca.x[0], 0, ca.x[2])\n\t\tconst caz = new Vec(ca.z[0], 0, ca.z[2])\n\t\tconst ff = new Vec(0, mov.y, 0)\n\t\tff.applyAdd(cax.applyMult(mov.x))\n\t\tff.applyAdd(caz.applyMult(mov.z))\n\t\tthis.phys.force = ff\n\t\tif (ff.x !== 0 || ff.z !== 0) {\n\t\t\t// Orient avatar to movement direction\n\t\t\tthis.xform.rot.y = Math.atan2(ff.x, ff.z)\n\t\t}\n\t\tif (this.onForce) {\n\t\t\tthis.onForce(this.getUserXform())\n\t\t}\n\t}\n}\n","import * as p5 from 'p5'\nimport * as Tone from 'tone'\nimport { MidiEventCC, MidiEventNote, MidiEventPitchbend } from '../MIDI'\nimport { Instrument } from '../Instrument'\nimport { noteFreq } from './util'\nimport { Avatar, Obj, ObjOpts, Vec } from 'engine3d'\nimport { sketch } from '../Sketch'\n\ntype BHObjOpts = ObjOpts & {\n\tnoteEvt: MidiEventNote\n\ttwist: number\n\tmass: number\n}\n\nconst srand = () => Math.random() * 2 - 1\nconst srandVec = () => new Vec(srand(), srand(), srand())\n\nclass BHObj extends Obj {\n\tinst: BlackHole\n\tcreatedAt: number\n\tnoteEvt: MidiEventNote\n\tscaleOrig: Vec\n\tvoice: Tone.Synth | null = null\n\thue = Math.random()\n\tmass: number\n\ttwist = 0\n\n\tconstructor(inst: BlackHole, opts: BHObjOpts) {\n\t\tsuper(opts)\n\t\tthis.inst = inst\n\t\tthis.createdAt = new Date().valueOf() / 1000\n\t\tthis.noteEvt = opts.noteEvt\n\t\tthis.scaleOrig = this.xform.scale.clone()\n\t\tthis.mass = 1 - opts.mass // invert to apply square\n\t\tthis.mass = 1 - this.mass * this.mass // un-invert the square\n\t\tif (opts.twist) {\n\t\t\tthis.twist = Math.random() > 0.5 ? opts.twist : -opts.twist\n\t\t}\n\t}\n\n\tupdate = (dt: number) => {\n\t\tlet mod = 1 - this.inst.modwheel // invert to apply square\n\t\tmod = 1 - mod * mod // un-invert the square\n\t\tthis.xform.rot.applyAdd(srandVec().applyMult(dt * mod))\n\t}\n\n\torigin2D = new Vec()\n\tscale2D = 1\n\tdrawFunc = (pg: p5.Graphics) => {\n\t\tif (sketch.shaderBlackHole) {\n\t\t\tsketch.shaderBlackHole.setUniform('origin', [\n\t\t\t\tthis.origin2D.x / pg.width,\n\t\t\t\tthis.origin2D.y / pg.height,\n\t\t\t])\n\t\t\tsketch.shaderBlackHole.setUniform('scale', this.scale2D / pg.width)\n\t\t\tsketch.shaderBlackHole.setUniform('rotate', this.twist * Math.PI)\n\t\t\tsketch.shaderBlackHole.setUniform('mass', this.mass)\n\t\t}\n\t\tpg.sphere(1, 3, 4)\n\t}\n\n\tdrawFunc2D = (pp: p5, pos: Vec, scale: number) => {\n\t\tthis.origin2D = pos\n\t\tthis.scale2D = Math.min(pp.height * 2, scale)\n\t}\n}\n\nexport class BlackHole extends Instrument {\n\tsynth: Tone.Synth\n\tgain: Tone.Gain\n\tfreqNode = new Tone.Add()\n\tfreq = new Tone.Signal(440)\n\tnoiseGain: Tone.Gain\n\tnoise: Tone.Noise\n\treverb: Tone.Reverb\n\tpanVol: Tone.PanVol\n\tps = 0\n\tpsSpread = 7\n\tattack = 0.01\n\tdecay = 0.07\n\tsustain = 0.3\n\trelease = 0.6\n\tmodwheel = 0.3\n\tobjs: Obj[] = []\n\tmaxObjs = 24\n\tii = 0\n\n\tconstructor() {\n\t\tsuper()\n\t\tthis.panVol = new Tone.PanVol(0, 0).toDestination()\n\t\tthis.reverb = new Tone.Reverb({ decay: 4, wet: 0.6 }).connect(this.panVol)\n\t\tconst filter = new Tone.Filter({\n\t\t\ttype: 'lowpass',\n\t\t\tfrequency: 8000,\n\t\t\tQ: 0.5,\n\t\t}).connect(this.reverb)\n\t\tconst delay = new Tone.PingPongDelay({\n\t\t\tdelayTime: '4n',\n\t\t\tfeedback: 0.6,\n\t\t\twet: 0.3,\n\t\t}).connect(filter)\n\t\tthis.gain = new Tone.Gain(1).connect(delay)\n\t\tthis.synth = new Tone.Synth().connect(this.gain)\n\t\tthis.freqNode.connect(this.synth.frequency)\n\t\tthis.freq.connect(this.freqNode)\n\t\tthis.noiseGain = new Tone.Gain(100).connect(this.freqNode.addend)\n\t\tthis.noise = new Tone.Noise({ volume: 0, playbackRate: 0.5, type: 'brown' })\n\t\t\t.start()\n\t\t\t.connect(this.noiseGain)\n\t}\n\n\tloaded() {\n\t\treturn true\n\t}\n\n\tnoteon = (avatar: Avatar, time: number, evt: MidiEventNote) => {\n\t\tconst freq = noteFreq(evt.note)\n\t\tthis.freq.exponentialRampToValueAtTime(freq, time)\n\t\ttry {\n\t\t\tthis.synth.triggerAttack(freq, time, evt.attack)\n\t\t} catch {}\n\t\tTone.Draw.schedule(() => this.addBHObj(avatar, evt), time)\n\t}\n\n\tnoteoff = (_avatar: Avatar, time: number, _evt: MidiEventNote) => {\n\t\tthis.synth.triggerRelease(time)\n\t}\n\n\tcontrolchange = (_avatar: Avatar, time: number, evt: MidiEventCC) => {\n\t\tconst num = evt.controller.number\n\t\tlet delayed: (() => void) | null = null\n\t\tswitch (true) {\n\t\t\tcase num === 1:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tconst vv = evt.value * evt.value\n\t\t\t\t\tthis.noiseGain.set({ gain: vv * this.freq.value * 3 })\n\t\t\t\t\tthis.modwheel = evt.value\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase num === 21:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tconst vv = evt.value * evt.value\n\t\t\t\t\tthis.noise.set({ playbackRate: vv * 2 })\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase num === 27:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.psSpread = evt.value * 12\n\t\t\t\t\tthis.updatePitchbend()\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase num === 28:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.panVol.set({ pan: evt.value * 2 - 1 })\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase 71 <= num && num <= 74: {\n\t\t\t\tlet vv = evt.value * evt.value * evt.value * evt.value\n\t\t\t\tconst key = ['attack', 'decay', 'sustain', 'release'][num - 71]\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tvv = key === 'sustain' ? evt.value : 10 * vv\n\t\t\t\t\t;(this as any)[key] = vv\n\t\t\t\t\tthis.synth.envelope.set({ [key]: vv })\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase 75 <= num && num <= 79:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.panVol.mute = !evt.value\n\t\t\t\t\tthis.panVol.set({ volume: (evt.value - 1) * 50 })\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase 15 <= num && num <= 19:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.panVol.mute = !evt.value\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tdefault:\n\t\t\t// console.log(\n\t\t\t// \t`[BlackHole #controlchange] Unsupported CC event on channel ${evt.channel}:`,\n\t\t\t// \tevt.controller,\n\t\t\t// \tevt.value,\n\t\t\t// )\n\t\t}\n\t\tif (delayed) {\n\t\t\tTone.Draw.schedule(delayed, time)\n\t\t}\n\t}\n\n\tpitchbend = (_avatar: Avatar, time: number, evt: MidiEventPitchbend) => {\n\t\tTone.Draw.schedule(() => {\n\t\t\tthis.ps = evt.value\n\t\t\tthis.updatePitchbend()\n\t\t}, time)\n\t}\n\n\tupdatePitchbend = () => {\n\t\tthis.synth.set({ detune: 100 * this.ps * this.psSpread })\n\t}\n\n\tlastPos: { [key: number]: Vec } = {}\n\taddBHObj = (avatar: Avatar, evt: MidiEventNote) => {\n\t\tconst { blackHole } = sketch\n\t\tif (!blackHole) {\n\t\t\treturn\n\t\t}\n\t\t// Create obj for note\n\t\tconst objSize = 100\n\t\tconst { objs, maxObjs } = this\n\t\tconst { clientId } = avatar.user\n\t\tlet pos = avatar.xform.pos\n\t\tif (this.lastPos[clientId]) {\n\t\t\tpos = this.lastPos[clientId]\n\t\t}\n\t\tconst off = new Vec(srand(), Math.random(), srand()).applyMult(objSize * 0.6)\n\t\tpos = pos.cloneAdd(off)\n\t\tif (this.ii++ % 8 === 0 || pos.y > 1000) {\n\t\t\tfor (const oo of objs) {\n\t\t\t\too.xform.scale.applyMult(0.6)\n\t\t\t}\n\t\t\tconst { pos: apos, scale: ascale } = avatar.xform\n\t\t\tconst theta = Math.random() * Math.PI * 2\n\t\t\tpos.x = apos.x + ascale.x * 5 * Math.sin(theta)\n\t\t\tpos.y = apos.y\n\t\t\tpos.z = apos.z + ascale.x * 5 * Math.cos(theta)\n\t\t}\n\t\tthis.lastPos[clientId] = pos\n\t\tconst rot = new Vec(\n\t\t\tMath.random() * Math.PI * 2,\n\t\t\tMath.random() * Math.PI * 2,\n\t\t\tMath.random() * Math.PI * 2,\n\t\t)\n\t\tconst obj = new BHObj(this, {\n\t\t\tnoteEvt: evt,\n\t\t\tpos: pos,\n\t\t\trot: rot,\n\t\t\tscale: new Vec(objSize),\n\t\t\ttwist: this.modwheel * this.modwheel,\n\t\t\tmass: evt.attack || 0.7,\n\t\t})\n\t\tobjs.unshift(obj)\n\t\t// Add obj to root blackhole object\n\t\tblackHole.addChild(obj)\n\t\tif (objs.length > maxObjs) {\n\t\t\t// remove oldest obj\n\t\t\tblackHole.rmChild(objs[objs.length - 1])\n\t\t\tthis.objs = objs.slice(0, maxObjs)\n\t\t}\n\t}\n}\n","import { MidiEventCC, MidiEventNote, MidiEventPitchbend } from '../MIDI'\nimport { Instrument } from '../Instrument'\nimport { Avatar } from 'engine3d'\n\nexport class Dancer extends Instrument {\n\tloaded() {\n\t\treturn true\n\t}\n\n\tlr = -1\n\tnoteon = (avatar: Avatar, time: number, evt: MidiEventNote) => {\n\t\tavatar.dancer.moves.noteEvent(time, evt)\n\t}\n\n\tnoteoff = (avatar: Avatar, time: number, evt: MidiEventNote) => {\n\t\tavatar.dancer.moves.noteEvent(time, evt)\n\t}\n\n\t// controlchange = (avatar: Avatar, time: number, evt: MidiEventCC) => {}\n\t// pitchbend = (avatar: Avatar, time: number, evt: MidiEventPitchbend) => {}\n}\n","import * as Tone from 'tone'\nimport { Avatar } from 'engine3d'\nimport { MidiEventCC, MidiEventNote, MidiEventPitchbend } from '../MIDI'\nimport { Instrument } from '../Instrument'\nimport { noteFreq } from './util'\n\nexport class Sampler extends Instrument {\n\tsampler: Tone.Sampler\n\tpitchShift: Tone.PitchShift\n\tpanVol: Tone.PanVol\n\tps = 0\n\tpsSpread = 7\n\n\tconstructor(sampler: Tone.Sampler) {\n\t\tsuper()\n\t\tthis.panVol = new Tone.PanVol(0, 0).toDestination()\n\t\tthis.pitchShift = new Tone.PitchShift().connect(this.panVol)\n\t\tthis.sampler = sampler.connect(this.pitchShift)\n\t}\n\n\tloaded() {\n\t\treturn this.sampler.loaded\n\t}\n\n\tnoteon = (_avatar: Avatar, time: number, evt: MidiEventNote) => {\n\t\tthis.sampler.triggerAttack(noteFreq(evt.note), time, evt.attack)\n\t}\n\n\tnoteoff = (_avatar: Avatar, time: number, evt: MidiEventNote) => {\n\t\tthis.sampler.triggerRelease(noteFreq(evt.note), time)\n\t}\n\n\tcontrolchange = (_avatar: Avatar, time: number, evt: MidiEventCC) => {\n\t\tconst num = evt.controller.number\n\t\tlet delayed: (() => void) | null = null\n\t\tswitch (true) {\n\t\t\tcase num === 1:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.psSpread = evt.value * 12\n\t\t\t\t\tthis.pitchShift.pitch = this.ps * this.psSpread\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase 75 <= num && num <= 79:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.panVol.mute = !evt.value\n\t\t\t\t\tthis.panVol.volume.value = (evt.value - 1) * 50\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase 15 <= num && num <= 19:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.panVol.mute = !evt.value\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase num === 28:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.panVol.pan.value = evt.value * 2 - 1\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tdefault:\n\t\t\t\tconsole.log(\n\t\t\t\t\t`[Sampler #controlchange] Unsupported CC event on channel ${evt.channel}:`,\n\t\t\t\t\tevt.controller,\n\t\t\t\t\tevt.value,\n\t\t\t\t)\n\t\t}\n\t\tif (delayed) {\n\t\t\tTone.Draw.schedule(delayed, time)\n\t\t}\n\t}\n\n\tpitchbend = (_avatar: Avatar, time: number, evt: MidiEventPitchbend) => {\n\t\tTone.Draw.schedule(() => {\n\t\t\tthis.ps = evt.value\n\t\t\tthis.pitchShift.pitch = this.ps * this.psSpread\n\t\t}, time)\n\t}\n}\n","import * as Tone from 'tone'\nimport { Avatar } from 'engine3d'\nimport { Sampler } from './Sampler'\nimport { MidiEventNote } from '../MIDI'\nimport { noteFreq } from './util'\nimport Sketch from '../Sketch'\n\nconst samps = [\n\t'BD0010.WAV',\n\t'BD0050.WAV',\n\t// 'BD0025.WAV',\n\t// 'BD0075.WAV',\n\t'SD7510.WAV',\n\t'CP.WAV',\n\t// 'SD7550.WAV',\n\t// 'SD7500.WAV',\n\t// 'SD7525.WAV',\n\t'CH.WAV',\n\t'OH10.WAV',\n\t'LT00.WAV',\n\t'MT00.WAV',\n\t'HT00.WAV',\n\t'LC00.WAV',\n\t'MC00.WAV',\n\t'HC00.WAV',\n\t'CB.WAV',\n\t'CY0075.WAV',\n\t// 'CY1000.WAV',\n\t'MA.WAV',\n\t'RS.WAV',\n\t// 'CL.WAV',\n]\n\nfunction eightOhEight() {\n\tconst urls: { [key: number]: string } = {}\n\tfor (let ii = 0; ii < samps.length; ++ii) {\n\t\turls[ii] = samps[ii % samps.length]\n\t}\n\treturn new Tone.Sampler({\n\t\turls,\n\t\trelease: 1,\n\t\tbaseUrl: '/samples/808/',\n\t})\n}\n\nexport class EightOhEight extends Sampler {\n\tsketch: Sketch\n\n\tconstructor(sketch: Sketch) {\n\t\tsuper(eightOhEight())\n\t\tthis.sketch = sketch\n\t}\n\n\tmodNote(note: number) {\n\t\treturn (note + 12) % samps.length\n\t}\n\n\tnoteon = (_avatar: Avatar, time: number, note: MidiEventNote) => {\n\t\tlet nn = this.modNote(note.note)\n\t\tthis.sampler.triggerAttack(noteFreq(nn), time, note.attack)\n\t\t// Update sky color\n\t\tTone.Draw.schedule(() => {\n\t\t\tthis.sketch.bgCol.hue = Math.random()\n\t\t\tthis.sketch.bgCol.sat = Math.random() * 0.4 + 0.5\n\t\t}, time)\n\t}\n\n\tnoteoff = (_avatar: Avatar, time: number, note: MidiEventNote) => {\n\t\tlet nn = this.modNote(note.note)\n\t\tthis.sampler.triggerRelease(noteFreq(nn), time)\n\t}\n}\n","import * as Tone from 'tone'\nimport { Avatar } from 'engine3d'\nimport { Sampler } from './Sampler'\nimport { MidiEventNote } from '../MIDI'\nimport { noteFreq } from './util'\nimport Sketch from '../Sketch'\n\nconst samps = ['MA.WAV', 'RS.WAV']\n\nfunction metronome() {\n\tconst urls: { [key: number]: string } = {}\n\tfor (let ii = 0; ii < samps.length; ++ii) {\n\t\turls[ii] = samps[ii % samps.length]\n\t}\n\treturn new Tone.Sampler({\n\t\turls,\n\t\trelease: 1,\n\t\tbaseUrl: '/samples/808/',\n\t})\n}\n\nexport class Metronome extends Sampler {\n\tsketch: Sketch\n\n\tconstructor(sketch: Sketch) {\n\t\tsuper(metronome())\n\t\tthis.sketch = sketch\n\t\tthis.panVol.set({ volume: -10 })\n\t\tthis.panVol.mute = true\n\t}\n\n\tmodNote(note: number) {\n\t\treturn note % samps.length\n\t}\n\n\tnoteon = (_avatar: Avatar, time: number, note: MidiEventNote) => {\n\t\tlet nn = this.modNote(note.note)\n\t\tthis.sampler.triggerAttack(noteFreq(nn), time, note.attack)\n\t}\n\n\tnoteoff = (_avatar: Avatar, time: number, note: MidiEventNote) => {\n\t\tlet nn = this.modNote(note.note)\n\t\tthis.sampler.triggerRelease(noteFreq(nn), time)\n\t}\n}\n","import * as Tone from 'tone'\nimport { Sampler } from './Sampler'\n\nconst pianoSamps = {\n\tA0: 'A0.mp3',\n\tC1: 'C1.mp3',\n\t'D#1': 'Ds1.mp3',\n\t'F#1': 'Fs1.mp3',\n\tA1: 'A1.mp3',\n\tC2: 'C2.mp3',\n\t'D#2': 'Ds2.mp3',\n\t'F#2': 'Fs2.mp3',\n\tA2: 'A2.mp3',\n\tC3: 'C3.mp3',\n\t'D#3': 'Ds3.mp3',\n\t'F#3': 'Fs3.mp3',\n\tA3: 'A3.mp3',\n\tC4: 'C4.mp3',\n\t'D#4': 'Ds4.mp3',\n\t'F#4': 'Fs4.mp3',\n\tA4: 'A4.mp3',\n\tC5: 'C5.mp3',\n\t'D#5': 'Ds5.mp3',\n\t'F#5': 'Fs5.mp3',\n\tA5: 'A5.mp3',\n\tC6: 'C6.mp3',\n\t'D#6': 'Ds6.mp3',\n\t'F#6': 'Fs6.mp3',\n\tA6: 'A6.mp3',\n\tC7: 'C7.mp3',\n\t'D#7': 'Ds7.mp3',\n\t'F#7': 'Fs7.mp3',\n\tA7: 'A7.mp3',\n\tC8: 'C8.mp3',\n}\n\nfunction piano() {\n\treturn new Tone.Sampler({\n\t\turls: pianoSamps,\n\t\trelease: 1,\n\t\tbaseUrl: 'https://tonejs.github.io/audio/salamander/',\n\t})\n}\n\nexport class Piano extends Sampler {\n\tconstructor() {\n\t\tsuper(piano())\n\t}\n}\n","import * as p5 from 'p5'\nimport * as Tone from 'tone'\nimport { MidiEventCC, MidiEventNote, MidiEventPitchbend } from '../MIDI'\nimport { Instrument } from '../Instrument'\nimport { noteFreq } from './util'\nimport { engine3d, Avatar, Obj, ObjOpts, Vec } from 'engine3d'\n\ntype SynthObjOpts = ObjOpts & {\n\tnoteEvt: MidiEventNote\n}\n\nconst srand = () => Math.random() * 2 - 1\nconst srandVec = () => new Vec(srand(), srand(), srand())\n\nclass SynthObj extends Obj {\n\tpolySynth: PolySynth\n\tcreatedAt: number\n\tnoteEvt: MidiEventNote\n\tscaleOrig: Vec\n\tvoice: Tone.Synth | null = null\n\thue = Math.random()\n\tlgt = 0.3\n\tenvValLast = 1\n\n\tconstructor(polySynth: PolySynth, opts: SynthObjOpts) {\n\t\tsuper(opts)\n\t\tthis.polySynth = polySynth\n\t\tthis.createdAt = new Date().valueOf() / 1000\n\t\tthis.noteEvt = opts.noteEvt\n\t\tthis.drawFunc = this.render\n\t\tthis.scaleOrig = this.xform.scale.clone()\n\t}\n\n\tupdate = (dt: number) => {\n\t\tlet mod = 1 - this.polySynth.modwheel\n\t\tmod = 1 - mod * mod\n\t\t// set lightness\n\t\tthis.lgt = mod * 0.8 + 0.2\n\t\t// set hue\n\t\tthis.hue += (Math.random() * 2 - 1) * dt * mod\n\t\tif (this.hue < 0) {\n\t\t\tthis.hue += 1\n\t\t} else if (this.hue > 1) {\n\t\t\tthis.hue -= 1\n\t\t}\n\t\tthis.xform.rot.applyAdd(srandVec().applyMult(dt * mod))\n\t\t// // Disabled for now: scale by envelope value\n\t\t// const voices = (this.polySynth.synth as any)._activeVoices\n\t\t// if (!this.voice) {\n\t\t// \tfor (const vv of voices) {\n\t\t// \t\tif (vv.midi === noteFreq(this.noteEvt.note) && !vv.released) {\n\t\t// \t\t\tthis.voice = vv.voice\n\t\t// \t\t\tbreak\n\t\t// \t\t}\n\t\t// \t}\n\t\t// }\n\t\t// if (this.voice) {\n\t\t// \tthis.envValLast = this.voice.envelope.value\n\t\t// }\n\t\t// this.xform.scale = this.scaleOrig.cloneMult(this.envValLast)\n\t}\n\n\trender = (pg: p5.Graphics) => {\n\t\tpg.colorMode(pg.HSL, 1)\n\t\tpg.fill(this.hue, 0.8, this.lgt)\n\t\tpg.stroke(this.hue, 0.8, this.lgt - 0.2)\n\t\tpg.strokeWeight(1)\n\t\tpg.sphere(1, 3, 4)\n\t\tpg.colorMode(pg.RGB, 255)\n\t}\n}\n\nexport class PolySynth extends Instrument {\n\tsynth: Tone.PolySynth\n\tfilter: Tone.Filter\n\tfilterVol: Tone.Volume\n\treverb: Tone.Reverb\n\tpanVol: Tone.PanVol\n\tps = 0\n\tpsSpread = 7\n\tattack = 0.01\n\tdecay = 0.07\n\tsustain = 0.3\n\trelease = 0.6\n\tmodwheel = 0.3\n\tobjs: Obj[] = []\n\tmaxObjs = 24\n\tii = 0\n\n\tconstructor() {\n\t\tsuper()\n\t\tthis.panVol = new Tone.PanVol(0, 0).toDestination()\n\t\tthis.reverb = new Tone.Reverb({ decay: 4, wet: 0.6 }).connect(this.panVol)\n\t\tthis.filterVol = new Tone.Volume(0).connect(this.reverb)\n\t\tthis.filter = new Tone.Filter({\n\t\t\ttype: 'bandpass',\n\t\t\tfrequency: 1000,\n\t\t\tQ: 2,\n\t\t}).connect(this.filterVol)\n\t\tthis.synth = new Tone.PolySynth(Tone.Synth, {\n\t\t\toscillator: {\n\t\t\t\ttype: 'fatsawtooth',\n\t\t\t\tcount: 3,\n\t\t\t\tspread: 30,\n\t\t\t},\n\t\t\tenvelope: {\n\t\t\t\tattack: this.attack,\n\t\t\t\tdecay: this.decay,\n\t\t\t\tsustain: this.sustain,\n\t\t\t\trelease: this.release,\n\t\t\t},\n\t\t}).connect(this.filter)\n\t}\n\n\tsetFilterGain = (db: number) => {\n\t\tthis.filter.set({ gain: db })\n\t\tthis.filterVol.volume.set({ value: Math.min(0, -db) })\n\t}\n\n\tloaded() {\n\t\treturn true\n\t}\n\n\tnoteon = (avatar: Avatar, time: number, evt: MidiEventNote) => {\n\t\tthis.synth.triggerAttack(noteFreq(evt.note), time, evt.attack)\n\t\tTone.Draw.schedule(() => this.addSynthObj(avatar, evt), time)\n\t}\n\n\tnoteoff = (_avatar: Avatar, time: number, evt: MidiEventNote) => {\n\t\tconst freq = noteFreq(evt.note)\n\t\t// this.synth.triggerRelease(freq, time) // sometimes fails to release\n\t\t// Tone.PolySynth can leave voices dangling, so manually release all voices matching this note\n\t\tTone.Draw.schedule(() => {\n\t\t\tfor (const vv of (this.synth as any)._activeVoices) {\n\t\t\t\tif (!vv.released && vv.midi === freq) {\n\t\t\t\t\tvv.voice.triggerRelease(Tone.immediate())\n\t\t\t\t}\n\t\t\t}\n\t\t}, `+${time - Tone.immediate()}`)\n\t}\n\n\tcontrolchange = (_avatar: Avatar, time: number, evt: MidiEventCC) => {\n\t\tconst num = evt.controller.number\n\t\tlet delayed: (() => void) | null = null\n\t\tswitch (true) {\n\t\t\tcase num === 1:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tconst vv = evt.value * evt.value\n\t\t\t\t\tthis.filter.frequency.rampTo(20 + 10000 * vv, 0.005)\n\t\t\t\t\tthis.modwheel = evt.value\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase num === 21:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tconst vv = evt.value * evt.value\n\t\t\t\t\tthis.filter.set({ Q: vv * 8 })\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase num === 27:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.psSpread = evt.value * 12\n\t\t\t\t\tthis.updatePitchbend()\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase num === 28:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.panVol.set({ pan: evt.value * 2 - 1 })\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase 71 <= num && num <= 74: {\n\t\t\t\tlet vv = evt.value * evt.value * evt.value * evt.value\n\t\t\t\tconst key = ['attack', 'decay', 'sustain', 'release'][num - 71]\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tvv = key === 'sustain' ? evt.value : 10 * vv\n\t\t\t\t\t;(this as any)[key] = vv\n\t\t\t\t\tthis.synth.set({ envelope: { [key]: vv } })\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase 75 <= num && num <= 79:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.panVol.mute = !evt.value\n\t\t\t\t\tthis.panVol.set({ volume: (evt.value - 1) * 50 })\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tcase 15 <= num && num <= 19:\n\t\t\t\tdelayed = () => {\n\t\t\t\t\tthis.panVol.mute = !evt.value\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\tdefault:\n\t\t\t\tconsole.log(\n\t\t\t\t\t`[PolySynth #controlchange] Unsupported CC event on channel ${evt.channel}:`,\n\t\t\t\t\tevt.controller,\n\t\t\t\t\tevt.value,\n\t\t\t\t)\n\t\t}\n\t\tif (delayed) {\n\t\t\tTone.Draw.schedule(delayed, time)\n\t\t}\n\t}\n\n\tpitchbend = (_avatar: Avatar, time: number, evt: MidiEventPitchbend) => {\n\t\tTone.Draw.schedule(() => {\n\t\t\tthis.ps = evt.value\n\t\t\tthis.updatePitchbend()\n\t\t}, time)\n\t}\n\n\tupdatePitchbend = () => {\n\t\tthis.synth.set({ detune: 100 * this.ps * this.psSpread })\n\t}\n\n\tlastPos: { [key: number]: Vec } = {}\n\taddSynthObj = (avatar: Avatar, evt: MidiEventNote) => {\n\t\t// Create obj for note\n\t\tconst objSize = 100\n\t\tconst { objs, maxObjs } = this\n\t\tconst { clientId } = avatar.user\n\t\tlet pos = avatar.xform.pos\n\t\tif (this.lastPos[clientId]) {\n\t\t\tpos = this.lastPos[clientId]\n\t\t}\n\t\tconst off = new Vec(srand(), Math.random(), srand()).applyMult(objSize * 0.6)\n\t\tpos = pos.cloneAdd(off)\n\t\tif (this.ii++ % 8 === 0 || pos.y > 1000) {\n\t\t\tfor (const oo of objs) {\n\t\t\t\too.xform.scale.applyMult(0.6)\n\t\t\t}\n\t\t\tconst { pos: apos, scale: ascale } = avatar.xform\n\t\t\tconst theta = Math.random() * Math.PI * 2\n\t\t\tpos.x = apos.x + ascale.x * 5 * Math.sin(theta)\n\t\t\tpos.y = apos.y\n\t\t\tpos.z = apos.z + ascale.x * 5 * Math.cos(theta)\n\t\t}\n\t\tthis.lastPos[clientId] = pos\n\t\tconst rot = new Vec(\n\t\t\tMath.random() * Math.PI * 2,\n\t\t\tMath.random() * Math.PI * 2,\n\t\t\tMath.random() * Math.PI * 2,\n\t\t)\n\t\tconst obj = new SynthObj(this, {\n\t\t\tnoteEvt: evt,\n\t\t\tpos: pos,\n\t\t\trot: rot,\n\t\t\tscale: new Vec(objSize),\n\t\t})\n\t\t// Add obj to engine\n\t\tobjs.unshift(obj)\n\t\tengine3d.addObj(obj)\n\t\tif (objs.length > maxObjs) {\n\t\t\t// remove oldest obj\n\t\t\tengine3d.rmObj(objs[objs.length - 1])\n\t\t\tthis.objs = objs.slice(0, maxObjs)\n\t\t}\n\t}\n}\n","// import * as p5 from 'p5'\n/*\n *\n * The p5.EasyCam library - Easy 3D CameraControl for p5.js and WEBGL.\n *\n *   Copyright © 2017-2020 by p5.EasyCam authors\n *\n *   Source: https://github.com/freshfork/p5.EasyCam\n *\n *   MIT License: https://opensource.org/licenses/MIT\n *\n *\n * explanatory notes:\n *\n * p5.EasyCam is a derivative of the original PeasyCam Library by Jonathan Feinberg\n * and combines new useful features with the great look and feel of its parent.\n *\n */\n\n/** @namespace  */\n// var Dw = (function(ext) {\nconst ext = {}\n\n/**\n * EasyCam Library Info\n */\nconst INFO = {\n\t/** name    */ LIBRARY: 'p5.EasyCam',\n\t/** version */ VERSION: '1.0.10',\n\t/** author  */ AUTHOR: 'p5.EasyCam authors',\n\t/** source  */ SOURCE: 'https://github.com/freshfork/p5.EasyCam',\n\n\ttoString: function () {\n\t\treturn this.LIBRARY + ' v' + this.VERSION + ' by ' + this.AUTHOR + ' (' + this.SOURCE + ')'\n\t},\n}\n\n/**\n * EasyCam\n *\n * <pre>\n *\n *   new Dw.EasyCam(p5.RendererGL, {\n *     distance : z,                 // scalar\n *     center   : [x, y, z],         // vector\n *     rotation : [q0, q1, q2, q3],  // quaternion\n *     viewport : [x, y, w, h],      // array\n *   }\n *\n * </pre>\n *\n * @param {p5.RendererGL} renderer - p5 WEBGL renderer\n * @param {Object}        args     - {distance, center, rotation, viewport}\n *\n */\nexport class EasyCam {\n\t/**\n\t * @constructor\n\t */\n\tconstructor(renderer, args) {\n\t\t// WEBGL renderer required\n\t\tif (!(renderer instanceof window.p5.RendererGL)) {\n\t\t\tconsole.log('renderer needs to be an instance of p5.RendererGL')\n\t\t\treturn\n\t\t}\n\n\t\t// define default args\n\t\targs = args || {}\n\t\tif (args.distance === undefined) args.distance = 500\n\t\tif (args.center === undefined) args.center = [0, 0, 0]\n\t\tif (args.rotation === undefined) args.rotation = Rotation.identity()\n\t\tif (args.viewport === undefined) args.viewport = [0, 0, renderer.width, renderer.height]\n\n\t\t// library info\n\t\tthis.INFO = INFO\n\n\t\t// set renderer, graphics, p5\n\t\t// this.renderer;\n\t\t// this.graphics;\n\t\t// this.P5\n\t\tthis.setCanvas(renderer)\n\n\t\t// self reference\n\t\tvar cam = this\n\t\tthis.cam = cam\n\n\t\t// some constants\n\t\tthis.LOOK = [0, 0, 1]\n\t\tthis.UP = [0, 1, 0]\n\n\t\t// principal axes flags\n\t\tthis.AXIS = new (function () {\n\t\t\tthis.YAW = 0x01\n\t\t\tthis.PITCH = 0x02\n\t\t\tthis.ROLL = 0x04\n\t\t\tthis.ALL = this.YAW | this.PITCH | this.ROLL\n\t\t})()\n\n\t\t// mouse action constraints\n\t\tthis.SHIFT_CONSTRAINT = 0 // applied when pressing the shift key\n\t\tthis.FIXED_CONSTRAINT = 0 // applied, when set by user and SHIFT_CONSTRAINT is 0\n\t\tthis.DRAG_CONSTRAINT = 0 // depending on SHIFT_CONSTRAINT and FIXED_CONSTRAINT, default is ALL\n\n\t\t// mouse action speed\n\t\tthis.scale_rotation = 0.001\n\t\tthis.scale_pan = 0.0002\n\t\tthis.scale_zoom = 0.001\n\t\tthis.scale_zoomwheel = 20.0\n\n\t\t// zoom limits\n\t\tthis.distance_min_limit = 0.01\n\t\tthis.distance_min = 1.0\n\t\tthis.distance_max = Number.MAX_VALUE\n\n\t\t// main state\n\t\tthis.state = {\n\t\t\tdistance: args.distance, // scalar\n\t\t\tcenter: args.center.slice(), // vec3\n\t\t\trotation: args.rotation.slice(), // quaternion\n\n\t\t\tcopy: function (dst) {\n\t\t\t\tdst = dst || {}\n\t\t\t\tdst.distance = this.distance\n\t\t\t\tdst.center = this.center.slice()\n\t\t\t\tdst.rotation = this.rotation.slice()\n\t\t\t\treturn dst\n\t\t\t},\n\t\t}\n\n\t\t// backup-state at start\n\t\tthis.state_reset = this.state.copy()\n\t\t// backup-state, probably not required\n\t\tthis.state_pushed = this.state.copy()\n\n\t\t// viewport for the mouse-pointer [x,y,w,h]\n\t\tthis.viewport = args.viewport.slice()\n\n\t\t// mouse/touch/key action handler\n\t\tthis.mouse = {\n\t\t\tcam: cam,\n\n\t\t\tcurr: [0, 0, 0],\n\t\t\tprev: [0, 0, 0],\n\t\t\tdist: [0, 0, 0],\n\t\t\tmwheel: 0,\n\n\t\t\tisPressed: false, // true if (istouchdown || ismousedown)\n\t\t\tistouchdown: false, // true, if input came from a touch\n\t\t\tismousedown: false, // true, if input came from a mouse\n\n\t\t\tBUTTON: { LMB: 0x01, MMB: 0x02, RMB: 0x04 },\n\n\t\t\tbutton: 0,\n\n\t\t\tmouseDragLeft: cam.mouseDragRotate.bind(cam),\n\t\t\tmouseDragCenter: cam.mouseDragPan.bind(cam),\n\t\t\tmouseDragRight: cam.mouseDragZoom.bind(cam),\n\t\t\tmouseWheelAction: cam.mouseWheelZoom.bind(cam),\n\n\t\t\ttouchmoveSingle: cam.mouseDragRotate.bind(cam),\n\t\t\ttouchmoveMulti: function () {\n\t\t\t\tcam.mouseDragPan()\n\t\t\t\tcam.mouseDragZoom()\n\t\t\t},\n\n\t\t\tinsideViewport: function (x, y) {\n\t\t\t\tvar x0 = cam.viewport[0],\n\t\t\t\t\tx1 = x0 + cam.viewport[2]\n\t\t\t\tvar y0 = cam.viewport[1],\n\t\t\t\t\ty1 = y0 + cam.viewport[3]\n\t\t\t\treturn x > x0 && x < x1 && y > y0 && y < y1\n\t\t\t},\n\n\t\t\tsolveConstraint: function () {\n\t\t\t\tvar dx = this.dist[0]\n\t\t\t\tvar dy = this.dist[1]\n\n\t\t\t\t// YAW, PITCH\n\t\t\t\tif (this.shiftKey && !cam.SHIFT_CONSTRAINT && Math.abs(dx - dy) > 1) {\n\t\t\t\t\tcam.SHIFT_CONSTRAINT = Math.abs(dx) > Math.abs(dy) ? cam.AXIS.YAW : cam.AXIS.PITCH\n\t\t\t\t}\n\n\t\t\t\t// define constraint by increasing priority\n\t\t\t\tcam.DRAG_CONSTRAINT = cam.AXIS.ALL\n\t\t\t\tif (cam.FIXED_CONSTRAINT) cam.DRAG_CONSTRAINT = cam.FIXED_CONSTRAINT\n\t\t\t\tif (cam.SHIFT_CONSTRAINT) cam.DRAG_CONSTRAINT = cam.SHIFT_CONSTRAINT\n\t\t\t},\n\n\t\t\tupdateInput: function (x, y, z) {\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tvar pd = cam.P5.pixelDensity()\n\n\t\t\t\tmouse.prev[0] = mouse.curr[0]\n\t\t\t\tmouse.prev[1] = mouse.curr[1]\n\t\t\t\tmouse.prev[2] = mouse.curr[2]\n\n\t\t\t\tmouse.curr[0] = x\n\t\t\t\tmouse.curr[1] = y\n\t\t\t\tmouse.curr[2] = z\n\n\t\t\t\tmouse.dist[0] = -(mouse.curr[0] - mouse.prev[0]) / pd\n\t\t\t\tmouse.dist[1] = -(mouse.curr[1] - mouse.prev[1]) / pd\n\t\t\t\tmouse.dist[2] = -(mouse.curr[2] - mouse.prev[2]) / pd\n\t\t\t},\n\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\t\t\t// mouseinput\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\n\t\t\tmousedown: function (event) {\n\t\t\t\tvar mouse = cam.mouse\n\n\t\t\t\tif (event.button === 0) mouse.button |= mouse.BUTTON.LMB\n\t\t\t\tif (event.button === 1) mouse.button |= mouse.BUTTON.MMB\n\t\t\t\tif (event.button === 2) mouse.button |= mouse.BUTTON.RMB\n\n\t\t\t\tif (mouse.insideViewport(event.x, event.y)) {\n\t\t\t\t\tmouse.updateInput(event.x, event.y, event.y)\n\t\t\t\t\tmouse.ismousedown = mouse.button > 0\n\t\t\t\t\tmouse.isPressed = mouse.ismousedown\n\t\t\t\t\tcam.SHIFT_CONSTRAINT = 0\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tmousedrag: function () {\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tif (mouse.ismousedown) {\n\t\t\t\t\tvar x = cam.P5.mouseX\n\t\t\t\t\tvar y = cam.P5.mouseY\n\t\t\t\t\tvar z = y\n\n\t\t\t\t\tmouse.updateInput(x, y, z)\n\t\t\t\t\tmouse.solveConstraint()\n\n\t\t\t\t\tvar LMB = mouse.button & mouse.BUTTON.LMB\n\t\t\t\t\tvar MMB = mouse.button & mouse.BUTTON.MMB\n\t\t\t\t\tvar RMB = mouse.button & mouse.BUTTON.RMB\n\n\t\t\t\t\tif (LMB && mouse.mouseDragLeft) mouse.mouseDragLeft()\n\t\t\t\t\tif (MMB && mouse.mouseDragCenter) mouse.mouseDragCenter()\n\t\t\t\t\tif (RMB && mouse.mouseDragRight) mouse.mouseDragRight()\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tmouseup: function (event) {\n\t\t\t\tvar mouse = cam.mouse\n\n\t\t\t\tif (event.button === 0) mouse.button &= ~mouse.BUTTON.LMB\n\t\t\t\tif (event.button === 1) mouse.button &= ~mouse.BUTTON.MMB\n\t\t\t\tif (event.button === 2) mouse.button &= ~mouse.BUTTON.RMB\n\n\t\t\t\tmouse.ismousedown = mouse.button > 0\n\t\t\t\tmouse.isPressed = mouse.istouchdown || mouse.ismousedown\n\t\t\t\tcam.SHIFT_CONSTRAINT = 0\n\t\t\t},\n\n\t\t\tdblclick: function (event) {\n\t\t\t\tvar x = event.x\n\t\t\t\tvar y = event.y\n\t\t\t\tif (cam.mouse.insideViewport(x, y)) {\n\t\t\t\t\tcam.reset()\n\t\t\t\t}\n\t\t\t},\n\n\t\t\twheel: function (event) {\n\t\t\t\tvar x = event.x\n\t\t\t\tvar y = event.y\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tif (mouse.insideViewport(x, y)) {\n\t\t\t\t\tmouse.mwheel = event.deltaY * 0.01\n\t\t\t\t\tif (mouse.mouseWheelAction) mouse.mouseWheelAction()\n\t\t\t\t}\n\t\t\t},\n\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\t\t\t// touchinput\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\n\t\t\tevaluateTouches: function (event) {\n\t\t\t\tvar touches = event.touches\n\t\t\t\tvar avg_x = 0.0\n\t\t\t\tvar avg_y = 0.0\n\t\t\t\tvar avg_d = 0.0\n\t\t\t\tvar i,\n\t\t\t\t\tdx,\n\t\t\t\t\tdy,\n\t\t\t\t\tcount = touches.length\n\n\t\t\t\t// center, averaged touch position\n\t\t\t\tfor (i = 0; i < count; i++) {\n\t\t\t\t\tavg_x += touches[i].clientX\n\t\t\t\t\tavg_y += touches[i].clientY\n\t\t\t\t}\n\t\t\t\tavg_x /= count\n\t\t\t\tavg_y /= count\n\n\t\t\t\t// offset, mean distance to center\n\t\t\t\tfor (i = 0; i < count; i++) {\n\t\t\t\t\tdx = avg_x - touches[i].clientX\n\t\t\t\t\tdy = avg_y - touches[i].clientY\n\t\t\t\t\tavg_d += Math.sqrt(dx * dx + dy * dy)\n\t\t\t\t}\n\t\t\t\tavg_d /= count\n\n\t\t\t\tcam.mouse.updateInput(avg_x, avg_y, -avg_d)\n\t\t\t},\n\n\t\t\ttouchstart: function (event) {\n\t\t\t\tevent.preventDefault()\n\t\t\t\tevent.stopPropagation()\n\n\t\t\t\tvar mouse = cam.mouse\n\n\t\t\t\tmouse.evaluateTouches(event)\n\t\t\t\tmouse.istouchdown = mouse.insideViewport(mouse.curr[0], mouse.curr[1])\n\t\t\t\tmouse.isPressed = cam.mouse.istouchdown || cam.mouse.ismousedown\n\n\t\t\t\tmouse.dbltap(event)\n\t\t\t},\n\n\t\t\ttouchmove: function (event) {\n\t\t\t\tevent.preventDefault()\n\t\t\t\tevent.stopPropagation()\n\n\t\t\t\tvar mouse = cam.mouse\n\n\t\t\t\tif (mouse.istouchdown) {\n\t\t\t\t\tmouse.evaluateTouches(event)\n\t\t\t\t\tmouse.solveConstraint()\n\n\t\t\t\t\tif (event.touches.length === 1) {\n\t\t\t\t\t\tmouse.touchmoveSingle()\n\t\t\t\t\t} else {\n\t\t\t\t\t\tmouse.touchmoveMulti()\n\t\t\t\t\t\tmouse.tapcount = 0\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\n\t\t\ttouchend: function (event) {\n\t\t\t\tevent.preventDefault()\n\t\t\t\tevent.stopPropagation()\n\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tmouse.istouchdown = false\n\t\t\t\tmouse.isPressed = mouse.istouchdown || mouse.ismousedown\n\t\t\t\tcam.SHIFT_CONSTRAINT = 0\n\n\t\t\t\tif (mouse.tapcount >= 2) {\n\t\t\t\t\tif (mouse.insideViewport(mouse.curr[0], mouse.curr[1])) {\n\t\t\t\t\t\tcam.reset()\n\t\t\t\t\t}\n\t\t\t\t\tmouse.tapcount = 0\n\t\t\t\t}\n\t\t\t},\n\n\t\t\ttapcount: 0,\n\n\t\t\tdbltap: function (event) {\n\t\t\t\tif (cam.mouse.tapcount++ === 0) {\n\t\t\t\t\tsetTimeout(function () {\n\t\t\t\t\t\tcam.mouse.tapcount = 0\n\t\t\t\t\t}, 350)\n\t\t\t\t}\n\t\t\t},\n\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\t\t\t// keyingput\n\t\t\t//////////////////////////////////////////////////////////////////////////\n\n\t\t\t// key-event for shift constraints\n\t\t\tshiftKey: false,\n\n\t\t\tkeydown: function (event) {\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tif (!mouse.shiftKey) {\n\t\t\t\t\tmouse.shiftKey = event.keyCode === 16\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tkeyup: function (event) {\n\t\t\t\tvar mouse = cam.mouse\n\t\t\t\tif (mouse.shiftKey) {\n\t\t\t\t\tmouse.shiftKey = event.keyCode !== 16\n\t\t\t\t\tif (!mouse.shiftKey) {\n\t\t\t\t\t\tcam.SHIFT_CONSTRAINT = 0\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t}\n\n\t\t// camera mouse listeners\n\t\tthis.attachMouseListeners()\n\n\t\t// P5 registered callbacks, TODO unregister on dispose\n\t\tthis.auto_update = true\n\t\tthis.P5.registerMethod('pre', function () {\n\t\t\tif (cam.auto_update) {\n\t\t\t\tcam.update()\n\t\t\t}\n\t\t})\n\n\t\t// damped camera transition\n\t\tthis.dampedZoom = new DampedAction(function (d) {\n\t\t\tcam.zoom(d * cam.getZoomMult())\n\t\t})\n\t\tthis.dampedPanX = new DampedAction(function (d) {\n\t\t\tcam.panX(d * cam.getPanMult())\n\t\t})\n\t\tthis.dampedPanY = new DampedAction(function (d) {\n\t\t\tcam.panY(d * cam.getPanMult())\n\t\t})\n\t\tthis.dampedPanZ = new DampedAction(function (d) {\n\t\t\tcam.panZ(d * cam.getPanMult())\n\t\t})\n\t\tthis.dampedRotX = new DampedAction(function (d) {\n\t\t\tcam.rotateX(d * cam.getRotationMult())\n\t\t})\n\t\tthis.dampedRotY = new DampedAction(function (d) {\n\t\t\tcam.rotateY(d * cam.getRotationMult())\n\t\t})\n\t\tthis.dampedRotZ = new DampedAction(function (d) {\n\t\t\tcam.rotateZ(d * cam.getRotationMult())\n\t\t})\n\n\t\t// interpolated camera transition\n\t\tthis.timedRot = new Interpolation(cam.setInterpolatedRotation.bind(cam))\n\t\tthis.timedPan = new Interpolation(cam.setInterpolatedCenter.bind(cam))\n\t\tthis.timedzoom = new Interpolation(cam.setInterpolatedDistance.bind(cam))\n\t}\n\n\t/**\n\t * sets the WEBGL renderer the camera is working on\n\t *\n\t * @param {p5.RendererGL} renderer ... p5 WEBGL renderer\n\t */\n\tsetCanvas(renderer) {\n\t\tif (renderer instanceof window.p5.RendererGL) {\n\t\t\t// p5js seems to be not very clear about this\n\t\t\t// ... a bit confusing, so i guess this could change in future releases\n\t\t\tthis.renderer = renderer\n\t\t\tif (renderer._pInst instanceof window.p5) {\n\t\t\t\tthis.graphics = renderer\n\t\t\t} else {\n\t\t\t\tthis.graphics = renderer._pInst\n\t\t\t}\n\t\t\tthis.P5 = this.graphics._pInst\n\t\t} else {\n\t\t\tthis.graphics = undefined\n\t\t\tthis.renderer = undefined\n\t\t}\n\t}\n\n\t/** @return {p5.RendererGL} the currently used renderer */\n\tgetCanvas() {\n\t\treturn this.renderer\n\t}\n\n\tattachListener(el, ev, fx, op) {\n\t\tif (!el || el === fx.el) {\n\t\t\treturn\n\t\t}\n\n\t\tthis.detachListener(fx)\n\n\t\tfx.el = el\n\t\tfx.ev = ev\n\t\tfx.op = op\n\t\tfx.el.addEventListener(fx.ev, fx, fx.op)\n\t}\n\n\tdetachListener(fx) {\n\t\tif (fx.el) {\n\t\t\tfx.el.removeEventListener(fx.ev, fx, fx.op)\n\t\t\tfx.el = undefined\n\t\t}\n\t}\n\n\t/** attaches input-listeners (mouse, touch, key) to the used renderer */\n\tattachMouseListeners(renderer) {\n\t\tvar cam = this.cam\n\t\tvar mouse = cam.mouse\n\n\t\trenderer = renderer || cam.renderer\n\t\tif (renderer) {\n\t\t\tvar op = { passive: false }\n\t\t\tvar el = renderer.elt\n\n\t\t\tcam.attachListener(el, 'mousedown', mouse.mousedown, op)\n\t\t\tcam.attachListener(el, 'mouseup', mouse.mouseup, op)\n\t\t\t// cam.attachListener(el, 'dblclick', mouse.dblclick, op)\n\t\t\tcam.attachListener(el, 'wheel', mouse.wheel, op)\n\t\t\tcam.attachListener(el, 'touchstart', mouse.touchstart, op)\n\t\t\tcam.attachListener(el, 'touchend', mouse.touchend, op)\n\t\t\tcam.attachListener(el, 'touchmove', mouse.touchmove, op)\n\t\t\tcam.attachListener(window, 'keydown', mouse.keydown, op)\n\t\t\tcam.attachListener(window, 'keyup', mouse.keyup, op)\n\t\t}\n\t}\n\n\t/** detaches all attached input-listeners */\n\tremoveMouseListeners() {\n\t\tvar cam = this.cam\n\t\tvar mouse = cam.mouse\n\n\t\tcam.detachListener(mouse.mousedown)\n\t\tcam.detachListener(mouse.mouseup)\n\t\t// cam.detachListener(mouse.dblclick)\n\t\tcam.detachListener(mouse.wheel)\n\t\tcam.detachListener(mouse.keydown)\n\t\tcam.detachListener(mouse.keyup)\n\t\tcam.detachListener(mouse.touchstart)\n\t\tcam.detachListener(mouse.touchend)\n\t\tcam.detachListener(mouse.touchmove)\n\t}\n\n\t/** Disposes/releases the camera. */\n\tdispose() {\n\t\t// // TODO: p5 unregister 'pre', ... not available in 0.5.16\n\t\t// removeMouseListeners();\n\t}\n\n\t/** @return {boolean} the current autoUpdate state */\n\tgetAutoUpdate() {\n\t\treturn this.auto_update\n\t}\n\t/**\n\t * If true, the EasyCam will update automatically in a pre-draw step.\n\t * This updates the camera state and updates the renderers\n\t * modelview/camera matrix.\n\t *\n\t * If false, the update() needs to be called manually.\n\t *\n\t * @param {boolean} the new autoUpdate state\n\t */\n\tsetAutoUpdate(status) {\n\t\tthis.auto_update = status\n\t}\n\n\t/**\n\t * Updates the camera state (interpolated / damped animations) and updates\n\t * the renderers' modelview/camera matrix.\n\t *\n\t * if \"auto_update\" is true, this is called automatically in a pre-draw call.\n\t */\n\tupdate() {\n\t\tvar cam = this.cam\n\t\tvar mouse = cam.mouse\n\n\t\tmouse.mousedrag()\n\n\t\tvar b_update = false\n\t\tb_update |= cam.dampedZoom.update()\n\t\tb_update |= cam.dampedPanX.update()\n\t\tb_update |= cam.dampedPanY.update()\n\t\tb_update |= cam.dampedPanZ.update()\n\t\tb_update |= cam.dampedRotX.update()\n\t\tb_update |= cam.dampedRotY.update()\n\t\tb_update |= cam.dampedRotZ.update()\n\n\t\t// interpolated actions have lower priority then damped actions\n\t\tif (b_update) {\n\t\t\tcam.timedRot.stop()\n\t\t\tcam.timedPan.stop()\n\t\t\tcam.timedzoom.stop()\n\t\t} else {\n\t\t\tcam.timedRot.update()\n\t\t\tcam.timedPan.update()\n\t\t\tcam.timedzoom.update()\n\t\t}\n\n\t\tcam.apply()\n\t}\n\n\t/**\n\t * Applies the current camera state to the renderers' modelview/camera matrix.\n\t * If no argument is given, then the cameras currently set renderer is used.\n\t */\n\tapply(renderer) {\n\t\tvar cam = this.cam\n\t\trenderer = renderer || cam.renderer\n\n\t\tif (renderer) {\n\t\t\tthis.camEYE = this.getPosition(this.camEYE)\n\t\t\tthis.camLAT = this.getCenter(this.camLAT)\n\t\t\tthis.camRUP = this.getUpVector(this.camRUP)\n\n\t\t\tif (undefined === renderer._curCamera)\n\t\t\t\trenderer.camera(\n\t\t\t\t\tthis.camEYE[0],\n\t\t\t\t\tthis.camEYE[1],\n\t\t\t\t\tthis.camEYE[2],\n\t\t\t\t\tthis.camLAT[0],\n\t\t\t\t\tthis.camLAT[1],\n\t\t\t\t\tthis.camLAT[2],\n\t\t\t\t\tthis.camRUP[0],\n\t\t\t\t\tthis.camRUP[1],\n\t\t\t\t\tthis.camRUP[2],\n\t\t\t\t)\n\t\t\telse\n\t\t\t\trenderer._curCamera.camera(\n\t\t\t\t\tthis.camEYE[0],\n\t\t\t\t\tthis.camEYE[1],\n\t\t\t\t\tthis.camEYE[2],\n\t\t\t\t\tthis.camLAT[0],\n\t\t\t\t\tthis.camLAT[1],\n\t\t\t\t\tthis.camLAT[2],\n\t\t\t\t\tthis.camRUP[0],\n\t\t\t\t\tthis.camRUP[1],\n\t\t\t\t\tthis.camRUP[2],\n\t\t\t\t)\n\t\t}\n\t}\n\n\t/** @param {int[]} the new viewport-def, as [x,y,w,h] */\n\tsetViewport(viewport) {\n\t\tthis.viewport = viewport.slice()\n\t}\n\n\t/** @returns {int[]} the current viewport-def, as [x,y,w,h] */\n\tgetViewport() {\n\t\treturn this.viewport\n\t}\n\n\t//\n\t// mouse state changes\n\t//\n\n\t/** implemented zoom-cb for mouswheel handler.*/\n\tmouseWheelZoom() {\n\t\tvar cam = this\n\t\tvar mouse = cam.mouse\n\t\tcam.dampedZoom.addForce(mouse.mwheel * cam.scale_zoomwheel)\n\t}\n\n\t/** implemented zoom-cb for mousedrag/touch handler.*/\n\tmouseDragZoom() {\n\t\tvar cam = this\n\t\tvar mouse = cam.mouse\n\t\tcam.dampedZoom.addForce(-mouse.dist[2])\n\t}\n\n\t/** implemented pan-cb for mousedrag/touch handler.*/\n\tmouseDragPan() {\n\t\tvar cam = this\n\t\tvar mouse = cam.mouse\n\n\t\tcam.dampedPanX.addForce(cam.DRAG_CONSTRAINT & cam.AXIS.YAW ? mouse.dist[0] : 0)\n\t\tcam.dampedPanY.addForce(cam.DRAG_CONSTRAINT & cam.AXIS.PITCH ? mouse.dist[1] : 0)\n\t}\n\n\t/** implemented rotate-cb for mousedrag/touch handler.*/\n\tmouseDragRotate() {\n\t\tvar cam = this\n\t\tvar mouse = cam.mouse\n\n\t\tvar mx = mouse.curr[0],\n\t\t\tmy = mouse.curr[1]\n\t\tvar dx = mouse.dist[0],\n\t\t\tdy = mouse.dist[1]\n\n\t\t// mouse [-1, +1]\n\t\tvar mxNdc = Math.min(Math.max((mx - cam.viewport[0]) / cam.viewport[2], 0), 1) * 2 - 1\n\t\tvar myNdc = Math.min(Math.max((my - cam.viewport[1]) / cam.viewport[3], 0), 1) * 2 - 1\n\n\t\tif (cam.DRAG_CONSTRAINT & cam.AXIS.YAW) {\n\t\t\tcam.dampedRotY.addForce(+dx * (1.0 - myNdc * myNdc))\n\t\t}\n\t\tif (cam.DRAG_CONSTRAINT & cam.AXIS.PITCH) {\n\t\t\tcam.dampedRotX.addForce(-dy * (1.0 - mxNdc * mxNdc))\n\t\t}\n\t\tif (cam.DRAG_CONSTRAINT & cam.AXIS.ROLL) {\n\t\t\tcam.dampedRotZ.addForce(-dx * myNdc)\n\t\t\tcam.dampedRotZ.addForce(+dy * mxNdc)\n\t\t}\n\t}\n\n\t//\n\t// damped multipliers\n\t//\n\t/** (private) returns the used zoom -multiplier for damped actions. */\n\tgetZoomMult() {\n\t\treturn this.state.distance * this.scale_zoom\n\t}\n\t/** (private) returns the used pan-multiplier for damped actions. */\n\tgetPanMult() {\n\t\treturn this.state.distance * this.scale_pan\n\t}\n\t/** (private) returns the used rotate-multiplier for damped actions. */\n\tgetRotationMult() {\n\t\treturn Math.pow(Math.log10(1 + this.state.distance), 0.5) * this.scale_rotation\n\t}\n\n\t//\n\t// damped state changes\n\t//\n\t/** Applies a change to the current zoom.  */\n\tzoom(dz) {\n\t\tvar cam = this.cam\n\t\tvar distance_tmp = cam.state.distance + dz\n\n\t\t// check lower bound\n\t\tif (distance_tmp < cam.distance_min) {\n\t\t\tdistance_tmp = cam.distance_min\n\t\t\tcam.dampedZoom.stop()\n\t\t}\n\n\t\t// check upper bound\n\t\tif (distance_tmp > cam.distance_max) {\n\t\t\tdistance_tmp = cam.distance_max\n\t\t\tcam.dampedZoom.stop()\n\t\t}\n\n\t\tcam.state.distance = distance_tmp\n\t}\n\n\t/** Applies a change to the current pan-xValue.  */\n\tpanX(dx) {\n\t\tvar state = this.cam.state\n\t\tif (dx) {\n\t\t\tvar val = Rotation.applyToVec3(state.rotation, [dx, 0, 0])\n\t\t\tVec3.add(state.center, val, state.center)\n\t\t}\n\t}\n\n\t/** Applies a change to the current pan-yValue.  */\n\tpanY(dy) {\n\t\tvar state = this.cam.state\n\t\tif (dy) {\n\t\t\tvar val = Rotation.applyToVec3(state.rotation, [0, dy, 0])\n\t\t\tVec3.add(state.center, val, state.center)\n\t\t}\n\t}\n\n\tpanZ(dz) {\n\t\tvar state = this.cam.state\n\t\tif (dz) {\n\t\t\tvar val = Rotation.applyToVec3(state.rotation, [0, 0, dz])\n\t\t\tVec3.add(state.center, val, state.center)\n\t\t}\n\t}\n\n\tpanGround(dx, dy, dz) {\n\t\tconst ca = this.centerAxes()\n\t\tVec3.mult(ca.x, dx, ca.x)\n\t\tVec3.mult(ca.z, dz, ca.z)\n\t\tconst val = [0, 0, 0]\n\t\tVec3.add(ca.x, ca.z, val)\n\t\tval[1] = dy\n\t\tVec3.add(this.cam.state.center, val, this.cam.state.center)\n\t}\n\n\tcenterAxes() {\n\t\tconst state = this.cam.state\n\t\t// Get world unit vector for screen-space X axis\n\t\tconst screenX = Rotation.applyToVec3(state.rotation, [1, 0, 0])\n\t\tscreenX[1] = 0 // project X vector onto ground plane\n\t\t// normalize post-projection vector\n\t\tlet mX = Vec3.mag(screenX)\n\t\tif (mX === 0) {\n\t\t\tconsole.warn('[EasyCam] No magnitude for screenX vector', screenX)\n\t\t\tmX = 1\n\t\t}\n\t\tVec3.mult(screenX, 1.0 / mX, screenX)\n\t\t// Get Z vector: cross-product of X with UP (Y)\n\t\tconst screenZ = [0, 0, 0]\n\t\tVec3.cross(screenX, [0, 1, 0], screenZ)\n\t\t// Multiply ground-plane vectors by arguments, apply to camera state\n\t\treturn {\n\t\t\tx: screenX,\n\t\t\ty: [0, 1, 0],\n\t\t\tz: screenZ,\n\t\t}\n\t}\n\n\t/** Applies a change to the current pan-value.  */\n\tpan(dx, dy, dz) {\n\t\tthis.cam.panX(dx)\n\t\tthis.cam.panY(dy)\n\t\tthis.cam.panZ(dz)\n\t}\n\n\t/** Applies a change to the current xRotation.  */\n\trotateX(rx) {\n\t\tthis.cam.rotate([1, 0, 0], rx)\n\t}\n\n\t/** Applies a change to the current yRotation.  */\n\trotateY(ry) {\n\t\tthis.cam.rotate([0, 1, 0], ry)\n\t}\n\n\t/** Applies a change to the current zRotation.  */\n\trotateZ(rz) {\n\t\tthis.cam.rotate([0, 0, 1], rz)\n\t}\n\n\t/** Applies a change to the current rotation, using the given axis/angle.  */\n\trotate(axis, angle) {\n\t\tvar state = this.cam.state\n\t\tif (angle) {\n\t\t\tvar new_rotation = Rotation.create({ axis: axis, angle: angle })\n\t\t\tRotation.applyToRotation(state.rotation, new_rotation, state.rotation)\n\t\t}\n\t}\n\n\t//\n\t// interpolated states\n\t//\n\t/** Sets the new camera-distance, interpolated (t) between given A and B. */\n\tsetInterpolatedDistance(valA, valB, t) {\n\t\tthis.cam.state.distance = Scalar.mix(valA, valB, Scalar.smoothstep(t))\n\t}\n\t/** Sets the new camera-center, interpolated (t) between given A and B. */\n\tsetInterpolatedCenter(valA, valB, t) {\n\t\tthis.cam.state.center = Vec3.mix(valA, valB, Scalar.smoothstep(t))\n\t}\n\t/** Sets the new camera-rotation, interpolated (t) between given A and B. */\n\tsetInterpolatedRotation(valA, valB, t) {\n\t\tthis.cam.state.rotation = Rotation.slerp(valA, valB, t)\n\t}\n\n\t//\n\t// DISTANCE\n\t//\n\t/** Sets the minimum camera distance. */\n\tsetDistanceMin(distance_min) {\n\t\tthis.distance_min = Math.max(distance_min, this.distance_min_limit)\n\t\tthis.zoom(0) // update, to ensure new minimum\n\t}\n\n\t/** Sets the maximum camera distance. */\n\tsetDistanceMax(distance_max) {\n\t\tthis.distance_max = distance_max\n\t\tthis.zoom(0) // update, to ensure new maximum\n\t}\n\n\t/**\n\t * Sets the new camera distance.\n\t *\n\t * @param {double} new distance.\n\t * @param {long} animation time in millis.\n\t */\n\tsetDistance(distance, duration) {\n\t\tthis.timedzoom.start(this.state.distance, distance, duration, [this.dampedZoom])\n\t}\n\n\t/** @returns {double} the current camera distance. */\n\tgetDistance() {\n\t\treturn this.state.distance\n\t}\n\n\t//\n\t// CENTER / LOOK AT\n\t//\n\t/**\n\t * Sets the new camera center.\n\t *\n\t * @param {double[]} new center.\n\t * @param {long} animation time in millis.\n\t */\n\tsetCenter(center, duration) {\n\t\tthis.timedPan.start(this.state.center, center, duration, [this.dampedPanX, this.dampedPanY])\n\t}\n\n\t/** @returns {double[]} the current camera center. */\n\tgetCenter() {\n\t\treturn this.state.center\n\t}\n\n\t//\n\t// ROTATION\n\t//\n\t/**\n\t * Sets the new camera rotation (quaternion).\n\t *\n\t * @param {double[]} new rotation as quat[q0,q1,q2,q3].\n\t * @param {long} animation time in millis.\n\t */\n\tsetRotation(rotation, duration) {\n\t\tthis.timedRot.start(this.state.rotation, rotation, duration, [\n\t\t\tthis.dampedRotX,\n\t\t\tthis.dampedRotY,\n\t\t\tthis.dampedRotZ,\n\t\t])\n\t}\n\n\t/** @returns {double[]} the current camera rotation as quat[q0,q1,q2,q3]. */\n\tgetRotation() {\n\t\treturn this.state.rotation\n\t}\n\n\t//\n\t// CAMERA POSITION/EYE\n\t//\n\t/** @returns {double[]} the current camera position, aka. the eye position. */\n\tgetPosition(dst) {\n\t\tvar cam = this.cam\n\t\tvar state = cam.state\n\n\t\tdst = Vec3.assert(dst)\n\t\tRotation.applyToVec3(state.rotation, cam.LOOK, dst)\n\t\tVec3.mult(dst, state.distance, dst)\n\t\tVec3.add(dst, state.center, dst)\n\n\t\treturn dst\n\t}\n\n\t//\n\t// CAMERA UP\n\t//\n\t/** @returns {double[]} the current camera up vector. */\n\tgetUpVector(dst) {\n\t\tvar cam = this.cam\n\t\tvar state = cam.state\n\t\tdst = Vec3.assert(dst)\n\t\tRotation.applyToVec3(state.rotation, cam.UP, dst)\n\t\treturn dst\n\t}\n\n\t//\n\t// STATE (rotation, center, distance)\n\t//\n\t/** @returns {Object} a copy of the camera state {distance,center,rotation} */\n\tgetState() {\n\t\treturn this.state.copy()\n\t}\n\t/**\n\t * @param {Object} a new camera state {distance,center,rotation}.\n\t * @param {long} animation time in millis.\n\t */\n\tsetState(other, duration) {\n\t\tif (other) {\n\t\t\tthis.setDistance(other.distance, duration)\n\t\t\tthis.setCenter(other.center, duration)\n\t\t\tthis.setRotation(other.rotation, duration)\n\t\t}\n\t}\n\n\tpushState() {\n\t\treturn (this.state_pushed = this.getState())\n\t}\n\tpopState(duration) {\n\t\tthis.setState(this.state_pushed, duration)\n\t}\n\n\t/** sets the current state as reset-state. */\n\tpushResetState() {\n\t\treturn (this.state_reset = this.getState())\n\t}\n\t/** resets the camera, by applying the reset-state. */\n\treset(duration) {\n\t\tthis.setState(this.state_reset, duration)\n\t}\n\n\t/** sets the rotation scale/speed. */\n\tsetRotationScale(scale_rotation) {\n\t\tthis.scale_rotation = scale_rotation\n\t}\n\t/** sets the pan scale/speed. */\n\tsetPanScale(scale_pan) {\n\t\tthis.scale_pan = scale_pan\n\t}\n\t/** sets the zoom scale/speed. */\n\tsetZoomScale(scale_zoom) {\n\t\tthis.scale_zoom = scale_zoom\n\t}\n\t/** sets the wheel scale/speed. */\n\tsetWheelScale(wheelScale) {\n\t\tthis.scale_zoomwheel = wheelScale\n\t}\n\t/** @returns the rotation scale/speed. */\n\tgetRotationScale() {\n\t\treturn this.scale_rotation\n\t}\n\t/** @returns the pan scale/speed. */\n\tgetPanScale() {\n\t\treturn this.scale_pan\n\t}\n\t/** @returns the zoom scale/speed. */\n\tgetZoomScale() {\n\t\treturn this.scale_zoom\n\t}\n\t/** @returns the wheel scale/speed. */\n\tgetWheelScale() {\n\t\treturn this.scale_zoomwheel\n\t}\n\n\t/** sets the default damping scale/speed. */\n\tsetDamping(damping) {\n\t\tthis.dampedZoom.damping = damping\n\t\tthis.dampedPanX.damping = damping\n\t\tthis.dampedPanY.damping = damping\n\t\tthis.dampedPanZ.damping = damping\n\t\tthis.dampedRotX.damping = damping\n\t\tthis.dampedRotY.damping = damping\n\t\tthis.dampedRotZ.damping = damping\n\t}\n\t/** sets the default interpolation time in millis. */\n\tsetDefaultInterpolationTime(duration) {\n\t\tthis.timedRot.default_duration = duration\n\t\tthis.timedPan.default_duration = duration\n\t\tthis.timedzoom.default_duration = duration\n\t}\n\n\t/**\n\t * sets the rotation constraint for each axis separately.\n\t *\n\t * @param {boolean} yaw constraint\n\t * @param {boolean} pitch constraint\n\t * @param {boolean} roll constraint\n\t */\n\tsetRotationConstraint(yaw, pitch, roll) {\n\t\tvar cam = this.cam\n\t\tcam.FIXED_CONSTRAINT = 0\n\t\tcam.FIXED_CONSTRAINT |= yaw ? cam.AXIS.YAW : 0\n\t\tcam.FIXED_CONSTRAINT |= pitch ? cam.AXIS.PITCH : 0\n\t\tcam.FIXED_CONSTRAINT |= roll ? cam.AXIS.ROLL : 0\n\t}\n\n\t/**\n\t *\n\t * begin screen-aligned 2D-drawing.\n\t *\n\t * <pre>\n\t * beginHUD()\n\t *   disabled depth test\n\t *   ortho\n\t *   ... your code is executed here ...\n\t * endHUD()\n\t * </pre>\n\t *\n\t */\n\tbeginHUD(renderer, w, h) {\n\t\tvar cam = this.cam\n\t\trenderer = renderer || cam.renderer\n\n\t\tif (!renderer) return\n\t\tthis.pushed_rendererState = renderer.push()\n\n\t\tvar gl = renderer.drawingContext\n\t\tconst ww = w !== undefined ? w : renderer.width\n\t\tconst hh = h !== undefined ? h : renderer.height\n\t\tvar d = Number.MAX_VALUE\n\n\t\tgl.flush()\n\t\t// gl.finish();\n\n\t\t// 1) disable DEPTH_TEST\n\t\tgl.disable(gl.DEPTH_TEST)\n\t\t// 2) push modelview/projection\n\t\t//    p5 is not creating a push/pop stack\n\t\tthis.pushed_uMVMatrix = renderer.uMVMatrix.copy()\n\t\tthis.pushed_uPMatrix = renderer.uPMatrix.copy()\n\n\t\t// 3) set new modelview (identity)\n\t\trenderer.resetMatrix()\n\t\t// 4) set new projection (ortho)\n\t\trenderer._curCamera.ortho(0, ww, -hh, 0, -d, +d)\n\t\t// renderer.ortho();\n\t\t// renderer.translate(-w/2, -h/2);\n\t}\n\n\t/**\n\t *\n\t * end screen-aligned 2D-drawing.\n\t *\n\t */\n\tendHUD(renderer) {\n\t\tvar cam = this.cam\n\t\trenderer = renderer || cam.renderer\n\n\t\tif (!renderer) return\n\n\t\tvar gl = renderer.drawingContext\n\n\t\tgl.flush()\n\t\t// gl.finish();\n\n\t\t// 2) restore modelview/projection\n\t\trenderer.uMVMatrix.set(this.pushed_uMVMatrix)\n\t\trenderer.uPMatrix.set(this.pushed_uPMatrix)\n\t\t// 1) enable DEPTH_TEST\n\t\tgl.enable(gl.DEPTH_TEST)\n\t\trenderer.pop(this.pushed_rendererState)\n\t}\n}\n\n/**\n * Damped callback, that accepts the resulting damped/smooth value.\n *\n * @callback dampedCallback\n * @param {double} value - the damped/smoothed value\n *\n */\n\n/**\n *\n * DampedAction, for smoothly changing a value to zero.\n *\n * @param {dampedCallback} cb - callback that accepts the damped value as argument.\n */\nclass DampedAction {\n\t/**  @constructor */\n\tconstructor(cb) {\n\t\tthis.value = 0.0\n\t\tthis.damping = 0.85\n\t\tthis.action = cb\n\t}\n\n\t/** adds a value to the current value beeing damped.\n\t * @param {double} force - the value beeing added.\n\t */\n\taddForce(force) {\n\t\tthis.value += force\n\t}\n\n\t/** updates the damping and calls {@link damped-callback}. */\n\tupdate() {\n\t\tvar active = this.value * this.value > 0.000001\n\t\tif (active) {\n\t\t\tthis.action(this.value)\n\t\t\tthis.value *= this.damping\n\t\t} else {\n\t\t\tthis.stop()\n\t\t}\n\t\treturn active\n\t}\n\n\t/** stops the damping. */\n\tstop() {\n\t\tthis.value = 0.0\n\t}\n}\n\n/**\n * Interpolation callback, that implements any form of interpolation between\n * two values A and B and the interpolationparameter t.\n * <pre>\n *   linear: A * (1-t) + B * t\n *   smooth, etc...\n * </pre>\n * @callback interpolationCallback\n * @param {Object} A - First Value\n * @param {Object} B - Second Value\n * @param {double} t - interpolation parameter [0, 1]\n *\n */\n\n/**\n *\n * Interpolation, for smoothly changing a value by interpolating it over time.\n *\n * @param {interpolationCallback} cb - callback for interpolating between two values.\n */\nclass Interpolation {\n\t/**  @constructor */\n\tconstructor(cb) {\n\t\tthis.default_duration = 300\n\t\tthis.action = cb\n\t}\n\n\t/** starts the interpolation.\n\t *  If the given interpolation-duration is 0, then\n\t * {@link interpolation-callback} is called immediately.\n\t */\n\tstart(valA, valB, duration, actions) {\n\t\tfor (var x in actions) {\n\t\t\tactions[x].stop()\n\t\t}\n\t\tthis.valA = valA\n\t\tthis.valB = valB\n\t\tthis.duration = duration === undefined ? this.default_duration : duration\n\t\tthis.timer = new Date().getTime()\n\t\tthis.active = this.duration > 0\n\t\tif (!this.active) {\n\t\t\tthis.interpolate(1)\n\t\t}\n\t}\n\n\t/** updates the interpolation and calls {@link interpolation-callback}.*/\n\tupdate() {\n\t\tif (this.active) {\n\t\t\tvar t = (new Date().getTime() - this.timer) / this.duration\n\t\t\tif (t > 0.995) {\n\t\t\t\tthis.interpolate(1)\n\t\t\t\tthis.stop()\n\t\t\t} else {\n\t\t\t\tthis.interpolate(t)\n\t\t\t}\n\t\t}\n\t}\n\n\tinterpolate(t) {\n\t\tthis.action(this.valA, this.valB, t)\n\t}\n\n\t/** stops the interpolation. */\n\tstop() {\n\t\tthis.active = false\n\t}\n}\n\n////////////////////////////////////////////////////////////////////////////////\n//\n// ROTATION (Quaternion)\n//\n////////////////////////////////////////////////////////////////////////////////\n/**\n * Rotation as Quaternion [q0, q1, q2, q3]\n *\n * Note: Only functions that were required for the EasyCam to work are implemented.\n *\n * @namespace\n */\nvar Rotation = {\n\tassert: function (dst) {\n\t\treturn dst === undefined || dst.constructor !== Array ? [1, 0, 0, 0] : dst\n\t},\n\n\t/** @returns {Number[]} an identity rotation [1,0,0,0] */\n\tidentity: function () {\n\t\treturn [1, 0, 0, 0]\n\t},\n\n\t/**\n\t * Applies the rotation to a vector and returns dst or a new vector.\n\t *\n\t * @param {Number[]} rot - Rotation (Quaternion)\n\t * @param {Number[]} vec - vector to be rotated by rot\n\t * @param {Number[]} dst - resulting vector\n\t * @returns {Number[]} dst- resulting vector\n\t */\n\tapplyToVec3: function (rot, vec, dst) {\n\t\tvar [x, y, z] = vec\n\t\tvar [q0, q1, q2, q3] = rot\n\n\t\tvar s = q1 * x + q2 * y + q3 * z\n\n\t\tdst = Vec3.assert(dst)\n\t\tdst[0] = 2 * (q0 * (x * q0 - (q2 * z - q3 * y)) + s * q1) - x\n\t\tdst[1] = 2 * (q0 * (y * q0 - (q3 * x - q1 * z)) + s * q2) - y\n\t\tdst[2] = 2 * (q0 * (z * q0 - (q1 * y - q2 * x)) + s * q3) - z\n\t\treturn dst\n\t},\n\n\t/**\n\t * Applies the rotation to another rotation and returns dst or a new rotation.\n\t *\n\t * @param {Number[]} rotA - RotationA (Quaternion)\n\t * @param {Number[]} rotB - RotationB (Quaternion)\n\t * @param {Number[]} dst - resulting rotation\n\t * @returns {Number[]} dst - resulting rotation\n\t */\n\tapplyToRotation(rotA, rotB, dst) {\n\t\tvar [a0, a1, a2, a3] = rotA\n\t\tvar [b0, b1, b2, b3] = rotB\n\n\t\tdst = Rotation.assert(dst)\n\t\tdst[0] = b0 * a0 - (b1 * a1 + b2 * a2 + b3 * a3)\n\t\tdst[1] = b1 * a0 + b0 * a1 + (b2 * a3 - b3 * a2)\n\t\tdst[2] = b2 * a0 + b0 * a2 + (b3 * a1 - b1 * a3)\n\t\tdst[3] = b3 * a0 + b0 * a3 + (b1 * a2 - b2 * a1)\n\t\treturn dst\n\t},\n\n\t/**\n\t * Interpolates a rotation.\n\t *\n\t * @param {Number[]} rotA - RotationA (Quaternion)\n\t * @param {Number[]} rotB - RotationB (Quaternion)\n\t * @param {Number  } t - interpolation parameter\n\t * @param {Number[]} dst - resulting rotation\n\t * @returns {Number[]} dst - resulting rotation\n\t */\n\tslerp: function (rotA, rotB, t, dst) {\n\t\tvar [a0, a1, a2, a3] = rotA\n\t\tvar [b0, b1, b2, b3] = rotB\n\n\t\tvar cosTheta = a0 * b0 + a1 * b1 + a2 * b2 + a3 * b3\n\t\tif (cosTheta < 0) {\n\t\t\tb0 = -b0\n\t\t\tb1 = -b1\n\t\t\tb2 = -b2\n\t\t\tb3 = -b3\n\t\t\tcosTheta = -cosTheta\n\t\t}\n\n\t\tvar theta = Math.acos(cosTheta)\n\t\tvar sinTheta = Math.sqrt(1.0 - cosTheta * cosTheta)\n\n\t\tvar w1, w2\n\t\tif (sinTheta > 0.001) {\n\t\t\tw1 = Math.sin((1.0 - t) * theta) / sinTheta\n\t\t\tw2 = Math.sin(t * theta) / sinTheta\n\t\t} else {\n\t\t\tw1 = 1.0 - t\n\t\t\tw2 = t\n\t\t}\n\n\t\tdst = Rotation.assert(dst)\n\t\tdst[0] = w1 * a0 + w2 * b0\n\t\tdst[1] = w1 * a1 + w2 * b1\n\t\tdst[2] = w1 * a2 + w2 * b2\n\t\tdst[3] = w1 * a3 + w2 * b3\n\n\t\treturn Rotation.create({ rotation: dst, normalize: true }, dst)\n\t},\n\n\t/**\n\t * Creates/Initiates a new Rotation\n\t *\n\t * <pre>\n\t *\n\t *    1) Axis,Angle:\n\t *       {\n\t *         axis : [x, y, z],\n\t *         angle: double\n\t *       }\n\t *\n\t *    2) Another Rotation:\n\t *       {\n\t *         rotation : [q0, q1, q2, q3],\n\t *         normalize: boolean\n\t *       }\n\t *\n\t *    3) 3 euler angles, XYZ-order:\n\t *       {\n\t *         angles_xyz : [rX, rY, rZ]\n\t *       }\n\t *\n\t * </pre>\n\t *\n\t *\n\t * @param {Object} def - Definition, for creating the new Rotation\n\t * @param {Number[]} dst - resulting rotation\n\t * @returns {Number[]} dst - resulting rotation\n\t */\n\tcreate: function (def, dst) {\n\t\tdst = Rotation.assert(dst)\n\n\t\t// 1) from axis and angle\n\t\tif (def.axis) {\n\t\t\tvar axis = def.axis\n\t\t\tvar angle = def.angle\n\n\t\t\tvar norm = Vec3.mag(axis)\n\t\t\tif (norm === 0.0) return // vector is of zero length\n\n\t\t\tvar halfAngle = -0.5 * angle\n\t\t\tvar coeff = Math.sin(halfAngle) / norm\n\n\t\t\tdst[0] = Math.cos(halfAngle)\n\t\t\tdst[1] = coeff * axis[0]\n\t\t\tdst[2] = coeff * axis[1]\n\t\t\tdst[3] = coeff * axis[2]\n\t\t\treturn dst\n\t\t}\n\n\t\t// 2) from another rotation\n\t\tif (def.rotation) {\n\t\t\tdst[0] = def.rotation[0]\n\t\t\tdst[1] = def.rotation[1]\n\t\t\tdst[2] = def.rotation[2]\n\t\t\tdst[3] = def.rotation[3]\n\n\t\t\tif (def.normalize) {\n\t\t\t\tvar inv =\n\t\t\t\t\t1.0 / Math.sqrt(dst[0] * dst[0] + dst[1] * dst[1] + dst[2] * dst[2] + dst[3] * dst[3])\n\t\t\t\tdst[0] *= inv\n\t\t\t\tdst[1] *= inv\n\t\t\t\tdst[2] *= inv\n\t\t\t\tdst[3] *= inv\n\t\t\t}\n\n\t\t\treturn dst\n\t\t}\n\n\t\t// 3) from 3 euler angles, order XYZ\n\t\tif (def.angles_xyz) {\n\t\t\tvar ax = -0.5 * def.angles_xyz[0]\n\t\t\tvar ay = -0.5 * def.angles_xyz[1]\n\t\t\tvar az = -0.5 * def.angles_xyz[2]\n\n\t\t\tvar rotX = [Math.cos(ax), Math.sin(ax), 0, 0]\n\t\t\tvar rotY = [Math.cos(ay), 0, Math.sin(ay), 0]\n\t\t\tvar rotZ = [Math.cos(az), 0, 0, Math.sin(az)]\n\n\t\t\tRotation.applyToRotation(rotY, rotZ, dst)\n\t\t\tRotation.applyToRotation(rotX, dst, dst)\n\n\t\t\treturn dst\n\t\t}\n\t},\n\n\t//\n\t// ... to be continued ...\n\t//\n}\n\n////////////////////////////////////////////////////////////////////////////////\n//\n// SCALAR\n//\n////////////////////////////////////////////////////////////////////////////////\n/**\n * Scalar as a simple number.\n *\n * Note: Only functions that were required for the EasyCam to work are implemented.\n *\n * @namespace\n */\nvar Scalar = {\n\t/**\n\t * Linear interpolation between A and B using t[0,1]\n\t */\n\tmix: function (a, b, t) {\n\t\treturn a * (1 - t) + b * t\n\t},\n\n\t/**\n\t * modifying t as a function of smoothstep(0,1,t);\n\t */\n\tsmoothstep: function (x) {\n\t\treturn x * x * (3 - 2 * x)\n\t},\n\n\t/**\n\t * modifying t as a function of smootherstep(0,1,t);\n\t */\n\tsmootherstep: function (x) {\n\t\treturn x * x * x * (x * (x * 6 - 15) + 10)\n\t},\n}\n\n////////////////////////////////////////////////////////////////////////////////\n//\n// VEC3\n//\n////////////////////////////////////////////////////////////////////////////////\n/**\n * Vec3 as a 3D vector (Array)\n *\n * @namespace\n */\nvar Vec3 = {\n\tassert: function (dst) {\n\t\treturn dst === undefined || dst.constructor !== Array ? [0, 0, 0] : dst\n\t},\n\n\tisScalar: function (arg) {\n\t\t// TODO: do some profiling to figure out what fails\n\t\treturn arg !== undefined && arg.constructor !== Array\n\t\t// return typeof(arg) === 'number';\n\t},\n\n\t/** addition: <pre> dst = a + b </pre>  */\n\tadd: function (a, b, dst) {\n\t\tdst = this.assert(dst)\n\t\tif (this.isScalar(b)) {\n\t\t\tdst[0] = a[0] + b\n\t\t\tdst[1] = a[1] + b\n\t\t\tdst[2] = a[2] + b\n\t\t} else {\n\t\t\tdst[0] = a[0] + b[0]\n\t\t\tdst[1] = a[1] + b[1]\n\t\t\tdst[2] = a[2] + b[2]\n\t\t}\n\t\treturn dst\n\t},\n\n\t/** componentwise multiplication: <pre> dst = a * b </pre>  */\n\tmult: function (a, b, dst) {\n\t\tdst = this.assert(dst)\n\t\tif (this.isScalar(b)) {\n\t\t\tdst[0] = a[0] * b\n\t\t\tdst[1] = a[1] * b\n\t\t\tdst[2] = a[2] * b\n\t\t} else {\n\t\t\tdst[0] = a[0] * b[0]\n\t\t\tdst[1] = a[1] * b[1]\n\t\t\tdst[2] = a[2] * b[2]\n\t\t}\n\t\treturn dst\n\t},\n\n\t/** squared length  */\n\tmagSq: function (a) {\n\t\treturn a[0] * a[0] + a[1] * a[1] + a[2] * a[2]\n\t},\n\n\t/** length  */\n\tmag: function (a) {\n\t\treturn Math.sqrt(a[0] * a[0] + a[1] * a[1] + a[2] * a[2])\n\t},\n\n\t/** dot-product  */\n\tdot: function (a, b) {\n\t\treturn a[0] * b[0] + a[1] * b[1] + a[2] * b[2]\n\t},\n\n\t/** cross-product  */\n\tcross: function (a, b, dst) {\n\t\tdst = this.assert(dst)\n\t\tdst[0] = a[1] * b[2] - a[2] * b[1]\n\t\tdst[1] = a[2] * b[0] - a[0] * b[2]\n\t\tdst[2] = a[0] * b[1] - a[1] * b[0]\n\t\treturn dst\n\t},\n\n\t/** angle  */\n\tangle: function (v1, v2) {\n\t\tvar normProduct = this.mag(v1) * this.mag(v2)\n\t\tif (normProduct === 0.0) {\n\t\t\treturn 0.0 // at least one vector is of zero length\n\t\t}\n\n\t\tvar dot = this.dot(v1, v2)\n\t\tvar threshold = normProduct * 0.9999\n\t\tif (dot < -threshold || dot > threshold) {\n\t\t\t// the vectors are almost aligned, compute using the sine\n\t\t\tvar v3 = this.cross(v1, v2)\n\t\t\tif (dot >= 0) {\n\t\t\t\treturn Math.asin(this.mag(v3) / normProduct)\n\t\t\t} else {\n\t\t\t\treturn Math.PI - Math.asin(this.mag(v3) / normProduct)\n\t\t\t}\n\t\t}\n\n\t\t// the vectors are sufficiently separated to use the cosine\n\t\treturn Math.acos(dot / normProduct)\n\t},\n\n\t/** linear interpolation: <pre> dst = a * (1 - t) + b * t </pre> */\n\tmix(a, b, t, dst) {\n\t\tdst = this.assert(dst)\n\t\tdst[0] = Scalar.mix(a[0], b[0], t)\n\t\tdst[1] = Scalar.mix(a[1], b[1], t)\n\t\tdst[2] = Scalar.mix(a[2], b[2], t)\n\t\treturn dst\n\t},\n\n\t//\n\t// ... to be continued ...\n\t//\n}\n\n////////////////////////////////////////////////////////////////////////////////\n//\n// public objects\n//\n////////////////////////////////////////////////////////////////////////////////\n\n/**\n * @static\n */\nEasyCam.INFO = INFO // make static\nObject.freeze(INFO) // and constant\n\n// ext = (ext !== undefined) ? ext : {};\n\n/**\n * @memberof Dw\n */\next.EasyCam = EasyCam\n/**\n * @memberof Dw\n */\next.DampedAction = DampedAction\n/**\n * @memberof Dw\n */\next.Interpolation = Interpolation\n/**\n * @memberof Dw\n */\next.Rotation = Rotation\n/**\n * @memberof Dw\n */\next.Vec3 = Vec3\n/**\n * @memberof Dw\n */\next.Scalar = Scalar\n\n// return ext;\n//\n//\n// })(Dw);\n\n// export const { DampedAction, Interpolation, Rotation, Vec3, Scalar } = ext\nexport default ext\n\n// /**\n//  * @submodule Camera\n//  * @for p5\n//  */\n//\n// if(p5){\n//\n//\n//   /**\n//    * p5.EasyCam creator function.\n//    * Arguments are optional, and equal to the default EasyCam constructor.\n//    * @return {EasyCam} a new EasyCam\n//    */\n//   p5.prototype.createEasyCam = function(/* p5.RendererGL, {state} */){\n//\n//     var renderer = this._renderer;\n//     var args     = arguments[0];\n//\n//     if(arguments[0] instanceof p5.RendererGL){\n//       renderer = arguments[0];\n//       args     = arguments[1]; // could still be undefined, which is fine\n//     }\n//\n//     return new Dw.EasyCam(renderer, args);\n//   }\n// }\n","import * as p5 from 'p5'\nimport Sketch from './Sketch'\nimport { clockUpdateReq, ClockOpts } from './serverApi/serverClock'\n\nconst userInputsY = 40\n\nfunction msToString(ms: number) {\n\tif (ms < 0.001) {\n\t\treturn `${(ms * 1000).toFixed(1)}µs`\n\t} else if (ms < 1) {\n\t\treturn `${(ms * 1000).toFixed(0)}µs`\n\t} else if (ms < 10) {\n\t\treturn `${ms.toFixed(1)}ms`\n\t}\n\treturn `${ms.toFixed(0)}ms`\n}\n\nexport class SketchInputs {\n\tparent: Sketch\n\tpp?: p5\n\tnameCustomized = false\n\tinputs: {\n\t\t// DOM input elements\n\t\tname?: any\n\t\tinstrument?: any\n\t\tinputDevice?: any\n\t\toffset?: any\n\t\tbpm?: any\n\t\thide?: any\n\t\thideLoops?: any\n\t\thideDial?: any\n\t\tshowHelp?: any\n\t} = {}\n\thidden = false\n\tclockOpts: ClockOpts = {\n\t\tbpm: 95,\n\t}\n\thelp = false\n\thelpRetoggle = {\n\t\tloops: true,\n\t\tdial: true,\n\t}\n\thelpImg?: p5.Image\n\n\tconstructor(parent: Sketch, loadedFromStorage = false) {\n\t\tthis.parent = parent\n\t\tthis.nameCustomized = loadedFromStorage\n\t}\n\n\tbpm = () => (this.inputs.bpm ? this.inputs.bpm.value() : this.clockOpts.bpm)\n\n\tisFocused = () => {\n\t\tfor (const key in this.inputs) {\n\t\t\tconst input = (this.inputs as any)[key]\n\t\t\tif (input && input.focused) {\n\t\t\t\treturn true\n\t\t\t}\n\t\t}\n\t\treturn false\n\t}\n\n\ttoggleHide = () => {\n\t\tif (!this.pp) {\n\t\t\treturn\n\t\t}\n\t\tthis.hidden = !this.hidden\n\t\tthis.setup(this.pp)\n\t\tif (!this.hidden) {\n\t\t\tthis.setupInputsBPM()\n\t\t}\n\t}\n\n\tsetup = (pp: p5) => {\n\t\tthis.pp = pp\n\t\tif (!this.helpImg) {\n\t\t\tthis.helpImg = pp.loadImage('/help-overlay.png')\n\t\t}\n\t\tif (this.hidden || this.help) {\n\t\t\tfor (const key in this.inputs) {\n\t\t\t\tconst input = (this.inputs as any)[key]\n\t\t\t\tif (!input) {\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\t\t\t\tinput.remove()\n\t\t\t\tdelete (this.inputs as any)[key]\n\t\t\t}\n\t\t\tthis.setupInputsHide(this.pp)\n\t\t\treturn\n\t\t}\n\t\tthis.setupInputsUser(this.parent.ws.clientId)\n\t\tthis.setupInputsInstrument()\n\t\tif (!this.inputs.inputDevice) {\n\t\t\tthis.setupInputsMidi(this.parent.midi.webMidi)\n\t\t}\n\t\tthis.setupInputsHide(pp)\n\t}\n\n\tsetupInputsHide = (pp: p5) => {\n\t\tif (this.inputs.hide) {\n\t\t\tthis.inputs.hide.remove()\n\t\t}\n\t\tif (this.inputs.hideLoops) {\n\t\t\tthis.inputs.hideLoops.remove()\n\t\t}\n\t\tif (this.inputs.hideDial) {\n\t\t\tthis.inputs.hideDial.remove()\n\t\t}\n\t\tif (this.inputs.showHelp) {\n\t\t\tthis.inputs.showHelp.remove()\n\t\t}\n\t\tconst { loops } = this.parent\n\t\tthis.inputs.showHelp = pp.createButton(this.help ? 'Hide Help' : 'Show Help') as any\n\t\tconst { showHelp } = this.inputs\n\t\tlet xx = pp.width - showHelp.width - 50\n\t\tconst yy = pp.height - showHelp.height - 10\n\t\tshowHelp.position(xx, yy)\n\t\tshowHelp.mousePressed(() => {\n\t\t\tthis.help = !this.help\n\t\t\tif (this.help) {\n\t\t\t\tthis.helpRetoggle.loops = !loops.hidden\n\t\t\t\tthis.helpRetoggle.dial = !loops.hiddenDial\n\t\t\t}\n\t\t\tif (this.helpRetoggle.loops) {\n\t\t\t\tloops.toggleHide()\n\t\t\t}\n\t\t\tif (this.helpRetoggle.dial) {\n\t\t\t\tloops.toggleHideDial()\n\t\t\t}\n\t\t\tthis.setup(pp)\n\t\t\tif (!this.help && !this.hidden) {\n\t\t\t\tthis.setupInputsBPM()\n\t\t\t}\n\t\t})\n\t\tif (this.help) {\n\t\t\treturn\n\t\t}\n\t\txx -= 100\n\t\tthis.inputs.hide = pp.createButton(this.hidden ? 'Show Settings' : 'Hide Settings') as any\n\t\tthis.inputs.hideLoops = pp.createButton(loops.toggleHideText()) as any\n\t\tthis.inputs.hideDial = pp.createButton(loops.toggleHideDialText()) as any\n\t\tconst { hide, hideLoops, hideDial } = this.inputs\n\t\thideLoops.position(xx, yy)\n\t\thideLoops.mousePressed(() => {\n\t\t\tloops.toggleHide()\n\t\t\thideLoops.elt.innerHTML = loops.toggleHideText()\n\t\t})\n\t\txx -= 130\n\t\thideDial.position(xx, yy)\n\t\thideDial.mousePressed(() => {\n\t\t\tloops.toggleHideDial()\n\t\t\thideDial.elt.innerHTML = loops.toggleHideDialText()\n\t\t})\n\t\txx -= 110\n\t\thide.position(xx, yy)\n\t\thide.mousePressed(this.toggleHide)\n\t}\n\n\tsetupInputsUser = (clientId: number): any => {\n\t\tconst uu = this.parent.user\n\t\tconst defaultName = this.nameCustomized ? uu.name : `User ${this.parent.ws.clientId}`\n\t\tif (this.hidden) {\n\t\t\tif (uu.name === '') {\n\t\t\t\tthis.parent.updateUser({ name: defaultName })\n\t\t\t}\n\t\t\treturn\n\t\t}\n\t\tif (!this.pp) {\n\t\t\tconsole.warn(\n\t\t\t\t'[SketchInputs #setupInputsUser] Attempted to setup user input before sketch was initialized',\n\t\t\t)\n\t\t\treturn\n\t\t}\n\t\tif (this.inputs.name && this.nameCustomized) {\n\t\t\t// Don't re-create the input if the user has already customized their name\n\t\t\treturn\n\t\t}\n\t\tif (this.inputs.name) {\n\t\t\tthis.inputs.name.remove()\n\t\t}\n\t\tif (this.inputs.offset) {\n\t\t\tthis.inputs.offset.remove()\n\t\t}\n\t\tconst inName = this.pp.createInput(defaultName) as any\n\t\tinName.size(80)\n\t\tinName.position(20, userInputsY)\n\t\tinName.input(() => {\n\t\t\t// console.log('[SketchInputs #inputs.name] Changed:', inName.value())\n\t\t\tthis.nameCustomized = true\n\t\t\tthis.parent.updateUser({ name: inName.value() })\n\t\t})\n\t\tinName.elt.onfocus = () => (inName.focused = true)\n\t\tinName.elt.onblur = () => (inName.focused = false)\n\t\t// // Uncomment to select name field on load:\n\t\t// inName.elt.focus()\n\t\t// inName.elt.select()\n\t\tthis.inputs.name = inName\n\t\tthis.parent.updateUser({ name: inName.value() }, false)\n\n\t\tconst inOffset = this.pp.createInput(`${this.parent.user.offset}`) as any\n\t\tinOffset.size(50)\n\t\tinOffset.position(inName.x + inName.width + 10, userInputsY)\n\t\tconst setOffset = () => {\n\t\t\tconst off = parseFloat(inOffset.value())\n\t\t\tif (!Number.isNaN(off)) {\n\t\t\t\tthis.parent.updateUser({ offset: off })\n\t\t\t\tthis.parent.loops.updateRecOffset(off)\n\t\t\t}\n\t\t}\n\t\tinOffset.input(() => {\n\t\t\tconsole.log('[SketchInputs #inputs.offset] Changed:', inOffset.value())\n\t\t\tsetOffset()\n\t\t})\n\t\tinOffset.elt.onfocus = () => (inOffset.focused = true)\n\t\tinOffset.elt.onblur = () => (inOffset.focused = false)\n\t\tthis.inputs.offset = inOffset\n\t\tsetOffset()\n\t}\n\n\tsetupInputsInstrument = () => {\n\t\tif (!this.pp || !this.inputs.offset || this.hidden) {\n\t\t\treturn\n\t\t}\n\t\tif (this.inputs.instrument) {\n\t\t\tthis.inputs.instrument.remove()\n\t\t}\n\t\tconst inInst = this.pp.createSelect() as any\n\t\tinInst.position(this.inputs.offset.x + this.inputs.offset.width + 10, userInputsY)\n\t\tconst uinst = this.parent.user.instrument\n\t\tinInst.size(130)\n\t\tfor (const instName in this.parent.instruments) {\n\t\t\tinInst.option(instName)\n\t\t\tif (instName === uinst) {\n\t\t\t\tinInst.selected(instName)\n\t\t\t}\n\t\t}\n\t\tinInst.changed(() => {\n\t\t\tthis.parent.updateUser({ instrument: inInst.value() })\n\t\t})\n\t\tinInst.elt.onfocus = () => (inInst.focused = true)\n\t\tinInst.elt.onblur = () => (inInst.focused = false)\n\t\tthis.inputs.instrument = inInst\n\t\tthis.parent.updateUser({ instrument: inInst.value() }, false)\n\t}\n\n\tsetupInputsMidi = (webMidi: any) => {\n\t\tif (!this.pp || !this.inputs.instrument || this.hidden) {\n\t\t\treturn\n\t\t}\n\t\tif (this.inputs.inputDevice) {\n\t\t\tthis.inputs.inputDevice.remove()\n\t\t}\n\t\tconst { inputs } = webMidi || { inputs: [] }\n\t\tconst inMidi = this.pp.createSelect() as any\n\t\tconst inInst = this.inputs.instrument\n\t\tinMidi.position(inInst.x + inInst.width + 10, userInputsY)\n\t\tinMidi.option('keyboard')\n\t\tfor (const input of inputs) {\n\t\t\tconst { _midiInput } = input\n\t\t\tif (!_midiInput) {\n\t\t\t\tconsole.error('[SketchInputs #setupInputsMidi] Received a midi input with missing data')\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tinMidi.option(_midiInput.name)\n\t\t}\n\t\tinMidi.selected(this.parent.user.inputDevice)\n\t\tinMidi.changed(() => {\n\t\t\tthis.parent.updateUser({ inputDevice: inMidi.value() })\n\t\t})\n\t\tinMidi.elt.onfocus = () => (inMidi.focused = true)\n\t\tinMidi.elt.onblur = () => (inMidi.focused = false)\n\t\tthis.inputs.inputDevice = inMidi\n\t\tthis.parent.updateUser({ inputDevice: inMidi.value() }, false)\n\t}\n\n\tsetupInputsBPM = () => {\n\t\tif (!this.pp || this.hidden) {\n\t\t\treturn\n\t\t}\n\t\tif (this.inputs.bpm) {\n\t\t\tthis.inputs.bpm.remove()\n\t\t}\n\t\tconst inBPM = this.pp.createSlider(30, 200, this.clockOpts.bpm) as any\n\t\tinBPM.position(20, this.pp.height - 40)\n\t\tinBPM.size(300)\n\t\tinBPM.input(() => {\n\t\t\tthis.clockOpts.bpm = inBPM.value()\n\t\t\tthis.clockOpts.clientId = this.parent.user.clientId\n\t\t\tthis.sendClockUpdate(this.clockOpts)\n\t\t})\n\t\tinBPM.elt.onfocus = () => (inBPM.focused = true)\n\t\tinBPM.elt.onblur = () => (inBPM.focused = false)\n\t\tthis.inputs.bpm = inBPM\n\t}\n\n\tdraw = (pp: p5) => {\n\t\tif (this.help) {\n\t\t\tthis.drawHelp(pp)\n\t\t\treturn\n\t\t}\n\t\t// Draw labels for inputs\n\t\tpp.textSize(12)\n\t\tpp.fill(255)\n\t\tpp.strokeWeight(1)\n\t\tpp.stroke(0)\n\t\tpp.textAlign(pp.LEFT, pp.BOTTOM)\n\t\tpp.textStyle(pp.BOLD)\n\t\tfor (const key in this.inputs) {\n\t\t\tconst input = (this.inputs as any)[key]\n\t\t\tif (!input) {\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tconst xx = input.x + 3\n\t\t\tconst yy = input.y - 5\n\t\t\tswitch (true) {\n\t\t\t\tcase key === 'hide':\n\t\t\t\tcase key === 'hideLoops':\n\t\t\t\tcase key === 'hideDial':\n\t\t\t\tcase key === 'showHelp':\n\t\t\t\t\tcontinue\n\t\t\t\tcase key === 'offset':\n\t\t\t\t\tconst off = parseFloat(input.value())\n\t\t\t\t\tlet msg = ``\n\t\t\t\t\tif (Number.isNaN(off)) {\n\t\t\t\t\t\t// Show the user that they have an invalid value\n\t\t\t\t\t\tpp.fill(255, 0, 0)\n\t\t\t\t\t\tmsg = ` (NaN!)`\n\t\t\t\t\t}\n\t\t\t\t\tpp.text(`${key.toUpperCase()}${msg}${'\\n'}(in beats)`, xx, yy)\n\t\t\t\t\tif (Number.isNaN(off)) {\n\t\t\t\t\t\t// put fill color back\n\t\t\t\t\t\tpp.fill(255)\n\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\tcase key in this.parent.user:\n\t\t\t\t\tpp.text(key.toUpperCase(), xx, yy)\n\t\t\t\t\tbreak\n\t\t\t\tcase key === 'bpm':\n\t\t\t\t\tconst prec = Math.abs(this.parent.ws.clock.precisionNow)\n\t\t\t\t\tconst ping = msToString(this.parent.ws.clock.pingMs)\n\t\t\t\t\tconst xp = input.x + input.width\n\t\t\t\t\tpp.textAlign(pp.RIGHT, pp.BOTTOM)\n\t\t\t\t\tif (!this.parent.ws.ready()) {\n\t\t\t\t\t\tpp.fill(255, 50, 50)\n\t\t\t\t\t\tpp.text(`NO CONNECTION TO SERVER`, xp, yy)\n\t\t\t\t\t\tpp.fill(255)\n\t\t\t\t\t} else if (prec >= 10) {\n\t\t\t\t\t\tpp.fill(255, 50, 50)\n\t\t\t\t\t\tpp.text(`Clock precision: ${msToString(prec)}  |  ping: ${ping}`, xp, yy)\n\t\t\t\t\t\tpp.fill(255)\n\t\t\t\t\t} else {\n\t\t\t\t\t\tpp.text(`Clock precision: ${msToString(prec)}  |  ping: ${ping}`, xp, yy)\n\t\t\t\t\t}\n\t\t\t\t\tpp.textAlign(pp.LEFT, pp.BOTTOM)\n\t\t\t\t// fallthrough\n\t\t\t\tdefault:\n\t\t\t\t\tpp.text(`${key.toUpperCase()}: ${input.value()}`, xx, yy)\n\t\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t}\n\n\tdrawHelp = (pp: p5) => {\n\t\tif (!this.helpImg) {\n\t\t\treturn\n\t\t}\n\t\tconst haspect = this.helpImg.height / this.helpImg.width\n\t\tconst hx = 40\n\t\tconst ww = pp.width - hx * 2\n\t\tconst hh = haspect * ww\n\t\tconst hy = (pp.height - hh) / 2\n\t\tpp.background(60, 220)\n\t\tpp.image(this.helpImg, hx, hy, ww, hh)\n\t}\n\n\tsendClockUpdate = (clk: ClockOpts) => {\n\t\tconst { conn, ready } = this.parent.ws\n\t\tif (!ready()) {\n\t\t\tconsole.warn(\n\t\t\t\t\"[SketchInputs #sendClockUpdate] Can't send bpm update, websocket connection is not open\",\n\t\t\t)\n\t\t\treturn\n\t\t}\n\t\tconn.send(clockUpdateReq(clk))\n\t}\n\n\tonClockUpdate = (clk: ClockOpts) => {\n\t\tthis.clockOpts = clk\n\t\tif (!this.inputs.bpm) {\n\t\t\treturn\n\t\t}\n\t\tthis.inputs.bpm.value(clk.bpm)\n\t}\n}\n","import * as p5 from 'p5'\nimport AudioKeys from 'audiokeys'\nimport Sketch from './Sketch'\nimport { MidiEvent } from './MIDI'\n\ntype AudioKeysEvent = {\n\t// the midi number of the note\n\tnote: number\n\t// the keyCode of the key being pressed down\n\tkeyCode: number\n\t// the frequency of the note\n\tfrequency: number\n\t// on note down: the current velocity (this can only be set when rows = 1)\n\t// on note up: 0\n\tvelocity: number\n}\n\nexport class SketchAudioKeys {\n\tsketch: Sketch\n\taudioKeys: AudioKeys\n\t// customs stores state vals for custom controlchange keybindings\n\tcustoms: { [key: string]: number } = {\n\t\tmod: 0.5,\n\t\ta: 0.02,\n\t\td: 0.1,\n\t\ts: 1.0,\n\t\tr: 0.3,\n\t}\n\t// customToCtrl maps custom values to MIDI controlchange channels\n\tcustomToCtrl: { [key: string]: number } = {\n\t\tmod: 1,\n\t\ta: 71,\n\t\td: 72,\n\t\ts: 73,\n\t\tr: 74,\n\t}\n\n\tconstructor(sketch: Sketch) {\n\t\tthis.sketch = sketch\n\t\tthis.audioKeys = new AudioKeys({ polyphony: Infinity })\n\t\tthis.audioKeys.down(this.keyPressed)\n\t\tthis.audioKeys.up(this.keyReleased)\n\t}\n\n\tkeyPressed = (evt: AudioKeysEvent) => {\n\t\tconst { note, velocity } = evt\n\t\tif (this.sketch.keyboardInputDisabled()) {\n\t\t\treturn\n\t\t}\n\t\tif (this.sketch.user.inputDevice !== 'keyboard') {\n\t\t\treturn\n\t\t}\n\t\tconst midiEvt = { kind: 'noteon', note: note, attack: velocity / 128.0 } as MidiEvent\n\t\tthis.sketch.sendUserEvent('keyboard', 'noteon', midiEvt)\n\t}\n\n\tkeyReleased = (evt: AudioKeysEvent) => {\n\t\tconst { note } = evt\n\t\tif (this.sketch.keyboardInputDisabled()) {\n\t\t\treturn\n\t\t}\n\t\tif (this.sketch.user.inputDevice !== 'keyboard') {\n\t\t\treturn\n\t\t}\n\t\tconst midiEvt = { kind: 'noteoff', note: note } as MidiEvent\n\t\tthis.sketch.sendUserEvent('keyboard', 'noteoff', midiEvt)\n\t}\n\n\t//\n\t// Handling for custom keys not built-in to the audiokeys library\n\t//\n\tkeyPressedP5 = (evt: p5) => {\n\t\tswitch (evt.key) {\n\t\t\tcase '[':\n\t\t\tcase '{': this.handleCustom('mod', false); break\n\t\t\tcase ']':\n\t\t\tcase '}': this.handleCustom('mod', true); break\n\t\t\tcase 'c':\n\t\t\tcase 'C': this.handleCustom('a', false); break\n\t\t\tcase 'v':\n\t\t\tcase 'V': this.handleCustom('a', true); break\n\t\t\tcase 'b':\n\t\t\tcase 'B': this.handleCustom('d', false); break\n\t\t\tcase 'n':\n\t\t\tcase 'N': this.handleCustom('d', true); break\n\t\t\tcase 'm':\n\t\t\tcase 'M': this.handleCustom('s', false); break\n\t\t\tcase ',':\n\t\t\tcase '<': this.handleCustom('s', true); break\n\t\t\tcase '.':\n\t\t\tcase '>': this.handleCustom('r', false); break\n\t\t\tcase '/':\n\t\t\tcase '?': this.handleCustom('r', true); break\n\t\t}\n\t}\n\n\thandleCustom = (prop: string, increase = false) => {\n\t\tconst { customs } = this\n\t\tconst vel = this.audioKeys._state.velocity / 127\n\t\tif (increase) {\n\t\t\tcustoms[prop] = Math.min(1, customs[prop] + vel / 4)\n\t\t} else {\n\t\t\tcustoms[prop] = Math.max(0, customs[prop] - vel / 4)\n\t\t}\n\t\tthis.sketch.sendUserEvent('keyboard', 'controlchange', {\n\t\t\tkind: 'controlchange',\n\t\t\tchannel: 1,\n\t\t\tcontroller: { number: this.customToCtrl[prop] },\n\t\t\tvalue: customs[prop],\n\t\t} as MidiEvent)\n\t}\n\n\tkeyReleasedP5 = (_evt: p5) => {}\n}\n","export const KEYCODE_RETURN = 3\nexport const KEYCODE_ENTER = 13\nexport const KEYCODE_BACKSPACE = 8\nexport const KEYCODE_DELETE = 46\nexport const KEYCODE_SHIFT = 16\nexport const KEYCODE_CONTROL = 17\nexport const KEYCODE_ESC = 27\n\nexport const BLACK_KEYS = [1, 3, 6, 8, 10]\n","import * as p5 from 'p5'\nimport { v4 as uuid } from 'uuid'\nimport { UserEvent } from './serverApi/serverApi'\nimport Sketch from './Sketch'\nimport seedrandom from 'seedrandom'\nimport { BLACK_KEYS } from './constants'\n\nexport const radBig = 50\nexport const radSmall = 35\n\ntype LoopEvent = {\n\tevt: UserEvent\n\tloopTime: number // normalized 0-1 to loop duration\n\trelease?: LoopEvent // reference to release for attack events\n}\n\ntype LoopData = {\n\tid: string\n\tbeats: number\n\tevts: LoopEvent[]\n\tisMuted: boolean\n}\n\nexport type LoopOpts = {\n\tid?: string\n\tbeats: number\n\tradius: number\n\tsketch: Sketch\n\tisDial?: boolean\n}\n\nexport class Loop {\n\topts: LoopOpts\n\tid: string\n\txx = 0\n\tyy = 0\n\tevts: LoopEvent[] = []\n\theadPlay = 0\n\theadRec = 0\n\tisActive = false\n\tisDial = false\n\tisRecording = false\n\tisMuted = false\n\tloaded = false\n\tpgControls?: p5.Graphics\n\tpgNotes?: p5.Graphics\n\tneedsRenderControls = false\n\tneedsRenderNotes = false\n\t// data: LoopData\n\n\tconstructor(opts: LoopOpts) {\n\t\tthis.opts = opts\n\t\tif (opts.id) {\n\t\t\tthis.id = opts.id\n\t\t\tif (this.load()) {\n\t\t\t\tconsole.log(`[Loop #ctor] Loaded loop ${opts.id} from local storage`)\n\t\t\t\tthis.needsRenderControls = true\n\t\t\t\tthis.needsRenderNotes = true\n\t\t\t\treturn // loaded loop from local storage\n\t\t\t} else {\n\t\t\t\tconsole.error(`[Loop #ctor] Failed to load loop ${opts.id} from local storage`)\n\t\t\t}\n\t\t} else {\n\t\t\tthis.id = uuid()\n\t\t}\n\t\tif (opts.isDial) {\n\t\t\tthis.isDial = true\n\t\t} else {\n\t\t\tthis.isActive = true\n\t\t}\n\t}\n\n\tsave = () => {\n\t\tconst { id, isMuted, evts, opts } = this\n\t\tconst { beats, sketch } = opts\n\t\tconst data = { id, beats, evts, isMuted }\n\t\tsketch.localStorage.setItem(id, JSON.stringify(data))\n\t\t// console.log(`[Loop #save] Saved loop ${id} to local storage`)\n\t}\n\n\tload = () => {\n\t\tconst { id, opts } = this\n\t\tconst { sketch } = opts\n\t\tconst dataStr = sketch.localStorage.getItem(id)\n\t\tif (!dataStr || dataStr === '') {\n\t\t\tthis.loaded = false\n\t\t\treturn false\n\t\t}\n\t\tconst data = JSON.parse(dataStr) as LoopData\n\t\topts.beats = data.beats\n\t\tthis.evts = data.evts\n\t\tthis.isMuted = data.isMuted\n\t\tthis.loaded = true\n\t\treturn true\n\t}\n\n\tremove = () => {\n\t\tthis.opts.sketch.localStorage.removeItem(this.id)\n\t}\n\n\tsetRadius = (rad: number) => {\n\t\tif (rad === this.opts.radius) {\n\t\t\treturn\n\t\t}\n\t\tthis.opts.radius = rad\n\t\t// redraw notes and controls\n\t\tif (this.pgControls) {\n\t\t\tthis.needsRenderControls = true\n\t\t}\n\t\tif (this.pgNotes) {\n\t\t\tthis.needsRenderNotes = true\n\t\t}\n\t}\n\n\tloopLenMs = () => this.opts.beats * this.opts.sketch.beatMs()\n\n\tloopUserEvent = (evt: UserEvent) => {\n\t\tconst { sketch } = this.opts\n\t\tconst recOff = sketch.offsetMs()\n\t\tconst now = sketch.nowMs()\n\t\tconst loopTime = this.timeGlobalToLoopNorm(now + recOff)\n\t\tconst levt = {\n\t\t\tevt,\n\t\t\tloopTime,\n\t\t}\n\t\tconst { kind, note } = evt.midiEvent\n\t\tif (kind === 'noteoff') {\n\t\t\t// Attach event to the associated noteon event\n\t\t\tconst attacks = this.filterNote(this.attackEvents(), note)\n\t\t\tlet attackEvt: LoopEvent | null = null\n\t\t\tlet minDiff = 1\n\t\t\tconst relTime = loopTime + 1\n\t\t\tfor (const ae of attacks) {\n\t\t\t\tlet attTime = ae.loopTime > loopTime ? ae.loopTime : ae.loopTime + 1\n\t\t\t\tconst diff = relTime - attTime\n\t\t\t\tif (diff < minDiff) {\n\t\t\t\t\tminDiff = diff\n\t\t\t\t\tattackEvt = ae\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (attackEvt) {\n\t\t\t\tattackEvt.release = levt\n\t\t\t} else {\n\t\t\t\tconsole.warn('[Loop #loopUserEvent] No attack event found for release', levt)\n\t\t\t}\n\t\t\tthis.needsRenderNotes = true\n\t\t\treturn\n\t\t}\n\t\tif (kind === 'controlchange' || kind === 'pitchbend') {\n\t\t\tthis.needsRenderControls = true\n\t\t}\n\t\tif (kind === 'noteon' || kind === 'noteoff') {\n\t\t\tthis.needsRenderNotes = true\n\t\t}\n\t\tthis.evts.push(levt)\n\t}\n\n\tsanitizeEvents = () => {\n\t\t// Remove any attacks that don't have releases\n\t\tthis.evts = this.evts.filter(ee => ee.evt.midiEvent.kind !== 'noteon' || ee.release)\n\t}\n\n\tupdateClientId = (clientId: number) => {\n\t\tfor (const le of this.evts) {\n\t\t\tle.evt.clientId = clientId\n\t\t\tif (le.release) {\n\t\t\t\tle.release.evt.clientId = clientId\n\t\t\t}\n\t\t}\n\t}\n\n\tattackEvents = () => this.evts.filter(ee => ee.evt.midiEvent.kind === 'noteon')\n\treleaseEvents = () => this.evts.filter(ee => ee.evt.midiEvent.kind === 'noteoff')\n\tcontrolEvents = () =>\n\t\tthis.evts.filter(\n\t\t\tee => ee.evt.midiEvent.kind === 'controlchange' || ee.evt.midiEvent.kind === 'pitchbend',\n\t\t)\n\tsortByLoopTime = (evts: LoopEvent[]) =>\n\t\tevts.sort((aa: LoopEvent, bb: LoopEvent) => (aa.loopTime > bb.loopTime ? 1 : -1))\n\tgroupByController = (evts: LoopEvent[]) => {\n\t\tconst resp: { [key: number]: LoopEvent[] } = {}\n\t\tfor (const le of evts) {\n\t\t\tconst { controller } = le.evt.midiEvent\n\t\t\tconst ctrl = controller ? controller.number : 0\n\t\t\tif (!resp[ctrl]) {\n\t\t\t\tresp[ctrl] = []\n\t\t\t}\n\t\t\tresp[ctrl].push(le)\n\t\t}\n\t\treturn resp\n\t}\n\tfilterNote = (evts: LoopEvent[], note: number) => evts.filter(ee => ee.evt.midiEvent.note === note)\n\n\tclearAllEvents = () => {\n\t\t// Remove all loop events\n\t\tthis.evts = []\n\t\tthis.save()\n\t\t// Update note and control graphics\n\t\tif (this.pgControls) {\n\t\t\tthis.needsRenderControls = true\n\t\t}\n\t\tif (this.pgNotes) {\n\t\t\tthis.needsRenderNotes = true\n\t\t}\n\t}\n\n\tupdate = () => {\n\t\t// Calculate play and rec heads normalized (0-1) to the loop length\n\t\tconst { sketch } = this.opts\n\t\tconst now = sketch.nowMs()\n\t\tconst recOff = sketch.offsetMs()\n\t\tconst play = this.timeGlobalToLoopNorm(now)\n\t\tlet rec = this.timeGlobalToLoopNorm(now + recOff)\n\t\tconst headRecPrev = this.headRec\n\n\t\tthis.headPlay = play\n\t\tthis.headRec = rec\n\n\t\tif (this.isMuted) {\n\t\t\treturn\n\t\t}\n\n\t\t// Trigger looped events if an offset boundary was crossed\n\t\tfor (const levt of this.evts) {\n\t\t\tconst { evt, loopTime, release } = levt\n\t\t\tlet lt = loopTime\n\t\t\tif (evt.timestamp > now - sketch.beatMs() / 2) {\n\t\t\t\tcontinue // don't trigger the first event since it is sent directly\n\t\t\t}\n\t\t\tif (rec < headRecPrev) {\n\t\t\t\t// crossed the 1/0 boundary\n\t\t\t\tif (lt <= rec) {\n\t\t\t\t\tlt += 1\n\t\t\t\t}\n\t\t\t\trec += 1\n\t\t\t}\n\t\t\tif (headRecPrev < lt && lt <= rec) {\n\t\t\t\tsketch._sendUserEvent({\n\t\t\t\t\t...levt.evt,\n\t\t\t\t\ttimestamp: this.timeLoopNormToGlobal(now + recOff, lt),\n\t\t\t\t})\n\t\t\t\tif (release) {\n\t\t\t\t\tlet after = release.loopTime - loopTime\n\t\t\t\t\tif (after <= 0) {\n\t\t\t\t\t\tafter += 1\n\t\t\t\t\t}\n\t\t\t\t\tsketch._sendUserEvent({\n\t\t\t\t\t\t...release.evt,\n\t\t\t\t\t\ttimestamp: this.timeLoopNormToGlobal(now + recOff, lt + after),\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\trecStartedAt: number | null = null\n\tdraw = (pp: p5, xx: number, yy: number) => {\n\t\tconst { beats, radius } = this.opts\n\t\tconst { isActive, isDial, isMuted, isRecording } = this\n\t\tthis.xx = xx\n\t\tthis.yy = yy\n\t\tif (isRecording) {\n\t\t\tif (this.recStartedAt === null) {\n\t\t\t\tthis.recStartedAt = this.headRec\n\t\t\t}\n\t\t\tpp.fill(30).stroke(255, 0, 0).strokeWeight(4)\n\t\t} else {\n\t\t\tthis.recStartedAt = null\n\t\t\tpp.fill(30).stroke(0).strokeWeight(2)\n\t\t}\n\t\tpp.circle(this.xx, this.yy, radius * 2 + (isRecording ? 2 : 0))\n\n\t\t// Draw a line for every beat\n\t\tfor (let ii = 0; ii < beats; ii++) {\n\t\t\tconst isDown = ii % 4 === 0\n\t\t\tconst isFirst = ii === 0\n\t\t\tpp.stroke(isFirst ? 180 : isDown ? 130 : 80)\n\t\t\tpp.strokeWeight(isFirst ? 3 : isDown ? 2 : 1)\n\t\t\tconst bb = ii / beats\n\t\t\tthis.drawLine(pp, radius, bb)\n\t\t}\n\n\t\tthis.drawEvents(pp)\n\n\t\tif (isMuted) {\n\t\t\tpp.fill(30, 150).noStroke()\n\t\t\tpp.circle(this.xx, this.yy, radius * 2)\n\t\t}\n\n\t\t// Draw indicators for playhead and record-head\n\t\tconst { headPlay, headRec } = this\n\t\tif (isDial || isRecording) {\n\t\t\tconst arcPlay = (Math.ceil(headPlay * beats) % beats) / beats\n\t\t\tconst arcRec = (Math.ceil(headRec * beats) % beats) / beats\n\t\t\tlet recFillAlpha = 100\n\t\t\tif (isDial) {\n\t\t\t\tpp.fill(0, 200, 0, 60).noStroke()\n\t\t\t\tthis.drawArc(pp, radius, arcPlay)\n\t\t\t\trecFillAlpha = 140\n\t\t\t}\n\t\t\tpp.fill(180, 0, 0, recFillAlpha).noStroke()\n\t\t\tif (headRec !== headPlay) {\n\t\t\t\tconst rad = isRecording ? radius : radius * 0.7\n\t\t\t\tif (isRecording && this.recStartedAt !== null) {\n\t\t\t\t\tthis.drawArc(pp, rad, headRec, this.recStartedAt)\n\t\t\t\t} else {\n\t\t\t\t\tthis.drawArc(pp, rad, arcRec, headPlay)\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (isActive || !isMuted) {\n\t\t\tif (isMuted) {\n\t\t\t\tpp.stroke(100).strokeWeight(3)\n\t\t\t} else {\n\t\t\t\tpp.stroke(0, 200, 0).strokeWeight(3)\n\t\t\t}\n\t\t\tthis.drawLine(pp, radius, headPlay)\n\t\t}\n\t\tif (isDial || isActive) {\n\t\t\tpp.stroke(200, 0, 0).strokeWeight(4)\n\t\t\tconst rad = isRecording ? radius : radius * 0.7\n\t\t\tthis.drawLine(pp, rad, headRec)\n\t\t}\n\t}\n\n\t// drawEvents draws an arc stroke for every note\n\tdrawEvents = (pp: p5) => {\n\t\tif (this.isDial) {\n\t\t\treturn\n\t\t}\n\t\tthis.drawControls(pp)\n\t\tthis.drawNotes(pp)\n\t}\n\n\tdrawControls = (pp: p5) => {\n\t\tconst { radius } = this.opts\n\t\tif (this.needsRenderControls) {\n\t\t\tthis.needsRenderControls = false\n\t\t\tif (!this.pgControls) {\n\t\t\t\tthis.pgControls = pp.createGraphics(radBig * 2, radBig * 2)\n\t\t\t}\n\t\t\t// Stash the x and y coords and override with center of graphics\n\t\t\tconst [tmpx, tmpy] = [this.xx, this.yy]\n\t\t\tthis.xx = radius\n\t\t\tthis.yy = radius\n\t\t\tthis.renderControls()\n\t\t\tthis.xx = tmpx\n\t\t\tthis.yy = tmpy\n\t\t}\n\t\tif (this.pgControls) {\n\t\t\tpp.image(this.pgControls, this.xx - radius, this.yy - radius)\n\t\t}\n\t}\n\n\tdrawNotes = (pp: p5) => {\n\t\tconst { radius } = this.opts\n\t\tif (this.needsRenderNotes) {\n\t\t\tthis.needsRenderNotes = false\n\t\t\tif (!this.pgNotes) {\n\t\t\t\tthis.pgNotes = pp.createGraphics(radBig * 2, radBig * 2)\n\t\t\t}\n\t\t\tconst [tmpx, tmpy] = [this.xx, this.yy]\n\t\t\tthis.xx = radius\n\t\t\tthis.yy = radius\n\t\t\tthis.renderNotes()\n\t\t\tthis.xx = tmpx\n\t\t\tthis.yy = tmpy\n\t\t}\n\t\tif (this.pgNotes) {\n\t\t\tpp.image(this.pgNotes, this.xx - radius, this.yy - radius)\n\t\t}\n\t\tif (this.isRecording) {\n\t\t\tthis._drawNotes(pp, true) // draw any unreleased notes\n\t\t}\n\t}\n\n\tdrawLine = (pp: p5, rad: number, loopTime: number) => {\n\t\tconst theta = Math.PI * 2 * loopTime\n\t\tconst lx = this.xx + (rad - 2) * Math.sin(theta)\n\t\tconst ly = this.yy - (rad - 2) * Math.cos(theta)\n\t\tpp.line(this.xx, this.yy, lx, ly)\n\t}\n\n\tdrawArc = (pp: p5, rad: number, loopTime: number, fromTime: number = 0) => {\n\t\tconst theta = Math.PI * (2 * loopTime - 0.5)\n\t\tconst from = Math.PI * (2 * fromTime - 0.5)\n\t\tpp.arc(this.xx, this.yy, rad * 2, rad * 2, from, theta)\n\t}\n\n\trenderControls = () => {\n\t\tif (!this.pgControls) {\n\t\t\treturn\n\t\t}\n\t\tconst pg = this.pgControls\n\t\tpg.clear()\n\t\tconst cevts = this.groupByController(this.sortByLoopTime(this.controlEvents()))\n\t\tif (!Object.keys(cevts).length) {\n\t\t\treturn\n\t\t}\n\t\tconst { radius } = this.opts\n\t\tpg.strokeWeight(2).noFill()\n\t\tpg.colorMode(pg.HSL, 1)\n\t\tfor (const ctrl in cevts) {\n\t\t\tconst hue = seedrandom(ctrl).quick()\n\t\t\tconst sat = 0.8\n\t\t\tconst len = cevts[ctrl].length\n\t\t\tfor (let ii = 0; ii < len; ii++) {\n\t\t\t\tconst { loopTime, evt } = cevts[ctrl][ii]\n\t\t\t\tconst nextEvtIdx = ii === len - 1 ? 0 : ii + 1\n\t\t\t\tconst { loopTime: nextTime } = cevts[ctrl][nextEvtIdx]\n\t\t\t\tconst { kind, value } = evt.midiEvent\n\t\t\t\tconst isPitchbend = kind === 'pitchbend'\n\t\t\t\tconst vv = isPitchbend ? value / 2 + 0.5 : value\n\t\t\t\tconst rad = radius * (0.3 + 0.7 * vv)\n\t\t\t\tpg.stroke(hue, sat, 0.4)\n\t\t\t\tthis.drawArc(pg, rad, nextTime, loopTime)\n\t\t\t}\n\t\t}\n\t}\n\n\trenderNotes = () => {\n\t\tif (!this.pgNotes) {\n\t\t\treturn\n\t\t}\n\t\tthis.pgNotes.clear()\n\t\tthis._drawNotes(this.pgNotes)\n\t}\n\n\t_drawNotes = (pp: p5, unreleasedOnly = false) => {\n\t\tconst modNotes = 12\n\t\tconst { radius } = this.opts\n\t\tpp.strokeWeight(radius / modNotes).noFill()\n\t\tpp.colorMode(pp.HSL, 1)\n\t\tfor (const { loopTime, evt, release } of this.attackEvents()) {\n\t\t\tconst { note, attack } = evt.midiEvent\n\t\t\tlet relTime = this.headRec\n\t\t\tif (release) {\n\t\t\t\tif (unreleasedOnly) {\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\t\t\t\trelTime = release.loopTime\n\t\t\t}\n\t\t\tconst rad = radius * (0.3 + (0.7 * (note % modNotes)) / modNotes)\n\t\t\tconst nn = note % 12\n\t\t\tlet hue = BLACK_KEYS.includes(nn) ? 0.5 + nn / 36 : nn / 36\n\t\t\tlet sat = attack ? 1 - attack : 0.5\n\t\t\tsat = 1 - sat * sat\n\t\t\tpp.stroke(hue, sat, 0.4)\n\t\t\tthis.drawArc(pp, rad, relTime, loopTime)\n\t\t}\n\t\tpp.colorMode(pp.RGB, 255)\n\t}\n\n\ttimeGlobalToLoop = (tt: number) => {\n\t\treturn (tt - this.opts.sketch.downbeat) / this.loopLenMs()\n\t}\n\n\ttimeGlobalToLoopNorm = (tt: number) => {\n\t\tconst lt = this.timeGlobalToLoop(tt)\n\t\treturn lt - Math.floor(lt) // 0-1 from start to end of loop\n\t}\n\n\ttimeLoopToGlobal = (loopTime: number) => {\n\t\tconst { sketch } = this.opts\n\t\tconst loopLenMs = this.loopLenMs()\n\t\treturn sketch.downbeat + loopTime * loopLenMs\n\t}\n\n\ttimeLoopNormToGlobal = (tt: number, loopTime: number) => {\n\t\tconst loopLenMs = this.loopLenMs()\n\t\treturn this.timeLastLoopStartMs(tt) + loopTime * loopLenMs\n\t}\n\n\ttimeLastLoopStartMs = (tt: number) => {\n\t\tconst { sketch } = this.opts\n\t\tconst loopLenMs = this.loopLenMs()\n\t\tconst lt = this.timeGlobalToLoop(tt)\n\t\treturn sketch.downbeat + Math.floor(lt) * loopLenMs\n\t}\n\n\thitTest = (xx: number, yy: number) => {\n\t\tconst { radius } = this.opts\n\t\tif (xx < this.xx - radius || xx > this.xx + radius) {\n\t\t\treturn false\n\t\t}\n\t\tif (yy < this.yy - radius || yy > this.yy + radius) {\n\t\t\treturn false\n\t\t}\n\t\treturn true\n\t}\n}\n","import * as p5 from 'p5'\nimport { UserEvent } from './serverApi/serverApi'\nimport Sketch from './Sketch'\nimport { KEYCODE_BACKSPACE, KEYCODE_DELETE, KEYCODE_SHIFT, KEYCODE_ENTER, KEYCODE_RETURN } from './constants'\nimport { radBig, radSmall, Loop } from './Loop'\n\ntype LoopsOpts = {\n\tsketch: Sketch\n\trecOffset: number\n}\n\nexport class Loops {\n\tsketch: Sketch\n\tdial: Loop\n\tloops: Loop[] = []\n\tactiveLoop: Loop\n\tinputs: {\n\t\tloopLen?: any\n\t\tnewLoopBtn?: any\n\t} = {}\n\trecLock = false\n\thidden = false\n\thiddenDial = false\n\n\tconstructor(opts: LoopsOpts) {\n\t\tthis.sketch = opts.sketch\n\t\tthis.dial = new Loop({\n\t\t\tbeats: this.dialBeats(opts.recOffset),\n\t\t\tradius: radBig,\n\t\t\tsketch: opts.sketch,\n\t\t\tisDial: true,\n\t\t})\n\t\tthis.activeLoop = this.load()\n\t}\n\n\tsaveLoopRefs = () => {\n\t\tconst store = this.sketch.localStorage\n\t\tstore.setItem('activeLoop', this.activeLoop.id)\n\t\tstore.setItem('loops', JSON.stringify(this.loops.map(ll => ll.id)))\n\t}\n\n\tload = () => {\n\t\tconst { sketch } = this\n\t\tconst store = sketch.localStorage\n\t\tconst lidsStr = store.getItem('loops')\n\t\tconst defaultParams = { beats: 8, radius: radSmall, sketch }\n\t\tconst aid = store.getItem('activeLoop')\n\t\tlet activeLoop: Loop | null = null\n\t\tif (lidsStr && lidsStr !== '') {\n\t\t\tconst lids = JSON.parse(lidsStr)\n\t\t\tfor (const lid of lids) {\n\t\t\t\tconst loop = new Loop({ id: lid, ...defaultParams })\n\t\t\t\tif (loop.loaded) {\n\t\t\t\t\t// loop loaded successfully from local storage, add to loops\n\t\t\t\t\tthis.loops.push(loop)\n\t\t\t\t\tif (lid === aid) {\n\t\t\t\t\t\tactiveLoop = loop\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (activeLoop) {\n\t\t\tthis.activeLoop = activeLoop\n\t\t\treturn activeLoop\n\t\t}\n\t\tthis.activeLoop = new Loop(defaultParams)\n\t\tthis.loops.push(this.activeLoop)\n\t\treturn this.activeLoop\n\t}\n\n\tupdate = () => {\n\t\tthis.dial.update()\n\t\tthis.loops.forEach(ll => ll.update())\n\t}\n\n\tdraw = (pp: p5) => {\n\t\tconst { activeLoop, didSetup, hidden, hiddenDial } = this\n\t\tif (hidden) {\n\t\t\tif (didSetup) {\n\t\t\t\tthis.inputs.loopLen.remove()\n\t\t\t\tthis.inputs.newLoopBtn.remove()\n\t\t\t\tthis.didSetup = false\n\t\t\t}\n\t\t} else if (!didSetup) {\n\t\t\tthis.setupInputs(pp)\n\t\t}\n\t\tconst { loopLen, newLoopBtn } = this.inputs\n\n\t\t// Draw active loop\n\t\tlet rad = radBig\n\t\tlet yy = rad + 20\n\t\tlet xx = pp.width - 20\n\t\tif (!hidden) {\n\t\t\tactiveLoop.isActive = true\n\t\t\tactiveLoop.setRadius(rad)\n\t\t\tactiveLoop.isRecording = this.isRecording(pp)\n\t\t\txx -= rad + 20\n\t\t\tactiveLoop.draw(pp, xx, yy)\n\t\t\tpp.fill(210).stroke(0).strokeWeight(1)\n\t\t\tpp.textSize(14).textAlign(pp.CENTER, pp.TOP)\n\t\t\tpp.text(`Active loop: ${loopLen.value()} beats`, xx, yy + rad + 10)\n\t\t\tloopLen.position(xx - 60, yy + rad + 30)\n\t\t\tconst btnHalfwidth = Math.max(48, Math.floor(newLoopBtn.elt.offsetWidth / 2))\n\t\t\tnewLoopBtn.position(xx - btnHalfwidth, yy + rad + 60)\n\t\t\txx -= rad + 20\n\t\t}\n\n\t\tif (!hiddenDial) {\n\t\t\t// Draw metronome dial\n\t\t\trad = this.dial.opts.radius\n\t\t\txx -= rad + 20\n\t\t\tthis.dial.draw(pp, xx, yy)\n\t\t\tpp.fill(210).stroke(0).strokeWeight(1)\n\t\t\tpp.textSize(14).textAlign(pp.CENTER, pp.TOP)\n\t\t\tpp.text('Metronome', xx, yy + rad + 10)\n\t\t}\n\n\t\tif (hidden) {\n\t\t\treturn\n\t\t}\n\n\t\tyy = newLoopBtn.y + newLoopBtn.elt.offsetHeight + 20\n\n\t\tconst othersTop = yy\n\t\trad = radSmall\n\t\txx = pp.width - rad - 20\n\t\tfor (const ll of this.inactiveLoops()) {\n\t\t\tll.isActive = false\n\t\t\tll.setRadius(radSmall)\n\t\t\tyy += rad\n\t\t\tll.draw(pp, xx, yy)\n\t\t\tif (pp.keyIsDown(KEYCODE_SHIFT)) {\n\t\t\t\t// inform user they can click here to delete this loop\n\t\t\t\tpp.fill(50, 150).noStroke()\n\t\t\t\tpp.circle(xx, yy, rad * 2)\n\t\t\t\tpp.fill(200).textSize(12).textStyle(pp.NORMAL).textAlign(pp.CENTER, pp.CENTER)\n\t\t\t\tpp.text('Click to\\ndelete', xx, yy)\n\t\t\t}\n\t\t\tyy += rad + 20\n\t\t\tif (yy > pp.height - rad * 3) {\n\t\t\t\tyy = othersTop\n\t\t\t\txx -= rad * 2 + 20\n\t\t\t}\n\t\t}\n\t}\n\n\tdidSetup = false\n\tsetupInputs = (pp: p5) => {\n\t\tthis.didSetup = true\n\t\tthis.inputs.loopLen = pp.createSlider(1, 64, this.activeLoop.opts.beats) as any\n\t\tthis.inputs.newLoopBtn = pp.createButton('Add new loop') as any\n\t\tconst { loopLen, newLoopBtn } = this.inputs\n\t\tloopLen.size(120)\n\t\tloopLen.input(() => {\n\t\t\tthis.activeLoop.opts.beats = loopLen.value()\n\t\t\tthis.activeLoop.save()\n\t\t})\n\t\tnewLoopBtn.mousePressed(this.addLoop)\n\t}\n\n\tdialBeats = (recOffset: number) => 4 * Math.ceil((recOffset + 1) / 4)\n\n\tupdateRecOffset = (off: number) => {\n\t\tthis.dial.opts.beats = this.dialBeats(off)\n\t}\n\n\tloopUserEvent = (evt: UserEvent) => {\n\t\tthis.activeLoop.loopUserEvent(evt)\n\t}\n\n\tclearAll = () => {\n\t\tthis.loops.forEach(ll => ll.clearAllEvents())\n\t}\n\n\tclearActiveLoop = () => {\n\t\tthis.activeLoop.clearAllEvents()\n\t}\n\n\tupdateClientId = (clientId: number) => {\n\t\tthis.loops.forEach(ll => ll.updateClientId(clientId))\n\t}\n\n\ttoggleActiveLoopMute = () => {\n\t\tconst al = this.activeLoop\n\t\tal.isMuted = !al.isMuted\n\t\tal.save()\n\t}\n\n\ttoggleHide = () => (this.hidden = !this.hidden)\n\ttoggleHideText = () => (this.hidden ? 'Show Loops' : 'Hide Loops')\n\ttoggleHideDial = () => (this.hiddenDial = !this.hiddenDial)\n\ttoggleHideDialText = () => (this.hiddenDial ? 'Show Metronome' : 'Hide Metronome')\n\n\tstopRecording = () => {\n\t\tthis.activeLoop.sanitizeEvents()\n\t\tthis.activeLoop.save()\n\t}\n\n\taddLoop = () => {\n\t\tthis.activeLoop = new Loop({\n\t\t\tbeats: this.inputs.loopLen.value(),\n\t\t\tradius: radBig,\n\t\t\tsketch: this.sketch,\n\t\t})\n\t\tthis.loops.push(this.activeLoop)\n\t\tthis.saveLoopRefs()\n\t}\n\n\tinactiveLoops = () => this.loops.filter(ll => ll !== this.activeLoop)\n\n\tmousePressed = (pp: p5) => {\n\t\tlet didHit = false\n\t\tfor (const loop of this.inactiveLoops()) {\n\t\t\tif (loop.hitTest(pp.mouseX, pp.mouseY)) {\n\t\t\t\tdidHit = true\n\t\t\t\tif (pp.keyIsDown(KEYCODE_SHIFT)) {\n\t\t\t\t\t// Remove loop\n\t\t\t\t\tloop.remove()\n\t\t\t\t\tthis.loops = this.loops.filter(ll => ll !== loop)\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t\tthis.inputs.loopLen.value(loop.opts.beats)\n\t\t\t\tthis.activeLoop.isActive = false\n\t\t\t\tthis.activeLoop = loop\n\t\t\t\tloop.isActive = true\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t\tif (didHit) {\n\t\t\tthis.saveLoopRefs()\n\t\t}\n\t}\n\n\tkeyPressed = (evt: p5) => {\n\t\tif (evt.keyCode === KEYCODE_BACKSPACE || evt.keyCode === KEYCODE_DELETE) {\n\t\t\t// Clear events from active loop, or all loops if Shift is being pressed\n\t\t\tif (evt.keyIsDown(KEYCODE_SHIFT)) {\n\t\t\t\tthis.clearAll()\n\t\t\t} else {\n\t\t\t\tthis.clearActiveLoop()\n\t\t\t}\n\t\t}\n\t\tif (evt.keyCode === KEYCODE_ENTER || evt.keyCode === KEYCODE_RETURN) {\n\t\t\tthis.recLock = !this.recLock\n\t\t\tif (!this.recLock) {\n\t\t\t\tthis.stopRecording()\n\t\t\t}\n\t\t}\n\t\tif (evt.key === '\\\\' || evt.key === '|') {\n\t\t\tthis.toggleActiveLoopMute()\n\t\t}\n\t}\n\n\tkeyReleased = (evt: p5) => {\n\t\tif (evt.keyCode === KEYCODE_SHIFT) {\n\t\t\t// Stopped recording to loop, cleanup any dangling notes\n\t\t\tthis.stopRecording()\n\t\t}\n\t}\n\n\tisRecording = (pp?: p5): boolean => {\n\t\treturn this.recLock || (!!pp && pp.keyIsDown(KEYCODE_SHIFT))\n\t}\n}\n","import * as p5 from 'p5'\nimport { Obj, Vec } from '../core'\nimport { sketch } from 'app/Sketch'\nimport { BlackHole } from 'app/instruments'\n\nexport class BlackHoleObj extends Obj {\n\torigin2D = new Vec()\n\tscale2D = 1\n\n\tdraw(pg: p5.Graphics) {\n\t\tif (sketch && sketch.shaderBlackHole && sketch.backbuffer) {\n\t\t\tconst blackHole = sketch.instruments.blackHole as BlackHole\n\t\t\tpg.shader(sketch.shaderBlackHole)\n\t\t\tsketch.shaderBlackHole.setUniform('backbuffer', sketch.backbuffer)\n\t\t\tsketch.shaderBlackHole.setUniform('size', [pg.width, pg.height])\n\t\t\tsketch.shaderBlackHole.setUniform('rotate', blackHole.modwheel * Math.PI)\n\t\t}\n\t\tpg.fill(0, 0).noStroke()\n\t\tsuper.draw(pg) // apply xform and draw children\n\t\tpg.resetShader()\n\t}\n}\n","import * as p5 from 'p5'\nimport * as Tone from 'tone'\nimport WSClient, { DONT_REOPEN } from './serverApi/WSClient'\nimport { ClockOpts, NOTE_METRONOME_BPM_CHANGED, NOTE_METRONOME_DOWN } from './serverApi/serverClock'\nimport {\n\tuserEventReq,\n\tuserUpdateReq,\n\tuserXformReq,\n\tuserRequestXformsReq,\n\tUser,\n\tUserEvent,\n\tUserForce,\n\tUserXform,\n} from './serverApi/serverApi'\nimport MIDI, { MidiEvent, MidiEventCC, MidiEventNote, MidiEventPitchbend } from './MIDI'\nimport { Instrument } from './Instrument'\nimport { BlackHole, Dancer, EightOhEight, Metronome, Piano, PolySynth } from './instruments'\nimport { EasyCam } from 'vendor/p5.easycam.js'\nimport { engine3d, Avatar, Vec } from 'engine3d'\nimport { SketchInputs } from './SketchInputs'\nimport { SketchAudioKeys } from './SketchAudioKeys'\nimport { Loops } from './Loops'\nimport { BlackHoleObj } from 'engine3d/objs/BlackHoleObj'\n\ntype Instruments = { [key: string]: Instrument }\n\nconst worldScale = 1000\nconst newAvatarPos = () => {\n\tconst rr = () => Math.random() * 1.8 - 0.9\n\treturn new Vec(rr() * worldScale, 31, rr() * worldScale)\n}\nfunction nearestPowerOf2(n: number) {\n\t// via https://stackoverflow.com/questions/26965171/fast-nearest-power-of-2-in-javascript\n\treturn 1 << (31 - Math.clz32(n))\n}\n\nexport default class Sketch {\n\twidth: number = 0\n\theight: number = 0\n\tstarted: boolean = false\n\tsyncing: boolean = true\n\tinstruments: Instruments\n\tws: WSClient\n\tmidi: MIDI\n\taudioKeys: SketchAudioKeys\n\tpp?: p5 // Main canvas, gets WebGL graphics + 2D elements (loops, labels, etc)\n\tpg?: p5.Graphics // WebGL graphics context for 3D virtual space\n\tbackbuffer?: p5.Graphics // A graphics buffer for the previously rendered frame\n\tcam?: EasyCam\n\tuser: User = {\n\t\tclientId: 0,\n\t\tname: '',\n\t\tinstrument: 'dancer',\n\t\tinputDevice: 'keyboard',\n\t\toffset: 2,\n\t}\n\tavatar: Avatar\n\tusers: User[] = []\n\tavatars: Avatar[] = []\n\tinputs: SketchInputs\n\t// ground = new Ground({ pos: new Vec(0, -1, 0), scale: new Vec(worldScale) })\n\tengine3d = engine3d\n\tbgCol = {\n\t\thue: 0.5,\n\t\tsat: 0,\n\t\tlgt: 0.2,\n\t}\n\tloops: Loops\n\tdownbeat = 0 // Tone time of the first downbeat\n\ttransportStarted = false\n\t_bpm = 95\n\t_bpmNext = 95\n\tlocalStorage: Storage\n\t// blackHole = new BlackHoleObj({ pos: new Vec(0, 100, 0), scale: new Vec(100) })\n\tblackHole = new BlackHoleObj()\n\n\tconstructor(global: any) {\n\t\tconsole.log('[Sketch #ctor]')\n\t\tthis.localStorage = global.localStorage\n\t\tconst didLoad = this.loadFromStorage()\n\t\tthis.inputs = new SketchInputs(this, didLoad)\n\t\tthis.loops = new Loops({\n\t\t\tsketch: this,\n\t\t\trecOffset: this.user.offset,\n\t\t})\n\t\tthis.ws = new WSClient(window, {\n\t\t\tclock: {\n\t\t\t\tonSynced: () => {\n\t\t\t\t\tthis.syncing = false\n\t\t\t\t\tthis.transportStarted = false\n\t\t\t\t\tthis.inputs.setupInputsBPM()\n\t\t\t\t},\n\t\t\t},\n\t\t\tonClientId: (clientId: number) => {\n\t\t\t\tthis.user.clientId = clientId\n\t\t\t\tthis.inputs.setupInputsUser(clientId)\n\t\t\t\tthis.loops.updateClientId(clientId)\n\t\t\t\tthis.sendUserUpdate()\n\t\t\t\tthis.sendUserXform(this.avatar.getUserXform())\n\t\t\t\tthis.sendUserRequestXforms()\n\t\t\t},\n\t\t\tonClockUpdate: (clkOpts: ClockOpts) => {\n\t\t\t\tif (clkOpts.clientId === 0) {\n\t\t\t\t\t// Clock update came from server, use to set BPM on next downbeat\n\t\t\t\t\tthis._bpmNext = clkOpts.bpm\n\t\t\t\t} else {\n\t\t\t\t\tthis.inputs.onClockUpdate(clkOpts)\n\t\t\t\t}\n\t\t\t},\n\t\t\tonUsers: this.onUsers,\n\t\t\tonUserEvent: this.onUserEvent,\n\t\t\tonUserForce: this.onUserForce,\n\t\t\tonUserXform: this.onUserXform,\n\t\t\tonUserRequestXforms: () => this.sendUserXform(this.avatar.getUserXform()),\n\t\t})\n\t\tthis.instruments = {\n\t\t\tdancer: new Dancer(),\n\t\t\tsynth: new PolySynth(),\n\t\t\tblackHole: new BlackHole(),\n\t\t\teightOhEight: new EightOhEight(this),\n\t\t\tpiano: new Piano(),\n\t\t\tmetronome: new Metronome(this),\n\t\t}\n\t\tthis.midi = new MIDI({\n\t\t\tonEnabled: this.inputs.setupInputsMidi,\n\t\t\tonMessage: this.sendUserEvent,\n\t\t})\n\t\tthis.audioKeys = new SketchAudioKeys(this)\n\t\tthis.avatar = new Avatar({\n\t\t\tuser: this.user,\n\t\t\tpos: newAvatarPos(),\n\t\t\tscale: new Vec(30),\n\t\t\tphys: { worldScale },\n\t\t\tonForce: this.sendUserXform,\n\t\t})\n\t\twindow.Tone = Tone\n\t\twindow.me = this\n\t}\n\n\tloadFromStorage = () => {\n\t\tconst ustr = this.localStorage.getItem('user')\n\t\tif (!ustr || ustr === ``) {\n\t\t\tconsole.error('No stored user')\n\t\t\treturn false\n\t\t}\n\t\tthis.user = JSON.parse(ustr)\n\t\treturn true\n\t}\n\n\tdestroy = () => {\n\t\tthis.ws.conn.close(DONT_REOPEN, 'sketch destroyed')\n\t}\n\n\ttimeGlobalToTone = (globalTime: number) => {\n\t\tconst rawCtx = Tone.context.rawContext as any\n\t\tconst { contextTime, performanceTime } = rawCtx._nativeAudioContext.getOutputTimestamp()\n\t\tconst lt = this.ws.clock.toLocal(globalTime)\n\t\tconst delta = lt - performanceTime\n\t\tconst toneTime = contextTime + delta / 1000\n\t\treturn toneTime\n\t}\n\n\ttimeToneToGlobal = (toneTime: number) => {\n\t\tconst rawCtx = Tone.context.rawContext as any\n\t\tconst { contextTime, performanceTime } = rawCtx._nativeAudioContext.getOutputTimestamp()\n\t\tconst delta = toneTime - contextTime\n\t\tconst pt = performanceTime + delta * 1000\n\t\tconst globalTime = this.ws.clock.toGlobal(pt)\n\t\treturn globalTime\n\t}\n\n\tsetSize = (width: number, height: number) => {\n\t\tthis.width = width\n\t\tthis.height = height\n\t}\n\n\tshaderBlackHole?: p5.Shader\n\tsketch = (pp: p5) => {\n\t\tthis.pp = pp\n\t\tpp.pixelDensity(1)\n\t\tpp.preload = () => {\n\t\t\tthis.shaderBlackHole = pp.loadShader('/shaders/simple.vert', '/shaders/blackHole.frag')\n\t\t}\n\t\tpp.setup = () => this.setup(pp)\n\t\tpp.draw = () => this.draw(pp)\n\t\tpp.mousePressed = () => this.mousePressed(pp)\n\t\tpp.keyPressed = () => this.keyPressed(pp)\n\t\tpp.keyReleased = () => this.keyReleased(pp)\n\t}\n\n\tsetup = (pp: p5) => {\n\t\tconsole.log(`[Sketch #setup] ${this.width} x ${this.height}`)\n\t\tpp.createCanvas(this.width, this.height)\n\t\tthis.pg = pp.createGraphics(this.width, this.height, 'webgl')\n\t\tthis.pg.textureWrap(pp.REPEAT) // applies to textures rendered to pg (i.e. backbuffer)\n\t\tconst bbsize = nearestPowerOf2(this.width) // backbuffer size is ^2 so p5 doesn't force mode to CLAMP\n\t\tthis.backbuffer = pp.createGraphics(bbsize, bbsize, pp.WEBGL)\n\t\tconsole.log('bbsize', bbsize, this.backbuffer.width, this.backbuffer.height)\n\t\tthis.cam = new EasyCam((this.pg as any)._renderer, { distance: 100 })\n\t\tthis.cam.setDistanceMin(40)\n\t\tthis.cam.setDistanceMax(3000)\n\t\tthis.cam.rotateX(-Math.PI / 8)\n\t\tthis.cam.attachMouseListeners((pp as any)._renderer)\n\t\tthis.cam.setViewport([0, 0, this.width, this.height])\n\t\tthis.cam.rotateZ(Math.PI)\n\t\tthis.avatar.addFollowCam(this.cam)\n\t\tthis.inputs.setup(pp)\n\t}\n\n\tdraw = (pp: p5) => {\n\t\tthis.loops.update()\n\t\tengine3d.update()\n\t\tlet loading = false\n\t\tfor (const instName in this.instruments) {\n\t\t\tif (!this.instruments[instName].loaded()) {\n\t\t\t\tloading = true\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t\tpp.colorMode(pp.HSL, 1)\n\t\t\t.background(this.bgCol.hue, this.bgCol.sat, this.bgCol.lgt)\n\t\t\t.colorMode(pp.RGB, 255)\n\t\tconst { pg } = this\n\t\tif (pg) {\n\t\t\tpg.perspective(Math.PI / 3, pg.width / pg.height, 1, 10000)\n\t\t\tpg.clear()\n\t\t\tengine3d.draw(pg)\n\t\t\tpp.image(pg, 0, 0)\n\t\t\tconst { backbuffer } = this\n\t\t\tif (backbuffer) {\n\t\t\t\tconst { width, height } = backbuffer\n\t\t\t\tbackbuffer.image(pg, -width / 2, -height / 2, width, height)\n\t\t\t}\n\t\t\tif (!this.inputs.help) {\n\t\t\t\tengine3d.draw2D(pp, pg)\n\t\t\t}\n\t\t}\n\t\tthis.inputs.draw(pp)\n\t\tthis.loops.draw(pp)\n\t\tif (this.inputs.help) {\n\t\t\treturn\n\t\t}\n\t\tif (loading) {\n\t\t\tthis.drawMessage(pp, 'Loading instruments...')\n\t\t} else if (this.syncing) {\n\t\t\tthis.drawMessage(pp, 'Syncing clock with server...')\n\t\t}\n\t\t// if (!this.blackHole) {\n\t\t// \tthis.blackHole = new BlackHoleObj({ scale: new Vec(100) })\n\t\t// }\n\t}\n\n\tdrawMessage = (pp: p5, msg: string) => {\n\t\tpp.fill(200)\n\t\tpp.strokeWeight(0)\n\t\tpp.textSize(20)\n\t\tpp.textAlign(pp.CENTER, pp.CENTER)\n\t\tpp.textStyle(pp.BOLDITALIC)\n\t\tpp.text(msg, pp.width / 2, pp.height / 2)\n\t}\n\n\tmousePressed = (pp: p5) => {\n\t\tif (!this.started) {\n\t\t\tthis.started = true\n\t\t\tTone.start()\n\t\t\tconsole.log('[Sketch #mousePressed] Started Tone')\n\t\t}\n\t\tthis.loops.mousePressed(pp)\n\t}\n\n\tkeyboardInputDisabled = () => {\n\t\treturn this.inputs.isFocused() // Ignore keyboard if inputs are focused\n\t}\n\tkeyPressed = (evt: p5) => {\n\t\tif (this.keyboardInputDisabled()) {\n\t\t\treturn\n\t\t}\n\t\tthis.avatar.keyPressed(evt)\n\t\tthis.loops.keyPressed(evt)\n\t\tthis.audioKeys.keyPressedP5(evt)\n\t}\n\tkeyReleased = (evt: p5) => {\n\t\tif (this.keyboardInputDisabled()) {\n\t\t\treturn\n\t\t}\n\t\tthis.avatar.keyReleased(evt)\n\t\tthis.loops.keyReleased(evt)\n\t\tthis.audioKeys.keyReleasedP5(evt)\n\t}\n\n\tupdateUser = (uu: Partial<User>, sendUpdate: boolean = true) => {\n\t\tthis.user = Object.assign(this.user, uu)\n\t\tthis.localStorage.setItem('user', JSON.stringify(this.user))\n\t\tif (sendUpdate) {\n\t\t\tthis.sendUserUpdate()\n\t\t}\n\t}\n\n\t// getUser returns the user matching clientId,\n\t// or this.user if no matching user is found\n\tgetUser = (clientId: number): User => {\n\t\tif (clientId === this.user.clientId) {\n\t\t\treturn this.user\n\t\t}\n\t\tfor (const uu of this.users) {\n\t\t\tif (clientId === uu.clientId) {\n\t\t\t\treturn uu\n\t\t\t}\n\t\t}\n\t\treturn this.user\n\t}\n\n\tgetAvatar = (clientId: number): Avatar | null => {\n\t\tif (clientId === this.user.clientId) {\n\t\t\treturn this.avatar\n\t\t}\n\t\tfor (const aa of this.avatars) {\n\t\t\tif (clientId === aa.user.clientId) {\n\t\t\t\treturn aa\n\t\t\t}\n\t\t}\n\t\treturn null\n\t}\n\tgetAvatarSafe = (clientId: number): Avatar => {\n\t\tconst aa = this.getAvatar(clientId)\n\t\tif (!aa) {\n\t\t\tconsole.warn(\"[Sketch #getAvatarSafe] Can't find avatar for client\", clientId)\n\t\t\treturn this.avatar\n\t\t}\n\t\treturn aa\n\t}\n\n\tsendUserUpdate = () => {\n\t\tconst { conn, ready } = this.ws\n\t\tif (!ready()) {\n\t\t\tconsole.warn(\"[Sketch #sendUserUpdate] Can't send user update, websocket connection is not open\")\n\t\t\treturn\n\t\t}\n\t\tconn.send(userUpdateReq(this.user))\n\t}\n\n\tsendUserXform = (data: UserXform) => {\n\t\tconst { conn, ready } = this.ws\n\t\tif (!ready()) {\n\t\t\tconsole.warn(\"[Sketch #sendUserXform] Can't send user xform, websocket connection is not open\")\n\t\t\treturn\n\t\t}\n\t\tconn.send(userXformReq(data))\n\t}\n\n\tsendUserRequestXforms = () => {\n\t\tconst { conn, ready } = this.ws\n\t\tif (!ready()) {\n\t\t\tconsole.warn(\n\t\t\t\t\"[Sketch #sendUserRequestXforms] Can't request other users' xforms, websocket connection is not open\",\n\t\t\t)\n\t\t\treturn\n\t\t}\n\t\tconn.send(userRequestXformsReq())\n\t}\n\n\tsendUserEvent = (inputName: string, _eventName: string, evt: MidiEvent) => {\n\t\tlet instName = this.user.instrument\n\t\tif (evt.controller) {\n\t\t\t// Hardcode some CC events to control instrument volumes\n\t\t\tswitch (evt.controller.number) {\n\t\t\t\tcase 79: // master volume (local only)\n\t\t\t\t\tTone.Destination.volume.value = (evt.value - 1) * 50\n\t\t\t\t// fallthrough\n\t\t\t\tcase 19: // master mute (local only)\n\t\t\t\t\tTone.Destination.mute = !evt.value\n\t\t\t\t\treturn\n\t\t\t\tcase 117: // record lock (local only)\n\t\t\t\t\tif (evt.value) {\n\t\t\t\t\t\tthis.loops.recLock = !this.loops.recLock\n\t\t\t\t\t}\n\t\t\t\t\treturn\n\t\t\t\tcase 18:\n\t\t\t\tcase 78:\n\t\t\t\t\tinstName = 'metronome'\n\t\t\t\t\tbreak\n\t\t\t\tcase 17:\n\t\t\t\tcase 77:\n\t\t\t\t\tinstName = 'synth'\n\t\t\t\t\tbreak\n\t\t\t\tcase 16:\n\t\t\t\tcase 76:\n\t\t\t\t\tinstName = 'eightOhEight'\n\t\t\t\t\tbreak\n\t\t\t\tcase 15:\n\t\t\t\tcase 75:\n\t\t\t\t\tinstName = 'piano'\n\t\t\t\t\tbreak\n\t\t\t\tdefault:\n\t\t\t\t\t// Commented out for easier deving -- MIDI input always enabled\n\t\t\t\t\t// if (inputName !== this.user.inputDevice) {\n\t\t\t\t\t// \treturn // not a whitelisted CC and not the active device, so don't send\n\t\t\t\t\t// }\n\t\t\t\t\tbreak\n\t\t\t}\n\t\t\t// Commented out for easier deving -- MIDI input always enabled\n\t\t\t// } else {\n\t\t\t// \tif (inputName !== this.user.inputDevice) {\n\t\t\t// \t\treturn\n\t\t\t// \t}\n\t\t}\n\t\tconst off = this.offsetMs()\n\t\tconst uevt = {\n\t\t\tclientId: this.user.clientId,\n\t\t\tinstrument: instName,\n\t\t\tmidiEvent: evt,\n\t\t\ttimestamp: this.nowMs() + off,\n\t\t}\n\t\tif (this.loops.isRecording(this.pp)) {\n\t\t\tthis.loops.loopUserEvent(uevt)\n\t\t}\n\t\tthis._sendUserEvent(uevt)\n\t}\n\n\t_sendUserEvent = (uevt: UserEvent) => {\n\t\tconst { conn, ready } = this.ws\n\t\tif (!ready()) {\n\t\t\t// websocket connection isn't ready, handle event locally\n\t\t\tthis.onUserEvent(uevt)\n\t\t\treturn\n\t\t}\n\t\tconn.send(userEventReq(uevt))\n\t}\n\n\tonUserEvent = (evt: UserEvent) => {\n\t\tconst { clientId, instrument, midiEvent, timestamp } = evt\n\t\tconst { data, channel, kind } = midiEvent\n\t\tconst inst = this.instruments[instrument]\n\t\tif (!inst) {\n\t\t\tconsole.error('[Sketch #onUserEvent] Unable to find instrument', instrument)\n\t\t\treturn\n\t\t}\n\t\tif (!inst.loaded()) {\n\t\t\treturn // don't send events if instrument hasn't finished loading\n\t\t}\n\t\tconst isMetronome = instrument === 'metronome'\n\t\tif (isMetronome && this.syncing) {\n\t\t\treturn // don't handle metronome events until clock has synced\n\t\t}\n\t\tconst tt = this.timeGlobalToTone(timestamp)\n\t\tif (tt < 0) {\n\t\t\treturn // Negative tone time, probably just\n\t\t}\n\t\tif (tt - Tone.immediate() < -1) {\n\t\t\tconsole.log(`[Sketch #onUserEvent] Received event ${Tone.immediate() - tt} seconds late`)\n\t\t\treturn\n\t\t}\n\t\tconst avatar = this.getAvatarSafe(clientId)\n\t\tswitch (kind) {\n\t\t\tcase 'noteon': {\n\t\t\t\tconst nn = midiEvent as MidiEventNote\n\t\t\t\tinst.noteon(avatar, tt, nn)\n\t\t\t\tif (isMetronome) {\n\t\t\t\t\tthis.onMetronome(tt, nn.note)\n\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase 'noteoff': {\n\t\t\t\tconst nn = midiEvent as MidiEventNote\n\t\t\t\tinst.noteoff(avatar, tt, nn)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase 'controlchange': {\n\t\t\t\tconst cc = midiEvent as MidiEventCC\n\t\t\t\tinst.controlchange(avatar, tt, cc)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tcase 'pitchbend': {\n\t\t\t\tconst pb = midiEvent as MidiEventPitchbend\n\t\t\t\tinst.pitchbend(avatar, tt, pb)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tdefault:\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`[Sketch #onUserEvent] Unhandled MIDI event on channel ${channel}:`,\n\t\t\t\t\tkind,\n\t\t\t\t\tdata,\n\t\t\t\t\tevt,\n\t\t\t\t)\n\t\t\t\tbreak\n\t\t}\n\t}\n\n\tonMetronome = (time: number, note: number) => {\n\t\tif (!this.transportStarted && note === NOTE_METRONOME_DOWN) {\n\t\t\tconsole.log(`[Sketch #onUserEvent] Downbeat synced with server. BPM:`, this._bpmNext)\n\t\t\tthis.transportStarted = true\n\t\t\tthis.setNewDownbeat(time)\n\t\t\treturn\n\t\t}\n\t\tif (note !== NOTE_METRONOME_BPM_CHANGED) {\n\t\t\treturn\n\t\t}\n\t\tconsole.log(\n\t\t\t`[Sketch #onUserEvent] Received new downbeat from server, will update clock in ${(\n\t\t\t\ttime - Tone.immediate()\n\t\t\t).toFixed(1)} seconds`,\n\t\t)\n\t\tTone.Draw.schedule(() => {\n\t\t\tconsole.log(`[Sketch #onUserEvent] BPM updated:`, this._bpmNext)\n\t\t\tthis.setNewDownbeat(time)\n\t\t}, time)\n\t}\n\n\tsetNewDownbeat = (toneTime: number) => {\n\t\tthis.downbeat = this.timeToneToGlobal(toneTime)\n\t\tthis._bpm = this._bpmNext\n\t\tthis.inputs.onClockUpdate({ bpm: this._bpm, clientId: 0 })\n\t\tTone.Transport.bpm.value = this._bpm\n\t}\n\n\tonUsers = (users: User[]) => {\n\t\tfor (const user of users) {\n\t\t\tif (user.clientId === this.user.clientId) {\n\t\t\t\tcontinue // skip local user\n\t\t\t}\n\t\t\tconst prevs = this.users.filter(uu => uu.clientId === user.clientId)\n\t\t\tif (!prevs.length) {\n\t\t\t\tthis.users.push(user)\n\t\t\t\tthis.avatars.push(\n\t\t\t\t\tnew Avatar({\n\t\t\t\t\t\tuser: user,\n\t\t\t\t\t\tpos: newAvatarPos(),\n\t\t\t\t\t\tscale: new Vec(20),\n\t\t\t\t\t\tphys: { worldScale },\n\t\t\t\t\t}),\n\t\t\t\t)\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tif (prevs.length > 1) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`[Sketch #onUsers] Found more than one user for clientId #${user.clientId}`,\n\t\t\t\t\tuser.clientId,\n\t\t\t\t\tuser.name,\n\t\t\t\t)\n\t\t\t}\n\t\t\t// Update pre-existing user\n\t\t\tconst prev = prevs[0]\n\t\t\tObject.assign(prev, user)\n\t\t}\n\t\tfor (const user of this.users) {\n\t\t\tif (users.some(uu => uu.clientId === user.clientId)) {\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\t// user dropped, remove user and its avatar\n\t\t\tconst aa = this.getAvatar(user.clientId)\n\t\t\tif (aa) {\n\t\t\t\tengine3d.rmObj(aa)\n\t\t\t} else {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`[Sketch #onUsers] Unable to find avatar for dropped user #${user.clientId}`,\n\t\t\t\t\tuser.name,\n\t\t\t\t)\n\t\t\t}\n\t\t\tthis.users = this.users.filter(uu => uu.clientId !== user.clientId)\n\t\t\tthis.avatars = this.avatars.filter(aa => aa.user.clientId !== user.clientId)\n\t\t}\n\t}\n\n\tonUserForce = (evt: UserForce) => {\n\t\tconst { clientId } = evt\n\t\tconst avatar = this.getAvatar(clientId)\n\t\tif (!avatar) {\n\t\t\tconsole.warn('[Sketch #onUserForce] No avatar for user', clientId)\n\t\t\treturn\n\t\t}\n\t\tavatar.setUserForce(evt)\n\t}\n\n\tonUserXform = (evt: UserXform) => {\n\t\tconst { clientId } = evt\n\t\tconst avatar = this.getAvatar(clientId)\n\t\tif (!avatar) {\n\t\t\tconsole.warn('[Sketch #onUserXform] No avatar for user', clientId)\n\t\t\treturn\n\t\t}\n\t\tavatar.setUserXform(evt)\n\t}\n\n\tbpm = () => {\n\t\tif (!this.transportStarted) {\n\t\t\treturn this.inputs.bpm()\n\t\t}\n\t\treturn this._bpm\n\t}\n\tbps = () => this.bpm() / 60\n\tbeatMs = () => 1000.0 / this.bps()\n\tbeatSec = () => 1.0 / this.bps()\n\toffsetMs = () => this.beatMs() * this.user.offset\n\toffsetSec = () => this.beatSec() * this.user.offset\n\tnowMs = () => this.ws.now()\n}\n\nexport const sketch = new Sketch(window)\n","import React, { useEffect, useRef } from 'react'\nimport { sketch } from './Sketch'\n\nconst VideoOutput: React.FC = () => {\n\tconst ref = useRef<HTMLDivElement>(null)\n\tconst msg = useRef<string>(`Loading`)\n\tuseEffect(() => {\n\t\tif (!ref.current) {\n\t\t\tmsg.current = `Internal component error`\n\t\t\tconsole.warn(`[VideoOutput #useEffect] Can't find component reference`)\n\t\t\treturn\n\t\t}\n\t\tconst elem = ref.current as HTMLDivElement\n\t\tif (elem.childNodes[0]) {\n\t\t\telem.removeChild(elem.childNodes[0]) // remove previous sketch\n\t\t}\n\t\tconst { clientWidth, clientHeight } = elem\n\t\tsketch.setSize(clientWidth, clientHeight)\n\t\tconst canvas = new window.p5(sketch.sketch, elem)\n\t\treturn () => {\n\t\t\tsketch.destroy()\n\t\t\tcanvas.remove()\n\t\t\tconsole.log('[VideoOutput #useEffect.return]')\n\t\t}\n\t})\n\treturn (\n\t\t<div\n\t\t\tref={ref}\n\t\t\tstyle={{\n\t\t\t\tdisplay: 'flex',\n\t\t\t\tflex: 1,\n\t\t\t\talignItems: 'center',\n\t\t\t\tjustifyContent: 'center',\n\t\t\t\tcolor: 'white',\n\t\t\t}}\n\t\t>\n\t\t\t{msg.current}\n\t\t</div>\n\t)\n}\n\nexport default VideoOutput\n","import React from 'react'\nimport VideoOutput from './VideoOutput'\n\nimport './App.css'\n\nconst App: React.FC = () => {\n\treturn (\n\t\t<div\n\t\t\tclassName='App'\n\t\t\tstyle={{\n\t\t\t\tdisplay: 'flex',\n\t\t\t\tflexDirection: 'column',\n\t\t\t\tposition: 'absolute',\n\t\t\t\tbackgroundColor: '#383838',\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0,\n\t\t\t\tright: 0,\n\t\t\t\tbottom: 0,\n\t\t\t}}\n\t\t>\n\t\t\t<VideoOutput />\n\t\t</div>\n\t)\n}\n\nexport default App\n"],"sourceRoot":""}